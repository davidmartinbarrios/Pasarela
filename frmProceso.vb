Option Strict Off
Option Explicit On
Imports VB = Microsoft.VisualBasic
Friend Class frmProceso
	Inherits System.Windows.Forms.Form
	
	Dim colProc As Collection
	Dim j As Integer
	Dim lngCProc As Integer
	Dim lngFlowOrder As Integer
	
	Dim lngID As Integer
	Dim colCancel As Collection
	Dim colConOp As Collection
	Dim strFlow As String
	Dim lngVersion As Integer
	Dim strCom As String
	Dim blnInserta As Boolean
	Dim blnIns As Boolean
	Dim regPlus As Integer
	Dim lngRef As Integer
	Dim TIEMPOTOTAL As Integer
	Dim strdif As Integer
	Dim ContadorErrores As Short
	Dim intTimer As Short
	Dim bConexion2 As Boolean
	'aketza 31/05/2007
	Dim tramiteAnterior As String
	'fin aketza
	
	''Inicio 12/11/2010 - Para tratar excepcion de Diagrama Usuario
	'Const CONST_DIAGRAMA_USUARIO As Integer = 2650
	''Fin 12/11/2010
	
	Private Declare Function GetTickCount Lib "kernel32" () As Integer
	
	Private Sub msCorregirTramites()
		On Error GoTo procErr
		
		'Constantes
		Const cNOMBRE As String = "ModificarFlujos_BUSCARVBFIRMA"
		Const cIND_CONTINUAR_VB As String = "IND_CONTINUAR_VB"
		Const cNOMBRE_IF As String = "IF_CONTINUAR_VB"
		
		'Variables
		Dim strSQL As String
		Dim strInsert As String
		Dim rstVistosBuenos As ADODB.Recordset
		Dim rstFlowOrderMax As ADODB.Recordset
		Dim rstJump As ADODB.Recordset
		Dim rstLETVAR As ADODB.Recordset
		Dim strFlowOrderTram As String
		Dim lngMinFlowOrder As Integer
		Dim lngMaxFlowOrder As Integer
		Dim lngFlowOrder As Integer
		Dim condicionIF As String
		Dim salidaTHEN As String
		Dim salidaELSE As String
		Dim strFlowOrderSigTram As String
		Dim strVariable As String
		Dim cont As String
		Dim strUpdate As String
		Dim strIDParametro As String
		Dim rstFormFicticio As ADODB.Recordset
		Dim strNombreFormFicticio As String
		Dim strOrdenTramite As String
		
		'1. Obtenemos los Trámites de VºBº y/o Firma del Procedimiento y Versión (apariciones de la acción BUSCARVBFIRMA)
		strSQL = "SELECT W1.FLOW, " & "W1.VERSION, " & "W1.FLOWORDER AS FLOWORDER_ACCION, " & "W1.FLOWORDER AS FLOWORDER_MIN, " & "W1.PATH, " & "W2.FLOWORDER AS FLOWORDER_MAX, " & "W2.PATH AS PATH_THEN " & "FROM WFFLOWACTIONS W1, WFFLOWACTIONS W2 " & "WHERE W1.FLOW = W2.FLOW " & "AND W1.VERSION = W2.VERSION " & "AND W1.FLOW = '" & gNomProcCorto & "' " & "AND W1.VERSION = " & SelectedVersion & " " & "AND W1.PATH LIKE 'APE_BUSCARVBFIRMA%' " & "AND W2.PATH LIKE 'APE_TRAMITEPDTE%' " & "AND W2.FLOWORDER = (SELECT TOP 1 FLOWORDER " & "FROM WFFLOWACTIONS W3 " & "WHERE W1.FLOW = W3.FLOW " & "AND W1.VERSION = W3.VERSION " & "AND W3.PATH LIKE 'APE_TRAMITEPDTE%' " & "AND W3.FLOWORDER > W1.FLOWORDER)"
		rstVistosBuenos = mfRecordset(conPasarela, strSQL)
		cont = CStr(1)
		While Not rstVistosBuenos.EOF
			'Obtenemos el FlowOrder de la Acción BUSCARVBFIRMA que estamos tratando
			strFlowOrderTram = Trim(rstVistosBuenos.Fields("FLOWORDER_ACCION").Value)
			
			'Calculamos el FlowOrder que se asignará al nuevo IF
			lngMinFlowOrder = CInt(Trim(rstVistosBuenos.Fields("FLOWORDER_MIN").Value))
			lngMaxFlowOrder = CInt(Trim(rstVistosBuenos.Fields("FLOWORDER_MAX").Value))
			lngFlowOrder = System.Math.Abs((lngMinFlowOrder + lngMaxFlowOrder) / 2)
			
			'Obtenemos la condición del IF
			condicionIF = CStr("@") & cNOMBRE_IF & cont & "!" & cIND_CONTINUAR_VB
			
			'Obtenemos la salida THEN del IF
			salidaTHEN = Trim(rstVistosBuenos.Fields("PATH_THEN").Value)
			
			'Obtenemos la salida ELSE del IF
			'Obtenemos FlowOrder del siguiente trámite (el que va después del trámite de VB y/o Firma en secuencia, no en ejecución)
			strSQL = "SELECT TOP 1 FLOWORDER " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & SelectedVersion & " " & "AND FLOWORDER >= " & CStr(lngMinFlowOrder) & " " & "AND ACTION = 'LABEL' " & "AND PATH LIKE 'PR[_]%' " & "ORDER BY FLOWORDER"
			rstFlowOrderMax = mfRecordset(conPasarela, strSQL)
			While Not rstFlowOrderMax.EOF
				strFlowOrderSigTram = Trim(rstFlowOrderMax.Fields("FLOWORDER").Value)
				rstFlowOrderMax.MoveNext()
			End While
			'Obtenemos el último JUMP del trámite VºBº para conseguir el nombre de la variable a buscar
			strSQL = "SELECT TOP 1 * " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & SelectedVersion & " " & "AND FLOWORDER > " & strFlowOrderTram & " " & "AND FLOWORDER < " & strFlowOrderSigTram & " " & "AND ACTION = 'JUMP' " & "ORDER BY FLOWORDER DESC"
			rstJump = mfRecordset(conPasarela, strSQL)
			While Not rstJump.EOF
				strVariable = Trim(rstJump.Fields("VALUE").Value)
				rstJump.MoveNext()
			End While
			strVariable = Mid(strVariable, InStr(1, strVariable, "!") + 1)
			strVariable = "@" & strVariable
			'Obtenemos el último LETVAR del trámite para la variable obtenida, pues es a donde saltará el ELSE del IF
			strSQL = "SELECT TOP 1 * " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & SelectedVersion & " " & "AND FLOWORDER > " & strFlowOrderTram & " " & "AND FLOWORDER < " & strFlowOrderSigTram & " " & "AND ACTION = 'LETVAR' " & "AND PATH LIKE 'LETAPE%' " & "AND PARAM = '" & strVariable & "' " & "ORDER BY FLOWORDER DESC"
			rstLETVAR = mfRecordset(conPasarela, strSQL)
			While Not rstLETVAR.EOF
				salidaELSE = Trim(rstLETVAR.Fields("VALUE").Value)
				rstLETVAR.MoveNext()
			End While
			
			'Actualizamos el PATHRETORNO de la acción BUSCARVBFIRMA para que vaya al nuevo IF
			strUpdate = "UPDATE WFFLOWACTIONS " & "SET VALUE = '" & cNOMBRE_IF & cont & "' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & SelectedVersion & " " & "AND FLOWORDER = " & strFlowOrderTram & " " & "AND PARAM = '@PATHRETORNO'"
			mfExecute(conPasarela, strUpdate)
			
			'Insertamos el IF
			strInsert = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES " & "('" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", 0, 'IF', '" & cNOMBRE_IF & cont & "', 'VAR1', '" & condicionIF & "', '')"
			mfExecute(conPasarela, strInsert)
			
			strInsert = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES " & "('" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", 1, '', '', 'VAR2', 'S', '')"
			mfExecute(conPasarela, strInsert)
			
			strInsert = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES " & "('" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", 2, '', '', 'CONDITION', '=', '')"
			mfExecute(conPasarela, strInsert)
			
			strInsert = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES " & "('" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", 3, '', '', 'PATH', '" & salidaTHEN & "', '')"
			mfExecute(conPasarela, strInsert)
			
			strInsert = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES " & "('" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", 4, '', '', 'ELSEPATH', '" & salidaELSE & "', '')"
			mfExecute(conPasarela, strInsert)
			
			strInsert = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES " & "('" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", 5, '', '', 'TYPE', 'STRING', '')"
			mfExecute(conPasarela, strInsert)
			
			strInsert = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES " & "('" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", 6, '', '', 'LEVEL', '2', '')"
			mfExecute(conPasarela, strInsert)
			
			cont = CStr(CDbl(cont) + 1)
			rstVistosBuenos.MoveNext()
		End While
		
		'2.- Obtenemos las acciones que tienen el parámetro @NOMBRE_FORMULARIO_IN de las acciones BUSCARVBFIRMA, BUSCARUNITRAMITADORAFIRMA y OBTENER_RESPONSABLE_FIRMA_EXTERNO
		strSQL = "SELECT W2.FLOWORDER AS FLOWORDER_ACCION, " & "W2.ID AS ID_PARAMETRO, " & "W3.VALUE AS ORDENTRA " & "FROM WFFLOWACTIONS W1 " & "JOIN WFFLOWACTIONS W2 ON (W2.FLOW = W1.FLOW AND " & "W2.VERSION = W1.VERSION AND " & "W2.FLOWORDER = W1.FLOWORDER AND " & "W2.PARAM = '@NOMBRE_FORMULARIO_IN') " & "JOIN WFFLOWACTIONS W3 ON (W3.FLOW = W2.FLOW AND " & "W3.VERSION = W2.VERSION AND " & "W3.FLOWORDER = W2.FLOWORDER AND " & "W3.PARAM = '@ORDENTRA') " & "WHERE W1.Flow = '" & gNomProcCorto & "' " & "AND W1.VERSION = " & SelectedVersion & " " & "AND W1.PARAM = 'FLOW' " & "AND W1.VALUE IN ('BUSCARVBFIRMA', 'BUSCARUNITRAMITADORAFIRMA', 'OBTENER_RESPONSABLE_FIRMA_EXTERNO')"
		rstVistosBuenos = mfRecordset(conPasarela, strSQL)
		While Not rstVistosBuenos.EOF
			'Obtenemos el nombre del FORMFICTICIO
			strFlowOrderTram = Trim(rstVistosBuenos.Fields("FLOWORDER_ACCION").Value)
			strIDParametro = Trim(rstVistosBuenos.Fields("ID_PARAMETRO").Value)
			strOrdenTramite = Trim(rstVistosBuenos.Fields("ORDENTRA").Value)
			
			'Obtenemos el primer y último FlowOrder del Trámite
			strSQL = "SELECT MIN(FLOWORDER) AS FLOWORDER_MIN, " & "MAX(FLOWORDER) AS FLOWORDER_MAX " & "FROM WFFLOWACTIONS " & "WHERE Flow = '" & gNomProcCorto & "' " & "AND VERSION = " & SelectedVersion & " " & "AND PARAM = '@ORDENTRA' " & "AND VALUE = '" & strOrdenTramite & "'"
			rstFlowOrderMax = mfRecordset(conPasarela, strSQL)
			If Not rstFlowOrderMax.EOF Then
				lngMinFlowOrder = CInt(Trim(rstFlowOrderMax.Fields("FLOWORDER_MIN").Value))
				lngMaxFlowOrder = CInt(Trim(rstFlowOrderMax.Fields("FLOWORDER_MAX").Value))
			End If
			
			'Obtenemos el PATH del FORMFICTICIO asociado al trámite que estamos tratando
			strSQL = "SELECT TOP(1) PATH AS NOMBRE_FORMFICTICIO " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & SelectedVersion & " " & "AND FLOWORDER BETWEEN " & CStr(lngMinFlowOrder) & " AND " & CStr(lngMaxFlowOrder) & " " & "AND ACTION = 'FORM' " & "AND PATH LIKE 'FORMFICTICIO%' " & "ORDER BY FLOWORDER"
			rstFormFicticio = mfRecordset(conPasarela, strSQL)
			If Not rstFormFicticio.EOF Then
				strNombreFormFicticio = Trim(rstFormFicticio.Fields("NOMBRE_FORMFICTICIO").Value)
				rstFormFicticio.MoveNext()
			End If
			
			'Actualizamos el Parámetro
			'Actualizamos el PATHRETORNO de la acción BUSCARVBFIRMA para que vaya al nuevo IF
			strUpdate = "UPDATE WFFLOWACTIONS " & "SET VALUE = '" & strNombreFormFicticio & "' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & SelectedVersion & " " & "AND FLOWORDER = " & strFlowOrderTram & " " & "AND ID = " & strIDParametro
			mfExecute(conPasarela, strUpdate)
			
			rstVistosBuenos.MoveNext()
		End While
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'aketza errores
		Insertar_Error(Me, "Crear Flujo", "Error al crear el flujo", "msCrearFlujo")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msCreaFlujo - " & Err.Description)
		tramiteAnterior = ""
		Me.Close()
		Resume procFin
		
procFin: 
		
	End Sub
	
	
	Public Sub msLec_Diagram_Proc(ByVal colEntrada As Collection, ByVal TIPO As String, ByVal NIVEL As Integer)
		
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rstProc As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim rstProp3 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim blnExp As Boolean
		Dim strTram As String
		Dim lngMax As Integer
		Dim icol As Object
		Dim arrPasar(7) As Object
		Dim colPaso As Collection
		Dim colCon As Collection
		Dim I As Integer
		Dim j As Integer
		Dim k As Integer
		Dim arr As Object
		Dim lngnumSal As Integer
		Dim lngAux As Integer
		Dim rows As Integer
		Dim blnComprobacionNivel4 As Boolean
		Dim blnComprobacionNivel3 As Boolean
		Dim blnComp3 As Boolean
		Dim lngNomas As Integer
		Dim idPadre As Integer
		Dim arrFases As Object 'MU88
		
		
		I = 1
		If NIVEL = 1 Then
			colProc = New Collection
			colProc = colEntrada
		End If
		colPaso = New Collection
		colCon = New Collection
		blnComp3 = False
		For	Each icol In colEntrada
			lngMax = 0
			rstProc = New ADODB.Recordset
			System.Windows.Forms.Application.DoEvents()
			j = 1
			If NIVEL = 1 Then
				lblMensaje.Text = "Eliminando DIAGRAMAS"
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("DIAGRAMA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("PROPIEDADES_DI", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				lblMensaje.Text = "Eliminando CONECTORES"
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("CONECTORES_DI", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("CONECTOR_ACC", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				lblMensaje.Text = "Eliminando ACCIONES"
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("ACCIONES_DI", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				msLimpiar("PARAM_ACC", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				lblMensaje.Text = "Eliminando ERRORES"
				System.Windows.Forms.Application.DoEvents()
				mfExecute(conPasarela, "INSERT INTO ERRORES_HISTORICO SELECT * FROM ERRORES WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and USERID='" & strUserId & "'")
				mfExecute(conPasarela, "DELETE FROM ERRORES WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and USERID='" & strUserId & "'")
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("VALIDACIONES", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				lblMensaje.Text = "Eliminando tablas equivalencia INFRAESTRUCTURA"
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("TBDCELTA_PA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("TBPFIN01_PA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("TBPFIN02_PA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("TBPFIN03_PA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("TBPFIN23_PA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("TBPFIN04_PA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
				System.Windows.Forms.Application.DoEvents()
				msLimpiar("VAR_ALTA_PA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
			End If
			lblMensaje.Text = "Leyendo DIAGRAMAS de nivel " & NIVEL & " DP4"
			If NIVEL = 1 Then
				strSQL = "SELECT A.ANO_ID, A.SH_SEQ, A.SH_Y, A.SH_X, B.PR_NAME "
				strSQL = strSQL & "FROM SHAPE A, PROCESS B, CW_PROP_TYPE C, CW_LOOKUP D "
				strSQL = strSQL & "Where B.PR_TYPE=D.LU_ID AND D.PPT_ID = C.PPT_ID And C.PPT_FIELD_NAME='PR_TYPE' AND "
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & "D.LU_NAME IN (" & TIPO & ") AND A.ANO_TABNR=8953 AND A.ANO_ID=B.PR_ID AND A.DI_ID = " & icol(0)
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				
				strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC"
			Else
				lngAux = 0
				strSQL = "Select E.DI_ID, D.ANO_ID, D.SH_SEQ, D.SH_Y, D.SH_X, A.PR_NAME "
				strSQL = strSQL & "From PROCESS A, CW_PROP_TYPE B, CW_LOOKUP C, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "Where A.PR_TYPE = C.LU_ID and D.ANO_ID = A.PR_ID and B.PPT_ID = C.PPT_ID and "
				strSQL = strSQL & "B.PPT_FIELD_NAME = 'PR_TYPE' and C.LU_NAME IN (" & TIPO & ")  and D.ANO_TABNR = 8953 and "
				strSQL = strSQL & "E.ANO_TABNR=8953 and "
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & "D.ANO_ID <> E.ANO_ID and E.DI_ID = D.DI_ID and E.DI_TYPE <> 1 and E.ANO_ID = " & icol(0)
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " Order by SH_Y desc, SH_X asc"
			End If
			System.Windows.Forms.Application.DoEvents()
			rstProc = mfRecordset(conDP4, strSQL)
			System.Windows.Forms.Application.DoEvents()
			If Not rstProc.EOF Then
				'UPGRADE_WARNING: Couldn't resolve default property of object rstProc.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				arr = rstProc.GetRows
				rstProc.MoveFirst()
			End If
			System.Windows.Forms.Application.DoEvents()
			'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			Me.pgbProceso.Value = 0
			While Not rstProc.EOF
				System.Windows.Forms.Application.DoEvents()
				lblMensaje.Text = "Volcando información DIAGRAMAS de nivel " & NIVEL & " en PASARELA"
				msProceso(j, UBound(arr, 2) + 1, I, colEntrada.Count())
				rstProp = New ADODB.Recordset
				System.Windows.Forms.Application.DoEvents()
				strSQL = "SELECT D.LU_NAME "
				strSQL = strSQL & "FROM PROCESS B, CW_PROP_TYPE C, CW_LOOKUP D "
				strSQL = strSQL & "Where B.PR_TYPE=D.LU_ID AND C.PPT_ID=D.PPT_ID AND C.PPT_FIELD_NAME='PR_TYPE' AND B.PR_ID = " & rstProc.Fields("ANO_ID").Value
				' **** NUEVO SD ENERO'08
				
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				
				System.Windows.Forms.Application.DoEvents()
				rstProp = mfRecordset(conDP4, strSQL)
				If Not rstProp.EOF Then
					strTram = Trim(rstProp.Fields("LU_NAME").Value) & ""
				End If
				rstProp.Close()
				System.Windows.Forms.Application.DoEvents()
				strSQL = "Select D.ANO_ID "
				strSQL = strSQL & "From PROCESS A, CW_PROP_TYPE B, CW_LOOKUP C, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "Where A.PR_TYPE = C.LU_ID and D.ANO_ID = A.PR_ID and B.PPT_ID = C.PPT_ID and "
				strSQL = strSQL & "B.PPT_FIELD_NAME = 'PR_TYPE' and C.LU_NAME   in ('Trámite de Inicio', 'Trámite', 'Trámite automático', 'Trámite general', 'Ramificación')  and "
				strSQL = strSQL & "D.ANO_TABNR = 8953 and D.ANO_ID <> E.ANO_ID and E.DI_ID = D.DI_ID and E.DI_TYPE <> 1 and "
				strSQL = strSQL & "E.ANO_ID = " & rstProc.Fields("ANO_ID").Value
				'Problema en Ardatz que lee tramites de otros diagramas 30/11/2006
				strSQL = strSQL & " AND E.ANO_TABNR=8953 "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Fin Problema en Ardatz
				strSQL = strSQL & " Order by SH_Y desc, SH_X asc "
				rstProp = mfRecordset(conDP4, strSQL)
				System.Windows.Forms.Application.DoEvents()
				If rstProp.EOF Then
					System.Windows.Forms.Application.DoEvents()
					blnExp = True
				Else
					System.Windows.Forms.Application.DoEvents()
					'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					arrPasar(0) = rstProc.Fields("ANO_ID").Value
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					arrPasar(1) = icol(0)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					arrPasar(2) = icol(1)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					arrPasar(3) = icol(2)
					blnExp = False
				End If
				System.Windows.Forms.Application.DoEvents()
				Select Case NIVEL
					Case CDec("1")
						strSQL = "SELECT MAX(ORDEN_N1) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
						System.Windows.Forms.Application.DoEvents()
						rstProp = mfRecordset(conPasarela, strSQL)
						lngMax = Val(rstProp.Fields(0).Value & "") + 1
						rstProp.Close()
						System.Windows.Forms.Application.DoEvents()
						
						'MU88 - Fase/Subfase
						ReDim arrFases(3)
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object mfFaseSubfase(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						arrFases = mfFaseSubfase(rstProc.Fields("ANO_ID").Value, icol(0), rstProc.Fields("SH_SEQ").Value, lngMax, 0, 0, 0, 0, vbNullString)
						'Fin MU88 - Fase/Subfase
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ID_DIAG_N1, ID_DIAGRAMA, CAT_DIAGRAMA, ID_PADRE, NUM_DIAGRAMA, EXPLOTA_ACC, " & "NUM_SEQ, NOMBRE, DI_ID, CODFASE, CODSFASE, DATFASUB) VALUES (" & "'" & gNomProcCorto & "', " & lngMax & ", " & "0, " & "0, " & "0, " & "0, " & rstProc.Fields("ANO_ID").Value & ", " & rstProc.Fields("ANO_ID").Value & ", " & "'" & strTram & "', " & icol(0) & ", " & NIVEL & ", " & IIf(blnExp = True, "'S'", "'N'") & ", " & rstProc.Fields("SH_SEQ").Value & ", " & "'" & Trim(rstProc.Fields("PR_NAME").Value) & "', " & icol(0) & ", " & "'" & arrFases(0) & "', " & "'" & arrFases(1) & "', " & "'" & arrFases(2) & "')"
						mfExecute(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						If blnExp = False Then
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(4) = lngMax
						End If
						System.Windows.Forms.Application.DoEvents()
					Case CDec("2")
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "SELECT MAX(ORDEN_N2) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(0) & " and ORDEN_N1=" & icol(4)
						System.Windows.Forms.Application.DoEvents()
						rstProp = mfRecordset(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						lngMax = Val(rstProp.Fields(0).Value & "") + 1
						rstProp.Close()
						System.Windows.Forms.Application.DoEvents()
						
						'MU88 - Fase/Subfase
						ReDim arrFases(3)
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object mfFaseSubfase(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						arrFases = mfFaseSubfase(rstProc.Fields("ANO_ID").Value, icol(0), rstProc.Fields("SH_SEQ").Value, icol(4), lngMax, 0, 0, 0, vbNullString)
						'Fin MU88 - Fase/Subfase
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5," & "ID_DIAG_N1,ID_DIAG_N2,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC," & "NUM_SEQ,NOMBRE,DI_ID,CODFASE,CODSFASE,DATFASUB) VALUES " & "('" & gNomProcCorto & "'," & icol(4) & "," & lngMax & ", 0,0,0," & icol(0) & "," & rstProc.Fields("ANO_ID").Value & "," & rstProc.Fields("ANO_ID").Value & ",'" & strTram & "', " & icol(0) & ", " & NIVEL & "," & IIf(blnExp = True, "'S'", "'N'") & "," & rstProc.Fields("SH_SEQ").Value & ",'" & Trim(rstProc.Fields("PR_NAME").Value) & "'," & rstProc.Fields("DI_ID").Value & "," & "'" & arrFases(0) & "', '" & arrFases(1) & "', '" & arrFases(2) & "')"
						mfExecute(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						If blnExp = False Then
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(4) = icol(4)
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(5) = lngMax
						End If
					Case CDec("3")
						blnComprobacionNivel3 = False
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "SELECT MAX(ORDEN_N3) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(1) & " and ORDEN_N1=" & icol(4) & " and ID_DIAG_N2=" & icol(0) & " and ORDEN_N2=" & icol(5)
						System.Windows.Forms.Application.DoEvents()
						rstProp = mfRecordset(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						lngMax = Val(rstProp.Fields(0).Value & "") + 1
						rstProp.Close()
						'nuevo
						'               If rstProp(0) > 0 Then
						'                  strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(1) & " and ORDEN_N1=" & icol(4) & " and ID_DIAG_N2=" & icol(0) & " AND ID_DIAGRAMA<>" & icol(0)
						'                  Set rstAux = mfRecordset(conPasarela, strSQL)
						'                  If rstAux("NOMBRE") = Trim(rstProc("PR_NAME")) Then
						'                     blnComprobacionNivel3 = True
						'                  End If
						'               End If
						'               DoEvents
						'               lngMax = Val(rstProp(0) & "") + 1
						'               strSQL = "SELECT ORDEN_N1,ORDEN_N2 FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(2) & " and ORDEN_N1=" & icol(4) & " and ID_DIAG_N2=" & icol(0)
						'               Set rstProp = mfRecordset(conPasarela, strSQL)
						'               Do While Not blnComprobacionNivel3 = False
						'                  If rstProp("ORDEN_N1") = rstAux("ORDEN_N1") And rstProp("ORDEN_N2") = rstAux("ORDEN_N2") Then
						'                     blnComprobacionNivel3 = True
						'                     rstProp.MoveNext
						'                  Else
						'                     blnComprobacionNivel3 = False
						'                     lngMax = 1
						'                     Exit Do
						'                  End If
						'               Loop
						'               DoEvents
						'finnuevo
						System.Windows.Forms.Application.DoEvents()
						
						'MU88 - Fase/Subfase
						ReDim arrFases(3)
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object mfFaseSubfase(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						arrFases = mfFaseSubfase(rstProc.Fields("ANO_ID").Value, icol(0), rstProc.Fields("SH_SEQ").Value, icol(4), icol(5), lngMax, 0, 0, vbNullString)
						'Fin MU88 - Fase/Subfase
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5," & "ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA," & "EXPLOTA_ACC,NUM_SEQ,NOMBRE,DI_ID,CODFASE,CODSFASE,DATFASUB) VALUES " & "('" & gNomProcCorto & "'," & icol(4) & "," & icol(5) & "," & lngMax & ",0,0," & icol(1) & "," & icol(0) & ", " & rstProc.Fields("ANO_ID").Value & "," & rstProc.Fields("ANO_ID").Value & "," & "'" & strTram & "'," & icol(0) & "," & NIVEL & "," & IIf(blnExp = True, "'S'", "'N'") & "," & rstProc.Fields("SH_SEQ").Value & ",'" & Trim(rstProc.Fields("PR_NAME").Value) & "'," & rstProc.Fields("DI_ID").Value & "," & "'" & arrFases(0) & "', '" & arrFases(1) & "', '" & arrFases(2) & "')"
						mfExecute(conPasarela, strSQL)
						'               rstProp.Close
						System.Windows.Forms.Application.DoEvents()
						If blnExp = False Then
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(4) = icol(4)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(5) = icol(5)
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(6). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(6) = lngMax
						End If
					Case CDec("4")
						blnComprobacionNivel4 = False
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "SELECT MAX(ORDEN_N4) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(2) & " and ORDEN_N1=" & icol(4) & " and ID_DIAG_N2=" & icol(1) & " AND ID_DIAG_N3 = " & icol(0)
						System.Windows.Forms.Application.DoEvents()
						rstProp = mfRecordset(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						lngMax = Val(rstProp.Fields(0).Value & "") + 1
						rstProp.Close()
						'               If rstProp(0) > 0 Then
						'
						'                  strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(2) & " and ORDEN_N1=" & icol(4) & " and ID_DIAG_N2=" & icol(1) & " AND ID_DIAG_N3 = " & icol(0) & " AND ID_DIAGRAMA<>" & icol(0)
						'                  Set rstAux = mfRecordset(conPasarela, strSQL)
						'                  Do While Not rstAux.EOF
						'                     If rstAux("NOMBRE") = Trim(rstProc("PR_NAME")) Then
						'                        blnComprobacionNivel4 = True
						'                        Exit Do
						'                     End If
						'                  rstAux.MoveNext
						'                  Loop
						'
						'               End If
						'               DoEvents
						'               lngMax = Val(rstProp(0) & "") + 1
						'               strSQL = "SELECT ORDEN_N2,ORDEN_N3 FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(2) & " and ORDEN_N1=" & icol(4) & " and ID_DIAG_N2=" & icol(1) & " AND ID_DIAG_N3 = " & icol(0)
						'               Set rstProp = mfRecordset(conPasarela, strSQL)
						'               Do While Not blnComprobacionNivel4 = False
						'                  If rstProp("ORDEN_N2") = rstAux("ORDEN_N2") And rstProp("ORDEN_N3") = rstAux("ORDEN_N3") Then
						'                     blnComprobacionNivel4 = True
						'                     rstProp.MoveNext
						'                  Else
						'                     blnComprobacionNivel4 = False
						'                     strSQL = "SELECT MAX(ORDEN_N4) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & icol(4) & " AND ORDEN_N2=" & rstProp("ORDEN_N2") & " AND ORDEN_N3=" & rstProp("ORDEN_N3")
						'                     DoEvents
						'                     Set rstAux3 = mfRecordset(conPasarela, strSQL)
						'                     'lngMax = 1
						'                     lngMax = Val(rstAux3(0) & "") + 1
						'                     Exit Do
						'                  End If
						'               Loop
						System.Windows.Forms.Application.DoEvents()
						
						'MU88 - Fase/Subfase
						ReDim arrFases(3)
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(6). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object mfFaseSubfase(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						arrFases = mfFaseSubfase(rstProc.Fields("ANO_ID").Value, icol(0), rstProc.Fields("SH_SEQ").Value, icol(4), icol(5), icol(6), lngMax, 0, vbNullString)
						'Fin MU88 - Fase/Subfase
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(6). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5," & "ID_DIAG_N1 , ID_DIAG_N2, ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA," & "ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,NOMBRE,DI_ID,CODFASE,CODSFASE,DATFASUB) VALUES " & "('" & gNomProcCorto & "'," & icol(4) & "," & icol(5) & "," & icol(6) & "," & lngMax & ", 0," & "" & icol(2) & "," & icol(1) & ", " & icol(0) & "," & rstProc.Fields("ANO_ID").Value & ", 0," & rstProc.Fields("ANO_ID").Value & ",'" & strTram & "'," & icol(0) & "," & "" & NIVEL & "," & IIf(blnExp = True, "'S'", "'N'") & "," & rstProc.Fields("SH_SEQ").Value & ",'" & Trim(rstProc.Fields("PR_NAME").Value) & "'," & rstProc.Fields("DI_ID").Value & ",'" & arrFases(0) & "', '" & arrFases(1) & "', '" & arrFases(2) & "')"
						mfExecute(conPasarela, strSQL)
						'               rstProp.Close
						System.Windows.Forms.Application.DoEvents()
						If blnExp = False Then
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(4) = icol(4)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(5) = icol(5)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(6). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(6) = icol(6)
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(7). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(7) = lngMax
						End If
					Case CDec("5")
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "SELECT MAX(ORDEN_N5) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(3) & " and ORDEN_N1=" & icol(4) & " and ID_DIAG_N2=" & icol(2) & " and ID_DIAG_N3 = " & icol(1) & " AND ID_DIAG_N4=" & icol(0)
						System.Windows.Forms.Application.DoEvents()
						rstProp = mfRecordset(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						lngMax = Val(rstProp.Fields(0).Value & "") + 1
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "SELECT ORDEN_N2,ORDEN_N3,ORDEN_N4 FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAG_N1 = " & icol(3) & " And ORDEN_N1 = " & icol(4) & " and ID_DIAG_N2=" & icol(2) & " and ID_DIAG_N3 = " & icol(1) & " AND ID_DIAG_N4=" & icol(0)
						System.Windows.Forms.Application.DoEvents()
						rstProp = mfRecordset(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						
						'MU88 - Fase/Subfase
						ReDim arrFases(3)
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object mfFaseSubfase(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						arrFases = mfFaseSubfase(rstProc.Fields("ANO_ID").Value, icol(0), rstProc.Fields("SH_SEQ").Value, icol(4), rstProp.Fields("ORDEN_N2").Value, rstProp.Fields("ORDEN_N3").Value, rstProp.Fields("ORDEN_N4").Value, lngMax, vbNullString)
						'Fin MU88 - Fase/Subfase
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrFases(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5," & "ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA," & "ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,NOMBRE,DI_ID,CODFASE,CODSFASE,DATFASUB) VALUES " & "('" & gNomProcCorto & "'," & icol(4) & "," & rstProp.Fields("ORDEN_N2").Value & "," & rstProp.Fields("ORDEN_N3").Value & "," & rstProp.Fields("ORDEN_N4").Value & "," & lngMax & "," & icol(3) & "," & icol(2) & ", " & icol(1) & "," & icol(0) & "," & rstProc.Fields("ANO_ID").Value & "," & rstProc.Fields("ANO_ID").Value & ",'" & strTram & "'," & icol(0) & "," & NIVEL & "," & IIf(blnExp = True, "'S'", "'N'") & "," & rstProc.Fields("SH_SEQ").Value & ",'" & Trim(rstProc.Fields("PR_NAME").Value) & "'," & rstProc.Fields("DI_ID").Value & ",'" & arrFases(0) & "', '" & arrFases(1) & "', '" & arrFases(2) & "')"
						mfExecute(conPasarela, strSQL)
						System.Windows.Forms.Application.DoEvents()
						rstProp.Close()
						If blnExp = False Then
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(4) = icol(4)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(5) = icol(5)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(6). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(6) = icol(6)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrPasar(7). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrPasar(7) = icol(7)
						End If
						System.Windows.Forms.Application.DoEvents()
				End Select
				If blnExp = False Then
					colPaso.Add(arrPasar)
					System.Windows.Forms.Application.DoEvents()
				End If
				rstProc.MoveNext()
				j = j + 1
			End While
			I = I + 1
		Next icol
		rstProc.Close()
		'UPGRADE_NOTE: Object rstProc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProc = Nothing
		I = 1
		'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Me.pgbProceso.Value = 0
		For	Each icol In colEntrada
			lblMensaje.Text = "Volcando información CONECTORES de nivel " & NIVEL & " en PASARELA"
			System.Windows.Forms.Application.DoEvents()
			If NIVEL = 1 Then
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				msLec_Conectores_DI(icol(0), I, colEntrada.Count(), NIVEL, 0)
			Else
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				msLec_Conectores_DI(icol(0), I, colEntrada.Count(), NIVEL, CInt(icol(4)), CInt(icol(5)), CInt(icol(6)), CInt(icol(7)))
			End If
			I = I + 1
		Next icol
		
		GoTo procFin
procErr: 
		
		If blnCancelar = True Then
			Exit Sub
		End If
		If blnParar = True Then
			Exit Sub
		End If
		Insertar_Error(Me, "Lectura de Diagramas del Procedimiento", "Ha ocurrido un error no controlado", "msLec_Diagram_Proc")
		Mostrar_Error()
		logError("msLec_Diagram_Proc - " & Err.Description)
		Resume procFin
procFin: 
		If colPaso.Count() > 0 Then
			msLec_Diagram_Proc(colPaso, TIPO, NIVEL + 1)
		Else
			'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			Me.pgbProceso.Value = 0
			lblMensaje.Text = "Estructurando tabla DIAGRAMAS"
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3,ORDEN_N4,ORDEN_N5"
			rstProc = mfRecordset(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
			'UPGRADE_WARNING: Couldn't resolve default property of object rstProc.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstProc.GetRows
			rstProc.MoveFirst()
			msLimpiar("DIAGRAMA", "PROCEDIMIENTO", gNomProcCorto, conPasarela)
			j = 1
			While Not rstProc.EOF
				msProceso(j, UBound(arr, 2) + 1, 1, 1)
				strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5," & "ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA," & "ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS," & "DI_ID,CODFASE,CODSFASE,DATFASUB) VALUES (" & "'" & gNomProcCorto & "'," & rstProc.Fields("ORDEN_N1").Value & "," & rstProc.Fields("ORDEN_N2").Value & "," & rstProc.Fields("ORDEN_N3").Value & "," & rstProc.Fields("ORDEN_N4").Value & "," & rstProc.Fields("ORDEN_N5").Value & "," & snulo(rstProc.Fields("ID_DIAG_N1").Value & "") & "," & snulo(rstProc.Fields("ID_DIAG_N2").Value & "") & "," & snulo(rstProc.Fields("ID_DIAG_N3").Value & "") & "," & snulo(rstProc.Fields("ID_DIAG_N4").Value & "") & "," & snulo(rstProc.Fields("ID_DIAG_N5").Value & "") & "," & snulo(rstProc.Fields("ID_DIAGRAMA").Value & "") & "," & "'" & rstProc.Fields("CAT_DIAGRAMA").Value & "'," & snulo(rstProc.Fields("ID_PADRE").Value & "") & "," & snulo(rstProc.Fields("NUM_DIAGRAMA").Value & "") & ",'" & rstProc.Fields("EXPLOTA_ACC").Value & "'," & snulo(rstProc.Fields("NUM_SEQ").Value & "") & ",'" & rstProc.Fields("INDPARA").Value & "','" & rstProc.Fields("INDJUMP").Value & "'," & "'" & rstProc.Fields("INDCANCEL").Value & "','" & rstProc.Fields("NOMBRE").Value & "'," & snulo(rstProc.Fields("SALIDAS").Value & "") & "," & snulo(rstProc.Fields("DI_ID").Value & "") & ",'" & rstProc.Fields("CODFASE").Value & "','" & rstProc.Fields("CODSFASE").Value & "'," & "'" & rstProc.Fields("DATFASUB").Value & "')"
				mfExecute(conPasarela, strSQL)
				rstProc.MoveNext()
				System.Windows.Forms.Application.DoEvents()
				j = j + 1
			End While
		End If
		
		CierraRS(rstProc)
		'UPGRADE_NOTE: Object rstProc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProc = Nothing
		CierraRS(rstProp)
		'UPGRADE_NOTE: Object rstProp may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProp = Nothing
		CierraRS(rstProp3)
		'UPGRADE_NOTE: Object rstProp3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProp3 = Nothing
		
	End Sub
	
	Private Sub msLec_Conectores_DI(ByVal Id As Integer, Optional ByVal colact As Integer = 0, Optional ByRef colmax As Integer = 0, Optional ByRef NIVEL As Integer = 0, Optional ByRef ORDEN_N1 As Integer = 0, Optional ByRef ORDEN_N2 As Integer = 0, Optional ByRef ORDEN_N3 As Integer = 0, Optional ByRef ORDEN_N4 As Integer = 0)
		
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rstCon As ADODB.Recordset
		Dim rstXML As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim strXML As String
		Dim strProp As String
		Dim strCadenaXML As String
		Dim j As Integer
		Dim arr As Object
		Dim colXML As Collection
		Dim colXMLD As Collection
		Dim strAux As String
		Dim numCON As Integer
		Dim lngTipo As Integer
		Dim strSalida As String
		rstCon = New ADODB.Recordset
		rstXML = New ADODB.Recordset
		colXML = New Collection
		If NIVEL = 1 Then
			strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID "
			strSQL = strSQL & "FROM SHAPE A, JOINER B, PROCESS C, CW_LOOKUP E "
			strSQL = strSQL & "Where A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_FROM AND (A.ANO_TABNR=8953) AND A.DI_ID=" & Id & "  AND A.ANO_ID=C.PR_ID AND "
			strSQL = strSQL & "C.PR_TYPE=E.LU_ID and E.LU_NAME in ('Trámite de Inicio', 'Trámite', 'Trámite automático', 'Trámite general', 'Trámite General Automático','Ramificación') AND C.PR_TYPE=23 "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC"
			rstAux = mfRecordset(conDP4, strSQL)
			While Not rstAux.EOF
				strAux = strAux & "-" & rstAux.Fields("SH_SEQ").Value & "-"
				rstAux.MoveNext()
			End While
			strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID "
			strSQL = strSQL & "FROM SHAPE A, JOINER B, PROCESS C, CW_LOOKUP E "
			strSQL = strSQL & "Where A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_FROM AND (A.ANO_TABNR=8953) AND A.DI_ID=" & Id & "  AND A.ANO_ID=C.PR_ID AND "
			strSQL = strSQL & "C.PR_TYPE=E.LU_ID and E.LU_NAME in ('Trámite de Inicio', 'Trámite', 'Trámite automático', 'Trámite general', 'Trámite General Automático','Ramificación') AND C.PR_TYPE<>23 "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC"
		Else
			strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID  "
			strSQL = strSQL & "From SHAPE A, JOINER B, PROCESS C, CW_LOOKUP E, DIAGRAM D Where "
			strSQL = strSQL & "A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_FROM AND (A.ANO_TABNR=8953) AND A.ANO_ID=C.PR_ID AND C.PR_TYPE=E.LU_ID and "
			strSQL = strSQL & "E.LU_NAME in ('Trámite de Inicio', 'Trámite', 'Trámite automático', 'Trámite general', 'Trámite General Automático','Ramificación') AND C.PR_TYPE<>23 AND "
			strSQL = strSQL & "D.DI_ID =A.DI_ID and D.DI_TYPE <> 1 and D.ANO_ID = " & Id
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
			strSQL = strSQL & " AND D.DI_TYPE <> " & gstrCodTramUsu
			'Inicio Jonathan Prieto 11/04/2011
			strSQL = strSQL & " AND D.ANO_TABNR=8953"
			'Fin Jonathan Prieto 11/04/2011
			'Fin Jonathan Prieto 28/10/2010
		End If
		System.Windows.Forms.Application.DoEvents()
		rstCon = mfRecordset(conDP4, strSQL)
		If Not rstCon.EOF Then
			'UPGRADE_WARNING: Couldn't resolve default property of object rstCon.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstCon.GetRows
			rstCon.MoveFirst()
		End If
		'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Me.pgbProceso.Value = 0
		j = 1
		colXML = New Collection
		colXML.Add("Categoría")
		While Not rstCon.EOF
			System.Windows.Forms.Application.DoEvents()
			msProceso(j, UBound(arr, 2) + 1, colact, colmax)
			System.Windows.Forms.Application.DoEvents()
			colXMLD = mfBuscaXML("Conector", colXML, rstCon.Fields("ANO_ID").Value, True)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strProp = colXMLD.Item(1)
			System.Windows.Forms.Application.DoEvents()
			'## ds66 31/03/09  Con este If no funcionan los conectores q salen y entran de la misma accion
			'If rstCon("SH_SEQ_FROM") <> rstCon("SH_SEQ_TO") Then
			'##
			If InStr(1, strAux, "-" & rstCon.Fields("SH_SEQ_FROM").Value & "-") = 0 Then
				'introduzco si el conector es de tipo resultado externo
				'Inicio Jonathan Prieto 28/10/2013
				strSQL = "SELECT EV_INTERNAL, EV_NAME" & " FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E" & " WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado'" & " AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.DI_ID=" & rstCon.Fields("DI_ID").Value & " AND D.SH_SEQ=" & rstCon.Fields("SH_SEQ_TO").Value & " AND A.MODEL_NAME ='" & strModelo & "'" & " AND B.MODEL_NAME ='" & strModelo & "'" & " AND D.MODEL_NAME ='" & strModelo & "'" & " AND E.MODEL_NAME ='" & strModelo & "'" & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2013
				rstAux = mfRecordset(conDP4, strSQL)
				If Not rstAux.EOF Then
					If rstAux.Fields("EV_INTERNAL").Value <> 1 Then
						lngTipo = 0
					Else
						lngTipo = 1
					End If
					'Inicio Jonathan 17/09/2013
					'If (InStr(1, rstAux("EV_NAME"), "Inicio ") <> 0 Or InStr(1, rstAux("EV_NAME"), "Fin ") <> 0) Then
					If VB.Left(rstAux.Fields("EV_NAME").Value, 7) = "Inicio " Or VB.Left(rstAux.Fields("EV_NAME").Value, 4) = "Fin " Then
						'Fin Jonathan 17/09/2013
						strSalida = "S"
					Else
						'No es un evento ni de Inicio... ni de Fin..., no nos interesa el conector opcional que apunte a él
						If strProp = "Conector Opcional" Then
							GoTo SiguienteConector
						Else
							strSalida = ""
						End If
					End If
				Else
					strSalida = ""
					lngTipo = 0
				End If
				
				strSQL = "INSERT INTO  CONECTORES_DI (PROCEDIMIENTO,ID_CONECTOR, DIAGRAMA, NUM, NUM_SEC_DESDE, NUM_SEC_HASTA, CAT_CONECTOR,DI_ID, "
				strSQL = strSQL & "ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, TIPO_CONECTOR, SALIDA) VALUES "
				strSQL = strSQL & "('" & gNomProcCorto & "'," & rstCon.Fields("JO_SEQ").Value & "," & Id & "," & NIVEL & "," & rstCon.Fields("SH_SEQ_FROM").Value & "," & rstCon.Fields("SH_SEQ_TO").Value & ",'" & strProp & "'," & rstCon.Fields("DI_ID").Value & ","
				strSQL = strSQL & ORDEN_N1 & "," & ORDEN_N2 & "," & ORDEN_N3 & "," & ORDEN_N4 & ", " & lngTipo & ", '" & strSalida & "')"
				mfExecute(conPasarela, strSQL)
			End If
			'## ds66 31/03/09
			'End If
			'##
SiguienteConector: 
			rstCon.MoveNext()
			j = j + 1
		End While
		rstCon.Close()
		If NIVEL = 1 Then
			strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID,P.PB_NAME "
			strSQL = strSQL & "FROM SHAPE A, PROCESS_BREAK P,JOINER B "
			strSQL = strSQL & "Where A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_TO AND A.ANO_ID = P.PB_ID AND A.DI_ID=" & Id & " AND A.ANO_TABNR=5257"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND P.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		Else
			strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID, C.PB_NAME "
			strSQL = strSQL & "From SHAPE A, JOINER B, PROCESS_BREAK C, DIAGRAM D "
			strSQL = strSQL & "Where A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_TO AND A.ANO_ID=C.PB_ID AND D.DI_ID =A.DI_ID and D.ANO_ID = " & Id & " AND A.ANO_TABNR=5257"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
			strSQL = strSQL & " AND D.DI_TYPE <> " & gstrCodTramUsu
			'Fin Jonathan Prieto 28/10/2010
		End If
		rstCon = mfRecordset(conDP4, strSQL)
		While Not rstCon.EOF
			strSQL = "UPDATE CONECTORES_DI "
			'Inicio Jonathan Prieto 27/12/2011. La CAT_CONECTOR2 de los conectores que van a un Process Break siemre será "Fin de Expediente"
			'strSQL = strSQL & "SET CAT_CONECTOR2='" & rstCon("PB_NAME") & "' "
			strSQL = strSQL & "SET CAT_CONECTOR2='Fin de Expediente' "
			'Fin Jonathan Prieto 27/12/2011
			strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_CONECTOR= " & rstCon.Fields("JO_SEQ").Value & " AND DIAGRAMA= " & Id & " AND "
			strSQL = strSQL & "NUM = " & NIVEL & " And NUM_SEC_DESDE=" & rstCon.Fields("SH_SEQ_FROM").Value & " AND NUM_SEC_HASTA=" & rstCon.Fields("SH_SEQ_TO").Value & " AND DI_ID=" & rstCon.Fields("DI_ID").Value
			mfExecute(conPasarela, strSQL)
			rstCon.MoveNext()
		End While
		strSQL = "UPDATE CONECTORES_DI "
		strSQL = strSQL & "SET CAT_CONECTOR='' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_CONECTOR='Excluyente'"
		mfExecute(conPasarela, strSQL)
		'UPGRADE_NOTE: Object rstCon may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstCon = Nothing
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Lectura de Conectores entre Diagramas", "Ha ocurrido un error no controlado", "msLec_Conectores_DI")
		Mostrar_Error()
		logError("msLec_Conectores_DI - " & Err.Description)
		Resume procFin
procFin: 
		CierraRS(rstCon)
		'UPGRADE_NOTE: Object rstCon may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstCon = Nothing
		CierraRS(rstXML)
		'UPGRADE_NOTE: Object rstXML may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstXML = Nothing
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
	End Sub
	
	Private Function msMismoEnlaceSinDefinir(ByVal rstEnlaceSinDefinir As ADODB.Recordset, ByVal rstTramiteEnlace As ADODB.Recordset, ByRef strOrden_Acc As String, ByRef strDestinoEnlace As String, ByRef blnBuscaAnterior As Boolean, Optional ByRef intId_EvAnt As Short = 0) As Boolean
		'Inicio Jonathan Prieto 09/02/2011: Nueva función para solucionar la resolución de la salida de un ENLACE_SIN_DEFINIR
		'cuando ya hay otro que tiene la misma salida dentro del mismo trámite.
		
		On Error GoTo ERROR_Renamed
		
		Dim rstParametro As ADODB.Recordset
		Dim rstAccion As ADODB.Recordset
		Dim rstConCorp As ADODB.Recordset
		Dim rstObjeto As ADODB.Recordset
		Dim rstSaltoTDU As ADODB.Recordset
		Dim strSQL As String
		Dim strSalida As String
		Dim strTipoAccion As String
		Dim intId_EvDestino As Short
		Dim intContTDU As Short
		
		If blnBuscaAnterior = True Then
			'Tengo que buscar el otro enlace que apunta al mismo sitio
			strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_N1=" & rstEnlaceSinDefinir.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstEnlaceSinDefinir.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3=" & rstEnlaceSinDefinir.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstEnlaceSinDefinir.Fields("ORDEN_N4").Value & " " & "AND VALOR='" & strDestinoEnlace & "' AND ORDEN_ACC<>" & strOrden_Acc
			rstEnlaceSinDefinir = mfRecordset(conPasarela, strSQL)
			If rstEnlaceSinDefinir.EOF Then
				GoTo ERROR_Renamed
			Else
				strOrden_Acc = rstEnlaceSinDefinir.Fields("ORDEN_ACC").Value
			End If
		End If
		'Averiguo el parámetro por el que sale el enlace
		'    & "AND VALOR IN (SELECT NOM_ACCION FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_N1=" & rstEnlaceSinDefinir.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstEnlaceSinDefinir.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3=" & rstEnlaceSinDefinir.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstEnlaceSinDefinir.Fields("ORDEN_N4").Value & " " & "AND VALOR IN (SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_N1=" & rstEnlaceSinDefinir.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstEnlaceSinDefinir.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3=" & rstEnlaceSinDefinir.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstEnlaceSinDefinir.Fields("ORDEN_N4").Value & " " & "AND ORDEN_ACC=" & strOrden_Acc & ")"
		rstParametro = mfRecordset(conPasarela, strSQL)
		'Puede ser un enlace que venga de una TDAUTOMATICA, TDUSUARIO ó de alguna otra acción (ej. INICIALIZACIONVAR)
		Dim colXML As Collection
		Dim lngShapeID As Short
		Dim intCodRespuesta As Short
		If Not rstParametro.EOF Then
			'TDAUTOMATICA ó TDUSUARIO
			strSalida = Trim(rstParametro.Fields("PARAMETRO").Value)
			'Averiguo la acción por la que sale el enlace
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_ACC=" & rstParametro.Fields("ORDEN_ACC").Value & " " & "AND ORDEN_N1=" & rstParametro.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstParametro.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3=" & rstParametro.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstParametro.Fields("ORDEN_N4").Value & " "
			rstAccion = mfRecordset(conPasarela, strSQL)
			If Not rstAccion.EOF Then
				strTipoAccion = Trim(rstAccion.Fields("NOM_ACCION").Value)
				Select Case strTipoAccion
					Case "TDAUTOMATICA"
						'Averiguo los conectores de salida de la TDAUTOMATICA
						strSQL = "SELECT * FROM CONNECTOR WHERE MODEL_NAME='" & strModelo & "' " & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " & "AND ANO_ID=" & rstTramiteEnlace.Fields("ID_DIAGRAMA").Value & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953) " & "AND CO_ID IN (SELECT ANO_ID FROM JOINER WHERE SH_SEQ_FROM=" & rstAccion.Fields("NUM_SEQ").Value & " AND MODEL_NAME='" & strModelo & "' " & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " & "AND ANO_ID=" & rstTramiteEnlace.Fields("ID_DIAGRAMA").Value & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953))"
						If strSalida = "@SALTOTRUE" Then
							strSQL = strSQL & " AND CO_TYPE=145"
						ElseIf strSalida = "@SALTOFALSE" Then 
							strSQL = strSQL & " AND CO_TYPE=152"
						End If
						rstConCorp = mfRecordset(conDP4, strSQL)
						If Not rstConCorp.EOF Then
							'Averiguo el objeto al que apunta el conector
							strSQL = "SELECT ANO_ID,ANO_TABNR FROM SHAPE WHERE MODEL_NAME='" & strModelo & "' " & "AND DI_ID=" & rstConCorp.Fields("DI_ID").Value & " AND SH_SEQ=(SELECT SH_SEQ_TO FROM JOINER " & "WHERE ANO_ID=" & rstConCorp.Fields("CO_ID").Value & " AND DI_ID=" & rstConCorp.Fields("DI_ID").Value & " " & "AND MODEL_NAME='" & strModelo & "')"
							rstObjeto = mfRecordset(conDP4, strSQL)
							If Not rstObjeto.EOF Then
								'Si es un tipo Evento, me guardo su ID para compararlo con el otro enlace
								If rstObjeto.Fields("ANO_TABNR").Value = 9097 Then
									If blnBuscaAnterior = False Then
										intId_EvDestino = rstObjeto.Fields("ANO_ID").Value
									Else
										'Viene buscando el otro enlace que apunta al mismo sitio
										If Val(rstObjeto.Fields("ANO_ID").Value) = intId_EvAnt Then
											'Apunta al mismo objeto
											msMismoEnlaceSinDefinir = True
										End If
										GoTo FIN
									End If
									'Ahora tengo que buscar el otro enlace que apunta al mismo sitio
									msMismoEnlaceSinDefinir = msMismoEnlaceSinDefinir(rstEnlaceSinDefinir, rstTramiteEnlace, strOrden_Acc, strDestinoEnlace, True, intId_EvDestino)
									If msMismoEnlaceSinDefinir = True Then
										GoTo FIN
									End If
								End If
							End If
						End If
						
					Case "TDUSUARIO"
						'Como es una TDUSUARIO primero tengo que averiguar el literal que le lleva a ése salto
						strSQL = "SELECT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_N1=" & rstEnlaceSinDefinir.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstEnlaceSinDefinir.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3=" & rstEnlaceSinDefinir.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstEnlaceSinDefinir.Fields("ORDEN_N4").Value & " " & "AND ORDEN_ACC=" & rstParametro.Fields("ORDEN_ACC").Value & " AND PARAMETRO='@LITERAL" & Val(Mid(strSalida, Len("@SALTO") + 1, Len(strSalida) - Len("@SALTO"))) & "'"
						rstSaltoTDU = mfRecordset(conPasarela, strSQL)
						If Not rstSaltoTDU.EOF Then
							'Inicio Jonathan Prieto 21/02/2011: comparar valor del literal de TDU con el CODIGORESPUESTA del campo USERDEFINED del conector
							'                'Ahora que ya sé el código, consigo el texto del literal de DB2
							'                Select Case strModelo
							'                Case "ARDATZ"
							'                    strSQL = "SELECT DESCCAMP FROM %owner%TBPFIN38 WHERE CODENTID=2 AND CODFAMIL=2 " _
							''                        & "AND CODRESTI=" & rstSaltoTDU("VALOR") & " AND TIPRESTI='R'"
							'                Case "WWKA24KV"
							'                    strSQL = "SELECT DESCCAMP FROM %owner%TBPFIN38 WHERE CODENTID=2 AND CODFAMIL=1 " _
							''                        & "AND CODRESTI=" & rstSaltoTDU("VALOR") & " AND TIPRESTI='R'"
							'                End Select
							'                Set conDB2 = New ADODB.Connection
							'                If ComprobarConexion(conDB2, ReadIniFile(INIFile, "DB2", "Connection")) = False Then
							'                    MsgBox "No se ha podido conectar a DB2, vuelva a lanzar la pasarela", vbCritical
							'                    End
							'                End If
							'                Set rstSaltoTDU = mfRecordset(conDB2, strSQL, "DB2")
							'                If Not rstSaltoTDU.EOF Then
							'                    'Averiguo los conectores de salida de la TDUSUARIO
							'                    strSQL = "SELECT * FROM CONNECTOR WHERE MODEL_NAME='" & strModelo & "' " _
							''                        & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " _
							''                        & "AND ANO_ID=" & rstTramiteEnlace("ID_DIAGRAMA") & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953) " _
							''                        & "AND CO_ID IN (SELECT ANO_ID FROM JOINER WHERE SH_SEQ_FROM=" & rstAccion("NUM_SEQ") & " AND MODEL_NAME='" & strModelo & "' " _
							''                        & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " _
							''                        & "AND ANO_ID=" & rstTramiteEnlace("ID_DIAGRAMA") & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953)) " _
							''                        & "AND UPPER(CO_CONDITION)='" & UCase(Trim(rstSaltoTDU("DESCCAMP"))) & "'"
							strSQL = "SELECT CO_ID, USERDEFINED, DI_ID FROM CONNECTOR WHERE MODEL_NAME='" & strModelo & "' " & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " & "AND ANO_ID=" & rstTramiteEnlace.Fields("ID_DIAGRAMA").Value & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953) " & "AND CO_ID IN (SELECT ANO_ID FROM JOINER WHERE SH_SEQ_FROM=" & rstAccion.Fields("NUM_SEQ").Value & " AND MODEL_NAME='" & strModelo & "' " & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " & "AND ANO_ID=" & rstTramiteEnlace.Fields("ID_DIAGRAMA").Value & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953))"
							rstConCorp = mfRecordset(conDP4, strSQL)
							While Not rstConCorp.EOF
								colXML = New Collection
								colXML.Add("Código Respuesta")
								colXML.Add("Indicador Valor Variable")
								colXML = mfBuscaXML("Conector", colXML, rstConCorp.Fields("CO_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXML(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								intCodRespuesta = CInt(Val(colXML.Item(1)))
								If Val(Trim(rstSaltoTDU.Fields("VALOR").Value)) = intCodRespuesta Then
									'Averiguo el objeto al que apunta el conector
									strSQL = "SELECT ANO_ID,ANO_TABNR FROM SHAPE WHERE MODEL_NAME='" & strModelo & "' " & "AND DI_ID=" & rstConCorp.Fields("DI_ID").Value & " AND SH_SEQ=(SELECT SH_SEQ_TO FROM JOINER " & "WHERE ANO_ID=" & rstConCorp.Fields("CO_ID").Value & " AND DI_ID=" & rstConCorp.Fields("DI_ID").Value & " " & "AND MODEL_NAME='" & strModelo & "')"
									rstObjeto = mfRecordset(conDP4, strSQL)
									If Not rstObjeto.EOF Then
										'Si es un tipo Evento, me guardo su ID para compararlo con el otro enlace
										If rstObjeto.Fields("ANO_TABNR").Value = 9097 Then
											If blnBuscaAnterior = False Then
												intId_EvDestino = rstObjeto.Fields("ANO_ID").Value
											Else
												'Viene buscando el otro enlace que apunta al mismo sitio
												If Val(rstObjeto.Fields("ANO_ID").Value) = intId_EvAnt Then
													'Apunta al mismo objeto
													msMismoEnlaceSinDefinir = True
												End If
												GoTo FIN
											End If
											'Ahora tengo que buscar el otro enlace que apunta al mismo sitio
											msMismoEnlaceSinDefinir = msMismoEnlaceSinDefinir(rstEnlaceSinDefinir, rstTramiteEnlace, strOrden_Acc, strDestinoEnlace, True, intId_EvDestino)
											If msMismoEnlaceSinDefinir = True Then
												GoTo FIN
											End If
										End If
									End If
								End If
								rstConCorp.MoveNext()
							End While
							'                    Set rstConCorp = mfRecordset(conDP4, strSQL)
							'                    If Not rstConCorp.EOF Then
							'                        'Averiguo el objeto al que apunta el conector
							'                        strSQL = "SELECT ANO_ID,ANO_TABNR FROM SHAPE WHERE MODEL_NAME='" & strModelo & "' " _
							''                            & "AND DI_ID=" & rstConCorp("DI_ID") & " AND SH_SEQ=(SELECT SH_SEQ_TO FROM JOINER " _
							''                            & "WHERE ANO_ID=" & rstConCorp("CO_ID") & " AND DI_ID=" & rstConCorp("DI_ID") & " " _
							''                            & "AND MODEL_NAME='" & strModelo & "')"
							'                        Set rstObjeto = mfRecordset(conDP4, strSQL)
							'                        If Not rstObjeto.EOF Then
							'                            'Si es un tipo Evento, me guardo su ID para compararlo con el otro enlace
							'                            If rstObjeto("ANO_TABNR") = 9097 Then
							'                                If blnBuscaAnterior = False Then
							'                                    intId_EvDestino = rstObjeto("ANO_ID")
							'                                Else
							'                                    'Viene buscando el otro enlace que apunta al mismo sitio
							'                                    If Val(rstObjeto("ANO_ID")) = intId_EvAnt Then
							'                                        'Apunta al mismo objeto
							'                                        msMismoEnlaceSinDefinir = True
							'                                    End If
							'                                    GoTo FIN
							'                                End If
							'                                'Ahora tengo que buscar el otro enlace que apunta al mismo sitio
							'                                msMismoEnlaceSinDefinir = msMismoEnlaceSinDefinir(rstEnlaceSinDefinir, rstTramiteEnlace, strOrden_Acc, strDestinoEnlace, True, intId_EvDestino)
							'                                If msMismoEnlaceSinDefinir = True Then
							'                                    GoTo FIN
							'                                End If
							'                            End If
							'                        End If
							'                    End If
							'                 End If
							'Fin Jonathan Prieto 21/02/2011
						End If
				End Select
			End If
		Else
			'No es ni una TDUSUARIO ni una TDAUTOMATICA, busco la acción anterior
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_N1=" & rstEnlaceSinDefinir.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstEnlaceSinDefinir.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3=" & rstEnlaceSinDefinir.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstEnlaceSinDefinir.Fields("ORDEN_N4").Value & " " & "AND ORDEN_ACC=" & CDbl(strOrden_Acc) - 1
			rstAccion = mfRecordset(conPasarela, strSQL)
			If Not rstAccion.EOF Then
				'Si es un PRO_ le llevo hasta el APE_
				If UCase(Trim(rstAccion.Fields("NOM_ACCION").Value)) = "PROCESS" Then
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_N1=" & rstEnlaceSinDefinir.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstEnlaceSinDefinir.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3=" & rstEnlaceSinDefinir.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstEnlaceSinDefinir.Fields("ORDEN_N4").Value & " " & "AND ORDEN_ACC=" & CDbl(strOrden_Acc) - 3
					rstAccion = mfRecordset(conPasarela, strSQL)
					If rstAccion.EOF Then GoTo FIN
				End If
				'Averiguo los conectores de salida de la acción
				strSQL = "SELECT * FROM CONNECTOR WHERE MODEL_NAME='" & strModelo & "' " & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " & "AND ANO_ID=" & rstTramiteEnlace.Fields("ID_DIAGRAMA").Value & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953) " & "AND CO_ID IN (SELECT ANO_ID FROM JOINER WHERE SH_SEQ_FROM=" & rstAccion.Fields("NUM_SEQ").Value & " AND MODEL_NAME='" & strModelo & "' " & "AND DI_ID=(SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " & "AND ANO_ID=" & rstTramiteEnlace.Fields("ID_DIAGRAMA").Value & " AND DI_TYPE<> " & gstrCodTramUsu & " AND ANO_TABNR=8953))"
				rstConCorp = mfRecordset(conDP4, strSQL)
				While Not rstConCorp.EOF
					'Averiguo el objeto al que apunta el conector
					strSQL = "SELECT ANO_ID,ANO_TABNR FROM SHAPE WHERE MODEL_NAME='" & strModelo & "' " & "AND DI_ID=" & rstConCorp.Fields("DI_ID").Value & " AND SH_SEQ=(SELECT SH_SEQ_TO FROM JOINER " & "WHERE ANO_ID=" & rstConCorp.Fields("CO_ID").Value & " AND DI_ID=" & rstConCorp.Fields("DI_ID").Value & " " & "AND MODEL_NAME='" & strModelo & "')"
					rstObjeto = mfRecordset(conDP4, strSQL)
					If Not rstObjeto.EOF Then
						'Si es un tipo Evento, me guardo su ID para compararlo con el otro enlace
						If rstObjeto.Fields("ANO_TABNR").Value = 9097 Then
							If blnBuscaAnterior = False Then
								intId_EvDestino = rstObjeto.Fields("ANO_ID").Value
							Else
								'Viene buscando el otro enlace que apunta al mismo sitio
								If Val(rstObjeto.Fields("ANO_ID").Value) = intId_EvAnt Then
									'Apunta al mismo objeto
									msMismoEnlaceSinDefinir = True
								End If
								GoTo FIN
							End If
							'Ahora tengo que buscar el otro enlace que apunta al mismo trámite
							msMismoEnlaceSinDefinir = msMismoEnlaceSinDefinir(rstEnlaceSinDefinir, rstTramiteEnlace, CStr(CDbl(strOrden_Acc) - 1), strDestinoEnlace, True, intId_EvDestino)
							If msMismoEnlaceSinDefinir = True Then
								GoTo FIN
							End If
						End If
					End If
					rstConCorp.MoveNext()
				End While
			End If
		End If
		
		GoTo FIN
		
ERROR_Renamed: 
		Insertar_Error(Me, "Mismo Enlace Sin Definir", "No se ha podido hallar el diferente enlace que apunta a " & UCase(strDestinoEnlace) & " debido a que se ha producido el siguiente error: " & Err.Description & ".", "Enlaces Sin Definir")
		logError("No se ha podido encontrar el otro enlace que apunta " & UCase(strDestinoEnlace) & " debido a que se ha producido el siguiente error: " & Err.Description & ".")
FIN: 
		'UPGRADE_NOTE: Object rstEnlaceSinDefinir may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstEnlaceSinDefinir = Nothing
		'UPGRADE_NOTE: Object rstTramiteEnlace may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTramiteEnlace = Nothing
		'UPGRADE_NOTE: Object rstParametro may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstParametro = Nothing
		'UPGRADE_NOTE: Object rstAccion may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAccion = Nothing
		'UPGRADE_NOTE: Object rstConCorp may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstConCorp = Nothing
		'UPGRADE_NOTE: Object rstObjeto may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstObjeto = Nothing
		'UPGRADE_NOTE: Object rstSaltoTDU may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstSaltoTDU = Nothing
		
		'Fin Jonathan Prieto 09/02/2011
	End Function
	
	Private Sub msProceso(ByVal recact As Integer, ByVal recmax As Integer, ByVal colact As Integer, ByVal colmax As Integer)
		
		On Error Resume Next
		
		'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Me.pgbProceso.Value = (((recact / recmax) * 100) / colmax) + (((colact - 1) / colmax) * 100)
		System.Windows.Forms.Application.DoEvents()
		
	End Sub
	
	
	Public Sub msPropiedades_Proc(ByVal colEntrada As Collection)
		
		On Error GoTo procErr
		
		Dim rstAux As ADODB.Recordset
		Dim rstCon As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim strSQL As String
		Dim lngShapeID As Integer
		Dim strXML As String
		Dim intNivel As Integer
		Dim strName As String
		Dim intVersion As Integer
		Dim strPath As String
		Dim colXML As Collection
		Dim colXMLD As Collection
		Dim I As Short
		Dim Tiempo As Integer
		'Ainhoa 23/11/2007
		'recordset para coger el valor para filtrar ANO_TABNR
		Dim rstIDDiagram As ADODB.Recordset
		'fin Ainhoa
		
		lblMensaje.Text = "Obteniendo información del PROCEDIMIENTO"
		msProceso(1, 5, 1, 1)
		System.Windows.Forms.Application.DoEvents()
		'Ainhoa 23/11/2007
		'Cojo el ID por el que se va a filtra ANO_TABNR
		rstIDDiagram = New ADODB.Recordset
		strSQL = "Select OT_ID From CW_OBJECT_TYPE Where OT_NAME='Procedimiento'"
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND MODEL_NAME ='" & strModelo & "'"
		
		rstIDDiagram = mfRecordset(conDP4, strSQL)
		'*****************************************
		
		rstCon = New ADODB.Recordset
		strSQL = "SELECT A.ANO_ID,A.DI_ID, B.DI_NAME FROM SHAPE A, DIAGRAM B "
		'UPGRADE_WARNING: Couldn't resolve default property of object colEntrada()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = strSQL & "WHERE A.DI_ID=B.DI_ID AND A.DI_ID= " & colEntrada.Item(1)(0) & " AND A.ANO_TABNR=" & rstIDDiagram.Fields("OT_ID").Value
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		
		rstCon = mfRecordset(conDP4, strSQL)
		strName = rstCon.Fields("DI_NAME").Value
		lngShapeID = CInt(Val(CStr(rstCon.Fields("ANO_ID").Value & "")))
		rstCon.Close()
		colXML = New Collection
		colXML.Add("Nivel Autorización Inicio")
		'''busco el nivel de autorización de inicio
		colXMLD = mfBuscaXML("Procedimiento", colXML, lngShapeID)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		intNivel = CInt(Val(colXMLD.Item(1)))
		'inserto en la tabla de grupos de procedimientos administrativos P1 en castellano y euskera
		strSQL = "INSERT INTO TBDCELTA_PA (PROCEDIMIENTO,ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE) VALUES ('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','P1','C','" & gstrGrupo & "')"
		mfExecute(conPasarela, strSQL)
		strSQL = "INSERT INTO TBDCELTA_PA (PROCEDIMIENTO,ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE) VALUES ('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','P1','E','" & gstrGrupo & "')"
		mfExecute(conPasarela, strSQL)
		conDB2 = New ADODB.Connection
		If ComprobarConexion(conDB2, ReadIniFile(INIFile, "DB2", "Connection")) = False Then
			MsgBox("No se ha podido conectar a DB2, vuelva a lanzar la pasarela", MsgBoxStyle.Critical)
			End
		End If
		rstProp = New ADODB.Recordset
		strSQL = "SELECT CODPROCE FROM %owner%TBPFIN01 WHERE CODEXTPR='" & UCase(Mid(strName, 1, lngNombre)) & "'" & " AND CODENTID=" & strCodEntid & " AND CODFAMIL=" & strCodFamil
		rstAux2 = mfRecordset(conDB2, strSQL, "DB2")
		If rstAux2.EOF Then
			blnParar = True
			'Inicio Jonathan Prieto 27/04/2011
			'MsgBox "El procedimiento " & strName & " no está dado de alta en BIDERATUZ"
			MsgBox("El procedimiento " & strName & " no está dado de alta en la aplicación de INFRAESTRUCTURA (T0)")
			'Fin Jonathan Prieto 27/04/2011
			tramiteAnterior = ""
			Me.Close()
			GoTo procErr
		Else
			lngCodProc = rstAux2.Fields("CODPROCE").Value
		End If
		msProceso(4, 5, 1, 1)
		System.Windows.Forms.Application.DoEvents()
		'Inserto en Procedimientos adif ministrativos
		strSQL = "INSERT INTO TBPFIN01_PA (PROCEDIMIENTO,CODPROCE, CODENTID, CODFAMIL, CODEXTPR, CODGRPRO, DIRECCM) VALUES "
		strSQL = strSQL & "('" & gNomProcCorto & "'," & lngCodProc & "," & strCodEntid & "," & strCodFamil & ",'" & Mid(strName, 1, lngNombre) & "', '" & gstrGrupo & "','/ " & Mid(strName, 1, lngNombre) & "_ca/DI" & lngCodProc & ".htm'  )"
		mfExecute(conPasarela, strSQL)
		'inserto en la tabla de grupos de procedimientos administrativos P3 en castellano y euskera
		
		strSQL = "INSERT INTO TBDCELTA_PA (PROCEDIMIENTO,ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, ELTA_DESC20, ELTA_DESC40, ELTA_DESC60) VALUES "
		'aketza 21/08/2007
		'strSQL = strSQL & "('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','P3','C','" & String(10 - Len(CStr(lngCodProc)), "0") & Trim(CStr(lngCodProc)) & "', '" & Mid(strName, 8, 20) & "','" & Mid(strName, 8, 40) & "','" & Mid(strName, 8, 60) & "')"
		strSQL = strSQL & "('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','P3','C','" & New String("0", 10 - Len(CStr(lngCodProc))) & Trim(CStr(lngCodProc)) & "', '" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 20) & "','" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 40) & "','" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 60) & "')"
		'fin aketza
		mfExecute(conPasarela, strSQL)
		If strTipoFamilia = "Función Pública" Then
			strSQL = "INSERT INTO TBDCELTA_PA(PROCEDIMIENTO,ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, ELTA_DESC20, ELTA_DESC40, ELTA_DESC60) VALUES "
			'aketza 21/08/2007
			'strSQL = strSQL & "('" & gNomProcCorto & "','0201','P3','E','" & String(10 - Len(CStr(lngCodProc)), "0") & Trim(CStr(lngCodProc)) & "', 'E-" & Mid(strName, 8, 18) & "','E-" & Mid(strName, 8, 38) & "','E-" & Mid(strName, 8, 58) & "')"
			strSQL = strSQL & "('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','P3','E','" & New String("0", 10 - Len(CStr(lngCodProc))) & Trim(CStr(lngCodProc)) & "', 'E-" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 18) & "','E-" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 38) & "','E-" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 58) & "')"
			'fin aketza
		ElseIf strTipoFamilia = "Acción Social" Or strTipoFamilia = "Acción Social IFAS" Then 
			strSQL = "INSERT INTO TBDCELTA_PA(PROCEDIMIENTO,ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, ELTA_DESC20, ELTA_DESC40, ELTA_DESC60) VALUES "
			'aketza 21/08/2007
			'strSQL = strSQL & "('" & gNomProcCorto & "','0202','P3','E','" & String(10 - Len(CStr(lngCodProc)), "0") & Trim(CStr(lngCodProc)) & "', 'E-" & Mid(strName, 8, 18) & "','E-" & Mid(strName, 8, 38) & "','E-" & Mid(strName, 8, 58) & "')"
			strSQL = strSQL & "('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','P3','E','" & New String("0", 10 - Len(CStr(lngCodProc))) & Trim(CStr(lngCodProc)) & "', 'E-" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 18) & "','E-" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 38) & "','E-" & Mid(Trim(Replace(strName, gNomProcCorto, "")), 1, 58) & "')"
			'fin aketza
		End If
		mfExecute(conPasarela, strSQL)
		msProceso(5, 5, 1, 1)
		System.Windows.Forms.Application.DoEvents()
		'inserto la primera acción Arranque de expediente
		strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN='ARRANQUEEXPEDIENTE'"
		rstCon = mfRecordset(conInfra, strSQL)
		'Inicio Jonathan Prieto 17/01/2011 - Añado valor al campo DI_ID, el ID del diagrama padre)
		'strSQL = "INSERT INTO DIAGRAMA(PROCEDIMIENTO,ORDEN_N1,ID_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NOMBRE) VALUES ('" & gNomProcCorto & "',0,0," & colPasar(1)(0) & ", 0,'N','Arranque Expediente')"
		'UPGRADE_WARNING: Couldn't resolve default property of object colPasar(1)(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		'UPGRADE_WARNING: Couldn't resolve default property of object colPasar()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = "INSERT INTO DIAGRAMA(PROCEDIMIENTO,ORDEN_N1,ID_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NOMBRE,DI_ID) VALUES ('" & gNomProcCorto & "',0,0," & colPasar.Item(1)(0) & ", 0,'N','Arranque Expediente'," & colPasar.Item(1)(0) & ")"
		'Fin Jonathan Prieto 17/01/2011
		mfExecute(conPasarela, strSQL)
		mfInserta_PROPIEDADES(0, 0, 0, 0, 0, 0, "PR_ARRANQUEEXPEDIENTE", "", "", "", "", "", "", "0")
		strSQL = "INSERT INTO TBPFIN03_PA (PROCEDIMIENTO,CODPROCE,ORDENTRA,CODTRAAD,NOMBRE,NIVTRAMI) VALUES "
		strSQL = strSQL & "('" & gNomProcCorto & "'," & lngCodProc & ",0,0,'PR_ARRANQUEEXPEDIENTE',0)"
		mfExecute(conPasarela, strSQL)
		''''''''''''''''''''''''''''''''
		mfInserta_ACCIONES(0, 0, 0, 0, 0, 0, rstCon.Fields("IDACCION").Value, "ARRANQUEEXPEDIENTE", 1, rstCon.Fields("INDTIPOA").Value, "APE_ARRANQUEEXPEDIENTE", 0, 0, "", "", "")
		blnInserta = True
		msInsertaParamAcc("", "", 0, 0, 0, 0, 0, 0)
		mfInserta_ACCIONES(0, 0, 0, 0, 0, 1, rstCon.Fields("IDACCION").Value, "ENDPROC", 1, rstCon.Fields("INDTIPOA").Value, "EDP_ARRANQUEEXPEDIENTE", 0, 0, "", "", "")
		mfInserta_ACCIONES(0, 0, 0, 0, 0, 2, rstCon.Fields("IDACCION").Value, "PROCESS", 1, rstCon.Fields("INDTIPOA").Value, "PRO_ARRANQUEEXPEDIENTE", 0, 0, "", "", "")
		strSQL = "SELECT COUNT(*) FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=0"
		rstAux = mfRecordset(conPasarela, strSQL)
		blnInserta = False
		msInsertaParamAcc("@USIDSOLI", "@INICIO!USIDSOLI", 0, 0, 0, 0, 0, 0)
		msInsertaParamAcc("@URGENCIA", "@INICIO!URGENCIA", 0, 0, 0, 0, 0, 0)
		msInsertaParamAcc("@COMENTARIOC", "@INICIO!COMENTARIOC", 0, 0, 0, 0, 0, 0)
		msInsertaParamAcc("@COMENTARIOE", "@INICIO!COMENTARIOE", 0, 0, 0, 0, 0, 0)
		msInsertaParamAcc("@ID_PROC_JX", "@INICIO!ID_PROC_JX", 0, 0, 0, 0, 0, 0)
		msInsertaParamAcc("@ID_ENTRADA", "@INICIO!ID_ENTRADA", 0, 0, 0, 0, 0, 0)
		blnInserta = True
		mfExecute(conPasarela, strSQL)
		strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_ARRANQUEEXPEDIENTE' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=0 AND ORDEN_N2=0 AND ORDEN_N3=0 AND ORDEN_N4=0 AND ORDEN_N5=0 AND PARAMETRO='@PATHRETORNO'"
		mfExecute(conPasarela, strSQL)
		'insertamos un JUMP en el arranque expediente
		strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID "
		strSQL = strSQL & "FROM SHAPE A, JOINER B, PROCESS C, CW_LOOKUP E "
		'UPGRADE_WARNING: Couldn't resolve default property of object colPasar()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = strSQL & "Where A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_FROM AND (A.ANO_TABNR=8953) AND A.DI_ID=" & colPasar.Item(1)(0) & "  AND A.ANO_ID=C.PR_ID AND "
		strSQL = strSQL & "C.PR_TYPE=E.LU_ID and E.LU_NAME in ('Alta Expediente')"
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC"
		rstCon = mfRecordset(conDP4, strSQL)
		If rstCon.RecordCount > 1 Then
			'buscaremos si los dos destinos existen
			For I = 1 To rstCon.RecordCount - 1
				strSQL = "SELECT COUNT(*) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=1 AND NUM_SEQ=" & rstCon.Fields(6).Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If rstAux2.Fields(0).Value = 0 Then
					GoTo solo1Jump
				End If
				rstCon.MoveNext()
			Next I
			rstCon.MoveFirst()
			'insertamos fly
			For I = 1 To rstCon.RecordCount - 1
				mfInserta_ACCIONES(0, 0, 0, 0, 0, (2 * rstCon.AbsolutePosition) + 1, 0, "FLY", rstCon.AbsolutePosition, "", "PRO_ARRANQUEEXPEDIENTE" & VB6.Format(rstCon.AbsolutePosition, "00"), 0, 0, "FLY", "", "")
				mfInserta_ACCIONES(0, 0, 0, 0, 0, (2 * rstCon.AbsolutePosition) + 2, 0, "JUMP", rstCon.AbsolutePosition, "", "JUMP" & VB6.Format(rstCon.AbsolutePosition, "00"), 0, 0, "ISFLY", "", "")
				blnInserta = False
				msInsertaParamAcc("PATH", CStr(rstCon.AbsolutePosition & ";0;0;0;0"), 0, 0, 0, 0, 0, CInt((2 * rstCon.AbsolutePosition) + 2))
				blnInserta = True
				rstCon.MoveNext()
			Next 
			mfInserta_ACCIONES(0, 0, 0, 0, 0, (2 * rstCon.RecordCount) + 1, 0, "JUMP", rstCon.RecordCount, "", "JUMP" & VB6.Format(rstCon.RecordCount, "00"), 0, 0, "", "", "")
			blnInserta = False
			msInsertaParamAcc("PATH", CStr(rstCon.RecordCount & ";0;0;0;0"), 0, 0, 0, 0, 0, CInt((2 * rstCon.RecordCount) + 1))
			blnInserta = True
		Else
			'solo jump
solo1Jump: 
			mfInserta_ACCIONES(0, 0, 0, 0, 0, 4, 0, "JUMP", 1, "", "JUMP1", 0, 0, "", "", "")
			strSQL = "SELECT MAX(ORDEN_ACC) FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=0"
			rstProp = mfRecordset(conPasarela, strSQL)
			blnInserta = False
			msInsertaParamAcc("PATH", "1;0;0;0;0", 0, 0, 0, 0, 0, 4)
			blnInserta = True
		End If
		CierraCN(conDB2)
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Lectura de Propiedades del Procedimiento", "Ha ocurrido un error no controlado", "msPropiedades_Proc")
		Mostrar_Error()
		logError("msPropiedades_Proc - " & Err.Description)
		Resume procFin
		
procFin: 
		CierraCN(conDB2)
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rstCon)
		'UPGRADE_NOTE: Object rstCon may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstCon = Nothing
		CierraRS(rstProp)
		'UPGRADE_NOTE: Object rstProp may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProp = Nothing
		CierraRS(rstAux2)
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
	End Sub
	
	
	Private Sub msPruebaTDAUTOMATICA(ByRef blnfin As Boolean, ByRef blnSalto As Boolean, ByRef blnSalto1 As Boolean, ByRef blnSalto2 As Boolean, ByRef strSQL As String, ByRef rstAux2 As ADODB.Recordset, ByRef lngNumAcc As Integer, ByRef lngUlt As Integer, ByRef lngORACC As Integer, ByRef blnInserta As Boolean, ByRef nomTram As String, ByRef nomTramS As String, ByRef rstAux5 As ADODB.Recordset, ByRef strsalto As String, ByRef rstTram As ADODB.Recordset, ByRef rstAux3 As ADODB.Recordset, ByRef rstTRAMS As ADODB.Recordset, ByRef rstAux4 As ADODB.Recordset, ByRef rstAux6 As ADODB.Recordset, ByRef strAuxiliar As String, ByRef rstACC2 As ADODB.Recordset, ByRef rstAcc As ADODB.Recordset, ByVal orden1 As Integer, ByVal orden2 As Integer, ByVal orden3 As Integer, ByVal orden4 As Integer, ByVal orden5 As Integer)
		
		blnfin = True
		If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
		Else
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION like '" & strsalto & "SALTO%'"
		End If
		rstAux2 = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & orden1 & " AND ORDEN_N2=" & orden2 & " AND ORDEN_N3=" & orden3 & " AND ORDEN_N4=" & orden4 & " AND ORDEN_N5=" & orden5 & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
		rstAux2 = mfRecordset(conPasarela, strSQL)
		While Not rstAux2.EOF
			strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
			strSQL = strSQL & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
			mfExecute(conPasarela, strSQL)
			strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
			mfExecute(conPasarela, strSQL)
			lngUlt = rstAux2.Fields("ORDEN_ACC").Value
			rstAux2.MoveNext()
		End While
		If lngUlt <> 0 Then
			lngORACC = lngUlt
		Else
			strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
			rstAux3 = mfRecordset(conPasarela, strSQL)
			lngORACC = rstAux3.Fields(0).Value + 1
		End If
		j = j + 1
		If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
			'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA)
			'VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," &
			'rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",
			'LET INICIALIZACIONVAR" & Format(lngNumAcc, "00") & "')"
			mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
		Else
			If blnSalto2 = False Then
				'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'" & strsalto & "SALTO" & Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & Format(1, "00") & "')"
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, strsalto & "SALTO" & VB6.Format(1, "00"), lngNumAcc, "", strsalto & "SALTO" & VB6.Format(1, "00"), 0, 0, "", "", "")
			Else
				'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'" & strsalto & "SALTO" & Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & Format(2, "00") & "')"
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, strsalto & "SALTO" & VB6.Format(2, "00"), lngNumAcc, "", strsalto & "SALTO" & VB6.Format(2, "00"), 0, 0, "", "", "")
			End If
		End If
		'mfExecute conPasarela, strSQL
		blnInserta = False
		strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
		rstAux2 = mfRecordset(conPasarela, strSQL)
		If Not rstAux2.EOF Then
			nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
		Else
			nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
		End If
		If Not rstAux4 Is Nothing Then
			If Not rstAux4.EOF Then
				strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
			ElseIf Not rstTRAMS.EOF Then 
				strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
			Else
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=0"
				rstAux4 = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux4.Fields("DI_ID").Value & " AND NUM_SEC_DESDE=" & rstAux4.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR not in ('Conector Opcional','Fin de plazo 2')"
				rstAux5 = mfRecordset(conPasarela, strSQL)
				If rstAux5.EOF Then
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo saltosinconectores
				End If
				Do While Not rstAux5.EOF
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux5.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstAux4.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					rstAux6 = mfRecordset(conPasarela, strSQL)
					If Not rstAux6.EOF Then
						strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
						Exit Do
					End If
					rstAux5.MoveNext()
				Loop 
			End If
		ElseIf Not rstTRAMS.EOF Then 
			strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
		Else
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=0"
			rstAux4 = mfRecordset(conPasarela, strSQL)
			strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux4.Fields("DI_ID").Value & " AND NUM_SEC_DESDE=" & rstAux4.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR not in ('Conector Opcional','Fin de plazo 2')"
			rstAux5 = mfRecordset(conPasarela, strSQL)
			If rstAux5.EOF Then
				nomTramS = "PR_FINEXPEDIENTE"
				GoTo saltosinconectores
			End If
			Do While Not rstAux5.EOF
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux5.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstAux4.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				rstAux6 = mfRecordset(conPasarela, strSQL)
				If Not rstAux6.EOF Then
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
					Exit Do
				End If
				rstAux5.MoveNext()
			Loop 
		End If
		rstAux2 = mfRecordset(conPasarela, strSQL)
		If Not rstAux2.EOF Then
			nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
			If nomTramS = "" Then
				strAuxiliar = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 "
				'Inicio Jonathan 01/02/2012
				If rstAux2.Fields("ORDEN_N2").Value = 0 Then
					'strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2>" & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
					'strSQL = strAuxiliar & " >= " & rstAux2("ORDEN_N2") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					strSQL = strAuxiliar & " > " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
					'strSQL = strAuxiliar & " = " & rstAux2("ORDEN_N2") & " AND ORDEN_N3 >=" & rstAux2("ORDEN_N3") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					strSQL = strAuxiliar & " = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
					'strSQL = strAuxiliar & " = " & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND ORDEN_N4 >=" & rstAux2("ORDEN_N4") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					strSQL = strAuxiliar & " = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				Else
					'strSQL = strAuxiliar & "  = " & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND ORDEN_N4 = " & rstAux2("ORDEN_N4") & " AND ORDEN_N5 >=" & rstAux2("ORDEN_N5") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					strSQL = strAuxiliar & "  = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >" & rstAux2.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				End If
				'Fin Jonathan 01/02/2012
				rstAux2 = mfRecordset(conPasarela, strSQL)
				Do While Not rstAux2.EOF
					If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
						nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
						Exit Do
					End If
					rstAux2.MoveNext()
					nomTramS = "PR_FINEXPEDIENTE"
				Loop 
			End If
		Else
			nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
		End If
saltosinconectores: 
		msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
		rstACC2 = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
		lngORACC = lngORACC + 1
		'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
		'mfExecute conPasarela, strSQL
		mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
		blnInserta = False
		blnIns = True
		regPlus = regPlus + 1 '
		msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
		
	End Sub
	
	Public Sub msVariables_Alta(ByVal colEntrada As Collection)
		On Error GoTo procErr
		Dim rstVar As ADODB.Recordset
		Dim rstVar2 As ADODB.Recordset
		Dim rstVar3 As ADODB.Recordset
		Dim strSQL As String
		Dim strNOM As String
		Dim montaVar() As String
		Dim I As Integer
		Dim j As Integer
		Dim arr As Object
		Dim arr2 As Object
		Dim A As Object
		
		rstVar = New ADODB.Recordset
		mfExecute(conPasarela, "DELETE FROM VAR_ALTA_PA where PROCEDIMIENTO='" & gNomProcCorto & "'")
		
		lblMensaje.Text = "Obteniendo Variables de Alta"
		strSQL = "Select A.PR_ID, A.PR_NAME, E.DI_NAME "
		strSQL = strSQL & "From PROCESS A, CW_PROP_TYPE B, CW_LOOKUP C, SHAPE D, DIAGRAM E "
		strSQL = strSQL & "Where A.PR_TYPE = C.LU_ID and D.ANO_ID = A.PR_ID and B.PPT_ID = C.PPT_ID and B.PPT_FIELD_NAME = 'PR_TYPE' and "
		strSQL = strSQL & "C.LU_NAME   in ('Alta Expediente') and D.ANO_TABNR = 8953 and D.ANO_ID <> E.ANO_ID "
		'UPGRADE_WARNING: Couldn't resolve default property of object colEntrada()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = strSQL & " and E.DI_ID = D.DI_ID and E.DI_ID = " & colEntrada.Item(1)(0)
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		rstVar = mfRecordset(conDP4, strSQL, CStr(True))
		I = 1
		While Not rstVar.EOF
			strSQL = "SELECT A.AT_NAME, C.PR_NAME, A.AT_ID FROM ATTRIBUTE A, CW_DATA_USAGE B,PROCESS C "
			strSQL = strSQL & "WHERE A.AT_ID=B.AT_ID AND B.PR_ID=C.PR_ID AND B.PR_ID = " & rstVar.Fields("PR_ID").Value & " "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " order by B.DM_SEQ"
			rstVar2 = mfRecordset(conDP4, strSQL)
			If Not rstVar2.EOF Then
				'UPGRADE_WARNING: Couldn't resolve default property of object rstVar2.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				arr = rstVar2.GetRows
				rstVar2.MoveFirst()
			End If
			'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			Me.pgbProceso.Value = 0
			lblMensaje.Text = "Volcando información VARIABLES DE ALTA"
			j = 1
			While Not rstVar2.EOF
				msProceso(j, UBound(arr, 2) + 1, I, rstVar.RecordCount)
				System.Windows.Forms.Application.DoEvents()
				'busco el nombre de hidra en Infra
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object A. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				A = mfInsertaVariables(rstVar2.Fields("AT_ID").Value, rstVar2.Fields("AT_NAME").Value, True, Mid(rstVar.Fields("DI_NAME").Value, 1, lngNombre), j)
				rstVar2.MoveNext()
				j = j + 1
			End While
			rstVar.MoveNext()
			I = I + 1
		End While
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Lectura de Variables de Alta", "Ha ocurrido un error no controlado", "msVariables_Alta")
		Mostrar_Error()
		logError("msVariables_Alta - " & Err.Description)
		Resume procFin
		
procFin: 
		CierraRS(rstVar)
		'UPGRADE_NOTE: Object rstVar may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstVar = Nothing
		CierraRS(rstVar2)
		'UPGRADE_NOTE: Object rstVar2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstVar2 = Nothing
		CierraRS(rstVar3)
		'UPGRADE_NOTE: Object rstVar3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstVar3 = Nothing
		
	End Sub
	
	
	
	Public Sub msUd_Tramitacion()
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstUT As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim strXML As String
		Dim strCod As String
		Dim strNivel As String
		Dim strTipo As String
		Dim strCadenaXML As Object
		Dim arr As Object
		Dim j As Integer
		Dim colXML As Collection
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim pasada As Boolean
		
		rstUT = New ADODB.Recordset
		lblMensaje.Text = "Leyendo unidades de tramitación"
		strSQL = "SELECT OU_ID, OU_NAME "
		strSQL = strSQL & "FROM ORGANIZATION A, CW_PROP_TYPE B, CW_LOOKUP C "
		strSQL = strSQL & "WHERE A.OU_TYPE=C.LU_ID AND B.PPT_ID=C.PPT_ID AND B.PPT_FIELD_NAME='OU_TYPE' AND C.LU_NAME NOT IN ('Cabeceras diagrama','Procesos Automáticos','Unidades Mantenimiento') "
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & "Union SELECT OU_ID, OU_NAME FROM ORGANIZATION A WHERE A.OU_TYPE Is Null "
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		System.Windows.Forms.Application.DoEvents()
		rstUT = mfRecordset(conDP4, strSQL)
		System.Windows.Forms.Application.DoEvents()
		If rstUT.EOF = False Then
			'UPGRADE_WARNING: Couldn't resolve default property of object rstUT.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstUT.GetRows
			System.Windows.Forms.Application.DoEvents()
			rstUT.MoveFirst()
		End If
		'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Me.pgbProceso.Value = 0
		j = 1
		colXML = New Collection
		colXML2 = New Collection
		colXML.Add("Código Unidad")
		colXML2.Add("Nivel Conversión")
		colXML2.Add("Tipo Unidad Tramitación")
		strSQL = "select * from procesos_pendientes where USERID='" & strUserId & "' and FINALIZADO='S' order by NOMBRE_CM desc"
		'*********************************
		System.Windows.Forms.Application.DoEvents()
		rstAux = mfRecordset(conPasarela, strSQL)
		If rstAux.EOF = True Then
			While Not rstUT.EOF
				System.Windows.Forms.Application.DoEvents()
				rstProp = New ADODB.Recordset
				msProceso(j, UBound(arr, 2) + 1, 1, 1)
				System.Windows.Forms.Application.DoEvents()
				colXMLD = mfBuscaXML("Organización", colXML, rstUT.Fields("OU_ID").Value)
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strCod = IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1))
				If strCod <> "" Then
					'UPGRADE_NOTE: Object colXMLD may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
					colXMLD = Nothing
					colXMLD = mfBuscaXML("Organización", colXML2, rstUT.Fields("OU_ID").Value, True)
					'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strNivel = IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1))
					'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strTipo = IIf(colXMLD.Item(2) = "-1", "", colXMLD.Item(2))
					If strNivel <> "" Then
						strNivel = Mid(strNivel, 1, 1)
					End If
					If strTipo <> "" Then
						strTipo = Mid(strTipo, 1, 1)
					End If
					System.Windows.Forms.Application.DoEvents()
					strSQL = "INSERT INTO TBPFIN23_PA (PROCEDIMIENTO,CODENTID, CODFAMIL, CODUNITR,CODUTRHN, INDCONVE, TIPOUNTR, NUMORG) VALUES "
					strSQL = strSQL & "('" & gNomProcCorto & "'," & strCodEntid & "," & strCodFamil & "," & CShort(rstUT.Fields("OU_ID").Value) & ",'" & Mid(strCod, 1, 15) & "','" & strNivel & "', '" & strTipo & "'," & rstUT.Fields("OU_ID").Value & ")"
					'logError strSQL
					mfExecute(conPasarela, strSQL)
					strSQL = "INSERT INTO TBDCELTA_PA (PROCEDIMIENTO,ELTA_AMBITO,ELTA_CODTAB,ELTA_IDIOMA,ELTA_CLAVE,ELTA_DESC20,ELTA_DESC40,ELTA_DESC60) VALUES "
					strSQL = strSQL & "('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','PB','C','" & New String("0", 6 - Len(Trim(CStr(rstUT.Fields("OU_ID").Value)))) & Trim(CStr(rstUT.Fields("OU_ID").Value)) & "','" & Mid(rstUT.Fields("OU_NAME").Value, 1, 20) & "','" & Mid(rstUT.Fields("OU_NAME").Value, 1, 40) & "','" & Mid(rstUT.Fields("OU_NAME").Value, 1, 60) & "')"
					System.Windows.Forms.Application.DoEvents()
					mfExecute(conPasarela, strSQL)
					System.Windows.Forms.Application.DoEvents()
					strSQL = "INSERT INTO TBDCELTA_PA (PROCEDIMIENTO,ELTA_AMBITO,ELTA_CODTAB,ELTA_IDIOMA,ELTA_CLAVE,ELTA_DESC20,ELTA_DESC40,ELTA_DESC60) VALUES "
					strSQL = strSQL & "('" & gNomProcCorto & "','" & strCodEntid & strCodFamil & "','PB','E','" & New String("0", 6 - Len(Trim(CStr(rstUT.Fields("OU_ID").Value)))) & Trim(CStr(rstUT.Fields("OU_ID").Value)) & "','E-" & Mid(rstUT.Fields("OU_NAME").Value, 1, 18) & "','E-" & Mid(rstUT.Fields("OU_NAME").Value, 1, 38) & "','E-" & Mid(rstUT.Fields("OU_NAME").Value, 1, 58) & "')"
					mfExecute(conPasarela, strSQL)
				End If
				System.Windows.Forms.Application.DoEvents()
				rstUT.MoveNext()
				j = j + 1
			End While
		Else
			'If strTipoFamilia = "Función Pública" Then
			'strSQL = "UPDATE TBPFIN23_PA set PROCEDIMIENTO='" & gNomProcCorto & "' where PROCEDIMIENTO='" & rstAUX("PROCEDIMIENTO") & "' and CODENTID=02 and CODFAMIL=01"
			strSQL = "UPDATE TBPFIN23_PA set PROCEDIMIENTO='" & gNomProcCorto & "' where PROCEDIMIENTO='" & rstAux.Fields("PROCEDIMIENTO").Value & "' and CODENTID=" & strCodEntid & " and CODFAMIL=" & strCodFamil
			'ElseIf strTipoFamilia = "Acción Social" Then
			'strSQL = "UPDATE TBPFIN23_PA set PROCEDIMIENTO='" & gNomProcCorto & "' where PROCEDIMIENTO='" & rstAUX("PROCEDIMIENTO") & "' and CODENTID=02 and CODFAMIL=02"
			'End If
			mfExecute(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
			'If strTipoFamilia = "Función Pública" Then
			'strSQL = "UPDATE TBDCELTA_PA set PROCEDIMIENTO='" & gNomProcCorto & "' where PROCEDIMIENTO='" & rstAUX("PROCEDIMIENTO") & "' and ELTA_AMBITO='0201' and ELTA_CODTAB='PB'"
			strSQL = "UPDATE TBDCELTA_PA set PROCEDIMIENTO='" & gNomProcCorto & "' where PROCEDIMIENTO='" & rstAux.Fields("PROCEDIMIENTO").Value & "' and ELTA_AMBITO='" & strCodEntid & strCodFamil & "' and ELTA_CODTAB='PB'"
			'ElseIf strTipoFamilia = "Acción Social" Then
			'strSQL = "UPDATE TBDCELTA_PA set PROCEDIMIENTO='" & gNomProcCorto & "' where PROCEDIMIENTO='" & rstAUX("PROCEDIMIENTO") & "' and ELTA_AMBITO='0202' and ELTA_CODTAB='PB'"
			'End If
			mfExecute(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
			strSQL = "DELETE TBPFIN03_PA where PROCEDIMIENTO='" & rstAux.Fields("PROCEDIMIENTO").Value & "' and ORDENTRA=888 "
			mfExecute(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
			strSQL = "DELETE TBPFIN04_PA where PROCEDIMIENTO='" & rstAux.Fields("PROCEDIMIENTO").Value & "' and (ORDENTRA=888 or ORDENTRA=0) "
			mfExecute(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
		End If
		'insertar UT del alta
		strSQL = "SELECT A.ANO_ID, A.SH_SEQ, A.SH_Y, A.SH_X, B.PR_NAME, D.LU_NAME "
		strSQL = strSQL & "FROM SHAPE A, PROCESS B, CW_PROP_TYPE C, CW_LOOKUP D "
		strSQL = strSQL & "Where B.PR_TYPE=D.LU_ID AND D.PPT_ID = C.PPT_ID And C.PPT_FIELD_NAME='PR_TYPE' AND D.LU_NAME='Alta Expediente' and "
		'UPGRADE_WARNING: Couldn't resolve default property of object colPasar()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = strSQL & "A.ANO_TABNR=8953 AND A.ANO_ID=B.PR_ID AND A.DI_ID = " & colPasar.Item(1)(0)
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC "
		rstUT = mfRecordset(conDP4, strSQL)
		If Not rstUT.EOF Then
			'Inicio Jonathan Prieto 17/01/2011 - Modifico los registros de Arranque Expediente de las tablas de pasarela
			'PROPIEDADES_DI: el campo ID_DIAGRAMA con valor del ID del proceso
			strSQL = "UPDATE PROPIEDADES_DI SET ID_DIAGRAMA=" & rstUT.Fields("ANO_ID").Value & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA='PR_ARRANQUEEXPEDIENTE'"
			mfExecute(conPasarela, strSQL)
			'DIAGRAMA: ID_DIAGRAMA con valor del ID del proceso y NUM_SEQ con su número de secuencia
			strSQL = "UPDATE DIAGRAMA SET ID_DIAGRAMA=" & rstUT.Fields("ANO_ID").Value & ", NUM_SEQ=" & rstUT.Fields("SH_SEQ").Value & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOMBRE='Arranque Expediente'"
			mfExecute(conPasarela, strSQL)
			'UPGRADE_WARNING: Couldn't resolve default property of object colPasar(1)(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			mfUnidTra(rstUT.Fields("ANO_ID").Value, colPasar.Item(1)(0), colPasar.Item(1)(0), 0, 0, 0, 0, 0, 0, rstUT.Fields("ANO_ID").Value)
			'Cuando ha leído las UTs para el Alta Expediente, vuelvo a dejar las tablas como estaban
			strSQL = "UPDATE PROPIEDADES_DI SET ID_DIAGRAMA=0 WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA='PR_ARRANQUEEXPEDIENTE'"
			mfExecute(conPasarela, strSQL)
			strSQL = "UPDATE DIAGRAMA SET ID_DIAGRAMA=0, DI_ID=NULL, NUM_SEQ=NULL WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOMBRE='Arranque Expediente'"
			mfExecute(conPasarela, strSQL)
			'Fin Jonathan Prieto 17/01/2011
		End If
		
		'insertar UT del registro de solicitudes
		strSQL = "SELECT A.ANO_ID, A.SH_SEQ, A.SH_Y, A.SH_X, B.PR_NAME, D.LU_NAME "
		strSQL = strSQL & "FROM SHAPE A, PROCESS B, CW_PROP_TYPE C, CW_LOOKUP D "
		strSQL = strSQL & "Where B.PR_TYPE=D.LU_ID AND D.PPT_ID = C.PPT_ID And C.PPT_FIELD_NAME='PR_TYPE' AND D.LU_NAME='Registro Solicitud' and "
		'UPGRADE_WARNING: Couldn't resolve default property of object colPasar()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = strSQL & "A.ANO_TABNR=8953 AND A.ANO_ID=B.PR_ID AND A.DI_ID = " & colPasar.Item(1)(0)
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC "
		rstUT = mfRecordset(conDP4, strSQL)
		If Not rstUT.EOF Then
			strSQL = "INSERT INTO TBPFIN03_PA (PROCEDIMIENTO,CODPROCE,ORDENTRA,CODTRAAD,NOMBRE,NIVTRAMI, CDESTRAM, INDSIMUL, TRAMOCUL, INDBLOQ) VALUES "
			strSQL = strSQL & "('" & gNomProcCorto & "'," & lngCodProc & ",888,888888,'Presentación de Solicitudes',0,0,'N','N','N')"
			mfExecute(conPasarela, strSQL)
			'UPGRADE_WARNING: Couldn't resolve default property of object colPasar(1)(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			mfUnidTra(rstUT.Fields("ANO_ID").Value, colPasar.Item(1)(0), colPasar.Item(1)(0), 888, 0, 0, 0, 0, 0, 888888)
		End If
		
		'UPGRADE_WARNING: Couldn't resolve default property of object colPasar()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = "SELECT DISTINCT DI_ID from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DI_ID IS NOT NULL AND DI_ID <>" & colPasar.Item(1)(0)
		
		rstAux = mfRecordset(conPasarela, strSQL)
		
		While Not rstAux.EOF
			strSQL = "SELECT A.ANO_ID, A.SH_SEQ, A.SH_Y, A.SH_X, B.PR_NAME, D.LU_NAME "
			strSQL = strSQL & "FROM SHAPE A, PROCESS B, CW_PROP_TYPE C, CW_LOOKUP D "
			strSQL = strSQL & "Where B.PR_TYPE=D.LU_ID AND D.PPT_ID = C.PPT_ID And C.PPT_FIELD_NAME='PR_TYPE' AND D.LU_NAME='Registro Solicitud' and "
			strSQL = strSQL & "A.ANO_TABNR=8953 AND A.ANO_ID=B.PR_ID AND A.DI_ID = " & rstAux.Fields("DI_ID").Value
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC "
			rstUT = mfRecordset(conDP4, strSQL)
			If Not rstUT.EOF Then
				strSQL = "INSERT INTO TBPFIN03_PA (PROCEDIMIENTO,CODPROCE,ORDENTRA,CODTRAAD,NOMBRE,NIVTRAMI, CDESTRAM, INDSIMUL, TRAMOCUL, INDBLOQ) VALUES "
				strSQL = strSQL & "('" & gNomProcCorto & "'," & lngCodProc & ",888,888888,'Presentación de Solicitudes',0,0,'N','N','N')"
				mfExecute(conPasarela, strSQL)
				mfUnidTra(rstUT.Fields("ANO_ID").Value, rstAux.Fields("DI_ID").Value, rstAux.Fields("DI_ID").Value, 888, 0, 0, 0, 0, 0, 888888)
			End If
			
			rstAux.MoveNext()
		End While
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Lectura de Unidades de Tramitación", "Ha ocurrido un error no controlado", "msUd_Tramitacion")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msUd_Tramitacion - " & Err.Description)
		Resume procFin
procFin: 
		CierraRS(rstUT)
		'UPGRADE_NOTE: Object rstUT may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstUT = Nothing
		CierraRS(rstProp)
		'UPGRADE_NOTE: Object rstProp may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProp = Nothing
	End Sub
	
	
	
	Public Sub msLecTramRamif()
		Dim strSQL As String
		Dim rstTram As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim rstXML As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstTramAux As ADODB.Recordset
		Dim arr As Object
		Dim strXML As String
		Dim strCadenaXML As String
		Dim strNomTram As String
		Dim strNomTram2 As String
		Dim strTipTram As String
		Dim strPlazoT1 As String
		Dim strPlazoT2 As String
		Dim strNivTram As String
		Dim strIndBloq As String
		Dim strUnRamPa As String
		Dim strTramSimul As String
		Dim strTramOcul As String
		Dim strURP As String
		Dim j As Integer
		Dim lngMax As Integer
		Dim colXML As Collection
		Dim colXML2 As Collection
		Dim colXML3 As Collection
		Dim colXMLD As Collection
		Dim arrOrden As Object
		Dim lngNumAcc As Integer
		Dim strPath As String
		Dim lngORACC As Integer
		Dim I As Integer
		Dim H As Integer
		Dim arrvar As Object
		Dim orden1 As Integer
		Dim orden2 As Integer
		Dim orden3 As Integer
		Dim orden4 As Integer
		Dim orden5 As Integer
		Dim strIndVal As String
		Dim strParametro As String
		'Inicio Jonathan 19/02/2016
		Dim strTramCond As String
		'Fin Jonathan 19/02/2016
		
		On Error GoTo procErr
		
		I = 1
		H = 1
		strSQL = "SELECT * From DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		rstTram = mfRecordset(conPasarela, strSQL)
		System.Windows.Forms.Application.DoEvents()
		If rstTram.EOF = False Then
			'UPGRADE_WARNING: Couldn't resolve default property of object rstTram.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstTram.GetRows
			System.Windows.Forms.Application.DoEvents()
			rstTram.MoveFirst()
		End If
		'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Me.pgbProceso.Value = 0
		j = 1
		colXML = New Collection
		colXML2 = New Collection
		colXML3 = New Collection
		colXML2.Add("Nombre Trámite")
		colXML3.Add("Tipo Trámite")
		colXML.Add("Plazo Tipo 1")
		colXML.Add("Plazo Tipo 2")
		colXML.Add("Nivel Tramitación")
		colXML.Add("Bloqueo Expediente")
		colXML.Add("Unión Ramas Paralelas")
		colXML.Add("Tramitación Simultánea")
		colXML.Add("Trámite Oculto Consulta")
		colXML.Add("Indicador Valor Variable")
		colXML.Add("Vuelta atrás con URP")
		'Inicio Jonathan 19/02/2016
		colXML.Add("Trámite condicionado")
		'Fin Jonathan 19/02/2016
		
		While Not rstTram.EOF
			strSeg = rstTram.Fields("ORDEN_N1").Value & "/" & rstTram.Fields("ORDEN_N2").Value & "/" & rstTram.Fields("ORDEN_N3").Value & "/" & rstTram.Fields("ORDEN_N4").Value & "/" & rstTram.Fields("ORDEN_N5").Value
			Me.lblMensaje.Text = "Leyendo Propiedades Trámite/Ramificación"
			msProceso(1, 8, j, UBound(arr, 2) + 1)
			colXMLD = mfBuscaXML("Proceso", colXML, rstTram.Fields("ID_DIAGRAMA").Value)
			'Plazo Tipo 1
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strPlazoT1 = IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1))
			msProceso(2, 8, j, UBound(arr, 2) + 1)
			'Plazo Tipo 2
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strPlazoT2 = IIf(colXMLD.Item(2) = "-1", "", colXMLD.Item(2))
			msProceso(3, 8, j, UBound(arr, 2) + 1)
			'Nivel Tramitación
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strNivTram = mfTratamientoCM10(IIf(colXMLD.Item(3) = "-1", "", colXMLD.Item(3)))
			msProceso(4, 8, j, UBound(arr, 2) + 1)
			'Indicador Bloqueo Expediente
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strIndBloq = mfTratamientoCM10(IIf(colXMLD.Item(4) = "-1", "1", colXMLD.Item(4)))
			msProceso(5, 8, j, UBound(arr, 2) + 1)
			'Indicador Unión Ramas Paralelas
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strUnRamPa = mfTratamientoCM10(IIf(colXMLD.Item(5) = "-1", "1", colXMLD.Item(5)))
			msProceso(6, 8, j, UBound(arr, 2) + 1)
			'Tramitacion Simultanea
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strTramSimul = mfTratamientoCM10(IIf(colXMLD.Item(6) = "-1", "1", colXMLD.Item(6)))
			msProceso(7, 8, j, UBound(arr, 2) + 1)
			'Trámite Oculto Consulta
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strTramOcul = mfTratamientoCM10(IIf(colXMLD.Item(7) = "-1", "1", colXMLD.Item(7)))
			'Indicador Valor Variable
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strIndVal = IIf(colXMLD.Item(8) = "", "0", colXMLD.Item(8))
			'Vuelta atrás con URP
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strURP = mfTratamientoCM10(IIf(colXMLD.Item(9) = "-1", "1", colXMLD.Item(9)))
			'Inicio Jonathan 19/02/2016
			'Trámite Condicionado
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strTramCond = mfTratamientoCM10(IIf(colXMLD.Item(10) = "-1", "1", colXMLD.Item(10)))
			'Fin Jonathan 19/02/2016
			'Nombre tramite
			colXMLD = mfBuscaXML("Proceso", colXML2, rstTram.Fields("ID_DIAGRAMA").Value, True)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strNomTram = IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1))
			'Tipo Trámite
			colXMLD = mfBuscaXML("Proceso", colXML3, rstTram.Fields("ID_DIAGRAMA").Value, True, True)
			'strTipTram = mfTratamientoCM10(IIf(colXMLD(1) = "-1", "", colXMLD(1)))
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strTipTram = IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1))
			
			Me.lblMensaje.Text = "Introduciendo Propiedades Diagramas"
			msProceso(8, 8, j, UBound(arr, 2) + 1)
			strNomTram2 = strNomTram
			strNomTram = Replace(strNomTram, " ", "")
			If strNomTram <> "" Then
				strSQL = "SELECT COUNT(*) FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "NOM_DIAGRAMA LIKE 'PR_" & UCase(Mid(strNomTram, 1, 19)) & "%'"
				rstAux = mfRecordset(conPasarela, strSQL)
				strNomTram = "PR_" & UCase(Mid(strNomTram, 1, 19)) & VB6.Format(rstAux.Fields(0).Value + 1, "00")
			End If
			If strNomTram = "" And rstTram.Fields("CAT_DIAGRAMA").Value & "" <> "Ramificación" And rstTram.Fields("ID_DIAGRAMA").Value <> "0" Then
				Insertar_Error(Me, "Lectura de Trámite/Ramificación", "La propiedad Nombre Trámite de " & rstTram.Fields("NOMBRE").Value & " no tiene valor", "msLecTramRamif")
				Mostrar_Error()
				GoTo siguiente
			End If
			
			If rstTram.Fields("ID_DIAGRAMA").Value <> "0" Then
				''''''''''''''''''''''''''''''
				mfInserta_PROPIEDADES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstTram.Fields("ID_DIAGRAMA").Value, UCase(strNomTram), strTipTram, strPlazoT1, strPlazoT2, strNivTram, strIndBloq, strUnRamPa, "0")
				''''''''''''''''''''''''''''''
			End If
			If rstTram.Fields("EXPLOTA_ACC").Value = "S" Then
				'Inicio Jonathan 19/02/2016
				'tablas de infraestructura
				msTablasInfra(CInt(rstTram.Fields("ID_DIAGRAMA").Value), strNomTram2 & "", H, strTipTram & "", Val(strNivTram & ""), strIndBloq & "", strNomTram & "", strTramSimul & "", strTramOcul & "", rstTram.Fields("CODFASE").Value, rstTram.Fields("CODSFASE").Value, rstTram.Fields("DATFASUB").Value, strTramCond)
				'Fin Jonathan 19/02/2016
				H = H + 1
				'unidades de tramitacion
				System.Windows.Forms.Application.DoEvents()
				If (strTipTram <> "O") Then
					If mfUnidTra(rstTram.Fields("ID_DIAGRAMA").Value, rstTram.Fields("DI_ID").Value, rstTram.Fields("ID_PADRE").Value, I, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstTram.Fields("ID_DIAGRAMA").Value) = True Then
						I = I + 1
					End If
				Else
					If rstTram.Fields("EXPLOTA_ACC").Value = "S" Then
						mfUnidTra(rstTram.Fields("ID_DIAGRAMA").Value, rstTram.Fields("DI_ID").Value, rstTram.Fields("ID_PADRE").Value, I, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstTram.Fields("ID_DIAGRAMA").Value)
						mfUnidTraComunicacion(rstTram.Fields("ID_DIAGRAMA").Value, rstTram.Fields("DI_ID").Value, rstTram.Fields("ID_PADRE").Value, I, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstTram.Fields("ID_DIAGRAMA").Value)
					End If
					I = I + 1
				End If
			Else
				msUnidTraRami(rstTram.Fields("ID_DIAGRAMA").Value, Val(rstTram.Fields("DI_ID").Value & ""), rstTram.Fields("ID_PADRE").Value, I, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstTram.Fields("ID_DIAGRAMA").Value)
			End If
			If strUnRamPa <> "" Then 'ramas paralelas
				msUnRamPa(rstTram)
			End If
			If strPlazoT1 <> "" Then 'plazo ejecucion tipo1
				System.Windows.Forms.Application.DoEvents()
				msPlazT1(rstTram, strPlazoT1, UCase(strNomTram), CBool(strIndVal))
				System.Windows.Forms.Application.DoEvents()
			End If
			
			If strTipTram = "F" Or strTipTram = "X" Or strTipTram = "Z" Or strTipTram = "@" Then 'tramites de firma
				msFirma(rstTram)
				
			ElseIf strTipTram = "5" Or strTipTram = "0" Then  'tramite BUSCARVBFIRMA
				msBuscarvbFirma(rstTram, strTipTram)
				
			ElseIf strTipTram = "V" Then  'tramite VB 1er nivel
				msVBResp1(rstTram)
				
			ElseIf strTipTram = "2" Then  'tramite VB 2º nivel
				msVBResp2(rstTram)
				
			ElseIf strTipTram = "C" Then  'Acuse de recibo telematico
				msAcusRecTele(rstTram)
				
			ElseIf strTipTram = "#" Then  'Firma en SEDE
				msObtenerResponsableFirmaExterno(rstTram, strTipTram)
			End If
			
			If strTipTram = "O" Then
				If rstTram.Fields("ORDEN_N2").Value = 0 Then
					strSQL = "UPDATE DIAGRAMA SET INDCOMUN='S' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
				ElseIf rstTram.Fields("ORDEN_N3").Value = 0 Then 
					strSQL = "UPDATE DIAGRAMA SET INDCOMUN= 'S' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
				ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
					strSQL = "UPDATE DIAGRAMA SET INDCOMUN='S' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
				ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
					strSQL = "UPDATE DIAGRAMA SET INDCOMUN='S' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
				Else
					strSQL = "UPDATE DIAGRAMA SET INDCOMUN='S' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				End If
				mfExecute(conPasarela, strSQL)
				orden1 = rstTram.Fields("ORDEN_N1").Value
				orden2 = rstTram.Fields("ORDEN_N2").Value
				orden3 = rstTram.Fields("ORDEN_N3").Value
				orden4 = rstTram.Fields("ORDEN_N4").Value
				orden5 = rstTram.Fields("ORDEN_N5").Value
				rstTram.Requery()
				Do While Not rstTram.EOF
					If rstTram.Fields("ORDEN_N1").Value = orden1 And rstTram.Fields("ORDEN_N2").Value = orden2 And rstTram.Fields("ORDEN_N3").Value = orden3 And rstTram.Fields("ORDEN_N4").Value = orden4 And rstTram.Fields("ORDEN_N5").Value = orden5 Then
						Exit Do
					End If
					rstTram.MoveNext()
				Loop 
			End If
			If rstTram.Fields("EXPLOTA_ACC").Value = "S" Then
				'INSERTO EL CANCELWAIT SI LO TIENE
				If strURP = "1" Then
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CANCELWAIT'"
					rstAux = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
					strPath = "CANCELWAIT" & VB6.Format(lngNumAcc, "00")
					mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, 1, 0, "CANCELWAIT", lngNumAcc, "", strPath, 0, 0, "", "", "")
				End If
				strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " and ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " and ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " and ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
				System.Windows.Forms.Application.DoEvents()
				rstAux = mfRecordset(conPasarela, strSQL)
				lngORACC = Val(rstAux.Fields(0).Value & "") + 1
				If rstTram.Fields("CAT_DIAGRAMA").Value <> "Trámite automático" Then 'And strTipTram <> "A" Then 'And (rstTram("INDCOMUN") <> "S" Or strTipTram = "P") Then
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TRAMITEPDTE'"
					rstAux = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
					strPath = "APE_TRAMITEPDTE" & VB6.Format(lngNumAcc, "00")
					'mfInserta_ACCIONES rstram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC, 0, "TRAMITEPDTE", lngNumAcc, "G"
					strSQL = "INSERT INTO ACCIONES_DI (" & "PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, " & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, " & "NOM_ACCION, NUM_ACCION,TIPO_ACCION,PATH_HIDRA) VALUES " & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & "," & rstTram.Fields("ORDEN_N2").Value & "," & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'TRAMITEPDTE'," & lngNumAcc & ",'G','" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					blnInserta = True
					msInsertaParamAcc("", "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					
					'Añadimos el Código de Documento en función del tipo de Trámite
					'  - F: Firma
					'  - C: Acuse de Recibo Telemático
					'  - X: Visto Bueno con Firma
					'  - Z: Visto Bueno sin Firma
					'  - 5: Visto Bueno Firma General
					'  - @: Porta Firmas
					'  - #: Firma en SEDE
					If strTipTram = "F" Or strTipTram = "C" Or strTipTram = "X" Or strTipTram = "Z" Or strTipTram = "5" Or strTipTram = "@" Or strTipTram = "#" Then
						msInsertaParamAcc("@CODDOCUM", "@INICIO!CODIGODOCUMENTOEMITIDO", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					End If
					
					strPath = "EDP_TRAMITEPDTE" & VB6.Format(lngNumAcc, "00")
					lngORACC = lngORACC + 1
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'ENDPROC'," & lngNumAcc & "," & "'" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strPath = "PRO_TRAMITEPDTE" & VB6.Format(lngNumAcc, "00")
					lngORACC = lngORACC + 1
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'PROCESS'," & lngNumAcc & "," & "'" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
					mfExecute(conPasarela, strSQL)
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='FORMFICTICIO'"
					rstAux = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
					strPath = "FORMFICTICIO" & VB6.Format(lngNumAcc, "00")
					lngORACC = lngORACC + 1
					strSQL = "INSERT INTO ACCIONES_DI (" & "PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, " & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, " & "NOM_ACCION, NUM_ACCION, TIPO_ACCION,PATH_HIDRA) VALUES " & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & "," & rstTram.Fields("ORDEN_N2").Value & "," & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'FORMFICTICIO'," & lngNumAcc & ",'G','" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					lngORACC = lngORACC + 1
				End If
				If rstTram.Fields("CAT_DIAGRAMA").Value <> "Trámite automático" Then 'And strTipTram <> "A" Then 'And (rstTram("INDCOMUN") <> "S" Or strTipTram = "P") Then
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='INICIOTRAMITE'"
				Else
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='INICIOTRAMITEAUTOMA'"
				End If
				rstAux = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
				If rstTram.Fields("CAT_DIAGRAMA").Value <> "Trámite automático" Then ' And strTipTram <> "A" Then ' And (rstTram("INDCOMUN") <> "S" Or strTipTram = "P") Then
					strPath = "APE_INICIOTRAMITE" & VB6.Format(lngNumAcc, "00")
					If Len(strPath) > 25 Then
						strPath = "APE_INICIOTRAMIT" & VB6.Format(lngNumAcc, "00")
					End If
					strSQL = "INSERT INTO ACCIONES_DI (" & "PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, " & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, " & "NOM_ACCION,NUM_ACCION, TIPO_ACCION,PATH_HIDRA) VALUES " & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & "," & rstTram.Fields("ORDEN_N2").Value & "," & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'INICIOTRAMITE'," & lngNumAcc & ",'G','" & strPath & "')"
				Else
					strPath = "APE_INICIOTRAMITEAUTOMA" & VB6.Format(lngNumAcc, "00")
					If Len(strPath) > 25 Then
						strPath = "APE_INICIOTRAMITEAUTOM" & VB6.Format(lngNumAcc, "00")
					End If
					strSQL = "INSERT INTO ACCIONES_DI (" & "PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, " & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, " & "NOM_ACCION,NUM_ACCION, TIPO_ACCION,PATH_HIDRA) VALUES " & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & "," & rstTram.Fields("ORDEN_N2").Value & "," & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'INICIOTRAMITEAUTOMA'," & lngNumAcc & ",'G','" & strPath & "')"
				End If
				mfExecute(conPasarela, strSQL)
				blnInserta = True
				msInsertaParamAcc("", "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				If rstTram.Fields("CAT_DIAGRAMA").Value <> "Trámite automático" Then ' And strTipTram <> "A" Then 'And (rstTram("INDCOMUN") <> "S" Or strTipTram = "P") Then
					strPath = "EDP_INICIOTRAMITE" & VB6.Format(lngNumAcc, "00")
					If Len(strPath) > 25 Then
						strPath = "EDP_INICIOTRAMIT" & VB6.Format(lngNumAcc, "00")
					End If
				Else
					strPath = "EDP_INICIOTRAMITEAUTOMA" & VB6.Format(lngNumAcc, "00")
					If Len(strPath) > 25 Then
						strPath = "EDP_INICIOTRAMITEAUTOM" & VB6.Format(lngNumAcc, "00")
					End If
				End If
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'ENDPROC'," & lngNumAcc & "," & "'" & strPath & "')"
				mfExecute(conPasarela, strSQL)
				If rstTram.Fields("CAT_DIAGRAMA").Value <> "Trámite automático" Then ' And strTipTram <> "A" Then 'And (rstTram("INDCOMUN") <> "S" Or strTipTram = "P") Then
					strPath = "PRO_INICIOTRAMITE" & VB6.Format(lngNumAcc, "00")
					If Len(strPath) > 25 Then
						strPath = "PRO_INICIOTRAMIT" & VB6.Format(lngNumAcc, "00")
					End If
				Else
					strPath = "PRO_INICIOTRAMITEAUTOMA" & VB6.Format(lngNumAcc, "00")
					If Len(strPath) > 25 Then
						strPath = "PRO_INICIOTRAMITEAUTOM" & VB6.Format(lngNumAcc, "00")
					End If
				End If
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'PROCESS'," & lngNumAcc & "," & "'" & strPath & "')"
				mfExecute(conPasarela, strSQL)
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
				mfExecute(conPasarela, strSQL)
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND" & " ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstTramAux = mfRecordset(conPasarela, strSQL)
				colCancel.Add(rstTramAux)
				msActVar(rstTram)
			End If
			If strPlazoT2 <> "" Then
				msPlazT2(rstTram, strPlazoT2, CBool(strIndVal))
			End If
siguiente: 
			j = j + 1
			rstTram.MoveNext()
		End While
		
		
		
		
		''''''
		'msResolPlazo1
		''''''
		
		
		
		
		
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION IN ('ALERT', 'JUMP','WAITALL')"
		rstTram = mfRecordset(conPasarela, strSQL)
		While Not rstTram.EOF
			If rstTram.Fields("NOM_ACCION").Value = "ALERT" Then
				strParametro = "ALERTPATH"
			ElseIf rstTram.Fields("NOM_ACCION").Value = "WAITALL" Then 
				strParametro = "WAITALL"
			Else
				strParametro = "PATH"
			End If
			strSQL = "SELECT ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,ID_ACCION,PARAMETRO,VALOR,ORDEN_PA FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstTram.Fields("ORDEN_ACC").Value & " AND" & " PARAMETRO='" & strParametro & "'"
			rstProp = mfRecordset(conPasarela, strSQL)
			If rstProp.Fields("VALOR").Value <> "FINTRAMITEPROV" Then
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				arrOrden = Split(rstProp.Fields("VALOR").Value, ";")
				If UBound(arrOrden) > 0 Then
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & arrOrden(0) & " AND " & "ORDEN_N2=" & arrOrden(1) & " AND " & "ORDEN_N3=" & arrOrden(2) & " AND " & "ORDEN_N4=" & arrOrden(3) & " AND " & "ORDEN_N5=" & arrOrden(4)
					rstProp = mfRecordset(conPasarela, strSQL)
					'''ERROR pq rstProp no tiene un registro, se le podria meter en un IF (aketza)
					'****????¿¿¿¿****
					If Not rstProp.EOF Then
						If rstProp.Fields("NOM_DIAGRAMA").Value <> "" Then
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstProp.Fields("NOM_DIAGRAMA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstTram.Fields("ORDEN_ACC").Value & " AND " & "PARAMETRO='" & strParametro & "'"
						Else
							GoTo rami
						End If
						
					Else
rami: 
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If arrOrden(1) = 0 Then
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & arrOrden(0) & " ORDER BY " & "ORDEN_N2"
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf arrOrden(2) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & arrOrden(0) & " AND " & "ORDEN_N2=" & arrOrden(1) & " ORDER BY " & "ORDEN_N3"
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf arrOrden(4) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & arrOrden(0) & " AND " & "ORDEN_N2=" & arrOrden(1) & " AND " & "ORDEN_N3=" & arrOrden(2) & " AND " & "ORDEN_N4=" & arrOrden(3) & " ORDER BY " & "ORDEN_N5"
						End If
						rstAux = mfRecordset(conPasarela, strSQL)
						Do While Not rstAux.EOF
							strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
							rstAux2 = mfRecordset(conPasarela, strSQL)
							If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2.Fields("NOM_DIAGRAMA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstTram.Fields("ORDEN_ACC").Value & " And " & "PARAMETRO='" & strParametro & "'"
								mfExecute(conPasarela, strSQL)
								Exit Do
							End If
							rstAux.MoveNext()
						Loop 
					End If
					mfExecute(conPasarela, strSQL)
				End If
			End If
			rstTram.MoveNext()
		End While
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@ORDTRACADUCAR'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			'UPGRADE_WARNING: Couldn't resolve default property of object arrvar. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrvar = Split(rstAux.Fields("VALOR").Value, ";")
			If UBound(arrvar) > 0 Then
				'UPGRADE_WARNING: Couldn't resolve default property of object arrvar(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrvar(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrvar(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrvar(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrvar(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & arrvar(0) & " AND " & "ORDEN_N2=" & arrvar(1) & " AND " & "ORDEN_N3=" & arrvar(2) & " AND " & "ORDEN_N4=" & arrvar(3) & " AND " & "ORDEN_N5=" & arrvar(4)
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2.Fields("NOM_DIAGRAMA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND " & "PARAMETRO='@ORDTRACADUCAR'"
					mfExecute(conPasarela, strSQL)
				End If
			End If
			rstAux.MoveNext()
		End While
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHNORESPONSABLE'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrOrden = Split(rstAux.Fields("VALOR").Value, ";")
			If UBound(arrOrden) > 0 Then
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & arrOrden(0) & " AND " & "ORDEN_N2=" & arrOrden(1) & " AND " & "ORDEN_N3=" & arrOrden(2) & " AND " & "ORDEN_N4=" & arrOrden(3) & " AND " & "ORDEN_N5=" & arrOrden(4)
				rstProp = mfRecordset(conPasarela, strSQL)
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstProp.Fields("NOM_DIAGRAMA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND " & "PARAMETRO='@PATHNORESPONSABLE'"
				mfExecute(conPasarela, strSQL)
			End If
			
			rstAux.MoveNext()
		End While
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		logError("msLecTramRamif - " & Err.Description & "/" & Err.Number)
		'Resume Next
		Insertar_Error(Me, "Lectura de Trámite/Ramificación", "Ha ocurrido un error no controlado", "msLecTramRamif" & " -" & strSeg)
		Mostrar_Error()
		Resume procFin
procFin: 
		CierraRS(rstTram)
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
		CierraRS(rstProp)
		'UPGRADE_NOTE: Object rstProp may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProp = Nothing
		CierraRS(rstXML)
		'UPGRADE_NOTE: Object rstXML may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstXML = Nothing
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rstAux2)
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		CierraRS(rstTramAux)
		'UPGRADE_NOTE: Object rstTramAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTramAux = Nothing
	End Sub
	
	Private Sub cmdCancelar_Click(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles cmdCancelar.Click
		Dim sSQL As String
		Dim rsErrores As New ADODB.Recordset
		If Me.cmdCancelar.Text = "Cancelar Todos" Then
			
			blnParar = True
			blnCancelar = True
			tramiteAnterior = ""
			Me.Close()
			sSQL = "SELECT * FROM PROCESOS_PENDIENTES WHERE USERID='" & strUserId & "' and (FINALIZADO='N' or FINALIZADO='P') order by NOMBRE_CM"
			rsErrores = mfRecordset(conPasarela, sSQL)
			While Not rsErrores.EOF
				sSQL = "INSERT INTO ERRORES (PROCEDIMIENTO, USERID, AMBITO, DESCRIPCION) VALUES " & "('" & rsErrores.Fields("PROCEDIMIENTO").Value & "', '" & strUserId & "', 'Resultado','Operación cancelada por el usuario')"
				'            sSQL = "INSERT INTO ERRORES (PROCEDIMIENTO, AMBITO, DESCRIPCION) VALUES " _
				''                    & "('" & rsErrores("PROCEDIMIENTO") & "', 'Resultado','Operación cancelada por el usuario')"
				'**********************
				mfExecute(conPasarela, sSQL)
				sSQL = "UPDATE PROCESOS_PENDIENTES SET FINALIZADO='C' WHERE PROCEDIMIENTO='" & rsErrores.Fields("PROCEDIMIENTO").Value & "' and USERID='" & strUserId & "'"
				mfExecute(conPasarela, sSQL)
				rsErrores.MoveNext()
			End While
			rsErrores.Close()
			'UPGRADE_NOTE: Object rsErrores may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rsErrores = Nothing
			
			msPasarProcedimientos()
			'Inicio Jonathan Prieto 07/06/2011
			frmErrores.lblError.Text = "Errores detectados por la pasarela"
			frmErrores.Text = "Errores"
			frmErrores.intOpcion = 0
			'Fin Jonathan Prieto 07/06/2011
			frmErrores.Show()
			
		End If
	End Sub
	
	Private Sub CmdCancelarActual_Click(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles CmdCancelarActual.Click
		Dim sSQL As String
		Dim rsErrores As New ADODB.Recordset
		' boton para cancelar el proceso actual y que continue con el siguiente
		If Me.CmdCancelarActual.Text = "Cancelar Actual" Then
			blnParar = True
			blnCancelar = True
			sSQL = "SELECT * FROM PROCESOS_PENDIENTES WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND USERID='" & strUserId & "' and FINALIZADO='P' order by NOMBRE_CM"
			rsErrores = mfRecordset(conPasarela, sSQL)
			While Not rsErrores.EOF
				Insertar_Error(Me, "Resultado", "Operación cancelada por el usuario", "CmdCancelarActual_Click")
				sSQL = "UPDATE PROCESOS_PENDIENTES SET FINALIZADO='C' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and USERID='" & strUserId & "'"
				mfExecute(conPasarela, sSQL)
				rsErrores.MoveNext()
			End While
			rsErrores.Close()
			'UPGRADE_NOTE: Object rsErrores may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rsErrores = Nothing
			'frmErrores.Show
			
			' continuamos la funcion
			msPasarProcedimientos()
		End If
	End Sub
	
	Private Sub cmdForzar_Click(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles cmdForzar.Click
		strFechaProgramada = VB6.Format(Now, "dd/mm/yyyy hh:mm:ss")
		cmdForzar.Visible = False
	End Sub
	
	'UPGRADE_WARNING: Form event frmProceso.Activate has a new behavior. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6BA9B8D2-2A32-4B6E-8D36-44949974A5B4"'
	Private Sub frmProceso_Activated(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles MyBase.Activated
		'''''''''''''''''''''''''''''''''''''''''''''
		
		'
		'    Me.lblProc = gNomProc
		'   If blnCarga = True Then
		'       blnParar = False
		'       conPasarela.Execute "DELETE FROM WFFLOWS"
		'       conPasarela.Execute "DELETE FROM WFFLOWACTIONS"
		'       msCrearFlujo
		'       msCrearTramites
		'       Unload Me
		'       frmMDI.Enabled = False
		'       frmVisualizacion.Show 1
		'       frmMDI.Enabled = True
		'
		'   ElseIf blnCargaInfra = True Then
		'       blnParar = False
		'       cmdCancelar.Visible = False
		'       msCargarInfraestructura
		'        msVariablesInfra
		'        msCargarFlujo
		'        If conPasarela.State = adStateOpen Then conPasarela.Close
		'        If conDP4.State = adStateOpen Then conDP4.Close
		'        If conInfra.State = adStateOpen Then conInfra.Close
		'        CierraCN conDB2
		'        If conCarga.State = adStateOpen Then conCarga.Close
		'        Unload Me
		'    Else
		'        TIEMPOTOTAL = GetTickCount
		'        blnParar = False
		'        cmdCancelar.Visible = True
		'        Set colCancel = New Collection
		'        Set colConOp = New Collection
		'        msLec_Diagram_Proc colPasar, "'Trámite','Trámite automático','Trámite general','Ramificación','Trámite General Automático'", 1
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        msPropiedades_Proc colPasar
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        msVariables_Alta colPasar
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        msUd_Tramitacion
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        msLec_Conectores_ACC
		'        If blnParar = True Then Exit Sub
		'        msActualizarSalidas
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        msLecTramRamif
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        msLecAccTram
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        mslecParamAcc
		'        If blnParar = True Then Exit Sub
		'        DoEvents
		'        msRepaso
		'        If blnParar = True Then Exit Sub
		'        msValidaciones
		'        ''''msResolVariables
		'        If blnParar = True Then Exit Sub
		'        Unload Me
		'        If blnParar = True Then Exit Sub
		'        TIEMPOTOTAL = GetTickCount - TIEMPOTOTAL
		'        logTiempos "TIEMPOTOTAL: " & formatGTC(TIEMPOTOTAL)
		'        frmFechaActivacion.Show 1
		'    End If
	End Sub
	
	
	Private Sub msLec_Conectores_ACC()
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstCon As ADODB.Recordset
		Dim rstXML As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim rstTram As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim strXML As String
		Dim strProp As String
		Dim strCadenaXML As String
		Dim j As Integer
		Dim I As Integer
		Dim arr As Object
		Dim arr2 As Object
		Dim strNomCon As String
		Dim strCatCon As String
		Dim strSalTra As String
		Dim colXML As Collection
		Dim colXMLD As Collection
		Dim H As Integer
		Dim Tiempo As Integer
		Tiempo = GetTickCount
		rstCon = New ADODB.Recordset
		rstXML = New ADODB.Recordset
		rstTram = New ADODB.Recordset
		strSQL = "SELECT * " & "From DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND EXPLOTA_ACC='S' " & "ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		rstTram = mfRecordset(conPasarela, strSQL)
		System.Windows.Forms.Application.DoEvents()
		If rstTram.EOF = False Then
			'UPGRADE_WARNING: Couldn't resolve default property of object rstTram.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstTram.GetRows
			System.Windows.Forms.Application.DoEvents()
			rstTram.MoveFirst()
		End If
		'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Me.pgbProceso.Value = 0
		
		H = 1
		I = 1
		colXML = New Collection
		colXML.Add("Nombre")
		colXML.Add("Categoría")
		While Not rstTram.EOF
			strSeg = rstTram.Fields("ORDEN_N1").Value & "/" & rstTram.Fields("ORDEN_N2").Value & "/" & rstTram.Fields("ORDEN_N3").Value & "/" & rstTram.Fields("ORDEN_N4").Value & "/" & rstTram.Fields("ORDEN_N5").Value
			strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, "
			strSQL = strSQL & "B.SH_SEQ_TO, B.DI_ID From "
			strSQL = strSQL & "SHAPE A, JOINER B, DIAGRAM D Where "
			strSQL = strSQL & "A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_FROM AND "
			strSQL = strSQL & "(A.ANO_TABNR=8953 or A.ANO_TABNR=9096) AND (D.ANO_TABNR=8953 or D.ANO_TABNR=9096) AND D.DI_ID =A.DI_ID and D.DI_TYPE <> 1 and "
			strSQL = strSQL & "D.ANO_ID = " & rstTram.Fields("ID_DIAGRAMA").Value
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			'## DS66  05/06/09  Filtro para que no lea los conectores de la parte de "Trámite Usuario" "TRU"
			strSQL = strSQL & " AND D.DI_TYPE not in (SELECT LU_ID FROM CW_LOOKUP where model_name ='" & strModelo & "' and lu_abbreviation='TRU')"
			'##
			strSQL = strSQL & " UNION "
			strSQL = strSQL & "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, "
			strSQL = strSQL & "B.SH_SEQ_TO, B.DI_ID From "
			strSQL = strSQL & "SHAPE A, JOINER B, DIAGRAM D Where "
			strSQL = strSQL & "A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_TO AND "
			strSQL = strSQL & "(A.ANO_TABNR=8953 or A.ANO_TABNR=9096) AND D.DI_ID =A.DI_ID and D.DI_TYPE <> 1 and "
			strSQL = strSQL & "(D.ANO_TABNR=8953 or D.ANO_TABNR=9096) AND D.ANO_ID = " & rstTram.Fields("ID_DIAGRAMA").Value
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			'## DS66  05/06/09  Filtro para que no lea los conectores de la parte de "Trámite Usuario" "TRU"
			strSQL = strSQL & " AND D.DI_TYPE not in (SELECT LU_ID FROM CW_LOOKUP where model_name ='" & strModelo & "' and lu_abbreviation='TRU')"
			'##
			System.Windows.Forms.Application.DoEvents()
			
			If rstTram.Fields("ID_DIAGRAMA").Value = "188" Then
				System.Windows.Forms.Application.DoEvents()
			End If
			
			rstCon = mfRecordset(conDP4, strSQL)
			System.Windows.Forms.Application.DoEvents()
			If rstCon.EOF = False Then
				'UPGRADE_WARNING: Couldn't resolve default property of object rstCon.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arr2. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				arr2 = rstCon.GetRows
				System.Windows.Forms.Application.DoEvents()
				rstCon.MoveFirst()
			End If
			j = 1
			
			While Not rstCon.EOF
				lblMensaje.Text = "Volcando información CONECTORES ENTRE ACCIONES en PASARELA"
				msProceso(j, UBound(arr2, 2) + 1, I, UBound(arr, 2) + 1)
				If rstCon.Fields("SH_SEQ_FROM").Value = rstCon.Fields("SH_SEQ_TO").Value Then
					colXMLD = mfBuscaXML("Conector", colXML, rstCon.Fields("ANO_ID").Value)
					'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strNomCon = colXMLD.Item(1)
					Insertar_Error(Me, "Lectura de conectores entre acciones", "En el diagrama " & rstTram.Fields("ID_DIAGRAMA").Value & " tiene un conector sobre si mismo", "msLec_Conectores_ACC")
					Mostrar_Error()
				Else
					colXMLD = mfBuscaXML("Conector", colXML, rstCon.Fields("ANO_ID").Value)
					'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strCatCon = colXMLD.Item(2)
					strSQL = "SELECT A.OT_NAME FROM CW_OBJECT_TYPE A, SHAPE B WHERE "
					strSQL = strSQL & "A.OT_ID=B.ANO_TABNR AND "
					strSQL = strSQL & "B.SH_SEQ=" & rstCon.Fields(6).Value & " AND B.ANO_TABNR=9097 AND "
					strSQL = strSQL & "B.DI_ID=" & rstCon.Fields("DI_ID").Value
					' **** NUEVO SD ENERO'08ss
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					
					
					System.Windows.Forms.Application.DoEvents()
					rstProp = mfRecordset(conDP4, strSQL)
					System.Windows.Forms.Application.DoEvents()
					If Not rstProp.EOF Then
						If Trim(rstProp.Fields(0).Value) = "Evento/Resultado" Then
							strSalTra = "S"
						Else
							strSalTra = "N"
						End If
					Else
						strSalTra = "N"
					End If
					
					'Set colXMLD = mfBuscaXML("Proceso", colXMLIm, rstACC("ID_ACCION"), True)
					
					strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_CONECTOR=" & rstCon.Fields(3).Value & " AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstCon.Fields(5).Value & " AND " & "NUM_SEQ_HASTA=" & rstCon.Fields(6).Value & " AND " & "CAT_CONECTOR='" & strCatCon & "' AND " & "IND_SALIDA_TRAM='" & strSalTra & "' AND " & "DI_ID=" & rstCon.Fields("DI_ID").Value
					rstAux = mfRecordset(conPasarela, strSQL)
					
					If rstAux.EOF Then
						
						strSQL = "INSERT INTO CONECTOR_ACC (PROCEDIMIENTO,ID_CONECTOR, ID_DIAGRAMA, NUM_CONECTOR, " & "NUM_SEQ_DESDE, NUM_SEQ_HASTA, CAT_CONECTOR, " & "IND_SALIDA_TRAM, DI_ID) VALUES (" & "'" & gNomProcCorto & "'," & rstCon.Fields(3).Value & "," & rstTram.Fields("ID_DIAGRAMA").Value & ", " & rstTram.Fields("NUM_DIAGRAMA").Value & ", " & rstCon.Fields(5).Value & "," & rstCon.Fields(6).Value & ",'" & strCatCon & "', " & "'" & strSalTra & "', " & rstCon.Fields("DI_ID").Value & ")"
						mfExecute(conPasarela, strSQL)
						
						strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, "
						strSQL = strSQL & " B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID, C.PB_NAME From "
						strSQL = strSQL & " SHAPE A, JOINER B, PROCESS_BREAK C, DIAGRAM D Where"
						strSQL = strSQL & " A.DI_ID=B.DI_ID AND"
						strSQL = strSQL & " A.SH_SEQ=B.SH_SEQ_TO AND"
						strSQL = strSQL & " A.ANO_ID=C.PB_ID AND"
						strSQL = strSQL & " D.DI_ID =A.DI_ID and"
						strSQL = strSQL & " D.ANO_ID =" & rstTram.Fields("ID_DIAGRAMA").Value & " AND"
						strSQL = strSQL & " B.SH_SEQ_FROM=" & rstCon.Fields(5).Value & " and  B.SH_SEQ_TO=" & rstCon.Fields(6).Value & " and"
						strSQL = strSQL & " A.ANO_TABNR = 5257"
						' **** NUEVO SD ENERO'08
						strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
						
						rstAux = mfRecordset(conDP4, strSQL)
						If Not rstAux.EOF Then
							strSQL = "UPDATE CONECTOR_ACC SET CAT_CONECTOR2='" & rstAux.Fields("PB_NAME").Value & "' , IND_SALIDA_TRAM='S' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ID_CONECTOR= " & rstCon.Fields(3).Value & " AND "
							strSQL = strSQL & "ID_DIAGRAMA= " & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
							strSQL = strSQL & "NUM_CONECTOR = " & rstTram.Fields("NUM_DIAGRAMA").Value & " And "
							strSQL = strSQL & "NUM_SEQ_DESDE=" & rstCon.Fields(5).Value & " AND "
							strSQL = strSQL & "NUM_SEQ_HASTA=" & rstCon.Fields(6).Value & " AND "
							strSQL = strSQL & "DI_ID=" & rstCon.Fields("DI_ID").Value
							
							mfExecute(conPasarela, strSQL)
						End If
						H = H + 1
					End If
				End If
				
				rstCon.MoveNext()
				j = j + 1
			End While
			rstTram.MoveNext()
			I = I + 1
		End While
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		If blnParar = True Then Exit Sub
		logError("msLec_Conectores_ACC - " & Err.Description)
		'aketza errores
		Insertar_Error(Me, "Lectura de conectores entre acciones", "Ha ocurrido un error no controlado", "msLec_Conectores_ACC" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		Resume procFin
procFin: 
		CierraRS(rstCon)
		'UPGRADE_NOTE: Object rstCon may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstCon = Nothing
		CierraRS(rstXML)
		'UPGRADE_NOTE: Object rstXML may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstXML = Nothing
		CierraRS(rstProp)
		'UPGRADE_NOTE: Object rstProp may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProp = Nothing
		CierraRS(rstTram)
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		
	End Sub
	
	Private Sub msTablasInfra(ByVal Id As Integer, ByVal NOMBRE As String, ByRef contador As Integer, ByVal tipTram As String, ByVal nivtram As Integer, ByVal indBloq As String, ByVal nomTram As String, ByVal TramSimul As String, ByVal tramOcul As String, ByVal codFase As String, ByVal codSubfase As String, ByVal datoFasSubf As String, Optional ByVal pstrTramCond As String = "")
		'Inicio Jonathan 19/02/2016 - Nuevo parámetro opcional pstrTramCond, indica si el trámite es condicionado:
		'habrá que evaluar la condición y grabar los campos VAR_FLUJO, CRITERIO_COMP, VALOR_FIJO en la TBPFIN03_PA
		Dim strSQL As String
		Dim tipTram2 As String
		Dim rstAux As ADODB.Recordset
		'Inicio Jonathan 19/02/2016
		Dim strVAR_FLUJO As String
		Dim strCRITERIO_COMP As String
		Dim strVALOR_FIJO As String
		Dim colXML As Collection
		Dim colXMLD As Collection
		'Fin Jonathan 19/02/2016
		
		On Error GoTo procErr
		
		'Comprobamos si existe la Descripción del Trámite en Castellano
		strSQL = "SELECT * " & "FROM TBDCELTA_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_AMBITO = '" & strCodEntid & strCodFamil & "' " & "AND ELTA_CODTAB = 'P2' " & "AND ELTA_IDIOMA = 'C' " & "AND ELTA_CLAVE = '" & CStr(Id) & "' " & "AND ELTA_DESC20 = '" & Mid(NOMBRE, 1, 20) & "' " & "AND ELTA_DESC40 = '" & Mid(NOMBRE, 1, 40) & "' " & "AND ELTA_DESC60 = '" & Mid(NOMBRE, 1, 60) & "'"
		rstAux = mfRecordset(conPasarela, strSQL)
		If rstAux.EOF Then
			'Damos de alta la Descripción del Trámite en Castellano
			strSQL = "INSERT INTO TBDCELTA_PA (PROCEDIMIENTO, ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, ELTA_DESC20, ELTA_DESC40, ELTA_DESC60) VALUES (" & "'" & gNomProcCorto & "', " & "'" & strCodEntid & strCodFamil & "', " & "'P2', " & "'C', " & "'" & CStr(Id) & "', " & "'" & Mid(NOMBRE, 1, 20) & "', " & "'" & Mid(NOMBRE, 1, 40) & "', " & "'" & Mid(NOMBRE, 1, 60) & "')"
			mfExecute(conPasarela, strSQL)
		End If
		'Comprobamos si existe la Descripción del Trámite en Euskera
		strSQL = "SELECT * " & "FROM TBDCELTA_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_AMBITO = '" & strCodEntid & strCodFamil & "' " & "AND ELTA_CODTAB = 'P2' " & "AND ELTA_IDIOMA = 'E' " & "AND ELTA_CLAVE = '" & CStr(Id) & "' " & "AND ELTA_DESC20 = 'E-" & Mid(NOMBRE, 1, 18) & "' " & "AND ELTA_DESC40 = 'E-" & Mid(NOMBRE, 1, 38) & "' " & "AND ELTA_DESC60 = 'E-" & Mid(NOMBRE, 1, 58) & "'"
		rstAux = mfRecordset(conPasarela, strSQL)
		If rstAux.EOF Then
			'Damos de alta la Descripción del Trámite en Euskera
			strSQL = "INSERT INTO TBDCELTA_PA (PROCEDIMIENTO, ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, ELTA_DESC20, ELTA_DESC40, ELTA_DESC60) VALUES (" & "'" & gNomProcCorto & "', " & "'" & strCodEntid & strCodFamil & "', " & "'P2', " & "'E', " & "'" & CStr(Id) & "', " & "'E-" & Mid(NOMBRE, 1, 18) & "', " & "'E-" & Mid(NOMBRE, 1, 38) & "', " & "'E-" & Mid(NOMBRE, 1, 58) & "')"
			mfExecute(conPasarela, strSQL)
		End If
		
		'Inicializamos los Valores de los Campos de Definición del Trámite
		'Indicador Tramitación Simultánea
		If TramSimul <> "" Then
			TramSimul = "S"
		Else
			TramSimul = "N"
		End If
		'Indicador Trámite Oculto
		If tramOcul <> "" Then
			tramOcul = "S"
		Else
			tramOcul = "N"
		End If
		'Indicador Bloqueo
		If indBloq <> "" Then
			indBloq = "S"
		Else
			indBloq = "N"
		End If
		'Trámite Condicionado
		If pstrTramCond <> "" Then
			'Es un Trámite Condicionado
			colXML = New Collection
			colXML.Add("Variable de la condición")
			colXML.Add("Criterio de comparación")
			colXML.Add("Valor de comparación")
			colXMLD = mfBuscaXML("Proceso", colXML, Id,  , True)
			'Variable de la condición - buscamos el valor de la variable
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strVAR_FLUJO = Trim(colXMLD.Item(1))
			'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariablesNOMBRE(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strVAR_FLUJO = mfInsertaVariablesNOMBRE(strVAR_FLUJO)
			'Criterio de comparación - se ha obtenido el id de la opción seleccionada, buscamos en CW_LOOKUP su literal
			strCRITERIO_COMP = vbNullString
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If Trim(colXMLD.Item(2)) <> "" Then
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT LU_NAME " & "FROM CW_LOOKUP " & "WHERE MODEL_NAME = '" & strModelo & "' " & "AND LU_ID = " & Trim(colXMLD.Item(2))
				rstAux = mfRecordset(conDP4, strSQL)
				If Not rstAux.EOF Then
					strCRITERIO_COMP = rstAux.Fields(0).Value
				End If
			End If
			'Valor de comparación
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strVALOR_FIJO = Trim(colXMLD.Item(3))
			'Comprobamos si el Trámite es de Bloqueo para cambiar el Indicador del Trámite de S a C
			If indBloq = "S" Then
				indBloq = "C"
			End If
		Else
			'No es un Trámite Condicionado
			strVAR_FLUJO = vbNullString
			strCRITERIO_COMP = vbNullString
			strVALOR_FIJO = vbNullString
		End If
		'Creamos el Trámite
		strSQL = "INSERT INTO TBPFIN03_PA (PROCEDIMIENTO, CODPROCE, ORDENTRA, CODTRAAD, INDPROCE, NIVTRAMI, INDBLOQ, NOMBRE, INDSIMUL, TRAMOCUL, CODFASE, CODSFASE, DATFASUB, " & "VAR_FLUJO,CRITERIO_COMP,VALOR_FIJO) VALUES (" & "'" & gNomProcCorto & "', " & lngCodProc & ", " & contador & ", " & Id & ", " & "'" & tipTram & "', " & nivtram & ", " & "'" & indBloq & "', " & "'" & nomTram & "', " & "'" & TramSimul & "', " & "'" & tramOcul & "', " & "'" & codFase & "', " & "'" & codSubfase & "', " & "'" & datoFasSubf & "', " & "'" & strVAR_FLUJO & "', " & "'" & strCRITERIO_COMP & "', " & "'" & strVALOR_FIJO & "')"
		mfExecute(conPasarela, strSQL)
		
		'Trámite condicionado
		If pstrTramCond <> "" Then
			'Validar que los tres campos estén informados en Corporate. Se permite el grabado de la TBPFIN03_PA pero el proceso mostrará error
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If Trim(colXMLD.Item(1)) = "" Or Trim(colXMLD.Item(2)) = "" Or Trim(colXMLD.Item(3)) = "" Then
				GoTo ErrTramiteCondicionado
			End If
		End If
		GoTo procFin
		
ErrTramiteCondicionado: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		logError("msTablasInfra - Trámite condicionado: deben informarse la Variable, el Criterio y el Valor. (" & nomTram & ")")
		Insertar_Error(Me, "Trámite condicionado", "En caso de Trámite condicionado, deben informarse la Variable, el Criterio y el Valor. (" & nomTram & ")", "msTablasInfra")
		Mostrar_Error()
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		logError("msTablasInfra - " & Err.Description)
		Insertar_Error(Me, "Datos para infraestructura", "Ha ocurrido un error no controlado", "msTablasInfra")
		Mostrar_Error()
		Resume procFin
		
procFin: 
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
	End Sub
	Private Sub msUnidTraRami(ByVal AnoID As Integer, ByVal idPadre As Integer, ByVal idpadre2 As Integer, ByVal Orden As Integer, ByRef orden1 As Integer, ByRef orden2 As Integer, ByRef orden3 As Integer, ByRef orden4 As Integer, ByRef orden5 As Integer, ByRef idInicial As Integer, Optional ByRef idArrastra As Integer = 0)
		Dim rstTram As ADODB.Recordset
		Dim rstTram1 As ADODB.Recordset
		Dim rstTram2 As ADODB.Recordset
		Dim rsttram3 As ADODB.Recordset
		Dim rsttram4 As ADODB.Recordset
		Dim rsttram5 As ADODB.Recordset
		Dim rsttram6 As ADODB.Recordset
		'aketza 09/04/2008
		Dim rstAux As ADODB.Recordset
		'fin aketza
		Dim strSQL As String
		Dim arr As Object
		Dim blnViene As Boolean
		Dim NIV1 As Boolean
		
		If orden1 = 4 And orden2 = 4 And orden3 = 1 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		
		strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & AnoID & " AND ORDEN_N1=" & orden1 & " AND " & "ORDEN_N2=" & orden2 & " AND ORDEN_N3=" & orden3 & " AND ORDEN_N4=" & orden4 & " AND " & "ORDEN_N5=" & orden5
		rstTram1 = New ADODB.Recordset
		rstTram1 = mfRecordset(conPasarela, strSQL)
		strSQL = "SELECT DISTINCT D.OU_ID, C.PR_NAME, E.OU_NAME FROM "
		strSQL = strSQL & "DIAGRAM A, SHAPE B, PROCESS C, CW_REASON D, ORGANIZATION E WHERE "
		strSQL = strSQL & "A.DI_ID=B.DI_ID AND "
		strSQL = strSQL & "B.ANO_ID=C.PR_ID AND "
		strSQL = strSQL & "C.PR_ID=D.PR_ID AND "
		strSQL = strSQL & "D.OU_ID=E.OU_ID AND "
		strSQL = strSQL & "B.ANO_ID= " & AnoID
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		rstTram = mfRecordset(conDP4, strSQL)
		If Not rstTram.EOF Then
			If rstTram.Fields("OU_NAME").Value = "Persona Interesada" Or rstTram.Fields("OU_NAME").Value = "Persona Implicada" Then
				Insertar_Error(Me, "Aviso UT asociada", "La ramificación " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram.Fields("OU_NAME").Value, "msUnidTraRami")
				Exit Sub
			End If
			'UPGRADE_WARNING: Couldn't resolve default property of object rstTram.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstTram.GetRows
			System.Windows.Forms.Application.DoEvents()
			rstTram.MoveFirst()
			'si existe mas de uno
			If UBound(arr, 2) + 1 > 1 Then
				strSQL = "SELECT ID_DIAGRAMA, ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE"
				rsttram3 = mfRecordset(conPasarela, strSQL)
				If Not rsttram3.EOF Then
					AnoID = rsttram3.Fields("ID_DIAGRAMA").Value
					'idpadre = rsttram3("DI_ID")
					idPadre = rsttram3.Fields("ID_PADRE").Value
				Else
					AnoID = AnoID
					idPadre = idPadre
				End If
				strSQL = "Select OU_ID, OU_NAME "
				strSQL = strSQL & "From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
				strSQL = strSQL & "Where A.OT_NAME = 'Proceso' AND "
				strSQL = strSQL & "A.OT_ID = C.ANO_TABNR and "
				strSQL = strSQL & "B.PR_ID = C.ANO_ID and "
				strSQL = strSQL & "C.DI_ID = D.DI_ID and "
				strSQL = strSQL & "D.ANO_ID = E.OU_ID AND "
				strSQL = strSQL & "C.SH_X > D.SH_X and "
				strSQL = strSQL & "C.SH_X < D.SH_WIDTH+D.SH_X and "
				strSQL = strSQL & "C.SH_Y < D.SH_Y and "
				strSQL = strSQL & "C.SH_Y > D.SH_Y - D.SH_HEIGHT and "
				strSQL = strSQL & "B.PR_ID =" & AnoID & " and "
				strSQL = strSQL & "C.DI_ID =" & idPadre
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				rsttram3 = mfRecordset(conDP4, strSQL)
				If Not rsttram3.EOF Then
					strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rsttram3.Fields("OU_ID").Value
					rstTram2 = mfRecordset(conPasarela, strSQL)
					If Not rstTram2.EOF Then
						Insertar_Error(Me, "Aviso UT asociada", "La ramificación " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram2.Fields("CODUTRHN").Value, "msUnidTraRami")
					Else
						While Not rstTram.EOF
							strSQL = "SELECT CODUNITR, CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
							rstTram2 = mfRecordset(conPasarela, strSQL)
							If Not rstTram2.EOF Then
								'## DS66 09/01/09
								Insertar_Error(Me, "Aviso UT asociada", "La ramificación " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram2.Fields("CODUTRHN").Value, "msUnidTraRami")
								'##
							End If
							rstTram.MoveNext()
						End While
					End If
				End If
			Else
				'solamente tiene 1
				strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
				rstTram2 = mfRecordset(conPasarela, strSQL)
				If Not rstTram2.EOF Then
					'## DS66 09/01/09
					Insertar_Error(Me, "Aviso UT asociada", "La ramificación " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram2.Fields("CODUTRHN").Value, "msUnidTraRami")
					'##
				End If
			End If
		End If
		
	End Sub
	
	
	Private Function mfUnidTra(ByVal AnoID As Integer, ByVal idPadre As Integer, ByVal idpadre2 As Integer, ByVal Orden As Integer, ByRef orden1 As Integer, ByRef orden2 As Integer, ByRef orden3 As Integer, ByRef orden4 As Integer, ByRef orden5 As Integer, ByRef idInicial As Integer, Optional ByRef idArrastra As Integer = 0) As Boolean
		
		On Error GoTo procErr
		
		strSeg = orden1 & "/" & orden2 & "/" & orden3 & "/" & orden4 & "/" & orden5
		
		'If strSeg = "3/0/0/0/0" Then
		'   MsgBox "Parada"
		'Ainhoa 02/08/2010
		'   logError Now & " - AnoID:" & AnoID & ", idPadre: " & idpadre & ", idPadre2: " & idpadre2 & ", Orden: " & Orden & ", ORDEN1: " & ORDEN1 & ", ORDEN2: " & ORDEN2 & ", ORDEN3: " & ORDEN3 & ", ORDEN4: " & ORDEN4 & ", ORDEN5: " & ORDEN5 & ", idInicial: " & idInicial & ", idArrastra: " & idArrastra
		'Else
		'   logError Now & " - AnoID:" & AnoID & ", idPadre: " & idpadre & ", idPadre2: " & idpadre2 & ", Orden: " & Orden & ", ORDEN1: " & ORDEN1 & ", ORDEN2: " & ORDEN2 & ", ORDEN3: " & ORDEN3 & ", ORDEN4: " & ORDEN4 & ", ORDEN5: " & ORDEN5 & ", idInicial: " & idInicial & ", idArrastra: " & idArrastra
		'End If
		
		Dim rstTram As ADODB.Recordset
		Dim rstTram1 As ADODB.Recordset
		Dim rstTram2 As ADODB.Recordset
		Dim rsttram3 As ADODB.Recordset
		Dim rsttram4 As ADODB.Recordset
		Dim rsttram5 As ADODB.Recordset
		Dim rsttram6 As ADODB.Recordset
		'aketza 09/04/2008
		Dim rstAux As ADODB.Recordset
		'fin aketza
		Dim strSQL As String
		Dim arr As Object
		Dim blnViene As Boolean
		Dim NIV1 As Boolean
		'Inicio Jonathan Prieto 03/12/2012
		Dim intNumSeq As Short
		'Fin Jonathan Prieto 03/12/2012
		
		mfUnidTra = True
		strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & AnoID & " AND ORDEN_N1=" & orden1 & " AND " & "ORDEN_N2=" & orden2 & " AND ORDEN_N3=" & orden3 & " AND ORDEN_N4=" & orden4 & " AND " & "ORDEN_N5=" & orden5
		rstTram1 = New ADODB.Recordset
		rstTram1 = mfRecordset(conPasarela, strSQL)
		strSQL = "SELECT DISTINCT D.OU_ID, C.PR_NAME, E.OU_NAME FROM "
		strSQL = strSQL & "DIAGRAM A, SHAPE B, PROCESS C, CW_REASON D, ORGANIZATION E WHERE "
		strSQL = strSQL & "A.DI_ID=B.DI_ID AND "
		strSQL = strSQL & "B.ANO_ID=C.PR_ID AND "
		strSQL = strSQL & "C.PR_ID=D.PR_ID AND "
		strSQL = strSQL & "D.OU_ID=E.OU_ID AND "
		strSQL = strSQL & "B.ANO_ID= " & AnoID
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		rstTram = mfRecordset(conDP4, strSQL)
		If Not rstTram.EOF Then
			If rstTram.Fields("OU_NAME").Value = "Persona Interesada" Or rstTram.Fields("OU_NAME").Value = "Persona Implicada" Then
				strSQL = "UPDATE PROPIEDADES_DI SET INDPERSINT='1' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & AnoID
				mfExecute(conPasarela, strSQL)
				strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & "'76','USUARIO-GENERAL','S','N')"
				mfExecute(conPasarela, strSQL)
				Exit Function
			End If
			'UPGRADE_WARNING: Couldn't resolve default property of object rstTram.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstTram.GetRows
			System.Windows.Forms.Application.DoEvents()
			rstTram.MoveFirst()
			'si existe mas de uno
			If UBound(arr, 2) + 1 > 1 Then
				strSQL = "SELECT ID_DIAGRAMA, ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE"
				rsttram3 = mfRecordset(conPasarela, strSQL)
				If Not rsttram3.EOF Then
					AnoID = rsttram3.Fields("ID_DIAGRAMA").Value
					'idpadre = rsttram3("DI_ID")
					idPadre = rsttram3.Fields("ID_PADRE").Value
				Else
					AnoID = AnoID
					idPadre = idPadre
				End If
				strSQL = "Select OU_ID, OU_NAME "
				strSQL = strSQL & "From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
				strSQL = strSQL & "Where A.OT_NAME = 'Proceso' AND "
				strSQL = strSQL & "A.OT_ID = C.ANO_TABNR and "
				strSQL = strSQL & "B.PR_ID = C.ANO_ID and "
				strSQL = strSQL & "C.DI_ID = D.DI_ID and "
				strSQL = strSQL & "D.ANO_ID = E.OU_ID AND "
				strSQL = strSQL & "C.SH_X > D.SH_X and "
				strSQL = strSQL & "C.SH_X < D.SH_WIDTH+D.SH_X and "
				strSQL = strSQL & "C.SH_Y < D.SH_Y and "
				strSQL = strSQL & "C.SH_Y > D.SH_Y - D.SH_HEIGHT and "
				strSQL = strSQL & "B.PR_ID =" & AnoID & " and "
				strSQL = strSQL & "C.DI_ID =" & idPadre
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				rsttram3 = mfRecordset(conDP4, strSQL)
				If Not rsttram3.EOF Then
					strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rsttram3.Fields("OU_ID").Value
					rstTram2 = mfRecordset(conPasarela, strSQL)
					If Not rstTram2.EOF Then
						strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
						mfExecute(conPasarela, strSQL)
					Else
						While Not rstTram.EOF
							strSQL = "SELECT CODUNITR, CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
							rstTram2 = mfRecordset(conPasarela, strSQL)
							If Not rstTram2.EOF Then
								strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
								mfExecute(conPasarela, strSQL)
								
								'aketza 09/04/2008
								strSQL = "select Cat_Diagrama from diagrama WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and Nombre='" & rstTram.Fields("PR_NAME").Value & "'"
								rstAux = mfRecordset(conPasarela, strSQL)
								If Not rstAux.EOF Then
									If rstAux.Fields("Cat_Diagrama").Value = "Ramificación" Then
										Insertar_Error(Me, "Aviso UT asociada", "La ramificación " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram2.Fields("CODUTRHN").Value, "mfUnidTra" & " -" & strSeg)
									End If
									If rstAux.Fields("Cat_Diagrama").Value = "Trámite general" Then
										Insertar_Error(Me, "Aviso UT asociada", "El trámite " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram2.Fields("CODUTRHN").Value, "mfUnidTra" & " -" & strSeg)
									End If
								End If
								'fin aketza
							Else
								If rstTram.Fields("OU_ID").Value <> 76 Then
									'If rstTram1("TIPO_DIAGRAMA") <> "O" Then
									Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite  " & rstTram.Fields("PR_NAME").Value, "mfUnidTra" & " -" & strSeg)
									Mostrar_Error()
									'End If
									mfUnidTra = False
								End If
							End If
							rstTram.MoveNext()
						End While
					End If
				End If
			Else
				'solamente tiene 1
				strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
				rstTram2 = mfRecordset(conPasarela, strSQL)
				If Not rstTram2.EOF Then
					strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
					mfExecute(conPasarela, strSQL)
					'aketza 09/04/2008
					strSQL = "select Cat_Diagrama from diagrama WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and Nombre='" & rstTram.Fields("PR_NAME").Value & "'"
					rstAux = mfRecordset(conPasarela, strSQL)
					If Not rstAux.EOF Then
						If rstAux.Fields("Cat_Diagrama").Value = "Ramificación" Then
							Insertar_Error(Me, "Aviso UT asociada", "La ramificación " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram2.Fields("CODUTRHN").Value, "mfUnidTra")
						End If
						If rstAux.Fields("Cat_Diagrama").Value = "Trámite general" Then
							Insertar_Error(Me, "Aviso UT asociada", "El trámite " & rstTram.Fields("PR_NAME").Value & ", tiene asociada la Unidad de tramitación " & rstTram2.Fields("CODUTRHN").Value, "mfUnidTra")
						End If
					End If
					'fin aketza
				Else
					mfUnidTra = False
					'If rstTram1("TIPO_DIAGRAMA") <> "O" Then
					Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite  " & rstTram.Fields("PR_NAME").Value, "mfUnidTra" & " -" & strSeg)
					Mostrar_Error()
					'End If
				End If
			End If
		Else
			'se buscan las del padre y se vuelve a realizar el mismo proceso
			If rstTram1.EOF Then GoTo ramif
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value & " and ORDEN_N3=" & rstTram1.Fields("ORDEN_N3").Value & " and ORDEN_N4=" & rstTram1.Fields("ORDEN_N4").Value & " and ORDEN_N5=" & rstTram1.Fields("ORDEN_N5").Value
			rsttram3 = mfRecordset(conPasarela, strSQL)
			'Inicio Jonathan Prieto 03/12/2012
			intNumSeq = rsttram3.Fields("NUM_SEQ").Value
			strSQL = "Select OU_ID, OU_NAME From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
			strSQL = strSQL & " Where A.OT_NAME = 'Proceso' AND A.OT_ID = C.ANO_TABNR and B.PR_ID = C.ANO_ID "
			strSQL = strSQL & " and C.DI_ID = D.DI_ID and D.ANO_ID = E.OU_ID AND C.SH_X > D.SH_X and C.SH_X < D.SH_WIDTH+D.SH_X and C.SH_Y < D.SH_Y and C.SH_Y > D.SH_Y - D.SH_HEIGHT "
			strSQL = strSQL & " and B.PR_ID =" & AnoID & " and C.DI_ID =" & idPadre & " and C.SH_SEQ= " & intNumSeq
			'Fin Jonathan Prieto 03/12/2012
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			rsttram3 = mfRecordset(conDP4, strSQL)
			If Not rsttram3.EOF Then
				strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUMORG=" & rsttram3.Fields("OU_ID").Value
				rstTram2 = mfRecordset(conPasarela, strSQL)
				If Not rstTram2.EOF Then
					GoTo ameter
				End If
			End If
			If rstTram1.Fields("ORDEN_N4").Value <> 0 Then
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idpadre2 & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram1.Fields("ORDEN_N3").Value
			ElseIf rstTram1.Fields("ORDEN_N3").Value <> 0 Then 
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idpadre2 & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value
			ElseIf rstTram1.Fields("ORDEN_N2").Value <> 0 Then 
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idpadre2 & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
			Else
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
			End If
			rsttram3 = mfRecordset(conPasarela, strSQL)
			If rsttram3.EOF Then
				NIV1 = False
				If rstTram1.Fields("ORDEN_N4").Value <> 0 Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram1.Fields("ORDEN_N3").Value
				ElseIf rstTram1.Fields("ORDEN_N3").Value <> 0 Then 
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value
				ElseIf rstTram1.Fields("ORDEN_N2").Value <> 0 Then 
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
				Else
					NIV1 = True
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
				End If
				rsttram3 = mfRecordset(conPasarela, strSQL)
			End If
			If Not rsttram3.EOF Then
				mfUnidTra(rsttram3.Fields("ID_DIAGRAMA"), rsttram3.Fields("DI_ID"), rsttram3.Fields("ID_PADRE"), Orden, rsttram3.Fields("ORDEN_N1"), rsttram3.Fields("ORDEN_N2"), rsttram3.Fields("ORDEN_N3"), rsttram3.Fields("ORDEN_N4"), rsttram3.Fields("ORDEN_N5"), idInicial, IIf(idArrastra <> 0, idArrastra, AnoID))
			Else
ramif: 
				strSQL = "Select OU_ID, OU_NAME "
				strSQL = strSQL & "From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
				strSQL = strSQL & "Where A.OT_NAME = 'Proceso' AND "
				strSQL = strSQL & "A.OT_ID = C.ANO_TABNR and "
				strSQL = strSQL & "B.PR_ID = C.ANO_ID and "
				strSQL = strSQL & "C.DI_ID = D.DI_ID and "
				strSQL = strSQL & "D.ANO_ID = E.OU_ID AND "
				strSQL = strSQL & "C.SH_X > D.SH_X and "
				strSQL = strSQL & "C.SH_X < D.SH_WIDTH+D.SH_X and "
				strSQL = strSQL & "C.SH_Y < D.SH_Y and "
				strSQL = strSQL & "C.SH_Y > D.SH_Y - D.SH_HEIGHT and "
				strSQL = strSQL & "B.PR_ID =" & AnoID & " and "
				strSQL = strSQL & "C.DI_ID =" & idPadre
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 03/12/2012
				strSQL = strSQL & " AND C.SH_SEQ=" & intNumSeq
				'Fin Jonathan Prieto 03/12/2012
				
				rsttram3 = mfRecordset(conDP4, strSQL)
ameter: 
				If Not rsttram3.EOF Then
					strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rsttram3.Fields("OU_ID").Value
					rstTram2 = mfRecordset(conPasarela, strSQL)
					If Not rstTram2.EOF Then
						strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
						mfExecute(conPasarela, strSQL)
					Else
						If NIV1 = True Then
							'Inicio Jonathan Prieto 29/04/2011
							'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA= " & rstTram1("ID_DIAGRAMA")
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ID_DIAGRAMA= " & rstTram1.Fields("ID_DIAGRAMA").Value & " AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
						Else
							'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & idpadre2 & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1("ORDEN_N1")
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ID_DIAGRAMA=" & idpadre2 & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & "" & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram1.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram1.Fields("ORDEN_N5").Value
							'Fin Jonathan Prieto 29/04/2011
						End If
						rsttram4 = mfRecordset(conPasarela, strSQL)
						If Not rsttram4.EOF Then
							strSQL = "Select OU_ID, OU_NAME "
							strSQL = strSQL & "From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
							strSQL = strSQL & "Where A.OT_NAME = 'Proceso' AND "
							strSQL = strSQL & "A.OT_ID = C.ANO_TABNR and "
							strSQL = strSQL & "B.PR_ID = C.ANO_ID and "
							strSQL = strSQL & "C.DI_ID = D.DI_ID and "
							strSQL = strSQL & "D.ANO_ID = E.OU_ID AND "
							strSQL = strSQL & "C.SH_X > D.SH_X and "
							strSQL = strSQL & "C.SH_X < D.SH_WIDTH+D.SH_X and "
							strSQL = strSQL & "C.SH_Y < D.SH_Y and "
							strSQL = strSQL & "C.SH_Y > D.SH_Y - D.SH_HEIGHT and "
							strSQL = strSQL & "B.PR_ID =" & IIf(NIV1 = True, rsttram4.Fields("ID_DIAGRAMA").Value, idpadre2) & " and C.di_id=" & rsttram4.Fields("DI_ID").Value
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 29/04/2011
							strSQL = strSQL & " AND C.SH_SEQ=" & rsttram4.Fields("NUM_SEQ").Value
							'Fin Jonathan Prieto 29/04/2011
							rsttram5 = mfRecordset(conDP4, strSQL)
							If Not rsttram5.EOF Then
								strSQL = "SELECT * FROM EQUIV_UT WHERE CODCM=" & rsttram5.Fields("OU_ID").Value
								rsttram6 = mfRecordset(conPasarela, strSQL)
								If Not rsttram6.EOF Then
									While Not rsttram6.EOF
										strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, "
										strSQL = strSQL & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES "
										strSQL = strSQL & "('" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & ", "
										strSQL = strSQL & rsttram6.Fields("CODHN").Value & ",'" & rsttram6.Fields("CODUTRHN").Value & "','S','N')"
										mfExecute(conPasarela, strSQL)
										rsttram6.MoveNext()
									End While
								Else
									strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUMORG=" & rsttram5.Fields("OU_ID").Value
									rsttram6 = mfRecordset(conPasarela, strSQL)
									If Not rsttram6.EOF Then
										strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO, CODPROCE, ORDENTRA, CODTRAAD, "
										strSQL = strSQL & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES ('" & gNomProcCorto & "', "
										strSQL = strSQL & lngCodProc & "," & Orden & ", " & idInicial & ", "
										strSQL = strSQL & rsttram6.Fields("CODUNITR").Value & ",'" & rsttram6.Fields("CODUTRHN").Value & "','S','N')"
										mfExecute(conPasarela, strSQL)
									Else
										mfUnidTra(rsttram4.Fields("ID_DIAGRAMA"), rsttram4.Fields("DI_ID"), rsttram4.Fields("ID_PADRE"), Orden, rsttram4.Fields("ORDEN_N1"), rsttram4.Fields("ORDEN_N2"), rsttram4.Fields("ORDEN_N3"), rsttram4.Fields("ORDEN_N4"), rsttram4.Fields("ORDEN_N5"), idInicial, IIf(idArrastra <> 0, idArrastra, AnoID))
									End If
								End If
							Else
								mfUnidTra(rsttram3.Fields("ID_DIAGRAMA"), rsttram3.Fields("DI_ID"), rsttram3.Fields("ID_PADRE"), Orden, rsttram3.Fields("ORDEN_N1"), rsttram3.Fields("ORDEN_N2"), rsttram3.Fields("ORDEN_N3"), rsttram3.Fields("ORDEN_N4"), rsttram3.Fields("ORDEN_N5"), idInicial, IIf(idArrastra <> 0, idArrastra, AnoID))
							End If
						End If
						While Not rstTram.EOF
							strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
							rstTram2 = mfRecordset(conPasarela, strSQL)
							If Not rstTram2.EOF Then
								strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
								mfExecute(conPasarela, strSQL)
							Else
								'If rstTram1("TIPO_DIAGRAMA") <> "O" Then
								Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite " & rstTram.Fields("PR_NAME").Value, "mfUnidTra" & " -" & strSeg)
								Mostrar_Error()
								'End If
								mfUnidTra = False
							End If
							rstTram.MoveNext()
						End While
					End If
				Else
					'If rstTram1("TIPO_DIAGRAMA") <> "O" Then
					Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite  " & IIf(rstTram1.Fields("TIPO_DIAGRAMA").Value <> "O", AnoID, idInicial), "mfUnidTra" & " -" & strSeg)
					Mostrar_Error()
					'End If
					mfUnidTra = False
				End If
			End If
		End If
		
		GoTo procFin
procErr: 
		'Resume Next
		'Resume
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		logError("mfUnidTra - " & Err.Description)
		Insertar_Error(Me, "Lectura de Unidades de Tramitación", "Ha ocurrido un error no controlado", "mfUnidTra" & " -" & strSeg)
		
		Mostrar_Error()
		Resume procFin
procFin: 
		CierraRS(rstTram)
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
		CierraRS(rstTram2)
		'UPGRADE_NOTE: Object rstTram2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram2 = Nothing
		CierraRS(rsttram3)
		'UPGRADE_NOTE: Object rsttram3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rsttram3 = Nothing
		CierraRS(rsttram4)
		'UPGRADE_NOTE: Object rsttram4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rsttram4 = Nothing
		CierraRS(rsttram5)
		'UPGRADE_NOTE: Object rsttram5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rsttram5 = Nothing
		CierraRS(rsttram6)
		'UPGRADE_NOTE: Object rsttram6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rsttram6 = Nothing
		'aketza 09/04/2008
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'fin aketza
	End Function
	
	
	'MU88 - Gestión de Fases/Subfases
	Private Function mfFaseSubfase(ByVal idDiagrama As Integer, ByVal idPadre As Integer, ByVal numSeq As Integer, ByVal orden1 As Integer, ByVal orden2 As Integer, ByVal orden3 As Integer, ByVal orden4 As Integer, ByVal orden5 As Integer, ByVal categoriaDiagrama As String) As Object
		'Declaración de Constantes
		Const cstrEtiquetaFase As String = "CÓDIGODEFASE"
		Const cstrEtiquetaSubFase As String = "CÓDIGODESUBFASE"
		Const cTipoDatoPropTexto As Short = 3
		Const cCampoUSERDEFINED As String = "USERDEFINED"
		
		'Definición de Variables
		Dim strError As String
		Dim arrRetorno As Object
		Dim blnPrimerObjetoRamificacion As Boolean
		Dim strSQL As String
		Dim rstFaseSubfaseRamificacion As ADODB.Recordset
		Dim strFaseRamificacion As String
		Dim strSubFaseRamificacion As String
		Dim strDatoImportanteRamificacion As String
		Dim rstObjetosFaseSubfase As ADODB.Recordset
		Dim rstFase As ADODB.Recordset
		Dim rstSubFase As ADODB.Recordset
		Dim rstDatoImp As ADODB.Recordset
		Dim strCodFase As String
		Dim strCodSubFase As String
		
		'   Dim strSQLBase    As String
		'   Dim strXML        As String
		'   Dim strSeq        As String
		'   Dim rstTram       As ADODB.Recordset
		'   Dim rstDiag       As ADODB.Recordset
		'   Dim rstInfra      As ADODB.Recordset
		'   Dim obj           As New clsCargaDatos
		
		On Error GoTo ERR_mfFaseSubfase
		
		'Inicializamos el Retorno
		ReDim arrRetorno(3)
		'UPGRADE_WARNING: Couldn't resolve default property of object arrRetorno(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		arrRetorno(0) = vbNullString 'Cód. Fase
		'UPGRADE_WARNING: Couldn't resolve default property of object arrRetorno(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		arrRetorno(1) = vbNullString 'Cód. Subfase
		'UPGRADE_WARNING: Couldn't resolve default property of object arrRetorno(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		arrRetorno(2) = vbNullString 'Dato importante
		
		'**************************************************************************************************************************************************************************************
		'**************************************************************************************************************************************************************************************
		' Dejamos el Código Comentado para que compile Pasarela
		'**************************************************************************************************************************************************************************************
		'**************************************************************************************************************************************************************************************
		'   'Comprobamos si estamos tratando el Primer Objeto (Trámite o Ramificación) de una Ramificación (nivel superior al 1)
		'   If orden1 > 0 Then
		'      If orden2 = 1 And orden3 = 0 And orden4 = 0 And orden5 = 0 Then
		'         'Primer Objeto de una Ramificación del Nivel 1
		'         blnPrimerObjetoRamificacion = True
		'         'Obtenemos la Definición de la Cabecera de la Ramificación
		'         strSQL = "SELECT CODFASE, " & _
		''                         "CODSFASE, " & _
		''                         "DATFASUB " & _
		''                  "FROM DIAGRAMA " & _
		''                  "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                    "AND ORDEN_N1 = " & orden1 & " " & _
		''                    "AND ORDEN_N2 = 0"
		'      ElseIf orden3 = 1 And orden4 = 0 And orden5 = 0 Then
		'         'Primer Objeto de una Ramificación del Nivel 2
		'         blnPrimerObjetoRamificacion = True
		'         'Obtenemos la Definición de la Cabecera de la Ramificación
		'         strSQL = "SELECT CODFASE, " & _
		''                         "CODSFASE, " & _
		''                         "DATFASUB " & _
		''                  "FROM DIAGRAMA " & _
		''                  "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                    "AND ORDEN_N1 = " & orden1 & " " & _
		''                    "AND ORDEN_N2 = " & orden2 & " " & _
		''                    "AND ORDEN_N3 = 0"
		'      ElseIf orden4 = 1 And orden5 = 0 Then
		'         'Primer Objeto de una Ramificación del Nivel 3
		'         blnPrimerObjetoRamificacion = True
		'         'Obtenemos la Definición de la Cabecera de la Ramificación
		'         strSQL = "SELECT CODFASE, " & _
		''                         "CODSFASE, " & _
		''                         "DATFASUB " & _
		''                  "FROM DIAGRAMA " & _
		''                  "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                    "AND ORDEN_N1 = " & orden1 & " " & _
		''                    "AND ORDEN_N2 = " & orden2 & " " & _
		''                    "AND ORDEN_N3 = " & orden3 & " " & _
		''                    "AND ORDEN_N4 = 0"
		'      ElseIf orden5 = 1 Then
		'         'Primer Objeto de una Ramificación del Nivel 4
		'         blnPrimerObjetoRamificacion = True
		'         'Obtenemos la Definición de la Cabecera de la Ramificación
		'         strSQL = "SELECT CODFASE, " & _
		''                         "CODSFASE, " & _
		''                         "DATFASUB " & _
		''                  "FROM DIAGRAMA " & _
		''                  "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                    "AND ORDEN_N1 = " & orden1 & " " & _
		''                    "AND ORDEN_N2 = " & orden2 & " " & _
		''                    "AND ORDEN_N3 = " & orden3 & " " & _
		''                    "AND ORDEN_N4 = " & orden4 & " " & _
		''                    "AND ORDEN_N5 = 0"
		'      End If
		'      'Obtenemos la Definición de la Cabecera de la Ramificación
		'      Set rstFaseSubfaseRamificacion = mfRecordset(conPasarela, strSQL)
		'      If Not rstFaseSubfaseRamificacion.EOF Then
		'         strFaseRamificacion = Trim(rstFaseSubfaseRamificacion("CODFASE"))
		'         strSubFaseRamificacion = Trim(rstFaseSubfaseRamificacion("CODSFASE"))
		'         strDatoImportanteRamificacion = Trim(rstFaseSubfaseRamificacion("DATFASUB"))
		'      Else
		'         'Error al Obtener la Definición de la Cabecera de la Ramificación
		'         strError = "ERROR al Obtener la Definición de la Cabecera de la Ramificación."
		'         GoTo ERR_mfFaseSubfase
		'      End If
		'   Else
		'      blnPrimerObjetoRamificacion = False
		'   End If
		'
		'   'Comprobamos si el Objeto (Trámite o Ramificación) está pintado sobre un Objeto "FaseSubfase"
		'   strSQL = "SELECT E.* " & _
		''            "FROM CW_OBJECT_TYPE A, " & _
		''                 "PROCESS B, " & _
		''                 "SHAPE C, " & _
		''                 "SHAPE D, " & _
		''                 "CW_OBJECT E, " & _
		''                 "CW_OBJECT_TYPE F " & _
		''            "WHERE A.OT_NAME = 'Proceso' " & _
		''              "AND B.PR_ID = " & idDiagrama & " " & _
		''              "AND A.OT_ID = C.ANO_TABNR " & _
		''              "AND B.PR_ID = C.ANO_ID " & _
		''              "AND E.OT_ID = F.OT_ID " & _
		''              "AND E.OT_ID = D.ANO_TABNR " & _
		''              "AND E.GO_ID = D.ANO_ID " & _
		''              "AND F.OT_NAME = 'FaseSubfase' " & _
		''              "AND C.DI_ID = D.DI_ID " & _
		''              "AND A.MODEL_NAME = '" & strModelo & "' AND B.MODEL_NAME = '" & strModelo & "' AND C.MODEL_NAME = '" & strModelo & "' AND D.MODEL_NAME = '" & strModelo & "' AND E.MODEL_NAME = '" & strModelo & "' AND F.MODEL_NAME = '" & strModelo & "' " & _
		''              "AND C.SH_X > D.SH_X " & _
		''              "AND C.SH_X < D.SH_WIDTH + D.SH_X " & _
		''              "AND C.SH_Y < D.SH_Y " & _
		''              "AND C.SH_Y > D.SH_Y - D.SH_HEIGHT"
		'   Set rstObjetosFaseSubfase = mfRecordset(conDP4, strSQL)
		'   If Not rstObjetosFaseSubfase.EOF Then
		'      'El Objeto (Trámite o Ramificación) está pintado sobre un Objeto "FaseSubfase"
		'      'Comprobamos si estamos tratando el Primer Objeto de una Ramificación
		'      If blnPrimerObjetoRamificacion Then
		'         'Comprobamos si la Ramificación estaba pintada sobre un Objeto "FaseSubfase"
		'         If strFaseRamificacion <> vbNullString Or strSubFaseRamificacion <> vbNullString Then
		'            'La Ramificación estaba pintada sobre un Objeto "FaseSubfase". Se da un error de Pasarela porque en Corporate no está bien pintado el Procedimiento
		'            strError = "ERROR, la Ramificación está pintada sobre un Objeto 'FaseSubfase' y el primer Objeto de la Ramificación también."
		'            GoTo ERR_mfFaseSubfase
		'         End If
		'      End If
		'      'Comprobamos si el Objeto (Trámite o Ramificación) está pintado sobre un y solo un Objeto "FaseSubfase"
		'      If rstObjetosFaseSubfase.RecordCount = 1 Then
		'         'Recogemos el XML donde se guardan los códigos de los Objetos Fase y Subfase
		'         strCodFase = obj.fBuscaDatoXML(rstObjetosFaseSubfase(cCampoUSERDEFINED), cstrEtiquetaFase, cTipoDatoPropTexto)
		'         strCodSubFase = obj.fBuscaDatoXML(rstObjetosFaseSubfase(cCampoUSERDEFINED), cstrEtiquetaSubFase, cTipoDatoPropTexto)
		'      Else
		'         'Si hay más de uno, filtrar por secuencia
		'         strSQL = strSQL & " AND C.SH_SEQ = " & numSeq
		'         Set rstObjetosFaseSubfase = mfRecordset(conDP4, strSQL)
		'         If Not rstObjetosFaseSubfase.EOF Then
		'            strCodFase = obj.fBuscaDatoXML(rstObjetosFaseSubfase(cCampoUSERDEFINED), cstrEtiquetaFase, cTipoDatoPropTexto)
		'            strCodSubFase = obj.fBuscaDatoXML(rstObjetosFaseSubfase(cCampoUSERDEFINED), cstrEtiquetaSubFase, cTipoDatoPropTexto)
		'         Else
		'            strError = "ERROR, el Objeto está pintado sobre más de un Objeto 'FaseSubfase'."
		'            GoTo ERR_mfFaseSubfase
		'         End If
		'         'Obtenemos los Códigos de la TBDCELTA correspondientes a los Objetos Fase y Subfase Recuperados
		'         'Fase
		'         strSQL = "SELECT LU_NAME, " & _
		''                         "LU_ABBREVIATION " & _
		''                  "FROM CW_LOOKUP " & _
		''                  "WHERE LU_ID = '" & strCodFase & "'"
		'         Set rstFase = mfRecordset(conDP4, strSQL)
		'         If Not rstFase.EOF Then
		'            arrRetorno(0) = rstFase("LU_ABBREVIATION")
		'         End If
		'         'Subfase
		'         strSQL = "SELECT LU_NAME, " & _
		''                         "LU_ABBREVIATION " & _
		''                  "FROM CW_LOOKUP " & _
		''                  "WHERE LU_ID = '" & strCodSubFase & "'"
		'         Set rstSubFase = mfRecordset(conDP4, strSQL)
		'         If Not rstSubFase.EOF Then
		'            arrRetorno(1) = rstSubFase("LU_ABBREVIATION")
		'         End If
		'         'Obtenemos el Dato Importante del Objeto "FaseSubfase"
		'         strSQL = "SELECT A.AT_ID AT_ID " & _
		''                  "FROM CW_INTER_OBJECT IO, " & _
		''                       "ENTITY E, " & _
		''                       "ATTRIBUTE A " & _
		''                  "WHERE IO.MODEL_NAME = '" & strModelo & "' " & _
		''                    "AND E.MODEL_NAME = '" & strModelo & "' " & _
		''                    "AND A.MODEL_NAME = '" & strModelo & "' " & _
		''                    "AND A.EN_ID = E.EN_ID " & _
		''                    "AND IO.ANO_ID_BELOW = " & rstObjetosFaseSubfase("GO_ID") & " " & _
		''                    "AND IO.GO_NAME <> '' " & _
		''                    "AND SUBSTRING(IO.GO_NAME, CHARINDEX('(', IO.GO_NAME) + 1, CHARINDEX(')', IO.GO_NAME) - CHARINDEX('(', IO.GO_NAME) - 1) = E.EN_NAME " & _
		''                    "AND SUBSTRING(IO.GO_NAME, 1, CHARINDEX('(', IO.GO_NAME) - 2) = A.AT_NAME"
		'         Set rstDatoImp = mfRecordset(conDP4, strSQL)
		'         If Not rstDatoImp.EOF Then
		'            'Obtenemos la Variable Hidra
		'            strSQL = "SELECT CODHIDRA " & _
		''                     "FROM VARIABLES " & _
		''                     "WHERE IDATRIBU = " & rstDatoImp("AT_ID")
		'            Set rstInfra = mfRecordset(conInfra, strSQL)
		'            If Not rstInfra.EOF Then
		'               arrRetorno(2) = rstInfra("CODHIDRA")
		'            End If
		'         End If
		'      End If
		'   Else
		'      'El Objeto (Trámite o Ramificación) no está pintado sobre un Objeto "FaseSubfase"
		'      If blnPrimerObjetoRamificacion Then
		'         arrRetorno(0) = strFaseRamificacion
		'         arrRetorno(1) = strSubFaseRamificacion
		'         arrRetorno(2) = strDatoImportanteRamificacion
		'      Else
		'         arrRetorno(0) = vbNullString
		'         arrRetorno(1) = vbNullString
		'         arrRetorno(2) = vbNullString
		'      End If
		'   End If
		'**************************************************************************************************************************************************************************************
		'**************************************************************************************************************************************************************************************
		'UPGRADE_WARNING: Couldn't resolve default property of object arrRetorno. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		'UPGRADE_WARNING: Couldn't resolve default property of object mfFaseSubfase. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		mfFaseSubfase = arrRetorno
		GoTo mfFaseSubfase
		
		'****************************************************************************************************************************************************************************************************
		'****************************************************************************************************************************************************************************************************
		'****************************************************************************************************************************************************************************************************
		'   'Buscar si objeto Trámite o Ramificación está dentro de un objeto FaseSubfase
		'   strSQLBase = "SELECT E.* " _
		''            & " FROM CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, CW_OBJECT E, CW_OBJECT_TYPE F" _
		''            & " WHERE A.OT_NAME = 'Proceso'" _
		''            & " AND B.PR_ID =" & idDiagrama _
		''            & " AND A.OT_ID = C.ANO_TABNR" _
		''            & " AND B.PR_ID = C.ANO_ID" _
		''            & " AND E.OT_ID = F.OT_ID" _
		''            & " AND E.OT_ID=D.ANO_TABNR" _
		''            & " AND E.GO_ID=D.ANO_ID" _
		''            & " AND F.OT_NAME = 'FaseSubfase'" _
		''            & " AND C.DI_ID = D.DI_ID" _
		''            & " AND A.MODEL_NAME ='" & strModelo & "'" _
		''            & " AND B.MODEL_NAME ='" & strModelo & "'" _
		''            & " AND C.MODEL_NAME ='" & strModelo & "'" _
		''            & " AND D.MODEL_NAME ='" & strModelo & "'" _
		''            & " AND E.MODEL_NAME ='" & strModelo & "'" _
		''            & " AND F.MODEL_NAME ='" & strModelo & "'" _
		''            & " AND C.SH_X > D.SH_X" _
		''            & " AND C.SH_X < D.SH_WIDTH+D.SH_X" _
		''            & " AND C.SH_Y < D.SH_Y" _
		''            & " AND C.SH_Y > D.SH_Y - D.SH_HEIGHT"
		'   Set rstTram = mfRecordset(conDP4, strSQLBase)
		'   If Not rstTram.EOF Then
		'      'Si hay datos...
		'      'Si sólo hay un registro, es el válido
		'      If rstTram.RecordCount = 1 Then
		'         'Recoger el XML donde se guardan los códigos de Fase y Subfase
		'         strCodFase = obj.fBuscaDatoXML(rstTram(cCampoUSERDEFINED), cstrEtiquetaFase, cTipoDatoPropTexto)
		'         strCodSubFase = obj.fBuscaDatoXML(rstTram(cCampoUSERDEFINED), cstrEtiquetaSubFase, cTipoDatoPropTexto)
		'      Else
		'         'Si hay más de uno, filtrar por secuencia
		'         strSQL = strSQLBase & " AND C.SH_SEQ = " & numSeq
		'         Set rstTram = mfRecordset(conDP4, strSQL)
		'         If Not rstTram.EOF Then
		'            strCodFase = obj.fBuscaDatoXML(rstTram(cCampoUSERDEFINED), cstrEtiquetaFase, cTipoDatoPropTexto)
		'            strCodSubFase = obj.fBuscaDatoXML(rstTram(cCampoUSERDEFINED), cstrEtiquetaSubFase, cTipoDatoPropTexto)
		'         Else
		'            'ERROR!!!
		'            GoTo buscarpadre
		'         End If
		'      End If
		'
		'      'FASE
		'      strSQL = "SELECT LU_NAME, LU_ABBREVIATION From cw_lookup Where LU_ID = '" & strCodFase & "'"
		'      Set rstFase = mfRecordset(conDP4, strSQL)
		'      If Not rstFase.EOF Then arrRetorno(0) = rstFase("LU_ABBREVIATION")
		'
		'      'SUBFASE
		'      strSQL = "SELECT LU_NAME, LU_ABBREVIATION From cw_lookup Where LU_ID = '" & strCodSubFase & "'"
		'      Set rstSubFase = mfRecordset(conDP4, strSQL)
		'      If Not rstSubFase.EOF Then arrRetorno(1) = rstSubFase("LU_ABBREVIATION")
		'
		'      'DATO IMPORTANTE
		''      strSQL = "SELECT GO_NAME FROM cw_inter_object " _
		'''               & "WHERE model_name = '" & strModelo & "'" _
		'''               & "AND ano_id_below = " & rstTram("GO_ID") _
		'''               & "AND ano_id_above= " & gNomProcCorto
		'      strSQL = "SELECT A.AT_ID AT_ID " & _
		''               "FROM CW_INTER_OBJECT IO, " & _
		''                    "ENTITY E, " & _
		''                    "ATTRIBUTE A " & _
		''               "WHERE IO.MODEL_NAME = '" & strModelo & "' " & _
		''                 "AND E.MODEL_NAME = '" & strModelo & "' " & _
		''                 "AND A.MODEL_NAME = '" & strModelo & "' " & _
		''                 "AND A.EN_ID = E.EN_ID " & _
		''                 "AND IO.ANO_ID_BELOW = " & rstTram("GO_ID") & " " & _
		''                 "AND IO.GO_NAME <> '' " & _
		''                 "AND SUBSTRING(IO.GO_NAME, CHARINDEX('(', IO.GO_NAME) + 1, CHARINDEX(')', IO.GO_NAME) - CHARINDEX('(', IO.GO_NAME) - 1) = E.EN_NAME " & _
		''                 "AND SUBSTRING(IO.GO_NAME, 1, CHARINDEX('(', IO.GO_NAME) - 2) = A.AT_NAME"
		'      Set rstDatoImp = mfRecordset(conDP4, strSQL)
		'      If Not rstDatoImp.EOF Then
		'            strSQL = "SELECT CODHIDRA FROM VARIABLES WHERE IDATRIBU=" & rstDatoImp("AT_ID")
		'            Set rstInfra = mfRecordset(conInfra, strSQL)
		'            If Not rstInfra.EOF Then
		'                arrRetorno(2) = rstInfra("CODHIDRA")
		'            End If
		'      End If
		'   Else
		'buscarpadre:
		'      'sino, buscar el objeto padre del objeto Trámite tratado
		'      strSQL = strSQLBase & " AND C.DI_ID = " & idPadre _
		''            & " AND C.SH_SEQ = " & numSeq
		'      Set rstTram = mfRecordset(conDP4, strSQL)
		'      If Not rstTram.EOF Then
		'         strCodFase = obj.fBuscaDatoXML(rstTram(cCampoUSERDEFINED), cstrEtiquetaFase, cTipoDatoPropTexto)
		'         strCodSubFase = obj.fBuscaDatoXML(rstTram(cCampoUSERDEFINED), cstrEtiquetaSubFase, cTipoDatoPropTexto)
		'
		'         'FASE
		'         strSQL = "SELECT LU_NAME, LU_ABBREVIATION From cw_lookup Where LU_ID = '" & strCodFase & "'"
		'         Set rstFase = mfRecordset(conDP4, strSQL)
		'         If Not rstFase.EOF Then arrRetorno(0) = rstFase("LU_ABBREVIATION")
		'
		'         'SUBFASE
		'         strSQL = "SELECT LU_NAME, LU_ABBREVIATION From cw_lookup Where LU_ID = '" & strCodSubFase & "'"
		'         Set rstSubFase = mfRecordset(conDP4, strSQL)
		'         If Not rstSubFase.EOF Then arrRetorno(1) = rstSubFase("LU_ABBREVIATION")
		'
		'         'DATO IMPORTANTE
		''         strSQL = "SELECT GO_NAME FROM cw_inter_object" _
		'''                  & " WHERE model_name = '" & strModelo & "'" _
		'''                  & " AND ano_id_below = " & rstTram("GO_ID") _
		'''                  & " AND ano_id_above = " & gNomProcCorto
		'         strSQL = "SELECT A.AT_ID AT_ID" _
		''                  & " FROM CW_INTER_OBJECT IO, ENTITY E, ATTRIBUTE A" _
		''                  & " WHERE IO.MODEL_NAME = '" & strModelo & "'" _
		''                  & " AND E.MODEL_NAME = '" & strModelo & "'" _
		''                  & " AND A.MODEL_NAME = '" & strModelo & "'" _
		''                  & " AND A.EN_ID = E.EN_ID" _
		''                  & " AND IO.ANO_ID_BELOW = " & rstTram("GO_ID") _
		''                  & " AND SUBSTRING(IO.GO_NAME, CHARINDEX('(', IO.GO_NAME)+1, CHARINDEX(')', IO.GO_NAME)-CHARINDEX('(', IO.GO_NAME)-1) = E.EN_NAME" _
		''                  & " AND SUBSTRING(IO.GO_NAME, 1, CHARINDEX('(', IO.GO_NAME)-2) = A.AT_NAME"
		'         Set rstDatoImp = mfRecordset(conDP4, strSQL)
		'         If Not rstDatoImp.EOF Then
		'               strSQL = "SELECT CODHIDRA FROM VARIABLES WHERE IDATRIBU=" & rstDatoImp("AT_ID")
		'               Set rstInfra = mfRecordset(conInfra, strSQL)
		'               If Not rstInfra.EOF Then
		'                   arrRetorno(2) = rstInfra("CODHIDRA")
		'               End If
		'         End If
		'      Else
		'
		'         'Si no devuelve datos, hay que buscar el trámite anterior
		'         If orden5 > 0 Then
		'            strSQL = "SELECT CODFASE, " & _
		''                            "CODSFASE, " & _
		''                            "DATFASUB " & _
		''                     "FROM DIAGRAMA " & _
		''                     "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                       "AND ORDEN_N1 = " & orden1 & " " & _
		''                       "AND ORDEN_N2 = " & orden2 & " " & _
		''                       "AND ORDEN_N3 = " & orden3 & " " & _
		''                       "AND ORDEN_N4 = " & orden4 & " " & _
		''                       "AND ORDEN_N5 = " & orden5 - 1
		'         ElseIf orden4 > 0 Then
		'            strSQL = "SELECT CODFASE, " & _
		''                            "CODSFASE, " & _
		''                            "DATFASUB " & _
		''                     "FROM DIAGRAMA " & _
		''                     "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                       "AND ORDEN_N1 = " & orden1 & " " & _
		''                       "AND ORDEN_N2 = " & orden2 & " " & _
		''                       "AND ORDEN_N3 = " & orden3 & " " & _
		''                       "AND ORDEN_N4 = " & orden4 - 1
		'         ElseIf orden3 > 0 Then
		'            strSQL = "SELECT CODFASE, " & _
		''                            "CODSFASE, " & _
		''                            "DATFASUB " & _
		''                     "FROM DIAGRAMA " & _
		''                     "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                       "AND ORDEN_N1 = " & orden1 & " " & _
		''                       "AND ORDEN_N2 = " & orden2 & " " & _
		''                       "AND ORDEN_N3 = " & orden3 - 1
		'         ElseIf orden2 > 0 Then
		'            strSQL = "SELECT CODFASE, " & _
		''                            "CODSFASE, " & _
		''                            "DATFASUB " & _
		''                     "FROM DIAGRAMA " & _
		''                     "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                       "AND ORDEN_N1 = " & orden1 & " " & _
		''                       "AND ORDEN_N2 = " & orden2 - 1
		'         ElseIf orden1 > 1 Then
		'            strSQL = "SELECT CODFASE, " & _
		''                            "CODSFASE, " & _
		''                            "DATFASUB " & _
		''                     "FROM DIAGRAMA " & _
		''                     "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
		''                       "AND ORDEN_N1 = " & orden1 - 1
		'         Else
		'            'No hay diagrama de Fase/Subfase dibujado
		'            mfFaseSubfase = arrRetorno
		'            GoTo procFin
		'         End If
		'
		'         'Se cogen los valores de Fase, Subfase y Dato Importante del trámite anterior
		'         Set rstDiag = mfRecordset(conPasarela, strSQL)
		'         If Not rstDiag.EOF Then
		'            arrRetorno(0) = Trim(rstDiag("CODFASE"))
		'            arrRetorno(1) = Trim(rstDiag("CODSFASE"))
		'            arrRetorno(2) = Trim(rstDiag("DATFASUB"))
		'         Else
		'            'ERROR!!!
		'            GoTo procErr
		'         End If
		'
		'      End If
		'   End If
		'
		'   mfFaseSubfase = arrRetorno
		'   GoTo procFin
		
ERR_mfFaseSubfase: 
		If blnCancelar = True Then
			Exit Function
		End If
		If blnParar = True Then
			Exit Function
		End If
		If strError = vbNullString Then
			strError = Err.Description
		End If
		logError("mfFaseSubfase - " & strError)
		Insertar_Error(Me, "Lectura de Fases/Subfases", "Ha ocurrido un error no controlado", "mfFaseSubfase" & " -" & strSeg)
		
		Mostrar_Error()
		Resume mfFaseSubfase
		
mfFaseSubfase: 
		CierraRS(rstFaseSubfaseRamificacion)
		'UPGRADE_NOTE: Object rstFaseSubfaseRamificacion may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstFaseSubfaseRamificacion = Nothing
		CierraRS(rstObjetosFaseSubfase)
		'UPGRADE_NOTE: Object rstObjetosFaseSubfase may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstObjetosFaseSubfase = Nothing
		CierraRS(rstFase)
		'UPGRADE_NOTE: Object rstFase may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstFase = Nothing
		CierraRS(rstSubFase)
		'UPGRADE_NOTE: Object rstSubFase may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstSubFase = Nothing
		CierraRS(rstDatoImp)
		'UPGRADE_NOTE: Object rstDatoImp may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstDatoImp = Nothing
	End Function
	'Fin MU88 - Gestión de Fases/Subfases
	'
	'
	
	Private Sub msUnRamPa(ByVal rstTram As ADODB.Recordset)
		On Error GoTo procErr
		Dim strSQL As String
		Dim rst As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim blnPrim As Boolean
		Dim strIns As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim strPath As String
		
		strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI "
		strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngORACC = Val(rstAux.Fields(0).Value & "") + 1
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITMOMENTANEO'"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
		strPath = "WAITMOMENTANEO" & VB6.Format(lngNumAcc, "00")
		strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,TIPO_ACCION, PATH_HIDRA) VALUES "
		strSQL = strSQL & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
		strSQL = strSQL & "'WAITMOMENTANEO'," & lngNumAcc & "," & "'G','" & strPath & "')"
		mfExecute(conPasarela, strSQL)
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		logError("msUnidRamPa - " & Err.Description)
		Insertar_Error(Me, "Unión de Ramas Paralelas", "Ha ocurrido un error no controlado", "msUnRamPa")
		Mostrar_Error()
		Resume procFin
		
procFin: 
		
	End Sub
	
	Private Sub msPlazT1(ByRef rstTram As ADODB.Recordset, ByRef strPlazo As String, ByRef nombreTram As String, ByVal blnIndVar As Boolean)
		On Error GoTo procErr
		Dim strSQL As String
		Dim rst As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamHN As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim blnPrim As Boolean
		Dim strIns As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim strPath As String
		Dim strPath2 As String
		Dim strPathAL As String
		Dim strJOINER As String
		Dim lngOr1 As Integer
		Dim lngOr2 As Integer
		Dim lngOr3 As Integer
		Dim lngOr4 As Integer
		Dim lngOr5 As Integer
		Dim lngOrP2 As Integer
		Dim lngOrP3 As Integer
		Dim lngOrP4 As Integer
		Dim lngOrP5 As Integer
		Dim nomVarHN As String
		Dim colAux As Collection
		Dim colXMLD As Collection
		Dim strNomTram As String
		Dim lngF As Integer
		Dim lngNext As Integer
		Dim ATID As Integer
		Dim ATNAME As String
		Dim lngHasta As Integer
		
		Dim strPathIF As String
		
		
		System.Windows.Forms.Application.DoEvents()
		'Conector Fin de Plazo tipo 1
		strSQL = "SELECT DISTINCT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND CAT_CONECTOR='Fin de plazo 1'"
		rst = mfRecordset(conPasarela, strSQL)
		If rst.RecordCount > 1 Then
			strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
			rst = mfRecordset(conPasarela, strSQL)
		End If
		System.Windows.Forms.Application.DoEvents()
		If rst.EOF Then
			Insertar_Error(Me, "Lectura de Trámite/Ramificación", "No se encuentra el conector con categoría Fin de Plazo 1 en " & nombreTram, "msPlazT1")
			Mostrar_Error()
			Exit Sub
		End If
		System.Windows.Forms.Application.DoEvents()
		
		'Se obtiene el ID del conector
		While Not rst.EOF
			lngHasta = rst.Fields("NUM_SEC_HASTA").Value
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "Where J.JO_SEQ=" & rst.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rst.Fields("NUM_SEC_DESDE").Value & " AND SH_SEQ_TO=" & rst.Fields("NUM_SEC_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rst.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				System.Windows.Forms.Application.DoEvents()
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			System.Windows.Forms.Application.DoEvents()
			rst.MoveNext()
		End While
		System.Windows.Forms.Application.DoEvents()
		
		'Se obtiene el uso de datos del conector Fin Plazo tipo 1
		If strJOINER <> "" Then
			System.Windows.Forms.Application.DoEvents()
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & "Where C.CO_ID IN (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL)
			If Not rstParamCMS.EOF Then
				ATID = rstParamCMS.Fields("AT_ID").Value
				ATNAME = rstParamCMS.Fields("AT_NAME").Value
			Else
				ATID = 0
				ATNAME = ""
			End If
		Else
			Insertar_Error(Me, "Lectura de Trámite/Ramificación", "No se encuentra la variable en el conector Fin de Plazo 1", "msPlazT1")
			Mostrar_Error()
			Exit Sub
		End If
		System.Windows.Forms.Application.DoEvents()
		
		'Se obtiene el número de orden de la acción
		If rstTram.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
			If rstTram.Fields("ORDEN_N2").Value = 0 Then
				System.Windows.Forms.Application.DoEvents()
				lngOr2 = 1
			Else
				lngOr2 = rstTram.Fields("ORDEN_N2").Value
				If rstTram.Fields("ORDEN_N3").Value = 0 Then
					System.Windows.Forms.Application.DoEvents()
					lngOr3 = 1
				Else
					lngOr3 = rstTram.Fields("ORDEN_N2").Value
					If rstTram.Fields("ORDEN_N4").Value = 0 Then
						System.Windows.Forms.Application.DoEvents()
						lngOr4 = 1
					Else
						lngOr4 = rstTram.Fields("ORDEN_N2").Value
						If rstTram.Fields("ORDEN_N5").Value = 0 Then
							System.Windows.Forms.Application.DoEvents()
							lngOr5 = 1
						Else
							System.Windows.Forms.Application.DoEvents()
							lngOr2 = rstTram.Fields("ORDEN_N2").Value
						End If
					End If
				End If
			End If
		Else
			lngOr2 = rstTram.Fields("ORDEN_N2").Value
			lngOr3 = rstTram.Fields("ORDEN_N3").Value
			lngOr4 = rstTram.Fields("ORDEN_N4").Value
			lngOr5 = rstTram.Fields("ORDEN_N5").Value
		End If
		
		'Se actualiza el INDJUMP y el INDCANCEL del registro de la tabla Diagrama
		strSQL = "UPDATE DIAGRAMA SET INDJUMP='S' "
		strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
		mfExecute(conPasarela, strSQL)
		strSQL = "UPDATE DIAGRAMA SET INDCANCEL='P' "
		strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3=" & lngOr3 & " AND ORDEN_N4=" & lngOr4 & " AND ORDEN_N5=" & lngOr5
		mfExecute(conPasarela, strSQL)
		
		'Se busca el la acción con mayor id del trámite
		strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI "
		strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3=" & lngOr3 & " AND ORDEN_N4=" & lngOr4 & " AND ORDEN_N5=" & lngOr5 & " AND ORDEN_ACC<>999"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngORACC = Val(rstAux.Fields(0).Value & "") + 1
		
		'Se cuentan las acciones CREARALERTA del procedimiento para saber cuál es la siguiente
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI "
		strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CREARALERTA'"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
		
		strPath = "APE_CREARALERTA" & VB6.Format(lngNumAcc, "00")
		
		'Se busca la acción CREARALERTA en la tabla acciones de la aplicación para obtener su INDTIPOA
		strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN='CREARALERTA'"
		rstAux = mfRecordset(conInfra, strSQL)
		
		'APE_CREARALERTA
		mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, rstAux.Fields("IDACCION").Value, "CREARALERTA", lngNumAcc, rstAux.Fields("INDTIPOA").Value, strPath, 0, 0, "", "S", "")
		'mfInserta_ACCIONES rstTram("ORDEN_N1"), lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, rstAux("IDACCION"), "CREARALERTA", lngNumAcc, rstAux("INDTIPOA"), strPathIF, 0, 0, "", "S", ""
		strSQL = "SELECT FlowOrder From wfFlowActions "
		strSQL = strSQL & "WHERE (RTRIM(Flow)='CREARALERTA') AND (RTRIM(Action) = 'LABEL') ORDER BY FLOWORDER"
		rstAux2 = mfRecordset(conGestion, strSQL)
		If Not rstAux.EOF Then
			lngF = rstAux2.Fields("FLOWORDER").Value
			strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='CREARALERTA' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
			rstparamHN = mfRecordset(conGestion, strSQL)
		End If
		blnInserta = True
		'Parámetro CODPLAZO
		If blnIndVar = True Then
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		Else
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strPlazo, rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		End If
		'Parámetro FECHA
		rstparamHN.MoveNext()
		'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		nomVarHN = mfInsertaVariables(ATID, ATNAME)
		msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		'Parámetro TIPO
		rstparamHN.MoveNext()
		msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "1", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		'Parámetro NUMDIAS
		rstparamHN.MoveNext()
		If blnIndVar = True Then
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strPlazo, rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, True)
		Else
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		End If
		'Parámetro TIPODIAS
		rstparamHN.MoveNext()
		colAux = New Collection
		colAux.Add("Naturaleza Plazo")
		'UPGRADE_NOTE: Object colXMLD may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		colXMLD = Nothing
		colXMLD = New Collection
		colXMLD = mfBuscaXML("Proceso", colAux, rstTram.Fields("ID_DIAGRAMA").Value, False)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1)), rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		
		'EDP_CREARALERTA
		lngORACC = lngORACC + 1
		strPath = "EDP_CREARALERTA" & VB6.Format(lngNumAcc, "00")
		
		mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, 0, "ENDPROC", lngNumAcc, "", strPath, 0, 0, "", "S", "")
		
		'PRO_CREARALERTA
		lngORACC = lngORACC + 1
		strPath2 = "PRO_CREARALERTA" & VB6.Format(lngNumAcc, "00")
		mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, 0, "PROCESS", lngNumAcc, "", strPath2, 0, 0, "", "S", "")
		
		'Apuntar el PATHRETORNO del APE_CREARALERTA al PRO_CREARALERTA
		strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath2 & "' "
		strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3=" & lngOr3 & " AND ORDEN_N4=" & lngOr4 & " AND ORDEN_N5=" & lngOr5 & " AND ORDEN_ACC=" & lngORACC - 2
		mfExecute(conPasarela, strSQL)
		
		'IF_CREARALERTA, que evalúa si la alerta está caducada
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PATH_HIDRA LIKE 'IF_CREARALERTA%'"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
		
		strPathIF = "IF_CREARALERTA" & VB6.Format(lngNumAcc, "00")
		
		lngORACC = lngORACC + 1
		strPathAL = "IF_CREARALERTA" & VB6.Format(lngNumAcc, "00")
		'Insertar acción IF_CREARALERTA
		'mfInserta_ACCIONES rstTram("ORDEN_N1"), lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, 0, "IF", lngNumAcc, "", strPathAL, 0, 0, "", "S", ""
		mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, 0, "IF", lngNumAcc, "", strPathIF, 0, 0, "", "S", "")
		'Insertar parámetro de la acción:
		'Parámetro VAR1
		'msInsertaParamAcc "VAR1", "@PRO_CREARALERTA" & Format(lngNumAcc, "00") & "!ALERTACADUCADA", rstTram("ORDEN_N1"), lngOr2, lngOr3, lngOr4, lngOr5, lngORACC
		msInsertaParamAcc("VAR1", "@IF_CREARALERTA" & VB6.Format(lngNumAcc, "00") & "!ALERTACADUCADA", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		'Parámetro VAR2
		msInsertaParamAcc("VAR2", "S", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		'Parámetro CONDITION
		msInsertaParamAcc("CONDITION", "=", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		'Parámetro PATH
		msInsertaParamAcc("PATH", "", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		'Parámetro ELSEPATH
		msInsertaParamAcc("ELSEPATH", "ALRT ALERTA" & VB6.Format(lngNumAcc, "00"), rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		'Parámetro TYPE
		msInsertaParamAcc("TYPE", "STRING", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		
		'ALRT ALERTA
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='ALERT'"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
		
		lngORACC = lngORACC + 1
		strPathAL = "ALRT ALERTA" & VB6.Format(lngNumAcc, "00")
		mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, 0, "ALERT", lngNumAcc, "", strPathAL, 0, 0, "", "S", "")
		rst.MoveFirst()
		'Parámetro DATE
		'msInsertaParamAcc "DATE", "@" & strPath2 & "!FCADUCIDAD", rstTram("ORDEN_N1"), lngOr2, lngOr3, lngOr4, lngOr5, lngORACC
		msInsertaParamAcc("DATE", "@" & strPathIF & "!FCADUCIDAD", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		
		'Parámetro ALERTPATH
		msInsertaParamAcc("ALERTPATH", "", rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
		
		'METOCADUCAR
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='METOCADUCAR'"
		System.Windows.Forms.Application.DoEvents()
		rstAux = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
		
		lngORACC = lngORACC + 1
		strPathAL = "METOCADUCAR" & VB6.Format(lngNumAcc, "00")
		mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC, 0, "METOCADUCAR", lngNumAcc, "", strPathAL, 0, 0, "", "S", "")
		
		strSQL = "SELECT * FROM CONECTORES_DI "
		strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND CAT_CONECTOR NOT IN ('Fin de plazo 1','Conector Opcional') and NUM_SEC_HASTA <> " & rstTram.Fields("NUM_SEQ").Value & " AND NUM_SEC_HASTA <> " & lngHasta
		
		'A dónde apunta el conector para saber a dónde apunta
		rst = mfRecordset(conPasarela, strSQL)
		If Not rst.EOF Then
			If rst.Fields("ORDEN_N1").Value <> 0 Then
				strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
				rst = mfRecordset(conPasarela, strSQL)
			End If
		End If
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CREARALERTA'"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
		
		While Not rst.EOF
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and NUM_SEQ=" & rst.Fields("NUM_SEC_HASTA").Value & " And ID_PADRE=" & rst.Fields("DIAGRAMA").Value
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				If rstAux.RecordCount > 1 Then
					strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
					rstAux = mfRecordset(conPasarela, strSQL)
				End If
			End If
			If Not rstAux.EOF Then
				lngOr1 = rstAux.Fields("ORDEN_N1").Value
				If rstAux.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
					If rstAux.Fields("ORDEN_N2").Value = 0 Then
						lngOr2 = 1
					Else
						lngOr2 = rstAux.Fields("ORDEN_N2").Value
						If rstAux.Fields("ORDEN_N3").Value = 0 Then
							lngOr3 = 1
						Else
							lngOr3 = rstAux.Fields("ORDEN_N2").Value
							If rstAux.Fields("ORDEN_N4").Value = 0 Then
								lngOr4 = 1
							Else
								lngOr4 = rstAux.Fields("ORDEN_N2").Value
								If rstAux.Fields("ORDEN_N5").Value = 0 Then
									lngOr5 = 1
								Else
									lngOr2 = rstAux.Fields("ORDEN_N2").Value
								End If
							End If
						End If
					End If
				Else
					lngOr2 = rstAux.Fields("ORDEN_N2").Value
					lngOr3 = rstAux.Fields("ORDEN_N3").Value
					lngOr4 = rstAux.Fields("ORDEN_N4").Value
					lngOr5 = rstAux.Fields("ORDEN_N5").Value
				End If
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstAcc = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=999"
				rstAux3 = mfRecordset(conPasarela, strSQL)
				If rstAux3.EOF Then
					mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, 999, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
					blnInserta = False
					msInsertaParamAcc("PATH", rstAux.Fields("ORDEN_N1").Value & ";" & lngOr2 & ";" & lngOr3 & ";" & lngOr4 & ";" & lngOr5, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, 999)
				End If
			Else
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstAcc = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, 999, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, 999)
			End If
			rst.MoveNext()
		End While
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Fin de Plazo 1", "Ha ocurrido un error no controlado", "msPlazT1")
		Mostrar_Error()
		logError("msPlazT1 - " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	
	
	Private Sub msLecAccTram()
		On Error GoTo procErr
		Dim rstTram As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim strSQL As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim strPath As String
		Dim arr As Object
		Dim arr2 As Object
		Dim I As Object
		Dim j As Integer
		'## DS66 10/11/09
		Dim NumId As Integer
		'##
		
		'UPGRADE_WARNING: Couldn't resolve default property of object Me.pgbProceso.Value. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Me.pgbProceso.Value = 0
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND EXPLOTA_ACC='S' AND ID_DIAGRAMA IN (SELECT CODTRAAD FROM TBPFIN03_PA) ORDER BY ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5"
		rstTram = mfRecordset(conPasarela, strSQL)
		If rstTram.EOF = False Then
			'UPGRADE_WARNING: Couldn't resolve default property of object rstTram.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstTram.GetRows
			System.Windows.Forms.Application.DoEvents()
			rstTram.MoveFirst()
		End If
		'UPGRADE_WARNING: Couldn't resolve default property of object I. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		I = 1
		While Not rstTram.EOF
			strSeg = rstTram.Fields("ORDEN_N1").Value & "/" & rstTram.Fields("ORDEN_N2").Value & "/" & rstTram.Fields("ORDEN_N3").Value & "/" & rstTram.Fields("ORDEN_N4").Value & "/" & rstTram.Fields("ORDEN_N5").Value
			If rstTram.Fields("ORDEN_n1").Value = 4 Then
				System.Windows.Forms.Application.DoEvents()
			End If
			strSQL = "Select A.PR_ID, D.SH_SEQ, A.PR_NAME, C.LU_NAME, A.PR_ALT_NAME, D.DI_ID "
			strSQL = strSQL & "From PROCESS A, CW_PROP_TYPE B, CW_LOOKUP C, SHAPE D, DIAGRAM E "
			strSQL = strSQL & "Where A.PR_TYPE = C.LU_ID and D.ANO_ID = A.PR_ID and B.PPT_ID = C.PPT_ID and B.PPT_FIELD_NAME = 'PR_TYPE' and "
			strSQL = strSQL & "C.LU_NAME  <>'Inicio Automático Expediente'  and D.ANO_TABNR = 8953 and  E.ANO_TABNR = 8953 and D.ANO_ID <> E.ANO_ID and E.DI_ID = D.DI_ID and E.DI_TYPE <> 1 and "
			strSQL = strSQL & "E.ANO_ID = " & rstTram.Fields("ID_DIAGRAMA").Value
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'## DS66  05/06/09  Filtro para que no lea los conectores de la parte de "Trámite Usuario" "Pru"
			strSQL = strSQL & " AND E.DI_TYPE not in (SELECT LU_ID FROM CW_LOOKUP where model_name ='" & strModelo & "' and lu_abbreviation='TRU')"
			'##
			strSQL = strSQL & " Order by SH_Y desc, SH_X asc"
			rstAcc = mfRecordset(conDP4, strSQL)
			If rstAcc.EOF = False Then
				'## DS66 10/11/09
				NumId = rstAcc.Fields("DI_ID").Value
				'##
				'UPGRADE_WARNING: Couldn't resolve default property of object rstAcc.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arr2. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				arr2 = rstAcc.GetRows
				System.Windows.Forms.Application.DoEvents()
				rstAcc.MoveFirst()
			End If
			j = 1
			While Not rstAcc.EOF
				'## DS66 10/11/09
				If rstAcc.Fields("DI_ID").Value = NumId Then 'Se colaban registros con diferentes DI_ID
					'##
					lblMensaje.Text = "Introduciendo ACCIONES en PASARELA"
					'UPGRADE_WARNING: Couldn't resolve default property of object I. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					msProceso(j, UBound(arr2, 2) + 1, I, UBound(arr, 2) + 1)
					If Trim(rstAcc.Fields("PR_ALT_NAME").Value) = "Proceso Falso" Then
						strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI "
						strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
						rstAux = mfRecordset(conPasarela, strSQL)
						lngORACC = Val(rstAux.Fields(0).Value & "") + 1
						strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_ACCION=0"
						rstAux = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
						mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "PROCESOFALSO", lngNumAcc, "", strPath, rstAcc.Fields("SH_SEQ").Value, rstAcc.Fields("DI_ID").Value, "", "S", Trim(rstAcc.Fields("PR_ALT_NAME").Value))
						GoTo siguiente
					End If
vueltaatras: 
					strSQL = "SELECT * FROM ACCIONES WHERE IDACCION= '" & rstAcc.Fields("PR_ID").Value & "'"
					rstProp = mfRecordset(conInfra, strSQL)
					If Not rstProp.EOF Then
						
						'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
						If rstProp.Fields("INDTIPOA").Value = "" Or IsDbNull(rstProp.Fields("INDTIPOA").Value) = True Then
							SolucionarINDTIPOA(rstAcc)
							rstProp.Requery()
						End If
						strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI "
						strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
						rstAux = mfRecordset(conPasarela, strSQL)
						lngORACC = Val(rstAux.Fields(0).Value & "") + 1
						strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_ACCION=" & rstAcc.Fields("PR_ID").Value
						rstAux = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
						strPath = IIf(rstProp.Fields("DESACCHN").Value <> "LET INICIALIZACIONVAR", "APE_", "") & Trim(Mid(rstProp.Fields("DESACCHN").Value, 1, 19)) & VB6.Format(lngNumAcc, "00")
						mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, rstAcc.Fields("PR_ID").Value, Trim(rstProp.Fields("DESACCHN").Value), lngNumAcc, rstProp.Fields("INDTIPOA").Value, strPath, rstAcc.Fields("SH_SEQ").Value, rstAcc.Fields("DI_ID").Value, "", "S", Mid(Trim(rstAcc.Fields("PR_ALT_NAME").Value), 1, 255))
						If rstProp.Fields("DESACCHN").Value <> "LET INICIALIZACIONVAR" Then
							strPath = "EDP_" & Trim(Mid(rstProp.Fields("DESACCHN").Value, 1, 19)) & VB6.Format(lngNumAcc, "00")
							lngORACC = lngORACC + 1
							mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "ENDPROC", lngNumAcc, rstProp.Fields("INDTIPOA").Value, strPath, 0, 0, "", "S", "")
							strPath = "PRO_" & Trim(Mid(rstProp.Fields("DESACCHN").Value, 1, 19)) & VB6.Format(lngNumAcc, "00")
							lngORACC = lngORACC + 1
							mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "PROCESS", lngNumAcc, rstProp.Fields("INDTIPOA").Value, strPath, 0, 0, "", "S", "")
						End If
					Else
						'CrearAccion rstAcc
						If CrearAccion(rstAcc) = True Then
							GoTo vueltaatras
						End If
					End If
					
					rstProp.Close()
siguiente: 
					
					rstAcc.MoveNext()
					j = j + 1
					'## DS66 10/11/09
				Else
					rstAcc.MoveNext()
				End If
				'##
			End While
			rstTram.MoveNext()
			'UPGRADE_WARNING: Couldn't resolve default property of object I. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			I = I + 1
		End While
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Lectura de acciones de trámite", "Ha ocurrido un error no controlado", "msLecAccTram" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msLecAccTram - " & Err.Description)
		Resume procFin
procFin: 
		
		
	End Sub
	
	
	Public Function mfBuscaXML(ByVal objeto As String, ByVal propiedad As Collection, ByVal Id As Integer, Optional ByRef lista As Boolean = False, Optional ByRef abrev As Boolean = False) As Collection
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstXML As ADODB.Recordset
		Dim rstObj As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim strXML As String
		Dim strCadenaXML As String
		Dim intDesde As Integer
		Dim intHasta As Integer
		Dim icol As Object
		Dim strValor As String
		Dim rstLU As ADODB.Recordset
		Dim blnPrim As Boolean
		Dim intD As Short
		Dim intH As Short
		
		blnPrim = False
		mfBuscaXML = New Collection
		For	Each icol In propiedad
			'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If icol = "Categoría" And objeto = "Conector" Then
				strSQL = "SELECT CW_LOOKUP.LU_NAME From CW_LOOKUP, CONNECTOR, JOINER, CW_PROP_TYPE "
				strSQL = strSQL & " Where JOINER.ANO_ID = CONNECTOR.CO_ID and CW_LOOKUP.LU_ID = CONNECTOR.CO_TYPE and CW_LOOKUP.PPT_ID = CW_PROP_TYPE.PPT_ID and "
				'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & " CW_PROP_TYPE.OT_ID=9225 AND JOINER.ANO_TABNR=9225 AND JOINER.ANO_ID=" & Id & " and CW_PROP_TYPE.PPT_NAME = '" & icol & "'"
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND CW_LOOKUP.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND CONNECTOR.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND JOINER.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND CW_PROP_TYPE.MODEL_NAME ='" & strModelo & "'"
				
				rstXML = mfRecordset(conDP4, strSQL)
				
				If Not rstXML.EOF Then
					strValor = Trim(CStr(rstXML.Fields("LU_NAME").Value))
					If InStr(1, strValor, "CDATA") Then
						intD = InStrRev(strValor, "[")
						intH = InStr(strValor, "]")
						strValor = Mid(strValor, intD + 1, intH - 1 - intD)
					End If
					mfBuscaXML.Add(strValor)
				Else
					mfBuscaXML.Add("")
				End If
			Else
				strSQL = "Select D.OT_ID, D.OT_TABLE_NAME, A.PPT_UUID, A.PPT_ID, A.PPT_SCRPT_NAME "
				strSQL = strSQL & " From CW_PROP_TYPE A, CW_OBJECT_TYPE D"
				strSQL = strSQL & " Where D.OT_NAME = '" & objeto & "' AND A.OT_ID=D.OT_ID "
				'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & " AND A.PPT_NAME='" & icol & "'"
				' NUEVOOOOOOO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				rstProp = mfRecordset(conDP4, strSQL)
				If rstProp.EOF Then
					mfBuscaXML.Add("")
				Else
					'strXML = ""
					'strXML = "x" & CStr(rstProp("PPT_UUID"))
					'If blnPrim Then
					If objeto = "Procedimiento" Then 'Procedimiento
						strSQL = "Select USERDEFINED From CW_OBJECT "
						strSQL = strSQL & " Where OT_ID='" & rstProp.Fields("OT_ID").Value & "'"
						strSQL = strSQL & " And GO_ID=" & Id
					Else
						strSQL = "SELECT USERDEFINED FROM " & rstProp.Fields("OT_TABLE_NAME").Value
						strSQL = strSQL & " WHERE "
						Select Case rstProp.Fields("OT_TABLE_NAME").Value
							Case "PROCESS"
								strSQL = strSQL & "PR_ID"
							Case "CONNECTOR"
								strSQL = strSQL & "CO_ID"
							Case "ATTRIBUTE"
								strSQL = strSQL & "AT_ID"
							Case "ORGANIZATION"
								strSQL = strSQL & "OU_ID"
							Case Else
								strSQL = strSQL & "OT_ID"
						End Select
						strSQL = strSQL & "=" & Id
					End If
					
					' **** NUEVO SD ENERO'08
					' SEA LA SQL QUE SEA HAYQ UE AÑADIRLE EL MODEL NAME
					strSQL = strSQL & " AND MODEL_NAME ='" & strModelo & "'"
					
					rstXML = mfRecordset(conDP4, strSQL)
					If Not rstXML.EOF Then
						strCadenaXML = rstXML.Fields("USERDEFINED").Value
						'Busco el valor de la propiedad en XML
						If InStr(1, strCadenaXML, rstProp.Fields("PPT_SCRPT_NAME").Value) > 0 Then
							intDesde = InStr(1, strCadenaXML, "scriptname=""" & rstProp.Fields("PPT_SCRPT_NAME").Value) + Len("scriptname=""" & rstProp.Fields("PPT_SCRPT_NAME").Value) + 1
							intHasta = InStr(intDesde, strCadenaXML, "</")
							strValor = Mid(strCadenaXML, intDesde + 1, intHasta - (intDesde + 1))
							If lista = False Then
								If InStr(1, strValor, "CDATA") Then
									intD = InStrRev(strValor, "[")
									intH = InStr(strValor, "]")
									strValor = Mid(strValor, intD + 1, intH - 1 - intD)
								End If
								strValor = Replace(strValor, "&#x20;", Space(1))
								strValor = Replace(strValor, "&lt;", "<")
								strValor = Replace(strValor, "&gt;", ">")
								mfBuscaXML.Add(strValor)
							Else
								strSQL = "SELECT LU_NAME, LU_ABBREVIATION From cw_lookup Where LU_ID = '" & strValor & "'"
								' **** NUEVO SD ENERO'08
								strSQL = strSQL & " AND MODEL_NAME ='" & strModelo & "'"
								rstLU = mfRecordset(conDP4, strSQL)
								If Not rstLU.EOF Then
									If abrev = True Then
										strValor = Trim(CStr(rstLU.Fields("LU_ABBREVIATION").Value))
										If InStr(1, strValor, "CDATA") Then
											intD = InStrRev(strValor, "[")
											intH = InStr(strValor, "]")
											strValor = Mid(strValor, intD + 1, intH - 1 - intD)
										End If
										strValor = Replace(strValor, "&lt;", "<")
										strValor = Replace(strValor, "&gt;", ">")
										mfBuscaXML.Add(strValor)
									Else
										strValor = Trim(CStr(rstLU.Fields("LU_NAME").Value))
										If InStr(1, strValor, "CDATA") Then
											intD = InStrRev(strValor, "[")
											intH = InStr(strValor, "]")
											strValor = Mid(strValor, intD + 1, intH - 1 - intD)
										End If
										strValor = Replace(strValor, "&lt;", "<")
										strValor = Replace(strValor, "&gt;", ">")
										mfBuscaXML.Add(strValor)
									End If
								Else
									mfBuscaXML.Add("")
								End If
							End If
						Else
							mfBuscaXML.Add("")
						End If
					Else
						mfBuscaXML.Add("")
					End If
					'End If
				End If
			End If
		Next icol
		
		GoTo procFin
procErr: 
		
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		'aketza errores
		Insertar_Error(Me, "Lectura de XML", "Ha ocurrido un error no controlado", "msBuscaXML")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("mfBuscaXML - " & Err.Description)
		Resume procFin
procFin: 
	End Function
	
	
	Private Function mfInsertaVariables(ByVal lngID As Integer, Optional ByRef strNOM As String = "", Optional ByRef Alta As Boolean = False, Optional ByRef Proc As String = "", Optional ByRef OrdenAlta As Integer = 0) As Object
		
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rstInfra As ADODB.Recordset
		Dim rstPasa As ADODB.Recordset
		Dim arrvar As Object
		Dim maxPasa As Integer
		Dim maxInfra As Integer
		Dim strValor As String
		Dim rstEntidad As ADODB.Recordset
		Dim strEntidad As String
		Dim strDescrip As String
		
		Dim strNomTot As String
		If lngID = 70 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		strNOM = Trim(Replace(strNOM, "'", "''"))
		strSQL = "SELECT * FROM VARIABLES WHERE IDATRIBU=" & lngID
		rstInfra = mfRecordset(conInfra, strSQL)
		
		strSQL = "SELECT E.EN_NAME, E.EN_DESCRIPTION, A.AT_DESCRIPTION  FROM ATTRIBUTE A, ENTITY E "
		strSQL = strSQL & " WHERE A.AT_ID=" & lngID & " and A.EN_ID=E.EN_ID"
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		rstEntidad = mfRecordset(conDP4, strSQL)
		If Not rstEntidad Is Nothing Then
			If Not rstEntidad.EOF Then
				strEntidad = Trim(rstEntidad.Fields("EN_NAME").Value)
				strDescrip = Trim(rstEntidad.Fields("AT_DESCRIPTION").Value)
			End If
		End If
		If strEntidad = "Variables de Expediente" Then
			strEntidad = ""
		End If
		If strNOM <> "" Then
			strNomTot = IIf(Mid(strNOM, 1, 1) = "@", Mid(strNOM, 2) & IIf(strEntidad <> "", " (" & strEntidad & ")", ""), strNOM & IIf(strEntidad <> "", " (" & strEntidad & ")", ""))
		End If
		If strDescrip = "" Then
			strDescrip = strNomTot
		End If
		If rstInfra.EOF Then
			
			strSQL = "SELECT * FROM VARIABLES_PA WHERE IDATRIBU=" & lngID & " and FAMILIA='" & strFamil & "'"
			rstPasa = mfRecordset(conPasarela, strSQL)
			If rstPasa.EOF Then
				strSQL = "SELECT MAX(CONVERT(INT, SUBSTRING(CODHIDRA, 4, 9))) FROM VARIABLES WHERE CODHIDRA LIKE 'VAR%'"
				rstInfra = mfRecordset(conInfra, strSQL)
				maxInfra = Val(rstInfra.Fields(0).Value & "")
				strSQL = "SELECT MAX(CONVERT(INT, SUBSTRING(CODHIDRA, 4, 9))) FROM VARIABLES_PA WHERE CODHIDRA LIKE 'VAR%'"
				rstPasa = mfRecordset(conPasarela, strSQL)
				maxPasa = Val(rstPasa.Fields(0).Value & "")
				If maxPasa > maxInfra Then
					strValor = "VAR" & CStr(maxPasa + 1)
				ElseIf maxPasa = maxInfra Then 
					strValor = "VAR" & CStr(maxPasa + 1)
				ElseIf maxPasa < maxInfra Then 
					strValor = "VAR" & CStr(maxInfra + 1)
				End If
				'IIf(Mid(strNOM, 1, 1) = "@", Mid(strNOM, 2) & IIF(STRENTIDAD<>""," (" & STRENTIDAD & ")",""), strNOM & IIF(STRENTIDAD<>""," (" & STRENTIDAD & ")",""))
				strSQL = "INSERT INTO VARIABLES_PA (IDATRIBU, DESATRIB, CODHIDRA, INDTIPOA, INDCTA, DESCATRI, DESEATRI, FAMILIA) VALUES "
				'strSQL = strSQL & "(" & lngID & ", '" & strNomTot & "', '" & strValor & "','S','S','" & Mid(strDescrip, 1, 250) & "','E-" & Mid(strDescrip, 1, 248) & "', '" & strFamil & "')"
				'Inicio Jonathan - 03/07/2012 - Escapar comilla simple en el valor
				strSQL = strSQL & "(" & lngID & ", '" & strNomTot & "', '" & strValor & "','S','S','" & Replace(Mid(strDescrip, 1, 250), "'", "''") & "','E-" & Replace(Mid(strDescrip, 1, 248), "'", "''") & "', '" & strFamil & "')"
				'Fin Jonathan 03/07/2012
				'strSQL = strSQL & "(" & lngID & ", '" & IIf(Mid(strNOM, 1, 1) = "@", Mid(strNOM, 2), strNOM) & "', '" & strValor & "','S','S','','', '" & strFamil & "')"
				mfExecute(conPasarela, strSQL)
			Else
				strValor = rstPasa.Fields("CODHIDRA").Value
			End If
			'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			mfInsertaVariables = strValor
		Else
			If strNomTot <> "" Then
				If rstInfra.Fields("DESATRIB").Value <> strNomTot Then
					strSQL = "DELETE FROM VARIABLES_PA WHERE IDATRIBU=" & lngID & " AND FAMILIA='" & strFamil & "'"
					mfExecute(conPasarela, strSQL)
					strSQL = "INSERT INTO VARIABLES_PA (IDATRIBU, DESATRIB, CODHIDRA, INDTIPOA, INDCTA, DESCATRI, DESEATRI, FAMILIA) VALUES "
					'Inicio Jonathan - 03/07/2012 - Escapar comilla simple en el valor
					'strSQL = strSQL & "(" & lngID & ", '" & strNomTot & "', '" & rstInfra("CODHIDRA") & "','" & rstInfra("INDTIPOA") & "','" & rstInfra("INDCTA") & "','" & Mid(strDescrip, 1, 250) & "','E-" & Mid(strDescrip, 1, 248) & "', '" & strFamil & "')"
					strSQL = strSQL & "(" & lngID & ", '" & strNomTot & "', '" & rstInfra.Fields("CODHIDRA").Value & "','" & rstInfra.Fields("INDTIPOA").Value & "','" & rstInfra.Fields("INDCTA").Value & "','" & Replace(Mid(strDescrip, 1, 250), "'", "''") & "','E-" & Replace(Mid(strDescrip, 1, 248), "'", "''") & "', '" & strFamil & "')"
					'Fin Jonathan 03/07/2012
					mfExecute(conPasarela, strSQL)
				End If
			End If
			'UPGRADE_WARNING: Couldn't resolve default property of object rstInfra.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arrvar. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrvar = rstInfra.GetRows
			'UPGRADE_WARNING: Couldn't resolve default property of object arrvar(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strValor = arrvar(2, 0)
			'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			mfInsertaVariables = strValor
		End If
		
		If Alta = True Then
			If Mid(strValor, 1, 3) = "VAR" And IsNumeric(Mid(strValor, 4)) Then
				strSQL = "INSERT INTO VAR_ALTA_PA (PROCEDIMIENTO,NOMPROC,ORDEN,CODHIDRA) VALUES ("
				strSQL = strSQL & "'" & gNomProcCorto & "','" & Proc & "'," & OrdenAlta & ",'" & strValor & "')"
				mfExecute(conPasarela, strSQL)
			End If
		End If
		
		GoTo procFin
procErr: 
		
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Inserción de variables", "Ha ocurrido un error no controlado", "mfinsertaVariables")
		Mostrar_Error()
		logError("mfInsertaVariables - " & Err.Description)
		Resume procFin
procFin: 
		
	End Function
	
	Private Sub msInsertaParamAcc(ByVal nomVarHN As String, ByVal valor As String, ByVal orden1 As Integer, ByVal orden2 As Integer, ByVal orden3 As Integer, ByVal orden4 As Integer, ByVal orden5 As Integer, ByVal ordenAcc As Integer, Optional ByRef IndValVar As Boolean = False)
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rstParam As ADODB.Recordset
		Dim rstParam2 As ADODB.Recordset
		Dim arrFijos(14) As Object
		Dim I As Short
		Dim blnEmpieza0 As Boolean
		Dim Orden As Integer
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim strDiagrama As String
		Dim strPath As String
		Dim strORDENTRA As String
		Dim strCODUNITR As String
		Dim lngIDAcc As Object
		Dim strIndVal As String
		Dim arrvar As Object
		blnEmpieza0 = False
		
		'''##
		If orden1 = 3 And orden2 = 1 And orden3 = 0 And orden4 = 0 And orden5 = 0 And ordenAcc = 21 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & orden1
		strSQL = strSQL & " AND ORDEN_N2=" & orden2 & " AND ORDEN_N3=" & orden3
		strSQL = strSQL & " AND ORDEN_N4=" & orden4 & " AND ORDEN_N5=" & orden5
		strSQL = strSQL & " AND ORDEN_ACC=" & ordenAcc & " ORDER BY ORDEN_PA DESC"
		rstParam = mfRecordset(conPasarela, strSQL)
		If rstParam.EOF Then
			blnEmpieza0 = True
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & orden1
			strSQL = strSQL & " AND ORDEN_N2=" & orden2 & " AND ORDEN_N3=" & orden3
			strSQL = strSQL & " AND ORDEN_N4=" & orden4 & " AND ORDEN_N5=" & orden5
			strSQL = strSQL & " AND ORDEN_ACC=" & ordenAcc
			rstParam = mfRecordset(conPasarela, strSQL)
			Orden = 0
		Else
			strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & orden1
			strSQL = strSQL & " AND ORDEN_N2=" & orden2 & " AND ORDEN_N3=" & orden3
			strSQL = strSQL & " AND ORDEN_N4=" & orden4 & " AND ORDEN_N5=" & orden5
			strSQL = strSQL & " AND ORDEN_ACC=" & ordenAcc & " AND PARAMETRO='@CODENTID'"
			rstParam2 = mfRecordset(conPasarela, strSQL)
			If Not rstParam2.EOF Then
				blnInserta = False
			End If
			rstParam.MoveFirst()
			Orden = rstParam.Fields("ORDEN_PA").Value
		End If
		If rstParam.EOF Then
			'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
			'UPGRADE_WARNING: Couldn't resolve default property of object lngIDAcc. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			lngIDAcc = System.DBNull.Value
		Else
			'UPGRADE_WARNING: Couldn't resolve default property of object lngIDAcc. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			lngIDAcc = snulo(rstParam.Fields("ID_ACCION").Value & "")
		End If
		If blnInserta = True Then
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(0) = "CODENTID"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(1) = "CODFAMIL"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(2) = "CODPROCE"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(3) = "VERSIONP"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(4) = "CODEXTPR"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(5). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(5) = "IDEXPEDI"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(6). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(6) = "ANOEXPED"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(7). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(7) = "NUMEXPED"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(8). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(8) = "CODOPCIO"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(9). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(9) = "FECREFER"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(10). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(10) = "NUMEMPLE"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(11). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(11) = "CODORGOC"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(12). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(12) = "PROJECT"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(13) = "FLUJO"
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(14). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFijos(14) = "PATHRETORNO"
			For I = 0 To UBound(arrFijos)
				strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
				strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
				strSQL = strSQL & "ID_ACCION, PARAMETRO, "
				strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
				strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
				strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object lngIDAcc. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & "," & lngIDAcc & ", '@" & arrFijos(I) & "'"
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFijos(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & ",'@INICIO!" & arrFijos(I) & "'," & IIf(blnEmpieza0 = True, I + 1, Orden + I + 1) & ")"
				mfExecute(conPasarela, strSQL)
			Next I
			'CODTRAAD
			strSQL = "SELECT ID_DIAGRAMA FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "ORDEN_N1=" & orden1 & " AND "
			strSQL = strSQL & "ORDEN_N2=" & orden2 & " AND "
			strSQL = strSQL & "ORDEN_N3=" & orden3 & " AND "
			strSQL = strSQL & "ORDEN_N4=" & orden4 & " AND "
			strSQL = strSQL & "ORDEN_N5=" & orden5
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strDiagrama = CStr(rstAux.Fields("ID_DIAGRAMA").Value)
			Else
				strDiagrama = ""
			End If
			
			strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
			strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
			strSQL = strSQL & "ID_ACCION, PARAMETRO, "
			strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
			strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
			strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
			strSQL = strSQL & "," & snulo(rstParam.Fields("ID_ACCION").Value & "") & ", '@CODTRAAD'"
			strSQL = strSQL & ",'" & IIf(strDiagrama <> "", strDiagrama, "@INICIO!CODTRAAD") & "'," & IIf(blnEmpieza0 = True, I + 1, Orden + I + 1) & ")"
			mfExecute(conPasarela, strSQL)
			
			'ORDENTRA
			strSQL = "SELECT ORDENTRA FROM TBPFIN03_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND "
			strSQL = strSQL & "NOMBRE=(SELECT TOP 1 NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "ORDEN_N1=" & orden1 & " AND "
			strSQL = strSQL & "ORDEN_N2=" & orden2 & " AND "
			strSQL = strSQL & "ORDEN_N3=" & orden3 & " AND "
			strSQL = strSQL & "ORDEN_N4=" & orden4 & " AND "
			strSQL = strSQL & "ORDEN_N5=" & orden5 & ")"
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strORDENTRA = rstAux.Fields("ORDENTRA").Value
			Else
				strORDENTRA = "@INICIO!ORDENTRA"
			End If
			strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
			strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
			strSQL = strSQL & "ID_ACCION, PARAMETRO, "
			strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
			strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
			strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
			strSQL = strSQL & "," & snulo(rstParam.Fields("ID_ACCION").Value & "") & ", '@ORDENTRA'"
			strSQL = strSQL & ",'" & strORDENTRA & "'," & IIf(blnEmpieza0 = True, I + 2, Orden + I + 2) & ")"
			mfExecute(conPasarela, strSQL)
			'CODUNITR
			If IsNumeric(strORDENTRA) Then
				strSQL = "SELECT CODUNITR FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				'Inicio Jonathan Prieto 24/04/2013
				strSQL = strSQL & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND ORDENTRA=" & strORDENTRA & " AND INDTRAMI='S'"
				'Fin Jonathan Prieto 24/04/2013
				rstAux = mfRecordset(conPasarela, strSQL)
				If rstAux.EOF Then
					strSQL = "SELECT CODUNITR FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND ORDENTRA=" & strORDENTRA
					rstAux = mfRecordset(conPasarela, strSQL)
				End If
			Else
				strSQL = "SELECT CODUNITR FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND INDTRAMI='S'"
				rstAux = mfRecordset(conPasarela, strSQL)
				If rstAux.EOF Then
					strSQL = "SELECT CODUNITR FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama)
					rstAux = mfRecordset(conPasarela, strSQL)
				End If
			End If
			'Set rstAUX = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strCODUNITR = rstAux.Fields("CODUNITR").Value
			Else
				strCODUNITR = "@INICIO!CODUNITR"
			End If
			strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
			strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
			strSQL = strSQL & "ID_ACCION, PARAMETRO, "
			strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
			strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
			strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
			strSQL = strSQL & "," & snulo(rstParam.Fields("ID_ACCION").Value & "") & ", '@CODUNITR'"
			strSQL = strSQL & ",'" & strCODUNITR & "'," & IIf(blnEmpieza0 = True, I + 3, Orden + I + 3) & ")"
			mfExecute(conPasarela, strSQL)
			'CODUTRHN
			If IsNumeric(strORDENTRA) Then
				strSQL = "SELECT CODUTRHN FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND ORDENTRA=" & strORDENTRA & " AND INDTRAMI='S'"
				rstAux = mfRecordset(conPasarela, strSQL)
				If rstAux.EOF Then
					strSQL = "SELECT CODUTRHN FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND ORDENTRA=" & strORDENTRA
					rstAux = mfRecordset(conPasarela, strSQL)
				End If
			Else
				strSQL = "SELECT CODUTRHN FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND INDTRAMI='S'"
				rstAux = mfRecordset(conPasarela, strSQL)
				If rstAux.EOF Then
					strSQL = "SELECT CODUTRHN FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama)
				End If
			End If
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strCODUNITR = rstAux.Fields("CODUTRHN").Value
			Else
				strCODUNITR = "@INICIO!CODUTRHN"
			End If
			strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
			strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
			strSQL = strSQL & "ID_ACCION, PARAMETRO, "
			strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
			strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
			strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
			strSQL = strSQL & "," & snulo(rstParam.Fields("ID_ACCION").Value & "") & ", '@CODUTRHN'"
			strSQL = strSQL & ",'" & strCODUNITR & "'," & IIf(blnEmpieza0 = True, I + 4, Orden + I + 4) & ")"
			mfExecute(conPasarela, strSQL)
			'USUARIO
			strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "ORDEN_N1=" & orden1 & " AND "
			strSQL = strSQL & "ORDEN_N2=" & orden2 & " AND "
			strSQL = strSQL & "ORDEN_N3=" & orden3 & " AND "
			strSQL = strSQL & "ORDEN_N4=" & orden4 & " AND "
			strSQL = strSQL & "ORDEN_N5=" & orden5 & " AND "
			strSQL = strSQL & "NOM_ACCION='FORMFICTICIO'"
			
			rstAux = mfRecordset(conPasarela, strSQL)
			strSQL = "SELECT INDPERSINT FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "ORDEN_N1=" & orden1 & " AND "
			strSQL = strSQL & "ORDEN_N2=" & orden2 & " AND "
			strSQL = strSQL & "ORDEN_N3=" & orden3 & " AND "
			strSQL = strSQL & "ORDEN_N4=" & orden4 & " AND "
			strSQL = strSQL & "ORDEN_N5=" & orden5
			
			rstAux2 = mfRecordset(conPasarela, strSQL)
			
			If Not rstAux2.EOF Then
				If rstAux2.Fields("INDPERSINT").Value = "1" Then
					strPath = "@INICIO!USIDSOLI"
					strSQL = "UPDATE PARAM_ACC SET VALOR='@INICIO!USIDSOLI' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "PARAMETRO='@USUARIO' AND "
					strSQL = strSQL & "ORDEN_N1=" & orden1 & " AND "
					strSQL = strSQL & "ORDEN_N2=" & orden2 & " AND "
					strSQL = strSQL & "ORDEN_N3=" & orden3 & " AND "
					strSQL = strSQL & "ORDEN_N4=" & orden4 & " AND "
					strSQL = strSQL & "ORDEN_N5=" & orden5
					mfExecute(conPasarela, strSQL)
				Else
					If Not rstAux.EOF Then
						strPath = "@" & rstAux.Fields("PATH_HIDRA").Value & "!USUARIO"
					Else
						strPath = "@INICIO!USUARIO"
					End If
				End If
			Else
				If Not rstAux.EOF Then
					strPath = "@" & rstAux.Fields("PATH_HIDRA").Value & "!USUARIO"
				Else
					strPath = "@INICIO!USUARIO"
				End If
			End If
			
			strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
			strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
			strSQL = strSQL & "ID_ACCION, PARAMETRO, "
			strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
			strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
			strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
			strSQL = strSQL & "," & snulo(rstParam.Fields("ID_ACCION").Value & "") & ", '@USUARIO'"
			strSQL = strSQL & ",'" & strPath & "'," & IIf(blnEmpieza0 = True, I + 5, Orden + I + 5) & ")"
			mfExecute(conPasarela, strSQL)
			'REFERENCIA
			strSQL = "SELECT COUNT(*) FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@REFERENCIA'"
			rstAux = mfRecordset(conPasarela, strSQL)
			strPath = "%REFERENCE%"
			strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
			strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
			strSQL = strSQL & "ID_ACCION, PARAMETRO, "
			strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
			strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
			strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
			strSQL = strSQL & "," & snulo(rstParam.Fields("ID_ACCION").Value & "") & ", '@REFERENCIA'"
			strSQL = strSQL & ",'" & strPath & "'," & IIf(blnEmpieza0 = True, I + 6, Orden + I + 6) & ")"
			mfExecute(conPasarela, strSQL)
			blnInserta = False
			Orden = Orden + I + 6
		End If
		If nomVarHN <> "" Then
			If IndValVar = True Then
				
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariablesNOMBRE(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strIndVal = CStr(mfInsertaVariablesNOMBRE(valor))
				If strIndVal = "" Then
					Insertar_Error(Me, "Insercción de variables", "Variable " & valor & " en " & mfObtieneRuta(orden1, orden2, orden3, orden4, orden5, rstParam.Fields("ORDEN_ACC").Value), "msInsertaParamAcc")
				End If
				valor = "@INICIO!" & strIndVal
				valor = Replace(valor, " ", " @INICIO!")
				'valor = "@INICIO!" & mfInsertaVariablesNOMBRE(valor)
			End If
			'''##
			strSQL = "INSERT INTO PARAM_ACC (PROCEDIMIENTO,ORDEN_N1, ORDEN_N2, ORDEN_N3, "
			strSQL = strSQL & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, "
			strSQL = strSQL & "ID_ACCION, PARAMETRO, "
			strSQL = strSQL & "VALOR, ORDEN_PA) VALUES ("
			strSQL = strSQL & "'" & gNomProcCorto & "'," & orden1 & "," & orden2 & "," & orden3
			strSQL = strSQL & "," & orden4 & "," & orden5 & "," & rstParam.Fields("ORDEN_ACC").Value
			strSQL = strSQL & "," & snulo(rstParam.Fields("ID_ACCION").Value & "") & ", '" & nomVarHN & "'"
			strSQL = strSQL & ",'" & valor & "'," & Orden + 1 & ")"
			mfExecute(conPasarela, strSQL)
		End If
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Inserción de Parámetros", "Ha ocurrido un error no controlado", "msInsertaParamAcc")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msInsertaParamAcc - " & Err.Description)
		Resume procFin
procFin: 
	End Sub
	
	
	Private Sub mslecParamAcc()
		
		On Error GoTo procErr
		
		Dim rstACC2 As ADODB.Recordset
		Dim rstTram As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstProp As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstparamHN As ADODB.Recordset
		Dim rstParCME As ADODB.Recordset
		Dim rstParCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTD As ADODB.Recordset
		Dim rstTDCon As ADODB.Recordset
		Dim strSQL As String
		Dim strNomImp As String
		Dim strValor As String
		Dim nomVarHN As String
		Dim strValorV As String
		Dim strImplem As String
		Dim strJOINER As String
		Dim strOrden As String
		Dim strAnt As String
		Dim lngAnt As String
		Dim strPath As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim strNomTram As String
		Dim Resultado As String
		Dim lngF As Integer
		Dim lngAccCME As Integer
		Dim lngAccCMS As Integer
		Dim lngAccConE As Integer
		Dim lngAccConS As Integer
		Dim lngacc As Integer
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim I As Integer
		Dim j As Integer
		Dim lngAux As Integer
		Dim lngUlt As Integer
		Dim regRec As Integer
		Dim H As Integer
		Dim colParam As Collection
		Dim colXMLIm As Collection
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim colValores As Collection
		Dim colPath As Collection
		Dim colXMLPar As Collection
		Dim blnError As Boolean
		Dim blnCompParamVacios As Boolean
		Dim blnfin As Boolean
		Dim blnPrim As Boolean
		Dim blnTruco As Boolean
		Dim arrOrden As Object
		Dim icol As Object
		Dim arr As Object
		Dim arrCM As Object
		Dim arrHN As Object
		
		colXMLIm = New Collection
		colXMLIm.Add("Implementación Acción")
		colXMLPar = New Collection
		colXMLPar.Add("Completar Parámetros Vacío")
		colXML2 = New Collection
		colXML2.Add("Valor")
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND (ID_ACCION is NOT NULL and (ID_ACCION <> 0 or "
		strSQL = strSQL & "NOM_ACCION='PROCESOFALSO')) AND (NUM_SEQ IS NOT NULL and NUM_SEQ<>0) AND (DI_ID IS NOT NULL and DI_ID<>0) ORDER BY "
		strSQL = strSQL & "ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC "
		rstAcc = mfRecordset(conPasarela, strSQL)
		regRec = 0
		If rstAcc.EOF = False Then
			'UPGRADE_WARNING: Couldn't resolve default property of object rstAcc.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstAcc.GetRows : rstAcc.MoveFirst()
		End If
		H = 1
		While Not rstAcc.EOF
			strSeg = rstAcc.Fields("ORDEN_N1").Value & "/" & rstAcc.Fields("ORDEN_N2").Value & "/" & rstAcc.Fields("ORDEN_N3").Value & "/" & rstAcc.Fields("ORDEN_N4").Value & "/" & rstAcc.Fields("ORDEN_N5").Value
			If rstAcc.Fields("ORDEN_N1").Value = 2 And rstAcc.Fields("ORDEN_n2").Value = 1 Then ' Then 'And rstAcc("Nom_accion") = "LET INICIALIZACIONVAR" Then
				System.Windows.Forms.Application.DoEvents()
			End If
			If rstAcc.Fields("NUM_ACCION").Value = 1 And rstAcc.Fields("NOM_ACCION").Value = "PROCESOFALSO" Then ' busca proceso falso, y todo el tema para saber si no hay registros en VAR_ALTA_PA
				strSQL = "SELECT * FROM VAR_ALTA_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
				rstAux = mfRecordset(conPasarela, strSQL)
				If rstAux.RecordCount = 0 Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value
					rstAux = mfRecordset(conPasarela, strSQL)
					strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstAux.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
					rstAux = mfRecordset(conPasarela, strSQL)
					strJOINER = ""
					While Not rstAux.EOF
						strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
						strSQL = strSQL & " Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value
						strSQL = strSQL & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value
						strSQL = strSQL & " AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
						' **** NUEVO SD ENERO'08
						strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
						
						rstConS = mfRecordset(conDP4, strSQL)
						If Not rstConS.EOF Then
							strJOINER = strJOINER & rstConS.Fields(0).Value & ","
						End If
						rstAux.MoveNext()
					End While
					If strJOINER <> "" Then
						strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where "
						strSQL = strSQL & "C.CO_ID =(" & rstConS.Fields("ANO_ID").Value & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
						' **** NUEVO SD ENERO'08
						strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " ORDER BY C.DM_SEQ"
						rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
						lngAccConS = rstParamCMS.RecordCount
						rstParamCMS.MoveFirst()
						If rstParamCMS.RecordCount > 0 Then
							While Not rstParamCMS.EOF
								'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								Resultado = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value, True, gNomProcCorto, rstParamCMS.AbsolutePosition) 'insercion de la variable en VAR_ALTA_PA
								rstParamCMS.MoveNext()
							End While
						End If
					Else
						lngAccConS = 0
					End If
				End If
			End If
			strOrden = rstAcc.Fields("ORDEN_N1").Value & ";" & rstAcc.Fields("ORDEN_N2").Value & ";" & rstAcc.Fields("ORDEN_N3").Value & ";" & rstAcc.Fields("ORDEN_N4").Value & ";" & rstAcc.Fields("ORDEN_N5").Value
			'Debug.Print rstAcc("ORDEN_ACC") & " - " & strOrden
			lblMensaje.Text = "Introduciendo parámetros de ACCIONES en PASARELA"
			If rstAcc.Fields("NOM_ACCION").Value = "PROCESOFALSO" Then
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value
				rstTram = mfRecordset(conPasarela, strSQL)
				GoTo siguiente
			End If
			msProceso(H, UBound(arr, 2) + 2, 1, 1)
			If regPlus <> 0 Then regPlus = 1
			If blnIns = True Then
				rstAcc.Requery()
				For I = 1 To (regRec + regPlus) - 1
					rstAcc.MoveNext()
				Next I
				blnIns = False
			End If
			If rstAcc.EOF Then
				rstAcc.Requery()
				For I = 1 To (regRec + regPlus) - 1
					rstAcc.MoveNext()
				Next I
				blnIns = False
			End If
			regPlus = 0
			strOrden = rstAcc.Fields("ORDEN_N1").Value & ";" & rstAcc.Fields("ORDEN_N2").Value & ";" & rstAcc.Fields("ORDEN_N3").Value & ";" & rstAcc.Fields("ORDEN_N4").Value & ";" & rstAcc.Fields("ORDEN_N5").Value
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value
			rstTram = mfRecordset(conPasarela, strSQL)
			colXMLD = mfBuscaXML("Proceso", colXMLIm, rstAcc.Fields("ID_ACCION").Value, True)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strImplem = IIf(colXMLD.Item(1) = "-1", "", Trim(colXMLD.Item(1)))
			colXMLD = mfBuscaXML("Proceso", colXMLPar, rstAcc.Fields("ID_ACCION").Value, False)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If colXMLD.Item(1) <> vbNullString Then
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				blnCompParamVacios = CBool(System.Math.Abs(colXMLD.Item(1)) = CDbl("1"))
			End If
			blnInserta = True
			strSQL = "SELECT A.AT_NAME, A.AT_ID, E.EN_NAME FROM ATTRIBUTE A, CW_DATA_USAGE B, ENTITY E "
			strSQL = strSQL & "  WHERE A.AT_ID=B.AT_ID AND B.PR_ID = " & rstAcc.Fields("ID_ACCION").Value & " AND DM_INSERTS=1 AND"
			strSQL = strSQL & "  E.EN_ID=A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY B.DM_SEQ"
			rstParCME = mfRecordset(conDP4, strSQL, CStr(True)) 'Parametros de Entrada
			lngAccCME = 0
			If Not rstParCME.EOF Then
				System.Windows.Forms.Application.DoEvents()
				lngAccCME = rstParCME.RecordCount
				System.Windows.Forms.Application.DoEvents()
				rstParCME.MoveFirst()
			End If
			strSQL = "SELECT A.AT_NAME, A.AT_ID, E.EN_NAME FROM ATTRIBUTE A, CW_DATA_USAGE B, ENTITY E "
			strSQL = strSQL & "  WHERE A.AT_ID=B.AT_ID AND B.PR_ID = " & rstAcc.Fields("ID_ACCION").Value & " AND "
			strSQL = strSQL & "  DM_DELETES=1 AND E.EN_ID=A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " ORDER BY B.DM_SEQ"
			rstParCMS = mfRecordset(conDP4, strSQL, CStr(True)) 'Parametros de Salida
			lngAccCMS = 0
			If Not rstParCMS.EOF Then
				lngAccCMS = rstParCMS.RecordCount
				rstParCMS.MoveFirst()
			End If
			strNomImp = Trim(rstAcc.Fields("NOM_ACCION").Value)
			strSQL = "SELECT FlowOrder From wfFlowActions WHERE (RTRIM(Flow)='" & Trim(strNomImp) & "') AND (RTRIM(Action) = 'LABEL') ORDER BY convert(int,FLOWORDER)"
			If rstAcc.Fields("TIPO_ACCION").Value = "E" Then
				rstAux = mfRecordset(conEspe, strSQL)
			ElseIf rstAcc.Fields("TIPO_ACCION").Value = "G" Then 
				rstAux = mfRecordset(conGene, strSQL)
			ElseIf rstAcc.Fields("TIPO_ACCION").Value = "F" Then 
				rstAux = mfRecordset(conGestion, strSQL)
			ElseIf rstAcc.Fields("TIPO_ACCION").Value = "W" Then 
				rstAux = mfRecordset(conWord, strSQL)
				'## Ds66, Para la nueva BD DBT0DOCU
			ElseIf rstAcc.Fields("TIPO_ACCION").Value = "D" Then 
				rstAux = mfRecordset(conDocu, strSQL)
				'##
			ElseIf rstAcc.Fields("TIPO_ACCION").Value = "M" Then 
				rstAux = mfRecordset(conMSJ, strSQL)
			ElseIf rstAcc.Fields("TIPO_ACCION").Value = "O" Then 
				rstAux = mfRecordset(conInfra, strSQL)
			End If
			If Not rstAux.EOF Then
				lngF = rstAux.Fields("FLOWORDER").Value
				rstAux.Close()
				strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='" & Trim(strNomImp) & "' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
				If rstAcc.Fields("TIPO_ACCION").Value = "E" Then
					rstparamHN = mfRecordset(conEspe, strSQL)
				ElseIf rstAcc.Fields("TIPO_ACCION").Value = "G" Then 
					rstparamHN = mfRecordset(conGene, strSQL)
				ElseIf rstAcc.Fields("TIPO_ACCION").Value = "F" Then 
					rstparamHN = mfRecordset(conGestion, strSQL)
				ElseIf rstAcc.Fields("TIPO_ACCION").Value = "W" Then 
					rstparamHN = mfRecordset(conWord, strSQL)
					'## Ds66, Para la nueva BD DBT0DOCU
				ElseIf rstAcc.Fields("TIPO_ACCION").Value = "D" Then 
					rstparamHN = mfRecordset(conDocu, strSQL)
					'##
				ElseIf rstAcc.Fields("TIPO_ACCION").Value = "M" Then 
					rstparamHN = mfRecordset(conMSJ, strSQL)
				ElseIf rstAcc.Fields("TIPO_ACCION").Value = "O" Then 
					rstparamHN = mfRecordset(conInfra, strSQL)
				End If
				If Not rstparamHN.EOF Then
					lngacc = rstparamHN.RecordCount
					rstparamHN.MoveFirst()
				Else
					lngacc = 0
				End If
			Else
				lngacc = 0
			End If
			'Debug.Print rstAcc("NOM_ACCION") & "/" & rstAcc(1) & "/" & rstAcc(2) & "/" & rstAcc(3) & "/" & rstAcc(4) & "/" & rstAcc(5) & "/" & rstAcc("ORDEN_ACC")
			Select Case UCase(strImplem)
				Case "ARRANQUE AUTOMÁTICO EXPEDIENTE"
					If fArranque_Automatico(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
					'Case "EDICIÓN MANUAL DE DOCUMENTO", "EMISIÓN DOCUMENTO", "CÁLCULO CON PLAZO", "COMUNICAR EMPLEADO"
				Case "CÁLCULO CON PLAZO", "COMUNICAR EMPLEADO"
					If fTrat_Varios(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS, strImplem) = False Then
						GoTo siguiente
					End If
				Case "ENVÍO DE MENSAJE"
					If fEnv_Mens(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "EVALUAR INDICADOR DE REQUISITOS"
					If fEval_Ind_Requis(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "IMPRESIÓN DE DOCUMENTO"
					If fImpres_Doc(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "INICIALIZACIÓN DE VARIABLES"
					If fInitVar(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "INTRODUCCIÓN CAMPO OBLIGATORIO/OPCIONAL"
					If fIntroCampoOb(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "INTRODUCCIÓN DE DATOS"
					If fIntroDatos(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "PRESENTACIÓN DE MENSAJE"
					If fPresen_Mens(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "TOMA DE DECISIÓN AUTOMÁTICA"
					If fTD_Aut(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "TOMA DE DECISIÓN DE USUARIO"
					If fTD_Usu(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "COMPROBACIÓN DE DOCUMENTACIÓN"
					If fComprobacion_DOC(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
						GoTo siguiente
					End If
				Case "TRATAMIENTO CON DOCUMENTOS"
					If fTrat_Docum(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS, strImplem) = False Then
						GoTo siguiente
					End If
				Case Else
					'aketza 29/11/2006
					'If fSin_Implementacion(rstTram, rstParamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS) = False Then
					If fSin_Implementacion(rstTram, rstparamHN, rstAcc, rstParCME, rstParCMS, lngacc, lngAccCME, lngAccCMS, blnCompParamVacios) = False Then
						'fin aketza
						GoTo siguiente
					End If
			End Select
			
			If Trim(rstAcc.Fields("NOM_ACCION").Value) <> "LET INICIALIZACIONVAR" Then
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND RTRIM(SUBSTRING(PATH_HIDRA,4,100))='" & Mid(rstAcc.Fields("PATH_HIDRA").Value, 4) & "' And NOM_ACCION='PROCESS'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2.Fields("PATH_HIDRA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1= " & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3= " & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4= " & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5= " & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value - 2 & " AND PARAMETRO='@PATHRETORNO'"
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
					
				End While
			End If
			'If UCase(strImplem) <> "TOMA DE DECISIÓN DE USUARIO" And UCase(strImplem) <> "TOMA DE DECISIÓN AUTOMÁTICA" And UCase(strImplem) <> "ARRANQUE AUTOMÁTICO EXPEDIENTE" Then
			If UCase(strImplem) <> "TOMA DE DECISIÓN DE USUARIO" And UCase(strImplem) <> "TOMA DE DECISIÓN AUTOMÁTICA" And UCase(strImplem) <> "ARRANQUE AUTOMÁTICO EXPEDIENTE" And UCase(strImplem) <> "INICIALIZACIÓN DE VARIABLES" Then
				
				If UCase(strImplem) <> "ARRANQUE AUTOMÁTICO EXPEDIENTE" Then
					'## DS66 15/12/09  Si la sub select devuelve mas de un registro casca
					'strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND NUM_SEQ_HASTA=(SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & ") AND IND_SALIDA_TRAM<>'S'"
					'##
					strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_SEQ_HASTA IN (SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & ") AND IND_SALIDA_TRAM<>'S'"
				Else
					strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='S'"
				End If
				rstAux = mfRecordset(conPasarela, strSQL)
				
				lngUlt = 0
				If rstAux.RecordCount > 1 Then
					
					If VB.Left(rstAcc.Fields("PATH_HIDRA").Value, 3) = "APE" Then
						strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > " & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
					Else
						strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > " & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
					End If
					rstAux2 = mfRecordset(conPasarela, strSQL)
					While Not rstAux2.EOF
						
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value & " + 1 WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC= " & rstAux2.Fields("ORDEN_ACC").Value
						mfExecute(conPasarela, strSQL)
						strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
						mfExecute(conPasarela, strSQL)
						lngUlt = rstAux2.Fields("ORDEN_ACC").Value
						rstAux2.MoveNext()
					End While
					'## DS66 15/12/09  Si la sub select devuelve mas de un registro casca
					'strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc("ORDEN_N1") & " AND ORDEN_N2=" & rstAcc("ORDEN_N2") & " AND ORDEN_N3=" & rstAcc("ORDEN_N3") & " AND ORDEN_N4=" & rstAcc("ORDEN_N4") & " AND ORDEN_N5=" & rstAcc("ORDEN_N5") & " AND NUM_SEQ=(SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & ")"
					'##
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND NUM_SEQ IN (SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & ")"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					'CAMBIO PROCESO FALSO
					If Not rstAux2.EOF Then
						If rstAux2.Fields("NOM_ACCION").Value = "PROCESOFALSO" Then
							strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND ORDEN_ACC= " & rstAux2.Fields("ORDEN_ACC").Value + 1
							rstAux2 = mfRecordset(conPasarela, strSQL)
						End If
					End If
					If lngUlt <> 0 Then
						lngORACC = lngUlt
					Else
						strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
						rstAux3 = mfRecordset(conPasarela, strSQL)
						lngORACC = rstAux3.Fields(0).Value + 1
					End If
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
					rstACC2 = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
					'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA)
					'VALUES ( '" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & ",
					'" & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
					'mfExecute conPasarela, strSQL: blnInserta = False
					mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
					If rstAux2.EOF Then
						msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					Else
						msInsertaParamAcc("PATH", rstAux2.Fields("PATH_HIDRA").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					End If
					rstAcc.Requery()
					For I = 1 To regRec
						rstAcc.MoveNext()
					Next I
				Else
					
					If rstTram.Fields("SALIDAS").Value = 1 Then
						If regPlus = 0 And UCase(strImplem) <> "INICIALIZACIÓN DE VARIABLES" Then
							If UCase(strImplem) <> "ARRANQUE AUTOMÁTICO EXPEDIENTE" Then
								'## DS66 15/12/09  Si la sub select devuelve mas de un registro casca
								'strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND NUM_SEQ_HASTA=(SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & ") AND IND_SALIDA_TRAM='S'"
								'##
								strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_SEQ_HASTA IN (SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & ") AND IND_SALIDA_TRAM='S'"
							Else
								strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='S'"
							End If
							rstAux = mfRecordset(conPasarela, strSQL)
							If (UCase(strImplem) <> "ARRANQUE AUTOMÁTICO EXPEDIENTE" And rstAux.RecordCount > 1) Then 'Or UCase(strImplem) = "ARRANQUE AUTOMÁTICO EXPEDIENTE" Then
								rstAcc.MoveNext()
								If Not rstAcc.EOF Then
									If rstAcc.Fields("ORDEN_N1").Value & ";" & rstAcc.Fields("ORDEN_N2").Value & ";" & rstAcc.Fields("ORDEN_N3").Value & ";" & rstAcc.Fields("ORDEN_N4").Value & ";" & rstAcc.Fields("ORDEN_N5").Value <> strOrden Then
										rstAcc.MovePrevious()
										GoTo CHAP
									End If
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>= " & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										
										strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value & " + 1 WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC= " & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
								End If
								rstAcc.MovePrevious()
								'## DS66 15/12/09  Si la sub select devuelve mas de un registro casca
								'strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc("ORDEN_N1") & " AND ORDEN_N2=" & rstAcc("ORDEN_N2") & " AND ORDEN_N3=" & rstAcc("ORDEN_N3") & " AND ORDEN_N4=" & rstAcc("ORDEN_N4") & " AND ORDEN_N5=" & rstAcc("ORDEN_N5") & " AND NUM_SEQ=(SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & ")"
								'##
								strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND NUM_SEQ IN (SELECT DISTINCT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & ")"
								rstAux2 = mfRecordset(conPasarela, strSQL)
								If lngUlt <> 0 Then
									lngORACC = lngUlt
								Else
CHAP: 
									
									strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux3 = mfRecordset(conPasarela, strSQL)
									lngORACC = rstAux3.Fields(0).Value + 1
								End If
								strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
								rstACC2 = mfRecordset(conPasarela, strSQL)
								lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
								'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
								'mfExecute conPasarela, strSQL
								mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
								blnInserta = False
								If UCase(strImplem) = "ARRANQUE AUTOMÁTICO EXPEDIENTE" Then
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
								Else
									If rstAux2.State = ADODB.ObjectStateEnum.adStateOpen Then
										If Not rstAux2.EOF Then
											msInsertaParamAcc("PATH", rstAux2.Fields("PATH_HIDRA").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										Else
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									Else
										msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									End If
								End If
								rstAcc.Requery()
								For I = 1 To regRec
									rstAcc.MoveNext()
								Next I
							End If
						End If
					End If
				End If
			End If
siguiente: 
			
			regRec = regRec + 1
			rstAcc.MoveNext()
			H = H + 1
			If Not rstAcc.EOF Then
				
				If strOrden <> rstAcc.Fields("ORDEN_N1").Value & ";" & rstAcc.Fields("ORDEN_N2").Value & ";" & rstAcc.Fields("ORDEN_N3").Value & ";" & rstAcc.Fields("ORDEN_N4").Value & ";" & rstAcc.Fields("ORDEN_N5").Value Then
					'SE PROCEDE A INSERTAR LAS ACCIONES FINTRAMITE
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					arrOrden = Split(strOrden, ";")
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4) & " AND ORDEN_ACC<>999"
					rstAux = mfRecordset(conPasarela, strSQL)
					strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN LIKE 'FINTRAMITE%'"
					rstProp = mfRecordset(conInfra, strSQL)
					lngORACC = Val(rstAux.Fields(0).Value & "") + 1
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION = 'FINTRAMITE'"
					rstAux = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
					strPath = "APE_FINTRAMITE" & VB6.Format(lngNumAcc, "00")
					'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,ID_ACCION,NOM_ACCION,NUM_ACCION,
					'PATH_HIDRA,TIPO_ACCION) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " &
					'rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & "," & rstProp("IDACCION") & ",
					''FINTRAMITE'," & lngNumAcc & "," & "'" & strPath & "','" & rstProp("INDTIPOA") & "')"
					'mfExecute conPasarela, strSQL
					mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, rstProp.Fields("IDACCION").Value, "FINTRAMITE", lngNumAcc, rstProp.Fields("INDTIPOA").Value, strPath, 0, 0, "", "", "")
					blnInserta = True
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					msInsertaParamAcc("", "", arrOrden(0), arrOrden(1), arrOrden(2), arrOrden(3), arrOrden(4), lngORACC)
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1= " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3= " & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4= " & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5= " & rstTram.Fields("ORDEN_N5").Value & " AND VALOR='FINTRAMITEPROV'"
					mfExecute(conPasarela, strSQL)
					lngORACC = lngORACC + 1
					strPath = "EDP_FINTRAMITE" & VB6.Format(lngNumAcc, "00")
					strSQL = " INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'ENDPROC'," & lngNumAcc & ",'" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					lngORACC = lngORACC + 1
					strPath = "PRO_FINTRAMITE" & VB6.Format(lngNumAcc, "00")
					'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA)
					'VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," &
					'rstTram ("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & "," & "'PROCESS'," & lngNumAcc & "," & "'" & strPath & "')"
					'mfExecute conPasarela, strSQL
					mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "PROCESS", lngNumAcc, "", strPath, 0, 0, "", "", "")
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
					mfExecute(conPasarela, strSQL)
					'''revisaremos si existe un plazo 2
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT SALIDAS FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4)
					rstAux = mfRecordset(conPasarela, strSQL)
					If rstAux.Fields("SALIDAS").Value > 1 Then
						
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4)
						rstAux2 = mfRecordset(conPasarela, strSQL)
						strNomTram = rstAux2.Fields("NOM_DIAGRAMA").Value
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4) & " AND ORDEN_ACC<>999"
						rstAux2 = mfRecordset(conPasarela, strSQL)
						lngORACC = Val(rstAux2.Fields(0).Value) + 1
						strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
						rstACC2 = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
						'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA)
						'VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & ","
						'& rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
						'mfExecute conPasarela, strSQL
						mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
						blnInserta = False
						msInsertaParamAcc("PATH", "@INICIO!" & "LET" & Mid(strNomTram, 1, 17) & Mid(strNomTram, Len(strNomTram) - 3), rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					End If
				End If
			Else
				
				'SE PROCEDE A INSERTAR LAS ACCIONES FINTRAMITE
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				arrOrden = Split(strOrden, ";")
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4) & " AND ORDEN_ACC<>999"
				rstAux = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN LIKE 'FINTRAMITE%'"
				rstProp = mfRecordset(conInfra, strSQL)
				lngORACC = Val(rstAux.Fields(0).Value & "") + 1
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION = 'FINTRAMITE'"
				rstAux = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
				strPath = "APE_FINTRAMITE" & VB6.Format(lngNumAcc, "00")
				'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,ID_ACCION,NOM_ACCION,NUM_ACCION,
				'PATH_HIDRA,TIPO_ACCION) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3")
				'& "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & "," & rstProp("IDACCION") & ",'FINTRAMITE'," & lngNumAcc & ",'"
				'& strPath & "','" & rstProp("INDTIPOA") & "')"
				'mfExecute conPasarela, strSQL
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, rstProp.Fields("IDACCION").Value, "FINTRAMITE", lngNumAcc, rstProp.Fields("INDTIPOA").Value, strPath, 0, 0, "", "", "")
				blnInserta = True
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				msInsertaParamAcc("", "", arrOrden(0), arrOrden(1), arrOrden(2), arrOrden(3), arrOrden(4), lngORACC)
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1= " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3= " & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4= " & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5= " & rstTram.Fields("ORDEN_N5").Value & " AND VALOR='FINTRAMITEPROV'"
				mfExecute(conPasarela, strSQL)
				lngORACC = lngORACC + 1
				strPath = "EDP_FINTRAMITE" & VB6.Format(lngNumAcc, "00")
				'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA)
				'VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," &
				'rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & "," & "'ENDPROC'," & lngNumAcc & "," & "'" & strPath & "')"
				'mfExecute conPasarela, strSQL
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, rstProp.Fields("IDACCION").Value, "ENDPROC", lngNumAcc, rstProp.Fields("INDTIPOA").Value, strPath, 0, 0, "", "", "")
				lngORACC = lngORACC + 1
				strPath = "PRO_FINTRAMITE" & VB6.Format(lngNumAcc, "00")
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'PROCESS'," & lngNumAcc & "," & "'" & strPath & "')"
				mfExecute(conPasarela, strSQL)
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
				mfExecute(conPasarela, strSQL)
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT SALIDAS FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4)
				rstAux = mfRecordset(conPasarela, strSQL)
				If rstAux.Fields("SALIDAS").Value > 1 Then
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4)
					rstAux2 = mfRecordset(conPasarela, strSQL)
					'strnomTram = rstAux2("NOM_DIAGRAMA")
					strNomTram = "LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object arrOrden(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & arrOrden(0) & " AND ORDEN_N2=" & arrOrden(1) & " AND ORDEN_N3=" & arrOrden(2) & " AND ORDEN_N4=" & arrOrden(3) & " AND ORDEN_N5=" & arrOrden(4) & " AND ORDEN_ACC<>999"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					lngORACC = Val(rstAux2.Fields(0).Value) + 1
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='JUMP'"
					rstACC2 = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
					mfExecute(conPasarela, strSQL) : blnInserta = False
					
					msInsertaParamAcc("PATH", "@INICIO!" & strNomTram, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				End If
			End If
		End While
		'seleccionamos el nombre de todos los tramites cuyo INDTRA sea C
		'por cada uno de ellos miramos sus ordenes en la tabla propiedades di
		'por cada uno de ellos buscamos la acción TRAMITE PENDIENTE
		'actualizamos todas las acciones y parametros
		'insertamos el APE, EL EDP y EL PRO
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='ANEXARFIRMADIGITAL'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND " & "NOM_ACCION='BUSCARUNITRAMITADORAFIRMA'"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			If Not rstAux2.EOF Then
				blnInserta = False
				msInsertaParamAcc("@NUMFIRMA", "PRO_" & Mid(rstAux2.Fields("PATH_HIDRA").Value, 5) & "!NUMFIRMA", rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, rstAux.Fields("ORDEN_ACC").Value)
				blnInserta = True
			End If
			rstAux.MoveNext()
		End While
		
		GoTo procFin
procErr: 
		
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		If rstparamHN.EOF Then
			'aketza errores
			Insertar_Error(Me, "Lectura de parámetros de acciones ", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas en Corporate no coincide con el número de variables de HidraNet", "mslecParamAcc")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			GoTo siguiente
		Else
			logError("msLecParamAcc - " & Err.Description)
			'aketza errores
			Insertar_Error(Me, "Lectura de parámetros de acciones", "Ha ocurrido un error no controlado", "mslecParamAcc" & " -" & strSeg)
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
		End If
		Resume procFin
procFin: 
		
	End Sub
	
	
	
	Private Function fArranque_Automatico(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		'Inicio Jonathan 10/02/2012
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstACC2 As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim lngUlt As Integer
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim blnEncon As Boolean
		'Dim rstParamAccion As ADODB.Recordset
		'Dim lngContParamAccion As Integer
		Dim cont As Short
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		fArranque_Automatico = True
		
		'------------------------------------------------------------------------------------------------------------------
		'COMPROBACIÓN Nº DE PARAMETROS
		'------------------------------------------------------------------------------------------------------------------
		
		'CONECTORES DE SALIDA: Buscamos todos los de la acción de Arranque Automático
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		
		'En cuanto encontremos uno que apunte al evento de categoría Inicio Automático Expediente, paramos
		Do While Not rstAux.EOF
			strSQL = "Select A.PR_ID, D.SH_SEQ, A.PR_NAME, C.LU_NAME, A.PR_ALT_NAME, D.DI_ID "
			strSQL = strSQL & "From PROCESS A, CW_PROP_TYPE B, CW_LOOKUP C, SHAPE D, DIAGRAM E "
			strSQL = strSQL & "Where A.PR_TYPE = C.LU_ID and D.ANO_ID = A.PR_ID and B.PPT_ID = C.PPT_ID and B.PPT_FIELD_NAME = 'PR_TYPE' and "
			strSQL = strSQL & "C.LU_NAME  ='Inicio Automático Expediente'  and D.ANO_TABNR = 8953 and  E.ANO_TABNR = 8953 and D.ANO_ID <> E.ANO_ID and E.DI_ID = D.DI_ID and E.DI_TYPE <> 1 and "
			strSQL = strSQL & "E.ANO_ID = " & rstTram.Fields("ID_DIAGRAMA").Value & " AND D.SH_SEQ = " & rstAux.Fields("NUM_SEQ_HASTA").Value
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			rstParamCMS = mfRecordset(conDP4, strSQL)
			If Not rstParamCMS.EOF Then
				lngAccConS = 1 'Con uno encontrado basta
				Exit Do
			Else
				rstAux.MoveNext()
			End If
			lngAccConS = 0
		Loop 
		
		'CONECTORES DE ENTRADA: Buscamos todos los de la acción de Arranque Automático
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		
		'Nos situamos en el primero que hayamos encontrado (todos tienen que tener los mismos parámetros) y buscamos
		'si tiene parámetros de salida
		If Not rstAux.EOF Then
			rstAux.MoveFirst()
			
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where "
			strSQL = strSQL & "J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
			strSQL = strSQL & " AND C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				'Tiene parámetro de salida, guardamos su ID
				strJOINER = strJOINER & rstconE.Fields(0).Value & ","
			End If
		End If
		
		'Si hemos encontrado algun conector con parámetros de salida, contaremos el nº de parámetros INPUT del conector y
		'de la acción Arranque Automático
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			'Buscamos los parámetros INPUT del conector y los contamos
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & " Where C.CO_ID = " & strJOINER & " AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			'Nº total de parámetros INPUT del conector de entrada
			If Not rstparamCME.EOF Then
				rstparamCME.MoveFirst()
				lngAccConE = rstparamCME.RecordCount
			End If
		Else
			lngAccConE = 0
		End If
		rstAux.Close()
		
		'No puede tener mas parámetros de entrada en el conector de entrada que los que tiene la acción de hidra
		If lngAccConE + 1 > rstparamHN.RecordCount Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "El conector de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " no puede tener más parámetros tipo Insert que la acción de Hidra.", "fArranque_Automatico")
			Mostrar_Error()
			fArranque_Automatico = False
			Exit Function
		End If
		
		'Los parámetros de entrada de la acción (+1 del procedimiento) no puede ser diferente de los que tiene la acción hidra
		If lngAccCME + 1 <> rstparamHN.RecordCount Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "No coincide el nº de parámetros de la acción Arranque Automático (" & Trim(rstAcc.Fields("NOM_ACCION").Value) & ") del trámite " & rstTram.Fields("NOMBRE").Value & " con el nº de parámetros de la acción hidra.", "fArranque_Automatico")
			Mostrar_Error()
			fArranque_Automatico = False
			Exit Function
		End If
		
		'------------------------------------------------------------------------------------------------------------------
		'TRATAMIENTO DE DATOS: Insertamos los parámetros de la acción (Procedimiento y Opción)
		'------------------------------------------------------------------------------------------------------------------
		
		'Parámetro @PROCEDIMIENTO
		If lngAccConS <> 0 Then
			'Tiene algún conector de salida que apunta a Inicio Expediente
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, Mid(rstParamCMS.Fields("PR_NAME").Value, 1, lngNombre), rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
		Else
			'No tiene ningún conector de salida que apunte a Inicio Expediente
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
		End If
		rstparamHN.MoveNext()
		
		'Resto de parámetros
		For cont = 2 To rstparamHN.RecordCount
			'En caso de tener parámetros de entrada en el conector de entrada
			If lngAccConE <> 0 Then
				'Nº de parámetros de entrada del conector de entrada a la acción
				If rstparamCME.RecordCount = 1 And cont = 2 Then
					'Solo tiene un parámetro de entrada. Será el valor del primer parámetro de la acción hidra (tras el de @PROCEDIMIENTO)
					Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fArranque_Automatico")
								Mostrar_Error()
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstparamCME.MoveNext()
					rstparamHN.MoveNext()
					rstParCME.MoveNext()
				ElseIf rstparamCME.RecordCount > 1 Then 
					'Tiene más de un parámetro de entrada en el conector de entrada a la acción
					While Not rstparamCME.EOF
						Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
							Case "Constantes"
								colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strValorV = colXMLD.Item(1)
								If strValorV = "" Then
									Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fArranque_Automatico")
									Mostrar_Error()
								Else
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								End If
							Case ""
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							Case Else
								'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						End Select
						rstparamCME.MoveNext()
						rstparamHN.MoveNext()
						rstParCME.MoveNext()
					End While
				Else
					'No tiene más parámetros de entrada en el conector de entrada a la acción
					'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					rstparamHN.MoveNext()
					rstParCME.MoveNext()
				End If
			Else
				'No tiene parámetros de entrada en el conector de entrada a la acción
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstparamHN.MoveNext()
				rstParCME.MoveNext()
			End If
		Next 
		
		'------------------------------------------------------------------------------------------------------------------
		'TRATAMIENTO DE SALTOS
		'------------------------------------------------------------------------------------------------------------------
		
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							strSQL = "SELECT A.EV_ID FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND "
							strSQL = strSQL & "A.EV_ID=" & rstConS.Fields("EV_ID").Value
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										rstAux2.MoveNext()
										
										
										
										
										
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									'GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					'nomTram = rstAux2("NOM_DIAGRAMA")
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'
				'            End If
				'fin aketza
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
			'''''    Else
			'''''        strSQL = "SELECT * FROM CONECTOR_ACC WHERE " _
			''''''            & "ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND " _
			''''''            & "NUM_CONECTOR=" & rstTram("NUM_DIAGRAMA") & " AND " _
			''''''            & "NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND " _
			''''''            & "IND_SALIDA_TRAM='S'"
			'''''        Set rstAux = mfRecordset(conPasarela, strSQL)
			'''''        If Not rstAux.EOF Then
			'''''            strSQL = "SELECT * FROM ACCIONES_DI WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC>" & rstAcc("ORDEN_ACC") + 1 _
			''''''                & " ORDER BY ORDEN_ACC DESC"
			'''''            Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'''''            While Not rstAux2.EOF
			'''''                strSQL = "UPDATE ACCIONES_DI SET " _
			''''''                & "ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 1 & " WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstAux2("ORDEN_N2") _
			''''''                & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstAux2("ORDEN_N4") _
			''''''                & " AND ORDEN_N5=" & rstAux2("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC=" & rstAux2("ORDEN_ACC")
			'''''                mfExecute conPasarela, strSQL
			'''''                rstAux2.MoveNext
			'''''            Wend
			'''''            blnIns = True
			'''''            regPlus = 1 '
			'''''            lngOrAcc = rstAcc("ORDEN_ACC") + 1
			'''''            strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE NOM_ACCION='JUMP'"
			'''''            Set rstACC2 = mfRecordset(conPasarela, strSQL)
			'''''            lngNumAcc = Val(rstACC2(0) & "") + 1
			'''''            strSQL = "INSERT INTO ACCIONES_DI(ORDEN_N1,ORDEN_N2,ORDEN_N3," _
			''''''                & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
			''''''                & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
			''''''                & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") _
			''''''                & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngOrAcc & "," _
			''''''                & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
			'''''            mfExecute conPasarela, strSQL
			'''''            blnInserta = False
			'''''            msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngOrAcc
			'''''        End If
		Else
			blnEncon = False
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='N'"
			rstAux = mfRecordset(conPasarela, strSQL)
			Do While Not rstAux.EOF
				strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND NUM_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				rstAux3 = mfRecordset(conPasarela, strSQL)
				If Not rstAux3.EOF Then
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					While Not rstAux2.EOF
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
						mfExecute(conPasarela, strSQL)
						lngUlt = rstAux2.Fields("ORDEN_ACC").Value
						strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
						mfExecute(conPasarela, strSQL)
						rstAux2.MoveNext()
					End While
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
					rstACC2 = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
					lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
					
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAcc.Fields("ORDEN_N1").Value & ", " & rstAcc.Fields("ORDEN_N2").Value & ", " & rstAcc.Fields("ORDEN_N3").Value & "," & rstAcc.Fields("ORDEN_N4").Value & "," & rstAcc.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					msInsertaParamAcc("PATH", rstAux3.Fields("PATH_HIDRA").Value, rstAcc.Fields("ORDEN_N1").Value, rstAcc.Fields("ORDEN_N2").Value, rstAcc.Fields("ORDEN_N3").Value, rstAcc.Fields("ORDEN_N4").Value, rstAcc.Fields("ORDEN_N5").Value, lngORACC)
					blnIns = True
					regPlus = 1
					blnEncon = True
					Exit Do
				End If
				
				rstAux.MoveNext()
			Loop 
			If blnEncon = False Then
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					lngUlt = rstAux2.Fields("ORDEN_ACC").Value
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAcc.Fields("ORDEN_N1").Value & ", " & rstAcc.Fields("ORDEN_N2").Value & ", " & rstAcc.Fields("ORDEN_N3").Value & "," & rstAcc.Fields("ORDEN_N4").Value & "," & rstAcc.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstAcc.Fields("ORDEN_N1").Value, rstAcc.Fields("ORDEN_N2").Value, rstAcc.Fields("ORDEN_N3").Value, rstAcc.Fields("ORDEN_N4").Value, rstAcc.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
				blnEncon = True
			End If
		End If
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Arranque automático de expediente", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fArranque_Automatico")
		Mostrar_Error()
		logError("fArranque_Automático - " & Err.Description)
		Resume procFin
		
procFin: 
		'Fin Jonathan 10/02/2012
	End Function
	
	
	Private Function fTrat_Varios(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer, ByVal strImplem As String) As Boolean
		On Error GoTo procErr
		
		Dim rstACC2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim lngUlt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim blnPrim As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strSQL As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim codPlaz As String
		Dim blnIndValVar As Boolean
		colXML2 = New Collection
		colXML2.Add("Valor")
		
		fTrat_Varios = True
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM "
			strSQL = strSQL & "JOINER J, CW_DATA_USAGE C Where "
			strSQL = strSQL & "J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				'*strJoiner = strJoiner & rstConS(0) & ","
				strJOINER = rstConS.Fields(0).Value
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & " Where C.CO_ID = (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConS = rstParamCMS.RecordCount
			System.Windows.Forms.Application.DoEvents()
			rstParamCMS.MoveFirst()
		Else
			lngAccConS = 0
		End If
		strJOINER = ""
		rstAux.Close()
		'aketza 4/9/2006
		'    strSQL = "SELECT * FROM CONECTOR_ACC WHERE " _
		''        & "ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND " _
		''        & "NUM_CONECTOR=" & rstTram("NUM_DIAGRAMA") & " and " _
		''        & "NUM_SEQ_HASTA=" & rstACC("NUM_SEQ")
		
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and " & "NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		'fin aketza
		rstAux = mfRecordset(conPasarela, strSQL)
		lngAnt = 0
		blnPrim = True
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM "
			strSQL = strSQL & "JOINER J, CW_DATA_USAGE C Where "
			strSQL = strSQL & "J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				strJOINER = rstconE.Fields(0).Value
vuelta: 
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
				strSQL = strSQL & " Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			Else
				strSQL = "select DISTINCT J.ANO_ID "
				strSQL = strSQL & "FROM JOINER J "
				strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
				strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
				strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
				strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				
				rstconE = mfRecordset(conDP4, strSQL)
				GoTo vuelta
			End If
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> rstparamCME.RecordCount Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fTrat_Varios")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fTrat_Varios = False
					Exit Function
				End If
				
			End If
			System.Windows.Forms.Application.DoEvents()
			lngAnt = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & " Where C.CO_ID = (" & strJOINER & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConE = rstparamCME.RecordCount
			rstparamCME.MoveFirst()
		Else
			lngAccConE = 0
		End If
		rstAux.Close()
		If Trim(rstAcc.Fields("NOM_ACCION").Value) <> "COMPROBACIONVALOR" Then
			If lngacc <> IIf(lngAccConE <> 0, lngAccConE, lngAccCME) + IIf(lngAccConS <> 0, lngAccConS, lngAccCMS) + 1 Then
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fTrat_Varios")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fTrat_Varios = False
				Exit Function
			End If
		End If
		colXML4 = New Collection
		If UCase(strImplem) = "CÁLCULO CON PLAZO" Then
			colXML4.Add("Código Plazo")
			colXML4.Add("Indicador Valor Variable")
			colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value, True)
		ElseIf UCase(strImplem) = "COMUNICAR EMPLEADO" Then 
			colXML4.Add("Código de Mensaje")
			colXML4.Add("Indicador Valor Variable")
			colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
		Else
			colXML4.Add("Código Documento")
			colXML4.Add("Indicador Valor Variable")
			colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
		End If
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		If colXMLD.Item(2) <> vbNullString Then
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
		End If
		'If blnIndValVar = True Then
		colXMLD.Remove(2)
		'End If
		'Set colXMLD = mfBuscaXML("Conector", colXML4, 33016)
		I = 0
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		codPlaz = colXMLD.Item(1)
		If Trim(rstAcc.Fields("NOM_ACCION").Value) = "COMPROBACIONVALOR" Then
			If codPlaz <> "" Then
				If lngacc - 1 <> IIf(lngAccConE <> 0, lngAccConE, lngAccCME) + IIf(lngAccConS <> 0, lngAccConS, lngAccCMS) + 1 Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fTrat_Varios")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fTrat_Varios = False
					Exit Function
				End If
			Else
				If lngacc <> IIf(lngAccConE <> 0, lngAccConE, lngAccCME) + IIf(lngAccConS <> 0, lngAccConS, lngAccCMS) + 1 Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fTrat_Varios")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fTrat_Varios = False
					Exit Function
				End If
			End If
		End If
		For	Each icol In colXMLD
			I = I + 1
			'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
			rstparamHN.MoveNext()
		Next icol
		If lngAccConE <> 0 Then
			If lngAccCME = lngAccConE + IIf(Trim(rstAcc.Fields("NOM_ACCION").Value) = "COMPROBACIONVALOR", (IIf(codPlaz <> "", 1, 0)), 0) Then
				While Not rstparamCME.EOF
					If Trim(rstparamHN.Fields("PARAM").Value) = "@OPERANDO2" And codPlaz <> "" Then
						rstparamHN.MoveNext()
					End If
					Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTrat_Varios")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstparamCME.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fTrat_Varios")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fTrat_Varios = False
				Exit Function
			End If
		Else
			While Not rstParCME.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCME.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		If lngAccConS <> 0 Then
			If lngAccCMS = lngAccConS Then
				While Not rstParamCMS.EOF
					Select Case rstParamCMS.Fields("EN_NAME").Value
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTrat_Varios")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
							'msInsertaParamAcc rstParamHN("PARAM"), "@INICIO!" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstParamCMS.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fTrat_Varios")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fTrat_Varios = False
				Exit Function
			End If
		Else
			While Not rstParCMS.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
				'msInsertaParamAcc rstParamHN("PARAM"), "@INICIO!" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCMS.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							strSQL = "SELECT A.EV_ID FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " and E.ANO_TABNR=8953 "
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							strSQL = strSQL & " ORDER BY D.SH_Y DESC"
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									'                                If Not RSTAUX2.EOF Then
									'                                    nomTramS = RSTAUX2("NOM_DIAGRAMA")
									'                                Else
									'                                    nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
									'                                End If
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
										If nomTramS = "" Then
											If rstAux2.Fields("ORDEN_N2").Value = 0 Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											Do While Not rstAux2.EOF
												If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Exit Do
												End If
												rstAux2.MoveNext()
												nomTramS = "PR_FINEXPEDIENTE"
											Loop 
										End If
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									'GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					'nomTram = rstAux2("NOM_DIAGRAMA")
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'
				'            End If
				'fin aketza
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
			'''''    Else
			'''''        strSQL = "SELECT * FROM CONECTOR_ACC WHERE " _
			''''''            & "ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND " _
			''''''            & "NUM_CONECTOR=" & rstTram("NUM_DIAGRAMA") & " AND " _
			''''''            & "NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND " _
			''''''            & "IND_SALIDA_TRAM='S'"
			'''''        Set rstAux = mfRecordset(conPasarela, strSQL)
			'''''        If Not rstAux.EOF Then
			'''''            strSQL = "SELECT * FROM ACCIONES_DI WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC>" & rstAcc("ORDEN_ACC") + 1 _
			''''''                & " ORDER BY ORDEN_ACC DESC"
			'''''            Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'''''            While Not rstAux2.EOF
			'''''                strSQL = "UPDATE ACCIONES_DI SET " _
			''''''                & "ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 1 & " WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstAux2("ORDEN_N2") _
			''''''                & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstAux2("ORDEN_N4") _
			''''''                & " AND ORDEN_N5=" & rstAux2("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC=" & rstAux2("ORDEN_ACC")
			'''''                mfExecute conPasarela, strSQL
			'''''                rstAux2.MoveNext
			'''''            Wend
			'''''            blnIns = True
			'''''            regPlus = 1 '
			'''''            lngOrAcc = rstAcc("ORDEN_ACC") + 1
			'''''            strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE NOM_ACCION='JUMP'"
			'''''            Set rstACC2 = mfRecordset(conPasarela, strSQL)
			'''''            lngNumAcc = Val(rstACC2(0) & "") + 1
			'''''            strSQL = "(ORDEN_N1,ORDEN_N2,ORDEN_N3," _
			''''''                & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
			''''''                & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
			''''''                & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") _
			''''''                & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngOrAcc & "," _
			''''''                & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
			'''''            mfExecute conPasarela, strSQL
			'''''            blnInserta = False
			'''''            msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngOrAcc
			'''''        End If
		End If
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		logError("fTrat_Varios - " & Err.Description)
		Insertar_Error(Me, "Lectura de acciones de trámite", "La acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " está mal definida.", "fTrat_Varios")
		Mostrar_Error()
		fTrat_Varios = False
		Resume procFin
		
procFin: 
		
	End Function
	
	
	
	Private Function fEval_Ind_Requis(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		On Error GoTo procErr
		Dim rstACC2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim blnfin As Boolean
		Dim blnPrim As Boolean
		Dim strSQL As String
		Dim strJOINER As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim I As Integer
		Dim lngAccConS As Integer
		Dim lngUlt As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim blnIndValVar As Boolean
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		fEval_Ind_Requis = True
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "  Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value
			strSQL = strSQL & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value
			strSQL = strSQL & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value
			strSQL = strSQL & "  AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM "
			strSQL = strSQL & "ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where "
			strSQL = strSQL & "C.CO_ID =(" & rstConS.Fields("ANO_ID").Value & ") AND DM_DELETES=1 AND "
			strSQL = strSQL & "A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConS = rstParamCMS.RecordCount
			System.Windows.Forms.Application.DoEvents()
			rstParamCMS.MoveFirst()
		Else
			lngAccConS = 0
		End If
		rstAux.Close()
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and " & "NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		lngAnt = 0
		blnPrim = True
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				strJOINER = rstconE.Fields(0).Value
			End If
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM "
			strSQL = strSQL & "ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where "
			strSQL = strSQL & "C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 "
			strSQL = strSQL & "AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> rstparamCME.RecordCount Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fEval_IndRequis")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fEval_Ind_Requis = False
					Exit Function
				End If
			End If
			System.Windows.Forms.Application.DoEvents()
			lngAnt = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			'strJoiner = Mid(strJoiner, 1, Len(strJoiner) - 1)
			'strjoiner=str
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM "
			strSQL = strSQL & "ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where "
			strSQL = strSQL & "C.CO_ID = (" & strJOINER & ")  AND DM_INSERTS=1 "
			strSQL = strSQL & "AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConE = rstparamCME.RecordCount
			rstparamCME.MoveFirst()
		Else
			lngAccConE = 0
		End If
		rstAux.Close()
		If lngacc <> IIf(lngAccConE <> 0, lngAccConE, lngAccCME) + IIf(lngAccConS <> 0, lngAccConS, lngAccCMS) + 5 Then
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fEval_IndRequis")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			fEval_Ind_Requis = False
			Exit Function
		End If
		If lngAccConE <> 0 Then
			If lngAccCME = lngAccConE Then
				While Not rstparamCME.EOF
					Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fEval_IndRequis")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstparamCME.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables  asignadas como entrada no coincide con el número de parámetros de entrada", "fEval_IndRequis")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fEval_Ind_Requis = False
				Exit Function
			End If
		Else
			While Not rstParCME.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCME.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		colXML4 = New Collection
		colXML4.Add("Código Requisito 1")
		colXML4.Add("Código Requisito 2")
		colXML4.Add("Código Requisito 3")
		colXML4.Add("Código Requisito 4")
		colXML4.Add("Código Requisito 5")
		'variable igor
		colXML4.Add("Indicador Valor Variable")
		
		colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(6). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		If colXMLD.Item(6) <> vbNullString Then
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(6)) = CDbl("1"))
		End If
		colXMLD.Remove(6)
		
		For	Each icol In colXMLD
			'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
			rstparamHN.MoveNext()
		Next icol
		If lngAccConS <> 0 Then
			If lngAccCMS = lngAccConS Then
				While Not rstParamCMS.EOF
					Select Case rstParamCMS.Fields("EN_NAME").Value
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fEval_IndRequis")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstParamCMS.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables  asignadas como entrada no coincide con el número de parámetros de entrada", "fEval_IndRequis")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fEval_Ind_Requis = False
				Exit Function
			End If
		Else
			While Not rstParCMS.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCMS.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2")) = "FIN DE EXPEDIENTE") Or UCase(Trim(rstAux("CAT_CONECTOR2")) = "FIN DE ASUNTO") Then
				If UCase(CStr(Trim(rstAux.Fields("CAT_CONECTOR2").Value) = "FIN DE EXPEDIENTE")) Or UCase(CStr(Trim(rstAux.Fields("CAT_CONECTOR2").Value) = "FIN DE ASUNTO")) Or UCase(CStr(Trim(rstAux.Fields("CAT_CONECTOR2").Value) = "FIN ASUNTO")) Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							strSQL = "SELECT A.EV_ID FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									'GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					'nomTram = rstAux2("NOM_DIAGRAMA")
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'
				'            End If
				'fin aketza
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
			'''''    Else
			'''''        strSQL = "SELECT * FROM CONECTOR_ACC WHERE " _
			''''''            & "ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND " _
			''''''            & "NUM_CONECTOR=" & rstTram("NUM_DIAGRAMA") & " AND " _
			''''''            & "NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND " _
			''''''            & "IND_SALIDA_TRAM='S'"
			'''''        Set rstAux = mfRecordset(conPasarela, strSQL)
			'''''        If Not rstAux.EOF Then
			'''''            strSQL = "SELECT * FROM ACCIONES_DI WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC>" & rstAcc("ORDEN_ACC") + 1 _
			''''''                & " ORDER BY ORDEN_ACC DESC"
			'''''            Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'''''            While Not rstAux2.EOF
			'''''                strSQL = "UPDATE ACCIONES_DI SET " _
			''''''                & "ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 1 & " WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstAux2("ORDEN_N2") _
			''''''                & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstAux2("ORDEN_N4") _
			''''''                & " AND ORDEN_N5=" & rstAux2("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC=" & rstAux2("ORDEN_ACC")
			'''''                mfExecute conPasarela, strSQL
			'''''                rstAux2.MoveNext
			'''''            Wend
			'''''            blnIns = True
			'''''            regPlus = 1 '
			'''''            lngOrAcc = rstAcc("ORDEN_ACC") + 1
			'''''            strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE NOM_ACCION='JUMP'"
			'''''            Set rstACC2 = mfRecordset(conPasarela, strSQL)
			'''''            lngNumAcc = Val(rstACC2(0) & "") + 1
			'''''            strSQL = "INSERT INTO ACCIONES_DI(ORDEN_N1,ORDEN_N2,ORDEN_N3," _
			''''''                & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
			''''''                & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
			''''''                & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") _
			''''''                & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngOrAcc & "," _
			''''''                & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
			'''''            mfExecute conPasarela, strSQL
			'''''            blnInserta = False
			'''''            msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngOrAcc
			'''''        End If
		End If
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Evaluar Indicador de Requisitos", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fEval_IndRequis")
		Mostrar_Error()
		logError("f_Eval_Ind_Requis - " & Err.Description)
		Resume procFin
		
procFin: 
		
	End Function
	
	Private Function fImpres_Doc(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		On Error GoTo procErr
		
		
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux7 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstACC2 As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngUlt As Integer
		Dim lngORACC As Integer
		Dim blnPrim As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim strSQL As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim blnIndValVar As Boolean
		If rstAcc.Fields("num_ACCION").Value = 3 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		
		fImpres_Doc = True
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & " Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value
			strSQL = strSQL & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & " Where C.CO_ID IN (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConS = rstParamCMS.RecordCount
			System.Windows.Forms.Application.DoEvents()
			rstParamCMS.MoveFirst()
		Else
			lngAccConS = 0
		End If
		rstAux.Close()
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		lngAnt = 0
		blnPrim = True
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID "
			strSQL = strSQL & "FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				strJOINER = strJOINER & rstconE.Fields(0).Value & ","
vuelta: 
				
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
				strSQL = strSQL & "  Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
				lngAccConE = rstparamCME.RecordCount
			Else
				strSQL = "select DISTINCT J.ANO_ID "
				strSQL = strSQL & "FROM JOINER J "
				strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
				strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
				strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
				strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				
				rstconE = mfRecordset(conDP4, strSQL)
				GoTo vuelta
			End If
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> rstparamCME.RecordCount Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fImpres_Doc")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fImpres_Doc = False
					Exit Function
				End If
				
			End If
			System.Windows.Forms.Application.DoEvents()
			lngAnt = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		If Not strJOINER = "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			
			'Inicio Jonathan Prieto 18/08/2011
			'        strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			'        strSQL = strSQL & "  Where C.CO_ID IN (" & strJOINER & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			'            ' **** NUEVO SD ENERO'08
			'        strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			'        strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			'        strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'        strSQL = strSQL & "  ORDER BY C.DM_SEQ"
			strSQL = "SELECT DISTINCT C.AT_ID, A.AT_NAME, E.EN_NAME, C.DM_SEQ" & " FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E " & " WHERE C.CO_ID IN (" & strJOINER & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID " & " AND A.MODEL_NAME ='" & strModelo & "' AND C.MODEL_NAME ='" & strModelo & "' AND E.MODEL_NAME ='" & strModelo & "'" & " ORDER BY C.DM_SEQ, C.AT_ID, A.AT_NAME, E.EN_NAME"
			'Fin Jonathan Prieto 18/08/2011
			
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			lngAccConE = rstparamCME.RecordCount
		Else
			rstparamCME = rstParCME
		End If
		rstAux.Close()
		If lngacc <> IIf(lngAccConE <> 0, lngAccConE, lngAccCME) + IIf(lngAccConS <> 0, lngAccConS, lngAccCMS) + 1 Then
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fImpres_Doc")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			fImpres_Doc = False
			Exit Function
		End If
		'Inicio Jonathan Prieto 23/06/2011
		colXML2 = New Collection
		colXML2.Add("Código Documento")
		colXML2.Add("Indicador Valor Variable")
		colXMLD = mfBuscaXML("Conector", colXML2, rstconE.Fields("ANO_ID").Value)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		If colXMLD.Item(2) <> vbNullString Then
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
		End If
		colXMLD.Remove(2)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strValorV = colXMLD.Item(1)
		If strValorV <> "" Then
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
			rstparamHN.MoveNext()
			rstParCME.MoveNext()
		End If
		'Fin Jonathan Prieto 23/06/2011
		colXML2 = New Collection
		colXML2.Add("Valor")
		If lngAccConE <> 0 Then
			If lngAccCME = lngAccConE Then
				While Not rstparamCME.EOF
					Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fImpres_Doc")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstparamCME.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables  asignadas como entrada no coincide con el número de parámetros de entrada", "fImpres_Doc")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fImpres_Doc = False
				Exit Function
			End If
		Else
			While Not rstParCME.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCME.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		colXML4 = New Collection
		colXML4.Add("Código de Mensaje")
		colXML4.Add("Indicador Valor Variable")
		colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
		'Inicio Jonathan Prieto 23/06/2011
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		If colXMLD.Item(2) <> vbNullString Then
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
		End If
		'blnIndValVar = CBool(colXMLD(2) = "1")
		'Fin Jonathan Prieto 23/06/2011
		colXMLD.Remove(2)
		I = 0
		For	Each icol In colXMLD
			I = I + 1
			'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
			rstparamHN.MoveNext()
		Next icol
		If lngAccConS <> 0 Then
			If lngAccCMS = lngAccConS Then
				While Not rstParamCMS.EOF
					Select Case rstParamCMS.Fields("EN_NAME").Value
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fImpres_Doc")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
							'msInsertaParamAcc rstParamHN("PARAM"), "@INICIO!" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstParamCMS.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fImpres_Doc")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fImpres_Doc = False
				Exit Function
			End If
		Else
			While Not rstParCMS.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
				'msInsertaParamAcc rstParamHN("PARAM"), "@INICIO!" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCMS.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		
		
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'If Trim(rstAux("CAT_CONECTOR2")) = "Fin de Expediente" Then
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui2
				End If
				
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=0"
					If rstTram.Fields("NUM_DIAGRAMA").Value = 1 Then
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=0"
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 2 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 4 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 5 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
					End If
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						If rstTram.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
							strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
							strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
							strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
							strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 5 Then 
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
							strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
						End If
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						If rstTRAMS.RecordCount > 1 Then
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
							rstTRAMS.Close()
							'UPGRADE_NOTE: Object rstTRAMS may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
							rstTRAMS = Nothing
							rstTRAMS = mfRecordset(conPasarela, strSQL)
						End If
						While Not rstTRAMS.EOF
							'*CAMBIO IMPORTANTE
							strSQL = "SELECT A.EV_ID FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND "
							strSQL = strSQL & "A.EV_ID=" & rstConS.Fields("EV_ID").Value
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & " NOM_ACCION='LET INICIALIZACIONVAR'"
									
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngUlt = 0
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
										If nomTramS = "" Then
											
											If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstTRAMS.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstTRAMS.Fields("ORDEN_N3").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstTRAMS.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstTRAMS.Fields("ORDEN_N4").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstTRAMS.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstTRAMS.Fields("ORDEN_N5").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstTRAMS.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											End If
											rstAux7 = mfRecordset(conPasarela, strSQL)
											Do While Not rstAux7.EOF
												If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
													nomTramS = rstAux7.Fields("NOM_DIAGRAMA").Value
													Exit Do
												End If
												rstAux7.MoveNext()
												nomTramS = "PR_FINEXPEDIENTE"
											Loop 
										End If
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											GoTo aqui
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui2: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					'nomTram = rstAux2("NOM_DIAGRAMA")
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'
				'            End If
				'fin aketza
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				'aketza 4/9/2006
				'strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE NOM_ACCION='JUMP'"
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				'fin aketza
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
				GoTo aqui
			End If
		End If
		
		
		
aqui: 
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Function
		
		If blnParar = True Then Exit Function
		'aketza errores
		Insertar_Error(Me, "Impresión de documento", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fImpres_Doc")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("fImpres_Doc - " & Err.Description)
		Resume procFin
procFin: 
		
	End Function
	
	Private Function fIntroDatos(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstACC2 As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim I As Integer
		Dim blnPrim As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim lngUlt As Integer
		Dim blnIndValVar As Boolean
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		fIntroDatos = True
		If Not rstparamHN.EOF Then rstparamHN.MoveFirst()
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID "
			strSQL = strSQL & "FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			'strSQL = "SELECT A.AT_ID, A.AT_NAME, E.EN_NAME FROM " _
			'& "ATTRIBUTE A, JOINER J, ENTITY E " _
			'& "WHERE A.AT_ID IN ( select C.AT_ID " _
			'& "FROM JOINER J, CW_DATA_USAGE C " _
			'& "Where J.ANO_ID in (" & strJoiner & ") AND " _
			'& "C.CO_ID=J.ANO_ID AND DM_DELETES=1) AND " _
			'& " J.ANO_ID IN (" & strJoiner & ") AND E.EN_ID = A.EN_ID"
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & " Where C.CO_ID IN (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL)
			lngAccConS = rstParamCMS.RecordCount
		Else
			rstAux.MoveFirst()
			strSQL = "select DISTINCT J.ANO_ID "
			strSQL = strSQL & "FROM JOINER J "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			rstParamCMS = rstParCMS
			lngAccConS = rstParamCMS.RecordCount
		End If
		rstAux.Close()
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		lngAnt = 0
		blnPrim = True
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID "
			strSQL = strSQL & "FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & "  AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				
				strJOINER = rstconE.Fields(0).Value
vuelta: 
				
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
				strSQL = strSQL & " Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			Else
				strSQL = "select DISTINCT J.ANO_ID "
				strSQL = strSQL & "FROM JOINER J "
				strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
				strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
				strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
				strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				rstconE = mfRecordset(conDP4, strSQL)
				GoTo vuelta
			End If
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> rstparamCME.RecordCount Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fIntroDatos")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fIntroDatos = False
					Exit Function
				End If
				
			End If
			System.Windows.Forms.Application.DoEvents()
			lngAnt = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		If Not strJOINER = "" Then
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & " Where C.CO_ID IN (" & strJOINER & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
		Else
			rstparamCME = rstParCME
		End If
		I = 0
		If rstparamCME.RecordCount = 0 Then
			rstparamCME = rstParCME
		End If
		If rstParamCMS.RecordCount = 0 Then
			rstParamCMS = rstParCMS
		End If
		colXML4 = New Collection
		System.Windows.Forms.Application.DoEvents()
		'For j = 1 To rstParamCME.RecordCount
		colXML4.Add("Código Literal 1")
		colXML4.Add("Código Literal 2")
		colXML4.Add("Indicador Valor Variable")
		'Next j
		'*16/09/2004
		If Not rstconE Is Nothing Then
			colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If colXMLD.Item(3) <> vbNullString Then
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(3)) = CDbl("1"))
			End If
			colXMLD.Remove(3)
			For	Each icol In colXMLD
				'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				If icol <> "" Then
					If rstparamHN.Fields("PARAM").Value = "@LETPR_VALORACIÓNDEEXIE01" And rstTram.Fields("ORDEN_N1").Value = 4 And rstTram.Fields("ORDEN_N2").Value = 0 And rstTram.Fields("ORDEN_N3").Value = 0 And rstTram.Fields("ORDEN_N4").Value = 0 And rstTram.Fields("ORDEN_N5").Value = 0 Then
						System.Windows.Forms.Application.DoEvents()
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
					rstparamHN.MoveNext()
					I = I + 1
				End If
			Next icol
		End If
		
		Do While Not rstparamHN.EOF
			If InStr(1, rstparamHN.Fields("PARAM").Value, "LITERAL") <> 0 Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstparamHN.MoveNext()
				I = I + 1
			Else
				Exit Do
			End If
		Loop 
		
		If rstparamCME.RecordCount > 0 Then rstparamCME.MoveFirst()
		If Not rstparamCME.EOF Then
			While Not rstparamCME.EOF
				Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
					Case "Constantes"
						colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
						'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strValorV = colXMLD.Item(1)
						If strValorV = "" Then
							'aketza errores
							Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fintroDatos")
							'mostramos el btn y el lbl
							Mostrar_Error()
							'fin aketza
						Else
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							I = I + 1
						End If
					Case ""
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						I = I + 1
					Case Else
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						I = I + 1
				End Select
				rstparamHN.MoveNext()
				rstparamCME.MoveNext()
			End While
		End If
		'''''        Set colXML4 = New Collection
		'''''        DoEvents
		'''''        'For j = 1 To rstParamCME.RecordCount
		'''''            colXML4.Add "Código Literal 1"
		'''''            colXML4.Add "Código Literal 2"
		'''''        'Next j
		'''''        Set colXMLD = mfBuscaXML("Conector", colXML4, rstConE("ANO_ID"))
		'''''        For Each icol In colXMLD
		'''''            If icol <> "" Then
		'''''                msInsertaParamAcc rstParamHN("PARAM"), icol, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
		'''''                rstParamHN.MoveNext
		'''''                i = i + 1
		'''''            End If
		'''''        Next
		'End If
		j = 0
		If lngAccConS <> 0 Then
			If lngAccCMS = lngAccConS Then
				While Not rstParamCMS.EOF
					Select Case rstParamCMS.Fields("EN_NAME").Value
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fintroDatos")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								j = j + 1
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							j = j + 1
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
							'msInsertaParamAcc rstParamHN("PARAM"), "@INICIO!" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							j = j + 1
					End Select
					rstParamCMS.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fintroDatos")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fIntroDatos = False
				Exit Function
			End If
		Else
			If Not rstParCMS.EOF Then rstParCMS.MoveFirst()
			While Not rstParCMS.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
				'msInsertaParamAcc rstParamHN("PARAM"), "@INICIO!" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCMS.MoveNext()
				rstparamHN.MoveNext()
				j = j + 1
			End While
		End If
		If lngacc <> j + I Then
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fintroDatos")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			fIntroDatos = False
			Exit Function
		End If
		
		If lngacc = 0 Then
			msInsertaParamAcc("", "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
		End If
		
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					'Inicio Jonathan Prieto 10/01/2014
					Select Case rstTram.Fields("NUM_DIAGRAMA").Value
						Case "2"
							strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value
						Case "3"
							strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value
						Case "4"
							strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value
						Case "5"
							strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value
					End Select
					'Fin Jonathan Prieto 10/01/2014
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						'Inicio Jonathan Prieto 10/01/2014
						Select Case rstTram.Fields("NUM_DIAGRAMA").Value
							Case "2"
								strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value
							Case "3"
								strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value
							Case "4"
								strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value
							Case "5"
								strSQL = strSQL & " AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value
						End Select
						'Fin Jonathan Prieto 10/01/2014
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							strSQL = "SELECT A.EV_ID FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " and E.ANO_TABNR=8953"
							
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							strSQL = strSQL & " ORDER BY D.SH_Y DESC"
							
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
										If nomTramS = "" Then
											If rstAux2.Fields("ORDEN_N2").Value = 0 Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											Do While Not rstAux2.EOF
												If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Exit Do
												End If
												rstAux2.MoveNext()
												nomTramS = "PR_FINEXPEDIENTE"
											Loop 
										End If
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									'GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									'**** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					'nomTram = rstAux2("NOM_DIAGRAMA")
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            End If
				'fin aketza
				rstAux.MoveFirst()
				'aketza 29/04/2008
				'If Trim(UCase(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If Trim(UCase(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or Trim(UCase(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
				Else
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
			''''''''''''''''''''''''''
			''''''    Else
			''''''        strSQL = "SELECT * FROM CONECTOR_ACC WHERE " _
			'''''''            & "ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND " _
			'''''''            & "NUM_CONECTOR=" & rstTram("NUM_DIAGRAMA") & " AND " _
			'''''''            & "NUM_SEQ_DESDE=" & rstACC("NUM_SEQ") & " AND " _
			'''''''            & "IND_SALIDA_TRAM='S'"
			''''''        Set rstAUX = mfRecordset(conPasarela, strSQL)
			''''''        If Not rstAUX.EOF Then
			''''''            strSQL = "SELECT * FROM ACCIONES_DI WHERE " _
			'''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			'''''''                & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") _
			'''''''                & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") _
			'''''''                & " AND ORDEN_ACC>" & rstACC("ORDEN_ACC") + 1 _
			'''''''                & " ORDER BY ORDEN_ACC DESC"
			''''''            Set rstAUX2 = mfRecordset(conPasarela, strSQL)
			''''''            While Not rstAUX2.EOF
			''''''                strSQL = "UPDATE ACCIONES_DI SET " _
			'''''''                & "ORDEN_ACC=" & rstAUX2("ORDEN_ACC") + 1 & " WHERE " _
			'''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			'''''''                & " AND ORDEN_N2=" & rstAUX2("ORDEN_N2") _
			'''''''                & " AND ORDEN_N3=" & rstAUX2("ORDEN_N3") _
			'''''''                & " AND ORDEN_N4=" & rstAUX2("ORDEN_N4") _
			'''''''                & " AND ORDEN_N5=" & rstAUX2("ORDEN_N5") _
			'''''''                & " AND ORDEN_ACC=" & rstAUX2("ORDEN_ACC")
			''''''                mfExecute conPasarela, strSQL
			''''''                rstAUX2.MoveNext
			''''''            Wend
			''''''            blnIns = True
			''''''            regPlus = 1 '
			''''''            lngORACC = rstACC("ORDEN_ACC") + 1
			''''''            strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE NOM_ACCION='JUMP'"
			''''''            Set rstACC2 = mfRecordset(conPasarela, strSQL)
			''''''            lngNUMACC = Val(rstACC2(0) & "") + 1
			''''''            strSQL = "INSERT INTO ACCIONES_DI(ORDEN_N1,ORDEN_N2,ORDEN_N3," _
			'''''''                & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
			'''''''                & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
			'''''''                & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") _
			'''''''                & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & "," _
			'''''''                & "'JUMP'," & lngNUMACC & ",'JUMP" & Format(lngNUMACC, "00") & "' )"
			''''''            mfExecute conPasarela, strSQL
			''''''            blnInserta = False
			''''''            msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
			''''''        End If
		End If
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		If rstparamHN.EOF Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas en Corporate no coincide con el número de variables de HidraNet", "fintroDatos")
			Mostrar_Error()
			fIntroDatos = False
		Else
			strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,USERID,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "','" & strUserId & "', 'Introducción de datos', 'Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value & "')"
			'strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "', 'Introducción de datos', 'Ha ocurrido un error no controlado en la acción " & rstAcc("ID_ACCION") & "-" & rstAcc("NOM_ACCION") & " del trámite " & rstTram("NOMBRE") & "')"
			'*****************
			mfExecute(conPasarela, strSQL)
			Insertar_Error(Me, "Introducción de datos", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fintroDatos")
			Mostrar_Error()
			logError("fIntroDatos - " & Err.Description)
		End If
		Resume procFin
		
procFin: 
		
	End Function
	
	
	
	
	
	Private Function fPresen_Mens(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		On Error GoTo procErr
		Dim rstACC2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim lngUlt As Integer
		Dim blnfin As Boolean
		Dim blnPrim As Boolean
		Dim strJOINER As String
		Dim strSQL As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim blnIndValVar As Boolean
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		fPresen_Mens = True
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
		strSQL = strSQL & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		lngAnt = 0
		blnPrim = True
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND DM_INSERTS=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
vuelta: 
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where "
				strSQL = strSQL & "C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND "
				strSQL = strSQL & "E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			Else
				strSQL = "select DISTINCT J.ANO_ID FROM JOINER J Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
				strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
				strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				
				rstconE = mfRecordset(conDP4, strSQL)
				GoTo vuelta
			End If
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> rstparamCME.RecordCount Then
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fPresen_Mens")
					Mostrar_Error()
					fPresen_Mens = False
					Exit Function
				End If
			End If
			System.Windows.Forms.Application.DoEvents()
			lngAnt = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		lngAccConE = lngAnt
		rstAux.Close()
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & " Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & "Where C.CO_ID IN (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID  "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConS = rstParamCMS.RecordCount
			System.Windows.Forms.Application.DoEvents()
		Else
			lngAccConS = 0
		End If
		I = 0
		colXML4 = New Collection
		colXML4.Add("Código de Mensaje")
		colXML4.Add("Indicador Valor Variable")
		colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		If colXMLD.Item(2) <> vbNullString Then
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
		End If
		colXMLD.Remove(2)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, colXMLD.Item(1), rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
		rstparamHN.MoveNext()
		Dim H As Short
		If lngAccConE <> 0 Then
			rstparamCME.MoveFirst()
			'rstParamHN.MoveNext
			colXML4 = New Collection
			System.Windows.Forms.Application.DoEvents()
			For I = 1 To rstparamCME.RecordCount
				colXML4.Add("Código Literal " & I)
			Next I
			colXML4.Add("Indicador Valor Variable")
			colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If colXMLD.Item(2) <> vbNullString Then
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
			End If
			colXMLD.Remove(I)
			I = 0
			For	Each icol In colXMLD
				'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				If icol <> "" Then
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
					I = I + 1
				End If
				rstparamHN.MoveNext()
				'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				If icol = "" And (rstAcc.Fields("NOM_ACCION").Value = "SELECCIONEMPLEADO" Or rstAcc.Fields("NOM_ACCION").Value = "COMPONERBLOQUEDEST" Or rstAcc.Fields("NOM_ACCION").Value = "SELECUNIDTRAM" Or rstAcc.Fields("NOM_ACCION").Value = "SELEPERSONAS") Then
					rstparamHN.MovePrevious()
				End If
				
			Next icol
			
			If I <> lngAccConE And (rstAcc.Fields("NOM_ACCION").Value <> "SELECCIONEMPLEADO" And rstAcc.Fields("NOM_ACCION").Value <> "COMPONERBLOQUEDEST") And rstAcc.Fields("NOM_ACCION").Value <> "SELECUNIDTRAM" And rstAcc.Fields("NOM_ACCION").Value <> "SELEPERSONAS" Then
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fPresen_Mens")
				Mostrar_Error()
				Exit Function
			End If
			
			If (rstAcc.Fields("NOM_ACCION").Value <> "SELECCIONEMPLEADO" And rstAcc.Fields("NOM_ACCION").Value <> "COMPONERBLOQUEDEST" And rstAcc.Fields("NOM_ACCION").Value <> "SELECUNIDTRAM" And rstAcc.Fields("NOM_ACCION").Value <> "SELEPERSONAS") Then
				If I < ((lngacc - 1) / 2) Then
					For H = 1 To Val(CStr(((lngacc - 1) / 2) - (I - 1) - 1))
						rstparamHN.MoveNext()
					Next H
				End If
			End If
			While Not rstparamCME.EOF
				Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
					Case "Constantes"
						colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
						'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strValorV = colXMLD.Item(1)
						If strValorV = "" Then
							'aketza errores
							Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fPresen_Mens")
							'mostramos el btn y el lbl
							Mostrar_Error()
							'fin aketza
						Else
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						End If
					Case ""
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					Case Else
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
						'*msInsertaParamAcc rstParamHN("PARAM"), "@INICIO" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				End Select
				rstparamCME.MoveNext()
				rstparamHN.MoveNext()
			End While
		ElseIf rstparamHN.RecordCount = 2 Then 
			If rstParCME.RecordCount > 0 Then
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstparamHN.MoveNext()
			End If
		ElseIf rstAcc.Fields("NOM_ACCION").Value = "SELECCIONEMPLEADO" Then 
			If rstParCME.RecordCount > 0 Then
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstparamHN.MoveNext()
			End If
		End If
		
		
		If lngAccConS <> 0 Then
			rstParamCMS.MoveFirst()
			If lngAccCMS = lngAccConS Then
				While Not rstParamCMS.EOF
					Select Case rstParamCMS.Fields("EN_NAME").Value
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fPresen_Mens")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
							'*msInsertaParamAcc rstParamHN("PARAM"), "@INICIO" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstParamCMS.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como salida no coincide con el número de parámetros de salida", "fPresen_Mens")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fPresen_Mens = False
				Exit Function
			End If
		Else
			While Not rstParCMS.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
				'*msInsertaParamAcc rstParamHN("PARAM"), "@INICIO" & nomVarHN, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCMS.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					
					
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=0"
					If rstTram.Fields("NUM_DIAGRAMA").Value = 1 Then
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=0"
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 2 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 4 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
					ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 5 Then 
						strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
					End If
					'fin aketza
					
					
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						'aketza 28/08/2007
						'                    strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " _
						''                        & "NUM_SEQ=" & rstConST("NUM_SEC_HASTA") & " AND " _
						''                        & "ID_PADRE=" & rstTram("ID_PADRE")
						
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
						
						'fin aketza
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							strSQL = "SELECT A.EV_ID FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND E.DI_TYPE <> 1 "
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							'******
							strSQL = strSQL & "ORDER BY D.SH_Y DESC"
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
										If nomTramS = "" Then
											If rstAux2.Fields("ORDEN_N2").Value = 0 Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											Else
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >=" & rstAux2.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											Do While Not rstAux2.EOF
												If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Exit Do
												End If
												rstAux2.MoveNext()
												nomTramS = "PR_FINEXPEDIENTE"
											Loop 
										End If
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					'nomTram = rstAux2("NOM_DIAGRAMA")
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'
				'            End If
				'fin aketza
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
			'''''    Else
			'''''        strSQL = "SELECT * FROM CONECTOR_ACC WHERE " _
			''''''            & "ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND " _
			''''''            & "NUM_CONECTOR=" & rstTram("NUM_DIAGRAMA") & " AND " _
			''''''            & "NUM_SEQ_DESDE=" & rstAcc("NUM_SEQ") & " AND " _
			''''''            & "IND_SALIDA_TRAM='S'"
			'''''        Set rstAux = mfRecordset(conPasarela, strSQL)
			'''''        If Not rstAux.EOF Then
			'''''            strSQL = "SELECT * FROM ACCIONES_DI WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC>" & rstAcc("ORDEN_ACC") + 1 _
			''''''                & " ORDER BY ORDEN_ACC DESC"
			'''''            Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'''''            While Not rstAux2.EOF
			'''''                strSQL = "UPDATE ACCIONES_DI SET " _
			''''''                & "ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 1 & " WHERE " _
			''''''                & "ORDEN_N1=" & rstTram("ORDEN_N1") _
			''''''                & " AND ORDEN_N2=" & rstAux2("ORDEN_N2") _
			''''''                & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") _
			''''''                & " AND ORDEN_N4=" & rstAux2("ORDEN_N4") _
			''''''                & " AND ORDEN_N5=" & rstAux2("ORDEN_N5") _
			''''''                & " AND ORDEN_ACC=" & rstAux2("ORDEN_ACC")
			'''''                mfExecute conPasarela, strSQL
			'''''                rstAux2.MoveNext
			'''''            Wend
			'''''            blnIns = True
			'''''            regPlus = 1 '
			'''''            lngOrAcc = rstAcc("ORDEN_ACC") + 1
			'''''            strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE NOM_ACCION='JUMP'"
			'''''            Set rstACC2 = mfRecordset(conPasarela, strSQL)
			'''''            lngNumAcc = Val(rstACC2(0) & "") + 1
			'''''            strSQL = "INSERT INTO ACCIONES_DI(ORDEN_N1,ORDEN_N2,ORDEN_N3," _
			''''''                & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
			''''''                & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
			''''''                & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") _
			''''''                & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngOrAcc & "," _
			''''''                & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
			'''''            mfExecute conPasarela, strSQL
			'''''            blnInserta = False
			'''''            msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngOrAcc
			'''''        End If
		End If
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		logError("fPresen_Mens - " & Err.Description)
		Insertar_Error(Me, "Presentación de mensaje", "La acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " está mal definida.", "fPresen_Mens")
		Mostrar_Error()
		fPresen_Mens = False
		Resume procFin
procFin: 
		
	End Function
	
	Private Function fTD_Aut(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		
		On Error GoTo procErr
		
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstACC2 As ADODB.Recordset
		Dim rstTDCon As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim seq1 As Integer
		Dim seq2 As Integer
		Dim lngUlt As Integer
		Dim blnPrim As Boolean
		Dim blnSalto As Boolean
		Dim blnSalto1 As Boolean
		Dim blnSalto2 As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strSQL As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim strsalto As String
		Dim icol As Object
		Dim arr As Object
		Dim blnFinExp As Boolean
		Dim strAuxiliar As String
		Dim intCont As Short
		'aketza 31/05/2007
		Dim num_seq_desde As Short
		'fin aketza
		'aketza 23/08/2007
		Dim strOrden As String
		'por problemas con el tamaño de la función
		strOrden = " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'fin aketza
		'aketza 31/05/2007
		If rstAcc.Fields("NUM_ACCION").Value = 11 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		'    If tramiteAnterior <> "" Then
		'    If rstTram("Salidas") > 1 And tramiteAnterior <> rstAcc("DI_ID") Then
		'        tramiteAnterior = rstAcc("DI_ID")
		'        strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND RTRIM(CAT_CONECTOR2)='Fin de Expediente' and DI_ID=" & rstAcc("DI_ID")
		'        Set rstACC2 = mfRecordset(conPasarela, strSQL)
		'        If rstACC2.RecordCount > 0 Then
		'            num_seq_desde = rstACC2("num_seq_desde")
		'            strSQL = "SELECT * FROM Acciones_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") & " AND NUM_SEQ=" & num_seq_desde
		'            Set rstACC2 = mfRecordset(conPasarela, strSQL)
		'            If Not rstACC2.EOF Then
		'                If rstACC2("NOM_ACCION") = "TDUSUARIO" Or rstACC2("NOM_ACCION") = "TDAUTOMATICA" Then
		'                    strSQL = "UPDATE DIAGRAMA SET SALIDAS=SALIDAS-1 WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") & " "
		'                    mfExecute conPasarela, strSQL
		'                    rstTram.Requery
		'                End If
		'            End If
		'        End If
		'    End If
		'    End If
		'fin aketza
		If rstAcc.Fields("NUM_ACCION").Value = 9 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		j = 0
		fTD_Aut = True
		colXML2 = New Collection
		colXML2.Add("Valor")
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		lngAnt = 0
		blnPrim = True
		While Not rstAux.EOF
			
			If rstAux.Fields("Cat_Conector").Value = "No cumple" Then
				System.Windows.Forms.Application.DoEvents()
			End If
			
			If rstAux.RecordCount > 1 Then
				System.Windows.Forms.Application.DoEvents()
			End If
			
			strSQL = "Select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & " Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value
			strSQL = strSQL & " AND DI_ID=" & rstAux.Fields("DI_ID").Value & " AND  DM_INSERTS=1" '## 15/12/09 DS66 En vez de rstAcc("DI_ID") porque en algunos casos no coinciden.
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				strJOINER = rstconE.Fields(0).Value
				strSQL = "SELECT C.AT_ID, A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
				strSQL = strSQL & " Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID"
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				'strSQL = strSQL & " ORDER BY C.DM_ID"
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
				intCont = rstparamCME.RecordCount
			Else
				'UPGRADE_NOTE: Object rstparamCME may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
				rstparamCME = Nothing
				intCont = 0
			End If
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> intCont Then
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fTD_Aut")
					Mostrar_Error()
					mfExecute(conPasarela, strSQL)
					fTD_Aut = False
					Exit Function
				End If
			End If
			System.Windows.Forms.Application.DoEvents()
			If intCont = 0 Then
				lngAnt = 0
			Else
				lngAnt = rstparamCME.RecordCount
			End If
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & "  Where C.CO_ID IN (" & strJOINER & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			'strSQL = strSQL & " ORDER BY C.DM_ID"
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			lngAccConE = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
		Else
			lngAccConE = 0
		End If
		rstAux.Close()
		If Not rstparamCME.EOF Then
			If lngAccCME = lngAccConE Then
				While Not rstparamCME.EOF
					Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(RTrim(rstparamCME.Fields("AT_NAME").Value), "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTD_Aut")
								Mostrar_Error()
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstparamCME.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & Trim(rstTram.Fields("NOMBRE").Value) & " el número de variables  asignadas como entrada no coincide con el número de parámetros de entrada", "fTD_Aut")
				Mostrar_Error()
				fTD_Aut = False
				Exit Function
			End If
		Else
			While Not rstParCME.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCME.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		strSQL = "SELECT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR='Cumple' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value
		rstTDCon = mfRecordset(conPasarela, strSQL)
		If rstTDCon.EOF Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el conector de categoria Cumple en la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTD_Aut")
			Mostrar_Error()
			fTD_Aut = False : Exit Function
		End If
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstTDCon.Fields(0).Value & " AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			blnSalto = False
			If rstAux.Fields("NOM_ACCION").Value = "PROCESOFALSO" Then
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC= " & rstAux.Fields("ORDEN_ACC").Value + 1
				rstAux = mfRecordset(conPasarela, strSQL)
			End If
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rstAux.Fields("PATH_HIDRA").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
		Else
			If rstTram.Fields("SALIDAS").Value > 1 Then
				blnSalto = True
				If rstAcc.Fields("NUM_ACCION").Value > 99 Then
					strsalto = "LET" & Mid(rstAcc.Fields("PATH_HIDRA").Value, 1, 12) & Mid(rstAcc.Fields("PATH_HIDRA").Value, Len(rstAcc.Fields("PATH_HIDRA").Value) - 2)
				Else
					strsalto = "LET" & Mid(rstAcc.Fields("PATH_HIDRA").Value, 1, 13) & Mid(rstAcc.Fields("PATH_HIDRA").Value, Len(rstAcc.Fields("PATH_HIDRA").Value) - 1)
				End If
				blnSalto1 = True
				seq1 = rstTDCon.Fields(0).Value
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strsalto & "SALTO01", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			Else
				blnSalto = False
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			End If
		End If
		'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		If rstTram.Fields("SALIDAS").Value > 1 And blnSalto = True Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='S' and CAT_CONECTOR='Cumple'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui2
				End If
				strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & " WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' "
				strSQL = strSQL & " AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					'strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram("ID_PADRE") & " AND NUM_SEC_DESDE=" & rstTram("NUM_SEQ") & " AND CAT_CONECTOR not in ('Conector Opcional','Fin de plazo 2')"
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') and RTRIM(CAT_CONECTOR2) <>'Fin de Expediente' and TIPO_CONECTOR=0"
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						'aketza 23/08/2007
						'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST("NUM_SEC_HASTA") & " AND ID_PADRE=" & rstTram("ID_PADRE") & " AND ORDEN_N1 > =  " & rstTram("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstTram.Fields("ORDEN_N1").Value & strOrden
						'fin aketza
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						If rstTRAMS.RecordCount > 1 Then rstTRAMS.Filter = "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
						If rstTRAMS.RecordCount = 0 Then rstTRAMS.Filter = ""
						If Not rstTRAMS.EOF Then
							While Not rstTRAMS.EOF
								'*cambio importante
								'UPGRADE_NOTE: Object rstAux4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
								rstAux4 = Nothing
								strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value
								' **** NUEVO SD ENERO'08
								strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
								strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
								strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
								strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
								'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
								strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
								'Fin Jonathan Prieto 28/10/2010
								strSQL = strSQL & " ORDER BY D.SH_Y DESC"
								
saltotrucado2: 
								If rstTRAMS.EOF Then
									strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_PADRE").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									strSQL = strSQL & " ORDER BY D.SH_Y ASC"
								Else
									strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									strSQL = strSQL & " ORDER BY D.SH_Y DESC"
								End If
								rstAux3 = mfRecordset(conDP4, strSQL)
								If Not rstAux3.EOF Then
									If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
										msPruebaTDAUTOMATICA(blnfin, blnSalto, blnSalto1, blnSalto2, strSQL, rstAux2, lngNumAcc, lngUlt, lngORACC, blnInserta, nomTram, nomTramS, rstAux5, strsalto, rstTram, rstAux3, rstTRAMS, rstAux4, rstAux6, strAuxiliar, rstACC2, rstAcc, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value)
										GoTo aqui2
										
									End If
								Else
									'''''''''''''''''''
									'CAMBIO PENDIENTE
									''''''''''''''''''''
									If rstTRAMS.EOF Then
										blnFinExp = True
										blnfin = True
										GoTo saltoafinexp
									End If
									If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
										strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
										If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
											strSQL = strSQL & " AND ORDEN_N2=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
										End If
										If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N3=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
										End If
										If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N4=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
										End If
										If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N5=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
										End If
										rstAux4 = mfRecordset(conPasarela, strSQL)
										strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
										strSQL = strSQL & " WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado'"
										strSQL = strSQL & " AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
										' **** NUEVO SD ENERO'08
										strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
										rstAux3 = mfRecordset(conDP4, strSQL)
										If Not rstAux3.EOF Then
											If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
												blnfin = True
saltoafinexp: 
												If blnSalto = False Then
													strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
												Else
													strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION like '" & strsalto & "SALTO%'"
												End If
												rstAux2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
												strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
												rstAux2 = mfRecordset(conPasarela, strSQL)
												While Not rstAux2.EOF
													strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL)
													lngUlt = rstAux2.Fields("ORDEN_ACC").Value
													strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL)
													rstAux2.MoveNext()
												End While
												If lngUlt <> 0 Then
													lngORACC = lngUlt
												Else
													strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
													rstAux3 = mfRecordset(conPasarela, strSQL)
													lngORACC = rstAux3.Fields(0).Value + 1
												End If
												j = j + 1
												If blnSalto = False Then
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
												Else
													If rstAux.Fields("NUM_SEQ_HASTA").Value = seq1 Then
														strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
													ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq2 Then 
														strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
													End If
												End If
												mfExecute(conPasarela, strSQL)
												blnInserta = False
												strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux2 = mfRecordset(conPasarela, strSQL)
												If Not rstAux2.EOF Then
													nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
												Else
													nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
												End If
												If blnFinExp = True Then
													nomTramS = "PR_FINEXPEDIENTE"
													blnFinExp = False
												Else
													strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
													rstAux2 = mfRecordset(conPasarela, strSQL)
													If Not rstAux2.EOF Then
														nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Else
														nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
													End If
												End If
												msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
												rstACC2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
												lngORACC = lngORACC + 1
												strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
												mfExecute(conPasarela, strSQL)
												blnInserta = False
												blnIns = True
												regPlus = regPlus + 1 '
												msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											End If
										End If
										'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									End If
								End If
								If Not rstTRAMS.EOF Then
									rstTRAMS.MoveNext()
								End If
							End While
						Else
							'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
							'busqueda para arriba
							'aketza 28/08/2007
							strAuxiliar = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
							'fin aketza
							If rstTram.Fields("ORDEN_N3").Value = 0 Then
								'aketza 28/08/2007
								'strSQL = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=0"
								strSQL = strAuxiliar & " AND ORDEN_N2=0"
								'fin aketza
								rstTRAMS = mfRecordset(conPasarela, strSQL)
								strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value
								rstAux3 = mfRecordset(conPasarela, strSQL)
							ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
								'aketza 28/08/2007
								'strSQL = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " and ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=0"
								strSQL = strAuxiliar & " and ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=0"
								'fin aketza
								rstTRAMS = mfRecordset(conPasarela, strSQL)
								strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								rstAux3 = mfRecordset(conPasarela, strSQL)
							ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
								'aketza 28/08/2007
								'strSQL = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " and ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=0"
								strSQL = strAuxiliar & " and ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=0"
								'aketza 28/08/2007
								rstTRAMS = mfRecordset(conPasarela, strSQL)
								strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								rstAux3 = mfRecordset(conPasarela, strSQL)
								'## DS66 02/12/09   Cuando no cumple los if no tenia valor y cascaba
							Else
								'strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "DS66'"
								'Set rstAux3 = mfRecordset(conPasarela, strSQL)
								
								
								strSQL = strAuxiliar & " and ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=0"
								rstTRAMS = mfRecordset(conPasarela, strSQL)
								strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								rstAux3 = mfRecordset(conPasarela, strSQL)
								
								
								'## DS66
							End If
							While Not rstAux3.EOF
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
								rstAux4 = mfRecordset(conPasarela, strSQL)
								If Not rstAux4.EOF Then
									strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									strSQL = strSQL & " ORDER BY D.SH_Y DESC"
									rstAux5 = mfRecordset(conDP4, strSQL)
									If rstAux5.Fields("EV_ID").Value = rstConS.Fields("EV_ID").Value Then
										msPruebaTDAUTOMATICA(blnfin, blnSalto, blnSalto1, blnSalto2, strSQL, rstAux2, lngNumAcc, lngUlt, lngORACC, blnInserta, nomTram, nomTramS, rstAux5, strsalto, rstTram, rstAux3, rstTRAMS, rstAux4, rstAux6, strAuxiliar, rstACC2, rstAcc, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value)
										GoTo aqui2
									End If
								End If
								rstAux3.MoveNext()
							End While
							GoTo saltotrucado2
							
						End If
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui2: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				j = j + 1
				If blnSalto = False Then
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				Else
					If blnSalto1 = True And j = 1 Then
						strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
					Else
						'CAMBIO IGOR OJO
						strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
					End If
				End If
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
				strSQL = strSQL & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				
				
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
					'Inicio Jonathan Prieto 08/08/2012: no hacer ninguna llamada a mfBuscaTramiteTDUSuperior
					'nomTramS = mfBuscaTramiteTDUSuperior(rstTram, rstAux)
					'Fin Jonathan Prieto 08/08/2012
				End If
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
		End If
		'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		rstparamHN.MoveNext()
		strSQL = "SELECT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR='No cumple' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value
		rstTDCon = mfRecordset(conPasarela, strSQL)
		If rstTDCon.EOF Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el conector de categoria No Cumple en la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTD_Aut")
			Mostrar_Error()
			fTD_Aut = False
			Exit Function
		End If
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstTDCon.Fields(0).Value & " AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		blnSalto = False
		blnSalto1 = False
		If Not rstAux.EOF Then
			blnSalto = False
			If rstAux.Fields("NOM_ACCION").Value = "PROCESOFALSO" Then
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC= " & rstAux.Fields("ORDEN_ACC").Value + 1
				rstAux = mfRecordset(conPasarela, strSQL)
			End If
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rstAux.Fields("PATH_HIDRA").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
		Else
			If rstTram.Fields("SALIDAS").Value > 1 Then
				blnSalto = True
				If rstAcc.Fields("NUM_ACCION").Value > 99 Then
					strsalto = "LET" & Mid(rstAcc.Fields("PATH_HIDRA").Value, 1, 12) & Mid(rstAcc.Fields("PATH_HIDRA").Value, Len(rstAcc.Fields("PATH_HIDRA").Value) - 2)
				Else
					strsalto = "LET" & Mid(rstAcc.Fields("PATH_HIDRA").Value, 1, 13) & Mid(rstAcc.Fields("PATH_HIDRA").Value, Len(rstAcc.Fields("PATH_HIDRA").Value) - 1)
				End If
				blnSalto2 = True
				seq2 = rstTDCon.Fields(0).Value
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strsalto & "SALTO02", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			Else
				blnSalto = False
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			End If
		End If
		blnfin = False
		j = 0
		If rstTram.Fields("SALIDAS").Value > 1 And blnSalto = True Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='S' and CAT_CONECTOR='No cumple'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			nomTramS = ""
			While Not rstAux.EOF
				'If Trim(rstAux("CAT_CONECTOR2")) = "Fin de Expediente" Then
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT DISTINCT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') and RTRIM(CAT_CONECTOR2)<>'Fin de Expediente' and TIPO_CONECTOR=0" & IIf(rstTram.Fields("NUM_DIAGRAMA").Value > 1, " AND ORDEN_N1= " & rstTram.Fields("ORDEN_N1").Value, "")
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstTram.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						If rstTRAMS.RecordCount > 1 Then
							rstTRAMS.Filter = "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
						End If
						If rstTRAMS.RecordCount = 0 Then
							rstTRAMS.Filter = ""
						End If
						If Not rstTRAMS.EOF Then
							While Not rstTRAMS.EOF
								'*cambio importante
								'UPGRADE_NOTE: Object rstAux4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
								rstAux4 = Nothing
								'aketza 23/08/2007
								strAuxiliar = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 "
								strAuxiliar = strAuxiliar & "AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND "
								strAuxiliar = strAuxiliar & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & "  AND E.ANO_TABNR=8953"
								' **** NUEVO SD ENERO'08
								strAuxiliar = strAuxiliar & " AND A.MODEL_NAME ='" & strModelo & "'"
								strAuxiliar = strAuxiliar & " AND B.MODEL_NAME ='" & strModelo & "'"
								strAuxiliar = strAuxiliar & " AND D.MODEL_NAME ='" & strModelo & "'"
								strAuxiliar = strAuxiliar & " AND E.MODEL_NAME ='" & strModelo & "'"
								'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
								strAuxiliar = strAuxiliar & " AND E.DI_TYPE <> " & gstrCodTramUsu
								'Fin Jonathan Prieto 28/10/2010
								strSQL = strAuxiliar & " AND A.EV_DESCRIPTION Is Null ORDER BY D.SH_Y DESC"
								'fin aketza
								
								rstAux3 = mfRecordset(conDP4, strSQL)
								If rstAux3.EOF Then
									strSQL = strAuxiliar & " ORDER BY D.SH_Y DESC"
									rstAux3 = mfRecordset(conDP4, strSQL)
								End If
								
saltotrucado: 
								
								strAuxiliar = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 "
								strAuxiliar = strAuxiliar & "AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID "
								strAuxiliar = strAuxiliar & "AND E.ANO_TABNR=8953"
								' **** NUEVO SD ENERO'08
								strAuxiliar = strAuxiliar & " AND A.MODEL_NAME ='" & strModelo & "'"
								strAuxiliar = strAuxiliar & " AND B.MODEL_NAME ='" & strModelo & "'"
								strAuxiliar = strAuxiliar & " AND D.MODEL_NAME ='" & strModelo & "'"
								strAuxiliar = strAuxiliar & " AND E.MODEL_NAME ='" & strModelo & "'"
								'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
								strAuxiliar = strAuxiliar & " AND E.DI_TYPE <> " & gstrCodTramUsu
								'Fin Jonathan Prieto 28/10/2010
								If rstTRAMS.EOF Then
									strSQL = strAuxiliar & " AND E.ANO_ID=" & rstTram.Fields("ID_PADRE").Value & " ORDER BY D.SH_Y ASC"
								Else
									strSQL = strAuxiliar & " AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " ORDER BY D.SH_Y DESC"
								End If
								rstAux3 = mfRecordset(conDP4, strSQL)
								If Not rstAux3.EOF Then
									If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
										''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
										'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
										msPruebaTDAUTOMATICA(blnfin, blnSalto, blnSalto1, blnSalto2, strSQL, rstAux2, lngNumAcc, lngUlt, lngORACC, blnInserta, nomTram, nomTramS, rstAux5, strsalto, rstTram, rstAux3, rstTRAMS, rstAux4, rstAux6, strAuxiliar, rstACC2, rstAcc, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value)
										GoTo aqui
										blnfin = True
										'aketza 31/8/2006
										strAuxiliar = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION"
										If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
											'strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
											strSQL = strAuxiliar & " = 'LET INICIALIZACIONVAR'"
										Else
											'strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION like '" & strSalto & "SALTO%'"
											strSQL = strAuxiliar & " like '" & strsalto & "SALTO%'"
										End If
										rstAux2 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
										strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
										rstAux2 = mfRecordset(conPasarela, strSQL)
										While Not rstAux2.EOF
											strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
											mfExecute(conPasarela, strSQL)
											strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
											mfExecute(conPasarela, strSQL)
											lngUlt = rstAux2.Fields("ORDEN_ACC").Value
											rstAux2.MoveNext()
										End While
										If lngUlt <> 0 Then
											lngORACC = lngUlt
										Else
											strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux3 = mfRecordset(conPasarela, strSQL)
											lngORACC = rstAux3.Fields(0).Value + 1
										End If
										j = j + 1
										If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
										Else
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
										End If
										mfExecute(conPasarela, strSQL)
										blnInserta = False
										strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux2 = mfRecordset(conPasarela, strSQL)
										If Not rstAux2.EOF Then
											nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
										Else
											nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
										End If
										If Not rstTRAMS.EOF Then
											strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
										Else
											'aketza 23/08/2007
											strAuxiliar = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & ""
											'fin aketza
											If rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then
												'aketza 23/08/2007
												'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=0"
												strSQL = strAuxiliar & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=0"
												'fin aketza
											Else
												'aketza 23/08/2007
												'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=0"
												strSQL = strAuxiliar & " AND ORDEN_N2=0"
												'fin aketza
											End If
											rstAux4 = mfRecordset(conPasarela, strSQL)
											'aketza 23/08/2007
											strAuxiliar = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
											'fin aketza
											If rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then
												'aketza 23/08/2007
												'strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DI_ID=" & rstAux4("DI_ID") & " AND NUM_SEC_DESDE=" & rstAux4("NUM_SEQ") & " AND CAT_CONECTOR not in ('Conector Opcional','Fin de plazo 2')"
												strSQL = strAuxiliar & " AND DI_ID=" & rstAux4.Fields("DI_ID").Value & " AND NUM_SEC_DESDE=" & rstAux4.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR not in ('Conector Opcional','Fin de plazo 2')"
												'fin aketza
											Else
												'aketza 23/08/2007
												'strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux4("DI_ID") & " AND NUM_SEC_DESDE=" & rstAux4("NUM_SEQ") & " AND CAT_CONECTOR not in ('Conector Opcional','Fin de plazo 2')"
												strSQL = strAuxiliar & " AND DIAGRAMA=" & rstAux4.Fields("DI_ID").Value & " AND NUM_SEC_DESDE=" & rstAux4.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR not in ('Conector Opcional','Fin de plazo 2')"
												'fin aketza
											End If
											rstAux5 = mfRecordset(conPasarela, strSQL)
											If rstAux5.EOF Then
												nomTramS = "ENLACE SIN DEFINIR"
												'Inicio Jonathan Prieto 08/08/2012: no hacer ninguna llamada a mfBuscaTramiteTDUSuperior
												'nomTramS = mfBuscaTramiteTDUSuperior(rstTram, rstAux)
												'Fin Jonathan Prieto 08/08/2012
												GoTo meteramas
											End If
											'aketza 23/08/2007
											strAuxiliar = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
											'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux5("NUM_SEC_HASTA") & " AND ID_PADRE=" & rstAux4("ID_PADRE") & " AND ORDEN_N1 > =  " & rstAux4("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											strSQL = strAuxiliar & " AND NUM_SEQ=" & rstAux5.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstAux4.Fields("ORDEN_N1").Value & strOrden
											'fin aketza
											rstAux6 = mfRecordset(conPasarela, strSQL)
											If rstAux6.EOF Then
												rstAux5.MoveNext()
												If Not rstAux5.EOF Then
													'aketza23/08/2007
													'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux5("NUM_SEC_HASTA") & " AND ID_PADRE=" & rstAux4("ID_PADRE") & " AND ORDEN_N1 > =  " & rstAux4("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													strSQL = strAuxiliar & " AND NUM_SEQ=" & rstAux5.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstAux4.Fields("ORDEN_N1").Value & strOrden
													'fin aketza
													rstAux6 = mfRecordset(conPasarela, strSQL)
													If rstAux6.EOF Then
														'aketza 23/08/2007
														'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux4("ID_PADRE") & " AND ORDEN_N1 > " & rstAux4("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
														strSQL = strAuxiliar & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > " & rstAux4.Fields("ORDEN_N1").Value & strOrden
														'fin aketza
														rstAux6 = mfRecordset(conPasarela, strSQL)
													End If
												Else
													'aketza 23/08/2007
													'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux4("ID_PADRE") & " AND ORDEN_N1 > " & rstAux4("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													strSQL = strAuxiliar & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > " & rstAux4.Fields("ORDEN_N1").Value & strOrden
													'fin aketza
													rstAux6 = mfRecordset(conPasarela, strSQL)
												End If
											End If
											'aketza 17/11/2006
											If rstAux6.EOF Then
												'aketza 23/08/2007
												'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > " & rstAux4("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												strSQL = strAuxiliar & " AND ORDEN_N1 > " & rstAux4.Fields("ORDEN_N1").Value & strOrden
												'fin aketza
												rstAux6 = mfRecordset(conPasarela, strSQL)
												If rstAux6.EOF Then
													nomTramS = "PR_FINEXPEDIENTE"
												Else
													strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
													rstAux2 = mfRecordset(conPasarela, strSQL)
												End If
											Else
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
												rstAux2 = mfRecordset(conPasarela, strSQL)
											End If
											'fin aketza
										End If
										If Not rstAux2.EOF Then
											nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											If nomTramS = "" Then
												'aketza 23/08/2007
												strAuxiliar = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
												'fin aketza
												If rstAux2.Fields("ORDEN_N2").Value = 0 Then
													'aketza 23/08/2007
													'strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													strSQL = strAuxiliar & " AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & strOrden
													'fin aketza
												ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
													'aketza 23/08/2007
													'strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND ORDEN_N2 >= " & rstAux2("ORDEN_N2") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													strSQL = strAuxiliar & " AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & strOrden
													'fin aketza
												ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
													'aketza 23/08/2007
													'strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND ORDEN_N2 = " & rstAux2("ORDEN_N2") & " AND ORDEN_N3 >=" & rstAux2("ORDEN_N3") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													strSQL = strAuxiliar & " AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & strOrden
													'fin aketza
												ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
													'aketza 23/08/2007
													'strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND ORDEN_N2 = " & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND ORDEN_N4 >=" & rstAux2("ORDEN_N4") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													strSQL = strAuxiliar & " AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & strOrden
													'fin aketza
													'aketza 30/8/2006
												Else
													'aketza 23/08/2007
													'strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND ORDEN_N2 = " & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND ORDEN_N4 =" & rstAux2("ORDEN_N4") & " AND ORDEN_N5 >=" & rstAux2("ORDEN_N5") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													strSQL = strAuxiliar & "  AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 =" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >=" & rstAux2.Fields("ORDEN_N5").Value & strOrden
													'fin aketza
													'fin aketza
												End If
												rstAux2 = mfRecordset(conPasarela, strSQL)
												
												Do While Not rstAux2.EOF
													If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
														nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
														Exit Do
													End If
													rstAux2.MoveNext()
													nomTramS = "PR_FINEXPEDIENTE"
												Loop 
											End If
										Else
											nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
										End If
meteramas: 
										msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
										rstACC2 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
										mfExecute(conPasarela, strSQL) : blnInserta = False : blnIns = True : regPlus = regPlus + 1 '
										msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
										''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
										GoTo aqui
									End If
								Else
									'''''''''''''''''''
									If rstTRAMS.EOF Then GoTo aqui
									If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
										strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
										If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
											strSQL = strSQL & " AND ORDEN_N2=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
										End If
										If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N3=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
										End If
										If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N4=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
										End If
										If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N5=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
										End If
										rstAux4 = mfRecordset(conPasarela, strSQL)
										'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
										strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
										strSQL = strSQL & " WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado'"
										strSQL = strSQL & " AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
										' **** NUEVO SD ENERO'08
										strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
										
										rstAux3 = mfRecordset(conDP4, strSQL)
										If Not rstAux3.EOF Then
											If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
												blnfin = True
												'aketza 23/08/2007
												strAuxiliar = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
												'fin aketza
												If blnSalto = False Then
													'aketza 23/08/2007
													'strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
													strSQL = strAuxiliar & " AND NOM_ACCION='LET INICIALIZACIONVAR'"
													'fin aketza
												Else
													'aketza 23/08/2007
													'strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION like '" & strsalto & "SALTO%'"
													strSQL = strAuxiliar & " AND NOM_ACCION like '" & strsalto & "SALTO%'"
													'fin aketza
												End If
												rstAux2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
												strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
												rstAux2 = mfRecordset(conPasarela, strSQL)
												While Not rstAux2.EOF
													strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL) : lngUlt = rstAux2.Fields("ORDEN_ACC").Value
													strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL) : rstAux2.MoveNext()
												End While
												If lngUlt <> 0 Then
													lngORACC = lngUlt
												Else
													strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
													rstAux3 = mfRecordset(conPasarela, strSQL)
													lngORACC = rstAux3.Fields(0).Value + 1
												End If
												j = j + 1
												If blnSalto = False Then
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
												Else
													If rstAux.Fields("NUM_SEQ_HASTA").Value = seq1 Then
														strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
													ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq2 Then 
														strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
													End If
												End If
												mfExecute(conPasarela, strSQL)
												blnInserta = False
												'aketza 18/9/2006
												'strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5")
												strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE  PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												'fin aketza
												rstAux2 = mfRecordset(conPasarela, strSQL)
												If Not rstAux2.EOF Then
													nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
												Else
													nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
												End If
												strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
												rstAux2 = mfRecordset(conPasarela, strSQL)
												If Not rstAux2.EOF Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
												Else
													nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
												End If
												msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
												rstACC2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
												lngORACC = lngORACC + 1
												strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
												mfExecute(conPasarela, strSQL)
												blnInserta = False
												blnIns = True
												regPlus = regPlus + 1 '
												msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											End If
										End If
										'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									End If
								End If
								If Not rstTRAMS.EOF Then
									rstTRAMS.MoveNext()
								End If
							End While
						Else
							'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
							If Not rstConST.EOF Then
								'aketza 23/08/2007
								strAuxiliar = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								'fin aketza
								If rstTram.Fields("ORDEN_N3").Value = 0 Then
									'aketza 23/08/2007
									'strSQL = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=0"
									strSQL = strAuxiliar & " AND ORDEN_N2=0"
									'fin aketza
									rstTRAMS = mfRecordset(conPasarela, strSQL)
									strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value
									rstAux3 = mfRecordset(conPasarela, strSQL)
								ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
									'aketza 23/08/2007
									'strSQL = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " and ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=0"
									strSQL = strAuxiliar & " and ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=0"
									'fin aketza
									rstTRAMS = mfRecordset(conPasarela, strSQL)
									strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
									rstAux3 = mfRecordset(conPasarela, strSQL)
								ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
									'aketza 23/08/2007
									'strSQL = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " and ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=0"
									strSQL = strAuxiliar & " and ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=0"
									'fin aketza''
									rstTRAMS = mfRecordset(conPasarela, strSQL)
									strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
									rstAux3 = mfRecordset(conPasarela, strSQL)
									'## DS66 02/12/09   Cuando no cumple los if no tenia valor y cascaba
								Else
									'strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "DS66'"
									'Set rstAux3 = mfRecordset(conPasarela, strSQL)
									
									
									strSQL = strAuxiliar & " and ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=0"
									rstTRAMS = mfRecordset(conPasarela, strSQL)
									strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEC_DESDE = " & rstTRAMS.Fields("NUM_SEQ").Value & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
									rstAux3 = mfRecordset(conPasarela, strSQL)
									
									'##
								End If
								While Not rstAux3.EOF
									'aketza23/08/2007
									strAuxiliar = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rstTRAMS.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
									'fin aketza
									If rstTRAMS.Fields("NUM_DIAGRAMA").Value = 1 Then
										'aketza 23/08/2007
										'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEQ=" & rstAux3("NUM_SEC_HASTA")
										strSQL = strAuxiliar
										'fin aketza
									ElseIf rstTRAMS.Fields("NUM_DIAGRAMA").Value = 2 Then 
										'aketza 23/08/2007
										'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEQ=" & rstAux3("NUM_SEC_HASTA") & " AND ORDEN_N1 >= " & rstTRAMS("ORDEN_N1")
										strSQL = strAuxiliar & " AND ORDEN_N1 >= " & rstTRAMS.Fields("ORDEN_N1").Value
										'fin aketza
									ElseIf rstTRAMS.Fields("NUM_DIAGRAMA").Value = 3 Then 
										'aketza 23/08/2007
										'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEQ=" & rstAux3("NUM_SEC_HASTA") & " AND ORDEN_N1 = " & rstTRAMS("ORDEN_N1") & " AND ORDEN_N2 >= " & rstTRAMS("ORDEN_N2")
										strSQL = strAuxiliar & " AND ORDEN_N1 = " & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstTRAMS.Fields("ORDEN_N2").Value
										'fin aketza
									ElseIf rstTRAMS.Fields("NUM_DIAGRAMA").Value = 4 Then 
										'aketza 23/08/2007
										'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEQ=" & rstAux3("NUM_SEC_HASTA") & " AND ORDEN_N1 = " & rstTRAMS("ORDEN_N1") & " AND ORDEN_N2 = " & rstTRAMS("ORDEN_N2") & " AND ORDEN_N3 >= " & rstTRAMS("ORDEN_N3")
										strSQL = strAuxiliar & " AND ORDEN_N1 = " & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >= " & rstTRAMS.Fields("ORDEN_N3").Value
										'fin aketza
									End If
									rstAux4 = mfRecordset(conPasarela, strSQL)
									If Not rstAux4.EOF Then
										
										strAuxiliar = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value & " AND E.ANO_TABNR=8953"
										
										' **** NUEVO SD ENERO'08
										strAuxiliar = strAuxiliar & " AND A.MODEL_NAME ='" & strModelo & "'"
										strAuxiliar = strAuxiliar & " AND B.MODEL_NAME ='" & strModelo & "'"
										strAuxiliar = strAuxiliar & " AND D.MODEL_NAME ='" & strModelo & "'"
										strAuxiliar = strAuxiliar & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strAuxiliar = strAuxiliar & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
										strSQL = strAuxiliar & " AND A.EV_DESCRIPTION is null ORDER BY D.SH_Y DESC"
										'fin aketza
										rstAux5 = mfRecordset(conDP4, strSQL)
										If rstAux5.EOF Then
											'aketza 23/08/2007
											'strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4("ID_DIAGRAMA") & " ORDER BY D.SH_Y DESC"
											strSQL = strAuxiliar & " ORDER BY D.SH_Y DESC"
											'fin aketza
											rstAux5 = mfRecordset(conDP4, strSQL)
										End If
										''''cambio
										If Not rstAux5.EOF Then
											If rstAux5.Fields("EV_ID").Value = rstConS.Fields("EV_ID").Value Then
												msPruebaTDAUTOMATICA(blnfin, blnSalto, blnSalto1, blnSalto2, strSQL, rstAux2, lngNumAcc, lngUlt, lngORACC, blnInserta, nomTram, nomTramS, rstAux5, strsalto, rstTram, rstAux3, rstTRAMS, rstAux4, rstAux6, strAuxiliar, rstACC2, rstAcc, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value)
												GoTo aqui
											End If
										End If
									End If
									rstAux3.MoveNext()
								End While
								'msPruebaTDAUTOMATICA blnfin, blnSalto, blnSalto1, blnSalto2, strSQL, rstAux2, lngNumAcc, lngUlt, lngORACC, blnInserta, nomTram, nomTramS, rstAUX5, strsalto, rstTram, rstAux3, rstTRAMS, rstAUX4, rstAUX6, strAuxiliar, rstACC2, rstAcc, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5")
								GoTo saltotrucado
							End If
						End If
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1 : strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value : mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value : mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				j = j + 1
				If blnSalto = False Then
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				Else
					
					strAuxiliar = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO"
					If blnSalto1 = True Then
						strSQL = strAuxiliar & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
					Else
						strSQL = strAuxiliar & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
					End If
				End If
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
					'Inicio Jonathan Prieto 08/08/2012: no hacer ninguna llamada a mfBuscaTramiteTDUSuperior
					'nomTramS = mfBuscaTramiteTDUSuperior(rstTram, rstAux)
					'Fin Jonathan Prieto 08/08/2012
				End If
				
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
		End If
		If regPlus <> 0 Then regPlus = 1
		GoTo procFin
procErr: 
		
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Toma de decisión automática", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTD_Aut")
		Mostrar_Error()
		logError("fTD_Aut - " & Err.Description)
		Resume procFin
procFin: 
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rstAux2)
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		CierraRS(rstAux3)
		'UPGRADE_NOTE: Object rstAux3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux3 = Nothing
		CierraRS(rstAux4)
		'UPGRADE_NOTE: Object rstAux4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux4 = Nothing
		CierraRS(rstParamCMS)
		'UPGRADE_NOTE: Object rstParamCMS may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstParamCMS = Nothing
		CierraRS(rstparamCME)
		'UPGRADE_NOTE: Object rstparamCME may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstparamCME = Nothing
		CierraRS(rstconE)
		'UPGRADE_NOTE: Object rstconE may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstconE = Nothing
		CierraRS(rstConS)
		'UPGRADE_NOTE: Object rstConS may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstConS = Nothing
		CierraRS(rstConST)
		'UPGRADE_NOTE: Object rstConST may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstConST = Nothing
		CierraRS(rstTRAMS)
		'UPGRADE_NOTE: Object rstTRAMS may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTRAMS = Nothing
		CierraRS(rstACC2)
		'UPGRADE_NOTE: Object rstACC2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstACC2 = Nothing
		CierraRS(rstTDCon)
		'UPGRADE_NOTE: Object rstTDCon may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTDCon = Nothing
		CierraRS(rstAux5)
		'UPGRADE_NOTE: Object rstAux5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux5 = Nothing
		CierraRS(rstAux6)
		'UPGRADE_NOTE: Object rstAux6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux6 = Nothing
		'UPGRADE_NOTE: Object colXMLD may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		colXMLD = Nothing
		'UPGRADE_NOTE: Object colXML2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		colXML2 = Nothing
		'UPGRADE_NOTE: Object colXML4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		colXML4 = Nothing
	End Function
	
	
	
	
	
	
	Private Function fTD_Usu(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstACC2 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstTDCon As ADODB.Recordset
		Dim rstUlt As ADODB.Recordset
		Dim nomTramS As String
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim I As Integer
		Dim strValorV As String
		Dim nomVarHN As String
		Dim strJOINER As String
		Dim strAnt As String
		Dim strAnt5 As String
		Dim strAnt6 As String
		Dim strAnt7 As String
		Dim strAnt8 As String
		Dim blnPrim As Boolean
		Dim blnError As Boolean
		Dim blnSalto As Boolean
		Dim colXMLD As Collection
		Dim colXMLD5 As Collection
		Dim colXMLD6 As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim colXML5 As Collection
		Dim colXML6 As Collection
		Dim icol As Object
		Dim strsalto As String
		Dim blnfin As Boolean
		Dim lngNumAcc As Integer
		Dim lngUlt As Integer
		Dim lngORACC As Integer
		Dim nomTram As String
		Dim blnSalto1 As Boolean
		Dim blnSalto2 As Boolean
		Dim j As Integer
		Dim seq1 As Integer
		Dim seq2 As Integer
		'Inicio Jonathan Prieto 23/02/2011: No estaba bien diseñada para crear saltos de salida de TDUSUARIO a partir del parámetro de @SALTO3
		Dim seq3 As Integer
		Dim seq4 As Integer
		Dim seq5 As Integer
		'Fin Jonathan Prieto 23/02/2011
		Dim numSalto As Integer
		Dim numSalto2 As Integer
		Dim blnIndValVar As Boolean
		Dim rstSalto As ADODB.Recordset
		Dim strAuxSalto As String
		Dim num_seq_desde As Short
		Dim auxCont As Short
		Dim auxI As Short
		Dim bool As Boolean
		
		On Error GoTo procErr
		
		If rstAcc.Fields("NUM_ACCION").Value = 10 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		
		If rstTram.Fields("ORDEN_N1").Value = 2 And rstTram.Fields("ORDEN_N2").Value = 1 And rstTram.Fields("ORDEN_N3").Value = 0 And rstTram.Fields("ORDEN_N4").Value = 0 And rstTram.Fields("ORDEN_N5").Value = 0 Then
			System.Windows.Forms.Application.DoEvents()
		End If
		
		numSalto = 0
		numSalto2 = 0
		fTD_Usu = True
		
		'Obtenemos los Conectores de Salida
		strSQL = "SELECT * " & "FROM CONECTOR_ACC " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & rstTram.Fields("ID_DIAGRAMA").Value & " " & "AND NUM_CONECTOR = " & rstTram.Fields("NUM_DIAGRAMA").Value & " " & "AND NUM_SEQ_DESDE = " & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "SELECT DISTINCT J.ANO_ID " & "FROM JOINER J, " & "CW_DATA_USAGE C " & "WHERE J.JO_SEQ = " & rstAux.Fields("ID_CONECTOR").Value & " " & "AND SH_SEQ_FROM = " & rstAux.Fields("NUM_SEQ_DESDE").Value & " " & "AND SH_SEQ_TO = " & rstAux.Fields("NUM_SEQ_HASTA").Value & " " & "AND DI_ID = " & rstAcc.Fields("DI_ID").Value & " " & "AND DM_DELETES = 1 " & "AND J.MODEL_NAME = '" & strModelo & "' " & "AND C.MODEL_NAME = '" & strModelo & "'"
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			strSQL = "SELECT DISTINCT J.ANO_ID, " & "J.JO_TLBR_FLAGS, " & "J.JO_TO_OFFSET " & "FROM JOINER J " & "WHERE J.ANO_ID IN (" & strJOINER & ") " & "AND J.MODEL_NAME = '" & strModelo & "' " & "ORDER BY ANO_ID, " & "JO_TLBR_FLAGS, " & "JO_TO_OFFSET"
			rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			'Número de Conectores de Salida
			lngAccConS = rstParamCMS.RecordCount
			System.Windows.Forms.Application.DoEvents()
			rstParamCMS.MoveFirst()
		Else
			lngAccConS = 0
		End If
		rstAux.Close()
		
		'Obtenemos los Conectores de Entrada
		strSQL = "SELECT * " & "FROM CONECTOR_ACC " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & rstTram.Fields("ID_DIAGRAMA").Value & " " & "AND NUM_CONECTOR = " & rstTram.Fields("NUM_DIAGRAMA").Value & " " & "AND NUM_SEQ_HASTA = " & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "SELECT DISTINCT J.ANO_ID " & "FROM JOINER J, " & "CW_DATA_USAGE C " & "WHERE J.JO_SEQ = " & rstAux.Fields("ID_CONECTOR").Value & " " & "AND SH_SEQ_FROM = " & rstAux.Fields("NUM_SEQ_DESDE").Value & " " & "AND SH_SEQ_TO = " & rstAux.Fields("NUM_SEQ_HASTA").Value & " " & "AND DI_ID = " & rstAcc.Fields("DI_ID").Value & " " & "AND DM_INSERTS = 1" & "AND J.MODEL_NAME = '" & strModelo & "' " & "AND C.MODEL_NAME = '" & strModelo & "'"
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				strJOINER = strJOINER & rstconE.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			strSQL = "SELECT DISTINCT J.ANO_ID, " & "J.JO_SEQ " & "FROM JOINER J " & "WHERE J.ANO_ID IN (" & strJOINER & ") " & "AND J.MODEL_NAME = '" & strModelo & "' " & "ORDER BY JO_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			'Número de Conectores de Entrada
			lngAccConE = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			rstparamCME.MoveFirst()
		Else
			lngAccConE = 0
		End If
		blnError = False
		
		'Comprobamos si tenemos Conectores de Entrada
		If lngAccConE <> 0 Then
			'Cargar Textos de preguntas
			colXML4 = New Collection
			colXML4.Add("Código Pregunta")
			strAnt = ""
			While Not rstparamCME.EOF
				colXMLD = mfBuscaXML("Conector", colXML4, rstparamCME.Fields("ANO_ID").Value)
				For	Each icol In colXMLD
					If strAnt <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If strAnt <> icol Then
							blnError = True
						End If
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strAnt = icol
				Next icol
				rstparamCME.MoveNext()
			End While
			'Insertar Pregunta
			If blnError = False Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strAnt, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
				rstparamHN.MoveNext()
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen valores distintos", "fTD_Usu")
				Mostrar_Error()
				fTD_Usu = False
				Exit Function
			End If
			
			'Cargar Textos de Código Texto de Verificación
			colXML5 = New Collection
			colXML5.Add("Código Texto de Verificación")
			strAnt5 = ""
			rstparamCME.MoveFirst()
			While Not rstparamCME.EOF
				colXMLD5 = mfBuscaXML("Conector", colXML5, rstparamCME.Fields("ANO_ID").Value)
				For	Each icol In colXMLD5
					If strAnt5 <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If strAnt5 <> icol Then
							blnError = True
						End If
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strAnt5 = icol
				Next icol
				rstparamCME.MoveNext()
			End While
			If blnError = False Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strAnt5, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
				rstparamHN.MoveNext()
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen valores distintos", "fTD_Usu")
				Mostrar_Error()
				fTD_Usu = False
				Exit Function
			End If
			
			'Cargar Textos de Código Aviso Verificación
			colXML6 = New Collection
			colXML6.Add("Código Aviso Verificación")
			strAnt6 = ""
			rstparamCME.MoveFirst()
			While Not rstparamCME.EOF
				colXMLD6 = mfBuscaXML("Conector", colXML6, rstparamCME.Fields("ANO_ID").Value)
				For	Each icol In colXMLD6
					If strAnt6 <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If strAnt6 <> icol Then
							blnError = True
						End If
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strAnt6 = icol
				Next icol
				rstparamCME.MoveNext()
			End While
			If blnError = False Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strAnt6, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
				rstparamHN.MoveNext()
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen valores distintos", "fTD_Usu")
				Mostrar_Error()
				fTD_Usu = False
				Exit Function
			End If
			
			'Inicio J.Lerma 20/02/2019 -- Tratamiento Aceptación/Rechazo
			'Cargar Indicador Aceptación/Rechazo
			colXML2 = New Collection
			colXML2.Add("Indicador Aceptación/Rechazo")
			strAnt = ""
			rstparamCME.MoveFirst()
			While Not rstparamCME.EOF
				colXMLD = mfBuscaXML("Conector", colXML2, rstparamCME.Fields("ANO_ID").Value)
				For	Each icol In colXMLD
					If strAnt <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If strAnt <> icol Then
							blnError = True
						End If
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strAnt = icol
				Next icol
				rstparamCME.MoveNext()
			End While
			If strAnt <> "" Then
				If strAnt = "-1" Then
					strAnt = "S"
				Else
					strAnt = "N"
				End If
			End If
			If blnError = False Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strAnt, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
				rstparamHN.MoveNext()
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen valores distintos", "fTD_Usu")
				Mostrar_Error()
				fTD_Usu = False
				Exit Function
			End If
			
			'Cargar Texto Motivos de Rechazo
			colXML2 = New Collection
			colXML2.Add("Literal Motivos de Rechazo")
			strAnt = ""
			rstparamCME.MoveFirst()
			While Not rstparamCME.EOF
				colXMLD = mfBuscaXML("Conector", colXML2, rstparamCME.Fields("ANO_ID").Value)
				For	Each icol In colXMLD
					If strAnt <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If strAnt <> icol Then
							blnError = True
						End If
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strAnt = icol
				Next icol
				rstparamCME.MoveNext()
			End While
			If blnError = False Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strAnt, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
				rstparamHN.MoveNext()
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen valores distintos", "fTD_Usu")
				Mostrar_Error()
				fTD_Usu = False
				Exit Function
			End If
			'Fin J.Lerma 20/02/2019 -- Tratamiento aceptación/rechazo
			
			'Inicio Jonathan Prieto 04/12/2013 - En el tratamiento de acción TDU nunca debe obtener Indicador Valor Variable en propiedades del conector
			blnIndValVar = False
			'Fin Jonathan Prieto 04/12/2013
		End If
		I = 0
		
		'Comprobamos si tenemos Conectores de Salida
		If lngAccConS <> 0 Then
			colXML4 = New Collection
			colXML4.Add("Código Respuesta")
			While Not rstParamCMS.EOF
				colXMLD = mfBuscaXML("Conector", colXML4, rstParamCMS.Fields("ANO_ID").Value)
				blnIndValVar = False
				For	Each icol In colXMLD
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
					rstparamHN.MoveNext()
				Next icol
				rstParamCMS.MoveNext()
				I = I + 1
			End While
		End If
		'Nos posicionamos en los Parámetros para los saltos tras haber tratado todos los Literales de las Respuestas
		If I < ((lngacc - 5) / 2) Then
			For j = 1 To ((lngacc - 5) / 2) - (I - 1) - 1
				rstparamHN.MoveNext()
			Next j
		End If
		rstParamCMS.MoveFirst()
		j = 0
		'Nos recorremos los Parámetros de Salida para Inicializar los Saltos
		While Not rstParamCMS.EOF
			j = j + 1
			strSQL = "SELECT SH_SEQ_TO " & "FROM JOINER " & "WHERE ANO_ID = " & rstParamCMS.Fields(0).Value & " " & "AND MODEL_NAME = '" & strModelo & "'"
			rstTDCon = mfRecordset(conDP4, strSQL)
			
			strSQL = "SELECT NOM_ACCION, " & "PATH_HIDRA, " & "ORDEN_ACC " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstAcc.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstAcc.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstAcc.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstAcc.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstAcc.Fields("ORDEN_N5").Value & " " & "AND NUM_SEQ = " & rstTDCon.Fields(0).Value
			rstAux = mfRecordset(conPasarela, strSQL) 'A que accion va el conector
			If Not rstAux.EOF Then
				blnSalto = False
				If rstAux.Fields("NOM_ACCION").Value = "PROCESOFALSO" Then
					strSQL = "SELECT * " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " " & "AND ORDEN_ACC = " & rstAux.Fields("ORDEN_ACC").Value + 1
					rstAux = mfRecordset(conPasarela, strSQL)
				End If
				'si está vacío metes el vacío y si esta lleno metes sin definir?
				If rstAux.Fields("PATH_HIDRA").Value = "" Then
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "ENLACE SIN DEFINIR", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				Else
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rstAux.Fields("PATH_HIDRA").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				End If
			Else
				If rstTram.Fields("SALIDAS").Value > 1 Then
					blnSalto = True
					bool = True
					strsalto = "LET" & Mid(rstAcc.Fields("PATH_HIDRA").Value, 1, 13) & Mid(rstAcc.Fields("PATH_HIDRA").Value, Len(rstAcc.Fields("PATH_HIDRA").Value) - 1)
					'Inicio Jonathan Prieto 23/02/2011: No estaba bien diseñada para crear saltos de salida de TDUSUARIO a partir del parámetro de @SALTO3
					Select Case j
						Case 1
							blnSalto1 = True
							seq1 = rstTDCon.Fields(0).Value
						Case 2
							blnSalto2 = True
							seq2 = rstTDCon.Fields(0).Value
						Case 3
							seq3 = rstTDCon.Fields(0).Value
						Case 4
							seq4 = rstTDCon.Fields(0).Value
						Case 5
							seq5 = rstTDCon.Fields(0).Value
					End Select
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strsalto & "SALTO" & VB6.Format(rstParamCMS.AbsolutePosition, "00"), rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					numSalto = numSalto + 1
				Else
					blnSalto = False
					strSQL = "SELECT * " & "FROM CONECTOR_ACC " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & rstTram.Fields("ID_DIAGRAMA").Value & " " & "AND NUM_CONECTOR = " & rstTram.Fields("NUM_DIAGRAMA").Value & " " & "AND NUM_SEQ_DESDE = " & rstAcc.Fields("NUM_SEQ").Value & " " & "AND IND_SALIDA_TRAM = 'S' " & "AND NUM_SEQ_HASTA = " & rstTDCon.Fields(0).Value
					rstAux = mfRecordset(conPasarela, strSQL)
					If Not rstAux.EOF Then
						If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "PR_FINEXPEDIENTE", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Else
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						End If
					Else
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End If
				End If
			End If
			rstparamHN.MoveNext()
			rstParamCMS.MoveNext()
		End While
		regPlus = 0
		j = 0
		Dim Num As String
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S' order by NUM_SEQ_HASTA"
			
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				nomTramS = ""
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				blnIns = False
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT DISTINCT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					
					rstConST = mfRecordset(conPasarela, strSQL)
					'aketza 21/04/2008
					'auxCont = 0
					'fin aketza
					While Not rstConST.EOF
						If rstTram.Fields("NUM_DIAGRAMA").Value > 1 Then
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ID_DIAG_N1=" & rstTram.Fields("ID_DIAG_N1").Value
							
							Select Case CShort(rstTram.Fields("NUM_DIAGRAMA").Value)
								Case 2
									strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								Case 3
									strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
								Case 4
									strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
								Case Else
									strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
							End Select
						Else
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						End If
						
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							'Inicio Jonathan Prieto 22/09/2011 - Añado la secuencia (D.SH_SEQ)
							strSQL = "SELECT A.EV_ID,D.SH_SEQ FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND "
							strSQL = strSQL & "A.EV_ID=" & rstConS.Fields("EV_ID").Value
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 22/09/2011 - Añado la secuencia (D.SH_SEQ)
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								'Inicio Jonathan Prieto 22/09/2011 - Comprobación de entrada no de salida.
								strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "ID_DIAGRAMA = " & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND "
								strSQL = strSQL & "NUM_SEQ_HASTA = " & rstAux3.Fields(1).Value & " AND "
								strSQL = strSQL & "IND_SALIDA_TRAM='S'"
								rstAux2 = mfRecordset(conPasarela, strSQL)
								'Si devuelve algún registro tiene un conector que llega hasta el evento, es de salida, no es válido.
								If (rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value) And rstAux2.EOF Then
									'If rstAux3(0) = rstConS("EV_ID") Then
									'Fin Jonathan Prieto 22/09/2011
									blnfin = True
									If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									Else
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION like '" & strsalto & "SALTO%'"
									End If
									
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									j = j + 1
									If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									Else
										'Inicio Jonathan Prieto 23/02/2011: No estaba bien diseñada para crear saltos de salida de TDUSUARIO a partir del parámetro de @SALTO3
										If rstAux.Fields("NUM_SEQ_HASTA").Value = seq1 Then
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
											strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,"
											strSQL = strSQL & "NUM_ACCION, PATH_HIDRA) VALUES "
											strSQL = strSQL & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ""
											strSQL = strSQL & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & ""
											strSQL = strSQL & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
											numSalto2 = numSalto2 + 1
										ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq2 Then 
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
											strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,"
											strSQL = strSQL & "NUM_ACCION, PATH_HIDRA) VALUES "
											strSQL = strSQL & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ""
											strSQL = strSQL & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & ""
											strSQL = strSQL & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(2, "00") & "'," & lngNumAcc & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
											blnSalto2 = False
											numSalto2 = numSalto2 + 1
										ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq3 Then 
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
											strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,"
											strSQL = strSQL & "NUM_ACCION, PATH_HIDRA) VALUES "
											strSQL = strSQL & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ""
											strSQL = strSQL & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & ""
											strSQL = strSQL & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(3, "00") & "'," & lngNumAcc & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(3, "00") & "')"
											numSalto2 = numSalto2 + 1
										ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq4 Then 
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
											strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,"
											strSQL = strSQL & "NUM_ACCION, PATH_HIDRA) VALUES "
											strSQL = strSQL & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ""
											strSQL = strSQL & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & ""
											strSQL = strSQL & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(4, "00") & "'," & lngNumAcc & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(4, "00") & "')"
											numSalto2 = numSalto2 + 1
										ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq5 Then 
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
											strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,"
											strSQL = strSQL & "NUM_ACCION, PATH_HIDRA) VALUES "
											strSQL = strSQL & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ""
											strSQL = strSQL & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & ""
											strSQL = strSQL & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(5, "00") & "'," & lngNumAcc & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(5, "00") & "')"
											numSalto2 = numSalto2 + 1
											'Fin Jonathan Prieto 23/02/2011
										Else
											strSQL = "select Valor from Param_acc where PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " and ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " and ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " and ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " and ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " and ORDEN_ACC = " & lngORACC - 3 & " and parametro like '@SALTO%' and valor like 'letape%' order by valor desc"
											rstSalto = mfRecordset(conPasarela, strSQL)
											If Not rstSalto.EOF Then
												strAuxSalto = rstSalto.Fields(0).Value
												strAuxSalto = VB.Right(strAuxSalto, 1)
											Else
												strAuxSalto = "3"
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
											strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,"
											strSQL = strSQL & "NUM_ACCION, PATH_HIDRA) VALUES "
											strSQL = strSQL & "('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ""
											strSQL = strSQL & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & ""
											strSQL = strSQL & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
											'                              strSQL = strSQL & "'" & strsalto & "SALTO" & Format(3, "00") & "'," & lngNumAcc & ","
											'                              strSQL = strSQL & "'" & strsalto & "SALTO" & Format(3, "00") & "')"
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(strAuxSalto, "00") & "'," & lngNumAcc & ","
											strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(strAuxSalto, "00") & "')"
											numSalto2 = numSalto2 + 1
										End If
									End If
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										'''##
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
										If nomTramS = "" Then
											If rstAux2.Fields("ORDEN_N2").Value = 0 Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											Do While Not rstAux2.EOF
												If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Exit Do
												End If
												rstAux2.MoveNext()
												nomTramS = "PR_FINEXPEDIENTE"
											Loop 
										End If
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									
									'''##
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									nomTramS = ""
								End If
							Else
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									rstAux4 = mfRecordset(conPasarela, strSQL)
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											If blnSalto = False Then
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											Else
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION like '" & strsalto & "SALTO%'"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											j = j + 1
											If blnSalto = False Then
												strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											Else
												'Inicio Jonathan Prieto 23/02/2011: No estaba bien diseñada para crear saltos de salida de TDUSUARIO a partir del parámetro de @SALTO3
												If rstAux.Fields("NUM_SEQ_HASTA").Value = seq1 Then
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
													numSalto2 = numSalto2 + 1
												ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq2 Then 
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'" & strsalto & "SALTO" & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
													blnSalto2 = False
													numSalto2 = numSalto2 + 1
												ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq3 Then 
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'" & strsalto & "SALTO" & VB6.Format(3, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(3, "00") & "')"
													numSalto2 = numSalto2 + 1
												ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq4 Then 
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'" & strsalto & "SALTO" & VB6.Format(4, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(4, "00") & "')"
													numSalto2 = numSalto2 + 1
												ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq5 Then 
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'" & strsalto & "SALTO" & VB6.Format(5, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(5, "00") & "')"
													numSalto2 = numSalto2 + 1
												End If
												'Fin Jonathan Prieto 23/02/2011
											End If
											
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
								End If
							End If
							rstTRAMS.MoveNext()
							
						End While
						rstConST.MoveNext()
						'aketza 21/04/2008
						'If Not rstAux.EOF And rstAux.RecordCount > rstAux.AbsolutePosition Then
						'   auxCont = auxCont + 1
						'   rstAux.MoveNext
						'End If
						'fin aketza
						If blnIns = True Then
							GoTo pru
						End If
					End While
					
pru: 
					'aketza 21/04/2008
					'If Not rstAux.EOF And rstAux.RecordCount > rstAux.AbsolutePosition And auxCont <> 0 Then
					'    For auxI = 0 To auxCont - 1
					'       rstAux.MovePrevious
					'    Next auxI
					'End If
					'auxCont = 0
					'fin aketza
				Else
					'aketza 29/04/2008
					'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
					If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
						'fin aketza
						'insertamos un salto a PR_FINDEEXPEDIENTE
						blnfin = True
						If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
							strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
						Else
							strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION like '" & strsalto & "SALTO%'"
						End If
						rstAux2 = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
						strSQL = "SELECT * FROM ACCIONES_DI WHERE "
						strSQL = strSQL & "PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
						strSQL = strSQL & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
						strSQL = strSQL & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
						strSQL = strSQL & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2
						strSQL = strSQL & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
						rstAux2 = mfRecordset(conPasarela, strSQL)
						While Not rstAux2.EOF
							strSQL = "UPDATE ACCIONES_DI SET "
							strSQL = strSQL & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
							strSQL = strSQL & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value
							strSQL = strSQL & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value
							strSQL = strSQL & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value
							strSQL = strSQL & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
							strSQL = strSQL & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
							mfExecute(conPasarela, strSQL)
							lngUlt = rstAux2.Fields("ORDEN_ACC").Value
							strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
							mfExecute(conPasarela, strSQL)
							rstAux2.MoveNext()
						End While
						If lngUlt <> 0 Then
							lngORACC = lngUlt
						Else
							strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
							rstAux3 = mfRecordset(conPasarela, strSQL)
							lngORACC = rstAux3.Fields(0).Value + 1
						End If
						j = j + 1
						If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
							strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3,"
							strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,"
							strSQL = strSQL & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "',"
							strSQL = strSQL & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value
							strSQL = strSQL & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
							strSQL = strSQL & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
						Else
							'Inicio Jonathan Prieto 23/02/2011: No estaba bien diseñada para crear saltos de salida de TDUSUARIO a partir del parámetro de @SALTO3
							If rstAux.Fields("NUM_SEQ_HASTA").Value = seq1 Then
								strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
								numSalto2 = numSalto2 + 1
							ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq2 Then 
								strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
								strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,"
								strSQL = strSQL & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "',"
								strSQL = strSQL & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value
								strSQL = strSQL & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
								strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
								blnSalto2 = False
								numSalto2 = numSalto2 + 1
							ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq3 Then 
								strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
								strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,"
								strSQL = strSQL & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "',"
								strSQL = strSQL & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value
								strSQL = strSQL & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
								strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(3, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(3, "00") & "')"
								numSalto2 = numSalto2 + 1
							ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq4 Then 
								strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
								strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,"
								strSQL = strSQL & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "',"
								strSQL = strSQL & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value
								strSQL = strSQL & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
								strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(4, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(4, "00") & "')"
								numSalto2 = numSalto2 + 1
							ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq5 Then 
								strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,"
								strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,"
								strSQL = strSQL & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "',"
								strSQL = strSQL & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value
								strSQL = strSQL & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
								strSQL = strSQL & "'" & strsalto & "SALTO" & VB6.Format(5, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(5, "00") & "')"
								numSalto2 = numSalto2 + 1
							End If
							'Fin Jonathan Prieto 23/02/2011
						End If
						mfExecute(conPasarela, strSQL)
						blnInserta = False
						strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
						strSQL = strSQL & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
						strSQL = strSQL & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
						strSQL = strSQL & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
						strSQL = strSQL & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
						rstAux2 = mfRecordset(conPasarela, strSQL)
						If Not rstAux2.EOF Then
							nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
						Else
							nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
						End If
						msInsertaParamAcc(nomTram, "PR_FINEXPEDIENTE", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
						strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
						rstACC2 = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
						lngORACC = lngORACC + 1
						strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3,"
						strSQL = strSQL & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,"
						strSQL = strSQL & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "',"
						strSQL = strSQL & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value
						strSQL = strSQL & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ","
						strSQL = strSQL & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
						mfExecute(conPasarela, strSQL)
						blnInserta = False
						blnIns = True
						regPlus = regPlus + 1 '
						msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
						nomTramS = ""
					End If
				End If
aqui2: 
				rstAux.MoveNext()
			End While
aqui: 
			If (blnfin = False And rstAux.RecordCount > 0) Or (j = 1 And blnSalto2 = True) Or (numSalto <> numSalto2) Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				j = j + 1
				
				'Inicio Jonathan Prieto 12/01/2012: queda pendiente la salida que no se ha podido definir (al evento de fin)
				If blnSalto = False And bool = False Then
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				Else
					strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND VALOR LIKE '%" & strsalto & "%'" & " ORDER BY ORDEN_PA"
					rstUlt = mfRecordset(conPasarela, strSQL)
					rstUlt.MoveLast()
					Num = VB6.Format(VB.Right(rstUlt.Fields("VALOR").Value, 2), "00")
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & Num & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & Num & "')"
				End If
				mfExecute(conPasarela, strSQL)
				
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				
				If nomTramS = "" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				'Fin Jonathan Prieto 12/01/2012
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
		End If
		If regPlus <> 0 Then regPlus = 1
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Toma de decisión de usuario", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTD_Usu")
		Mostrar_Error()
		logError("fTD_Usu - " & Err.Description)
		Resume procFin
		
procFin: 
		
	End Function
	Private Function fEnv_Mens(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		'Inicio Jonathan 17/01/2014: Nuevos parámetros entrada en la acción
		'********************************************************************************************************************************************
		'Tratamiento específico para la acción Envío de mensaje
		'El tratamiento de parámetros tiene dos partes:
		'   Parámetros fijos:
		'       @MENSAJE: se obtiene de la propiedad Nombre del Evento/Resultado Mensaje dibujado en Corporate
		'       @CODIGODOCUMENTO: se obtiene de la propiedad Código Documento del primer conector de entrada al trámite que contiene el Envío de Mensaje
		'       @FICHERO: se obtiene de la propiedad Fichero del primer conector de entrada al trámite que contiene el Envío de Mensaje
		'   Parámetros variables, a fecha 17/01/2014:
		'       @EMAIL, @PASSWORD, @CODASUNTO: primero, se obtienen del uso de datos del conector de entrada a la acción Envío de Mensaje.
		'           si no, se obtienen del uso de datos de la acción Envío de Mensaje
		'********************************************************************************************************************************************
		On Error GoTo procErr
		Dim rstACC2 As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim I As Integer
		Dim intPadre As Integer
		Dim Orden As Integer
		Dim lngUlt As Integer
		Dim blnfin As Boolean
		Dim blnPrim As Boolean
		Dim blnError As Boolean
		Dim blnEncon As Boolean
		Dim strSQL As String
		Dim strJOINER As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim strAnt As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim blnIndValVar As Boolean
		Dim arrFichero As Object
		Dim strFichero As String
		Dim rstRami As ADODB.Recordset
		Dim blnRami As Boolean
		
		fEnv_Mens = True
inicio: 
		blnEncon = False
		
		'Averiguar si la acción está dibujada en un trámite que está en una ramificación
		If rstTram.Fields("ORDEN_N5").Value <> 0 Then
			strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND "
			strSQL = strSQL & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5 = 0"
		ElseIf rstTram.Fields("ORDEN_N4").Value <> 0 Then 
			strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND "
			strSQL = strSQL & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = 0"
		ElseIf rstTram.Fields("ORDEN_N3").Value <> 0 Then 
			strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND "
			strSQL = strSQL & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3= 0"
		Else
			strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND "
			strSQL = strSQL & "ORDEN_N2= 0"
		End If
		rstRami = mfRecordset(conPasarela, strSQL)
		If Not rstRami.EOF Then
			If rstRami.Fields("TIPO_DIAGRAMA").Value = "O" Then
				blnRami = True
			End If
		End If
		
		'Obtener el trámite donde está dibujada la acción
		If blnRami = True Then
			'Trámite dibujado en una ramificación
			If rstTram.Fields("NUM_DIAGRAMA").Value > 1 Then
				If rstTram.Fields("NUM_DIAGRAMA").Value >= 3 Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & IIf(intPadre = 0, rstTram.Fields("ID_PADRE").Value, intPadre) & " and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
				Else
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & IIf(intPadre = 0, rstTram.Fields("ID_PADRE").Value, intPadre) & " and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
				End If
			Else
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & IIf(intPadre = 0, rstTram.Fields("ID_PADRE").Value, intPadre) & " and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
			End If
		Else
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
			strSQL = strSQL & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
			strSQL = strSQL & " AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
		End If
		rstAux = mfRecordset(conPasarela, strSQL)
		'Otra manera de obtener el trámite donde está dibujada la acción
		If rstAux.EOF Then
			If rstTram.Fields("NUM_DIAGRAMA").Value > 1 Then
				If rstTram.Fields("NUM_DIAGRAMA").Value >= 3 Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
				Else
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
				End If
			Else
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
			End If
			rstAux = mfRecordset(conPasarela, strSQL)
		End If
		'Encontrado el trámite donde está dibujada la acción
		If Not rstAux.EOF Then
			'Obtener Evento/Resultado Mensaje al que apunta el trámite donde está dibujada la acción
			If rstTram.Fields("NUM_DIAGRAMA").Value >= 3 Then
				'Trámite dibujado a partir de nivel 3
				strSQL = "SELECT OT_ID, EV_ID, EV_NAME "
				strSQL = strSQL & "FROM CW_OBJECT_TYPE A, EVENT B, SHAPE C, JOINER D, SHAPE E "
				strSQL = strSQL & "WHERE A.OT_NAME='Evento/Resultado' and "
				strSQL = strSQL & "A.OT_ID=C.ANO_TABNR AND "
				strSQL = strSQL & "B.EV_ID=C.ANO_ID AND "
				strSQL = strSQL & "C.SH_SEQ=D.SH_SEQ_TO AND "
				strSQL = strSQL & "C.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "E.DI_ID = D.DI_ID AND "
				strSQL = strSQL & "E.SH_SEQ = D.SH_SEQ_FROM AND "
				strSQL = strSQL & "C.DI_ID=" & rstTram.Fields("ID_PADRE").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ_FROM= " & rstAux.Fields("NUM_SEQ").Value
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				rstAux2 = mfRecordset(conDP4, strSQL, CStr(True))
				If rstAux2.EOF Then
					strSQL = "SELECT OT_ID, EV_ID, EV_NAME "
					strSQL = strSQL & "FROM CW_OBJECT_TYPE A, EVENT B, SHAPE C, JOINER D, SHAPE E "
					strSQL = strSQL & "WHERE A.OT_NAME='Evento/Resultado' and "
					strSQL = strSQL & "A.OT_ID=C.ANO_TABNR AND "
					strSQL = strSQL & "B.EV_ID=C.ANO_ID AND "
					strSQL = strSQL & "C.SH_SEQ=D.SH_SEQ_TO AND "
					strSQL = strSQL & "C.DI_ID=D.DI_ID AND "
					strSQL = strSQL & "E.DI_ID = D.DI_ID AND "
					strSQL = strSQL & "E.SH_SEQ = D.SH_SEQ_FROM AND "
					strSQL = strSQL & "C.DI_ID=" & rstAux.Fields("DI_ID").Value & " AND "
					strSQL = strSQL & "D.SH_SEQ_FROM = " & rstAux.Fields("NUM_SEQ").Value
					strSQL = strSQL & " AND SUBSTRING(EV_NAME,1,1)='M' "
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				End If
			Else
				strSQL = "SELECT OT_ID, EV_ID, EV_NAME "
				strSQL = strSQL & "FROM CW_OBJECT_TYPE A, EVENT B, SHAPE C, JOINER D, SHAPE E "
				strSQL = strSQL & "WHERE A.OT_NAME='Evento/Resultado' and "
				strSQL = strSQL & "A.OT_ID=C.ANO_TABNR AND "
				strSQL = strSQL & "B.EV_ID=C.ANO_ID AND "
				strSQL = strSQL & "C.SH_SEQ=D.SH_SEQ_TO AND "
				strSQL = strSQL & "C.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "E.DI_ID = D.DI_ID AND "
				strSQL = strSQL & "E.SH_SEQ = D.SH_SEQ_FROM AND "
				If blnRami = True Then
					strSQL = strSQL & "C.DI_ID=" & IIf(rstTram.Fields("NUM_DIAGRAMA").Value = 2, rstAux.Fields("ID_PADRE").Value, rstAux.Fields("ID_DIAGRAMA").Value) & " AND "
				Else
					strSQL = strSQL & "C.DI_ID=" & IIf(rstTram.Fields("NUM_DIAGRAMA").Value <= 2, rstAux.Fields("DI_ID").Value, rstAux.Fields("ID_DIAGRAMA").Value) & " AND "
				End If
				strSQL = strSQL & "D.SH_SEQ_FROM = " & rstAux.Fields("NUM_SEQ").Value
				strSQL = strSQL & " AND SUBSTRING(EV_NAME,1,1)='M' "
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			End If
			rstAux2 = mfRecordset(conDP4, strSQL, CStr(True))
			If rstAux2.EOF Then
				'Si no lo encuentra, subimos un nivel
				intPadre = rstAux.Fields("ID_PADRE").Value
				If rstAux.Fields("NUM_DIAGRAMA").Value <> 1 Then
					GoTo inicio
				End If
			Else
				'Insertar parámetro @MENSAJE, que tomará el valor de la propiedad Nombre del Evento/Resultado Mensaje
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, Trim(Mid(rstAux2.Fields("EV_NAME").Value, 2, 4)), rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstparamHN.MoveNext()
				blnEncon = True
				strSQL = "SELECT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "PARAMETRO='@ORDENTRA'"
				strSQL = strSQL & " AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value
				strSQL = strSQL & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value
				strSQL = strSQL & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value
				strSQL = strSQL & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value
				strSQL = strSQL & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_ACC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				Orden = rstAux2.Fields(0).Value
				strSQL = "SELECT * FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDENTRA=" & rstAux2.Fields(0).Value & " AND INDCOMUN='S'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If rstAux2.EOF Then
					strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, "
					strSQL = strSQL & "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES ("
					strSQL = strSQL & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & rstTram.Fields("ID_DIAGRAMA").Value & ","
					strSQL = strSQL & 999999 & ",'SERVIDOR','N','S')"
					mfExecute(conPasarela, strSQL)
				End If
			End If
		End If
		
		'Obtener todos los conectores de entrada al trámite donde se encuentra la acción
		strJOINER = ""
		strSQL = "select DISTINCT J.ANO_ID FROM JOINER J Where SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ").Value & " AND DI_ID=" & rstAux.Fields("DI_ID").Value & " AND J.MODEL_NAME ='" & strModelo & "'"
		rstconE = mfRecordset(conDP4, strSQL)
		While Not rstconE.EOF
			strJOINER = strJOINER & rstconE.Fields(0).Value & ","
			rstconE.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			strSQL = "SELECT DISTINCT J.ANO_ID FROM JOINER J WHERE J.ANO_ID IN (" & strJOINER & ")"
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConE = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			rstparamCME.MoveFirst()
		Else
			lngAccConE = 0
		End If
		
		blnError = False
		'En caso de haber encontrado algún conector de entrada al trámite donde está dibujada la acción Envío de Mensaje
		If lngAccConE <> 0 Then
			'Obtener parámetros de las propiedades del primer conector que apunte al trámite donde está dibujada la acción Envio Mensaje
			'------------------------------------------------------------
			'Obtener valor de la propiedad CODIGO DOCUMENTO
			colXML4 = New Collection
			'Si no ha podido obtener el CODIGO MENSAJE en el Evento/Resultado de CM
			'        If blnEncon = False Then
			'            colXML4.Add "Código de Mensaje"
			'        End If
			colXML4.Add("Código Documento")
			strAnt = ""
			While Not rstparamCME.EOF
				colXMLD = mfBuscaXML("Conector", colXML4, rstparamCME.Fields("ANO_ID").Value)
				For	Each icol In colXMLD
					If strAnt <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If strAnt <> icol Then
							blnError = True
						End If
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strAnt = icol
				Next icol
				rstparamCME.MoveNext()
			End While
			rstparamCME.MoveFirst()
			'Evaluar si está chequeada la opción Indicador Valor Variable en las propiedades del primer conector que apunta
			'al trámite donde está dibujada la acción Envio Mensaje
			colXML4 = New Collection
			colXML4.Add("Indicador Valor Variable")
			colXMLD = mfBuscaXML("Conector", colXML4, rstparamCME.Fields("ANO_ID").Value)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If colXMLD.Item(1) <> vbNullString Then
				'Si, está chequeada la opción Indicador Valor Variable
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(1)) = CDbl("1"))
			End If
			colXMLD.Remove(1)
			If blnError = False Then
				'Insertar parámetro @CODIGODOCUMENTO
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strAnt, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
				rstparamHN.MoveNext()
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen valores distintos", "fEnv_Mens")
				Mostrar_Error()
				fEnv_Mens = False
				Exit Function
			End If
			'UPGRADE_NOTE: Object colXML4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			colXML4 = Nothing
			'------------------------------------------------------------
			'Obtener valor de la propiedad FICHERO
			colXML4 = New Collection
			colXML4.Add("Fichero")
			strAnt = ""
			While Not rstparamCME.EOF
				colXMLD = mfBuscaXML("Conector", colXML4, rstparamCME.Fields("ANO_ID").Value)
				For	Each icol In colXMLD
					If strAnt <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If strAnt <> icol Then
							blnError = True
						End If
					End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strAnt = icol
				Next icol
				rstparamCME.MoveNext()
			End While
			rstparamCME.MoveFirst()
			If blnError = False Then
				If rstparamHN.Fields("PARAM").Value = "@FICHERO" Then
					'Tratamiento en caso recibir varios ficheros en el parámetro
					If strAnt <> "" Then
						strFichero = ""
						If blnIndValVar = False Then
							'UPGRADE_WARNING: Couldn't resolve default property of object arrFichero. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrFichero = Split(strAnt, " ")
						Else
							'UPGRADE_WARNING: Couldn't resolve default property of object arrFichero. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							arrFichero = Split(strAnt, ";")
						End If
						For I = 0 To UBound(arrFichero)
							'UPGRADE_WARNING: Couldn't resolve default property of object arrFichero(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariablesNOMBRE(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strFichero = strFichero & "@INICIO!" & mfInsertaVariablesNOMBRE(arrFichero(I)) & " "
						Next I
						strAnt = Mid(strFichero, 1, Len(strFichero) - 1)
					End If
				End If
				'Insertar parámetro @FICHERO
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strAnt, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			Else
				Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen valores distintos", "fEnv_Mens")
				Mostrar_Error()
				fEnv_Mens = False
				Exit Function
			End If
			'------------------------------------------------------------
		End If
		'---------------------------------------------------------------------------------------------------------------------------------
		'Resto de parámetros de la acción ENVIODEMENSAJE de hidra (tratamiento de parámetros variables)
		'---------------------------------------------------------------------------------------------------------------------------------
		Dim iRestoPH As Short 'PH: Parámetros hidra que faltan por tratar de la acción ENVIODEMENSAJE
		Dim rstParamPC As ADODB.Recordset 'PC: Parámetros entrada del uso de datos del conector que apunta a la acción Envio Mensaje
		Dim rstParamPA As ADODB.Recordset 'PA: Parámetros entrada del uso de datos de la acción Envio Mensaje
		Dim strValorParam As String
		Dim blnConstante As Boolean
		
		'Obtener el número de PH que faltan por tratar
		iRestoPH = rstparamHN.RecordCount - rstparamHN.AbsolutePosition
		
		'Si quedan PH sin tratar...
		If iRestoPH > 0 Then
			
			'Obtener parámetros de entrada del uso de datos del conector entrada a la acción Envío de Mensaje
			strSQL = "SELECT C.AT_ID, A.AT_NAME, E.EN_NAME" & " FROM ATTRIBUTE A, CW_DATA_USAGE C, ENTITY E" & " WHERE C.CO_ID IN (" & " SELECT ANO_ID" & " FROM JOINER" & " WHERE MODEL_NAME ='" & strModelo & "'" & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND SH_SEQ_TO=" & rstAcc.Fields("NUM_SEQ").Value & ")" & " AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID" & " AND A.MODEL_NAME ='" & strModelo & "' AND C.MODEL_NAME ='" & strModelo & "' AND E.MODEL_NAME ='" & strModelo & "'" & " ORDER BY C.DM_SEQ"
			rstParamPC = mfRecordset(conDP4, strSQL, CStr(True))
			
			'Obtener parámetros de entrada del uso de datos de la acción Envío de Mensaje
			strSQL = "SELECT C.AT_ID, A.AT_NAME, E.EN_NAME" & " FROM ATTRIBUTE A, CW_DATA_USAGE C, ENTITY E" & " WHERE C.PR_ID = " & rstAcc.Fields("ID_ACCION").Value & " AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID" & " AND A.MODEL_NAME ='" & strModelo & "' AND C.MODEL_NAME ='" & strModelo & "' AND E.MODEL_NAME ='" & strModelo & "'" & " ORDER BY C.DM_SEQ"
			rstParamPA = mfRecordset(conDP4, strSQL, CStr(True))
			
			'Validación: en caso de existir PC, tiene que ser el mismo número que los PA
			If Not rstParamPC.EOF And Not rstParamPA.EOF Then
				If Not rstParamPC.RecordCount.equals(rstParamPA.RecordCount) Then
					'El número de PC tiene que ser el mismo que el número de PA
					Insertar_Error(Me, "Lectura de acciones de trámite", "El número de parámetros del conector de entrada a la acción tiene que ser el mismo que el número de parámetros de la acción: " & Trim(rstAcc.Fields("NOM_ACCION").Value) & ", trámite " & rstTram.Fields("NOMBRE").Value, "fEnv_Mens")
					Mostrar_Error()
					fEnv_Mens = False
					Exit Function
				End If
			End If
			
			'Validación: en caso de existir PA, tiene que ser el mismo número que los PH restantes
			If Not rstParamPA.EOF Then
				If rstParamPA.RecordCount <> iRestoPH Then
					'El número de PA no puede distinto del número de PH (No coincide el número de parámetros)
					Insertar_Error(Me, "Lectura de acciones de trámite", "No coindide el número de parámetros de la acción con el número de parámetros del flujo acción hidra: " & Trim(rstAcc.Fields("NOM_ACCION").Value) & ", trámite " & rstTram.Fields("NOMBRE").Value, "fEnv_Mens")
					Mostrar_Error()
					fEnv_Mens = False
					Exit Function
				End If
			End If
			
			'Tratamiento de PH restantes
			rstparamHN.MoveNext()
			While Not rstparamHN.EOF
				'Evaluar si se recogen los parámetros de PC ó de PA
				If Not rstParamPC.EOF Then
					'Si existen PC, se recogerán los parámetros de PC
					Select Case Trim(rstParamPC.Fields("EN_NAME").Value)
						Case "Constantes"
							'Valor constante. Obtenemos el valor de la constante
							blnConstante = True
							colXML4 = New Collection
							colXML4.Add("Valor")
							colXMLD = mfBuscaXML("Atributo", colXML4, rstParamPC.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorParam = colXMLD.Item(1)
							If strValorParam = "" Then
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstParamPC.Fields("AT_NAME").Value, "'", """") & " incluída en el conector de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & ", trámite " & rstTram.Fields("NOMBRE").Value, "fEnv_Mens")
								Mostrar_Error()
								fEnv_Mens = False
								Exit Function
							End If
						Case ""
							'Parámetro vacío
							blnConstante = False
							strValorParam = vbNullString
						Case Else
							'Variable
							blnConstante = False
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorParam = mfInsertaVariables(rstParamPC.Fields("AT_ID").Value, rstParamPC.Fields("AT_NAME").Value)
					End Select
					'Siguiente PC
					rstParamPC.MoveNext()
					
				ElseIf Not rstParamPA.EOF Then 
					'Se recogen los parámetros de PA
					Select Case Trim(rstParamPA.Fields("EN_NAME").Value)
						Case "Constantes"
							'Valor constante. Obtenemos el valor de la constante
							colXML4 = New Collection
							colXML4.Add("Valor")
							colXMLD = mfBuscaXML("Atributo", colXML4, rstParamPA.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorParam = colXMLD.Item(1)
							If strValorParam = "" Then
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstParamPC.Fields("AT_NAME").Value, "'", """") & " incluída en la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & ", trámite " & rstTram.Fields("NOMBRE").Value, "fEnv_Mens")
								Mostrar_Error()
								fEnv_Mens = False
								Exit Function
							End If
						Case ""
							'Parámetro vacío
							strValorParam = vbNullString
						Case Else
							'Variable
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorParam = mfInsertaVariables(rstParamPA.Fields("AT_ID").Value, rstParamPA.Fields("AT_NAME").Value)
					End Select
					'Siguiente PA
					rstParamPA.MoveNext()
					
				Else
					'No existe ningún valor para el parámetro
					strValorParam = vbNullString
				End If
				
				'Si se ha encontrado valor para el parámetro y no es una Constante se le concatena @INICIO!
				If Trim(strValorParam) <> vbNullString And Not blnConstante Then
					strValorParam = "@INICIO!" & strValorParam
				End If
				
				'Se inserta el parámetro
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorParam, rstAcc.Fields("ORDEN_N1").Value, rstAcc.Fields("ORDEN_N2").Value, rstAcc.Fields("ORDEN_N3").Value, rstAcc.Fields("ORDEN_N4").Value, rstAcc.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				
				'Siguiente parámetro
				rstparamHN.MoveNext()
			End While
		End If
		
		CierraRS(rstParamPC)
		'UPGRADE_NOTE: Object rstParamPC may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstParamPC = Nothing
		CierraRS(rstParamPA)
		'UPGRADE_NOTE: Object rstParamPA may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstParamPA = Nothing
		'---------------------------------------------------------------------------------------------------------------------------------
		'---------------------------------------------------------------------------------------------------------------------------------
		'Fin Jonathan 17/01/2014: Nuevos parámetros entrada en la acción
		
		If rstTram.Fields("INDCOMUN").Value = "S" Then
			strSQL = "UPDATE PARAM_ACC SET VALOR='WEHYN001' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "PARAMETRO='@USUARIO' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND "
			strSQL = strSQL & "ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND "
			strSQL = strSQL & "ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND "
			strSQL = strSQL & "ORDEN_ACC=" & rstAcc.Fields("ORDEN_ACC").Value
			mfExecute(conPasarela, strSQL)
		End If
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
			strSQL = strSQL & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND "
			strSQL = strSQL & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND "
			strSQL = strSQL & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							'Inicio Jonathan Prieto 22/12/2011
							strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value
							strSQL = strSQL & "AND A.EV_ID=" & rstConS.Fields("EV_ID").Value
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 22/12/2011
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									strSQL = strSQL & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET "
										strSQL = strSQL & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
										strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value
										strSQL = strSQL & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value
										strSQL = strSQL & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
								End If
							Else
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									rstAux4 = mfRecordset(conPasarela, strSQL)
									strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
											strSQL = strSQL & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
											strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
											strSQL = strSQL & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
											strSQL = strSQL & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											strSQL = strSQL & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET "
												strSQL = strSQL & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
												strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value
												strSQL = strSQL & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value
												strSQL = strSQL & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
											strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
											strSQL = strSQL & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
											strSQL = strSQL & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
											strSQL = strSQL & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value
											strSQL = strSQL & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value
											strSQL = strSQL & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
				strSQL = strSQL & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
				strSQL = strSQL & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				strSQL = strSQL & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET "
					strSQL = strSQL & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value
					strSQL = strSQL & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value
					strSQL = strSQL & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
				strSQL = strSQL & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
				strSQL = strSQL & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
			If regPlus <> 0 Then regPlus = 1
		End If
		GoTo procFin
		
procErr: 
		
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Envío de mensaje", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fEnv_Mens")
		Mostrar_Error()
		logError("fEnv_Mens - " & Err.Description)
		Resume procFin
		
procFin: 
		
	End Function
	
	
	Private Sub msBuscarCancel(ByRef rstTram As ADODB.Recordset)
		
		On Error GoTo procErr
		
		Dim rstTram2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim strSQL As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim strPath As String
		
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
		strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND "
		strSQL = strSQL & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND "
		strSQL = strSQL & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
		
		rstTram2 = mfRecordset(conPasarela, strSQL)
		
		If rstTram2.Fields("INDCANCEL").Value = "P" Then
			strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
			strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
			strSQL = strSQL & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
			strSQL = strSQL & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngORACC = Val(rstAux.Fields(0).Value & "") + 1
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CANCEL'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			strPath = "CNL ALERTA" & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "CANCEL", lngNumAcc, "", strPath, 0, 0, "", "", "")
			
			
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='ALERT' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
			rstAux = mfRecordset(conPasarela, strSQL)
			blnInserta = False
			msInsertaParamAcc("PATH", rstAux.Fields("PATH_HIDRA").Value, rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
			blnInserta = True
			strSQL = "select * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "ORDEN_ACC=" & lngORACC - 1
			rstAux = mfRecordset(conPasarela, strSQL)
			
			If rstAux.Fields("NOM_ACCION").Value = "JUMP" Then
				strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & lngORACC + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
				mfExecute(conPasarela, strSQL)
				
				strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & lngORACC + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
				mfExecute(conPasarela, strSQL)
			End If
			
		End If
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'    MsgBox Err.Description
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Buscar Cancel", "Ha ocurrido un error no controlado", "msBuscarCancel")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msBuscarCancel - " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	
	
	
	
	Private Sub msFirma(ByVal rstTram As ADODB.Recordset)
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim strPath As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		
		On Error GoTo procErr
		
		strSQL = "SELECT * " & "FROM ACCIONES " & "WHERE DESACCHN = 'BUSCARUNITRAMITADORAFIRMA'"
		rstAcc = mfRecordset(conInfra, strSQL)
		If Not rstAcc.EOF Then
			strSQL = "SELECT MAX(ORDEN_ACC) " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " " & "AND ORDEN_ACC <> 999"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngORACC = Val(rstAux.Fields(0).Value & "") + 1
			strSQL = "SELECT COUNT(*) " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND NOM_ACCION = 'BUSCARUNITRAMITADORAFIRMA'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			
			'Insertamos la llamada a la acción de gestión BUSCARUNITRAMITADORAFIRMA
			strPath = "APE_" & Mid("BUSCARUNITRAMITADORAFIRMA", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA, TIPO_ACCION) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'BUSCARUNITRAMITADORAFIRMA', " & lngNumAcc & ", " & "'" & strPath & "', " & "'" & rstAcc.Fields("INDTIPOA").Value & "')"
			mfExecute(conPasarela, strSQL)
			blnInserta = True
			msInsertaParamAcc("@CODDOCUM", "@INICIO!CODIGODOCUMENTOEMITIDO", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@NOMBRE_FORMULARIO_IN", vbNullString, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			blnInserta = False
			
			lngORACC = lngORACC + 1
			
			'Insertamos el EDP correspondiente a la acción BUSCARUNITRAMITADORAFIRMA
			strPath = "EDP_" & Mid("BUSCARUNITRAMITADORAFIRMA", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'ENDPROC', " & lngNumAcc & ", " & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			lngORACC = lngORACC + 1
			
			'Insertamos el PRO correspondiente a la acción BUSCARUNITRAMITADORAFIRMA
			strPath = "PRO_" & Mid("BUSCARUNITRAMITADORAFIRMA", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'PROCESS', " & lngNumAcc & ", " & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			'Actualizamos el PATHRETORNO
			strSQL = "UPDATE PARAM_ACC " & "SET VALOR = '" & strPath & "' " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND PARAMETRO = '@PATHRETORNO' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " " & "AND ORDEN_ACC = (SELECT ORDEN_ACC " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " " & "AND NOM_ACCION = 'BUSCARUNITRAMITADORAFIRMA') " & "AND VALOR = '@INICIO!PATHRETORNO'"
			mfExecute(conPasarela, strSQL)
		Else
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "La acción  BUSCARUNITRAMITADORAFIRMA no se encuentra en la tabla de conversión", "msFirma")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
		End If
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'MsgBox Err.Description
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Trámite de Firma", "Ha ocurrido un error no controlado", "msFirma")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msFirma - " & Err.Description)
		Resume procFin
		
procFin: 
		
	End Sub
	
	'##
	Private Sub msBuscarvbFirma(ByVal rstTram As ADODB.Recordset, ByVal strTipTram As String)
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim strPath As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		
		On Error GoTo procErr
		
		strSQL = "SELECT * " & "FROM ACCIONES " & "WHERE DESACCHN = 'BUSCARVBFIRMA'"
		rstAcc = mfRecordset(conInfra, strSQL)
		If Not rstAcc.EOF Then
			strSQL = "SELECT MAX(ORDEN_ACC) " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " " & "AND ORDEN_ACC <> 999"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngORACC = Val(rstAux.Fields(0).Value & "") + 1
			strSQL = "SELECT COUNT(*) " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND NOM_ACCION = 'BUSCARVBFIRMA'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			
			'Insertamos la llamada a la acción de gestión BUSCARVBFIRMA
			strPath = "APE_" & Mid("BUSCARVBFIRMA", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA, TIPO_ACCION) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'BUSCARVBFIRMA', " & lngNumAcc & ", " & "'" & strPath & "', " & "'" & rstAcc.Fields("INDTIPOA").Value & "')"
			mfExecute(conPasarela, strSQL)
			blnInserta = True
			'Inseertamos los Parámetros Específicos de la acción
			'04/03/2019 se añade y se comprueba el parámetro strTipTram J.Lerma
			If strTipTram = "5" Or strTipTram = "@" Then
				msInsertaParamAcc("@CODDOCUM", "@INICIO!CODIGODOCUMENTOEMITIDO", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			ElseIf strTipTram = "0" Then 
				msInsertaParamAcc("@CODDOCUM", "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			End If
			
			msInsertaParamAcc("@ASUNTO_DELEGACION_IN", "@INICIO!" & strVarAsuntoDelegacion, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@ULTIMO_DOCU_VB_IN", "@INICIO!" & strVarUltimoDocVB, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@ORGANICO_SIGUIENTE_VB_IN", "@INICIO!ORGANICO_SIGUIENTE_VB", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@NOMBRE_FORMULARIO_IN", vbNullString, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@ID_CIRCUITO_IN", "@INICIO!" & strVarIDCircuito, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@IND_PRIMER_VB_OUT", strVarIndPrimerVB, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@IND_ULTIMO_VB_OUT", strVarIndUltimoVB, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@IND_VISTO_BUENO_OUT", strVarIndVB, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@ULTIMO_DOCU_VB_OUT", strVarUltimoDocVB, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			blnInserta = False
			
			lngORACC = lngORACC + 1
			
			'Insertamos el EDP correspondiente a la acción BUSCARVBFIRMA
			strPath = "EDP_" & Mid("BUSCARVBFIRMA", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'ENDPROC', " & lngNumAcc & ", " & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			lngORACC = lngORACC + 1
			
			'Insertamos el PRO correspondiente a la acción BUSCARVBFIRMA
			strPath = "PRO_" & Mid("BUSCARVBFIRMA", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'PROCESS', " & lngNumAcc & ", " & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			'Actualizamos el PATHRETORNO
			strSQL = "UPDATE PARAM_ACC " & "SET VALOR = '" & strPath & "' " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND PARAMETRO = '@PATHRETORNO' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value
			mfExecute(conPasarela, strSQL)
		Else
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "La acción  BUSCARVBFIRMA no se encuentra en la tabla de conversión", "msBuscarvbFirma")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
		End If
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'MsgBox Err.Description
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Trámite de VB Firma", "Ha ocurrido un error no controlado", "msBuscarvbFirma")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msFirma - " & Err.Description)
		Resume procFin
		
procFin: 
		
	End Sub
	'##
	
	Private Sub msObtenerResponsableFirmaExterno(ByVal rstTram As ADODB.Recordset, ByVal strTipTram As String)
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim strPath As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		
		On Error GoTo procErr
		
		strSQL = "SELECT * " & "FROM ACCIONES " & "WHERE DESACCHN = 'OBTENER_RESPONSABLE_FIRMA_EXTERNO'"
		rstAcc = mfRecordset(conInfra, strSQL)
		If Not rstAcc.EOF Then
			strSQL = "SELECT MAX(ORDEN_ACC) " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value & " " & "AND ORDEN_ACC <> 999"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngORACC = Val(rstAux.Fields(0).Value & "") + 1
			strSQL = "SELECT COUNT(*) " & "FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND NOM_ACCION = 'OBTENER_RESPONSABLE_FIRMA_EXTERNO'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			
			'Insertamos la llamada a la acción de gestión OBTENER_RESPONSABLE_FIRMA_EXTERNO
			strPath = "APE_" & Mid("OBTENER_RESPONSABLE_FIRMA_EXTERNO", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA, TIPO_ACCION) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'OBTENER_RESPONSABLE_FIRMA_EXTERNO', " & lngNumAcc & ", " & "'" & strPath & "', " & "'" & rstAcc.Fields("INDTIPOA").Value & "')"
			mfExecute(conPasarela, strSQL)
			blnInserta = True
			'Inseertamos los Parámetros Específicos de la acción
			msInsertaParamAcc("@CODDOCUM", "@INICIO!CODIGODOCUMENTOEMITIDO", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@ID_CIRCUITO_IN", "@INICIO!" & strVarIDCircuito, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("@NOMBRE_FORMULARIO_IN", vbNullString, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			blnInserta = False
			
			lngORACC = lngORACC + 1
			
			'Insertamos el EDP correspondiente a la acción OBTENER_RESPONSABLE_FIRMA_EXTERNO
			strPath = "EDP_" & Mid("OBTENER_RESPONSABLE_FIRMA_EXTERNO", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'ENDPROC', " & lngNumAcc & ", " & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			lngORACC = lngORACC + 1
			
			'Insertamos el PRO correspondiente a la acción OBTENER_RESPONSABLE_FIRMA_EXTERNO
			strPath = "PRO_" & Mid("OBTENER_RESPONSABLE_FIRMA_EXTERNO", 1, 19) & VB6.Format(lngNumAcc, "00")
			strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, NOM_ACCION, NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "', " & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & ", " & rstTram.Fields("ORDEN_N4").Value & ", " & rstTram.Fields("ORDEN_N5").Value & ", " & lngORACC & ", " & "'PROCESS', " & lngNumAcc & ", " & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			'Actualizamos el PATHRETORNO
			strSQL = "UPDATE PARAM_ACC " & "SET VALOR = '" & strPath & "' " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND PARAMETRO = '@PATHRETORNO' " & "AND ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value
			mfExecute(conPasarela, strSQL)
		Else
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "La acción  OBTENER_RESPONSABLE_FIRMA_EXTERNO no se encuentra en la tabla de conversión", "msObtenerResponsableFirmaExterno")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
		End If
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'MsgBox Err.Description
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Trámite de VB Firma", "Ha ocurrido un error no controlado", "msObtenerResponsableFirmaExterno")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msFirma - " & Err.Description)
		Resume procFin
		
procFin: 
		
	End Sub
	
	Private Sub msVBResp1(ByVal rstTram As ADODB.Recordset)
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim strPath As String
		Dim strPathD As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		
		If rstTram.Fields("ORDEN_N2").Value = 0 Then
			strPathD = rstTram.Fields("ORDEN_N1").Value + 1 & ";0;0;0;0"
		ElseIf rstTram.Fields("ORDEN_N3").Value = 0 Then 
			strPathD = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value + 1 & ";0;0;0"
		ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
			strPathD = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value + 1 & ";0;0"
		ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
			strPathD = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value + 1 & ";0"
		End If
		
		strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN like 'BUSCARRESPONSABLE%'"
		rstAcc = mfRecordset(conInfra, strSQL)
		If Not rstAcc.EOF Then
			strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngORACC = Val(rstAux.Fields(0).Value & "") + 1
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='BUSCARRESPONSABLE'"
			
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			strPath = "APE_" & Mid("BUSCARRESPONSABLE", 1, 19) & VB6.Format(lngNumAcc, "00")
			
			strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA, TIPO_ACCION) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'BUSCARRESPONSABLE'," & lngNumAcc & "," & "'" & strPath & "','" & rstAcc.Fields("INDTIPOA").Value & "')"
			mfExecute(conPasarela, strSQL)
			blnInserta = True
			msInsertaParamAcc("@PATHNORESPONSABLE", strPathD, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			blnInserta = False
			lngORACC = lngORACC + 1
			strPath = "EDP_" & Mid("BUSCARRESPONSABLE", 1, 19) & VB6.Format(lngNumAcc, "00")
			
			strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'ENDPROC'," & lngNumAcc & "," & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			lngORACC = lngORACC + 1
			strPath = "PRO_" & Mid("BUSCARRESPONSABLE", 1, 19) & VB6.Format(lngNumAcc, "00")
			
			strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'PROCESS'," & lngNumAcc & "," & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
			mfExecute(conPasarela, strSQL)
		Else
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "La acción  BUSCARRESPONSABLE no se encuentra en la tabla de conversión", "msVBResp1")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
		End If
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'MsgBox Err.Description
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "VºBº Responsable 1er nivel", "Ha ocurrido un error no controlado", "msVBResp1")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msVBResp1 - " & Err.Description)
		Resume procFin
procFin: 
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rstAcc)
		'UPGRADE_NOTE: Object rstAcc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAcc = Nothing
	End Sub
	
	
	Private Sub msVBResp2(ByVal rstTram As ADODB.Recordset)
		
		On Error GoTo procErr
		
		
		Dim rstAux As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstTram2 As ADODB.Recordset
		Dim strSQL As String
		Dim strPath As String
		Dim strPath2 As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		
		strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
		strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value
		rstTram2 = mfRecordset(conPasarela, strSQL)
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE = " & rstTram2.Fields("DIAGRAMA").Value & " And "
		strSQL = strSQL & "NUM_SEQ=" & rstTram2.Fields("NUM_SEC_HASTA").Value
		rstTram2 = mfRecordset(conPasarela, strSQL)
		strPath2 = rstTram2.Fields("ORDEN_N1").Value & ";" & rstTram2.Fields("ORDEN_N2").Value & ";" & rstTram2.Fields("ORDEN_N3").Value & ";" & rstTram2.Fields("ORDEN_N4").Value & ";" & rstTram2.Fields("ORDEN_N5").Value
		strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN like 'BUSCARRESPONSABLE%'"
		rstAcc = mfRecordset(conInfra, strSQL)
		If Not rstAcc.EOF Then
			strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
			strSQL = strSQL & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
			strSQL = strSQL & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
			strSQL = strSQL & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngORACC = Val(rstAux.Fields(0).Value & "") + 1
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='BUSCARRESPONSABLE'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			strPath = "APE_" & Mid("BUSCARRESPONSABLE", 1, 19) & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "BUSCARRESPONSABLE", lngNumAcc, rstAcc.Fields("INDTIPOA").Value, strPath, 0, 0, "", "", "")
			blnInserta = True
			msInsertaParamAcc("@PATHNORESPONSABLE", strPath2, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			blnInserta = False
			lngORACC = lngORACC + 1
			strPath = "EDP_" & Mid("BUSCARRESPONSABLE", 1, 19) & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "ENDPROC", lngNumAcc, "", strPath, 0, 0, "", "", "")
			lngORACC = lngORACC + 1
			strPath = "PRO_" & Mid("BUSCARRESPONSABLE", 1, 19) & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "PROCESS", lngNumAcc, "", strPath, 0, 0, "", "", "")
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
			strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
			strSQL = strSQL & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
			mfExecute(conPasarela, strSQL)
		Else
			Insertar_Error(Me, "Lectura de acciones de trámite", "La acción  BUSCARRESPONSABLE no se encuentra en la tabla de conversión", "msVBResp2")
			Mostrar_Error()
		End If
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "VºBº Responsable 2º nivel", "Ha ocurrido un error no controlado", "msVBResp2")
		Mostrar_Error()
		logError("msVBResp2 - " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	
	
	Private Sub msRepaso()
		On Error GoTo procErr
		Dim rstTram As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux4B As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim rstAux7 As ADODB.Recordset
		Dim rstAUX8 As ADODB.Recordset
		Dim rstAUX9 As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstPAR As ADODB.Recordset
		Dim rstCol As ADODB.Recordset
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim strSQL As String
		Dim strTipo As String
		Dim lngOrBuscar As String
		Dim lngVar1 As Integer
		Dim lngVar2 As Integer
		Dim lngVar3 As Integer
		Dim lngVar4 As Integer
		Dim lngVar5 As Integer
		Dim lngOr2 As Integer
		Dim lngOr3 As Integer
		Dim lngOr4 As Integer
		Dim lngOr5 As Integer
		Dim icol As Object
		Dim lngFIN As Integer
		Dim strAccSig As String
		Dim strTramSig As String
		Dim I As Integer
		Dim regActual As Integer
		Dim j As Integer
		Dim strNomTram As String
		Dim blnEncon As Boolean
		Dim blnfin As Boolean
		Dim strsalto As String
		Dim blnEn1 As Boolean
		Dim blnEN2 As Boolean
		Dim blnEN3 As Boolean
		Dim strSaltIn As String
		Dim bln2SALTO As Boolean
		Dim strPath As String
		Dim numconectoresvalidos As Integer
		
		lblMensaje.Text = "Finalizando Proceso"
		msProceso(1, 16, 1, 1)
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='@INICIO!ORDENTRA'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			strSQL = "SELECT ORDENTRA FROM TBPFIN03_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOMBRE=(SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & ")"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			If Not rstAux2.EOF Then
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2.Fields("ORDENTRA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@ORDENTRA' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
				mfExecute(conPasarela, strSQL)
			End If
			rstAux.MoveNext()
		End While
		msProceso(2, 16, 1, 1)
		For	Each icol In colCancel
			rstCol = icol
			If rstCol.State = ADODB.ObjectStateEnum.adStateOpen Then msBuscarCancel(rstCol)
		Next icol
		lblMensaje.Text = "Finalizando Proceso"
		msProceso(3, 16, 1, 1)
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND INDJUMP='S'"
		rstTram = mfRecordset(conPasarela, strSQL)
		While Not rstTram.EOF
			lngVar2 = rstTram.Fields("ORDEN_N2").Value
			lngVar3 = rstTram.Fields("ORDEN_N3").Value
			lngVar4 = rstTram.Fields("ORDEN_N4").Value
			lngVar5 = rstTram.Fields("ORDEN_N5").Value
			strTipo = rstTram.Fields("CAT_DIAGRAMA").Value
inicio: 
			lngOrBuscar = CStr(1)
			If strTipo = "Ramificación" Then
				If lngVar2 = 0 Then
					lngOrBuscar = CStr(2)
				Else
					If lngVar3 = 0 Then
						lngOrBuscar = CStr(3)
					Else
						If lngVar4 = 0 Then
							lngOrBuscar = CStr(4)
						Else
							If lngVar5 = 0 Then
								lngOrBuscar = CStr(5)
							End If
						End If
					End If
				End If
			End If
			strSQL = "SELECT MAX("
			strSQL = strSQL & """ORDEN_N" & lngOrBuscar & """) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			lngOr2 = 0 : lngOr3 = 0 : lngOr4 = 0 : lngOr5 = 0
			Select Case lngOrBuscar
				Case CStr(1)
					lngOr2 = rstTram.Fields("ORDEN_N2").Value
					lngOr3 = rstTram.Fields("ORDEN_N3").Value
					lngOr4 = rstTram.Fields("ORDEN_N4").Value
					lngOr5 = rstTram.Fields("ORDEN_N5").Value
				Case CStr(2)
					strSQL = strSQL & "ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngVar2 + 1
					rstAux = mfRecordset(conPasarela, strSQL)
					lngOr2 = rstAux.Fields(0).Value
				Case CStr(3)
					lngOr2 = lngVar2
					strSQL = strSQL & "ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngVar2 & " AND ORDEN_N3 = " & lngVar3 + 1
					rstAux = mfRecordset(conPasarela, strSQL)
					lngOr3 = rstAux.Fields(0).Value
				Case CStr(4)
					lngOr2 = lngVar2
					lngOr3 = lngVar3
					strSQL = strSQL & "ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngVar2 & " AND ORDEN_N3 = " & lngVar3 & " AND ORDEN_N4 = " & lngVar4 + 1
					rstAux = mfRecordset(conPasarela, strSQL)
					lngOr4 = rstAux.Fields(0).Value
				Case CStr(5)
					lngOr2 = lngVar2
					lngOr3 = lngVar3
					lngOr4 = lngVar4
					strSQL = strSQL & "ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngVar2 & " AND ORDEN_N3 = " & lngVar3 & " AND ORDEN_N4 = " & lngVar4 & " AND ORDEN_N5 = " & lngVar5 + 1
					rstAux = mfRecordset(conPasarela, strSQL)
					lngOr5 = rstAux.Fields(0).Value
			End Select
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngOr2 & " AND ORDEN_N3 = " & lngOr3 & " AND ORDEN_N4 = " & lngOr4 & " AND ORDEN_N5 = " & lngOr5
			rstAux = mfRecordset(conPasarela, strSQL)
			If rstAux.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
				lngVar2 = rstAux.Fields("ORDEN_N2").Value
				lngVar3 = rstAux.Fields("ORDEN_N3").Value
				lngVar4 = rstAux.Fields("ORDEN_N4").Value
				lngVar5 = rstAux.Fields("ORDEN_N5").Value
				strTipo = rstTram.Fields("CAT_DIAGRAMA").Value
				GoTo inicio
			End If
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=999"
			rstAcc = mfRecordset(conPasarela, strSQL)
			strSQL = "DELETE FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=999"
			mfExecute(conPasarela, strSQL)
			strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=999"
			rstPAR = mfRecordset(conPasarela, strSQL)
			strSQL = "DELETE FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=999"
			mfExecute(conPasarela, strSQL)
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			rstAux2.MoveNext()
			rstTram.MoveNext()
		End While
		msProceso(4, 16, 1, 1)
		lblMensaje.Text = "Finalizando Proceso"
		
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@ORDTRACADUCAR'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			strSQL = "SELECT ORDENTRA FROM TBPFIN03_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOMBRE='" & rstAux.Fields("VALOR").Value & "'"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			If Not rstAux2.EOF Then
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2.Fields("ORDENTRA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@ORDTRACADUCAR' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
				'aketza errores
				mfExecute(conPasarela, strSQL)
			Else
				Insertar_Error(Me, "Lectura de Acciones de trámite", "No se puede asignar el Orden de Trámite a Caducar en el orden " & rstAux.Fields("ORDEN_N1").Value & "-" & rstAux.Fields("ORDEN_N2").Value & "-" & rstAux.Fields("ORDEN_N3").Value & "-" & rstAux.Fields("ORDEN_N4").Value & "-" & rstAux.Fields("ORDEN_N5").Value, "msRepaso")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
			End If
			rstAux.MoveNext()
		End While
		lblMensaje.Text = "Finalizando Proceso"
		msProceso(5, 16, 1, 1)
		'''solucion de jumps
		msSolucionJumps(False)
		'''''
		'*14/09/2004
		
		msProceso(6, 16, 1, 1)
		'## DS66 02/04/09 msConectoresOpcionales se ejecutaba despues de msMetoCaducar, y si habia caducar metia conectores opcionales despues del caducar, por lo q nunca se ejecutaba
		'msConectoresOpcionales
		'##
		'Inicio Jonathan Prieto 25/02/2011: el tratamiento para Conectores Opcionales debe estar antes que el de Caducar Alertas
		'msMetoCaducar
		'Fin Jonathan Prieto 25/02/2011
		
		'''''
		
		msProceso(7, 16, 1, 1)
		
		''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		msEnlaces_sin_Definir()
		msSolucionJumps(True)
		msJumpsNoDetectados()
		''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		
		msProceso(8, 16, 1, 1)
		msConectoresOpcionales()
		'Inicio Jonathan Prieto 25/02/2011: el tratamiento para Conectores Opcionales debe estar antes que el de Caducar Alertas
		msMetoCaducar()
		'Inicio Jonathan 11/01/2012
		msEnlaces_sin_Definir()
		'Fin Jonathan 11/01/2012
		'Fin Jonathan Prieto 25/02/2011
		'msProceso 9, 16, 1, 1
		'FIN Proc
		
		strSQL = "SELECT MAX(ORDEN_N1) FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
		rstAux = mfRecordset(conPasarela, strSQL)
		lngFIN = rstAux.Fields(0).Value + 1
		
		'strSQL = "INSERT INTO DIAGRAMA (*) VALUES " _
		'& "(" & lngFIN & ",0," & colPasar(1)(0) & ", 0,'S','Fin Expediente')"
		'UPGRADE_WARNING: Couldn't resolve default property of object colPasar()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ID_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NOMBRE) VALUES " & "('" & gNomProcCorto & "'," & lngFIN & ",0," & colPasar.Item(1)(0) & ", 999999,'S','Fin Expediente')"
		mfExecute(conPasarela, strSQL)
		
		mfInserta_PROPIEDADES(lngFIN, 0, 0, 0, 0, 0, "PR_FINEXPEDIENTE", "", "", "", "", "", "", "0")
		
		'strSQL = "INSERT INTO PROPIEDADES_DI (PROCEDIMIENTO,ORDEN_N1,ID_DIAGRAMA,NOM_DIAGRAMA) VALUES (" _
		'& "'" & gNomProcCorto & "'," & lngFIN & ",0,'PR_FINEXPEDIENTE')"
		'mfExecute conPasarela, strSQL
		
		strSQL = "SELECT MAX(ORDENTRA) FROM TBPFIN03_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
		rstAux = mfRecordset(conPasarela, strSQL)
		
		'strSQL = "INSERT INTO TBPFIN03_PA (CODPROCE,ORDENTRA,CODTRAAD," _
		'& "NOMBRE) VALUES (" _
		'& lngCodProc & "," & rstAUX(0) + 1 & ",0," _
		'& "'PR_FINEXPEDIENTE')"
		strSQL = "INSERT INTO TBPFIN03_PA (PROCEDIMIENTO,CODPROCE,ORDENTRA,CODTRAAD," & "NOMBRE) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & rstAux.Fields(0).Value + 1 & ",999999," & "'PR_FINEXPEDIENTE')"
		mfExecute(conPasarela, strSQL)
		
		
		strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN='FINEXPEDIENTE'"
		rstAux = mfRecordset(conInfra, strSQL)
		'Set rstAUX = mfRecordset(conGene, strSQL)
		
		strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "ID_ACCION,NOM_ACCION,NUM_ACCION," & "TIPO_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngFIN & ", 0, 0" & ", 0, 0, 1," & rstAux.Fields("IDACCION").Value & ",'FINEXPEDIENTE', 1," & "'" & rstAux.Fields("INDTIPOA").Value & "','APE_FINEXPEDIENTE')"
		mfExecute(conPasarela, strSQL)
		
		blnInserta = True
		msInsertaParamAcc("", "", lngFIN, 0, 0, 0, 0, 1)
		
		lngORACC = lngORACC + 1
		
		strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngFIN & ", 0, 0" & ", 0, 0, 2," & "'ENDPROC', 1 ," & "'EDP_FINEXPEDIENTE')"
		mfExecute(conPasarela, strSQL)
		
		strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngFIN & ", 0, 0" & ", 0, 0, 3," & "'PROCESS', 1 ," & "'PRO_FINEXPEDIENTE')"
		mfExecute(conPasarela, strSQL)
		
		strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_FINEXPEDIENTE' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and " & "ORDEN_N1=" & lngFIN & " AND ORDEN_N2=0" & " AND ORDEN_N3=0" & " AND ORDEN_N4=0" & " AND ORDEN_N5=0"
		mfExecute(conPasarela, strSQL)
		strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngFIN & ", 0, 0" & ", 0, 0, 4," & "'ENDPROC', 1 ," & "'EDP_ENDEXPEDIENTE')"
		mfExecute(conPasarela, strSQL)
		strSQL = "UPDATE DIAGRAMA SET EXPLOTA_ACC='S' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=0"
		mfExecute(conPasarela, strSQL)
		msProceso(10, 16, 1, 1)
		
		
		'''resolucion conectores tipo plazo 2
		
		msResolPlazTip2()
		
		''''''FLY DE SALIDA DE TRAMITE
		
		msProceso(11, 16, 1, 1)
		
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA IN (SELECT DISTINCT " & "CODTRAAD FROM TBPFIN03_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND INDPROCE='A')"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			strSQL = "UPDATE PARAM_ACC SET VALOR='WEHYN001' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "PARAMETRO='@USUARIO' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
			mfExecute(conPasarela, strSQL)
			rstAux.MoveNext()
		End While
		msProceso(12, 16, 1, 1)
		msSolucionRampa()
		msProceso(13, 16, 1, 1)
		msFly()
		msProceso(14, 16, 1, 1)
		msSolucionWait()
		msProceso(15, 16, 1, 1)
		msSolucionCaducar()
		
		strSQL = "DELETE FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='PROCESOFALSO'"
		mfExecute(conPasarela, strSQL)
		strSQL = "DELETE FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITMOMENTANEO'"
		mfExecute(conPasarela, strSQL)
		strSQL = "DELETE FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PATH_HIDRA='PRO_FINTRAMITEELIMINAR'"
		mfExecute(conPasarela, strSQL)
		
		'resolucion de variables
		msResolVariables()
		'''''
		'## DS66 18/01/10 Resolucion de Plazo1
		msResolPlazo1()
		'''''
		
		Dim colBusqueda As Collection
		colBusqueda = New Collection
		strSQL = "select VALOR from param_acc WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND replace(valor,'_','X') like 'PRX%' and valor not like 'PRO_%'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			strSQL = "select ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5 from PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA='" & rstAux.Fields("VALOR").Value & "'"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			strSQL = "SELECT EXPLOTA_ACC FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
			rstAux3 = mfRecordset(conPasarela, strSQL)
			If Not rstAux3.EOF Then
				If rstAux3.Fields("EXPLOTA_ACC").Value = "N" Then
					colBusqueda.Add(CStr(rstAux.Fields("VALOR").Value))
				End If
			End If
			rstAux.MoveNext()
		End While
		
		For	Each icol In colBusqueda
			'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA='" & icol & "'"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			If Not rstAux2.EOF Then
				If rstAux2.Fields("ORDEN_N2").Value = 0 Then
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=1 ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=1 ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 =" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 =1 ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 =" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=1  ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
				End If
				rstAux2 = mfRecordset(conPasarela, strSQL)
				Do While Not rstAux2.EOF
					If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2.Fields("NOM_DIAGRAMA").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "'"
						mfExecute(conPasarela, strSQL)
						Exit Do
					End If
					rstAux2.MoveNext()
				Loop 
			End If
		Next icol
		strSQL = "SELECT PATH_HIDRA From ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION<>'PROCESOFALSO' GROUP BY PATH_HIDRA" & " Having (Count(PATH_HIDRA) > 1)"
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			'aketza errores
			Insertar_Error(Me, "Repaso", "Se han duplicado acciones", "msRepaso")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
		End If
		'rev 1.3.0.2
		strSQL = "SELECT * FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDENTRA=0"
		rstAux = mfRecordset(conPasarela, strSQL)
		If rstAux.EOF Then
			strSQL = "SELECT * FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDENTRA=1"
			rstAux = mfRecordset(conPasarela, strSQL)
			While Not rstAux.EOF
				'****????¿¿¿¿**** Esta insert na error de priamry key
				strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) "
				strSQL = strSQL & "VALUES "
				strSQL = strSQL & "('" & gNomProcCorto & "'," & rstAux.Fields("CODPROCE").Value & ", 0, 0,'" & rstAux.Fields("CODUNITR").Value & "', '" & rstAux.Fields("CODUTRHN").Value & "','" & rstAux.Fields("INDTRAMI").Value & "','" & rstAux.Fields("INDCOMUN").Value & "')"
				mfExecute(conPasarela, strSQL)
				rstAux.MoveNext()
			End While
		End If
		'rev 1.3.0.2 END
		
		msProceso(16, 16, 1, 1)
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Repaso", "Ha ocurrido un error no controlado", "msRepaso")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msRepaso - " & Err.Description)
		If Err.Number = 3704 Then
			Resume Next
		End If
		Resume procFin
		
procFin: 
		CierraRS(rstTram)
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rstAux2)
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		CierraRS(rstAux3)
		'UPGRADE_NOTE: Object rstAux3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux3 = Nothing
		CierraRS(rstAux4)
		'UPGRADE_NOTE: Object rstAux4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux4 = Nothing
		CierraRS(rstAux5)
		'UPGRADE_NOTE: Object rstAux5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux5 = Nothing
		CierraRS(rstAux6)
		'UPGRADE_NOTE: Object rstAux6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux6 = Nothing
		CierraRS(rstAux7)
		'UPGRADE_NOTE: Object rstAux7 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux7 = Nothing
		CierraRS(rstAUX8)
		'UPGRADE_NOTE: Object rstAUX8 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAUX8 = Nothing
		CierraRS(rstAUX9)
		'UPGRADE_NOTE: Object rstAUX9 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAUX9 = Nothing
		CierraRS(rstAcc)
		'UPGRADE_NOTE: Object rstAcc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAcc = Nothing
		CierraRS(rstPAR)
		'UPGRADE_NOTE: Object rstPAR may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstPAR = Nothing
		CierraRS(rstCol)
		'UPGRADE_NOTE: Object rstCol may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstCol = Nothing
	End Sub
	
	
	Private Sub msPlazT2(ByRef rstTram As ADODB.Recordset, ByRef strPlazo As String, ByVal blnIndVar As Boolean)
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim strSQL1 As String
		Dim rst As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamHN As ADODB.Recordset
		Dim rstCon As ADODB.Recordset
		Dim blnPrim As Boolean
		Dim strIns As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim strPath As String
		Dim strPath2 As String
		Dim strPathAL As String
		Dim strJOINER As String
		Dim lngOr2 As Integer
		Dim lngOr3 As Integer
		Dim lngOr4 As Integer
		Dim lngOr5 As Integer
		Dim lngOrP2 As Integer
		Dim lngOrP3 As Integer
		Dim lngOrP4 As Integer
		Dim lngOrP5 As Integer
		Dim nomVarHN As String
		Dim colAux As Collection
		Dim colXMLD As Collection
		Dim strNomTram As String
		Dim lngF As Integer
		Dim lngOrBuscar As Integer
		Dim lngVar2 As Integer
		Dim lngVar3 As Integer
		Dim lngVar4 As Integer
		Dim lngVar5 As Integer
		Dim strTipo As String
		Dim ATID As Integer
		Dim ATNAME As String
		Dim lngHasta As Integer
		
		'HALLAMOS EL TRAMITE/RAMIFICACION A LA QUE VA EL CONECTOR DE TIPO2
		If rstTram.Fields("NUM_DIAGRAMA").Value = 1 Then
			'strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram("ID_PADRE") & " AND CAT_CONECTOR='Fin de plazo 2'"
			strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND CAT_CONECTOR='Fin de plazo 2' AND ORDEN_N1=0 and NUM_SEC_DESDE= " & rstTram.Fields("NUM_SEQ").Value
		ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 2 Then 
			strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND CAT_CONECTOR='Fin de plazo 2' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=0 and NUM_SEC_DESDE= " & rstTram.Fields("NUM_SEQ").Value
		ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then 
			strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND CAT_CONECTOR='Fin de plazo 2' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=0 and NUM_SEC_DESDE= " & rstTram.Fields("NUM_SEQ").Value
		ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 4 Then 
			strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND CAT_CONECTOR='Fin de plazo 2' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " And ORDEN_N4 = 0 and NUM_SEC_DESDE= " & rstTram.Fields("NUM_SEQ").Value
		ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 5 Then 
			strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND CAT_CONECTOR='Fin de plazo 2' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " And ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value
		End If
		rstCon = mfRecordset(conPasarela, strSQL)
		If rstCon.EOF Then
			Insertar_Error(Me, "Lectura de Trámite/Ramificación", "No se encuentra el conector con categoría Fin de Plazo 2", "msPlazT2")
			Mostrar_Error()
			Exit Sub
		End If
		System.Windows.Forms.Application.DoEvents()
		While Not rstCon.EOF
			lngHasta = rstCon.Fields("NUM_SEC_HASTA").Value
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstCon.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstCon.Fields("NUM_SEC_DESDE").Value & " AND SH_SEQ_TO=" & rstCon.Fields("NUM_SEC_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstCon.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				System.Windows.Forms.Application.DoEvents()
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			System.Windows.Forms.Application.DoEvents()
			rstCon.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where "
			strSQL = strSQL & "C.CO_ID IN (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL)
			If Not rstParamCMS.EOF Then
				ATID = rstParamCMS.Fields("AT_ID").Value
				ATNAME = rstParamCMS.Fields("AT_NAME").Value
			Else
				ATID = 0
				ATNAME = ""
			End If
		Else
			Insertar_Error(Me, "Lectura de Trámite/Ramificación", "No se encuentra la variable en el conector Fin de Plazo 2", "msPlazT2")
			Mostrar_Error()
			Exit Sub
		End If
		rstCon.MoveFirst()
		'Inicio Jonathan Prieto 11/02/2011: varias alertas Plazo Tipo 2 que salen del mismo trámite
		While Not rstCon.EOF
			lngORACC = 0
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstCon.Fields("NUM_SEC_HASTA").Value
			rst = mfRecordset(conPasarela, strSQL)
			If rst.EOF Then
				rstCon.MoveNext()
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstCon.Fields("NUM_SEC_HASTA").Value
				rst = mfRecordset(conPasarela, strSQL)
			End If
			
			If rst.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
				If rst.Fields("ORDEN_N2").Value = 0 Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst.Fields("ORDEN_N1").Value & " AND ORDEN_N2 > 0 AND ORDEN_N3 = 0"
					rst2 = mfRecordset(conPasarela, strSQL)
					If rst2.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3>0 order by orden_n3 desc"
						rstAux4 = mfRecordset(conPasarela, strSQL)
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value
						rst2 = mfRecordset(conPasarela, strSQL)
					End If
				ElseIf rst.Fields("ORDEN_N3").Value = 0 Then 
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst.Fields("ORDEN_N2").Value & " AND ORDEN_N3 > 0 AND "
					strSQL = CStr(strSQL & rst.Fields("ORDEN_N4").Value = 0 & " AND SH_SEQ=" & rst.Fields("NUM_SEC_DESDE").Value)
					rst2 = mfRecordset(conPasarela, strSQL)
					If rst2.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND "
						strSQL = strSQL & "ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4>0 order by orden_n3 desc"
						rstAux4 = mfRecordset(conPasarela, strSQL)
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND "
						strSQL = strSQL & "ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value
						rst2 = mfRecordset(conPasarela, strSQL)
					End If
				End If
			Else
				rst2 = rst
			End If
			
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CREARALERTA'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			strPath = "APE_CREARALERTA" & VB6.Format(lngNumAcc, "00")
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value & " AND NOM_ACCION='CREARALERTA'"
			rstAux = mfRecordset(conPasarela, strSQL)
			If rstAux.Fields(0).Value > 0 Then Exit Sub
			strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN='CREARALERTA'"
			rstAux = mfRecordset(conInfra, strSQL)
			'INSERTO LA ACCIÓN CREARALERTA
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, rstAux.Fields("IDACCION").Value, "CREARALERTA", lngNumAcc, rstAux.Fields("INDTIPOA").Value, strPath, 0, 0, "", "S", "")
			strSQL = "SELECT FlowOrder From wfFlowActions WHERE (RTRIM(Flow)='CREARALERTA')"
			strSQL = strSQL & " AND (RTRIM(Action) = 'LABEL') ORDER BY FLOWORDER"
			rstAux2 = mfRecordset(conGestion, strSQL)
			If Not rstAux2.EOF Then
				System.Windows.Forms.Application.DoEvents()
				lngF = rstAux2.Fields("FLOWORDER").Value
				strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='CREARALERTA' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
				rstparamHN = mfRecordset(conGestion, strSQL)
			End If
			blnInserta = True
			If blnIndVar = True Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			Else
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strPlazo, rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			End If
			rstparamHN.MoveNext()
			System.Windows.Forms.Application.DoEvents()
			'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			nomVarHN = mfInsertaVariables(ATID, ATNAME)
			System.Windows.Forms.Application.DoEvents()
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			rstparamHN.MoveNext()
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "2", rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			rstparamHN.MoveNext()
			If blnIndVar = True Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strPlazo, rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, True)
			Else
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			End If
			rstparamHN.MoveNext()
			colAux = New Collection
			colAux.Add("Naturaleza Plazo")
			'UPGRADE_NOTE: Object colXMLD may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			colXMLD = Nothing
			colXMLD = New Collection
			colXMLD = mfBuscaXML("Proceso", colAux, rstTram.Fields("ID_DIAGRAMA").Value, False)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1)), rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			System.Windows.Forms.Application.DoEvents()
			lngORACC = lngORACC + 1
			strPath = "EDP_CREARALERTA" & VB6.Format(lngNumAcc, "00")
			'ENDPROC DE CREARALERTA
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, 0, "ENDPROC", lngNumAcc, "", strPath, 0, 0, "", "S", "")
			lngORACC = lngORACC + 1
			strPath2 = "PRO_CREARALERTA" & VB6.Format(lngNumAcc, "00")
			'PROCESS DE CREARALERTA
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, 0, "PROCESS", lngNumAcc, "", strPath2, 0, 0, "", "S", "")
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath2 & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
			strSQL = strSQL & "ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value
			strSQL = strSQL & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value
			strSQL = strSQL & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value
			strSQL = strSQL & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value
			strSQL = strSQL & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value & " and orden_acc=" & lngORACC - 2
			mfExecute(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='ALERT'"
			System.Windows.Forms.Application.DoEvents()
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			System.Windows.Forms.Application.DoEvents()
			lngORACC = lngORACC + 1
			strPathAL = "ALRT ALERTA" & VB6.Format(lngNumAcc, "00")
			'INSERTO EL ALERT
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, 0, "ALERT", lngNumAcc, "", strPathAL, 0, 0, "", "S", "")
			msInsertaParamAcc("DATE", "@" & strPath2 & "!FCADUCIDAD", rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			msInsertaParamAcc("ALERTPATH", "APE_ACTIVACIONPLAZO" & VB6.Format(lngNumAcc, "00"), rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			rst.MoveFirst()
			System.Windows.Forms.Application.DoEvents()
			lngORACC = lngORACC + 1
			strPath = "EDP_ALRT" & VB6.Format(lngNumAcc, "00")
			'INSERTO EL ENDPROC DEL ALERT
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, 0, "ENDPROC", lngNumAcc, "", strPath, 0, 0, "", "S", "")
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='ACTIVACIONPORPLAZO'"
			rstAux = mfRecordset(conPasarela, strSQL)
			strPath = "APE_ACTIVACIONPLAZO" & VB6.Format(lngNumAcc, "00")
			lngORACC = lngORACC + 1
			'INSERTO LA ACCIÓN ACTIVACIONPLAZO
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, 0, "ACTIVACIONPLAZO", lngNumAcc, "", strPath, 0, 0, "", "S", "")
			blnInserta = True
			msInsertaParamAcc("@PATH", "PR_FINEXPEDIENTE", rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			blnInserta = False
			msInsertaParamAcc("@INDICADOR", "1", rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC)
			lngORACC = lngORACC + 1
			strPath = "EDP_ACTIVACIONPLAZO" & VB6.Format(lngNumAcc, "00")
			'INSERT EL ENDPROC DE LA ACTIVACIONPLAZO
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, 0, "ENDPROC", lngNumAcc, "", strPath, 0, 0, "", "S", "")
			lngORACC = lngORACC + 1
			strPath2 = "PRO_ACTIVACIONPLAZO" & VB6.Format(lngNumAcc, "00")
			'INSERTO EL PROCESS DE ACTIVACIONPLAZO
			mfInserta_ACCIONES(rst2.Fields("ORDEN_N1").Value, rst2.Fields("ORDEN_N2").Value, rst2.Fields("ORDEN_N3").Value, rst2.Fields("ORDEN_N4").Value, rst2.Fields("ORDEN_N5").Value, lngORACC, 0, "PROCESS", lngNumAcc, "", strPath2, 0, 0, "", "S", "")
			mfExecute(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath2 & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
			strSQL = strSQL & "ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value
			strSQL = strSQL & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
			mfExecute(conPasarela, strSQL)
			System.Windows.Forms.Application.DoEvents()
			rstCon.MoveNext()
		End While
		'Fin Jonathan Prieto 11/02/2011
		
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Plazo de Tipo 2", "Ha ocurrido un error no controlado", "msPlazT2")
		Mostrar_Error()
		logError("msPlazT2 - " & Err.Description)
		Resume procFin
		
procFin: 
		
		
		
	End Sub
	
	
	Private Sub msResolPlazTip2()
		
		On Error GoTo procErr
		
		Dim rst As ADODB.Recordset
		Dim rstTram As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		'aketza 23/04/2008
		Dim rstAux6 As ADODB.Recordset
		'fin aketza
		Dim rstConS As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamHN As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstSalDP4 As ADODB.Recordset
		Dim rstSal1 As ADODB.Recordset
		Dim blnPrim As Boolean
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim lngOr2 As Integer
		Dim lngOr3 As Integer
		Dim lngOr4 As Integer
		Dim lngOr5 As Integer
		Dim lngOrP2 As Integer
		Dim lngOrP3 As Integer
		Dim lngOrP4 As Integer
		Dim lngOrP5 As Integer
		Dim lngF As Integer
		Dim lngNumCon As Integer
		Dim lngnumSal As Integer
		Dim I As Integer
		Dim lngO1 As Integer
		Dim lngO2 As Integer
		Dim lngO3 As Integer
		Dim lngO4 As Integer
		Dim lngO5 As Integer
		Dim strSalidas As String
		Dim strTF As String
		Dim nomTramS As String
		Dim strNomTram As String
		Dim strsalto As String
		Dim nomVarHN As String
		Dim strPath As String
		Dim strPath2 As String
		Dim strPathAL As String
		Dim strJOINER As String
		Dim strIns As String
		Dim strSQL As String
		Dim colAux As Collection
		Dim colXMLD As Collection
		Dim colDestino As Collection
		'aketza 23/04/2008
		Dim auxOrd1 As Short
		Dim auxOrd2 As Short
		Dim auxOrd3 As Short
		Dim auxOrd4 As Short
		Dim auxOrd5 As Short
		Dim auxOrdAcc As Short
		'fin aketza
		
		'Inicio Jonathan Prieto 11/02/2011
		Dim rstAlert As ADODB.Recordset
		Dim rstFicticio As ADODB.Recordset
		Dim blnExisteFicticio As Boolean
		'Fin Jonathan Prieto 11/02/2011
		
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND EXPLOTA_ACC='S'"
		rstTram = mfRecordset(conPasarela, strSQL)
		
		While Not rstTram.EOF
			strSeg = rstTram.Fields("ORDEN_N1").Value & "/" & rstTram.Fields("ORDEN_N2").Value & "/" & rstTram.Fields("ORDEN_N3").Value & "/" & rstTram.Fields("ORDEN_N4").Value & "/" & rstTram.Fields("ORDEN_N5").Value
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='ACTIVACIONPLAZO' AND "
			strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND "
			strSQL = strSQL & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
			rst = mfRecordset(conPasarela, strSQL)
			If Not rst.EOF Then
				colDestino = New Collection
				strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND "
				strSQL = strSQL & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rst2 = mfRecordset(conPasarela, strSQL)
				strsalto = rst2.Fields("NOM_DIAGRAMA").Value
				colDestino.Add(strsalto)
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
				strSQL = strSQL & "NUM_SEC_HASTA=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR='Fin de plazo 2'"
				rst2 = mfRecordset(conPasarela, strSQL)
				If rst2.EOF Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value
					rstAux = mfRecordset(conPasarela, strSQL)
					strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND "
					strSQL = strSQL & "NUM_SEC_HASTA=" & rstAux.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR='Fin de plazo 2'"
					rst2 = mfRecordset(conPasarela, strSQL)
					strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rst2.Fields("NUM_SEC_DESDE").Value & " AND CAT_CONECTOR<>'Fin de plazo 2' AND RTRIM(CAT_CONECTOR2)<>'Caducar Expediente' AND CAT_CONECTOR<>'Conector Opcional'"
					rst2 = mfRecordset(conPasarela, strSQL)
					'aketza 14/02/2008
					'la query anterior a veces no devuelve nada
					If rst2.EOF Then
						lngnumSal = 0
						lngNumCon = 0
					Else
						'fin aketza
						strSQL = "SELECT count(*) FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rst2.Fields("NUM_SEC_DESDE").Value
						rstAux4 = mfRecordset(conPasarela, strSQL)
						lngNumCon = rstAux4.Fields(0).Value
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rst2.Fields("NUM").Value & " AND NUM_SEQ=" & rst2.Fields("NUM_SEC_DESDE").Value
						rstAux4 = mfRecordset(conPasarela, strSQL)
						lngnumSal = Val(rstAux4.Fields("SALIDAS").Value & "")
						'aketza 14/02/2008
					End If
					'fin aketza
				Else
					'aketza 23/04/2008
					'strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram("ID_PADRE") & " AND NUM_SEC_DESDE=" & rst2("NUM_SEC_DESDE") & " AND CAT_CONECTOR<>'Fin de plazo 2' AND rtrim(CAT_CONECTOR2)<>'Caducar Expediente'"
					strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rst2.Fields("NUM_SEC_DESDE").Value & " AND CAT_CONECTOR<>'Fin de plazo 2' AND rtrim(CAT_CONECTOR2)<>'Caducar Expediente' AND rtrim(CAT_CONECTOR)<>'Conector Opcional'"
					'fin aketza
					rst2 = mfRecordset(conPasarela, strSQL)
					If Not rst2.EOF Then
						strSQL = "SELECT COUNT(*) FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rst2.Fields("NUM_SEC_DESDE").Value
						rstAux4 = mfRecordset(conPasarela, strSQL)
						lngNumCon = rstAux4.Fields(0).Value
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rst2.Fields("NUM").Value & " AND NUM_SEQ=" & rst2.Fields("NUM_SEC_DESDE").Value
						rstAux4 = mfRecordset(conPasarela, strSQL)
						If rstAux4.Fields("SALIDAS").Value & "" = "" Then
							lngnumSal = 0
						Else
							lngnumSal = rstAux4.Fields("SALIDAS").Value
						End If
					Else
						lngnumSal = 0
					End If
				End If
				If lngnumSal = 0 And Not rstAux4 Is Nothing Then
					strSalidas = ""
					strSQL = "SELECT D.SH_SEQ FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
					strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND "
					strSQL = strSQL & "E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID = " & rstAux4.Fields("ID_DIAGRAMA").Value & " AND (EV_NAME like ('Fin%') OR "
					strSQL = strSQL & "EV_NAME LIKE ('Inicio%'))"
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					rstSalDP4 = mfRecordset(conDP4, strSQL)
					While Not rstSalDP4.EOF
						strSalidas = strSalidas & rstSalDP4.Fields(0).Value & ","
						rstSalDP4.MoveNext()
					End While
					strSalidas = Mid(strSalidas, 1, Len(strSalidas) - 1)
					'Inicio Jonathan Prieto 31/01/2011: Tenía un literal en el where
					'            strSQL = "select distinct num_Sec_hasta from conectores_di where procedimiento='PO112010' and "
					'            strSQL = strSQL & "orden_n1=" & rstAux4("ORDEN_N1") & " and diagrama=" & rstAux4("ID_DIAGRAMA") & " and "
					'            strSQL = strSQL & "num_Sec_hasta in (" & strSalidas & ")"
					strSQL = "select distinct num_Sec_hasta from conectores_di where procedimiento='" & gNomProcCorto & "' and "
					strSQL = strSQL & "orden_n1=" & rstAux4.Fields("ORDEN_N1").Value & " and diagrama=" & rstAux4.Fields("ID_DIAGRAMA").Value & " and "
					strSQL = strSQL & "num_Sec_hasta in (" & strSalidas & ")"
					'Fin Jonathan Prieto 31/01/2011
					rstSalDP4 = mfRecordset(conPasarela, strSQL)
					lngnumSal = rstSalDP4.RecordCount
				End If
				If lngnumSal = lngNumCon Then
					GoTo siguiente
				End If
				
				If lngnumSal = rst2.RecordCount Then
					While Not rst2.EOF
						colDestino = New Collection
						colDestino.Add(strsalto)
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rst2.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rst2.Fields("NUM_SEC_HASTA").Value
						rstAux3 = mfRecordset(conPasarela, strSQL)
						If Not rstAux3.EOF Then
							If rstAux3.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
								If rstAux3.Fields("ORDEN_N2").Value = 0 Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND "
									strSQL = strSQL & "ORDEN_N2>0 order by orden_n2, ORDEN_N3,ORDEN_N4, orden_n5 desc"
									rstAux5 = mfRecordset(conPasarela, strSQL)
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND "
									strSQL = strSQL & "ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND "
									strSQL = strSQL & "ORDEN_N4=" & rstAux5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux5.Fields("ORDEN_N5").Value
									rstAux3 = mfRecordset(conPasarela, strSQL)
								End If
							End If
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3= " & rstAux3.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux3.Fields("ORDEN_N4").Value & " AND "
							strSQL = strSQL & "ORDEN_N5=" & rstAux3.Fields("ORDEN_N5").Value
							rstAux3 = mfRecordset(conPasarela, strSQL)
							If rstAux3.Fields("ORDEN_N2").Value = 0 Then
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux3.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstAux3.Fields("ORDEN_N3").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux3.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstAux3.Fields("ORDEN_N4").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux3.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstAux3.Fields("ORDEN_N5").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux3.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							End If
							rstAux2 = mfRecordset(conPasarela, strSQL)
							Do While Not rstAux2.EOF
								If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
									nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
									Exit Do
								End If
								rstAux2.MoveNext()
								nomTramS = "PR_FINEXPEDIENTE"
							Loop 
							colDestino.Add(CStr(rstAux3.Fields("NOM_DIAGRAMA").Value))
						End If
						'insertamos en diagrama y en propiedades_di
						strSQL = "SELECT COUNT(*) FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA LIKE 'PR_TRAMITEFICTICIO%'"
						rstAux3 = mfRecordset(conPasarela, strSQL)
						strTF = "PR_TRAMITEFICTICIO" & VB6.Format(Val(rstAux3.Fields(0).Value & "") + 1, "00")
						If rstAux4.Fields("NUM_DIAGRAMA").Value = 1 Then
							lngO1 = rstAux4.Fields("ORDEN_N1").Value
							lngO2 = 999 - rst2.AbsolutePosition + 1
							lngO3 = 0
							lngO4 = 0
							lngO5 = 0
						ElseIf rstAux4.Fields("NUM_DIAGRAMA").Value = 2 Then 
							lngO1 = rstAux4.Fields("ORDEN_N1").Value
							lngO2 = rstAux4.Fields("ORDEN_N2").Value
							lngO3 = 999 - rst2.AbsolutePosition + 1
							lngO4 = 0
							lngO5 = 0
						ElseIf rstAux4.Fields("NUM_DIAGRAMA").Value = 3 Then 
							lngO1 = rstAux4.Fields("ORDEN_N1").Value
							lngO2 = rstAux4.Fields("ORDEN_N2").Value
							lngO3 = rstAux4.Fields("ORDEN_N3").Value
							lngO4 = 999
							lngO5 = 0
						ElseIf rstAux4.Fields("NUM_DIAGRAMA").Value >= 4 Then 
							lngO1 = rstAux4.Fields("ORDEN_N1").Value
							lngO2 = rstAux4.Fields("ORDEN_N2").Value
							lngO3 = rstAux4.Fields("ORDEN_N3").Value
							lngO4 = rstAux4.Fields("ORDEN_N4").Value
							lngO5 = 999
						End If
						'Inicio Jonathan Prieto 11/02/2011: Modificaciones para cuando ya existe el TRAMITEFICTICIO
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & lngO1 & " AND ORDEN_N2=" & lngO2 & " AND ORDEN_N3=" & lngO3 & " AND ORDEN_N4=" & lngO4 & " AND ORDEN_N5=" & lngO5
						rstFicticio = mfRecordset(conPasarela, strSQL)
						If rstFicticio.EOF Then
							strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES ('" & gNomProcCorto & "'," & lngO1 & ", " & lngO2 & "," & lngO3 & "," & lngO4 & "," & lngO5 & "," & rstAux4.Fields("NUM_DIAGRAMA").Value & " +1,'" & strTF & "','S',999999)"
							mfExecute(conPasarela, strSQL)
							mfInserta_PROPIEDADES(lngO1, lngO2, lngO3, lngO4, lngO5, 999999, strTF, "", "", "", "", "", "", "")
						Else
							blnExisteFicticio = True
							strTF = rstFicticio.Fields("NOMBRE").Value
						End If
						If colDestino.Count() > 1 Then
							For I = 1 To colDestino.Count() - 1
								strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
								rstAux5 = mfRecordset(conPasarela, strSQL)
								lngNumAcc = Val(rstAux5.Fields(0).Value & "") + 1
								'Jonathan Prieto 11/02/2011: si ya existía el TRAMITEFICTICIO tengo que modificar el ORDEN_ACC del siguiente JUMP a instertar
								If blnExisteFicticio = True Then
									mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, (2 * (I - 1)) + 4, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
									blnInserta = False
									'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									msInsertaParamAcc("PATH", colDestino.Item(I), lngO1, lngO2, lngO3, lngO4, lngO5, CInt((2 * (I - 1)) + 4))
								Else
									mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, (2 * (I - 1)) + 2, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
									blnInserta = False
									'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									msInsertaParamAcc("PATH", colDestino.Item(I), lngO1, lngO2, lngO3, lngO4, lngO5, CInt((2 * (I - 1)) + 2))
								End If
							Next I
							'Jonathan Prieto 11/02/2011: si ya existía el TRAMITEFICTICIO tampoco tengo que insertar el segundo JUMP porque son la misma salida
							If blnExisteFicticio = False Then
								mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, CInt((2 * (I - 1)) + 1), 0, "JUMP", lngNumAcc + 1, "", "JUMP" & VB6.Format(lngNumAcc + 1, "00"), 0, 0, "", "", "")
								'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								msInsertaParamAcc("PATH", colDestino.Item(colDestino.Count()), lngO1, lngO2, lngO3, lngO4, lngO5, CInt((2 * (I - 1)) + 1))
							End If
						Else
							strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
							rstAux5 = mfRecordset(conPasarela, strSQL)
							lngNumAcc = Val(rstAux5.Fields(0).Value & "") + 1
							'Jonathan Prieto 11/02/2011: si ya existía el TRAMITEFICTICIO tengo que modificar el ORDEN_ACC del siguiente JUMP a instertar
							If blnExisteFicticio = True Then
								mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, 1, 0, "JUMP", lngNumAcc + 2, "", "JUMP" & VB6.Format(lngNumAcc + 1, "00"), 0, 0, "", "", "")
								blnInserta = False
								'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								msInsertaParamAcc("PATH", colDestino.Item(colDestino.Count()), lngO1, lngO2, lngO3, lngO4, lngO5, 2)
							Else
								mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, 1, 0, "JUMP", lngNumAcc + 1, "", "JUMP" & VB6.Format(lngNumAcc + 1, "00"), 0, 0, "", "", "")
								blnInserta = False
								'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								msInsertaParamAcc("PATH", colDestino.Item(colDestino.Count()), lngO1, lngO2, lngO3, lngO4, lngO5, 1)
							End If
							'Fin Jonathan Prieto 11/02/2011
						End If
						For I = 1 To colDestino.Count()
							'aketza 23/04/2008
							'If lngO2 > 990 Then
							'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & "  and orden_n2 < 990"
							'ElseIf lngO3 = 999 Then
							'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & "  and orden_n3<>999"
							'ElseIf lngO4 = 999 Then
							'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & "  and orden_n4<>999"
							'ElseIf lngO5 = 999 Then
							'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & " and orden_n4=" & lngO4 & "  and orden_n5<>999"
							'End If
							If lngO2 > 990 Then
								'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & "  and orden_n2 < 990 and parametro not like '%@salto%'"
								'ElseIf lngO3 = 999 Then
								'## DS66 15/07/09
							ElseIf lngO3 = 999 Or lngO3 = 998 Then 
								'##
								'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & "  and orden_n3<>999 and parametro not like '%@salto%'"
							ElseIf lngO4 = 999 Then 
								'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & "  and orden_n4<>999 and parametro not like '%@salto%'"
							ElseIf lngO5 = 999 Then 
								'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & " and orden_n4=" & lngO4 & "  and orden_n5<>999 and parametro not like '%@salto%'"
							End If
							'fin aketza
							mfExecute(conPasarela, strSQL)
							
						Next I
						'aketza 23/04/2008
						If lngO2 = 999 Then
							strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & "  and orden_n2<>999 and parametro not like '%@salto%' order by orden_acc"
							'ElseIf lngO3 = 999 Then
							'## DS66 15/07/09
						ElseIf lngO3 = 999 Or lngO3 = 998 Then 
							'##
							strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & "  and orden_n3<>999 and parametro not like '%@salto%' order by orden_acc"
						ElseIf lngO4 = 999 Then 
							strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & "  and orden_n4<>999 and parametro not like '%@salto%' order by orden_acc"
						ElseIf lngO5 = 999 Then 
							strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & " and orden_n4=" & lngO4 & "  and orden_n5<>999 and parametro not like '%@salto%' order by orden_acc"
						End If
						rstAux6 = mfRecordset(conPasarela, strSQL)
						If Not rstAux6.EOF Then
							Do While Not rstAux6.EOF
								If auxOrd1 = rstAux6.Fields("orden_n1").Value And auxOrd2 = rstAux6.Fields("orden_n2").Value And auxOrd3 = rstAux6.Fields("orden_n3").Value And auxOrd4 = rstAux6.Fields("orden_n4").Value And auxOrd5 = rstAux6.Fields("orden_n5").Value And auxOrdAcc + 1 = rstAux6.Fields("orden_acc").Value Then
									strSQL = "delete from PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n1=" & rstAux6.Fields("orden_n1").Value & " AND orden_n2=" & rstAux6.Fields("orden_n2").Value & " AND orden_n3=" & rstAux6.Fields("orden_n3").Value & " AND orden_n4=" & rstAux6.Fields("orden_n4").Value & " AND orden_n5=" & rstAux6.Fields("orden_n5").Value & " AND orden_acc=" & rstAux6.Fields("orden_acc").Value & ""
									mfExecute(conPasarela, strSQL)
									strSQL = "delete from ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n1=" & rstAux6.Fields("orden_n1").Value & " AND orden_n2=" & rstAux6.Fields("orden_n2").Value & " AND orden_n3=" & rstAux6.Fields("orden_n3").Value & " AND orden_n4=" & rstAux6.Fields("orden_n4").Value & " AND orden_n5=" & rstAux6.Fields("orden_n5").Value & " AND orden_acc=" & rstAux6.Fields("orden_acc").Value & ""
									mfExecute(conPasarela, strSQL)
								End If
								auxOrd1 = rstAux6.Fields("orden_n1").Value
								auxOrd2 = rstAux6.Fields("orden_n2").Value
								auxOrd3 = rstAux6.Fields("orden_n3").Value
								auxOrd4 = rstAux6.Fields("orden_n4").Value
								auxOrd5 = rstAux6.Fields("orden_n5").Value
								auxOrdAcc = rstAux6.Fields("orden_acc").Value
								rstAux6.MoveNext()
							Loop 
						End If
						'fin aketza
						rst2.MoveNext()
					End While
				Else
					While Not rst2.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rst2.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rst2.Fields("NUM_SEC_HASTA").Value
						rstAux2 = mfRecordset(conPasarela, strSQL)
						If Not rstAux2.EOF Then
							'##  DS66 02/10/09
							'If rstAux2("CAT_DIAGRAMA") = "Ramificación" Then
							'   If rstAux2("ORDEN_N2") = 0 Then
							'      strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND "
							'      strSQL = strSQL & "ORDEN_N2>0 order by orden_n5,ORDEN_N4,ORDEN_N3,ORDEN_N2 desc"
							'      Set rstAux4 = mfRecordset(conPasarela, strSQL)
							'      strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4("ORDEN_N1") & " AND "
							'      strSQL = strSQL & "ORDEN_N2=" & rstAux4("ORDEN_N2") & " AND ORDEN_N3=" & rstAux4("ORDEN_N3") & " AND "
							'      strSQL = strSQL & "ORDEN_N4=" & rstAux4("ORDEN_N4") & " AND ORDEN_N5=" & rstAux4("ORDEN_N5")
							'      Set rstAux2 = mfRecordset(conPasarela, strSQL)
							'   End If
							'End If
							'##
							
							'##  DS66 02/10/09
							If rstAux2.Fields("CAT_DIAGRAMA").Value <> "Ramificación" Then
								strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND "
								strSQL = strSQL & "ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3= " & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND "
								strSQL = strSQL & "ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
								rstAux3 = mfRecordset(conPasarela, strSQL)
								colDestino.Add(CStr(rstAux3.Fields("NOM_DIAGRAMA").Value))
							End If
							'##
							
							'##  DS66 02/10/09
							'strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND "
							'strSQL = strSQL & "ORDEN_N2=" & rstAux2("ORDEN_N2") & " AND ORDEN_N3= " & rstAux2("ORDEN_N3") & " AND ORDEN_N4=" & rstAux2("ORDEN_N4") & " AND "
							'strSQL = strSQL & "ORDEN_N5=" & rstAux2("ORDEN_N5")
							'Set rstAux3 = mfRecordset(conPasarela, strSQL)
							'colDestino.Add CStr(rstAux3("NOM_DIAGRAMA"))
							'##
						End If
						rst2.MoveNext()
					End While
					'insertamos en diagrama y en propiedades_di
					strSQL = "SELECT COUNT(*) FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA LIKE 'PR_TRAMITEFICTICIO%'"
					rstAux3 = mfRecordset(conPasarela, strSQL)
					strTF = "PR_TRAMITEFICTICIO" & VB6.Format(Val(rstAux3.Fields(0).Value & "") + 1, "00")
					If rstAux4.Fields("NUM_DIAGRAMA").Value = 1 Then
						lngO1 = rstAux4.Fields("ORDEN_N1").Value
						lngO2 = 999
						lngO3 = 0
						lngO4 = 0
						lngO5 = 0
					ElseIf rstAux4.Fields("NUM_DIAGRAMA").Value = 2 Then 
						lngO1 = rstAux4.Fields("ORDEN_N1").Value
						lngO2 = rstAux4.Fields("ORDEN_N2").Value
						lngO3 = 999
						lngO4 = 0
						lngO5 = 0
					ElseIf rstAux4.Fields("NUM_DIAGRAMA").Value = 3 Then 
						lngO1 = rstAux4.Fields("ORDEN_N1").Value
						lngO2 = rstAux4.Fields("ORDEN_N2").Value
						lngO3 = rstAux4.Fields("ORDEN_N3").Value
						lngO4 = 999
						lngO5 = 0
					ElseIf rstAux4.Fields("NUM_DIAGRAMA").Value >= 4 Then 
						lngO1 = rstAux4.Fields("ORDEN_N1").Value
						lngO2 = rstAux4.Fields("ORDEN_N2").Value
						lngO3 = rstAux4.Fields("ORDEN_N3").Value
						lngO4 = rstAux4.Fields("ORDEN_N4").Value
						lngO5 = 999
					End If
					strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES ('" & gNomProcCorto & "'," & lngO1 & ", " & lngO2 & "," & lngO3 & "," & lngO4 & "," & lngO5 & "," & rstAux4.Fields("NUM_DIAGRAMA").Value & " +1,'" & strTF & "','S',999999)"
					mfExecute(conPasarela, strSQL)
					mfInserta_PROPIEDADES(lngO1, lngO2, lngO3, lngO4, lngO5, 999999, strTF, "", "", "", "", "", "", "")
					If colDestino.Count() > 1 Then
						For I = 1 To colDestino.Count() - 1
							strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
							rstAux5 = mfRecordset(conPasarela, strSQL)
							lngNumAcc = Val(rstAux5.Fields(0).Value & "") + 1
							mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, (2 * (I - 1)) + 2, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
							blnInserta = False
							'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							msInsertaParamAcc("PATH", colDestino.Item(I), lngO1, lngO2, lngO3, lngO4, lngO5, CInt((2 * (I - 1)) + 2))
						Next I
						mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, CInt((2 * (I - 1)) + 1), 0, "JUMP", lngNumAcc + 1, "", "JUMP" & VB6.Format(lngNumAcc + 1, "00"), 0, 0, "", "", "")
						'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						msInsertaParamAcc("PATH", colDestino.Item(colDestino.Count()), lngO1, lngO2, lngO3, lngO4, lngO5, CInt((2 * (I - 1)) + 1))
					Else
						strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
						rstAux5 = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAux5.Fields(0).Value & "") + 1
						mfInserta_ACCIONES(lngO1, lngO2, lngO3, lngO4, lngO5, 1, 0, "JUMP", lngNumAcc + 1, "", "JUMP" & VB6.Format(lngNumAcc + 1, "00"), 0, 0, "", "", "")
						blnInserta = False
						'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						msInsertaParamAcc("PATH", colDestino.Item(colDestino.Count()), lngO1, lngO2, lngO3, lngO4, lngO5, 1)
					End If
					For I = 1 To colDestino.Count()
						'aketza 23/04/2008
						'If lngO2 = 999 Then
						'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & "  and orden_n2<>999"
						'ElseIf lngO3 = 999 Then
						'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & "  and orden_n3<>999"
						'ElseIf lngO4 = 999 Then
						'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & "  and orden_n4<>999"
						'ElseIf lngO5 = 999 Then
						'   strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & " and orden_n4=" & lngO4 & "  and orden_n5<>999"
						'End If
						If lngO2 = 999 Then
							'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & "  and orden_n2<>999 and parametro not like '%@salto%'"
						ElseIf lngO3 = 999 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & "  and orden_n3<>999 and parametro not like '%@salto%'"
						ElseIf lngO4 = 999 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & "  and orden_n4<>999 and parametro not like '%@salto%'"
						ElseIf lngO5 = 999 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object colDestino(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & colDestino.Item(I) & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & " and orden_n4=" & lngO4 & "  and orden_n5<>999 and parametro not like '%@salto%'"
						End If
						'fin aketza
						mfExecute(conPasarela, strSQL)
					Next I
					
					'aketza 23/04/2008
					If lngO2 = 999 Then
						strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & "  and orden_n2<>999 and parametro not like '%@salto%' order by orden_acc"
					ElseIf lngO3 = 999 Then 
						strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & "  and orden_n3<>999 and parametro not like '%@salto%' order by orden_acc"
					ElseIf lngO4 = 999 Then 
						strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & "  and orden_n4<>999 and parametro not like '%@salto%' order by orden_acc"
					ElseIf lngO5 = 999 Then 
						strSQL = "select * from  PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strTF & "' AND ORDEN_N1=" & lngO1 & " And orden_n2=" & lngO2 & " and orden_n3=" & lngO3 & " and orden_n4=" & lngO4 & "  and orden_n5<>999 and parametro not like '%@salto%' order by orden_acc"
					End If
					rstAux6 = mfRecordset(conPasarela, strSQL)
					If Not rstAux6.EOF Then
						Do While Not rstAux6.EOF
							If auxOrd1 = rstAux6.Fields("orden_n1").Value And auxOrd2 = rstAux6.Fields("orden_n2").Value And auxOrd3 = rstAux6.Fields("orden_n3").Value And auxOrd4 = rstAux6.Fields("orden_n4").Value And auxOrd5 = rstAux6.Fields("orden_n5").Value And auxOrdAcc + 1 = rstAux6.Fields("orden_acc").Value Then
								strSQL = "delete from PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n1=" & rstAux6.Fields("orden_n1").Value & " AND orden_n2=" & rstAux6.Fields("orden_n2").Value & " AND orden_n3=" & rstAux6.Fields("orden_n3").Value & " AND orden_n4=" & rstAux6.Fields("orden_n4").Value & " AND orden_n5=" & rstAux6.Fields("orden_n5").Value & " AND orden_acc=" & rstAux6.Fields("orden_acc").Value & ""
								mfExecute(conPasarela, strSQL)
								strSQL = "delete from ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n1=" & rstAux6.Fields("orden_n1").Value & " AND orden_n2=" & rstAux6.Fields("orden_n2").Value & " AND orden_n3=" & rstAux6.Fields("orden_n3").Value & " AND orden_n4=" & rstAux6.Fields("orden_n4").Value & " AND orden_n5=" & rstAux6.Fields("orden_n5").Value & " AND orden_acc=" & rstAux6.Fields("orden_acc").Value & ""
								mfExecute(conPasarela, strSQL)
							End If
							auxOrd1 = rstAux6.Fields("orden_n1").Value
							auxOrd2 = rstAux6.Fields("orden_n2").Value
							auxOrd3 = rstAux6.Fields("orden_n3").Value
							auxOrd4 = rstAux6.Fields("orden_n4").Value
							auxOrd5 = rstAux6.Fields("orden_n5").Value
							auxOrdAcc = rstAux6.Fields("orden_acc").Value
							rstAux6.MoveNext()
						Loop 
					End If
					'fin aketza
				End If
			End If
siguiente: 
			'Inicio Jonathan Prieto 31/01/2011: De momento, debe cancelar manualmente la alerta del Plazo Tipo 2
			strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & rstTram.Fields("PROCEDIMIENTO").Value & "' AND NOM_ACCION='ALERT' " & "AND ORDEN_N1=(SELECT ORDEN_N1 FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & rstTram.Fields("PROCEDIMIENTO").Value & "' " & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " " & "AND NOM_ACCION='ACTIVACIONPLAZO') " & "AND ORDEN_N2=(SELECT ORDEN_N2 FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & rstTram.Fields("PROCEDIMIENTO").Value & "' " & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " " & "AND NOM_ACCION='ACTIVACIONPLAZO') " & "AND ORDEN_N3=(SELECT ORDEN_N3 FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & rstTram.Fields("PROCEDIMIENTO").Value & "' " & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " " & "AND NOM_ACCION='ACTIVACIONPLAZO') " & "AND ORDEN_N4=(SELECT ORDEN_N4 FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & rstTram.Fields("PROCEDIMIENTO").Value & "' " & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " " & "AND NOM_ACCION='ACTIVACIONPLAZO') " & "AND ORDEN_N5=(SELECT ORDEN_N5 FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & rstTram.Fields("PROCEDIMIENTO").Value & "' " & "AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " " & "AND NOM_ACCION='ACTIVACIONPLAZO')"
			rstAlert = mfRecordset(conPasarela, strSQL)
			If Not rstAlert.EOF Then
				Insertar_Error(Me, "Aviso Solución Plazo Tipo 2", "Debe introducir manualmente la cancelación de la alerta " & UCase(Trim(rstAlert.Fields("PATH_HIDRA").Value)) & " del trámite " & UCase(Trim(rstTram.Fields(20).Value)) & " correspondiente al Plazo Tipo 2.", "Solución Plazo Tipo 2")
				logError("Debe introducir manualmente la cancelación de la alerta " & UCase(Trim(rstAlert.Fields("PATH_HIDRA").Value)) & " del trámite " & UCase(Trim(rstTram.Fields(20).Value)) & " correspondiente al Plazo Tipo 2.")
			End If
			'Fin Jonathan Prieto 31/01/2011
			rstTram.MoveNext()
		End While
		
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Solución Plazo Tipo 2", "Ha ocurrido un error no controlado", "msResolPlazTip2" & " -" & strSeg)
		Mostrar_Error()
		logError("msResolPlazTip2 - " & Err.Description)
		Resume procFin
		
procFin: 
		CierraRS(rst)
		'UPGRADE_NOTE: Object rst may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst = Nothing
		CierraRS(rstTram)
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
		CierraRS(rst2)
		'UPGRADE_NOTE: Object rst2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst2 = Nothing
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rstAux2)
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		CierraRS(rstAux3)
		'UPGRADE_NOTE: Object rstAux3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux3 = Nothing
		CierraRS(rstAux4)
		'UPGRADE_NOTE: Object rstAux4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux4 = Nothing
		CierraRS(rstAux5)
		'UPGRADE_NOTE: Object rstAux5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux5 = Nothing
		CierraRS(rstConS)
		'UPGRADE_NOTE: Object rstConS may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstConS = Nothing
		CierraRS(rstParamCMS)
		'UPGRADE_NOTE: Object rstParamCMS may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstParamCMS = Nothing
		CierraRS(rstparamHN)
		'UPGRADE_NOTE: Object rstparamHN may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstparamHN = Nothing
		CierraRS(rstAcc)
		'UPGRADE_NOTE: Object rstAcc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAcc = Nothing
		CierraRS(rstSalDP4)
		'UPGRADE_NOTE: Object rstSalDP4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstSalDP4 = Nothing
		CierraRS(rstSal1)
		'UPGRADE_NOTE: Object rstSal1 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstSal1 = Nothing
		'Inicio Jonathan Prieto 11/02/2011
		CierraRS(rstAlert)
		'UPGRADE_NOTE: Object rstAlert may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAlert = Nothing
		CierraRS(rstFicticio)
		'UPGRADE_NOTE: Object rstFicticio may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstFicticio = Nothing
		'Fin Jonathan Prieto 11/02/2011
		
	End Sub
	
	Private Sub msActVar(ByRef rstTram As ADODB.Recordset)
		Dim strSQL As String
		Dim rstParam As ADODB.Recordset
		Dim I As Short
		Dim blnEmpieza0 As Boolean
		Dim Orden As Integer
		Dim rstAux As ADODB.Recordset
		Dim strDiagrama As String
		Dim strPath As String
		Dim strORDENTRA As String
		Dim strCODUNITR As String
		On Error GoTo procErr
		
		strSQL = "SELECT ID_DIAGRAMA FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
		
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			strDiagrama = rstAux.Fields("ID_DIAGRAMA").Value
		Else
			strDiagrama = ""
		End If
		'ORDENTRA
		'strSQL = "SELECT ORDENTRA FROM TBPFIN03_PA WHERE " _
		'& "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama)
		strSQL = "SELECT ORDENTRA FROM TBPFIN03_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND " & "NOMBRE=(SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "PROCEDIMIENTO='" & gNomProcCorto & "' and " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & ")"
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			strORDENTRA = rstAux.Fields("ORDENTRA").Value
		Else
			strORDENTRA = "@INICIO!ORDENTRA"
		End If
		
		strSQL = "UPDATE PARAM_ACC SET VALOR='" & strORDENTRA & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "PARAMETRO='@ORDENTRA'"
		
		mfExecute(conPasarela, strSQL)
		'CODUNITR
		'Inicio Jonathan Prieto 24/04/2013
		'CODUNITR
		If strORDENTRA <> "@INICIO!ORDENTRA" Then
			strSQL = "SELECT CODUNITR FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND ORDENTRA=" & strORDENTRA & " AND INDTRAMI='S'"
		Else
			strSQL = "SELECT CODUNITR FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND INDTRAMI='S'"
		End If
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			strCODUNITR = Trim(rstAux.Fields("CODUNITR").Value)
		Else
			strCODUNITR = "@INICIO!CODUNITR"
		End If
		strSQL = "UPDATE PARAM_ACC SET VALOR='" & strCODUNITR & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "PARAMETRO='@CODUNITR'"
		mfExecute(conPasarela, strSQL)
		
		'CODUTRHN
		If strORDENTRA <> "@INICIO!ORDENTRA" Then
			strSQL = "SELECT CODUTRHN FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND ORDENTRA=" & strORDENTRA & " AND INDTRAMI='S'"
		Else
			strSQL = "SELECT CODUTRHN FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "CODPROCE=" & lngCodProc & " AND CODTRAAD=" & Val(strDiagrama) & " AND ORDENTRA=" & strORDENTRA & " AND INDTRAMI='S'"
		End If
		
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			strCODUNITR = Trim(rstAux.Fields("CODUTRHN").Value)
		Else
			strCODUNITR = "@INICIO!CODUTRHN"
		End If
		strSQL = "UPDATE PARAM_ACC SET VALOR='" & strCODUNITR & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "PARAMETRO='CODUTRHN'"
		mfExecute(conPasarela, strSQL)
		'Fin Jonathan Prieto 24/04/2013
		
		'USUARIO
		strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "NOM_ACCION='FORMFICTICIO'"
		
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			strPath = "@" & rstAux.Fields("PATH_HIDRA").Value & "!USUARIO"
		Else
			strPath = "@INICIO!USUARIO"
		End If
		
		strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND " & "PARAMETRO='@USUARIO'"
		mfExecute(conPasarela, strSQL)
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Actualización Variables", "Ha ocurrido un error no controlado", "msActVar")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msActvar - " & Err.Description)
		GoTo procFin
procFin: 
		
	End Sub
	
	Private Sub msConectoresOpcionales()
		
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rst5 As ADODB.Recordset
		Dim rst6 As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAUX8 As ADODB.Recordset
		Dim rstAUX9 As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstparamHN As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstTram As ADODB.Recordset
		Dim rstTram2 As ADODB.Recordset
		Dim rstTramB As ADODB.Recordset
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim strValorV As String
		Dim nomVarHN As String
		Dim I As Integer
		Dim icol As Object
		Dim lngF As Integer
		Dim lngOr1 As Integer
		Dim lngOr2 As Integer
		Dim lngOr3 As Integer
		Dim lngOr4 As Integer
		Dim lngOr5 As Integer
		Dim lngOrP2 As Integer
		Dim lngOrP3 As Integer
		Dim lngOrP4 As Integer
		Dim lngOrP5 As Integer
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim strPath As String
		Dim colTramites As Collection
		Dim strTF As String
		Dim strURP As String
		Dim secAnt As Integer
		Dim numAnt As Integer
		Dim intOrde1 As Integer
		Dim intOrde2 As Integer
		Dim intOrde3 As Integer
		Dim intOrde4 As Integer
		Dim lngLocal As Integer
		Dim blnAsignacion As Boolean
		Dim lngNumAcc2 As Integer
		Dim rows As Integer
		Dim strJumFijo As String
		Dim nomTramS As String
		Dim strCampos_Conectores_DI As String
		Dim strCampos_Diagrama As String
		Dim strCampos_Propiedades_DI As String
		Dim blnSusti As Boolean
		Dim rstEvento1 As ADODB.Recordset
		Dim rstEvento2 As ADODB.Recordset
		Dim blnEncontrado As Boolean
		Dim strSQLEncontrado As String
		Dim lngIdEv As Integer
		Dim intNumBloquesCond As Short
		Dim intBloqueCond As Short
		Dim intORACCant As Short
		Dim intContParam As Short
		Dim intNumSecConector As Short
		Dim strAsigParam1 As String
		Dim strAsigParam2 As String
		Dim strAsigParam3 As String
		Const cintParamCondicion As Short = 3
		Const cstrSeparadorTDA As String = "AND"
		Const cstrSeparadorASIG As String = "ASIG"
		
		On Error GoTo procErr
		' les damos valor a las cadenas con los campos
		strCampos_Conectores_DI = "ID_CONECTOR,DIAGRAMA,NUM,NUM_SEC_DESDE,NUM_SEC_HASTA,CAT_CONECTOR,CAT_CONECTOR2,DI_ID,ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4"
		strCampos_Diagrama = "ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,INDCOMUN,DI_ID"
		strCampos_Propiedades_DI = "ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ID_DIAGRAMA,NOM_DIAGRAMA,TIPO_DIAGRAMA,PLAZTIP1_DI,PLAZTIP2_DI,NIVELTRAM_DI,INDBLOQ_DI,INDRAM_DI,INDPERSINT"
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		
		'Obtenemos el número de parámetros "no fijos" de la acción TDA
		strSQL = "SELECT FlowOrder" & " From wfFlowActions" & " WHERE (RTRIM(Flow)='TDAUTOMATICA')" & " AND (RTRIM(Action) = 'LABEL')" & " ORDER BY FLOWORDER"
		rstAux = mfRecordset(conGene, strSQL)
		If Not rstAux.EOF Then
			lngF = rstAux.Fields("FLOWORDER").Value
			rstAux.Close()
			strSQL = "SELECT PARAM" & " FROM WFFLOWACTIONS" & " WHERE RTRIM(FLOW)='TDAUTOMATICA'" & " AND PARAM LIKE '@%'" & " AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
			rstparamHN = mfRecordset(conGene, strSQL)
		End If
		
		'Obtenemos todos los conectores opcionales del procedimiento
		strSQL = "SELECT " & strCampos_Conectores_DI & " FROM CONECTORES_DI " & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND RTRIM(CAT_CONECTOR)='Conector Opcional'" & " ORDER BY NUM, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4"
		rstConS = mfRecordset(conPasarela, strSQL)
		
		'Tratamos cada conector opcional
		While Not rstConS.EOF
			strSeg = rstConS.Fields("ORDEN_N1").Value & "/" & rstConS.Fields("ORDEN_N2").Value & "/" & rstConS.Fields("ORDEN_N3").Value & "/" & rstConS.Fields("ORDEN_N4").Value
			
			'Obtener el trámite al que apunta el conector opcional
			If rstConS.Fields("NUM").Value = 1 Then
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N2=0"
			ElseIf rstConS.Fields("NUM").Value = 2 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value
			ElseIf rstConS.Fields("NUM").Value = 3 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value
			ElseIf rstConS.Fields("NUM").Value = 4 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value
			ElseIf rstConS.Fields("NUM").Value = 5 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstConS.Fields("ORDEN_N4").Value
			End If
			rstTramB = mfRecordset(conPasarela, strSQL)
			
			'Tratamiento para los que apuntan a un Evento en lugar de un Proceso
			blnEncontrado = False
			If rstTramB.RecordCount = 0 Then
				'No se ha encontrado el trámite al que apunta, miro a ver si el conector apunta a un evento
				strSQL = "SELECT * FROM SHAPE WHERE MODEL_NAME='" & strModelo & "' AND SH_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND DI_ID=" & rstConS.Fields("DI_ID").Value & " AND ANO_TABNR=9097"
				rstEvento1 = mfRecordset(conDP4, strSQL)
				If Not rstEvento1.EOF Then
					'Si apunta a un evento, busco éste en alguna de las salidas a las que apunta el trámite padre
					lngIdEv = rstEvento1.Fields("ANO_ID").Value
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ IN " & "(SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA IN " & "(SELECT DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstConS.Fields("DIAGRAMA").Value & ") " & "AND NUM_SEC_DESDE IN (SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstConS.Fields("DIAGRAMA").Value & "))                    "
					rstEvento2 = mfRecordset(conPasarela, strSQL)
					
					If rstEvento2.EOF Then
						'No tiene conector de salida, debe ir a FINEXPEDIENTE
						blnEncontrado = False
					Else
						
						While Not rstEvento2.EOF
							strSQL = "SELECT * FROM SHAPE WHERE MODEL_NAME='" & strModelo & "' AND ANO_TABNR=9097 " & "AND ANO_ID=" & lngIdEv & " AND DI_ID IN (SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "' " & "AND ANO_ID=" & rstEvento2.Fields("ID_DIAGRAMA").Value & ")"
							rstEvento1 = mfRecordset(conDP4, strSQL)
							If rstEvento1.RecordCount > 0 Then
								'Encontrado el evento como inicio de otro trámite al que apunta una de las salidas
								strSQLEncontrado = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstEvento2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstEvento2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstEvento2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstEvento2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstEvento2.Fields("ORDEN_N5").Value
								blnEncontrado = True
								rstEvento2.MoveLast()
							Else
								'Apunta a un evento de Fin...
								If rstConS.Fields("NUM").Value > 1 Then
									'...si el conector opcional esta dentro de una ramificacion (nivel 2 o mas), si existe un TRAMITEFICTICIO en la ramificacion crearemos la TDA con el SALTOTRUE apuntando al TRAMITEFICTICIO
									Select Case rstConS.Fields("NUM").Value
										Case 2
											strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 IN (97,98,99) AND NOMBRE LIKE 'PR_TRAMITEFICTICIO%'"
										Case 3
											strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 IN (97,98,99) AND NOMBRE LIKE 'PR_TRAMITEFICTICIO%'"
										Case 4
											strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3= " & rstConS.Fields("ORDEN_N3").Value & " AND ORDEN_N4 IN (97,98,99) AND NOMBRE LIKE 'PR_TRAMITEFICTICIO%'"
										Case 5
											strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3= " & rstConS.Fields("ORDEN_N3").Value & " AND ORDEN_N4= " & rstConS.Fields("ORDEN_N4").Value & " AND ORDEN_N5 IN (97,98,99) AND NOMBRE LIKE 'PR_TRAMITEFICTICIO%'"
									End Select
									rstEvento1 = mfRecordset(conPasarela, strSQL)
									If rstEvento1.RecordCount > 0 Then
										strSQLEncontrado = strSQL
										blnEncontrado = True
										rstEvento2.MoveLast()
									End If
								Else
									'...no encontrado a donde apunta, pasamos al siguiente conector opcional
									blnEncontrado = False
								End If
							End If
							rstEvento2.MoveNext()
						End While
						
					End If
					
					If blnEncontrado = False Then
						'No lo ha encontrado, pasamos al siguiente
						GoTo SigConector
					End If
				Else
					GoTo SigConector
				End If
			End If
			
			'Obtener el trámite desde el que sale el conector opcional tratado
			colTramites = New Collection
			If rstConS.Fields("NUM").Value = 1 Then
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N2=0"
			ElseIf rstConS.Fields("NUM").Value = 2 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value
			ElseIf rstConS.Fields("NUM").Value = 3 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value
			ElseIf rstConS.Fields("NUM").Value = 4 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value
			ElseIf rstConS.Fields("NUM").Value = 5 Then 
				strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstConS.Fields("ORDEN_N4").Value
			End If
			rstTram = mfRecordset(conPasarela, strSQL)
			
			'Si el conector opcional sale del mismo trámite/ramificación no es necesario crear el TRAMITEFICTICIO
			If secAnt = rstConS.Fields("NUM_SEC_DESDE").Value And numAnt = rstConS.Fields("NUM").Value And intOrde1 = rstConS.Fields("ORDEN_N1").Value And intOrde2 = rstConS.Fields("ORDEN_N2").Value And intOrde3 = rstConS.Fields("ORDEN_N3").Value And intOrde4 = rstConS.Fields("ORDEN_N4").Value Then
				blnSusti = True
				GoTo paso
			End If
			blnSusti = False
			
			'Tratamos el trámite desde el que sale el conector opcional tratado
			If Not rstTram.EOF Then
				
				If rstTram.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
					'Sale de una ramificación
					'Obtenemos los conectores salientes de la misma ramificación sin categorizar
					strSQL = "SELECT " & strCampos_Conectores_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstConS.Fields("NUM").Value & " AND NUM_SEC_DESDE=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND RTRIM(CAT_CONECTOR)='' AND RTRIM(CAT_CONECTOR2)=''"
					rstAUX8 = mfRecordset(conPasarela, strSQL)
					'UPGRADE_NOTE: Object rstAUX9 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
					rstAUX9 = Nothing
					Do While Not rstAUX8.EOF
						'Obtenemos el trámite al que apunta el primero de los conectores salientes sin categorizar
						strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAUX8.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstAUX8.Fields("DIAGRAMA").Value
						rstAUX9 = mfRecordset(conPasarela, strSQL)
						If Not rstAUX9.EOF Then Exit Do 'Ya hemos encontrado un trámite destino
						rstAUX8.MoveNext()
					Loop 
					If Not rstAUX9 Is Nothing Then
						If Not rstAUX9.EOF Then
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX9.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAUX9.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAUX9.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAUX9.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAUX9.Fields("ORDEN_N5").Value
							rstAux2 = mfRecordset(conPasarela, strSQL)
							If Not rstAux2.EOF Then
								'Nombre del trámite
								strURP = rstAux2.Fields("NOM_DIAGRAMA").Value
								If strURP = "" Then
									If rstAux2.Fields("ORDEN_N2").Value = 0 Then
										strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
										strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
										strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
										strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									End If
									rstAux2 = mfRecordset(conPasarela, strSQL)
									Do While Not rstAux2.EOF
										If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
											strURP = rstAux2.Fields("NOM_DIAGRAMA").Value
											Exit Do
										End If
										rstAux2.MoveNext()
										strURP = "PR_FINEXPEDIENTE"
									Loop 
								End If
							Else
								If rstTram.Fields("ORDEN_N2").Value = 0 Then
									strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstTram.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								ElseIf rstTram.Fields("ORDEN_N3").Value = 0 Then 
									strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstTram.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
									strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstTram.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
									strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstTram.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								End If
								rstAux2 = mfRecordset(conPasarela, strSQL)
								Do While Not rstAux2.EOF
									If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
										strURP = rstAux2.Fields("NOM_DIAGRAMA").Value
										Exit Do
									End If
									rstAux2.MoveNext()
									strURP = "PR_FINEXPEDIENTE"
								Loop 
								strURP = rstAux2.Fields("NOM_DIAGRAMA").Value
							End If
						Else
							If rstTram.Fields("ORDEN_N2").Value = 0 Then
								strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > " & rstTram.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstTram.Fields("ORDEN_N3").Value = 0 Then 
								strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 > " & rstTram.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
								strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >" & rstTram.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
								strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >" & rstTram.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							End If
							rstAux2 = mfRecordset(conPasarela, strSQL)
							Do While Not rstAux2.EOF
								If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
									strURP = rstAux2.Fields("NOM_DIAGRAMA").Value
									Exit Do
								End If
								rstAux2.MoveNext()
								strURP = "PR_FINEXPEDIENTE"
							Loop 
							strURP = rstAux2.Fields("NOM_DIAGRAMA").Value
						End If
					Else
						'Obtenemos el nombre del trámite destino
						If rstTramB.Fields("ORDEN_N2").Value = 0 Then
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstTramB.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstTramB.Fields("ORDEN_N3").Value = 0 Then 
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTramB.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstTramB.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstTramB.Fields("ORDEN_N4").Value = 0 Then 
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTramB.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTramB.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstTramB.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstTramB.Fields("ORDEN_N5").Value = 0 Then 
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTramB.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstTramB.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTramB.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstTramB.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						rstAux2 = mfRecordset(conPasarela, strSQL)
						Do While Not rstAux2.EOF
							If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
								strURP = rstAux2.Fields("NOM_DIAGRAMA").Value
								Exit Do
							End If
							rstAux2.MoveNext()
							strURP = "PR_FINEXPEDIENTE"
						Loop 
					End If
					
					'Procedemos a insertar el TRAMITEFICTICIO donde insertaremos después la TDA
					strSQL = "SELECT COUNT(*) FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA LIKE 'PR_TRAMITEFICTICIO%'"
					rstAux4 = mfRecordset(conPasarela, strSQL)
					strTF = "PR_TRAMITEFICTICIO" & VB6.Format(Val(rstAux4.Fields(0).Value & "") + 1, "00")
					
					'...para conector opcional en Nivel 1
					If rstTram.Fields("ORDEN_N2").Value = 0 Then
						strSQL = "SELECT ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = 97"
						rstAux2 = mfRecordset(conPasarela, strSQL)
						If rstAux2.RecordCount = 0 Then
							strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", 97," & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & rstTram.Fields("NUM_DIAGRAMA").Value + 1 & ",'" & strTF & "','S',999999)"
							mfExecute(conPasarela, strSQL)
							lngOr1 = rstTram.Fields("ORDEN_N1").Value
							lngOr2 = 97
							lngOr3 = rstTram.Fields("ORDEN_N3").Value
							lngOr4 = rstTram.Fields("ORDEN_N4").Value
							lngOr5 = rstTram.Fields("ORDEN_N5").Value
							mfInserta_PROPIEDADES(lngOr1, 97, lngOr3, lngOr4, lngOr5, 999999, strTF, "", "", "", "", "", "", "")
						Else
							strSQL = "select count(*) from diagrama where procedimiento='" & gNomProcCorto & "' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " and orden_n2=98"
							rstAUX9 = mfRecordset(conPasarela, strSQL)
							If rstAUX9.Fields(0).Value = 0 Then
								lngOr2 = 98
							Else
								lngOr2 = 99
							End If
							strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & lngOr2 & "," & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & rstTram.Fields("NUM_DIAGRAMA").Value & ",'" & strTF & "','S',999999)"
							mfExecute(conPasarela, strSQL)
							mfInserta_PROPIEDADES(rstTram.Fields("ORDEN_N1").Value, lngOr2, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, 999999, strTF, "", "", "", "", "", "", "0")
							lngOr1 = rstTram.Fields("ORDEN_N1").Value
							lngOr3 = rstTram.Fields("ORDEN_N3").Value
							lngOr4 = rstTram.Fields("ORDEN_N4").Value
							lngOr5 = rstTram.Fields("ORDEN_N5").Value
						End If
						
						'Actualizar todas las salidas que apuntaban directamente al trámite destino, ahora apuntarán al TRAMITEFICTICIO
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
						mfExecute(conPasarela, strSQL,  , rows)
						'
						If rows = 0 Then
							'Inicio Jonathan 21/02/2012: En caso de no haber actualizado ningun parámetro, actualizamos
							'todos los parámetros de salida del trámite/ramificación (que el conector indique SALIDA=S,
							'excluye los que realmente apuntan a un process break Fin Expediente) apuntando al TRAMITEFICTICIO creado
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND VALOR='PR_FINEXPEDIENTE' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2 IN (SELECT ORDEN_N2 FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND NUM_SEQ IN (SELECT NUM_SEC_DESDE FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND SALIDA='S' AND NUM=2 AND CAT_CONECTOR<>'Conector Opcional'))"
							'Fin Jonathan 21/02/2012
							mfExecute(conPasarela, strSQL,  , rows)
						Else
							strSQL = "select * from conectores_di where procedimiento='" & gNomProcCorto & "'"
							strSQL = strSQL & " AND NUM=1 and num_sec_Desde=" & rstTram.Fields("NUM_SEQ").Value & " and cat_conector <> 'Conector Opcional'"
							rstAux = mfRecordset(conPasarela, strSQL)
							If rstAux.EOF Then
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='PR_FINEXPEDIENTE' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								mfExecute(conPasarela, strSQL)
							End If
						End If
						If rows = 0 Then blnSusti = True
						
						'...para conector opcional en Nivel 2
					ElseIf rstTram.Fields("ORDEN_N3").Value = 0 Then 
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ",98," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & rstTram.Fields("NUM_DIAGRAMA").Value + 1 & ",'" & strTF & "','S',999999)"
						mfExecute(conPasarela, strSQL)
						mfInserta_PROPIEDADES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, 98, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, 999999, strTF, "", "", "", "", "", "", "0")
						lngOr1 = rstTram.Fields("ORDEN_N1").Value
						lngOr2 = rstTram.Fields("ORDEN_N2").Value
						lngOr3 = 98
						lngOr4 = rstTram.Fields("ORDEN_N4").Value
						lngOr5 = rstTram.Fields("ORDEN_N5").Value
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
						mfExecute(conPasarela, strSQL,  , rows)
						'rev 1.3.0.2
						'If rows = 0 Then
						'Inicio Jonathan 21/02/2012: En caso de no haber actualizado ningun parámetro, actualizamos
						'todos los parámetros de salida del trámite/ramificación (que el conector indique SALIDA=S,
						'excluye los que realmente apuntan a un process break Fin Expediente) apuntando al TRAMITEFICTICIO creado
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND VALOR='PR_FINEXPEDIENTE' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3 IN (SELECT ORDEN_N3 FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND NUM_SEQ IN (SELECT NUM_SEC_DESDE FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND SALIDA='S' AND NUM=3 AND CAT_CONECTOR<>'Conector Opcional'))"
						'Fin Jonathan 21/02/2012
						mfExecute(conPasarela, strSQL,  , rows)
						'End If
						
						'...para conector opcional en Nivel 3
					ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & "," & rstTram.Fields("ORDEN_N3").Value & ",99," & rstTram.Fields("ORDEN_N5").Value & "," & rstTram.Fields("NUM_DIAGRAMA").Value + 1 & ",'" & strTF & "','S',999999)"
						mfExecute(conPasarela, strSQL)
						mfInserta_PROPIEDADES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, 99, rstTram.Fields("ORDEN_N5").Value, 999999, strTF, "", "", "", "", "", "", "0")
						lngOr1 = rstTram.Fields("ORDEN_N1").Value
						lngOr2 = rstTram.Fields("ORDEN_N2").Value
						lngOr3 = rstTram.Fields("ORDEN_N3").Value
						lngOr4 = 99
						lngOr5 = rstTram.Fields("ORDEN_N5").Value
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
						mfExecute(conPasarela, strSQL,  , rows)
						'If rows = 0 Then
						'Inicio Jonathan 21/02/2012: En caso de no haber actualizado ningun parámetro, actualizamos
						'todos los parámetros de salida del trámite/ramificación (que el conector indique SALIDA=S,
						'excluye los que realmente apuntan a un process break Fin Expediente) apuntando al TRAMITEFICTICIO creado
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND VALOR='PR_FINEXPEDIENTE' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4 IN (SELECT ORDEN_N4 FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND NUM_SEQ IN (SELECT NUM_SEC_DESDE FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND SALIDA='S' AND NUM=4 AND CAT_CONECTOR<>'Conector Opcional'))"
						'Fin Jonathan 21/02/2012
						mfExecute(conPasarela, strSQL,  , rows)
						'End If
						
						'...para conector opcional en Nivel 4
					ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & "," & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & ",99," & rstTram.Fields("NUM_DIAGRAMA").Value + 1 & ",'" & strTF & "','S',999999)"
						mfExecute(conPasarela, strSQL)
						mfInserta_PROPIEDADES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, 99, 999999, strTF, "", "", "", "", "", "", "0")
						lngOr1 = rstTram.Fields("ORDEN_N1").Value
						lngOr2 = rstTram.Fields("ORDEN_N2").Value
						lngOr3 = rstTram.Fields("ORDEN_N3").Value
						lngOr4 = rstTram.Fields("ORDEN_N4").Value
						lngOr5 = 99
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
						mfExecute(conPasarela, strSQL,  , rows)
						'If rows = 0 Then
						'Inicio Jonathan 21/02/2012: En caso de no haber actualizado ningun parámetro, actualizamos
						'todos los parámetros de salida del trámite/ramificación (que el conector indique SALIDA=S,
						'excluye los que realmente apuntan a un process break Fin Expediente) apuntando al TRAMITEFICTICIO creado
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND VALOR='PR_FINEXPEDIENTE' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5 IN (SELECT ORDEN_N5 FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND NUM_SEQ IN (SELECT NUM_SEC_DESDE FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND SALIDA='S' AND NUM=5 AND CAT_CONECTOR<>'Conector Opcional'))"
						'Fin Jonathan 21/02/2012
						mfExecute(conPasarela, strSQL,  , rows)
						'End If
					End If
					
					'Si todos los conectores salientes, de la misma ramificación, están categorizados (opcionales), no metemmos el JUMP fijo
					strSQL = "SELECT " & strCampos_Conectores_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstConS.Fields("DIAGRAMA").Value
					strSQL = strSQL & " AND NUM=" & rstConS.Fields("NUM").Value
					strSQL = strSQL & " AND NUM_SEC_DESDE=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND RTRIM(CAT_CONECTOR)=''"
					rstAUX9 = mfRecordset(conPasarela, strSQL)
					If rstAUX9.EOF Then
						GoTo paso
					End If
					
					''''calculo del jump fijo
					strSQL = "SELECT ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAUX9.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAUX9.Fields("DIAGRAMA").Value & " AND NUM_DIAGRAMA= " & rstAUX9.Fields("NUM").Value
					rstAux = mfRecordset(conPasarela, strSQL)
					If rstAux.EOF Then
						If Not rstAUX9.EOF Then
							rstAUX9.MoveNext()
						Else
							GoTo paso
						End If
						If rstAUX9.EOF = False Then
							strSQL = "SELECT ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAUX9.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAUX9.Fields("DIAGRAMA").Value & " AND NUM_DIAGRAMA= " & rstAUX9.Fields("NUM").Value
							rstAux = mfRecordset(conPasarela, strSQL)
						Else
							GoTo paso
						End If
					End If
					If rstAux.EOF Then
						rstAUX9.MoveNext()
						If Not rstAUX9.EOF Then
							strSQL = "SELECT ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAUX9.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAUX9.Fields("DIAGRAMA").Value & " AND NUM_DIAGRAMA= " & rstAUX9.Fields("NUM").Value
							rstAux = mfRecordset(conPasarela, strSQL)
						Else
							GoTo paso
						End If
					End If
					
					If rstAux.EOF = False Then
						If rstAux.Fields("ORDEN_N2").Value = 0 Then
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstTram.Fields("ORDEN_N3").Value = 0 Then 
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
							strSQL = "SELECT " & strCampos_Propiedades_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						rstAux2 = mfRecordset(conPasarela, strSQL)
						Do While Not rstAux2.EOF
							If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
								strJumFijo = rstAux2.Fields("NOM_DIAGRAMA").Value
								Exit Do
							End If
							rstAux2.MoveNext()
							strJumFijo = "PR_FINEXPEDIENTE"
						Loop 
						
metefijo: 
						strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
						rstAcc = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
						strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & lngOr1 & ", " & lngOr2 & " , " & lngOr3 & "," & lngOr4 & ", " & lngOr5 & ", 1," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "')"
						mfExecute(conPasarela, strSQL)
						msInsertaParamAcc("PATH", strJumFijo, lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, 1)
					End If
					
paso: 
					secAnt = rstConS.Fields("NUM_SEC_DESDE").Value
					numAnt = rstConS.Fields("NUM").Value
					intOrde1 = rstConS.Fields("ORDEN_N1").Value
					intOrde2 = rstConS.Fields("ORDEN_N2").Value
					intOrde3 = rstConS.Fields("ORDEN_N3").Value
					intOrde4 = rstConS.Fields("ORDEN_N4").Value
					
					'Nos situamos en el TRAMITEFICTICIO donde insertaremos la/s TDA/s
					strSQL = "SELECT ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & lngOr1 & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3= " & lngOr3 & " AND ORDEN_N4= " & lngOr4 & " AND ORDEN_N5=" & lngOr5
					rstAux3 = mfRecordset(conPasarela, strSQL)
					colTramites.Add(rstAux3.GetRows)
					
				Else
					'No sale de una ramificación
					colTramites.Add(rstTram.GetRows)
					rstTram.Requery()
				End If
			End If
			'--------------------------------------------------------------------------------------------------------------------------------------
			'Tratamiento para la inserción de las TDA/s
			
			'Obtenemos el ID del conector opcional tratado
			strSQL = "Select DISTINCT J.ANO_ID " & " FROM JOINER J, CW_DATA_USAGE C " & " WHERE J.JO_SEQ=" & rstConS.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstConS.Fields("NUM_SEC_DESDE").Value & " AND SH_SEQ_TO=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND DI_ID=" & rstConS.Fields("DI_ID").Value & " AND DM_INSERTS=1 " & " AND J.MODEL_NAME ='" & strModelo & "' " & " AND C.MODEL_NAME ='" & strModelo & "'"
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				'Obtenemos el uso de datos del conector opcional tratado
				strSQL = "SELECT C.AT_ID, A.AT_NAME, E.EN_NAME " & " FROM ATTRIBUTE A, CW_DATA_USAGE C, ENTITY E " & " Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") " & " AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID " & " AND A.MODEL_NAME ='" & strModelo & "' " & " AND C.MODEL_NAME ='" & strModelo & "' " & " AND E.MODEL_NAME ='" & strModelo & "' " & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL)
				If Not rstparamCME.EOF Then
					
					'Obtenemos el número de bloques de condiciones del conector
					If rstparamCME.RecordCount < 12 Then
						intNumBloquesCond = Int(rstparamCME.RecordCount / 3)
					Else
						intNumBloquesCond = System.Math.Round(rstparamCME.RecordCount / 4, 0)
					End If
					
					'Validaciones número de parámetros conector opcional:
					'1. Tiene que tener, al menos, un bloque de condiciones (3 parámetros)
					If intNumBloquesCond < 1 Then
						Insertar_Error(Me, "Lectura de conectores opcionales", "El conector opcional de entrada a '" & rstTramB.Fields("NOMBRE").Value & "', desde '" & rstTram.Fields("NOMBRE").Value & "', tiene que tener, al menos, un bloque de condiciones (operando1, operando2 y operador)", "msConectoresOpcionales")
						Mostrar_Error()
						GoTo SigConector
					End If
					
					'Dato a almacenar en el campo NUM_SEQ de la tabla ACCIONES_DI que nos servirá para identificar las TDAs del mismo conector
					If intNumSecConector = 0 Then
						intNumSecConector = 1
					Else
						intNumSecConector = intNumSecConector + 1
					End If
					
					'Bucle de bloques de condiciones del conector opcional (los bloques de asignaciones tienen el mismo nº de parámetros)
					For intBloqueCond = 1 To intNumBloquesCond
						
						'Puede que ya hayamos terminado de recorrer los parámetros del conector opcional
						If rstparamCME.EOF Then
							Exit For
						End If
						
						'Para que en cada bloque de condiciones inserte todos los parámetros de la TDA
						blnInserta = True
						
						'Nos situamos en el primer parámetro hidra de la TDA
						rstparamHN.MoveFirst()
						
						For	Each icol In colTramites
							
							'Orden de nivel de la TDA a insertar
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr1 = icol(0, 0)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr2 = icol(1, 0)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr3 = icol(2, 0)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr4 = icol(3, 0)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr5 = icol(4, 0)
							
							'Obtenemos el orden de acción que ocupará la TDA
							strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE" & " PROCEDIMIENTO='" & gNomProcCorto & "' " & " AND ORDEN_N1=" & lngOr1 & " and ORDEN_N2=" & lngOr2 & " and ORDEN_N3=" & lngOr3 & " and ORDEN_N4=" & lngOr4 & " and ORDEN_N5=" & lngOr5 & " AND ORDEN_ACC<>999"
							rstAux = mfRecordset(conPasarela, strSQL)
							lngORACC = Val(rstAux.Fields(0).Value & "") + 1
							
							'Obtenemos el número de TDA que llevará la nueva
							strSQL = "SELECT COUNT(*) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TDAUTOMATICA'"
							rstAux = mfRecordset(conPasarela, strSQL)
							lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
							
							'Identificamos parámetros "separadores" para averiguar si se trata de una condición ó una asignación
							blnAsignacion = False
							If Trim(rstparamCME.Fields("EN_NAME").Value) = "Constantes" Then
								colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strValorV = colXMLD.Item(1)
								If Trim(strValorV) = cstrSeparadorTDA Then
									'Otra Condición
									rstparamCME.MoveNext()
								ElseIf Trim(strValorV) = cstrSeparadorASIG Then 
									'No es una condición, es una asignación de variable
									blnAsignacion = True
									rstparamCME.MoveNext()
								End If
							End If
							
							If blnAsignacion = True Then
								'----------------------------------------------------------------------------------------------------------
								'ASIGNACIÓN DE VARIABLE
								
								'En una asignación de variable jamás deberá insertar los parámetros genéricos
								blnInserta = False
								
								'Parámetro 1: variable destino
								If Trim(rstparamCME.Fields("EN_NAME").Value) = "Constantes" Or Trim(rstparamCME.Fields("EN_NAME").Value) = vbNullString Then
									Insertar_Error(Me, "Lectura de conectores opcionales", "El primer parámetro de cada asignación incluída en el conector opcional de entrada a '" & rstTramB.Fields("NOMBRE").Value & "', desde '" & rstTram.Fields("NOMBRE").Value & "', debe ser una variable (destino)", "msConectoresOpcionales")
									Mostrar_Error()
									GoTo SigConector
								Else
									'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strAsigParam1 = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
								End If
								
								'Parámetro 2: Operador. Tiene que ser un "="
								rstparamCME.MoveNext()
								If Trim(rstparamCME.Fields("EN_NAME").Value) <> "Constantes" Then
									Insertar_Error(Me, "Lectura de conectores opcionales", "El segundo parámetro de cada asignación incluída en el conector opcional de entrada a '" & rstTramB.Fields("NOMBRE").Value & "', desde '" & rstTram.Fields("NOMBRE").Value & "', debe ser el operador '='", "msConectoresOpcionales")
									Mostrar_Error()
									GoTo SigConector
								Else
									colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
									'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strAsigParam2 = colXMLD.Item(1)
									If strAsigParam2 <> "=" Then
										Insertar_Error(Me, "Lectura de conectores opcionales", "El segundo parámetro de cada asignación incluída en el conector opcional de entrada a '" & rstTramB.Fields("NOMBRE").Value & "', desde '" & rstTram.Fields("NOMBRE").Value & "', debe ser el operador '='", "msConectoresOpcionales")
										Mostrar_Error()
										GoTo SigConector
									End If
								End If
								
								'Parámetro 3: Valor variable/constante origen
								rstparamCME.MoveNext()
								Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
									'Valor constante
									Case "Constantes"
										'Obtenemos el valor de la constante
										colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
										'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
										strAsigParam3 = colXMLD.Item(1)
										If strAsigParam3 = "" Then
											Insertar_Error(Me, "Lectura de conectores opcionales", "No se encuentra el valor de la constante '" & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & "' de la asignación incluída en el conector opcional de entrada a '" & rstTramB.Fields("NOMBRE").Value & "', desde '" & rstTram.Fields("NOMBRE").Value & "'", "msConectoresOpcionales")
											Mostrar_Error()
											GoTo SigConector
										End If
									Case ""
										'Parámetro vacío
										strAsigParam3 = vbNullString
									Case Else
										'Variable de expediente
										'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
										strAsigParam3 = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
								End Select
								
								'Inicio Jonathan Prieto 03/12/2013
								'Identificamos si apunta a un trámite o a una ramificación
								If rstConS.Fields("NUM").Value = 1 Then
									strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N2=0"
								ElseIf rstConS.Fields("NUM").Value = 2 Then 
									strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value
								ElseIf rstConS.Fields("NUM").Value = 3 Then 
									strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value
								ElseIf rstConS.Fields("NUM").Value = 4 Then 
									strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value
								ElseIf rstConS.Fields("NUM").Value = 5 Then 
									strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstConS.Fields("ORDEN_N4").Value
								End If
								
								rst2 = mfRecordset(conPasarela, strSQL)
								
								If Trim(rst2.Fields("CAT_DIAGRAMA").Value) = "Ramificación" Then
									'----------------------------------------------------------------------------------------------------------
									'Apunta a una ramificación
									'Buscar la LOCALxx que le toca
									strSQL = "SELECT distinct valor FROM param_acc WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND parametro like '@LOCALCO%'"
									rst6 = mfRecordset(conPasarela, strSQL)
									lngLocal = rst6.RecordCount + 1
									
									'Buscamos el primer trámite de la ramificación
									If rst2.Fields("NUM_DIAGRAMA").Value = 1 Then
										'Ramificación en nivel 1
										strSQL = "SELECT TOP 1 ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5," & " ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5," & " ID_DIAGRAMA, ID_PADRE, NUM_DIAGRAMA, EXPLOTA_ACC, NUM_SEQ, DI_ID" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 > " & rst2.Fields("ORDEN_N2").Value & " AND EXPLOTA_ACC = 'S'" & " order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
										
									ElseIf rst2.Fields("NUM_DIAGRAMA").Value = 2 Then 
										'Ramificación en nivel 2
										strSQL = "SELECT TOP 1 ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5," & " ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5," & " ID_DIAGRAMA, ID_PADRE, NUM_DIAGRAMA, EXPLOTA_ACC, NUM_SEQ, DI_ID" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 > " & rst2.Fields("ORDEN_N3").Value & " AND EXPLOTA_ACC = 'S'" & " order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
										
									ElseIf rst2.Fields("NUM_DIAGRAMA").Value = 3 Then 
										'Ramificación en nivel 3
										strSQL = "SELECT TOP 1 ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5," & " ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5," & " ID_DIAGRAMA, ID_PADRE, NUM_DIAGRAMA, EXPLOTA_ACC, NUM_SEQ, DI_ID" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 > " & rst2.Fields("ORDEN_N4").Value & " AND EXPLOTA_ACC = 'S'" & " order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
										
									ElseIf rst2.Fields("NUM_DIAGRAMA").Value = 4 Then 
										'Ramificación en nivel 4
										strSQL = "SELECT TOP 1 ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5," & " ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5," & " ID_DIAGRAMA, ID_PADRE, NUM_DIAGRAMA, EXPLOTA_ACC, NUM_SEQ, DI_ID" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5 > " & rst2.Fields("ORDEN_N5").Value & " AND EXPLOTA_ACC = 'S'" & " order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
										
									End If
									'Fin Jonathan Prieto 03/12/2013
									rst5 = mfRecordset(conPasarela, strSQL)
									If Not rst5.EOF Then
										If rst5.Fields("EXPLOTA_ACC").Value = "S" Then
											'INSERTAMOS UNA ACCION LETVAR COMO PRIMERA ACCIÓN DEL PRIMER TRAMITE
											'Obtenemos todas las acciones del primer trámite
											strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC "
											strSQL = strSQL & "FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
											strSQL = strSQL & "ORDEN_N1 = " & rst5.Fields("ORDEN_N1").Value & " AND "
											strSQL = strSQL & "ORDEN_N2 = " & rst5.Fields("ORDEN_N2").Value & " AND "
											strSQL = strSQL & "ORDEN_N3 = " & rst5.Fields("ORDEN_N3").Value & " AND "
											strSQL = strSQL & "ORDEN_N4 = " & rst5.Fields("ORDEN_N4").Value & " AND "
											strSQL = strSQL & "ORDEN_N5 = " & rst5.Fields("ORDEN_N5").Value & " "
											strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC DESC"
											rst6 = mfRecordset(conPasarela, strSQL)
											'Movemos una posición abajo todas las acciones del trámite, para dejar un hueco a la LETVAR
											While Not rst6.EOF
												strSQL = "UPDATE ACCIONES_DI SET "
												strSQL = strSQL & "ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
												strSQL = strSQL & "ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value
												strSQL = strSQL & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value
												strSQL = strSQL & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value
												strSQL = strSQL & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value
												strSQL = strSQL & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
												strSQL = strSQL & " AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												
												strSQL = "UPDATE PARAM_ACC SET "
												strSQL = strSQL & "ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
												strSQL = strSQL & "ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value
												strSQL = strSQL & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value
												strSQL = strSQL & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value
												strSQL = strSQL & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value
												strSQL = strSQL & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
												strSQL = strSQL & " AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rst6.MoveNext()
											End While
											rst6.Close()
											'UPGRADE_NOTE: Object rst6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
											rst6 = Nothing
											'Número de acción LETVAR que le toca
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
											rst6 = mfRecordset(conPasarela, strSQL)
											lngNumAcc2 = rst6.Fields(0).Value + 1
											'UPGRADE_NOTE: Object rst6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
											rst6 = Nothing
											'Insertamos la acción LETVAR como primera acción del trámite
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) "
											strSQL = strSQL & "VALUES ('" & gNomProcCorto & "'," & rst5.Fields("ORDEN_N1").Value & ", "
											strSQL = strSQL & rst5.Fields("ORDEN_N2").Value & ", " & rst5.Fields("ORDEN_N3").Value & ", "
											strSQL = strSQL & rst5.Fields("ORDEN_N4").Value & "," & rst5.Fields("ORDEN_N5").Value & ", "
											strSQL = strSQL & "0," & "'LET INICIALIZACIONVAR'," & lngNumAcc2 & ","
											strSQL = strSQL & "'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc2, "00") & "')"
											mfExecute(conPasarela, strSQL)
											'Asignamos el valor del parámetro 3 a la variable local creada
											If Trim(rstparamCME.Fields("EN_NAME").Value) = "Constantes" Or Trim(rstparamCME.Fields("EN_NAME").Value) = vbNullString Then
												'Valor constante
												msInsertaParamAcc("@LOCALCO" & VB6.Format(lngLocal, "00"), strAsigParam3, rst5.Fields("ORDEN_N1").Value, rst5.Fields("ORDEN_N2").Value, rst5.Fields("ORDEN_N3").Value, rst5.Fields("ORDEN_N4").Value, rst5.Fields("ORDEN_N5").Value, 0)
											Else
												'Valor de una variable
												msInsertaParamAcc("@LOCALCO" & VB6.Format(lngLocal, "00"), "@INICIO!" & strAsigParam3, rst5.Fields("ORDEN_N1").Value, rst5.Fields("ORDEN_N2").Value, rst5.Fields("ORDEN_N3").Value, rst5.Fields("ORDEN_N4").Value, rst5.Fields("ORDEN_N5").Value, 0)
											End If
										End If
									End If
									
									'REEMPLAZAR TODOS LOS VARxx POR LOCALxx DENTRO DE LA RAMIFICACIÓN, ES DECIR, TODOS AQUELLOS
									'CUYO PADRE SEA LA RAMIFICACION Y SU ORDEN_N1 SEA EL MISMO
									If rst2.Fields("NUM_DIAGRAMA").Value = 1 Then
										strSQL = "UPDATE PARAM_ACC SET "
										strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strAsigParam1 & "', 'LOCALCO" & VB6.Format(lngLocal, "00") & "'), "
										strSQL = strSQL & "VALOR=Replace(VALOR, '" & strAsigParam1 & "', 'LOCALCO" & VB6.Format(lngLocal, "00") & "') "
										strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND "
										strSQL = strSQL & "ORDEN_N2 > " & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_ACC > 0"
										
									ElseIf rst2.Fields("NUM_DIAGRAMA").Value = 2 Then 
										strSQL = "UPDATE PARAM_ACC SET "
										strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strAsigParam1 & "', 'LOCALCO" & VB6.Format(lngLocal, "00") & "'), "
										strSQL = strSQL & "VALOR=Replace(VALOR, '" & strAsigParam1 & "', 'LOCALCO" & VB6.Format(lngLocal, "00") & "') "
										strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND "
										strSQL = strSQL & "ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND "
										strSQL = strSQL & "ORDEN_N3 > " & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_ACC > 0"
										
									ElseIf rst2.Fields("NUM_DIAGRAMA").Value = 3 Then 
										strSQL = "UPDATE PARAM_ACC SET "
										strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strAsigParam1 & "' 'LOCALCO" & VB6.Format(lngLocal, "00") & "'), "
										strSQL = strSQL & "VALOR=Replace(VALOR, '" & strAsigParam1 & "', 'LOCALCO" & VB6.Format(lngLocal, "00") & "') "
										strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND "
										strSQL = strSQL & "ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND "
										strSQL = strSQL & "ORDEN_N3 = " & rst2.Fields("ORDEN_N3").Value & " AND "
										strSQL = strSQL & "ORDEN_N4 > " & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_ACC > 0"
										
									ElseIf rst2.Fields("NUM_DIAGRAMA").Value = 4 Then 
										strSQL = "UPDATE PARAM_ACC SET "
										strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strAsigParam1 & "', 'LOCALCO" & VB6.Format(lngLocal, "00") & "'), "
										strSQL = strSQL & "VALOR=Replace(VALOR, '" & strAsigParam1 & "', 'LOCALCO" & VB6.Format(lngLocal, "00") & "') "
										strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst2.Fields("ORDEN_N1").Value & " AND "
										strSQL = strSQL & "ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND "
										strSQL = strSQL & "ORDEN_N3 = " & rst2.Fields("ORDEN_N3").Value & " AND "
										strSQL = strSQL & "ORDEN_N4 = " & rst2.Fields("ORDEN_N4").Value & " AND "
										strSQL = strSQL & "ORDEN_N5 > " & rst2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > 0"
										
									End If
									mfExecute(conPasarela, strSQL)
									
								Else
									'-----------------------------------------------------------------------------------------------------
									'Apunta a un trámite
									'Sustituir el valor de todas las apariciones del parámetro 1 de la asignación, utilizado como parámetro
									'de entrada a cualquier acción del trámite, con el valor del parámetro 3 de la asignación
									strSQL = "UPDATE PARAM_ACC " & "SET VALOR='" & strAsigParam3 & "' " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & "AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value & " AND PARAMETRO='" & strAsigParam1 & "'"
									mfExecute(conPasarela, strSQL)
									
								End If
								rstparamCME.MoveNext()
								GoTo SigBloqueCond
							Else
								'----------------------------------------------------------------------------------------------------------
								'CONDICIÓN PARA TDA
								
								'Insertar la TDA (primera condición del conector opcional)
								strPath = "APE_TDAUTOMATICA" & VB6.Format(lngNumAcc, "00")
								strSQL = "INSERT INTO ACCIONES_DI (" & "PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, " & "ORDEN_N4, ORDEN_N5, ORDEN_ACC, " & "NOM_ACCION, NUM_ACCION, TIPO_ACCION, PATH_HIDRA, NUM_SEQ) VALUES " & "('" & gNomProcCorto & "'," & lngOr1 & "," & lngOr2 & "," & lngOr3 & ", " & lngOr4 & "," & lngOr5 & "," & lngORACC & "," & "'TDAUTOMATICA'," & lngNumAcc & ",'G','" & strPath & "'," & intNumSecConector & ")"
								mfExecute(conPasarela, strSQL)
							End If
							Exit For
						Next icol
						
						'----------------------------------------------------------------------------------------------------------
						'Bloque de condición, parámetros OPERANDO1, OPERANDO2 y OPERADOR
						For intContParam = 1 To cintParamCondicion
							
							Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
								
								'Valor constante
								Case "Constantes"
									'Obtenemos el valor de la constante
									colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
									'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strValorV = colXMLD.Item(1)
									If strValorV = "" Then
										Insertar_Error(Me, "Lectura de conectores opcionales", "No se encuentra el valor de la constante '" & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & "' del conector opcional de entrada a '" & rstTramB.Fields("NOMBRE").Value & "', desde '" & rstTram.Fields("NOMBRE").Value & "'", "msConectoresOpcionales")
										Mostrar_Error()
										GoTo SigConector
									Else
										msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
									End If
								Case ""
									'Parámetro vacío
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
									
								Case Else
									'Variable de expediente
									'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
									
							End Select
							rstparamHN.MoveNext()
							rstparamCME.MoveNext()
						Next intContParam
						
						'Parámetros SALTOTRUE y SALTOFALSE
						If intBloqueCond > 1 Then
							'No es la primera condición del conector opcional, el SALTOTRUE lo copiamos de la TDA anterior
							
							'Obtenemos el número de orden de la TDA de la condición anterior
							strSQL = "SELECT ORDEN_ACC FROM ACCIONES_DI WHERE" & " PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & lngOr1 & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3=" & lngOr3 & " AND ORDEN_N4=" & lngOr4 & " AND ORDEN_N5=" & lngOr5 & " AND NOM_ACCION='TDAUTOMATICA'" & " AND NUM_ACCION=" & lngNumAcc - 1
							rstAux = mfRecordset(conPasarela, strSQL)
							intORACCant = rstAux.Fields("ORDEN_ACC").Value
							
							'Obtenemos el valor del SALTOTRUE de la TDA anterior
							strSQL = "SELECT VALOR" & " FROM PARAM_ACC" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & lngOr1 & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3=" & lngOr3 & " AND ORDEN_N4=" & lngOr4 & " AND ORDEN_N5=" & lngOr5 & " AND ORDEN_ACC=" & intORACCant & " AND PARAMETRO='@SALTOTRUE'"
							rstAux = mfRecordset(conPasarela, strSQL)
							nomTramS = rstAux.Fields("VALOR").Value
							
						Else
							'Primera condición del conector opcional
							
							'Trámite destino del conector opcional
							strSQL = "SELECT " & strCampos_Diagrama & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConS.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstConS.Fields("DIAGRAMA").Value
							If rstConS.Fields("NUM").Value = 1 Then
								strSQL = strSQL & " AND ORDEN_N2=0"
							ElseIf rstConS.Fields("NUM").Value = 2 Then 
								strSQL = strSQL & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value
							ElseIf rstConS.Fields("NUM").Value = 3 Then 
								strSQL = strSQL & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstConS.Fields("ORDEN_N2").Value
							ElseIf rstConS.Fields("NUM").Value = 4 Then 
								strSQL = strSQL & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value
							ElseIf rstConS.Fields("NUM").Value = 5 Then 
								strSQL = strSQL & " AND ORDEN_N1=" & rstConS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstConS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstConS.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstConS.Fields("ORDEN_N4").Value
							End If
							'Inicio Jonathan Prieto 25/02/2011: Nuevo tratamiento para los que apuntan a un Evento en lugar de un Proceso
							If blnEncontrado = True Then
								If strSQLEncontrado = "ENLACE SIN DEFINIR" Then
									nomTramS = "ENLACE SIN DEFINIR"
									GoTo SaltoTrue
								Else
									strSQL = strSQLEncontrado
								End If
							End If
							'Inicio Jonathan Prieto 25/02/2011: Nuevo tratamiento para los que apuntan a un Evento en lugar de un Proceso
							rstTram2 = mfRecordset(conPasarela, strSQL)
							
							'Por si no se ha encontrado el trámite al que apunta
							If rstTram2.EOF Then
								GoTo SigConector
							End If
							
							'Tipo de objeto (trámite/ramificación) al que apunta el conector opcional
							If rstTram2.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
								'Apunta a una ramificación
								If rstTram2.Fields("ORDEN_N2").Value = 0 Then
									System.Windows.Forms.Application.DoEvents()
									lngOrP2 = 1
								Else
									lngOrP2 = rstTram2.Fields("ORDEN_N2").Value
									If rstTram2.Fields("ORDEN_N3").Value = 0 Then
										System.Windows.Forms.Application.DoEvents()
										lngOrP3 = 1
									Else
										lngOrP3 = rstTram2.Fields("ORDEN_N3").Value
										If rstTram2.Fields("ORDEN_N4").Value = 0 Then
											System.Windows.Forms.Application.DoEvents()
											lngOrP4 = 1
										Else
											lngOrP4 = rstTram2.Fields("ORDEN_N4").Value
											If rstTram2.Fields("ORDEN_N5").Value = 0 Then
												System.Windows.Forms.Application.DoEvents()
												lngOrP5 = 1
											Else
												System.Windows.Forms.Application.DoEvents()
												lngOrP2 = rstTram2.Fields("ORDEN_N2").Value
											End If
										End If
									End If
								End If
							Else
								'Apunta a un trámite
								lngOrP2 = rstTram2.Fields("ORDEN_N2").Value
								lngOrP3 = rstTram2.Fields("ORDEN_N3").Value
								lngOrP4 = rstTram2.Fields("ORDEN_N4").Value
								lngOrP5 = rstTram2.Fields("ORDEN_N5").Value
							End If
							
							'Obtenemos el nombre del trámite al que apunta
							If rstTram2.Fields("NUM_DIAGRAMA").Value = "1" Then
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstTram2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstTram2.Fields("NUM_DIAGRAMA").Value = "2" Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & lngOrP2 & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstTram2.Fields("NUM_DIAGRAMA").Value = "3" Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngOrP2 & " AND ORDEN_N3 >=" & lngOrP3 & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstTram2.Fields("NUM_DIAGRAMA").Value = "4" Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngOrP2 & " AND ORDEN_N3=" & lngOrP3 & " AND ORDEN_N4 >=" & lngOrP4 & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							Else
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & lngOrP2 & " AND ORDEN_N3=" & lngOrP3 & " AND ORDEN_N4 =" & lngOrP4 & " AND ORDEN_N5 >=" & lngOrP5 & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							End If
							rstAux = mfRecordset(conPasarela, strSQL)
							Do While Not rstAux.EOF
								If rstAux.Fields("NOM_DIAGRAMA").Value <> "" Then
									nomTramS = rstAux.Fields("NOM_DIAGRAMA").Value
									Exit Do
								End If
								rstAux.MoveNext()
								nomTramS = "PR_FINEXPEDIENTE"
							Loop 
							
							'La salida que apuntaba directamente al trámite debe apuntar al nuevo TRAMITEFICTICIO
							If blnSusti = True Then
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & nomTramS & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								mfExecute(conPasarela, strSQL,  , rows)
								blnSusti = False
							End If
							
						End If
						
SaltoTrue: 
						'Insertamos el parámetro SALTOTRUE
						If rstAux.EOF = True Then
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
						Else
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomTramS, lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
						End If
						
						'Insertamos el parámetro SALTOFALSE. Siempre a FINEXPEDIENTE
						rstparamHN.MoveNext()
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "PR_FINEXPEDIENTE", lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, lngORACC)
						
						'Insertamos la acción EDP_TDAUTOMATICA
						lngORACC = lngORACC + 1
						strPath = "EDP_TDAUTOMATICA" & VB6.Format(lngNumAcc, "00")
						strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngOr1 & ", " & lngOr2 & ", " & lngOr3 & "," & lngOr4 & "," & lngOr5 & "," & lngORACC & "," & "'ENDPROC'," & lngNumAcc & "," & "'" & strPath & "')"
						mfExecute(conPasarela, strSQL)
						
						'Insertamos la acción PRO_TDAUTOMATICA
						lngORACC = lngORACC + 1
						strPath = "PRO_TDAUTOMATICA" & VB6.Format(lngNumAcc, "00")
						strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngOr1 & ", " & lngOr2 & ", " & lngOr3 & "," & lngOr4 & "," & lngOr5 & "," & lngORACC & "," & "'PROCESS'," & lngNumAcc & "," & "'" & strPath & "')"
						mfExecute(conPasarela, strSQL)
						
						'Actualizar el parámetro PATHRETORNO de la acción APE_TDAUTOMATICA
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and " & "ORDEN_N1=" & lngOr1 & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3=" & lngOr3 & " AND ORDEN_N4=" & lngOr4 & " AND ORDEN_N5=" & lngOr5 & " AND ORDEN_ACC=" & lngORACC - 2
						mfExecute(conPasarela, strSQL)
						
						'Si no es la primera condición del conector opcional, modificamos el SALTOTRUE de la TDA anterior
						If intBloqueCond > 1 Then
							'El SALTOTRUE de la TDA anterior apuntará a la nueva TDA
							strPath = "APE_TDAUTOMATICA" & VB6.Format(lngNumAcc, "00")
							strSQL = "UPDATE PARAM_ACC" & " SET VALOR='" & strPath & "'" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & lngOr1 & " AND ORDEN_N2=" & lngOr2 & " AND ORDEN_N3=" & lngOr3 & " AND ORDEN_N4=" & lngOr4 & " AND ORDEN_N5=" & lngOr5 & " AND ORDEN_ACC=" & intORACCant & " AND PARAMETRO='@SALTOTRUE'"
							rstAux = mfRecordset(conPasarela, strSQL)
						End If
						
SigBloqueCond: 
					Next intBloqueCond
					
SigConector: 
					rstConS.MoveNext()
				Else
					Insertar_Error(Me, "Lectura de conectores opcionales", "El conector opcional de entrada a '" & rstTramB.Fields("NOMBRE").Value & "', desde '" & rstTram.Fields("NOMBRE").Value & "', tiene que tener, al menos, un bloque de condiciones (operando1, operando2 y operador)", "msConectoresOpcionales")
					Mostrar_Error()
					GoTo SigConector
				End If
				
			End If
		End While
		
		GoTo procFin
procErr: 
		
		'para salir si han dado a cancelar (aketza)
		
		If blnCancelar = True Then Exit Sub
		If Err.Number = 438 Then GoTo SigConector
		'aketza errores
		Insertar_Error(Me, "Lectura de conectores opcionales", "Ha ocurrido un error no controlado " & Err.Description, "msConectoresOpcionales" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msConectoresOpcionales - " & Err.Description)
		
		Resume procFin
		
procFin: 
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'UPGRADE_NOTE: Object rst2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst2 = Nothing
		'UPGRADE_NOTE: Object rst5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst5 = Nothing
		'UPGRADE_NOTE: Object rst6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst6 = Nothing
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		'UPGRADE_NOTE: Object rstAux3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux3 = Nothing
		'UPGRADE_NOTE: Object rstAux4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux4 = Nothing
		'UPGRADE_NOTE: Object rstAUX8 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAUX8 = Nothing
		'UPGRADE_NOTE: Object rstAUX9 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAUX9 = Nothing
		'UPGRADE_NOTE: Object rstAcc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAcc = Nothing
		'UPGRADE_NOTE: Object rstparamCME may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstparamCME = Nothing
		'UPGRADE_NOTE: Object rstparamHN may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstparamHN = Nothing
		'UPGRADE_NOTE: Object rstconE may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstconE = Nothing
		'UPGRADE_NOTE: Object rstConS may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstConS = Nothing
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
		'UPGRADE_NOTE: Object rstTram2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram2 = Nothing
		'UPGRADE_NOTE: Object rstTramB may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTramB = Nothing
		'UPGRADE_NOTE: Object rstEvento1 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstEvento1 = Nothing
		'UPGRADE_NOTE: Object rstEvento2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstEvento2 = Nothing
		'UPGRADE_NOTE: Object colTramites may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		colTramites = Nothing
		'UPGRADE_NOTE: Object colXMLD may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		colXMLD = Nothing
		'UPGRADE_NOTE: Object colXML2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		colXML2 = Nothing
		'UPGRADE_NOTE: Object icol may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		icol = Nothing
		
	End Sub
	
	Private Sub msActualizarSalidas()
		On Error GoTo procErr
		
		Dim rstProp As ADODB.Recordset
		Dim rstTram As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim lngnumSal As Integer
		Dim strSQL As String
		Dim I As Short
		
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND EXPLOTA_ACC='S'"
		rstTram = mfRecordset(conPasarela, strSQL)
		While Not rstTram.EOF
			strSeg = rstTram.Fields("ORDEN_N1").Value & "/" & rstTram.Fields("ORDEN_N2").Value & "/" & rstTram.Fields("ORDEN_N3").Value & "/" & rstTram.Fields("ORDEN_N4").Value & "/" & rstTram.Fields("ORDEN_N5").Value
			strSQL = "SELECT A.EV_NAME, A.EV_ID, D.SH_SEQ, D.DI_ID  FROM "
			strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
			strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
			strSQL = strSQL & "D.ANO_TABNR=9097 AND "
			strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
			strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
			strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
			strSQL = strSQL & "E.ANO_ID = " & rstTram.Fields("ID_DIAGRAMA").Value
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'Inicio Jonathan Prieto 02/02/2011: Que no busque trámites de usuario
			strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
			'Fin Jonathan Prieto 02/02/2011
			rstProp = mfRecordset(conDP4, strSQL)
			lngnumSal = 0
			If rstProp.EOF Then
				System.Windows.Forms.Application.DoEvents()
			End If
			While Not rstProp.EOF
				strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_SEQ_HASTA=" & rstProp.Fields("SH_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
				rstAcc = mfRecordset(conPasarela, strSQL)
				If Not rstAcc.EOF Then
					lngnumSal = lngnumSal + 1
					'aketza 29/01/2007
				Else
					'aketza 29/04/2008
					'strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND (UPPER(RTRIM(CAT_CONECTOR2))='FIN DE EXPEDIENTE' or UPPER(RTRIM(CAT_CONECTOR2))='FIN DE ASUNTO') And  NUM_SEC_DESDE=" & rstTram("NUM_SEQ") & " and DIAGRAMA=" & rstTram("DI_ID")
					'Inicio Jonathan Prieto 21/02/2011: tiene que comparar con el mismo concepto, ambos DI_ID o ambos ID del trámite (que sería DIAGRAMA=rstTram("ID_PADRE")
					strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND (UPPER(RTRIM(CAT_CONECTOR2))='FIN DE EXPEDIENTE' or UPPER(RTRIM(CAT_CONECTOR2))='FIN DE ASUNTO' or UPPER(RTRIM(CAT_CONECTOR2))='FIN ASUNTO') And  NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " and DI_ID=" & rstTram.Fields("DI_ID").Value
					'strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND (UPPER(RTRIM(CAT_CONECTOR2))='FIN DE EXPEDIENTE' or UPPER(RTRIM(CAT_CONECTOR2))='FIN DE ASUNTO' or UPPER(RTRIM(CAT_CONECTOR2))='FIN ASUNTO') And  NUM_SEC_DESDE=" & rstTram("NUM_SEQ") & " and DIAGRAMA=" & rstTram("DI_ID")
					'Fin Jonathan Prieto 21/02/2011
					'fin aketza
					rstAcc = mfRecordset(conPasarela, strSQL)
					If Not rstAcc.EOF Then
						lngnumSal = lngnumSal + 1
					End If
					'fin aketza
				End If
				rstProp.MoveNext()
			End While
			strSQL = "SELECT COUNT(*) FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
			strSQL = strSQL & "IND_SALIDA_TRAM='S' AND RTRIM(CAT_CONECTOR2)<>''"
			rstAcc = mfRecordset(conPasarela, strSQL)
			If lngnumSal = 0 Then
				lngnumSal = lngnumSal + rstAcc.Fields(0).Value
			End If
			If lngnumSal > 0 Then
				strSQL = "UPDATE DIAGRAMA SET SALIDAS=" & lngnumSal & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1 = " & rstTram.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2 = " & rstTram.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3 = " & rstTram.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4 = " & rstTram.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5 = " & rstTram.Fields("ORDEN_N5").Value
				mfExecute(conPasarela, strSQL)
			End If
			rstTram.MoveNext()
		End While
		
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Actualizar Salidas", "Ha ocurrido un error no controlado", "msActualizarSalidas" & " -" & strSeg)
		Mostrar_Error()
		logError("msActualizarSalidas - " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	
	Private Sub msCrearFlujo()
		Dim strSQL As String
		Dim rstInf As ADODB.Recordset
		Dim intCodProce As Short
		Dim rstAux As ADODB.Recordset
		
		On Error GoTo procErr
		'''''''''''''''''''''''''''''''
		'''''insertamos en WFFLOWS'''''
		'''''''''''''''''''''''''''''''
		System.Windows.Forms.Application.DoEvents()
		lblMensaje.Text = "Insertando Flujo en PASARELA"
		
		strSQL = "SELECT CODPROCE, CODEXTPR FROM TBPFIN01_PA WHERE PROCEDIMIENTO = '" & gNomProcCorto & "'"
		rstInf = mfRecordset(conPasarela, strSQL)
		msProceso(1, 5, 1, 1)
		
		If Not rstInf.EOF Then
			Selectedflow = Trim(rstInf.Fields("CODEXTPR").Value)
			intCodProce = CShort(Trim(rstInf.Fields("CODPROCE").Value))
		End If
		rstInf.Close()
		
		conDB2 = New ADODB.Connection
		If ComprobarConexion(conDB2, ReadIniFile(INIFile, "DB2", "Connection")) = False Then
			MsgBox("No se ha podido conectar a DB2, vuelva a lanzar la pasarela", MsgBoxStyle.Critical)
			End
		End If
		
		'Inicio Jonathan Prieto 28/06/2013
		'Comprobamos cuál es la última versión administrativa existente
		strSQL = "SELECT MAX(VERSIONP) AS VERSION FROM %owner%TBPFIN02 WHERE CODPROCE = " & intCodProce
		rstInf = mfRecordset(conDB2, strSQL, "DB2")
		msProceso(2, 5, 1, 1)
		If Not rstInf.EOF Then
			SelectedVersion = CInt(Val(rstInf.Fields("VERSION").Value & ""))
			If SelectedVersion = 0 Then
				'No existe ninguna versión administrativa del procedimiento
				SelectedVersion = 1
			Else
				'Comprobar si el usuario quiere una nueva versión o machacar la que ya esta
				If gblnNuevaVersion And CStr(strFecha) <> "" Then
					SelectedVersion = SelectedVersion + 1
				End If
			End If
		End If
		'Fin Jonathan Prieto 28/06/2013
		'UPGRADE_NOTE: Object rstInf may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstInf = Nothing
		
		CierraCN(conDB2)
		strSQL = "SELECT ELTA_DESC40 FROM TBDCELTA_PA WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' AND ELTA_CODTAB = 'P3' AND ELTA_IDIOMA = 'C'"
		rstInf = mfRecordset(conPasarela, strSQL)
		msProceso(3, 5, 1, 1)
		If Not rstInf.EOF Then
			strCom = Trim(rstInf.Fields("ELTA_DESC40").Value & "")
		End If
		rstInf.Close()
		
		strSQL = "UPDATE TBPFIN03_PA SET VERSIONP = " & SelectedVersion
		mfExecute(conPasarela, strSQL)
		strSQL = "UPDATE TBPFIN04_PA SET VERSIONP = " & SelectedVersion
		mfExecute(conPasarela, strSQL)
		strSQL = "UPDATE PARAM_ACC SET VALOR = " & SelectedVersion & " WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' AND PARAMETRO = '@VERSIONP'"
		'mfExecute conPasarela, strSQL
		strSQL = "UPDATE PARAM_ACC SET VALOR='" & gNomProcCorto & "' WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' AND PARAMETRO = '@FLUJO'"
		mfExecute(conPasarela, strSQL)
		strSQL = "SELECT CONEXION, BASEDATOS FROM PROCESOS_PENDIENTES WHERE NOMBRE_CM LIKE '" & gNomProcCorto & "%'"
		rstAux = mfRecordset(conPasarela, strSQL)
		'strProj = Mid(CStr(rstAUX("CONEXION")), InStr(1, CStr(rstAUX("CONEXION")), "Initial Catalog=") + 16, 6)
		strProj = rstAux.Fields("BASEDATOS").Value
		strSQL = "UPDATE PARAM_ACC SET VALOR = '" & strProj & "' WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' AND PARAMETRO = '@PROJECT'"
		mfExecute(conPasarela, strSQL)
		
		strSQL = "INSERT INTO WFFLOWS (FLOW, VERSION, ACTIVE, FLOWNAME, COMMENTS, RUNNING, START, STOPOLDERVERSIONS) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", '1', '" & gNomProcCorto & "', '" & strCom & "', '1', '" & VB6.Format(strFecha, "yyyymmdd") & "', '0')"
		mfExecute(conPasarela, strSQL)
		msProceso(4, 5, 1, 1)
		
		'''''''''''''''''''''''''''''''
		''insertamos en WFFLOWACTIONS''
		'''''''''''''''''''''''''''''''
		lngFlowOrder = 0
		lngID = 0
		'Inicio Jonathan Prieto 31/03/2011: Versión de Pasarela, la inserto en los comentarios del "INICIO"
		strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE, COMMENTS) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'BEGIN', 'INICIO', 'STATE', 'INICIO', 'Pasarela v" & My.Application.Info.Version.Major & "." & My.Application.Info.Version.Minor & "." & My.Application.Info.Version.Revision & "')"
		'Fin Jonathan Prieto 31/03/2011
		mfExecute(conPasarela, strSQL)
		msProceso(5, 5, 1, 1)
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'aketza errores
		Insertar_Error(Me, "Crear Flujo", "Error al crear el flujo", "msCrearFlujo")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msCreaFlujo - " & Err.Description)
		tramiteAnterior = ""
		Me.Close()
		Resume procFin
procFin: 
		
	End Sub
	
	'  /******************************************************************\
	'  **   Método para Optimizar el Flujos
	'  \******************************************************************/
	Private Sub msOptimizarFlujo()
		'Invocamos al método que elimina los EDP y PRO de las acciones y cambia el PATHRETORNO
		msEliminarEDPyPRO()
		'Invocamos al método que sustituye la TDA (acción) por el IF (instrucción de motor)
		msRemplazarTDA_por_IF()
	End Sub
	
	'  /******************************************************************\
	'  **   Método para eliminar los JUMP a la Instrucción Siguiente en Secuencia
	'  \******************************************************************/
	Private Sub msEliminarJUMP_SiguienteInstruccion()
		Dim strError As String
		Dim strSQL As String
		Dim rstJumps As ADODB.Recordset
		
		On Error GoTo procErr
		
		System.Windows.Forms.Application.DoEvents()
		'lblMensaje = "Insertando Flujo en PASARELA"
		
		'Obtenemos los JUMP del Procedimiento cuyo PATH de salto coincida con la siguiente instrucción secuencial
		strSQL = "SELECT JUMPS.FLOWORDER AS FLOWORDER, " & "JUMPS.PATH AS PATH_JUMP, " & "JUMPS.VALUE AS SALTO " & "FROM WFFLOWACTIONS JUMPS " & "JOIN WFFLOWACTIONS SIG_INS ON (SIG_INS.FLOW = JUMPS.FLOW AND " & "SIG_INS.VERSION = JUMPS.VERSION AND " & "SIG_INS.FLOWORDER = (SELECT MIN(SIG_FLOWORDER.FLOWORDER) " & "FROM WFFLOWACTIONS SIG_FLOWORDER " & "WHERE SIG_FLOWORDER.FLOW = JUMPS.FLOW " & "AND SIG_FLOWORDER.VERSION = JUMPS.VERSION " & "AND SIG_FLOWORDER.FLOWORDER > JUMPS.FLOWORDER) AND " & "SIG_INS.ID = 0 AND " & "SIG_INS.PATH = JUMPS.VALUE) " & "WHERE JUMPS.FLOW = '" & gNomProcCorto & "' " & "AND JUMPS.VERSION = " & VersionHidra & " " & "AND JUMPS.ACTION = 'JUMP'"
		rstJumps = mfRecordset(conCarga, strSQL)
		If blnErrRecordset = True Then
			strError = "No se han podido obtener los FLOWORDER de los JUMP's"
			GoTo procErr
		End If
		If Not rstJumps.EOF Then
			'Nos recorremos los JUMP
			While Not rstJumps.EOF
				'Eliminamos el JUMP
				strSQL = "DELETE FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & Trim(rstJumps.Fields("FLOWORDER").Value)
				mfExecute(conCarga, strSQL)
				
				'Actualizamos todas las referencias al JUMP eliminado
				strSQL = "UPDATE WFFLOWACTIONS " & "SET VALUE = '" & Trim(rstJumps.Fields("SALTO").Value) & "' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND VALUE = '" & Trim(rstJumps.Fields("PATH_JUMP").Value) & "'"
				mfExecute(conCarga, strSQL)
				
				'Avanzamos al siguiente JUMP
				rstJumps.MoveNext()
			End While
		End If
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		If strError = vbNullString Then
			strError = Err.Description
		End If
		Insertar_Error(Me, "Eliminar JUMP a Instrucción Siguiente en Secuencia", strError, "msEliminarJUMP_SiguienteInstruccion")
		logError("msEliminarJUMP_SiguienteInstruccion - " & strError)
		tramiteAnterior = ""
		Me.Close()
		Resume procFin
		
procFin: 
		'UPGRADE_NOTE: Object rstJumps may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstJumps = Nothing
	End Sub
	
	'  /******************************************************************\
	'  **   Método para sustituir las acciones TDA por la instrucción IF de Motor
	'  \******************************************************************/
	Private Sub msRemplazarTDA_por_IF()
		Dim strSQL As String
		Dim rstTDAs As ADODB.Recordset
		'Datos para Identificar la Acción
		Dim intOrden_N1 As Short
		Dim intOrden_N2 As Short
		Dim intOrden_N3 As Short
		Dim intOrden_N4 As Short
		Dim intOrden_N5 As Short
		Dim intOrden_Accion As Short
		Dim strPathHidra As String
		'Datos para el IF
		Dim strOperando1 As String
		Dim strOperando2 As String
		Dim strOperador As String
		Dim strSaltoTrue As String
		Dim strSaltoFalse As String
		
		On Error GoTo procErr
		
		System.Windows.Forms.Application.DoEvents()
		
		'Obtenemos las TDA's del Flujo junto con los Parámetros importantes (Operando1, Operando2, Operador, SaltoTrue y SaltoFalse)
		strSQL = "SELECT TDA.PROCEDIMIENTO AS PROCEDIMIENTO, " & "TDA.ORDEN_N1 AS ORDEN_N1, " & "TDA.ORDEN_N2 AS ORDEN_N2, " & "TDA.ORDEN_N3 AS ORDEN_N3, " & "TDA.ORDEN_N4 AS ORDEN_N4, " & "TDA.ORDEN_N5 AS ORDEN_N5, " & "TDA.ORDEN_ACC AS ORDEN_ACCION, " & "TDA.PATH_HIDRA AS PATH, " & "OPERANDO1.VALOR AS OPERANDO1, " & "OPERANDO2.VALOR AS OPERANDO2, " & "OPERADOR.VALOR AS OPERADOR, " & "SALTOTRUE.VALOR AS SALTO_TRUE, " & "SALTOFALSE.VALOR AS SALTO_FALSE " & "FROM PASARELA..ACCIONES_DI TDA " & "LEFT JOIN PASARELA..PARAM_ACC OPERANDO1 ON (OPERANDO1.PROCEDIMIENTO = TDA.PROCEDIMIENTO AND OPERANDO1.ORDEN_N1 = TDA.ORDEN_N1 AND OPERANDO1.ORDEN_N2 = TDA.ORDEN_N2 AND OPERANDO1.ORDEN_N3 = TDA.ORDEN_N3 AND OPERANDO1.ORDEN_N4 = TDA.ORDEN_N4 AND OPERANDO1.ORDEN_N5 = TDA.ORDEN_N5 AND OPERANDO1.ORDEN_ACC = TDA.ORDEN_ACC AND OPERANDO1.PARAMETRO = '@OPERANDO1') " & "LEFT JOIN PASARELA..PARAM_ACC OPERANDO2 ON (OPERANDO2.PROCEDIMIENTO = TDA.PROCEDIMIENTO AND OPERANDO2.ORDEN_N1 = TDA.ORDEN_N1 AND OPERANDO2.ORDEN_N2 = TDA.ORDEN_N2 AND OPERANDO2.ORDEN_N3 = TDA.ORDEN_N3 AND OPERANDO2.ORDEN_N4 = TDA.ORDEN_N4 AND OPERANDO2.ORDEN_N5 = TDA.ORDEN_N5 AND OPERANDO2.ORDEN_ACC = TDA.ORDEN_ACC AND OPERANDO2.PARAMETRO = '@OPERANDO2') " & "LEFT JOIN PASARELA..PARAM_ACC OPERADOR ON (OPERADOR.PROCEDIMIENTO = TDA.PROCEDIMIENTO AND OPERADOR.ORDEN_N1 = TDA.ORDEN_N1 AND OPERADOR.ORDEN_N2 = TDA.ORDEN_N2 AND OPERADOR.ORDEN_N3 = TDA.ORDEN_N3 AND OPERADOR.ORDEN_N4 = TDA.ORDEN_N4 AND OPERADOR.ORDEN_N5 = TDA.ORDEN_N5 AND OPERADOR.ORDEN_ACC = TDA.ORDEN_ACC AND OPERADOR.PARAMETRO = '@OPERADOR') " & "LEFT JOIN PASARELA..PARAM_ACC SALTOTRUE ON (SALTOTRUE.PROCEDIMIENTO = TDA.PROCEDIMIENTO AND SALTOTRUE.ORDEN_N1 = TDA.ORDEN_N1 AND SALTOTRUE.ORDEN_N2 = TDA.ORDEN_N2 AND SALTOTRUE.ORDEN_N3 = TDA.ORDEN_N3 AND SALTOTRUE.ORDEN_N4 = TDA.ORDEN_N4 AND SALTOTRUE.ORDEN_N5 = TDA.ORDEN_N5 AND SALTOTRUE.ORDEN_ACC = TDA.ORDEN_ACC AND SALTOTRUE.PARAMETRO = '@SALTOTRUE') " & "LEFT JOIN PASARELA..PARAM_ACC SALTOFALSE ON (SALTOFALSE.PROCEDIMIENTO = TDA.PROCEDIMIENTO AND SALTOFALSE.ORDEN_N1 = TDA.ORDEN_N1 AND SALTOFALSE.ORDEN_N2 = TDA.ORDEN_N2 AND SALTOFALSE.ORDEN_N3 = TDA.ORDEN_N3 AND SALTOFALSE.ORDEN_N4 = TDA.ORDEN_N4 AND SALTOFALSE.ORDEN_N5 = TDA.ORDEN_N5 AND SALTOFALSE.ORDEN_ACC = TDA.ORDEN_ACC AND SALTOFALSE.PARAMETRO = '@SALTOFALSE') " & "WHERE TDA.PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND TDA.NOM_ACCION = 'TDAUTOMATICA'" & "ORDER BY TDA.ORDEN_N1, TDA.ORDEN_N2, TDA.ORDEN_N3, TDA.ORDEN_N4, TDA.ORDEN_N5, TDA.ORDEN_ACC"
		rstTDAs = mfRecordset(conPasarela, strSQL)
		While Not rstTDAs.EOF
			intOrden_N1 = CShort(rstTDAs.Fields("ORDEN_N1").Value)
			intOrden_N2 = CShort(rstTDAs.Fields("ORDEN_N2").Value)
			intOrden_N3 = CShort(rstTDAs.Fields("ORDEN_N3").Value)
			intOrden_N4 = CShort(rstTDAs.Fields("ORDEN_N4").Value)
			intOrden_N5 = CShort(rstTDAs.Fields("ORDEN_N5").Value)
			intOrden_Accion = CShort(rstTDAs.Fields("ORDEN_ACCION").Value)
			strPathHidra = CStr(rstTDAs.Fields("PATH").Value)
			strOperando1 = CStr(rstTDAs.Fields("OPERANDO1").Value)
			strOperando2 = CStr(rstTDAs.Fields("OPERANDO2").Value)
			strOperador = CStr(rstTDAs.Fields("OPERADOR").Value)
			strSaltoTrue = CStr(rstTDAs.Fields("SALTO_TRUE").Value)
			strSaltoFalse = CStr(rstTDAs.Fields("SALTO_FALSE").Value)
			
			'Eliminamos todos los Parámetros de la TDA
			strSQL = "DELETE FROM PASARELA..PARAM_ACC " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & intOrden_N1 & " " & "AND ORDEN_N2 = " & intOrden_N2 & " " & "AND ORDEN_N3 = " & intOrden_N3 & " " & "AND ORDEN_N4 = " & intOrden_N4 & " " & "AND ORDEN_N5 = " & intOrden_N5 & " " & "AND ORDEN_ACC = " & intOrden_Accion
			mfExecute(conPasarela, strSQL)
			
			'Actualizamos la Acción para convertirla en IF
			strSQL = "UPDATE PASARELA..ACCIONES_DI " & "SET ID_ACCION = 0, " & "NOM_ACCION = 'IF', " & "TIPO_ACCION = '' " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & intOrden_N1 & " " & "AND ORDEN_N2 = " & intOrden_N2 & " " & "AND ORDEN_N3 = " & intOrden_N3 & " " & "AND ORDEN_N4 = " & intOrden_N4 & " " & "AND ORDEN_N5 = " & intOrden_N5 & " " & "AND ORDEN_ACC = " & intOrden_Accion
			mfExecute(conPasarela, strSQL)
			
			'Insertamos los Parámetros de la Acción IF
			'Parámetro VAR1
			strSQL = "INSERT INTO PASARELA..PARAM_ACC (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, ORDEN_AC_SUB, ID_ACCION, PARAMETRO, VALOR, ORDEN_PA) VALUES " & "('" & gNomProcCorto & "', " & intOrden_N1 & ", " & intOrden_N2 & ", " & intOrden_N3 & ", " & intOrden_N4 & ", " & intOrden_N5 & ", " & intOrden_Accion & ", NULL, 0, " & "'VAR1', '" & strOperando1 & "', 1)"
			mfExecute(conPasarela, strSQL)
			'Parámetro VAR2
			strSQL = "INSERT INTO PASARELA..PARAM_ACC (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, ORDEN_AC_SUB, ID_ACCION, PARAMETRO, VALOR, ORDEN_PA) VALUES " & "('" & gNomProcCorto & "', " & intOrden_N1 & ", " & intOrden_N2 & ", " & intOrden_N3 & ", " & intOrden_N4 & ", " & intOrden_N5 & ", " & intOrden_Accion & ", NULL, 0, " & "'VAR2', '" & strOperando2 & "', 2)"
			mfExecute(conPasarela, strSQL)
			'Parámetro CONDITION
			strSQL = "INSERT INTO PASARELA..PARAM_ACC (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, ORDEN_AC_SUB, ID_ACCION, PARAMETRO, VALOR, ORDEN_PA) VALUES " & "('" & gNomProcCorto & "', " & intOrden_N1 & ", " & intOrden_N2 & ", " & intOrden_N3 & ", " & intOrden_N4 & ", " & intOrden_N5 & ", " & intOrden_Accion & ", NULL, 0, " & "'CONDITION', '" & strOperador & "', 3)"
			mfExecute(conPasarela, strSQL)
			'Parámetro PATH
			strSQL = "INSERT INTO PASARELA..PARAM_ACC (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, ORDEN_AC_SUB, ID_ACCION, PARAMETRO, VALOR, ORDEN_PA) VALUES " & "('" & gNomProcCorto & "', " & intOrden_N1 & ", " & intOrden_N2 & ", " & intOrden_N3 & ", " & intOrden_N4 & ", " & intOrden_N5 & ", " & intOrden_Accion & ", NULL, 0, " & "'PATH', '" & strSaltoTrue & "', 4)"
			mfExecute(conPasarela, strSQL)
			'Parámetro ELSEPATH
			strSQL = "INSERT INTO PASARELA..PARAM_ACC (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, ORDEN_AC_SUB, ID_ACCION, PARAMETRO, VALOR, ORDEN_PA) VALUES " & "('" & gNomProcCorto & "', " & intOrden_N1 & ", " & intOrden_N2 & ", " & intOrden_N3 & ", " & intOrden_N4 & ", " & intOrden_N5 & ", " & intOrden_Accion & ", NULL, 0, " & "'ELSEPATH', '" & strSaltoFalse & "', 5)"
			mfExecute(conPasarela, strSQL)
			'Parámetro TYPE
			strSQL = "INSERT INTO PASARELA..PARAM_ACC (PROCEDIMIENTO, ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC, ORDEN_AC_SUB, ID_ACCION, PARAMETRO, VALOR, ORDEN_PA) VALUES " & "('" & gNomProcCorto & "', " & intOrden_N1 & ", " & intOrden_N2 & ", " & intOrden_N3 & ", " & intOrden_N4 & ", " & intOrden_N5 & ", " & intOrden_Accion & ", NULL, 0, " & "'TYPE', '', 6)"
			mfExecute(conPasarela, strSQL)
			
			'Avanzamos a la siguiente TDA
			rstTDAs.MoveNext()
		End While
		If Not rstTDAs Is Nothing Then
			If rstTDAs.State <> 0 Then
				rstTDAs.Close()
			End If
		End If
		'UPGRADE_NOTE: Object rstTDAs may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTDAs = Nothing
		GoTo procFin
		
procErr: 
		Insertar_Error(Me, "Remplazar TDA por IF", "Error al Remplazar las TDA's por IF", "msRemplazarTDA_por_IF")
		Mostrar_Error()
		logError("msRemplazarTDA_por_IF - " & Err.Description)
		tramiteAnterior = ""
		Me.Close()
		Resume procFin
		
procFin: 
		
	End Sub
	
	'  /******************************************************************\
	'  **   Método para eliminar los pasos EDP y PRO, cambiar los retornos de las acciones
	'  \******************************************************************/
	Private Sub msEliminarEDPyPRO()
		Dim strSQL As String
		Dim strSQLDelete As String
		Dim strSQLUpdate As String
		Dim rstInf As ADODB.Recordset
		Dim intCodProce As Short
		Dim rstAux As ADODB.Recordset
		
		Dim strProcedimiento As String
		Dim intOrden_N1 As Short
		Dim intOrden_N2 As Short
		Dim intOrden_N3 As Short
		Dim intOrden_N4 As Short
		Dim intOrden_N5 As Short
		Dim intOrden_Accion As Short
		Dim strPathRetorno As String
		Dim strNombre_Accion As String
		Dim strPath As String
		Dim strPathAnterior As String
		Dim strPathAnterior2 As String
		Dim strPathSiguiente As String
		Dim strPathRetorno_Orig As String
		Dim strPathRetorno_Fin As String
		Dim I As Short
		
		On Error GoTo procErr
		
		System.Windows.Forms.Application.DoEvents()
		'lblMensaje = "Insertando Flujo en PASARELA"
		
		strSQL = "SELECT ACCIONES.PROCEDIMIENTO AS PROCEDIMIENTO,  ACCIONES.ORDEN_N1 AS ORDEN_N1, ACCIONES.ORDEN_N2 AS ORDEN_N2, ACCIONES.ORDEN_N3 AS ORDEN_N3, ACCIONES.ORDEN_N4 AS ORDEN_N4, ACCIONES.ORDEN_N5 AS ORDEN_N5, ACCIONES.ORDEN_ACC AS ORDEN_ACCION, ACCIONES.NOM_ACCION AS NOMBRE_ACCION, ACCIONES.PATH_HIDRA AS PATH, PARAM_PATHRETORNO.ORDEN_PA AS ID_PATHRETORNO, PARAM_PATHRETORNO.VALOR AS PATH_RETORNO_ORIGINAL, SIGUIENTE_ACCION.PATH_HIDRA AS PATH_RETORNO_FINAL " & "FROM PASARELA..ACCIONES_DI ACCIONES " & "LEFT JOIN PASARELA..PARAM_ACC PARAM_PATHRETORNO ON (PARAM_PATHRETORNO.PROCEDIMIENTO = ACCIONES.PROCEDIMIENTO AND PARAM_PATHRETORNO.ORDEN_N1 = ACCIONES.ORDEN_N1 AND  PARAM_PATHRETORNO.ORDEN_N2 = ACCIONES.ORDEN_N2 AND  PARAM_PATHRETORNO.ORDEN_N3 = ACCIONES.ORDEN_N3 AND  PARAM_PATHRETORNO.ORDEN_N4 = ACCIONES.ORDEN_N4 AND  PARAM_PATHRETORNO.ORDEN_N5 = ACCIONES.ORDEN_N5 AND  PARAM_PATHRETORNO.ORDEN_ACC = ACCIONES.ORDEN_ACC AND  PARAM_PATHRETORNO.PARAMETRO = '@PATHRETORNO') " & "LEFT JOIN PASARELA..ACCIONES_DI PATHRETORNO ON (PATHRETORNO.PROCEDIMIENTO = ACCIONES.PROCEDIMIENTO AND PATHRETORNO.ORDEN_N1 = ACCIONES.ORDEN_N1 AND PATHRETORNO.ORDEN_N2 = ACCIONES.ORDEN_N2 AND PATHRETORNO.ORDEN_N3 = ACCIONES.ORDEN_N3 AND PATHRETORNO.ORDEN_N4 = ACCIONES.ORDEN_N4 AND PATHRETORNO.ORDEN_N5 = ACCIONES.ORDEN_N5 AND PATHRETORNO.PATH_HIDRA = PARAM_PATHRETORNO.VALOR) " & "LEFT JOIN PASARELA..ACCIONES_DI SIGUIENTE_ACCION ON (SIGUIENTE_ACCION.PROCEDIMIENTO = PATHRETORNO.PROCEDIMIENTO AND " & "SIGUIENTE_ACCION.ORDEN_N1 = PATHRETORNO.ORDEN_N1 AND " & "SIGUIENTE_ACCION.ORDEN_N2 = PATHRETORNO.ORDEN_N2 AND " & "SIGUIENTE_ACCION.ORDEN_N3 = PATHRETORNO.ORDEN_N3 AND " & "SIGUIENTE_ACCION.ORDEN_N4 = PATHRETORNO.ORDEN_N4 AND " & "SIGUIENTE_ACCION.ORDEN_N5 = PATHRETORNO.ORDEN_N5 AND " & "SIGUIENTE_ACCION.ORDEN_ACC = (SELECT MIN(SIG.ORDEN_ACC) " & "FROM PASARELA..ACCIONES_DI SIG " & "WHERE SIG.PROCEDIMIENTO = SIGUIENTE_ACCION.PROCEDIMIENTO " & "AND SIG.ORDEN_N1 = PATHRETORNO.ORDEN_N1 " & "AND SIG.ORDEN_N2 = PATHRETORNO.ORDEN_N2 " & "AND SIG.ORDEN_N3 = PATHRETORNO.ORDEN_N3 " & "AND SIG.ORDEN_N4 = PATHRETORNO.ORDEN_N4 " & "AND SIG.ORDEN_N5 = PATHRETORNO.ORDEN_N5 " & "AND SIG.ORDEN_ACC > PATHRETORNO.ORDEN_ACC)" & ") " & "WHERE ACCIONES.PROCEDIMIENTO = '" & gNomProcCorto & "' " & "ORDER BY ACCIONES.ORDEN_N1, ACCIONES.ORDEN_N2, ACCIONES.ORDEN_N3, ACCIONES.ORDEN_N4, ACCIONES.ORDEN_N5, ACCIONES.ORDEN_ACC"
		rstInf = mfRecordset(conPasarela, strSQL)
		strPathAnterior = ""
		strPathAnterior2 = ""
		strPathSiguiente = ""
		I = 1
		While Not rstInf.EOF
			strProcedimiento = "" & rstInf.Fields("PROCEDIMIENTO").Value
			intOrden_N1 = rstInf.Fields("ORDEN_N1").Value
			intOrden_N2 = rstInf.Fields("ORDEN_N2").Value
			intOrden_N3 = rstInf.Fields("ORDEN_N3").Value
			intOrden_N4 = rstInf.Fields("ORDEN_N4").Value
			intOrden_N5 = rstInf.Fields("ORDEN_N5").Value
			intOrden_Accion = rstInf.Fields("ORDEN_ACCION").Value
			strPathRetorno = "" & rstInf.Fields("ID_PATHRETORNO").Value
			strNombre_Accion = "" & rstInf.Fields("NOMBRE_ACCION").Value
			strPath = "" & rstInf.Fields("PATH").Value
			strPathRetorno_Orig = "" & rstInf.Fields("PATH_RETORNO_ORIGINAL").Value
			strPathRetorno_Fin = "" & rstInf.Fields("PATH_RETORNO_FINAL").Value
			
			If rstInf.Fields("PATH").Value <> "EDP_ENDEXPEDIENTE" Then
				rstInf.MoveNext()
				strPathSiguiente = rstInf.Fields("PATH").Value
				rstInf.MovePrevious()
				
				If strNombre_Accion = "ENDPROC" And Mid(strPath, 1, 4) = "EDP_" Then
					If (Mid(strPathAnterior, 1, 4) = "APE_" And Mid(strPathAnterior, 5) = Mid(strPath, 5)) And (Mid(strPathSiguiente, 1, 4) = "PRO_" And Mid(strPathSiguiente, 5) = Mid(strPath, 5)) Then
						strSQLDelete = "DELETE FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & intOrden_N1 & " " & "AND ORDEN_N2 = " & intOrden_N2 & " " & "AND ORDEN_N3 = " & intOrden_N3 & " " & "AND ORDEN_N4 = " & intOrden_N4 & " " & "AND ORDEN_N5 = " & intOrden_N5 & " " & "AND ORDEN_ACC = " & intOrden_Accion
						mfExecute(conPasarela, strSQLDelete)
					End If
				End If
				
				If strNombre_Accion = "PROCESS" And Mid(strPath, 1, 4) = "PRO_" Then
					If (Mid(strPathAnterior, 1, 4) = "EDP_" And Mid(strPathAnterior, 5) = Mid(strPath, 5)) And (Mid(strPathAnterior2, 1, 4) = "APE_" And Mid(strPathAnterior2, 5) = Mid(strPath, 5)) Then
						strSQLDelete = "DELETE FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & intOrden_N1 & " " & "AND ORDEN_N2 = " & intOrden_N2 & " " & "AND ORDEN_N3 = " & intOrden_N3 & " " & "AND ORDEN_N4 = " & intOrden_N4 & " " & "AND ORDEN_N5 = " & intOrden_N5 & " " & "AND ORDEN_ACC = " & intOrden_Accion
						mfExecute(conPasarela, strSQLDelete)
					End If
				End If
				
				If strNombre_Accion <> "PROCESS" And strNombre_Accion <> "ENDPROC" And strPathRetorno_Orig <> "" Then
					If strNombre_Accion = "TDAUTOMATICA" Or strNombre_Accion = "TDUSUARIO" Then
						strSQLUpdate = "UPDATE PARAM_ACC " & "SET VALOR = '' " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & intOrden_N1 & " " & "AND ORDEN_N2 = " & intOrden_N2 & " " & "AND ORDEN_N3 = " & intOrden_N3 & " " & "AND ORDEN_N4 = " & intOrden_N4 & " " & "AND ORDEN_N5 = " & intOrden_N5 & " " & "AND ORDEN_ACC = " & intOrden_Accion & " " & "AND PARAMETRO = '@PATHRETORNO'"
						mfExecute(conPasarela, strSQLUpdate)
					Else
						strSQLUpdate = "UPDATE PARAM_ACC " & "SET VALOR = '" & strPathRetorno_Fin & "' " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & intOrden_N1 & " " & "AND ORDEN_N2 = " & intOrden_N2 & " " & "AND ORDEN_N3 = " & intOrden_N3 & " " & "AND ORDEN_N4 = " & intOrden_N4 & " " & "AND ORDEN_N5 = " & intOrden_N5 & " " & "AND ORDEN_ACC = " & intOrden_Accion & " " & "AND PARAMETRO = '@PATHRETORNO'"
						mfExecute(conPasarela, strSQLUpdate)
					End If
				End If
				strPathAnterior = rstInf.Fields("PATH").Value
				If I > 1 Then
					rstInf.MovePrevious()
					strPathAnterior2 = rstInf.Fields("PATH").Value
					rstInf.MoveNext()
				End If
				rstInf.MoveNext()
				I = I + 1
			Else
				GoTo procFin
			End If
		End While
		GoTo procFin
		
procErr: 
		Insertar_Error(Me, "Eliminar EDP y PRO", "Error al Eliminar los EDP y PROD", "msEliminarEDPyPRO")
		Mostrar_Error()
		logError("msEliminarEDPyPRO - " & Err.Description)
		tramiteAnterior = ""
		Me.Close()
		Resume procFin
		
procFin: 
		
	End Sub
	
	'  /******************************************************************\
	'  **   Método para crear los trámites y acciones de cada trámite
	'  \******************************************************************/
	Private Sub msCrearTramites()
		Dim strSQL As String
		Dim rstInf As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstCat As ADODB.Recordset
		
		Dim strNomD As String
		Dim strAux As String
		Dim strValue As String
		Dim strPath As String
		Dim strNum As String
		Dim strOrd As String
		
		Dim cont As Short
		Dim arrDi As Object
		Dim arrAc As Object
		Dim I As Object
		Dim j As Integer
		
		Dim strAction As String
		Dim strName As String
		Dim strParam As String
		Dim strValor As String
		Dim strFecha As String
		Dim strAlertPath As String
		Dim strPar As String
		Dim strBDDEspecificas As String
		Dim strBDDGenerales As String
		Dim strBDDWord As String
		Dim strBDDDOCU As String
		Dim strBDDGestion As String
		Dim strBDDArranque As String
		Dim strBDDMensaje As String
		Dim strBDDInfra As String
		Dim CodFlowOrder As Integer
		
		Dim CodAplicacion As String
		
		On Error GoTo procErr
		
		'Obtenemos las Bases de Datos de las Acciones
		strBDDEspecificas = LeeTablaINI("ESPECIFICAS", strTipoFamilia)
		strBDDGenerales = LeeTablaINI("GENERALES", strTipoFamilia)
		strBDDWord = LeeTablaINI("WORD", strTipoFamilia)
		strBDDDOCU = LeeTablaINI("DOCU", strTipoFamilia)
		strBDDGestion = LeeTablaINI("GESTION", strTipoFamilia)
		strBDDArranque = LeeTablaINI("ARRANQUE", strTipoFamilia)
		strBDDMensaje = LeeTablaINI("MENSAJE", strTipoFamilia)
		'Obtenemos el Código de la Aplicación
		CodAplicacion = LeeTablaINI("CodAplicacion", strTipoFamilia)
		
		strBDDInfra = "CWPF00"
		
		'Obtenemos los Trámites
		strSQL = "SELECT * " & "FROM DIAGRAMA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND EXPLOTA_ACC = 'S' " & "ORDER BY ORDEN_N1, " & "ORDEN_N2, " & "ORDEN_N3, " & "ORDEN_N4, " & "ORDEN_N5"
		rstInf = mfRecordset(conPasarela, strSQL)
		If Not rstInf.EOF Then
			'UPGRADE_WARNING: Couldn't resolve default property of object rstInf.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arrDi. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrDi = rstInf.GetRows
			rstInf.MoveFirst()
		End If
		'UPGRADE_WARNING: Couldn't resolve default property of object I. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		I = 1
		'Recorremos los Trámites
		While Not rstInf.EOF
			strSeg = rstInf.Fields("ORDEN_N1").Value & "/" & rstInf.Fields("ORDEN_N2").Value & "/" & rstInf.Fields("ORDEN_N3").Value & "/" & rstInf.Fields("ORDEN_N4").Value & "/" & rstInf.Fields("ORDEN_N5").Value
			
			'PRIMER REGISTRO
			If rstInf.Fields("ORDEN_N1").Value = 3 Then
				System.Windows.Forms.Application.DoEvents()
			End If
			'UPGRADE_WARNING: Couldn't resolve default property of object I. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			msProceso(I, UBound(arrDi, 2) + 1, 1, 1)
			'Obtenemos el Nombre del Trámite
			strSQL = "SELECT NOM_DIAGRAMA " & "FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstInf.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstInf.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstInf.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstInf.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstInf.Fields("ORDEN_N5").Value & " " & "AND ID_DIAGRAMA = " & rstInf.Fields("ID_DIAGRAMA").Value
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strNomD = Trim(rstAux.Fields("NOM_DIAGRAMA").Value)
			End If
			strAux = ""
			'Obtenemos el FLOWORDER
			strSQL = "SELECT MAX(FLOWORDER) AS CUENTA " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngFlowOrder = Val(rstAux.Fields("CUENTA").Value) + 100
			lngID = 0
			strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'LABEL', '" & strNomD & "', 'STATE', '" & strNomD & "')"
			mfExecute(conPasarela, strSQL)
			'SEGUNDO REGISTRO
			lngID = lngID + 1
			strValue = "0"
			strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'SUBMIT', '" & strValue & "')"
			mfExecute(conPasarela, strSQL)
			'TERCER REGISTRO
			lngID = lngID + 1
			strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '1')"
			mfExecute(conPasarela, strSQL)
			
			If (strValue = "1") Then
				'PRIMER REGISTRO
				lngFlowOrder = lngFlowOrder + 100
				lngID = 0
				strPath = Trim(Replace(strNomD, "PR_", ""))
				strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'LABEL', '" & strPath & "', 'STATE', 'INICIO')"
				mfExecute(conPasarela, strSQL)
				'SEGUNDO REGISTRO
				lngID = lngID + 1
				strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'SUBMIT', '0')"
				mfExecute(conPasarela, strSQL)
				'TERCER REGISTRO
				lngID = lngID + 1
				strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '2')"
				mfExecute(conPasarela, strSQL)
			End If
			
			'Obtenemos las Acciones del Trámite
			strSQL = "SELECT * " & "FROM ACCIONES_DI A " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND A.ORDEN_N1 = " & rstInf.Fields("ORDEN_N1").Value & " " & "AND A.ORDEN_N2 = " & rstInf.Fields("ORDEN_N2").Value & " " & "AND A.ORDEN_N3 = " & rstInf.Fields("ORDEN_N3").Value & " " & "AND A.ORDEN_N4 = " & rstInf.Fields("ORDEN_N4").Value & " " & "AND A.ORDEN_N5 = " & rstInf.Fields("ORDEN_N5").Value & " " & "ORDER BY ORDEN_ACC"
			rstAcc = mfRecordset(conPasarela, strSQL)
			If Not rstAcc.EOF Then
				'UPGRADE_WARNING: Couldn't resolve default property of object rstAcc.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrAc. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				arrAc = rstAcc.GetRows
				rstAcc.MoveFirst()
			End If
			j = 1
			While Not rstAcc.EOF
				Select Case UCase(rstAcc.Fields("NOM_ACCION").Value)
					Case UCase("CANCEL")
						'Obtener los parámetros de la acción CANCEL
						strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "ORDER BY ORDEN_PA"
						rstAux = mfRecordset(conPasarela, strSQL)
						If Not rstAux.EOF Then
							rstAux.MoveFirst()
							strPath = rstAux.Fields("VALOR").Value
						End If
						strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
						'Primer Registro
						lngFlowOrder = lngFlowOrder + 100
						lngID = 0
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'CANCEL', '" & strName & "', 'PATH', '" & strPath & "')"
						mfExecute(conPasarela, strSQL)
						'Segundo Registro
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'ALL', '0')"
						mfExecute(conPasarela, strSQL)
						'Tercer Registro
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '2')"
						mfExecute(conPasarela, strSQL)
						
					Case UCase("ALERT")
						'Obtener los parámetros de la acción ALERT
						strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "ORDER BY ORDEN_PA"
						rstAux = mfRecordset(conPasarela, strSQL)
						If Not rstAux.EOF Then
							rstAux.MoveFirst()
							While Not rstAux.EOF
								strParam = rstAux.Fields("PARAMETRO").Value
								Select Case Trim(UCase(strParam))
									Case "DATE"
										strFecha = rstAux.Fields("VALOR").Value
									Case "ALERTPATH"
										strAlertPath = rstAux.Fields("VALOR").Value
								End Select
								rstAux.MoveNext()
							End While
						End If
						strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
						'Primer Registro
						lngFlowOrder = lngFlowOrder + 100
						lngID = 0
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'ALERT', '" & strName & "', 'DATE', '" & strFecha & "')"
						mfExecute(conPasarela, strSQL)
						'Segundo Registro
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'MATURATION', '1')"
						mfExecute(conPasarela, strSQL)
						'Tercer Registro
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'INTERVAL', 'D')"
						mfExecute(conPasarela, strSQL)
						'Cuarto Registro
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'ALERTPATH', '" & strAlertPath & "')"
						mfExecute(conPasarela, strSQL)
						'Quinto Registro
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'DAYSOFWEEK', 'LMXJVSD')"
						mfExecute(conPasarela, strSQL)
						'Sexto Registro
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '2')"
						mfExecute(conPasarela, strSQL)
						
					Case UCase("IF")
						'Obtener los parámetros de la acción IF
						strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "ORDER BY ORDEN_PA"
						rstAux = mfRecordset(conPasarela, strSQL)
						If Not rstAux.EOF Then
							rstAux.MoveFirst()
							lngFlowOrder = lngFlowOrder + 100
							lngID = 0
							While Not rstAux.EOF
								'El primer registro lleva el Action y el Path
								If lngID = 0 Then
									strAction = "IF"
									strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
								Else
									strAction = vbNullString
									strName = vbNullString
								End If
								strParam = Trim(rstAux.Fields("PARAMETRO").Value)
								strValue = Trim(rstAux.Fields("VALOR").Value)
								'Insertamos el Parámetro
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '" & strAction & "', '" & strName & "', '" & strParam & "', '" & strValue & "')"
								mfExecute(conPasarela, strSQL)
								lngID = lngID + 1
								rstAux.MoveNext()
							End While
							'Parámetro Level
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '" & IIf(rstAcc.Fields("NOMBRE").Value = "ISFLY", "3", "2") & "')"
							mfExecute(conPasarela, strSQL)
						End If
						
					Case UCase("FORMFICTICIO")
						strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
						lngFlowOrder = lngFlowOrder + 100
						lngID = 0
						
						
						
						'Comprobamos si la Categoría del Trámite es "Trámite de Inicio"
						strSQL = "SELECT CAT_DIAGRAMA " & "FROM DIAGRAMA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "'"
						rstCat = mfRecordset(conPasarela, strSQL)
						If rstCat.Fields("CAT_DIAGRAMA").Value = "Trámite de Inicio" Then
							'Trámite de Categoría "Trámite de Inicio"
							If Mid(Trim(rstAcc.Fields("PATH_HIDRA").Value), 1, 3) = "APE" Then
								strName = Trim(Mid(rstAcc.Fields("PATH_HIDRA").Value, 5))
							Else
								strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
							End If
							'Insertamos el Parámetro USUARIO
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'LETVAR', " & "'" & strName & "', " & "'@USUARIO', " & "'@INICIO!CODUSUAR')"
							mfExecute(conPasarela, strSQL)
						Else
							'Trámite Normal
							'Insertamos el Parámetro FORM
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'FORM', " & "'" & strName & "', " & "'FORM', " & "'FORMULARIO FICTICIO')"
							mfExecute(conPasarela, strSQL)
							'Insertamos el Parámetro FILTER
							lngID = lngID + 1
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'FILTER', " & "'')"
							mfExecute(conPasarela, strSQL)
							'Insertamos el Parámetro GROUP
							lngID = lngID + 1
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'GROUP', " & "'')"
							mfExecute(conPasarela, strSQL)
							'Insertamos el Parámetro USER
							lngID = lngID + 1
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'USER', " & "'USUARIOFICTICIO')"
							mfExecute(conPasarela, strSQL)
							'Insertamos el Parámetro WAIT
							lngID = lngID + 1
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'WAIT', " & "'1')"
							mfExecute(conPasarela, strSQL)
							'Insertamos el Parámetro TO
							lngID = lngID + 1
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'TO', " & "'ALL')"
							mfExecute(conPasarela, strSQL)
							'Insertamos el Parámetro ICON
							lngID = lngID + 1
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'ICON', " & "'')"
							mfExecute(conPasarela, strSQL)
							'Insertamos el Parámetro TITTLE
							lngID = lngID + 1
							strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'@TITTLE', " & "'FORMULARIO FICTICIO')"
						End If
						'Insertamos el Parámetro ORDENTRA
						lngID = lngID + 1
						'Obtenemos el Valor del Parámetro ORDENTRA
						strSQL = "SELECT ORDENTRA " & "FROM TBPFIN03_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND NOMBRE = (SELECT NOM_DIAGRAMA " & "FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ORDEN_N1 = " & rstAcc.Fields("ORDEN_N1").Value & " " & "AND ORDEN_N2 = " & rstAcc.Fields("ORDEN_N2").Value & " " & "AND ORDEN_N3 = " & rstAcc.Fields("ORDEN_N3").Value & " " & "AND ORDEN_N4 = " & rstAcc.Fields("ORDEN_N4").Value & " " & "AND ORDEN_N5 = " & rstAcc.Fields("ORDEN_N5").Value & ")"
						rstAux4 = mfRecordset(conPasarela, strSQL)
						If Not rstAux4.EOF Then
							strOrd = rstAux4.Fields(0).Value
						Else
							strOrd = "@INICIO!ORDENTRA"
						End If
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'@ORDENTRA', " & "'" & strOrd & "')"
						mfExecute(conPasarela, strSQL)
						lngID = lngID + 1
						'Insertamos el Parámetro LEVEL
						lngID = lngID + 1
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", " & "'', " & "'', " & "'LEVEL', " & "'2')"
						mfExecute(conPasarela, strSQL)
						
						
						'               If strName = "FORMFICTICIO01" Then
						'                  'Cuando es el primer FormFicticio
						'                  strSQL = "SELECT CAT_DIAGRAMA " & _
						''                           "FROM DIAGRAMA " & _
						''                           "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
						''                             "AND ORDEN_N1 = '" & rstAcc("ORDEN_N1") & "' " & _
						''                             "AND ORDEN_N2 = '" & rstAcc("ORDEN_N2") & "' " & _
						''                             "AND ORDEN_N3 = '" & rstAcc("ORDEN_N3") & "' " & _
						''                             "AND ORDEN_N4 = '" & rstAcc("ORDEN_N4") & "' " & _
						''                             "AND ORDEN_N5 = '" & rstAcc("ORDEN_N5") & "'"
						'                  Set rstCat = mfRecordset(conPasarela, strSQL) 'Primer Registro
						'                  If rstCat("CAT_DIAGRAMA") = "Trámite de Inicio" Then     ' Solo cuando es un tramite de Categoria "Trámite de Inicio"
						'                     If Mid(Trim(rstAcc("PATH_HIDRA")), 1, 3) = "APE" Then
						'                        strName = Trim(Mid(rstAcc("PATH_HIDRA"), 5))
						'                     Else
						'                        strName = Trim(rstAcc("PATH_HIDRA"))
						'                     End If
						'                     strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                              & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'LETVAR', '" & strName & "', '@USUARIO', '@INICIO!CODUSUAR')"
						'                     mfExecute conPasarela, strSQL
						'                     lngID = lngID + 1
						'                     'Insertar Segundo Registro
						'                     strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                              & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '2')"
						'                     mfExecute conPasarela, strSQL
						'                  Else
						'                     GoTo NoInicio
						'                  End If
						'               Else
						'NoInicio:
						'                  'Insertamos Primer Registro
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'FORM', '" & strName & "', 'FORM', 'FORMULARIO FICTICIO')"
						'                  mfExecute conPasarela, strSQL
						'                  'Segundo Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'FILTER', '')"
						'                  mfExecute conPasarela, strSQL
						'                  'Tercer Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'GROUP', '')"
						'                  mfExecute conPasarela, strSQL
						'                  'Cuarto Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'USER', 'USUARIOFICTICIO')"
						'                  mfExecute conPasarela, strSQL
						'                  'Quinto Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'WAIT', '1')"
						'                  mfExecute conPasarela, strSQL
						'                  'Sexto Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'TO', 'ALL')"
						'                  mfExecute conPasarela, strSQL
						'                  'Septimo Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'ICON', '')"
						'                  mfExecute conPasarela, strSQL
						'                  'Octavo Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', '@TITTLE', 'FORMULARIO FICTICIO')"
						'                  mfExecute conPasarela, strSQL
						'                  'Noveno Registro
						'                  strSQL = "SELECT ORDENTRA " & _
						''                           "FROM TBPFIN03_PA " & _
						''                           "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
						''                             "AND NOMBRE = (SELECT NOM_DIAGRAMA " & _
						''                                           "FROM PROPIEDADES_DI " & _
						''                                           "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
						''                                             "AND PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
						''                                             "AND ORDEN_N1 = " & rstAcc("ORDEN_N1") & " " & _
						''                                             "AND ORDEN_N2 = " & rstAcc("ORDEN_N2") & " " & _
						''                                             "AND ORDEN_N3 = " & rstAcc("ORDEN_N3") & " " & _
						''                                             "AND ORDEN_N4 = " & rstAcc("ORDEN_N4") & " " & _
						''                                             "AND ORDEN_N5 = " & rstAcc("ORDEN_N5") & ")"
						'                  Set rstAux4 = mfRecordset(conPasarela, strSQL)
						'                  If Not rstAux4.EOF Then
						'                     strOrd = rstAux4(0)
						'                  Else
						'                     strOrd = "@INICIO!ORDENTRA"
						'                  End If
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', '@ORDENTRA', '" & strOrd & "')"
						'                  mfExecute conPasarela, strSQL
						'                  'Decimo Registro
						'                  lngID = lngID + 1
						'                  strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" _
						''                           & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '2')"
						'                  mfExecute conPasarela, strSQL
						'               End If
						
					Case "WAIT", "WAITALL"
						lngFlowOrder = lngFlowOrder + 100
						lngID = 0
						'Obtener los parámetros de la acción WAIT
						strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "ORDER BY ORDEN_PA"
						rstAux = mfRecordset(conPasarela, strSQL)
						If Not rstAux.EOF Then
							strParam = rstAux.Fields("PARAMETRO").Value
							strValor = rstAux.Fields("VALOR").Value
						End If
						strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
						'Primer Registro
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'WAITALL', '" & strName & "', 'PATH', '" & strValor & "')"
						mfExecute(conPasarela, strSQL)
						'Segundo Registro
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID + 1 & ", '', '', 'REQUIRED', '1')"
						mfExecute(conPasarela, strSQL)
						'Tercer Registro
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID + 2 & ", '', '', 'LEVEL', '2')"
						mfExecute(conPasarela, strSQL)
						
					Case "JUMP"
						lngFlowOrder = lngFlowOrder + 100
						lngID = 0
						'Obtener los parámetros de la acción JUMP
						'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
						If IsDbNull(rstAcc.Fields("ID_ACCION").Value) Then
							strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "ORDER BY ORDEN_PA"
						Else
							strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "AND P.ID_ACCION = '" & rstAcc.Fields("ID_ACCION").Value & "' " & "ORDER BY ORDEN_PA"
						End If
						rstAux = mfRecordset(conPasarela, strSQL)
						strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
						If Not rstAux.EOF Then
							strParam = rstAux.Fields("PARAMETRO").Value
							strValor = rstAux.Fields("VALOR").Value
						End If
						'Primer Registro
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'JUMP', '" & strName & "', 'PATH', '" & strValor & "')"
						mfExecute(conPasarela, strSQL)
						'Segundo Registro
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID + 1 & ", '', '', 'LEVEL', '" & IIf(rstAcc.Fields("NOMBRE").Value = "ISFLY", "3", "2") & "')"
						mfExecute(conPasarela, strSQL)
						
					Case UCase("CANCELWAIT")
						lngFlowOrder = lngFlowOrder + 100
						lngID = 0
						'Obtener los parámetros de la acción CANCELWAIT
						'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
						If IsDbNull(rstAcc.Fields("ID_ACCION").Value) Then
							strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "ORDER BY ORDEN_PA"
						Else
							strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "AND P.ID_ACCION = '" & rstAcc.Fields("ID_ACCION").Value & "' " & "ORDER BY ORDEN_PA"
						End If
						rstAux = mfRecordset(conPasarela, strSQL)
						strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
						If Not rstAux.EOF Then
							strParam = rstAux.Fields("PARAMETRO").Value
							strValor = rstAux.Fields("VALOR").Value
						End If
						'Primer Registro
						strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'CANCELWAIT', '" & strName & "', 'LEVEL', '2')"
						mfExecute(conPasarela, strSQL)
						
					Case Else
						Select Case UCase(VB.Left(Trim(rstAcc.Fields("PATH_HIDRA").Value), 3))
							Case "LET"
								If Mid(Trim(rstAcc.Fields("PATH_HIDRA").Value), 1, 3) = "APE" Then
									strName = Trim(Mid(rstAcc.Fields("PATH_HIDRA").Value, 5))
								Else
									strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
								End If
								lngFlowOrder = lngFlowOrder + 100
								lngID = 0
								'Obtener los parámetros de la acción LETVAR
								strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "AND P.ID_ACCION " & IIf(snulo(rstAcc.Fields("ID_ACCION").Value & "") = "Null", " IS NULL ", " = " & rstAcc.Fields("ID_ACCION").Value) & " " & "ORDER BY ORDEN_PA"
								rstAux = mfRecordset(conPasarela, strSQL)
								While Not rstAux.EOF
									'Insertar Primer Registro
									strParam = rstAux.Fields("PARAMETRO").Value
									strValor = rstAux.Fields("VALOR").Value
									strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'LETVAR', '" & strName & "', '" & strParam & "', '" & strValor & "')"
									mfExecute(conPasarela, strSQL)
									lngID = lngID + 1
									rstAux.MoveNext()
								End While
								'Insertar Segundo Registro
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '2')"
								mfExecute(conPasarela, strSQL)
								'Insertar Tercer Registro
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID + 2 & ", '', '', 'INICIO', '1')"
								mfExecute(conPasarela, strSQL)
								
							Case "APE"
								strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
								'Primer Registro
								If Not (rstAcc.Fields("ID_ACCION").Value = 0) Then
									strSQL = "SELECT INDTIPOA, " & "IDACCION, " & "DESACCCM " & "FROM ACCIONES " & "WHERE IDACCION = " & rstAcc.Fields("ID_ACCION").Value & " " & "AND DESACCHN = '" & rstAcc.Fields("NOM_ACCION").Value & "'"
								Else
									strSQL = "SELECT INDTIPOA, " & "IDACCION, " & "DESACCCM " & "FROM ACCIONES " & "WHERE DESACCHN = '" & rstAcc.Fields("NOM_ACCION").Value & "'"
								End If
								rstAux2 = mfRecordset(conInfra, strSQL)
								If Not rstAux2.EOF Then
									If (rstAux2.Fields("INDTIPOA").Value = "G") Then
										strValue = strBDDGenerales
									ElseIf (rstAux2.Fields("INDTIPOA").Value = "F") Then 
										strValue = strBDDGestion
									ElseIf (rstAux2.Fields("INDTIPOA").Value = "E") Then 
										strValue = strBDDEspecificas
									ElseIf (rstAux2.Fields("INDTIPOA").Value = "W") Then 
										strValue = strBDDWord
									ElseIf (rstAux2.Fields("INDTIPOA").Value = "D") Then 
										strValue = strBDDDOCU
									ElseIf (rstAux2.Fields("INDTIPOA").Value = "A") Then 
										strValue = strBDDArranque
									ElseIf (rstAux2.Fields("INDTIPOA").Value = "M") Then 
										strValue = strBDDMensaje
									ElseIf (rstAux2.Fields("INDTIPOA").Value = "O") Then 
										strValue = strBDDInfra
									End If
								End If
								lngFlowOrder = lngFlowOrder + 100
								lngID = 0
								If Len(strName) > 25 Then
									strName = Mid(strName, 1, 22) & Mid(strName, 24, 3)
								End If
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'APIINIENDEXT', '" & strName & "', 'PROJECT', '" & strValue & "')"
								mfExecute(conPasarela, strSQL)
								'Segundo Registro
								lngID = lngID + 1
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'FLOW', '" & rstAcc.Fields("NOM_ACCION").Value & "')"
								mfExecute(conPasarela, strSQL)
								'Tercer Registro
								lngID = lngID + 1
								'                  strSQL = "SELECT VALOR " & _
								''                           "FROM PARAM_ACC P " & _
								''                           "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & _
								''                             "AND P.ORDEN_N1 = " & rstAcc("ORDEN_N1") & " AND " _
								''                           & "P.ORDEN_N2=" & rstAcc("ORDEN_N2") & " AND " _
								''                           & "P.ORDEN_N3=" & rstAcc("ORDEN_N3") & " AND " _
								''                           & "P.ORDEN_N4=" & rstAcc("ORDEN_N4") & " AND " _
								''                           & "P.ORDEN_N5=" & rstAcc("ORDEN_N5") & " AND " _
								''                           & "P.ORDEN_ACC=" & rstAcc("ORDEN_ACC") & " AND " _
								''                           & "P.PARAMETRO='@REFERENCIA'"
								'                  Set rstAux3 = mfRecordset(conPasarela, strSQL)
								lngRef = lngRef + 1
								strPar = "=$CONCAT([%REFERENCE%];[" & strTipoReferencia & lngRef & "])/$"
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'REFERENCE', '" & strPar & "')"
								mfExecute(conPasarela, strSQL)
								'Cuarto Registro
								lngID = lngID + 1
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'INIT', '1')"
								mfExecute(conPasarela, strSQL)
								'Quinto Registro
								lngID = lngID + 1
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '" & IIf(rstAcc.Fields("NOMBRE").Value = "ISFLY", "3", "2") & "')"
								mfExecute(conPasarela, strSQL)
								'Sexto Registro (DEFERRED, por defecto se pondrá a 0 para que sean tareas NO diferidas)
								lngID = lngID + 1
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'DEFERRED', '0')"
								mfExecute(conPasarela, strSQL)
								'Septimo Registro (CODAPLICACION, el codigo de aplicación )
								lngID = lngID + 1
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', '@CODIGOAPLICA', '" & CodAplicacion & "')"
								mfExecute(conPasarela, strSQL)
								'Resto de Registros
								'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
								If IsDbNull(rstAcc.Fields("ID_ACCION").Value) Then
									strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "ORDER BY ORDEN_PA"
								Else
									strSQL = "SELECT * " & "FROM PARAM_ACC P " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND P.ORDEN_N1 = '" & rstAcc.Fields("ORDEN_N1").Value & "' " & "AND P.ORDEN_N2 = '" & rstAcc.Fields("ORDEN_N2").Value & "' " & "AND P.ORDEN_N3 = '" & rstAcc.Fields("ORDEN_N3").Value & "' " & "AND P.ORDEN_N4 = '" & rstAcc.Fields("ORDEN_N4").Value & "' " & "AND P.ORDEN_N5 = '" & rstAcc.Fields("ORDEN_N5").Value & "' " & "AND P.ORDEN_ACC = '" & rstAcc.Fields("ORDEN_ACC").Value & "' " & "AND P.ID_ACCION = '" & rstAcc.Fields("ID_ACCION").Value & "' " & "ORDER BY ORDEN_PA"
								End If
								rstAux = mfRecordset(conPasarela, strSQL)
								While Not rstAux.EOF
									lngID = lngID + 1
									Select Case rstAux.Fields("PARAMETRO").Value
										Case "REFERENCE"
											'                           strSQL = "SELECT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " _
											''                                    & "P.ORDEN_N1=" & rstAcc("ORDEN_N1") & " AND " _
											''                                    & "P.ORDEN_N2=" & rstAcc("ORDEN_N2") & " AND " _
											''                                    & "P.ORDEN_N3=" & rstAcc("ORDEN_N3") & " AND " _
											''                                    & "P.ORDEN_N4=" & rstAcc("ORDEN_N4") & " AND " _
											''                                    & "P.ORDEN_N5=" & rstAcc("ORDEN_N5") & " AND " _
											''                                    & "P.ORDEN_ACC=" & rstAcc("ORDEN_ACC") & " AND " _
											''                                    & "P.PARAMETRO='@REFERENCIA'"
											'                           Set rstAux3 = mfRecordset(conPasarela, strSQL)
											lngRef = lngRef + 1
											strPar = "=$CONCAT([%REFERENCE%];[" & strTipoReferencia & lngRef & "])/$"
											'fin aketza
											strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', '" & rstAux.Fields("PARAMETRO").Value & "', '" & strPar & "')"
											
										Case "@REFERENCIA"
											strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', '" & rstAux.Fields("PARAMETRO").Value & "', '%REFERENCE%')"
											
										Case Else
											strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', '" & rstAux.Fields("PARAMETRO").Value & "', '" & rstAux.Fields("VALOR").Value & "')"
									End Select
									mfExecute(conPasarela, strSQL)
									rstAux.MoveNext()
								End While
								
							Case "EDP"
								'ENDPROC
								strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
								If Len(strName) > 25 Then
									strName = Mid(strName, 1, 22) & Mid(strName, 24, 3)
								End If
								'Primer Registro
								lngFlowOrder = lngFlowOrder + 100
								lngID = 0
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'ENDPROC', '" & strName & "', 'COMENTARIO', '')"
								mfExecute(conPasarela, strSQL)
								'Segundo Registro
								lngID = lngID + 1
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '" & IIf(rstAcc.Fields("NOMBRE").Value = "ISFLY", "3", "2") & "')"
								mfExecute(conPasarela, strSQL)
								
							Case "PRO"
								'PROCESS
								strName = Trim(rstAcc.Fields("PATH_HIDRA").Value)
								If Len(strName) > 25 Then
									strName = Mid(strName, 1, 22) & Mid(strName, 24, 3)
								End If
								'Primer Registro
								lngFlowOrder = lngFlowOrder + 100
								lngID = 0
								strAux = Mid(strAux, 5, Len(strAux))
								If rstAcc.Fields("NOMBRE").Value = "FLY" Then
									strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'LABEL', '" & strName & "', '', '')"
								Else
									strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'LABEL', '" & strName & "', 'STATE', '" & strName & "')"
								End If
								mfExecute(conPasarela, strSQL)
								'Segundo Registro
								lngID = lngID + 1
								If rstAcc.Fields("NOMBRE").Value = "FLY" Then
									strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'SUBMIT', 'FLY')"
								Else
									strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'SUBMIT', '0')"
								End If
								mfExecute(conPasarela, strSQL)
								'Tercer Registro
								lngID = lngID + 1
								strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '" & IIf(rstAcc.Fields("NOMBRE").Value = "ISFLY", "3", "2") & "')"
								mfExecute(conPasarela, strSQL)
						End Select
				End Select
				j = j + 1
				rstAcc.MoveNext()
			End While
			'UPGRADE_WARNING: Couldn't resolve default property of object I. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			I = I + 1
			rstInf.MoveNext()
		End While
		
		lngID = 0
		lngFlowOrder = lngFlowOrder + 100
		strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", 'END', 'FIN " & gNomProcCorto & "', 'FLUSHALL', '0')"
		mfExecute(conPasarela, strSQL)
		lngID = lngID + 1
		strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, VERSION, FLOWORDER, ID, ACTION, PATH, PARAM, VALUE) VALUES (" & "'" & gNomProcCorto & "', " & SelectedVersion & ", " & lngFlowOrder & ", " & lngID & ", '', '', 'LEVEL', '1')"
		mfExecute(conPasarela, strSQL)
		
		'Modificamos los Trámites con Adaptaciones para mejorar la tramitación
		msCorregirTramites()
		
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'UPGRADE_NOTE: Object rstAcc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAcc = Nothing
		'UPGRADE_NOTE: Object rstInf may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstInf = Nothing
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		tramiteAnterior = ""
		Me.Close()
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'UPGRADE_NOTE: Object rstAcc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAcc = Nothing
		'UPGRADE_NOTE: Object rstInf may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstInf = Nothing
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		
		'aketza errores
		Insertar_Error(Me, "Crear Trámites", "Ha ocurrido un error no controlado", "msCrearTramites" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msCrearTramites - " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	
	Private Sub msCargarInfraestructura()
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		'CAMBIO PROVISIONAL UT
		Dim rstAux5 As ADODB.Recordset
		Dim blnErrUT As Boolean
		
		Dim strSQL As String
		Dim lngMax As Integer
		Dim STRFEC As Object
		
		On Error GoTo procErr
		
		blnErrRecordset = False
		
		'Comprobamos si tenemos acceso a DB2
		CierraCN(conDB2)
		conDB2 = New ADODB.Connection
		If ComprobarConexion(conDB2, ReadIniFile(INIFile, "DB2", "Connection")) = False Then
			MsgBox("No se ha podido conectar a DB2, vuelva a lanzar la pasarela", MsgBoxStyle.Critical)
			End
		End If
		
		'Abrimos la Transacción
		conDB2.BeginTrans()
		
		'Obtenemos las Descripciones del Procedimiento en Castellano
		strSQL = "SELECT * " & "FROM TBDCELTA_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_IDIOMA = 'C' " & "ORDER BY ELTA_CODTAB, " & "ELTA_CLAVE"
		blnErrRecordset = False
		rstAux2 = mfRecordset(conPasarela, strSQL)
		If blnErrRecordset = True Then
			GoTo procErr
		End If
		lblMensaje.Text = "Comprobado/Volcado de datos en INFRAESTUCTURA (TBDCELTA)"
		While Not rstAux2.EOF
			msProceso(rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 1, 8)
			Select Case Trim(CStr(rstAux2.Fields("ELTA_CODTAB").Value))
				Case "P1"
					strSQL = "SELECT * " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_CLAVE = '" & snulo(Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "") & "'"
					rstAux = mfRecordset(conDB2, strSQL, "DB2")
					If blnErrRecordset = True Then
						GoTo procErr
					End If
					If rstAux.EOF Then
						MsgBox("NO SE ENCUENTRA LA FAMILIA EN TBDCELTA")
						GoTo procErr
					End If
					
				Case "P2"
					strSQL = "SELECT * " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_DESC60 = '" & Trim(rstAux2.Fields("ELTA_DESC60").Value) & New String(" ", 60 - Len(Trim(rstAux2.Fields("ELTA_DESC60").Value))) & "'"
					rstAux = mfRecordset(conDB2, strSQL, "DB2")
					If blnErrRecordset = True Then
						GoTo procErr
					End If
					'Calcular el máximo de tbdcelta
					strSQL = "SELECT * " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & rstAux2.Fields("ELTA_IDIOMA").Value & "'"
					rstAux3 = mfRecordset(conDB2, strSQL, "DB2")
					'Cambio la SQL para poder ejecutar contra COMODB2
					strSQL = "SELECT MAX(dbo.INTEGER(ELTA_CLAVE)) " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & rstAux2.Fields("ELTA_IDIOMA").Value & "' " & "AND ELTA_CLAVE <> '999999'"
					rstAux4 = mfRecordset(conDB2, strSQL, "DB2")
					If rstAux.EOF = True Then
						If lngMax = 0 Then
							lngMax = Val(rstAux4.Fields(0).Value & "") + 1
						Else
							lngMax = lngMax + 1
						End If
						strSQL = "INSERT INTO %owner%TBDCELTA (ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, ELTA_DESC60, ELTA_DESC40, ELTA_DESC20, ELTA_FECBAJA) VALUES (" & "'" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "', " & "'" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "', " & "'" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "', " & "'" & New String("0", 6 - Len(CStr(lngMax))) & lngMax & "', " & "'" & snulo(Trim(rstAux2.Fields("ELTA_DESC60").Value) & "") & "', " & "'" & snulo(Trim(rstAux2.Fields("ELTA_DESC40").Value) & "") & "', " & "'" & snulo(Trim(rstAux2.Fields("ELTA_DESC20").Value) & "") & "', " & "'0001-01-01')"
						If mfExecute(conDB2, strSQL, "DB2") = False Then
							GoTo procErr
						End If
						strSQL = "UPDATE TBDCELTA_PA " & "SET AUX = " & lngMax & " " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_AMBITO = '" & rstAux2.Fields("ELTA_AMBITO").Value & "' " & "AND ELTA_CODTAB = '" & rstAux2.Fields("ELTA_CODTAB").Value & "' " & "AND ELTA_IDIOMA = '" & rstAux2.Fields("ELTA_IDIOMA").Value & "' " & "AND ELTA_CLAVE = '" & Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "'"
					Else
						strSQL = "UPDATE TBDCELTA_PA " & "SET AUX = " & Trim(rstAux.Fields("ELTA_CLAVE").Value) & " " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_CLAVE = '" & Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "'"
					End If
					mfExecute(conPasarela, strSQL)
					
				Case "P3"
					strSQL = "SELECT * " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_CLAVE = '" & snulo(Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "") & "'"
					rstAux = mfRecordset(conDB2, strSQL, "DB2")
					If blnErrRecordset = True Then
						GoTo procErr
					End If
					If rstAux.EOF Then
						MsgBox("NO SE ENCUENTRA EL PROCEDIMIENTO EN TBDCELTA")
						GoTo procErr
					End If
					
				Case "PB"
					''''''            strSQL = "SELECT * FROM %owner%TBDCELTA WHERE "
					''''''            strSQL = strSQL & " ELTA_AMBITO='" & Trim(rstAux2("ELTA_AMBITO")) & "' AND ELTA_CODTAB='" & Trim(rstAux2("ELTA_CODTAB")) & "' AND"
					''''''            strSQL = strSQL & " ELTA_IDIOMA='" & Trim(rstAux2("ELTA_IDIOMA")) & "' AND ELTA_CLAVE='" & snulo(Trim(rstAux2("ELTA_CLAVE")) & "") & "'"
					''''''            Set rstAux = mfRecordset(conDB2, strSQL, "DB2")
					''''''            If blnErrRecordset = True Then
					''''''               GoTo procErr
					''''''            End If
					'''''pendiente UT
					''''''            If rstAux.EOF = True Then
					''''''               strSQL = "INSERT into %owner%TBDCELTA (ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, "
					''''''               strSQL = strSQL & "ELTA_DESC60, ELTA_DESC40, ELTA_DESC20,ELTA_FECBAJA) values ("
					''''''               strSQL = strSQL & "'" & Trim(rstAux2("ELTA_AMBITO")) & "', '" & Trim(rstAux2("ELTA_CODTAB")) & "', "
					''''''               strSQL = strSQL & "'" & Trim(rstAux2("ELTA_IDIOMA")) & "', '" & snulo(Trim(rstAux2("ELTA_CLAVE")) & "") & "', "
					''''''               strSQL = strSQL & "'" & snulo(Trim(rstAux2("ELTA_DESC60")) & "") & "', '" & snulo(Trim(rstAux2("ELTA_DESC40")) & "") & "', "
					''''''               strSQL = strSQL & "'" & snulo(Trim(rstAux2("ELTA_DESC20")) & "") & "','01.01.0001')"
					''''''               If mfExecute(conDB2, strSQL, "DB2") = False Then GoTo procErr
					''''''            End If
					''''''
			End Select
			rstAux2.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		lngMax = 0
		
		'Obtenemos las Descripciones del Procedimiento en Euskera
		strSQL = "SELECT * " & "FROM TBDCELTA_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_IDIOMA = 'E' " & "ORDER BY ELTA_CODTAB, " & "ELTA_CLAVE "
		rstAux2 = mfRecordset(conPasarela, strSQL)
		If blnErrRecordset = True Then
			GoTo procErr
		End If
		lblMensaje.Text = "Comprobado/Volcado de datos en INFRAESTUCTURA (TBDCELTA)"
		While Not rstAux2.EOF
			msProceso(rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 2, 8)
			Select Case rstAux2.Fields("ELTA_CODTAB").Value
				Case "P1"
					strSQL = "SELECT * " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_CLAVE = '" & snulo(Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "") & "'"
					rstAux = mfRecordset(conDB2, strSQL, "DB2")
					If blnErrRecordset = True Then
						GoTo procErr
					End If
					If rstAux.EOF Then
						MsgBox("NO SE ENCUENTRA LA FAMILIA EN TBDCELTA")
						GoTo procErr
					End If
					
				Case "P2"
					strSQL = "SELECT * " & "FROM TBDCELTA_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_CLAVE = '" & Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "' " & "AND ELTA_IDIOMA = 'C'"
					rstAux3 = mfRecordset(conPasarela, strSQL)
					lngMax = Val(rstAux3.Fields("AUX").Value & "")
					strSQL = "SELECT * " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_CLAVE = '" & New String("0", 6 - Len(CStr(lngMax))) & lngMax & "'"
					rstAux = mfRecordset(conDB2, strSQL, "DB2")
					If blnErrRecordset = True Then
						GoTo procErr
					End If
					'calcular el máximo de tbdcelta
					If rstAux.EOF = True Then
						strSQL = "INSERT into %owner%TBDCELTA (ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, ELTA_DESC60, ELTA_DESC40, ELTA_DESC20,ELTA_FECBAJA) VALUES (" & "'" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "', " & "'" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "', " & "'" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "', " & "'" & New String("0", 6 - Len(CStr(lngMax))) & lngMax & "', " & "'" & snulo(Trim(rstAux2.Fields("ELTA_DESC60").Value) & "") & "', " & "'" & snulo(Trim(rstAux2.Fields("ELTA_DESC40").Value) & "") & "', " & "'" & snulo(Trim(rstAux2.Fields("ELTA_DESC20").Value) & "") & "', " & "'0001-01-01')"
						If mfExecute(conDB2, strSQL, "DB2") = False Then
							GoTo procErr
						End If
						strSQL = "UPDATE TBDCELTA_PA " & "SET AUX = " & lngMax & " " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_AMBITO = '" & rstAux2.Fields("ELTA_AMBITO").Value & "' " & "AND ELTA_CODTAB = '" & rstAux2.Fields("ELTA_CODTAB").Value & "' " & "AND ELTA_IDIOMA = '" & rstAux2.Fields("ELTA_IDIOMA").Value & "' " & "AND ELTA_CLAVE = '" & Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "'"
					Else
						strSQL = "UPDATE TBDCELTA_PA " & "SET AUX = " & Trim(rstAux.Fields("ELTA_CLAVE").Value) & " " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_CLAVE = '" & Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "'"
					End If
					mfExecute(conPasarela, strSQL)
					
				Case "P3"
					strSQL = "SELECT * " & "FROM %owner%TBDCELTA " & "WHERE ELTA_AMBITO = '" & Trim(rstAux2.Fields("ELTA_AMBITO").Value) & "' " & "AND ELTA_CODTAB = '" & Trim(rstAux2.Fields("ELTA_CODTAB").Value) & "' " & "AND ELTA_IDIOMA = '" & Trim(rstAux2.Fields("ELTA_IDIOMA").Value) & "' " & "AND ELTA_CLAVE = '" & snulo(Trim(rstAux2.Fields("ELTA_CLAVE").Value) & "") & "'"
					rstAux = mfRecordset(conDB2, strSQL, "DB2")
					If blnErrRecordset = True Then
						GoTo procErr
					End If
					If rstAux.EOF Then
						MsgBox("NO SE ENCUENTRA EL PROCEDIMIENTO EN TBDCELTA")
						GoTo procErr
					End If
					
				Case "PB"
					''''''            strSQL = "SELECT * FROM %owner%TBDCELTA WHERE "
					''''''            strSQL = strSQL & " ELTA_AMBITO='" & Trim(rstAux2("ELTA_AMBITO")) & "' AND ELTA_CODTAB='" & Trim(rstAux2("ELTA_CODTAB")) & "' AND"
					''''''            strSQL = strSQL & " ELTA_IDIOMA='" & Trim(rstAux2("ELTA_IDIOMA")) & "' AND ELTA_CLAVE='" & snulo(Trim(rstAux2("ELTA_CLAVE")) & "") & "'"
					''''''            Set rstAux = mfRecordset(conDB2, strSQL, "DB2")
					''''''            If blnErrRecordset = True Then
					''''''               GoTo procErr
					''''''            End If
					'pendiete ut
					'''''            If rstAux.EOF = True Then
					'''''               strSQL = "INSERT into %owner%TBDCELTA (ELTA_AMBITO, ELTA_CODTAB, ELTA_IDIOMA, ELTA_CLAVE, "
					'''''               strSQL = strSQL & "ELTA_DESC60, ELTA_DESC40, ELTA_DESC20,ELTA_FECBAJA) values ("
					'''''               strSQL = strSQL & "'" & Trim(rstAux2("ELTA_AMBITO")) & "', '" & Trim(rstAux2("ELTA_CODTAB")) & "', "
					'''''               strSQL = strSQL & "'" & Trim(rstAux2("ELTA_IDIOMA")) & "', '" & snulo(Trim(rstAux2("ELTA_CLAVE")) & "") & "', "
					'''''               strSQL = strSQL & "'" & snulo(Trim(rstAux2("ELTA_DESC60")) & "") & "', '" & snulo(Trim(rstAux2("ELTA_DESC40")) & "") & "', "
					'''''               strSQL = strSQL & "'" & snulo(Trim(rstAux2("ELTA_DESC20")) & "") & "','01.01.0001')"
					'''''               If mfExecute(conDB2, strSQL, "DB2") = False Then
					'''''                  GoTo procErr
					'''''               End If
					'''''            End If
			End Select
			rstAux2.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		
		'TBPFIN01
		strSQL = "SELECT CODPROCE, " & "CODENTID, " & "CODFAMIL, " & "CODEXTPR, " & "CODGRPRO " & "FROM TBPFIN01_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "'"
		rstAux2 = mfRecordset(conPasarela, strSQL)
		If blnErrRecordset = True Then
			GoTo procErr
		End If
		lblMensaje.Text = "Comprobado/Volcado de datos en INFRAESTUCTURA (TBPFIN01)"
		While Not rstAux2.EOF
			msProceso(rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 3, 8)
			strSQL = "SELECT * " & "FROM %owner%TBPFIN01 " & "WHERE CODPROCE = " & rstAux2.Fields("CODPROCE").Value & " " & "AND CODENTID = " & strCodEntid & " " & "AND CODFAMIL = " & strCodFamil
			rstAux = mfRecordset(conDB2, strSQL, "DB2")
			If blnErrRecordset = True Then
				GoTo procErr
			End If
			If rstAux.EOF = True Then
				GoTo procErr
			End If
			rstAux2.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		
		'TBPFIN02
		lblMensaje.Text = "Comprobado/Volcado de datos en INFRAESTUCTURA (TBPFIN02)"
		strSQL = "SELECT MAX(VERSIONH) " & "FROM %owner%TBPFIN02 " & "WHERE CODPROCE = " & lngCodProc
		rstAux = mfRecordset(conDB2, strSQL, "DB2")
		VersionHidra = Val(rstAux.Fields(0).Value & "") + 1
		strSQL = "SELECT * " & "FROM %owner%TBPFIN02 " & "WHERE CODPROCE = " & lngCodProc & " " & "AND VERSIONP = " & SelectedVersion
		rstAux = mfRecordset(conDB2, strSQL, "DB2")
		If blnErrRecordset = True Then
			GoTo procErr
		End If
		If rstAux.EOF = True Then
			strSQL = "INSERT INTO %owner%TBPFIN02 (CODPROCE, VERSIONP, FECVALDE, FECVALHA, NIVAUTOR, ESTADOVP, VERSIONH, OBSERVAC) VALUES (" & lngCodProc & ", " & SelectedVersion & ", " & "'" & VB6.Format(strFechaOriginal, "dd.mm.yyyy") & "', " & "'9999-12-31', " & "0, " & "'A', " & VersionHidra & ", " & "'" & gstrObserva & "')"
			If mfExecute(conDB2, strSQL, "DB2") = False Then
				GoTo procErr
			End If
			'UPGRADE_WARNING: Couldn't resolve default property of object STRFEC. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			STRFEC = DateAdd(Microsoft.VisualBasic.DateInterval.Day, -1, CDate(strFechaOriginal))
			'UPGRADE_WARNING: Couldn't resolve default property of object STRFEC. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strSQL = "UPDATE %owner%TBPFIN02 " & "SET FECVALHA = '" & VB6.Format(STRFEC, "dd.mm.yyyy") & "' " & "WHERE CODPROCE = " & lngCodProc & " " & "AND VERSIONP = " & SelectedVersion - 1
			If mfExecute(conDB2, strSQL, "DB2") = False Then
				GoTo procErr
			End If
		Else
			strSQL = "UPDATE %owner%TBPFIN02 " & "SET CODPROCE = " & rstAux.Fields("CODPROCE").Value & ", " & "VERSIONP = " & rstAux.Fields("VERSIONP").Value & ", " & "VERSIONH = " & VersionHidra & ", "
			If gblnNuevaVersion = True Then
				strSQL = strSQL & "FECVALDE = '" & VB6.Format(strFechaOriginal, "dd.mm.yyyy") & "', " & "FECVALHA = '" & Replace(snulo(rstAux.Fields("FECVALHA").Value & "", True), "/", ".") & "', "
			End If
			strSQL = strSQL & "NIVAUTOR = " & snulo(rstAux.Fields("NIVAUTOR").Value & "") & ", " & "ESTADOVP = '" & rstAux.Fields("ESTADOVP").Value & "' " & "WHERE CODPROCE = " & rstAux.Fields("CODPROCE").Value & " " & "AND VERSIONP = " & rstAux.Fields("VERSIONP").Value
			If mfExecute(conDB2, strSQL, "DB2") = False Then
				GoTo procErr
			End If
		End If
		
		'**************************************************************************************
		'* TBPFIN03 - TRÁMITES POR VERSIÓN DE P.A.
		'**************************************************************************************
		'Los borramos e insertamos
		strSQL = "SELECT * " & "FROM TBPFIN03_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND CODTRAAD <> 999999"
		rstAux2 = mfRecordset(conPasarela, strSQL)
		If blnErrRecordset = True Then
			GoTo procErr
		End If
		lblMensaje.Text = "Comprobado/Volcado de datos en INFRAESTUCTURA (TBPFIN03)"
		If Not rstAux2.EOF Then
			strSQL = "DELETE FROM %owner%TBPFIN03 " & "WHERE CODPROCE = " & rstAux2.Fields("CODPROCE").Value & " " & "AND VERSIONP = " & rstAux2.Fields("VERSIONP").Value
			If mfExecute(conDB2, strSQL, "DB2") = False Then
				GoTo procErr
			End If
			While Not rstAux2.EOF
				If rstAux2.Fields("ORDENTRA").Value <> 0 And rstAux2.Fields("ORDENTRA").Value <> 888 Then
					strSQL = "SELECT ELTA_DESC60 " & "FROM TBDCELTA_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_CLAVE = '" & rstAux2.Fields("CODTRAAD").Value & "' " & "AND ELTA_IDIOMA = 'C' " & "AND ELTA_CODTAB = 'P2'"
					rstAux4 = mfRecordset(conPasarela, strSQL)
					strSQL = "SELECT AUX " & "FROM TBDCELTA_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ELTA_DESC60 = '" & rstAux4.Fields("ELTA_DESC60").Value & "' " & "AND ELTA_IDIOMA = 'C' " & "AND ELTA_CODTAB = 'P2'"
					rstAux4 = mfRecordset(conPasarela, strSQL)
					msProceso(rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 4, 8)
					strSQL = "INSERT INTO %owner%TBPFIN03 (CODPROCE, VERSIONP, ORDENTRA, CODTRAAD, INDPROCE, NIVTRAMI, INDBLOQ, CDESTRAM, INDSIMUL, TRAMOCUL, CODFASE, CODSFASE, DATFASUB, VAR_FLUJO, CRITERIO_COMP, VALOR_FIJO) VALUES (" & rstAux2.Fields("CODPROCE").Value & ", " & rstAux2.Fields("VERSIONP").Value & ", " & rstAux2.Fields("ORDENTRA").Value & ", " & rstAux4.Fields("AUX").Value & ", " & "'" & Trim(rstAux2.Fields("INDPROCE").Value) & "', " & snulo(rstAux2.Fields("NIVTRAMI").Value & "") & ", " & "'" & Trim(rstAux2.Fields("INDBLOQ").Value) & "', " & snulo(rstAux2.Fields("CODTRAAD").Value & "") & ", " & "'" & Trim(rstAux2.Fields("INDSIMUL").Value) & "', " & "'" & Trim(rstAux2.Fields("TRAMOCUL").Value) & "', " & "'" & Trim(rstAux2.Fields("CODFASE").Value) & "', " & "'" & Trim(rstAux2.Fields("CODSFASE").Value) & "', " & "'" & Trim(rstAux2.Fields("DATFASUB").Value) & "', " & "'" & Trim(rstAux2.Fields("VAR_FLUJO").Value) & "', " & "'" & Trim(rstAux2.Fields("CRITERIO_COMP").Value) & "', " & "'" & Trim(rstAux2.Fields("VALOR_FIJO").Value) & "')"
				Else
					If rstAux2.Fields("ORDENTRA").Value = 888 Then
						strSQL = "INSERT INTO %owner%TBPFIN03 (CODPROCE, VERSIONP, ORDENTRA, CODTRAAD, INDPROCE, NIVTRAMI, INDBLOQ, CDESTRAM, INDSIMUL, TRAMOCUL) VALUES (" & rstAux2.Fields("CODPROCE").Value & ", " & rstAux2.Fields("VERSIONP").Value & ", " & rstAux2.Fields("ORDENTRA").Value & ", " & "888888, " & "'" & Trim(rstAux2.Fields("INDPROCE").Value) & "', " & snulo(rstAux2.Fields("NIVTRAMI").Value & "") & ", " & "'" & Trim(rstAux2.Fields("INDBLOQ").Value) & "', " & snulo(rstAux2.Fields("CODTRAAD").Value & "") & ", " & "'" & Trim(rstAux2.Fields("INDSIMUL").Value) & "', " & "'" & Trim(rstAux2.Fields("TRAMOCUL").Value) & "')"
					Else
						strSQL = "INSERT INTO %owner%TBPFIN03 (CODPROCE, VERSIONP, ORDENTRA, CODTRAAD, INDPROCE, NIVTRAMI, INDBLOQ, CDESTRAM, INDSIMUL, TRAMOCUL) VALUES (" & rstAux2.Fields("CODPROCE").Value & ", " & rstAux2.Fields("VERSIONP").Value & ", " & rstAux2.Fields("ORDENTRA").Value & ", " & "0, " & "'" & Trim(rstAux2.Fields("INDPROCE").Value) & "', " & snulo(rstAux2.Fields("NIVTRAMI").Value & "") & ", " & "'" & Trim(rstAux2.Fields("INDBLOQ").Value) & "', " & snulo(rstAux2.Fields("CODTRAAD").Value & "") & ", " & "'" & Trim(rstAux2.Fields("INDSIMUL").Value) & "', " & "'" & Trim(rstAux2.Fields("TRAMOCUL").Value) & "')"
					End If
				End If
				If mfExecute(conDB2, strSQL, "DB2") = False Then
					GoTo procErr
				End If
				rstAux2.MoveNext()
				System.Windows.Forms.Application.DoEvents()
			End While
		End If
		
		'''''CAMBIO PROVISIONAL UT. general especifico
		'''''   'TBPFIN23
		'''''   lblMensaje = "Comprobado/Volcado de datos en INFRAESTUCTURA (TBPFIN23)"
		'''''   strSQL = "SELECT * FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
		'''''   Set rstAux2 = mfRecordset(conPasarela, strSQL)
		'''''   If blnErrRecordset = True Then
		'''''      GoTo procErr
		'''''   End If
		'''''   While Not rstAux2.EOF
		'''''      msProceso rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 5, 6
		'''''      strSQL = "SELECT * FROM TBPFIN23 WHERE "
		'''''      strSQL = strSQL & " CODENTID=" & rstAux2("CODENTID") & " AND CODFAMIL=" & rstAux2("CODFAMIL") & " AND CODUNITR=" & rstAux2("CODUNITR")
		'''''      strSQL = strSQL & " AND CODUTRHN=" & rstAux2("CODUTRHN")
		'''''      strSQL = "SELECT * FROM TBPFIN23 WHERE CODENTID=" & rstAux2("CODENTID") & " AND CODFAMIL=" & rstAux2("CODFAMIL")
		'''''      strSQL = strSQL & " AND CODUNITR=" & rstAux2("CODUNITR")
		'''''      Set rstAux = mfRecordset(conDB2, strSQL, "DB2")
		'''''      If blnErrRecordset = True Then
		'''''         GoTo procErr
		'''''      End If
		'''''      If rstAux.EOF = True Then
		'''''         strSQL = "INSERT INTO %owner%TBPFIN23 (CODENTID, CODFAMIL, CODUNITR, CODUTRHN, INDCONVE, TIPOUNTR, CARGO) VALUES ("
		'''''         strSQL = strSQL & rstAux2("CODENTID") & ", " & rstAux2("CODFAMIL") & ", "
		'''''         strSQL = strSQL & rstAux2("CODUNITR") & ",'" & Trim(rstAux2("CODUTRHN")) & "', "
		'''''         strSQL = strSQL & "'" & Trim(rstAux2("INDCONVE")) & "','" & Trim(rstAux2("TIPOUNTR")) & "','" & rstAux2("CARGO") & "')"
		'''''         If mfExecute(conDB2, strSQL, "DB2") = False Then
		'''''            GoTo procErr
		'''''         End If
		'''''      End If
		'''''      rstAux2.MoveNext
		'''''      DoEvents
		'''''   Wend
		
		'TBPFIN04
		blnErrUT = False
		lblMensaje.Text = "Comprobado/Volcado de datos en INFRAESTUCTURA (TBPFIN04)"
		strSQL = "SELECT * FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
		rstAux2 = mfRecordset(conPasarela, strSQL)
		If blnErrRecordset = True Then
			GoTo procErr
		End If
		strSQL = "DELETE FROM %owner%TBPFIN04 WHERE CODPROCE=" & rstAux2.Fields("CODPROCE").Value & " AND VERSIONP=" & rstAux2.Fields("VERSIONP").Value
		
		If mfExecute(conDB2, strSQL, "DB2") = False Then
			GoTo procErr
		End If
		While Not rstAux2.EOF
			If rstAux2.Fields("ORDENTRA").Value <> 0 And rstAux2.Fields("ORDENTRA").Value <> 888 Then
				strSQL = "SELECT ELTA_DESC60 FROM TBDCELTA_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ELTA_CLAVE='" & rstAux2.Fields("CODTRAAD").Value & "' AND ELTA_CODTAB='P2'"
				rstAux4 = mfRecordset(conPasarela, strSQL)
				'cambio septiembre 2008
				'strSQL = "SELECT AUX FROM TBDCELTA_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ELTA_DESC60='" & rstAux4("ELTA_DESC60") & "'"
				strSQL = "SELECT AUX FROM TBDCELTA_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ELTA_DESC60='" & rstAux4.Fields("ELTA_DESC60").Value & "' AND ELTA_CODTAB='P2'"
				rstAux4 = mfRecordset(conPasarela, strSQL)
				'CAMBIO PROVISIONAL UT
				strSQL = "SELECT * FROM %owner%TBPFIN23 WHERE CODUTRHN='" & rstAux2.Fields("CODUTRHN").Value & "'"
				rstAux5 = mfRecordset(conDB2, strSQL, "DB2")
				If Not rstAux5.EOF Then
					strSQL = "INSERT INTO %owner%TBPFIN04 (CODPROCE, VERSIONP, ORDENTRA, CODTRAAD, "
					strSQL = strSQL & "CODUNITR, INDTRAMI, INDCOMUN) VALUES ("
					strSQL = strSQL & Trim(rstAux2.Fields("CODPROCE").Value) & "," & Trim(rstAux2.Fields("VERSIONP").Value) & ","
					strSQL = strSQL & Trim(rstAux2.Fields("ORDENTRA").Value) & ", " & Trim(snulo(rstAux4.Fields("AUX").Value & "")) & ", "
					strSQL = strSQL & Trim(rstAux5.Fields("CODUNITR").Value) & ", '" & Trim(rstAux2.Fields("INDTRAMI").Value) & "', "
					'strSQL = strSQL & Trim(rstAux2("CODUNITR")) & ", '" & Trim(rstAux2("INDTRAMI")) & "', "
					strSQL = strSQL & "'" & Trim(rstAux2.Fields("INDCOMUN").Value) & "')"
				Else
					Insertar_Error(Me, "Cambio UT", "No se encuentra la UT " & Trim(rstAux2.Fields("CODUTRHN").Value), "msCargarInfraestructura")
					blnErrUT = True
				End If
			Else
				strSQL = "SELECT * FROM %owner%TBPFIN23 WHERE CODUTRHN='" & rstAux2.Fields("CODUTRHN").Value & "'"
				rstAux5 = mfRecordset(conDB2, strSQL, "DB2")
				If Not rstAux5.EOF Then
					If rstAux2.Fields("ORDENTRA").Value = 888 Then
						strSQL = "INSERT INTO %owner%TBPFIN04 (CODPROCE, VERSIONP, ORDENTRA, CODTRAAD, CODUNITR, INDTRAMI, INDCOMUN) VALUES (" & Trim(rstAux2.Fields("CODPROCE").Value) & "," & Trim(rstAux2.Fields("VERSIONP").Value) & "," & Trim(rstAux2.Fields("ORDENTRA").Value) & ", 888888, " & Trim(rstAux5.Fields("CODUNITR").Value) & ", '" & Trim(rstAux2.Fields("INDTRAMI").Value) & "', " & "'" & Trim(rstAux2.Fields("INDCOMUN").Value) & "')"
					Else
						strSQL = "INSERT INTO %owner%TBPFIN04 (CODPROCE, VERSIONP, ORDENTRA, CODTRAAD, CODUNITR, INDTRAMI, INDCOMUN) VALUES (" & Trim(rstAux2.Fields("CODPROCE").Value) & "," & Trim(rstAux2.Fields("VERSIONP").Value) & "," & Trim(rstAux2.Fields("ORDENTRA").Value) & ", 0, " & Trim(rstAux5.Fields("CODUNITR").Value) & ", '" & Trim(rstAux2.Fields("INDTRAMI").Value) & "', '" & Trim(rstAux2.Fields("INDCOMUN").Value) & "')"
					End If
				Else
					Insertar_Error(Me, "Cambio UT", "No se encuentra la UT " & Trim(rstAux2.Fields("CODUTRHN").Value), "msCargarInfraestructura")
					blnErrUT = True
				End If
			End If
			msProceso(rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 6, 8)
			
			If mfExecute(conDB2, strSQL, "DB2") = False Then
				GoTo procErr
			End If
			rstAux2.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		'ponemos el rollbacktrans para aque no se ejecute, pq solo es una prueba
		If blnErrUT = True Then GoTo procErr
		conDB2.CommitTrans()
vuelta: 
		lblMensaje.Text = "Actualizando datos en Flujo de HIDRANET"
		msProceso(rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 7, 8)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		strSQL = "SELECT * FROM WFFLOWACTIONS WHERE rtrim(flow)='" & gNomProcCorto & "' AND PARAM='@CODTRAAD' AND VALUE<>'0'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			If rstAux.AbsolutePosition Mod 25 = 0 Then
				System.Windows.Forms.Application.DoEvents()
			End If
			strSQL = "SELECT AUX FROM TBDCELTA_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ELTA_CLAVE='" & CStr(rstAux.Fields("VALUE").Value) & "' AND ELTA_IDIOMA='C' and ELTA_CODTAB='P2'"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			If Not rstAux2.EOF Then
				'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
				strSQL = "UPDATE WFFLOWACTIONS SET VALUE='" & IIf(IsDbNull(rstAux2.Fields("AUX").Value), "", Trim(CStr(rstAux2.Fields("AUX").Value & ""))) & "' "
				strSQL = strSQL & "WHERE FLOW='" & Trim(rstAux.Fields("FLOW").Value) & "' AND VERSION='" & rstAux.Fields("VERSION").Value & "' AND "
				strSQL = strSQL & "FLOWORDER=" & rstAux.Fields("FLOWORDER").Value & " AND ID=" & rstAux.Fields("ID").Value & " AND "
				strSQL = strSQL & "ACTION='" & Trim(rstAux.Fields("ACTION").Value) & "' AND PATH='" & Trim(rstAux.Fields("PATH").Value) & "' AND "
				strSQL = strSQL & "PARAM='" & Trim(rstAux.Fields("PARAM").Value) & "'"
				mfExecute(conPasarela, strSQL)
			End If
			rstAux.MoveNext()
		End While
		conDB2.Close()
		conDB2.Open(conDB2.ConnectionString)
		msProceso(rstAux2.AbsolutePosition, rstAux2.RecordCount + 1, 8, 8)
		'****????¿¿¿¿****
		'Inicio Jonathan Prieto 28/06/2013
		'strSQL = "select * from tbpfin23_pa where procedimiento='" & gNomProcCorto & "' and codunitr  in (select distinct value from wfflowactions where flow='" & gNomProcCorto & "' and param ='@CODUNITR' and value not like '%INICIO%')"
		strSQL = "select * from tbpfin23_pa where procedimiento='" & gNomProcCorto & "' and codunitr in ( " & "select distinct(cast(value as numeric)) from wfflowactions " & "where flow='" & gNomProcCorto & "' and param ='@CODUNITR' and value not like '%INICIO%')"
		'Fin Jonathan Prieto 28/06/2013
		rstAux2 = mfRecordset(conPasarela, strSQL)
		While Not rstAux2.EOF
			strSQL = "SELECT CODUNITR FROM %owner%TBPFIN23 WHERE CODUTRHN='" & rstAux2.Fields("CODUTRHN").Value & "'"
			rstAux = mfRecordset(conDB2, strSQL, "DB2")
			strSQL = "UPDATE WFFLOWACTIONS SET VALUE='" & rstAux.Fields("CODUNITR").Value & "' where flow='" & gNomProcCorto & "' and param ='@CODUNITR' and value = '" & rstAux2.Fields("CODUNITR").Value & "'"
			mfExecute(conPasarela, strSQL)
			rstAux2.MoveNext()
		End While
		rstAux.Close()
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		rstAux2.Close()
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		CierraCN(conDB2)
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		
		If Err.Number = -2147467259 Or Err.Number = 3704 Then
			System.Windows.Forms.Application.DoEvents()
			GoTo vuelta
		End If
		If blnCancelar = True Then Exit Sub
		If blnErrUT = False Then
			MsgBox("Ha ocurrido un error al volcar los datos de PASARELA a INFRAESTRUCTURA", MsgBoxStyle.Critical)
		End If
		
		conDB2.RollbackTrans()
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		CierraCN(conDB2)
		If blnErrUT = False Then
			Insertar_Error(Me, "Carga Infraestructura", "Ha ocurrido un error no controlado", "msCargarInfraestructura")
			Mostrar_Error()
			logError("msCargarInfraestructura - " & Err.Description)
		End If
		tramiteAnterior = ""
		Me.Close()
		If blnErrUT = False Then
			Resume procFin
		Else
			GoTo procFin
		End If
procFin: 
		
	End Sub
	
	
	Private Function msVariablesInfra() As Object
		
		On Error GoTo procErr
		
		Dim rst As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim strSQL As String
		Dim strSQL2 As String
		
		conInfra.BeginTrans()
		strSQL = "SELECT * FROM VARIABLES_PA WHERE FAMILIA='" & strFamil & "'"
		lblMensaje.Text = "Comprobado/Volcado de variables en INFRAESTUCTURA"
		rst = mfRecordset(conPasarela, strSQL)
		While Not rst.EOF
			msProceso(rst.AbsolutePosition, rst.RecordCount + 1, 1, 2)
			strSQL = "SELECT * FROM VARIABLES WHERE IDATRIBU=" & rst.Fields("IDATRIBU").Value
			rst2 = mfRecordset(conInfra, strSQL)
			If rst2.EOF Then
				strSQL = "INSERT INTO VARIABLES (IDATRIBU, DESATRIB, CODHIDRA,INDTIPOA, "
				strSQL = strSQL & "INDCTA,DESCATRI, DESEATRI) VALUES ("
				strSQL = strSQL & rst.Fields("IDATRIBU").Value & ", '" & Replace(rst.Fields("DESATRIB").Value, "'", "''") & "','" & rst.Fields("CODHIDRA").Value & "', "
				strSQL = strSQL & "'" & rst.Fields("INDTIPOA").Value & "', '" & rst.Fields("INDCTA").Value & "', '" & rst.Fields("DESCATRI").Value & "',"
				strSQL = strSQL & "'" & rst.Fields("DESEATRI").Value & "')"
				If mfExecute(conInfra, strSQL) = False Then GoTo procErr
			Else
				'Inicio Jonathan - 03/07/2012 - Escapar comillas simples
				If rst.Fields("DESATRIB").Value <> rst2.Fields("DESATRIB").Value Then
					strSQL = "UPDATE VARIABLES SET DESATRIB= '" & Replace(rst.Fields("DESATRIB").Value, "'", "''") & "'"
					If rst2.Fields("DESCATRI").Value = "" Then
						strSQL = strSQL & ", DESCATRI='" & Replace(rst.Fields("DESCATRI").Value, "'", "''") & "'"
					End If
					If rst2.Fields("DESEATRI").Value = "" Then
						strSQL = strSQL & ", DESEATRI='" & Replace(rst.Fields("DESEATRI").Value, "'", "''") & "'"
					End If
					strSQL = strSQL & " WHERE IDATRIBU=" & rst.Fields("IDATRIBU").Value
					If mfExecute(conInfra, strSQL) = False Then GoTo procErr
				End If
				'Fin Jonathan - 03/07/2012 - Escapar comillas simples
			End If
			rst.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		lblMensaje.Text = "Comprobado/Volcado de variables de ALTA en INFRAESTUCTURA"
		strSQL = "DELETE FROM VAR_ALTA WHERE NOMPROC='" & Mid(strNombre, 1, lngNombre) & "'"
		mfExecute(conInfra, strSQL)
		strSQL = "SELECT * FROM VAR_ALTA_PA WHERE NOMPROC='" & Mid(strNombre, 1, lngNombre) & "'"
		rst = mfRecordset(conPasarela, strSQL)
		While Not rst.EOF
			msProceso(rst.AbsolutePosition, rst.RecordCount + 1, 2, 2)
			strSQL = "INSERT INTO VAR_ALTA (NOMPROC, ORDEN, CODHIDRA) VALUES ('" & rst.Fields("NOMPROC").Value & "', " & rst.Fields("ORDEN").Value & ", '" & rst.Fields("CODHIDRA").Value & "')"
			If mfExecute(conInfra, strSQL) = False Then GoTo procErr
			rst.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		conInfra.CommitTrans()
		GoTo procFin
		
procErr: 
		
		If blnCancelar = True Then Exit Function
		MsgBox("Ha ocurrido un error al volcar los datos de PASARELA a INFRAESTRUCTURA", MsgBoxStyle.Critical)
		
		conInfra.RollbackTrans()
		logError("msVariablesInfra - " & Err.Description)
		GoTo procFin
		
procFin: 
		
	End Function
	
	
	
	Private Sub msCargarFlujo()
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim gblnError As Boolean
		Dim strNomFlujo As String
		Dim strNomBD As Object
		
		''''FALTA LA COPIA DE SEGURIDAD
		
		'Copiar el flujo actual a la tabla de copia de flujos
		'strSQL = "INSERT INTO WFFLOWS_COPIA (FLOW, VERSION, ACTIVE, FLOWNAME, COMMENTS, RUNNING, START, STOPOLDERVERSIONS)" _
		'& " SELECT FLOW, VERSION, ACTIVE, FLOWNAME, COMMENTS, RUNNING, START, STOPOLDERVERSIONS FROM WFFLOWS WHERE FLOW='" & Mid(gNomProc,1,6) & "' AND VERSION=" & SelectedVersion
		'mfExecute conCarga, strSQL
		'conCarga.BeginTrans
		'UPGRADE_WARNING: Couldn't resolve default property of object strNomBD. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strNomBD = Split(Mid(conCarga.ConnectionString, InStr(1, conCarga.ConnectionString, "Initial Catalog=") + 16), ";")
		
		'Borrar el flujo actual
		'strSQL = "DELETE FROM WFFLOWS WHERE FLOW='" & Mid(gNomProc,1,6) & "' AND VERSION=" & SelectedVersion
		'strSQL = "DELETE FROM WFFLOWS WHERE FLOW='" & Selectedflow & "' AND VERSION=" & VersionHidra
		'If mfExecute(conCarga, strSQL) = False Then GoTo ProcErr
		
		
		
		'Volcar los datos de la pasarela a la base de datos del procedimiento en curso.
		strSQL = "SELECT FLOW, VERSION, ACTIVE, FLOWNAME, COMMENTS, RUNNING, START, STOPOLDERVERSIONS FROM WFFLOWS WHERE FLOW='" & gNomProcCorto & "' AND VERSION=" & SelectedVersion
		'strSQL = "SELECT FLOW, VERSION, ACTIVE, FLOWNAME, COMMENTS, RUNNING, START, STOPOLDERVERSIONS FROM WFFLOWS WHERE FLOW='" & Mid(gNomProc,1,6) & "' AND VERSION=" & VersionHidra
		'UPGRADE_NOTE: Object conPasarela may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conPasarela = Nothing
		conPasarela = New ADODB.Connection
		ComprobarConexion(conPasarela, ReadIniFile(INIFile, "PASARELA", "Connection"))
		rstAux = mfRecordset(conPasarela, strSQL)
		'UPGRADE_WARNING: Couldn't resolve default property of object strNomBD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		lblMensaje.Text = "Volcado de flujo " & gNomProcCorto & " en " & strNomBD(0)
		conCarga.BeginTrans()
		If bConexion2 Then
			conCarga2.BeginTrans()
			lblMensaje.Text = "Volcado de flujo " & gNomProcCorto & " en las bases de datos"
		End If
		While Not rstAux.EOF
			msProceso(rstAux.AbsolutePosition, rstAux.RecordCount + 1, 1, 2)
			'*cambio 13/09/2004
			strSQL = " INSERT INTO WFFLOWS(FLOW, VERSION, ACTIVE, FLOWNAME, COMMENTS, RUNNING, START, STOPOLDERVERSIONS)" & " VALUES('" & Trim(rstAux.Fields("FLOW").Value) & "'," & VersionHidra & ", '" & rstAux.Fields("ACTIVE").Value & "', " & "'" & Trim(rstAux.Fields("FLOWNAME").Value) & "', '" & Trim(rstAux.Fields("COMMENTS").Value) & "', '" & rstAux.Fields("RUNNING").Value & "', '" & VB6.Format(CDate(rstAux.Fields("START").Value), ReadIniFile(INIFile, "FECHA", "Formato")) & "', " & "'" & rstAux.Fields("STOPOLDERVERSIONS").Value & "')"
			
			mfExecute(conCarga, strSQL)
			If bConexion2 Then
				mfExecute(conCarga2, strSQL)
			End If
			rstAux.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		conCarga.CommitTrans()
		If bConexion2 Then
			conCarga2.CommitTrans()
		End If
		'Copiar las acciones de flujo actual a la tabla de copia de acciones de flujo
		'strSQL = "INSERT INTO WFFLOWACTIONS_COPIA (FLOW, VERSION, FLOWORDER, ID, [ACTION], PATH, PARAM, [VALUE], COMMENTS)" _
		'& " SELECT FLOW, VERSION, FLOWORDER, ID, [ACTION], PATH, PARAM, [VALUE], COMMENTS FROM WFFLOWACTIONS WHERE FLOW='" & Selectedflow & "' AND VERSION=" & SelectedVersion
		'mfExecute conCarga, strSQL
		'Borrar el flujo actual
		''strSQL = "DELETE FROM WFFLOWACTIONS WHERE FLOW='" & Selectedflow & "' AND VERSION=" & SelectedVersion
		''If mfExecute(conCarga, strSQL) = False Then GoTo ProcErr
		'Volcar los datos de la pasarela a la base de datos del procedimiento en curso.
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		strSQL = "SELECT * FROM WFFLOWACTIONS WHERE FLOW='" & gNomProcCorto & "' AND VERSION=" & SelectedVersion
		rstAux = mfRecordset(conPasarela, strSQL)
		
		While Not rstAux.EOF
			msProceso(rstAux.AbsolutePosition, rstAux.RecordCount + 1, 2, 2)
			strSQL = " INSERT INTO WFFLOWACTIONS(FLOW, VERSION, FLOWORDER, ID, [ACTION], PATH, PARAM, [VALUE], COMMENTS)" & " VALUES('" & Trim(rstAux.Fields("FLOW").Value) & "'," & VersionHidra & ", " & rstAux.Fields("FLOWORDER").Value & ", " & rstAux.Fields("ID").Value & ", '" & Trim(rstAux.Fields("ACTION").Value) & "', '" & Trim(rstAux.Fields("PATH").Value) & "', '" & Trim(rstAux.Fields("PARAM").Value) & "', " & "'" & Trim(rstAux.Fields("VALUE").Value) & "','" & Trim(rstAux.Fields("COMMENTS").Value) & "')"
			If mfExecute(conCarga, strSQL) = False Then
				'GoTo procErr
				System.Windows.Forms.Application.DoEvents()
			End If
			If bConexion2 Then
				If mfExecute(conCarga2, strSQL) = False Then
					System.Windows.Forms.Application.DoEvents()
				End If
			End If
			rstAux.MoveNext()
			System.Windows.Forms.Application.DoEvents()
		End While
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'conCarga.CommitTrans
		If Not gblnError Then
			'MsgBox ("El flujo se ha generado con éxito")
			msProcEnCola()
		End If
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		
		If blnCancelar = True Then Exit Sub
		
		'conCarga.RollbackTrans
		'strSQL = "DELETE FROM FLOWS WHERE FLOW='" & rstAux("FLOW") & "' AND VERSION=" & rstAux("VERSION")
		'mfExecute CARGA, strSQL
		'strSQL = "DELETE FROM WFFLOWACTIONS"
		
		MsgBox(Err.Description & "    msCargarFlujo")
		'conCarga.RollbackTrans
		logError("msCargarFlujo - " & Err.Description)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		gblnError = True
		tramiteAnterior = ""
		Me.Close()
		Resume procFin
procFin: 
	End Sub
	
	
	
	
	
	
	Private Function fInitVar(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		'Inicio Jonathan 09/02/2012
		On Error GoTo procErr
		Dim blnError As Boolean
		Dim rstACC2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngUlt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strSQL As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim codPlaz As String
		Dim colValores As Collection
		Dim blnTruco As Boolean
		Dim blnEncon As Boolean
		Dim rstSalida1 As ADODB.Recordset
		Dim rstSalida2 As ADODB.Recordset
		Dim rstSalida3 As ADODB.Recordset
		Dim strFiltro As String
		
		fInitVar = True
		colXML2 = New Collection : colXML2.Add("Valor")
		colValores = New Collection
		'-----------------------------------------------------------------------------------------------------------------
		'CONECTOR DE SALIDA
		'Obtenemos los conectores de salida de la acción
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		'Obtenemos los conectores de salida de la acción que tienen parámetros en el uso de datos
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_DELETES=1 " & " AND J.MODEL_NAME ='" & strModelo & "' AND C.MODEL_NAME ='" & strModelo & "'"
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		'Si tiene algún conector de salida de la acción con parámetros en el uso de datos obtenemos los parámetros del
		'   primero únicamente (todos deben ser iguales)
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E " & " WHERE C.CO_ID IN (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID " & " AND A.MODEL_NAME ='" & strModelo & "' AND C.MODEL_NAME ='" & strModelo & "' AND E.MODEL_NAME ='" & strModelo & "'" & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
			'Nº de parámetros de salida en el uso de datos del conector de salida
			lngAccConS = rstParamCMS.RecordCount
			rstParamCMS.MoveFirst()
		Else
			'No tiene ningún conector de salida de la acción con parámetros en el uso de datos
			lngAccConS = 0
		End If
		rstAux.Close()
		'-----------------------------------------------------------------------------------------------------------------
		'CONECTOR DE ENTRADA
		'Obtenemos los conectores de entrada de la acción
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		'Obtenemos los conectores de entrada de la acción que tienen parámetros en el uso de datos
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_INSERTS=1 " & " AND J.MODEL_NAME ='" & strModelo & "' AND C.MODEL_NAME ='" & strModelo & "'"
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				strJOINER = strJOINER & rstconE.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		'Si tiene algún conector de entrada de la acción con parámetros en el uso de datos obtenemos los parámetros del
		'   primero únicamente (todos deben ser iguales)
		If strJOINER <> "" Then
			strJOINER = VB.Left(strJOINER, InStr(1, strJOINER, ",") - 1)
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E" & " WHERE C.CO_ID=" & strJOINER & " AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID " & " AND A.MODEL_NAME ='" & strModelo & "' AND C.MODEL_NAME ='" & strModelo & "' AND E.MODEL_NAME ='" & strModelo & "'" & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			'Nº de parámetros de entrada en el uso de datos del conector de entrada
			lngAccConE = rstparamCME.RecordCount
			rstparamCME.MoveFirst()
		Else
			'No tiene ningún conector de entrada de la acción con parámetros en el uso de datos
			lngAccConE = 0
		End If
		rstAux.Close()
		'-----------------------------------------------------------------------------------------------------------------
		'VALIDACIONES
		'1. El conector de salida de la acción debe tener, como mínimo, un parámetro de salida en el uso de datos
		If lngAccConS = 0 Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "El conector de salida de la acción " & Trim(rstAcc.Fields("NOMBRE_CM").Value) & " (" & Trim(rstAcc.Fields("PATH_HIDRA").Value) & ") del trámite " & rstTram.Fields("NOMBRE").Value & " no tiene ningún parámetro de salida.", "fInitVar")
			Mostrar_Error()
			GoTo procFin
		End If
		'2. El conector de entrada de la acción debe tener el mismo número de parámetros de entrada en el uso de datos
		'   que parámetros de salida en el uso de datos del conector de salida de la acción
		If lngAccConE <> lngAccConS Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "No coincide el número de parámetros de los conectores de entrada y salida de la acción " & Trim(rstAcc.Fields("NOMBRE_CM").Value) & " (" & Trim(rstAcc.Fields("PATH_HIDRA").Value) & ") del trámite " & rstTram.Fields("NOMBRE").Value & ".", "fInitVar")
			Mostrar_Error()
			GoTo procFin
		End If
		'-----------------------------------------------------------------------------------------------------------------
		
		blnError = False
		If lngAccConE <> 0 Then
			While Not rstparamCME.EOF
				Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
					Case "Constantes"
						colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
						'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strValorV = colXMLD.Item(1)
						If strValorV = "" Then
							Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "finitVar")
							Mostrar_Error()
						Else
							colValores.Add(strValorV)
						End If
					Case ""
						colValores.Add("")
					Case Else
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
						colValores.Add("@INICIO!" & nomVarHN)
				End Select
				rstparamCME.MoveNext()
			End While
		End If
		If lngAccConS <> 0 Then
			I = 0
			rstparamCME.MoveFirst()
			j = 0
			blnIns = True
			rstParamCMS.MoveFirst()
			I = 0
			While Not rstParamCMS.EOF
				If InStr(1, rstParamCMS.Fields("AT_NAME").Value, "'") > 0 Then
					Insertar_Error(Me, "Lectura de acciones de trámite", "En una inicialización de variables no puede haber una constante como parámetro de salida - " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "finitVar")
					GoTo procFin
				End If
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
				strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAcc.Fields("ORDEN_ACC").Value & " AND PARAMETRO='@" & nomVarHN & "'"
				rstAux6 = mfRecordset(conPasarela, strSQL)
				If Not rstAux6.EOF Then
					strSQL = "DELETE FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAcc.Fields("ORDEN_ACC").Value & " AND PARAMETRO='@" & nomVarHN & "'"
					mfExecute(conPasarela, strSQL)
				End If
				blnInserta = False
				If colValores.Count() = 0 Then
					msInsertaParamAcc("@" & nomVarHN, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value) '+ (2 * i)
				Else
					'UPGRADE_WARNING: Couldn't resolve default property of object colValores(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					msInsertaParamAcc("@" & nomVarHN, colValores.Item(I + 1), rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value) '+ (2 * i)
				End If
				rstParamCMS.MoveNext()
				I = I + 1
			End While
			If rstTram.Fields("SALIDAS").Value = 1 Then
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstAux = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
				
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & rstAcc.Fields("ORDEN_ACC").Value + 1 & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				strSQL = "SELECT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value
				rstAux = mfRecordset(conPasarela, strSQL)
				If Not rstAux.EOF Then
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
					strSQL = strSQL & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
					strSQL = strSQL & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND NUM_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
					rstAux2 = mfRecordset(conPasarela, strSQL)
				End If
				If Not rstAux2.EOF Then
					msInsertaParamAcc("PATH", rstAux2.Fields("PATH_HIDRA").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value + 1)
				Else
					msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value + 1)
				End If
			End If
			blnEncon = True
		End If
		regPlus = 0
		
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & "  AND IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			If Not rstAux.EOF Then
				While Not rstAux.EOF
					'If Trim(rstAux("CAT_CONECTOR2")) = "Fin de Expediente" Then
					'aketza 29/04/2008
					'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
					If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
						'fin aketza
						nomTramS = "PR_FINEXPEDIENTE"
						GoTo aqui
					End If
					strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
					strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
					'Fin Jonathan Prieto 28/10/2010
					rstConS = mfRecordset(conDP4, strSQL)
					If Not rstConS.EOF Then
						If rstTram.Fields("NUM_DIAGRAMA").Value > 1 Then
							strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') and ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value
						Else
							strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') "
						End If
						rstConST = mfRecordset(conPasarela, strSQL)
						'Inicio Jonathan 31/01/2012
						'Obtenemos todos los conectores que salgan del trámite que contiene la acción Inicialización de Variables
						While Not rstConST.EOF
							blnTruco = False
							'Averiguamos si el conector apunta a un trámite o a un evento
							strSQL = "SELECT * FROM SHAPE WHERE MODEL_NAME='" & strModelo & "'" & " AND DI_ID=" & rstTram.Fields("DI_ID").Value & " AND SH_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ANO_TABNR=9097"
							rstSalida1 = mfRecordset(conDP4, strSQL)
							If Not rstSalida1.EOF Then
								If rstTram.Fields("NUM_DIAGRAMA").Value > 1 Then
									'El trámite que contiene la Inicialización está dentro de una ramificación, puede que ésta esté dibujada varias veces
									Select Case rstTram.Fields("NUM_DIAGRAMA").Value
										Case 2
											strFiltro = " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
										Case 3
											strFiltro = " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
										Case 4
											strFiltro = " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
										Case Else
											strFiltro = " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
									End Select
								Else
									strFiltro = vbNullString
								End If
								'Apunta a un evento. Buscamos en cuál de los trámites a los que apunta el objeto padre está dibujado
								strSQL = "SELECT * FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND NUM_SEQ IN (" & " SELECT NUM_SEC_HASTA" & " FROM CONECTORES_DI" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND DI_ID =(" & " SELECT DISTINCT(DI_ID)" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & strFiltro & ")" & " AND NUM_SEC_DESDE =(" & " SELECT DISTINCT(NUM_SEQ)" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & strFiltro & "))" & " AND DI_ID =(" & " SELECT DISTINCT(DI_ID)" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & strFiltro & ")"
								rstSalida2 = mfRecordset(conPasarela, strSQL)
								'Conectores salientes del objeto padre
								While Not rstSalida2.EOF
									If rstSalida2.Fields("EXPLOTA_ACC").Value = "N" Then
										'Apunta a una ramificación. Obtenemos el primer evento del primer trámite de la ramificación.
										strSQL = "SELECT ID_DIAGRAMA FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' "
										Select Case rstSalida2.Fields("NUM_DIAGRAMA").Value
											Case "1"
												strSQL = strSQL & "AND ORDEN_N1=" & rstSalida2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=1"
											Case "2"
												strSQL = strSQL & "AND ORDEN_N1=" & rstSalida2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstSalida2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=1"
											Case "3"
												strSQL = strSQL & "AND ORDEN_N1=" & rstSalida2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstSalida2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstSalida2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=1"
											Case "4"
												strSQL = strSQL & "AND ORDEN_N1=" & rstSalida2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstSalida2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstSalida2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstSalida2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=1"
										End Select
										rstSalida3 = mfRecordset(conPasarela, strSQL)
										If Not rstSalida3.EOF Then
											strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E" & " WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado'" & " AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstSalida3.Fields("ID_DIAGRAMA").Value & " AND A.EV_ID=" & rstConS.Fields("EV_ID").Value & " AND A.MODEL_NAME ='" & strModelo & "' AND B.MODEL_NAME ='" & strModelo & "' AND D.MODEL_NAME ='" & strModelo & "' AND E.MODEL_NAME ='" & strModelo & "' AND E.DI_TYPE <> " & gstrCodTramUsu & " ORDER BY D.SH_Y DESC"
											rstSalida3 = mfRecordset(conDP4, strSQL)
											If Not rstSalida3.EOF Then
												'Ya hemos encontrado el trámite que contiene el evento
												blnfin = True
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
												rstAux2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
												strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
												rstAux2 = mfRecordset(conPasarela, strSQL)
												While Not rstAux2.EOF
													strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL)
													lngUlt = rstAux2.Fields("ORDEN_ACC").Value
													
													strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL)
													
													rstAux2.MoveNext()
												End While
												If lngUlt <> 0 Then
													lngORACC = lngUlt
												Else
													strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
													rstAux3 = mfRecordset(conPasarela, strSQL)
													lngORACC = rstAux3.Fields(0).Value + 1
												End If
												mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
												blnInserta = False
												strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux2 = mfRecordset(conPasarela, strSQL)
												If Not rstAux2.EOF Then
													nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
												Else
													nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
												End If
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstSalida2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstSalida2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstSalida2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstSalida2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstSalida2.Fields("ORDEN_N5").Value
												rstAux2 = mfRecordset(conPasarela, strSQL)
												If Not rstAux2.EOF Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
												End If
												msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
												rstACC2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
												lngORACC = lngORACC + 1
												mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
												blnInserta = False
												blnIns = True
												regPlus = regPlus + 1 '
												msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
												GoTo FIN
											End If
										End If
									Else
										'Apunta a un trámite.
										strSQL = "SELECT * FROM SHAPE WHERE MODEL_NAME='" & strModelo & "'" & " AND ANO_TABNR=9097 AND ANO_ID=" & rstConS.Fields("EV_ID").Value & " AND DI_ID=" & " (SELECT DI_ID FROM DIAGRAM WHERE MODEL_NAME='" & strModelo & "'" & " AND ANO_ID=" & rstSalida2.Fields("ID_DIAGRAMA").Value & " AND ANO_TABNR=8953" & " AND DI_TYPE<>" & gstrCodTramUsu & ")"
										rstSalida3 = mfRecordset(conDP4, strSQL)
										If Not rstSalida3.EOF Then
											'Ya hemos encontrado el trámite que contiene el evento
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												
												strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstSalida2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstSalida2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstSalida2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstSalida2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstSalida2.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											GoTo FIN
										End If
									End If
									rstSalida2.MoveNext()
								End While
							Else
								'No apunta a un evento. Averiguamos si apunta a un trámite
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
								rstTRAMS = mfRecordset(conPasarela, strSQL)
								blnTruco = False
								While Not rstTRAMS.EOF
here: 
									If blnTruco = True Then
										strSQL = "SELECT A.EV_ID, D.SH_SEQ FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value
										' **** NUEVO SD ENERO'08
										strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
									Else
										strSQL = "SELECT A.EV_ID, D.SH_SEQ FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & "  AND A.EV_ID=" & rstConS.Fields("EV_ID").Value
										' **** NUEVO SD ENERO'08
										strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
										strSQL = strSQL & " ORDER BY D.SH_Y DESC"
									End If
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											'comprobación de entrada no de salida.
											
											strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
											strSQL = strSQL & "ID_DIAGRAMA = " & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND "
											strSQL = strSQL & "NUM_SEQ_HASTA = " & rstAux3.Fields(1).Value & " AND "
											strSQL = strSQL & "IND_SALIDA_TRAM='S'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												GoTo SIG
											End If
											
											
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												
												strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,
											'NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ",
											'" & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & ",
											'" & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & Format(lngNumAcc, "00") & "')"
											'mfExecute conPasarela, strSQL
											mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											If nomTramS = "" Then
												If rstAux2.Fields("ORDEN_N2").Value = 0 Then
													strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
													strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
													strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
													strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												End If
												rstAux2 = mfRecordset(conPasarela, strSQL)
												Do While Not rstAux2.EOF
													If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
														nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
														Exit Do
													End If
													rstAux2.MoveNext()
													nomTramS = "PR_FINEXPEDIENTE"
												Loop 
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
											'mfExecute conPasarela, strSQL
											mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											GoTo FIN
										Else
											If blnTruco = False Then
												blnTruco = True
												GoTo here
											End If
										End If
									Else
										If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
											strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
											If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
												strSQL = strSQL & " AND ORDEN_N2=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
											End If
											If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
												strSQL = strSQL & " AND ORDEN_N3=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
											End If
											If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
												strSQL = strSQL & " AND ORDEN_N4=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
											End If
											If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
												strSQL = strSQL & " AND ORDEN_N5=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
											End If
											rstAux4 = mfRecordset(conPasarela, strSQL)
											strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND "
											strSQL = strSQL & "D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND "
											strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
											' **** NUEVO SD ENERO'08
											strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
											'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
											strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
											'Fin Jonathan Prieto 28/10/2010
											rstAux3 = mfRecordset(conDP4, strSQL)
											If Not rstAux3.EOF Then
												If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
													blnfin = True
													strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
													rstAux2 = mfRecordset(conPasarela, strSQL)
													lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
													strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " and ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
													rstAux2 = mfRecordset(conPasarela, strSQL)
													While Not rstAux2.EOF
														strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
														mfExecute(conPasarela, strSQL)
														lngUlt = rstAux2.Fields("ORDEN_ACC").Value
														strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
														mfExecute(conPasarela, strSQL)
														rstAux2.MoveNext()
													End While
													If lngUlt <> 0 Then
														lngORACC = lngUlt
													Else
														strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
														rstAux3 = mfRecordset(conPasarela, strSQL)
														lngORACC = rstAux3.Fields(0).Value + 1
													End If
													
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
													mfExecute(conPasarela, strSQL)
													blnInserta = False
													strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
													rstAux2 = mfRecordset(conPasarela, strSQL)
													If Not rstAux2.EOF Then
														nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
													Else
														nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
													End If
													strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
													rstAux2 = mfRecordset(conPasarela, strSQL)
													If Not rstAux2.EOF Then
														nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Else
														nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
													End If
													msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
													strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
													rstACC2 = mfRecordset(conPasarela, strSQL)
													lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
													lngORACC = lngORACC + 1
													'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
													'mfExecute conPasarela, strSQL
													mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
													blnInserta = False
													blnIns = True
													regPlus = regPlus + 1 '
													msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
													GoTo FIN
												End If
											End If
										End If
									End If
									rstTRAMS.MoveNext()
								End While
							End If
SIG: 
							rstConST.MoveNext()
						End While
						'Fin Jonathan 31/01/2012
					End If
					rstAux.MoveNext()
				End While
			Else
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstAux5 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux5.Fields(0).Value & "") + 1
				'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & rstAcc("ORDEN_ACC") + 1 & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
				'mfExecute conPasarela, strSQL
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value + 1, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
				strSQL = "SELECT NUM_SEQ_HASTA FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value
				rstAux5 = mfRecordset(conPasarela, strSQL)
				If Not rstAux5.EOF Then
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND NUM_SEQ=" & rstAux5.Fields("NUM_SEQ_HASTA").Value
					rstAux2 = mfRecordset(conPasarela, strSQL)
				End If
				'CAMBIOS 11/2007
				blnInserta = False
				
				
				If Not rstAux2.EOF Then
					msInsertaParamAcc("PATH", rstAux2.Fields("PATH_HIDRA").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value + 1)
				Else
					msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value + 1)
				End If
				regPlus = 1
				blnIns = True
			End If
			
			'    'Inicio Jonathan Prieto 16/08/2011
			'    'Buscar en el nivel superior
			'    strSQL = "SELECT * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1")
			'    If rstTram("ORDEN_N3") = 0 Then
			'        strSQL = strSQL & " AND ORDEN_N2=0"
			'        Set rstTRAMS = mfRecordset(conPasarela, strSQL)
			'        '
			'        strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEC_DESDE = " & rstTRAMS("NUM_SEQ")
			'        Set rstAux3 = mfRecordset(conPasarela, strSQL)
			'    ElseIf rstTram("ORDEN_N4") = 0 Then
			'        strSQL = strSQL & " and ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=0"
			'        Set rstTRAMS = mfRecordset(conPasarela, strSQL)
			'        '
			'        strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEC_DESDE = " & rstTRAMS("NUM_SEQ") & " AND ORDEN_N1=" & rstTram("ORDEN_N1")
			'        Set rstAux3 = mfRecordset(conPasarela, strSQL)
			'    ElseIf rstTram("ORDEN_N5") = 0 Then
			'        strSQL = strSQL & " and ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=0"
			'        Set rstTRAMS = mfRecordset(conPasarela, strSQL)
			'        '
			'        strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEC_DESDE = " & rstTRAMS("NUM_SEQ") & "AND ORDEN_N1=" & rstTram("ORDEN_N1")
			'        Set rstAux3 = mfRecordset(conPasarela, strSQL)
			'    Else
			'        strSQL = strSQL & " and ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=0"
			'        Set rstTRAMS = mfRecordset(conPasarela, strSQL)
			'        '
			'        strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEC_DESDE = " & rstTRAMS("NUM_SEQ") & "AND ORDEN_N1=" & rstTram("ORDEN_N1")
			'        Set rstAux3 = mfRecordset(conPasarela, strSQL)
			'    End If
			'
			'    While Not rstAux3.EOF
			'        strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rstTRAMS("NUM_DIAGRAMA") & " AND NUM_SEQ=" & rstAux3("NUM_SEC_HASTA")
			'        Set rstAux4 = mfRecordset(conPasarela, strSQL)
			'        If Not rstAux4.EOF Then
			'            strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4("ID_DIAGRAMA")
			'            strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
			'            strSQL = strSQL & " ORDER BY D.SH_Y DESC"
			'            Set rstAux5 = mfRecordset(conDP4, strSQL)
			'            If rstAux5("EV_ID") = rstConS("EV_ID") Then
			'                strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4("ORDEN_N1") & " AND ORDEN_N2=" & rstAux4("ORDEN_N2") & " AND ORDEN_N3=" & rstAux4("ORDEN_N3") & " AND ORDEN_N4=" & rstAux4("ORDEN_N4") & " AND ORDEN_N5=" & rstAux4("ORDEN_N5") & ""
			'                Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'                nomTramS = rstAux2("NOM_DIAGRAMA")
			'                '
			'                strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
			'                Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'                lngNumAcc = Val(rstAux2(0)) + 1
			'                strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") & " AND ORDEN_ACC>" & rstAcc("ORDEN_ACC") & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
			'                Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'                While Not rstAux2.EOF
			'                   strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND ORDEN_N4=" & rstAux2("ORDEN_N4") & " AND ORDEN_N5=" & rstAux2("ORDEN_N5") & " AND ORDEN_ACC=" & rstAux2("ORDEN_ACC")
			'                   mfExecute conPasarela, strSQL
			'                   strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND ORDEN_N4=" & rstAux2("ORDEN_N4") & " AND ORDEN_N5=" & rstAux2("ORDEN_N5") & " AND ORDEN_ACC=" & rstAux2("ORDEN_ACC")
			'                   mfExecute conPasarela, strSQL
			'                   rstAux2.MoveNext
			'                Wend
			'                lngORACC = rstAcc("ORDEN_ACC") + 1
			'                mfInserta_ACCIONES rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC") + 1, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                blnInserta = False
			'                strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5")
			'                Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'                If Not rstAux2.EOF Then
			'                   nomTram = "@LET" & Mid(rstAux2("NOM_DIAGRAMA"), 1, 17) & Mid(rstAux2("NOM_DIAGRAMA"), Len(rstAux2("NOM_DIAGRAMA")) - 3)
			'                Else
			'                   nomTram = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
			'                End If
			'                msInsertaParamAcc nomTram, nomTramS, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
			'                strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
			'                Set rstACC2 = mfRecordset(conPasarela, strSQL)
			'                lngNumAcc = Val(rstACC2(0) & "") + 1
			'                lngORACC = lngORACC + 1
			'                mfInserta_ACCIONES rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                blnInserta = False
			'                msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
			'                blnIns = True: regPlus = 1
			'                GoTo FIN
			'            End If
			'        End If
			'        rstAux3.MoveNext
			'    Wend
			'    'Fin Jonathan Prieto 16/08/2011
			
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 1
				'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & Format(lngNumAcc, "00") & "')"
				'mfExecute conPasarela, strSQL
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value + 1, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
				'mfExecute conPasarela, strSQL
				mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True : regPlus = 1
				GoTo FIN
			End If
		Else
			'nada
		End If
		
FIN: 
		If regPlus <> 0 Then regPlus = 1
		If blnEncon = True Then regPlus = 1
		GoTo procFin
		
procErr: 
		
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Inicialización Variables", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "finitVar")
		Mostrar_Error()
		logError("fInitVar- " & Err.Description)
		Resume procFin
		
procFin: 
		'Fin Jonathan 09/02/2012
	End Function
	
	
	Private Function fSin_Implementacion(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer, Optional ByVal blnCompletarParametrosVacios As Boolean = False) As Boolean
		
		On Error GoTo procErr
		
		Dim blnError As Boolean
		Dim rstACC2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim lngUlt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim blnPrim As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strSQL As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim codPlaz As String
		Dim colValores As Collection
		Dim blnTruco As Boolean
		Dim blnEncon As Boolean
		Dim strAuxiliar As String
		Dim blnSalto As Boolean
		Dim blnSalto2 As Boolean
		Dim blnSalto1 As Boolean
		Dim strsalto As String
		Dim seq1 As Integer
		Dim seq2 As Integer
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		If rstAcc.Fields(1).Value & "-" & rstAcc.Fields(2).Value & "-" & rstAcc.Fields(3).Value = "4-2-3" Then
			'Debug.Print rstAcc("NOM_ACCION")
			System.Windows.Forms.Application.DoEvents()
		End If
		fSin_Implementacion = True
		If ((lngAccCME + lngAccCMS) <> lngacc) Then
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fSin_Implementacion")
			Mostrar_Error()
			fSin_Implementacion = False
		Else
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
			rstAux = mfRecordset(conPasarela, strSQL)
			strJOINER = ""
			While Not rstAux.EOF
				strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				
				rstconE = mfRecordset(conDP4, strSQL)
				If Not rstconE.EOF Then
					strJOINER = strJOINER & rstconE.Fields(0).Value & ","
				End If
				rstAux.MoveNext()
			End While
			If strJOINER <> "" Then
				strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
				If rstconE.EOF Then
					strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID =" & strJOINER & " AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " ORDER BY C.DM_SEQ"
				Else
					strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID =(" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " ORDER BY C.DM_SEQ"
				End If
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
				lngAccConE = rstparamCME.RecordCount
				rstparamCME.MoveFirst()
			Else
				lngAccConE = 0
			End If
			rstAux.Close()
			If lngAccConE <> 0 Then
				System.Windows.Forms.Application.DoEvents()
				If lngAccCME = lngAccConE Then
					rstparamCME.MoveFirst()
					While Not rstparamCME.EOF
						Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
							Case "Constantes"
								colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strValorV = colXMLD.Item(1)
								If strValorV = "" Then
									Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", "") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "Sin_Implementacion")
									Mostrar_Error()
									fSin_Implementacion = False
								Else
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								End If
							Case ""
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							Case Else
								'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						End Select
						rstparamCME.MoveNext() : rstparamHN.MoveNext()
					End While
				Else
					If blnCompletarParametrosVacios = True Then
						rstparamCME.MoveFirst()
						While Not rstparamCME.EOF
							Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
								Case "Constantes"
									colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
									'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strValorV = colXMLD.Item(1)
									If strValorV = "" Then
										Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", "") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fSin_Implementacion")
										Mostrar_Error()
										fSin_Implementacion = False
									Else
										msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
									End If
								Case ""
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								Case Else
									'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End Select
							rstparamCME.MoveNext() : rstparamHN.MoveNext()
						End While
						For I = rstparamCME.RecordCount + 1 To lngAccCME
							'Inicio Jonathan Prieto 18/08/2011
							If strVarVacio <> vbNullString Then
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & strVarVacio, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, vbNullString, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
							'               'strModelo
							'               '## DS66 20/10/09
							'               If strModelo = "ARDATZ" Then
							'                  msInsertaParamAcc rstparamHN("PARAM"), "@INICIO!VAR1038", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							'               Else
							'                  msInsertaParamAcc rstparamHN("PARAM"), "@INICIO!VAR24", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							'               End If
							'               '##
							'                  'msInsertaParamAcc rstparamHN("PARAM"), "@INICIO!VAR24", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							'Fin Jonathan Prieto 18/08/2011
							rstparamHN.MoveNext()
						Next I
					Else
						Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fSin_Implementacion")
						Mostrar_Error()
						fSin_Implementacion = False
					End If
				End If
			Else
				While Not rstParCME.EOF
					'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					rstParCME.MoveNext() : rstparamHN.MoveNext()
				End While
			End If
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
			rstAux = mfRecordset(conPasarela, strSQL)
			strJOINER = ""
			While Not rstAux.EOF
				strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strJOINER = strJOINER & rstConS.Fields(0).Value & ","
				End If
				rstAux.MoveNext()
			End While
			If strJOINER <> "" Then
				strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID =(" & rstConS.Fields("ANO_ID").Value & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
				System.Windows.Forms.Application.DoEvents()
				lngAccConS = rstParamCMS.RecordCount
				System.Windows.Forms.Application.DoEvents()
				rstParamCMS.MoveFirst()
			Else
				lngAccConS = 0
			End If
			rstAux.Close()
			If lngAccConS <> 0 Then
				System.Windows.Forms.Application.DoEvents()
				If lngAccCMS = lngAccConS Then
					rstParamCMS.MoveFirst()
					While Not rstParamCMS.EOF
						Select Case rstParamCMS.Fields("EN_NAME").Value
							Case "Constantes"
								colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strValorV = colXMLD.Item(1)
								If strValorV = "" Then
									Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fSin_Implementacion")
									Mostrar_Error()
									fSin_Implementacion = False
								Else
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								End If
							Case ""
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							Case Else
								'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						End Select
						rstParamCMS.MoveNext() : rstparamHN.MoveNext()
					End While
				Else
					If blnCompletarParametrosVacios = True Then
						rstParamCMS.MoveFirst()
						While Not rstParamCMS.EOF
							Select Case rstParamCMS.Fields("EN_NAME").Value
								Case "Constantes"
									colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
									'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strValorV = colXMLD.Item(1)
									If strValorV = "" Then
										Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", "") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fSin_Implementacion")
										Mostrar_Error()
										fSin_Implementacion = False
									Else
										msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
									End If
								Case ""
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								Case Else
									'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End Select
							rstParamCMS.MoveNext() : rstparamHN.MoveNext()
						End While
						For I = rstParamCMS.RecordCount + 1 To lngAccCMS
							'Inicio Jonathan Prieto 18/08/2011
							If strVarVacio <> vbNullString Then
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & strVarVacio, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, vbNullString, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
							'            'strModelo
							'               '## DS66 20/10/09
							'               If strModelo = "ARDATZ" Then
							'                  msInsertaParamAcc rstparamHN("PARAM"), "@VAR1038", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							'               Else
							'                  msInsertaParamAcc rstparamHN("PARAM"), "@VAR24", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							'               End If
							'               '##
							'               'msInsertaParamAcc rstparamHN("PARAM"), "@VAR24", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), rstAcc("ORDEN_ACC")
							'Fin Jonathan Prieto 18/08/2011
							rstparamHN.MoveNext()
						Next I
					Else
						Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fSin_Implementacion")
						Mostrar_Error()
						fSin_Implementacion = False
					End If
				End If
			Else
				While Not rstParCMS.EOF
					'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					rstParCMS.MoveNext() : rstparamHN.MoveNext()
				End While
			End If
			If rstParCMS.RecordCount = 0 And rstParCME.RecordCount = 0 And lngAccConS = 0 And lngAccConE = 0 Then
				msInsertaParamAcc("", "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			End If
			blnfin = False
			If Trim(rstAcc.Fields("NOM_ACCION").Value) = "ANEXARFACUSERECIBO" Then
				strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAcc.Fields("ORDEN_ACC").Value & " AND PARAMETRO='@CODIGODOCUMENTO'"
				rstAux = mfRecordset(conPasarela, strSQL)
				If Not rstAux.EOF Then
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND NOM_ACCION='TRAMITEPDTE'"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					If Not rstAux2.EOF Then
						msInsertaParamAcc("@CODDOCUM", rstAux.Fields("VALOR").Value, rstAux2.Fields("ORDEN_N1").Value, rstAux2.Fields("ORDEN_N2").Value, rstAux2.Fields("ORDEN_N3").Value, rstAux2.Fields("ORDEN_N4").Value, rstAux2.Fields("ORDEN_N5").Value, rstAux2.Fields("ORDEN_ACC").Value)
					End If
				End If
			End If
			If rstTram.Fields("SALIDAS").Value > 1 Then
				strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='S' "
				rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
				While Not rstAux.EOF
					'         If Trim(rstAux("CAT_CONECTOR2")) = "Fin de Expediente" Then
					'aketza 29/04/2008
					'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
					If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
						'fin aketza
						nomTramS = "PR_FINEXPEDIENTE"
						GoTo aqui
					End If
					strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
					
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
					strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
					'Fin Jonathan Prieto 28/10/2010
					rstConS = mfRecordset(conDP4, strSQL)
					If Not rstConS.EOF Then
						If rstTram.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "SELECT distinct NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2')"
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "SELECT distinct NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') AND ORDEN_N1= " & rstTram.Fields("ORDEN_N1").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "SELECT distinct NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') AND ORDEN_N1= " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "SELECT distinct NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') AND ORDEN_N1= " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 5 Then 
							strSQL = "SELECT distinct NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2') AND ORDEN_N1= " & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
						End If
						rstConST = mfRecordset(conPasarela, strSQL)
						While Not rstConST.EOF
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstTram.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							If rstTram.Fields("NUM_DIAGRAMA").Value = 1 Then
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
								strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
							ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 2 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
								strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
							ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
								strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
							ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 4 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
								strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
							ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 5 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
								strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
							End If
							rstTRAMS = mfRecordset(conPasarela, strSQL)
							If rstTRAMS.RecordCount > 1 Then
								rstTRAMS.Filter = "ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
							End If
							If rstTRAMS.RecordCount = 0 Then
								rstTRAMS.Filter = ""
							End If
							If Not rstTRAMS.EOF Then
								While Not rstTRAMS.EOF
									strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND E.DI_TYPE <> 1 "
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									strSQL = strSQL & "ORDER BY D.SH_Y DESC"
saltotrucado: 
									If rstTRAMS.EOF Then
										strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_PADRE").Value
										' **** NUEVO SD ENERO'08
										strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
										strSQL = strSQL & " ORDER BY D.SH_Y ASC"
									End If
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strAuxiliar = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION "
											If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
												strSQL = strAuxiliar & " = 'LET INICIALIZACIONVAR'"
											Else
												strSQL = strAuxiliar & " like '" & strsalto & "SALTO%'"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											j = j + 1
											If blnSalto = False And (blnSalto1 = False And blnSalto2 = False) Then
												'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & Format(lngNumAcc, "00") & "')"
												mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, "LET INICIALIZACIONVAR", lngNumAcc, "", "LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
											Else
												'strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'" & strsalto & "SALTO" & Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & Format(2, "00") & "')"
												mfInserta_ACCIONES(rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, 0, strsalto & "SALTO" & VB6.Format(2, "00"), lngNumAcc, "", strsalto & "SALTO" & VB6.Format(2, "00"), 0, 0, "", "", "")
											End If
											'mfExecute conPasarela, strSQL
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											If Not rstTRAMS.EOF Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
											Else
												If rstTram.Fields("NUM_DIAGRAMA").Value >= 3 Then
													strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=0"
												Else
													strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=0"
												End If
												rstAux4 = mfRecordset(conPasarela, strSQL)
												If rstTram.Fields("NUM_DIAGRAMA").Value >= 3 Then
													strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DI_ID=" & rstAux4.Fields("DI_ID").Value & " AND NUM_SEC_DESDE=" & rstAux4.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2')"
												Else
													strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux4.Fields("DI_ID").Value & " AND NUM_SEC_DESDE=" & rstAux4.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR) not in ('Conector Opcional','Fin de plazo 2')"
												End If
												rstAux5 = mfRecordset(conPasarela, strSQL)
												If rstAux5.EOF Then
													nomTramS = "ENLACE SIN DEFINIR"
													GoTo meteramas
												End If
												strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux5.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstAux4.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												rstAux6 = mfRecordset(conPasarela, strSQL)
												If rstAux6.EOF Then
													If Not rstAux5.EOF Then
														rstAux5.MoveNext()
														If rstAux5.EOF Then
															nomTramS = "ENLACE SIN DEFINIR"
															'nomTramS = "PR_FINEXPEDIENTE"
															GoTo meteramas
														End If
														strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux5.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstAux4.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
														rstAux6 = mfRecordset(conPasarela, strSQL)
													End If
												End If
												If rstAux6.EOF Then
													rstAux5.MoveNext()
													If rstAux5.EOF Then
														nomTramS = "ENLACE SIN DEFINIR"
														'nomTramS = "PR_FINEXPEDIENTE"
														GoTo meteramas
													End If
													strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux5.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > =  " & rstAux4.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													rstAux6 = mfRecordset(conPasarela, strSQL)
													If rstAux6.EOF Then
														strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux4.Fields("ID_PADRE").Value & " AND ORDEN_N1 > " & rstAux4.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
														rstAux6 = mfRecordset(conPasarela, strSQL)
													End If
												End If
												
												If rstAux6.EOF Then
													strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > " & rstAux4.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													rstAux6 = mfRecordset(conPasarela, strSQL)
													If rstAux6.EOF Then
														nomTramS = "PR_FINEXPEDIENTE"
													Else
														strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
														rstAux2 = mfRecordset(conPasarela, strSQL)
													End If
												Else
													strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
													rstAux2 = mfRecordset(conPasarela, strSQL)
												End If
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
												If nomTramS = "" Then
													If rstAux2.Fields("ORDEN_N2").Value = 0 Then
														strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
														strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
														strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
														strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													Else
														strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 =" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >=" & rstAux2.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
													End If
													rstAux2 = mfRecordset(conPasarela, strSQL)
													Do While Not rstAux2.EOF
														If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
															nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
															Exit Do
														End If
														rstAux2.MoveNext()
														nomTramS = "PR_FINEXPEDIENTE"
													Loop 
												End If
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
meteramas: 
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL) : blnInserta = False : blnIns = True : regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											GoTo aqui
										End If
									Else
										If rstTRAMS.EOF Then GoTo aqui
										If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
											strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
											If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
												strSQL = strSQL & " AND ORDEN_N2=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
											End If
											If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
												strSQL = strSQL & " AND ORDEN_N3=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
											End If
											If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
												strSQL = strSQL & " AND ORDEN_N4=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
											End If
											If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
												strSQL = strSQL & " AND ORDEN_N5=1 "
											Else
												strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
											End If
											rstAux4 = mfRecordset(conPasarela, strSQL)
											strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
											' **** NUEVO SD ENERO'08
											strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
											'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
											strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
											'Fin Jonathan Prieto 28/10/2010
											rstAux3 = mfRecordset(conDP4, strSQL)
											If Not rstAux3.EOF Then
												If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
													blnfin = True
													If blnSalto = False Then
														strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
													Else
														strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION like '" & strsalto & "SALTO%'"
													End If
													rstAux2 = mfRecordset(conPasarela, strSQL)
													lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
													strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
													rstAux2 = mfRecordset(conPasarela, strSQL)
													While Not rstAux2.EOF
														strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + (regPlus * 2) + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
														mfExecute(conPasarela, strSQL) : lngUlt = rstAux2.Fields("ORDEN_ACC").Value
														strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
														mfExecute(conPasarela, strSQL) : rstAux2.MoveNext()
													End While
													If lngUlt <> 0 Then
														lngORACC = lngUlt
													Else
														strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
														rstAux3 = mfRecordset(conPasarela, strSQL)
														lngORACC = rstAux3.Fields(0).Value + 1
													End If
													j = j + 1
													If blnSalto = False Then
														strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
													Else
														If rstAux.Fields("NUM_SEQ_HASTA").Value = seq1 Then
															strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
														ElseIf rstAux.Fields("NUM_SEQ_HASTA").Value = seq2 Then 
															strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
														End If
													End If
													mfExecute(conPasarela, strSQL)
													blnInserta = False
													strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE  PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
													rstAux2 = mfRecordset(conPasarela, strSQL)
													If Not rstAux2.EOF Then
														nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
													Else
														nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
													End If
													strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
													rstAux2 = mfRecordset(conPasarela, strSQL)
													If Not rstAux2.EOF Then
														nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Else
														nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
													End If
													msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
													strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
													rstACC2 = mfRecordset(conPasarela, strSQL)
													lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
													lngORACC = lngORACC + 1
													strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
													mfExecute(conPasarela, strSQL)
													blnInserta = False
													blnIns = True
													regPlus = regPlus + 1 '
													msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
												End If
											End If
										End If
									End If
									If Not rstTRAMS.EOF Then
										rstTRAMS.MoveNext()
									End If
								End While
							Else
								If Not rstConST.EOF Then
									GoTo saltotrucado
								End If
							End If
							rstConST.MoveNext()
						End While
					End If
					rstAux.MoveNext()
				End While
aqui: 
				If blnfin = False And rstAux.RecordCount > 0 Then
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'" : rstAux2 = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstAux2.Fields(0).Value) + 1 : strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					While Not rstAux2.EOF
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value : mfExecute(conPasarela, strSQL)
						strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value : mfExecute(conPasarela, strSQL)
						rstAux2.MoveNext()
					End While
					lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
					j = j + 1
					If blnSalto = False Then
						strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
					Else
						strAuxiliar = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'" & strsalto & "SALTO"
						If blnSalto1 = True Then
							strSQL = strAuxiliar & VB6.Format(1, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(1, "00") & "')"
						Else
							strSQL = strAuxiliar & VB6.Format(2, "00") & "'," & lngNumAcc & ",'" & strsalto & "SALTO" & VB6.Format(2, "00") & "')"
						End If
					End If
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
					rstAux2 = mfRecordset(conPasarela, strSQL)
					If Not rstAux2.EOF Then
						nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
					Else
						nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
					End If
					'aketza 5/9/2006
					'            If rstTram("ORDEN_N5") <> 0 Then
					'               nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
					'            ElseIf rstTram("ORDEN_N4") <> 0 Then
					'               nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
					'            ElseIf rstTram("ORDEN_N3") <> 0 Then
					'               nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
					'            ElseIf rstTram("ORDEN_N2") <> 0 Then
					'            nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
					'            ElseIf rstTram("ORDEN_N1") <> 0 Then
					'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
					'
					'            End If
					'fin aketza
					If nomTramS <> "PR_FINEXPEDIENTE" Then
						nomTramS = "ENLACE SIN DEFINIR"
					End If
					
					msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
					rstACC2 = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
					lngORACC = lngORACC + 1
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					blnIns = True
					regPlus = 1
				End If
			End If
			
			
			
			'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
			
			
		End If
		'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
		'''''        If rstTram("SALIDAS") > 1 Then
		'''''            strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram("ID_DIAGRAMA") & " AND NUM_CONECTOR=" & rstTram("NUM_DIAGRAMA") & " AND NUM_SEQ_DESDE=" & rstACC("NUM_SEQ") & " AND IND_SALIDA_TRAM='S'"
		'''''            Set rstAUX = mfRecordset(conPasarela, strSQL)
		'''''            While Not rstAUX.EOF
		'''''                strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram("ID_DIAGRAMA") & " AND D.SH_SEQ=" & rstAUX("NUM_SEQ_HASTA")
		'''''                Set rstConS = mfRecordset(conDP4, strSQL)
		'''''                If Not rstConS.EOF Then
		'''''                    strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstTram("ID_PADRE") & " AND NUM_SEC_DESDE=" & rstTram("NUM_SEQ") & " AND CAT_CONECTOR<>'Conector Opcional'" '& IIf(rstTram("NUM_DIAGRAMA") > 1, " AND ORDEN_N1=" & rstram("ORDEN_N1"), "")
		'''''                    Set rstConST = mfRecordset(conPasarela, strSQL)
		'''''                    While Not rstConST.EOF
		'''''                        strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST("NUM_SEC_HASTA") & " AND ID_PADRE=" & rstTram("ID_PADRE")
		'''''                        Set rstTRAMS = mfRecordset(conPasarela, strSQL)
		'''''                        If rstTRAMS.RecordCount > 1 Then
		'''''                           strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST("NUM_SEC_HASTA") & " AND ID_PADRE=" & rstTram("ID_PADRE") & " AND ORDEN_N1=" & rstTram("ORDEN_N1")
		'''''                           rstTRAMS.Close
		'''''                           Set rstTRAMS = Nothing
		'''''                           Set rstTRAMS = mfRecordset(conPasarela, strSQL)
		'''''                        End If
		'''''                        blnTruco = False
		'''''                        While Not rstTRAMS.EOF
		'''''here:
		'''''                            If blnTruco = True Then
		'''''                                strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS("ID_DIAGRAMA") '& " AND A.EV_ID=" & rstConS("EV_ID")
		'''''                                strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS("ID_PADRE") & " ORDER BY D.SH_Y ASC"
		'''''                            Else
		'''''
		'''''                                strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS("ID_DIAGRAMA") & " ORDER BY D.SH_Y DESC" '& " AND A.EV_ID=" & rstConS("EV_ID")
		'''''                            End If
		'''''                            Set rstAUX3 = mfRecordset(conDP4, strSQL)
		'''''                            If Not rstAUX3.EOF Then
		'''''                                If rstAUX3(0) = rstConS("EV_ID") Then
		'''''                                    blnFin = True
		'''''                                    strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
		'''''                                    Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                    lngNumAcc = Val(rstAUX2(0)) + 1
		'''''                                    strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") & " AND ORDEN_ACC>" & rstACC("ORDEN_ACC") + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
		'''''                                    Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                    lngUlt = 0
		'''''                                    While Not rstAUX2.EOF
		'''''                                        strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAUX2("ORDEN_ACC") + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX2("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX2("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX2("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX2("ORDEN_N5") & " AND ORDEN_ACC=" & rstAUX2("ORDEN_ACC")
		'''''                                        mfExecute conPasarela, strSQL
		'''''                                        lngUlt = rstAUX2("ORDEN_ACC")
		'''''                                        rstAUX2.MoveNext
		'''''                                    Wend
		'''''                                    If lngUlt <> 0 Then
		'''''                                        lngORACC = lngUlt
		'''''                                    Else
		'''''                                        strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") & " and orden_Acc<> 999"
		'''''                                        Set rstAUX3 = mfRecordset(conPasarela, strSQL)
		'''''                                        lngORACC = rstAUX3(0) + 1
		'''''                                    End If
		'''''                                    strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & Format(lngNumAcc, "00") & "')"
		'''''                                    mfExecute conPasarela, strSQL
		'''''                                    blnInserta = False
		'''''                                    strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5")
		'''''                                    Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                    If Not rstAUX2.EOF Then
		'''''                                        nomTram = "@LET" & Mid(rstAUX2("NOM_DIAGRAMA"), 1, 17) & Mid(rstAUX2("NOM_DIAGRAMA"), Len(rstAUX2("NOM_DIAGRAMA")) - 3)
		'''''                                    Else
		'''''                                        nomTram = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		'''''                                    End If
		'''''                                    strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS("ORDEN_N1") & " AND ORDEN_N2=" & rstTRAMS("ORDEN_N2") & " AND ORDEN_N3=" & rstTRAMS("ORDEN_N3") & " AND ORDEN_N4=" & rstTRAMS("ORDEN_N4") & " AND ORDEN_N5=" & rstTRAMS("ORDEN_N5")
		'''''                                    Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                    If Not rstAUX2.EOF Then
		'''''
		'''''                                        nomTramS = rstAUX2("NOM_DIAGRAMA")
		'''''                                        If nomTramS = "" Then
		'''''                                            If rstAUX2("ORDEN_N2") = 0 Then
		'''''                                                strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAUX2("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'''''                                            ElseIf rstAUX2("ORDEN_N3") = 0 Then
		'''''                                                strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX2("ORDEN_N1") & " AND ORDEN_N2 >= " & rstAUX2("ORDEN_N2") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'''''                                            ElseIf rstAUX2("ORDEN_N4") = 0 Then
		'''''                                                strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX2("ORDEN_N1") & " AND ORDEN_N2 = " & rstAUX2("ORDEN_N2") & " AND ORDEN_N3 >=" & rstAUX2("ORDEN_N3") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'''''                                            ElseIf rstAUX2("ORDEN_N5") = 0 Then
		'''''                                                strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX2("ORDEN_N1") & " AND ORDEN_N2 = " & rstAUX2("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX2("ORDEN_N3") & " AND ORDEN_N4 >=" & rstAUX2("ORDEN_N4") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'''''                                            End If
		'''''                                            Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                            Do While Not rstAUX2.EOF
		'''''                                                If rstAUX2("NOM_DIAGRAMA") <> "" Then
		'''''                                                    nomTramS = rstAUX2("NOM_DIAGRAMA")
		'''''                                                    Exit Do
		'''''                                                End If
		'''''                                                rstAUX2.MoveNext
		'''''                                                nomTramS = "PR_FINEXPEDIENTE"
		'''''                                            Loop
		'''''                                        End If
		'''''                                    Else
		'''''                                        nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		'''''                                    End If
		'''''                                    msInsertaParamAcc nomTram, nomTramS, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
		'''''                                    strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
		'''''                                    Set rstACC2 = mfRecordset(conPasarela, strSQL)
		'''''                                    lngNumAcc = Val(rstACC2(0) & "") + 1
		'''''                                    lngORACC = lngORACC + 1
		'''''                                    strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
		'''''                                    mfExecute conPasarela, strSQL
		'''''                                    blnInserta = False
		'''''                                    blnIns = True
		'''''                                    regPlus = regPlus + 1 '
		'''''                                    msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
		'''''                                    GoTo aqui2
		'''''                                Else
		'''''                                    If blnTruco = False Then
		'''''                                        blnTruco = True
		'''''                                        GoTo here
		'''''                                    End If
		'''''                                End If
		'''''                            Else
		'''''                                If rstTRAMS("EXPLOTA_ACC") = "N" Then
		'''''                                    strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS("ORDEN_N1")
		'''''                                    If rstTRAMS("ORDEN_N2") = 0 Then
		'''''                                        strSQL = strSQL & " AND ORDEN_N2=1 "
		'''''                                    Else
		'''''                                        strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS("ORDEN_N2")
		'''''                                    End If
		'''''                                    If rstTRAMS("ORDEN_N3") = 0 And rstTRAMS("ORDEN_N2") <> 0 Then
		'''''                                        strSQL = strSQL & " AND ORDEN_N3=1 "
		'''''                                    Else
		'''''                                        strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS("ORDEN_N3")
		'''''                                    End If
		'''''                                    If rstTRAMS("ORDEN_N4") = 0 And rstTRAMS("ORDEN_N2") <> 0 And rstTRAMS("ORDEN_N3") <> 0 Then
		'''''                                        strSQL = strSQL & " AND ORDEN_N4=1 "
		'''''                                    Else
		'''''                                        strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS("ORDEN_N4")
		'''''                                    End If
		'''''                                    If rstTRAMS("ORDEN_N3") = 0 And rstTRAMS("ORDEN_N2") <> 0 And rstTRAMS("ORDEN_N3") <> 0 And rstTRAMS("ORDEN_N4") <> 0 Then
		'''''                                        strSQL = strSQL & " AND ORDEN_N5=1 "
		'''''                                    Else
		'''''                                        strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS("ORDEN_N5")
		'''''                                    End If
		'''''
		'''''                                    Set rstAUX4 = mfRecordset(conPasarela, strSQL)
		'''''                                    strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAUX4("ID_DIAGRAMA") '& " AND A.EV_ID=" & rstConS("EV_ID")
		'''''                                    Set rstAUX3 = mfRecordset(conDP4, strSQL)
		'''''                                    If Not rstAUX3.EOF Then
		'''''                                        If rstAUX3(0) = rstConS("EV_ID") Then
		'''''                                            blnFin = True
		'''''                                            strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
		'''''                                            Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                            lngNumAcc = Val(rstAUX2(0)) + 1
		'''''                                            strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") & " AND ORDEN_ACC>" & rstACC("ORDEN_ACC") + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
		'''''                                            Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                            While Not rstAUX2.EOF
		'''''                                                strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAUX2("ORDEN_ACC") + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX2("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX2("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX2("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX2("ORDEN_N5") & " AND ORDEN_ACC=" & rstAUX2("ORDEN_ACC")
		'''''                                                mfExecute conPasarela, strSQL
		'''''                                                lngUlt = rstAUX2("ORDEN_ACC")
		'''''                                                strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAUX2("ORDEN_ACC") + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX2("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX2("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX2("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX2("ORDEN_N5") & " AND ORDEN_ACC=" & rstAUX2("ORDEN_ACC")
		'''''                                                mfExecute conPasarela, strSQL
		'''''                                                rstAUX2.MoveNext
		'''''                                            Wend
		'''''                                            If lngUlt <> 0 Then
		'''''                                                lngORACC = lngUlt
		'''''                                            Else
		'''''                                                strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5")
		'''''                                                Set rstAUX3 = mfRecordset(conPasarela, strSQL)
		'''''                                                lngORACC = rstAUX3(0) + 1
		'''''                                            End If
		'''''                                            strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & Format(lngNumAcc, "00") & "')"
		'''''                                            mfExecute conPasarela, strSQL
		'''''                                            blnInserta = False
		'''''                                            strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5")
		'''''                                            Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                            If Not rstAUX2.EOF Then
		'''''                                                nomTram = "@LET" & Mid(rstAUX2("NOM_DIAGRAMA"), 1, 17) & Mid(rstAUX2("NOM_DIAGRAMA"), Len(rstAUX2("NOM_DIAGRAMA")) - 3)
		'''''                                            Else
		'''''                                                nomTram = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		'''''                                            End If
		'''''                                             strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX4("ORDEN_N1") & " AND ORDEN_N2= " & rstAUX4("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX4("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX4("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX4("ORDEN_N5")
		'''''                                            Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                                            If Not rstAUX2.EOF Then
		'''''                                                nomTramS = rstAUX2("NOM_DIAGRAMA")
		'''''                                            Else
		'''''                                                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		'''''                                            End If
		'''''                                            msInsertaParamAcc nomTram, nomTramS, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
		'''''                                            strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
		'''''                                            Set rstACC2 = mfRecordset(conPasarela, strSQL)
		'''''                                            lngNumAcc = Val(rstACC2(0) & "") + 1
		'''''                                            lngORACC = lngORACC + 1
		'''''                                            strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
		'''''                                            mfExecute conPasarela, strSQL
		'''''                                            blnInserta = False
		'''''                                            blnIns = True
		'''''                                            regPlus = regPlus + 1 '
		'''''                                            msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
		'''''                                            GoTo aqui2
		'''''                                        End If
		'''''                                    End If
		'''''                                End If
		'''''                            End If
		'''''                            rstTRAMS.MoveNext
		'''''                        Wend
		'''''                        ''''''''''''''''''''
		'''''                     If Not rstConST.EOF Then
		'''''                        GoTo here
		'''''                     End If
		'''''                     '''''''''''''''''''''''''
		'''''                        rstConST.MoveNext
		'''''                    Wend
		'''''                End If
		'''''                rstAUX.MoveNext
		'''''            Wend
		'''''aqui2:
		'''''            If blnFin = False And rstAUX.RecordCount > 0 Then
		'''''                strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
		'''''                Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                lngNumAcc = Val(rstAUX2(0)) + 1
		'''''                strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5") & " AND ORDEN_ACC>" & rstACC("ORDEN_ACC") + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
		'''''                Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                While Not rstAUX2.EOF
		'''''                    strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAUX2("ORDEN_ACC") + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX2("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX2("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX2("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX2("ORDEN_N5") & " AND ORDEN_ACC=" & rstAUX2("ORDEN_ACC")
		'''''                    mfExecute conPasarela, strSQL
		'''''                    rstAUX2.MoveNext
		'''''                Wend
		'''''                lngORACC = rstACC("ORDEN_ACC") + 3
		'''''                strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & Format(lngNumAcc, "00") & "')"
		'''''                mfExecute conPasarela, strSQL
		'''''                blnInserta = False
		'''''                strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram("ORDEN_N1") & " AND ORDEN_N2=" & rstTram("ORDEN_N2") & " AND ORDEN_N3=" & rstTram("ORDEN_N3") & " AND ORDEN_N4=" & rstTram("ORDEN_N4") & " AND ORDEN_N5=" & rstTram("ORDEN_N5")
		'''''                Set rstAUX2 = mfRecordset(conPasarela, strSQL)
		'''''                If Not rstAUX2.EOF Then
		'''''                    'nomTram = rstAux2("NOM_DIAGRAMA")
		'''''                    nomTram = "@LET" & Mid(rstAUX2("NOM_DIAGRAMA"), 1, 17) & Mid(rstAUX2("NOM_DIAGRAMA"), Len(rstAUX2("NOM_DIAGRAMA")) - 3)
		'''''                Else
		'''''                    nomTram = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		'''''                End If
		'''''                'aketza 5/9/2006
		''''''                If rstTram("ORDEN_N5") <> 0 Then
		''''''                    nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
		''''''                ElseIf rstTram("ORDEN_N4") <> 0 Then
		''''''                    nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
		''''''                ElseIf rstTram("ORDEN_N3") <> 0 Then
		''''''                    nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		''''''                ElseIf rstTram("ORDEN_N2") <> 0 Then
		''''''                    nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		''''''                ElseIf rstTram("ORDEN_N1") <> 0 Then
		''''''                    nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
		''''''
		''''''                End If
		'''''                'fin aketza
		'''''                nomTramS = "ENLACE SIN DEFINIR"
		'''''
		'''''                msInsertaParamAcc nomTram, nomTramS, rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
		'''''                strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
		'''''                Set rstACC2 = mfRecordset(conPasarela, strSQL)
		'''''                lngNumAcc = Val(rstACC2(0) & "") + 1
		'''''                lngORACC = lngORACC + 1
		'''''                strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram("ORDEN_N1") & ", " & rstTram("ORDEN_N2") & ", " & rstTram("ORDEN_N3") & "," & rstTram("ORDEN_N4") & "," & rstTram("ORDEN_N5") & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
		'''''                mfExecute conPasarela, strSQL
		'''''                blnInserta = False
		'''''                msInsertaParamAcc "PATH", "FINTRAMITEPROV", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
		'''''                blnIns = True
		'''''                regPlus = 1
		'''''            End If
		'''''        End If
		'''''    End If
		
		
		
		
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Function
		
		If blnParar = True Then Exit Function
		'aketza errores
		Insertar_Error(Me, "Acción sin Implementación", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fSin_Implementacion")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("fSin_Implementacion- " & Err.Description)
		Resume procFin
		
procFin: 
	End Function
	
	
	Private Function fComprobacion_DOC(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		On Error GoTo procErr
		
		Dim blnError As Boolean
		Dim rstACC2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim lngUlt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim blnPrim As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strSQL As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim codPlaz As String
		Dim colValores As Collection
		Dim blnTruco As Boolean
		Dim blnEncon As Boolean
		Dim blnIndValVar As Boolean
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		fComprobacion_DOC = True
		If ((lngAccCME + lngAccCMS) + 1 <> lngacc) Then 'Or lngacc = 0 Then
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fComprobacion_Doc")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			fComprobacion_DOC = False
		Else
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
			rstAux = mfRecordset(conPasarela, strSQL)
			strJOINER = ""
			While Not rstAux.EOF
				'strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstAUX("ID_CONECTOR") & " AND FROM$SH_SEQ=" & rstAUX("NUM_SEQ_DESDE") & " AND TO$SH_SEQ=" & rstAUX("NUM_SEQ_HASTA") & " AND FROM$DI_ID=" & rstACC("DI_ID") & " AND TO$DI_ID=" & rstACC("DI_ID") & "  AND C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
				strSQL = "select DISTINCT J.ANO_ID FROM JOINER J Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				
				System.Windows.Forms.Application.DoEvents()
				rstconE = mfRecordset(conDP4, strSQL)
				If Not rstconE.EOF Then
					strJOINER = strJOINER & rstconE.Fields(0).Value & ","
				End If
				rstAux.MoveNext()
			End While
			If strJOINER <> "" Then
				strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID =(" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
				lngAccConE = rstparamCME.RecordCount
				If Not rstparamCME.BOF Then
					rstparamCME.MoveFirst()
				End If
			Else
				lngAccConE = 0
			End If
			rstAux.Close()
			colXML4 = New Collection
			colXML4.Add("Código Documento")
			colXML4.Add("Indicador Valor Variable")
			colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
			'Inicio Jonathan Prieto 30/08/2011
			'blnIndValVar = CBool(colXMLD(2) = "1")
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If colXMLD.Item(2) <> vbNullString Then
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
			End If
			'Fin Jonathan Prieto 30/08/2011
			colXMLD.Remove(2)
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			msInsertaParamAcc(Trim(rstparamHN.Fields("PARAM").Value), colXMLD.Item(1) & "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
			rstparamHN.MoveNext()
			If lngAccConE <> 0 Then
				System.Windows.Forms.Application.DoEvents()
				If lngAccCME = lngAccConE Then
					rstparamCME.MoveFirst()
					While Not rstparamCME.EOF
						Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
							Case "Constantes"
								colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strValorV = colXMLD.Item(1)
								If strValorV = "" Then
									'aketza errores
									Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fComprobacion_Doc")
									'mostramos el btn y el lbl
									Mostrar_Error()
									'fin aketza
									fComprobacion_DOC = False
								Else
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								End If
							Case ""
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							Case Else
								'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						End Select
						rstparamCME.MoveNext() : rstparamHN.MoveNext()
					End While
				Else
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fComprobacion_Doc")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fComprobacion_DOC = False
					
				End If
			Else
				While Not rstParCME.EOF
					'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					rstParCME.MoveNext() : rstparamHN.MoveNext()
				End While
			End If
			
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
			rstAux = mfRecordset(conPasarela, strSQL)
			strJOINER = ""
			While Not rstAux.EOF
				strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND DI_ID=" & rstAcc.Fields("DI_ID").Value & "  AND C.CO_ID=J.ANO_ID AND DM_DELETES=1"
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strJOINER = strJOINER & rstConS.Fields(0).Value & ","
				End If
				rstAux.MoveNext()
			End While
			If strJOINER <> "" Then
				strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID =(" & rstConS.Fields("ANO_ID").Value & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
				System.Windows.Forms.Application.DoEvents()
				lngAccConS = rstParamCMS.RecordCount
				System.Windows.Forms.Application.DoEvents()
				rstParamCMS.MoveFirst()
			Else
				lngAccConS = 0
			End If
			rstAux.Close()
			
			If lngAccConS <> 0 Then
				System.Windows.Forms.Application.DoEvents()
				If lngAccCMS = lngAccConS Then
					rstParamCMS.MoveFirst()
					While Not rstParamCMS.EOF
						Select Case rstParamCMS.Fields("EN_NAME").Value
							Case "Constantes"
								colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strValorV = colXMLD.Item(1)
								If strValorV = "" Then
									'aketza errores
									Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fComprobacion_Doc")
									'mostramos el btn y el lbl
									Mostrar_Error()
									'fin aketza
									fComprobacion_DOC = False
								Else
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								End If
							Case ""
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							Case Else
								'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						End Select
						rstParamCMS.MoveNext() : rstparamHN.MoveNext()
					End While
				Else
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables  asignadas como salida no coincide con el número de parámetros de salida", "fComprobacion_Doc")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fComprobacion_DOC = False
				End If
			Else
				While Not rstParCMS.EOF
					'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					rstParCMS.MoveNext() : rstparamHN.MoveNext()
				End While
			End If
			If rstParCMS.RecordCount = 0 And rstParCME.RecordCount = 0 And lngAccConS = 0 And lngAccConE = 0 Then
				msInsertaParamAcc("", "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			End If
			blnfin = False
			'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
			If Trim(rstAcc.Fields("NOM_ACCION").Value) = "ANEXARFACUSERECIBO" Then
				strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAcc.Fields("ORDEN_ACC").Value & " AND PARAMETRO='@CODIGODOCUMENTO'"
				rstAux = mfRecordset(conPasarela, strSQL)
				If Not rstAux.EOF Then
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAcc.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAcc.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAcc.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAcc.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAcc.Fields("ORDEN_N5").Value & " AND NOM_ACCION='TRAMITEPDTE'"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					If Not rstAux2.EOF Then
						msInsertaParamAcc("@CODDOCUM", rstAux.Fields("VALOR").Value, rstAux2.Fields("ORDEN_N1").Value, rstAux2.Fields("ORDEN_N2").Value, rstAux2.Fields("ORDEN_N3").Value, rstAux2.Fields("ORDEN_N4").Value, rstAux2.Fields("ORDEN_N5").Value, rstAux2.Fields("ORDEN_ACC").Value)
					End If
				End If
			End If
			'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
			If rstTram.Fields("SALIDAS").Value > 1 Then
				strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND IND_SALIDA_TRAM='S'"
				rstAux = mfRecordset(conPasarela, strSQL)
				While Not rstAux.EOF
					'aketza 29/04/2008
					'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
					If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
						'fin aketza
						nomTramS = "PR_FINEXPEDIENTE"
						GoTo aqui2
					End If
					strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
					strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
					'Fin Jonathan Prieto 28/10/2010
					rstConS = mfRecordset(conDP4, strSQL)
					If Not rstConS.EOF Then
						If rstTram.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NUM=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR)<>'Conector Opcional' AND ORDEN_N1=0"
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NUM=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR)<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NUM=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR)<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NUM=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR)<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value
						ElseIf rstTram.Fields("NUM_DIAGRAMA").Value = 5 Then 
							strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NUM=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND RTRIM(CAT_CONECTOR)<>'Conector Opcional' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value
						End If
						rstConST = mfRecordset(conPasarela, strSQL)
						While Not rstConST.EOF
							If rstConST.Fields("NUM").Value = 1 Then
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
							ElseIf rstConST.Fields("NUM").Value = 2 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstConST.Fields("ORDEN_N1").Value
							ElseIf rstConST.Fields("NUM").Value = 3 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstConST.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstConST.Fields("ORDEN_N2").Value
							ElseIf rstConST.Fields("NUM").Value = 4 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstConST.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstConST.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstConST.Fields("ORDEN_N3").Value
							ElseIf rstConST.Fields("NUM").Value = 5 Then 
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstConST.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstConST.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstConST.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstConST.Fields("ORDEN_N4").Value
							End If
							rstTRAMS = mfRecordset(conPasarela, strSQL)
							blnTruco = False
							While Not rstTRAMS.EOF
here: 
								If blnTruco = True Then
									strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
								Else
									strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									strSQL = strSQL & " ORDER BY D.SH_Y DESC"
								End If
								rstAux3 = mfRecordset(conDP4, strSQL)
								If Not rstAux3.EOF Then
									If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
										blnfin = True
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
										rstAux2 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
										strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
										rstAux2 = mfRecordset(conPasarela, strSQL)
										lngUlt = 0
										While Not rstAux2.EOF
											strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
											mfExecute(conPasarela, strSQL)
											lngUlt = rstAux2.Fields("ORDEN_ACC").Value
											
											strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
											mfExecute(conPasarela, strSQL)
											
											rstAux2.MoveNext()
										End While
										If lngUlt <> 0 Then
											lngORACC = lngUlt
										Else
											strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " and orden_Acc<> 999"
											rstAux3 = mfRecordset(conPasarela, strSQL)
											lngORACC = rstAux3.Fields(0).Value + 1
										End If
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										blnInserta = False
										strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux2 = mfRecordset(conPasarela, strSQL)
										If Not rstAux2.EOF Then
											nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
										Else
											nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
										End If
										If rstTram.Fields("ORDEN_N2").Value = 0 Then
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstTRAMS.Fields("ORDEN_N2").Value & " order by orden_n1, orden_n2, orden_n3, orden_n4,orden_n5"
										ElseIf rstTram.Fields("ORDEN_N3").Value = 0 Then 
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3>=" & rstTRAMS.Fields("ORDEN_N3").Value & " order by orden_n1, orden_n2, orden_n3, orden_n4,orden_n5"
										ElseIf rstTram.Fields("ORDEN_N4").Value = 0 Then 
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >= " & rstTRAMS.Fields("ORDEN_N4").Value & " order by orden_n1, orden_n2, orden_n3, orden_n4,orden_n5"
										ElseIf rstTram.Fields("ORDEN_N5").Value = 0 Then 
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >= " & rstTRAMS.Fields("ORDEN_N5").Value & " order by orden_n1, orden_n2, orden_n3, orden_n4,orden_n5"
										End If
										rstAux2 = mfRecordset(conPasarela, strSQL)
										Do While Not rstAux2.EOF
											If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
												Exit Do
											End If
											rstAux2.MoveNext()
											nomTramS = "PR_FINEXPEDIENTE"
										Loop 
										'                                    If Not rstAUX2.EOF Then
										'                                        nomTramS = rstAUX2("NOM_DIAGRAMA")
										'                                    Else
										'                                        nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
										'                                    End If
										msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='JUMP'"
										rstACC2 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
										mfExecute(conPasarela, strSQL)
										blnInserta = False
										blnIns = True
										regPlus = regPlus + 1 '
										msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										GoTo aqui2
									Else
										If blnTruco = False Then
											blnTruco = True
											GoTo here
										End If
									End If
								Else
									If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
										strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
										If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
											strSQL = strSQL & " AND ORDEN_N2=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
										End If
										If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N3=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
										End If
										If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N4=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
										End If
										If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
											strSQL = strSQL & " AND ORDEN_N5=1 "
										Else
											strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
										End If
										
										rstAux4 = mfRecordset(conPasarela, strSQL)
										strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
										
										' **** NUEVO SD ENERO'08
										strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
										rstAux3 = mfRecordset(conDP4, strSQL)
										If Not rstAux3.EOF Then
											If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
												blnfin = True
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='LET INICIALIZACIONVAR'"
												rstAux2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
												strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
												rstAux2 = mfRecordset(conPasarela, strSQL)
												While Not rstAux2.EOF
													strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL)
													lngUlt = rstAux2.Fields("ORDEN_ACC").Value
													strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
													mfExecute(conPasarela, strSQL)
													rstAux2.MoveNext()
												End While
												If lngUlt <> 0 Then
													lngORACC = lngUlt
												Else
													strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
													rstAux3 = mfRecordset(conPasarela, strSQL)
													lngORACC = rstAux3.Fields(0).Value + 1
												End If
												strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
												mfExecute(conPasarela, strSQL)
												blnInserta = False
												strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux2 = mfRecordset(conPasarela, strSQL)
												If Not rstAux2.EOF Then
													nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
												Else
													nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
												End If
												strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
												rstAux2 = mfRecordset(conPasarela, strSQL)
												If Not rstAux2.EOF Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
												Else
													nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
												End If
												msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
												strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='JUMP'"
												rstACC2 = mfRecordset(conPasarela, strSQL)
												lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
												lngORACC = lngORACC + 1
												strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
												mfExecute(conPasarela, strSQL)
												blnInserta = False
												blnIns = True
												regPlus = regPlus + 1 '
												msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
												GoTo aqui2
											End If
										End If
									End If
								End If
								rstTRAMS.MoveNext()
							End While
							rstConST.MoveNext()
						End While
					End If
					rstAux.MoveNext()
				End While
aqui2: 
				If blnfin = False And rstAux.RecordCount > 0 Then
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='LET INICIALIZACIONVAR'"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					While Not rstAux2.EOF
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
						mfExecute(conPasarela, strSQL)
						
						strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
						mfExecute(conPasarela, strSQL)
						
						rstAux2.MoveNext()
					End While
					lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
					rstAux2 = mfRecordset(conPasarela, strSQL)
					If Not rstAux2.EOF Then
						'nomTram = rstAux2("NOM_DIAGRAMA")
						nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
					Else
						nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
					End If
					If nomTramS <> "PR_FINEXPEDIENTE" Then
						nomTramS = "ENLACE SIN DEFINIR"
					End If
					
					msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='JUMP'"
					rstACC2 = mfRecordset(conPasarela, strSQL)
					lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
					lngORACC = lngORACC + 1
					strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
					blnIns = True
					regPlus = 1
				End If
			End If
		End If
		
		GoTo procFin
procErr: 
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		Insertar_Error(Me, "Comprobación de Documentación", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fComprobacion_Doc")
		Mostrar_Error()
		logError("fSin_Implementacion- " & Err.Description)
		Resume procFin
		
procFin: 
	End Function
	
	
	Private Sub msSolucionJumps(ByRef buscaTodo As Boolean)
		On Error GoTo procErr
		Dim strSQL As String
		Dim strsalto As String
		Dim rstAcc As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux5B As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim rstAux7 As ADODB.Recordset
		Dim rstAUX8 As ADODB.Recordset
		Dim rstAUX9 As ADODB.Recordset
		Dim blnEN2 As Boolean
		Dim blnEN3 As Boolean
		Dim blnEN4 As Boolean
		Dim blnEN5 As Boolean
		Dim blnEnCONTRA As Boolean
		Dim bln2SALTO As Boolean
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim lngFIN As Integer
		Dim lngORACC2 As Integer
		Dim colConectores As Collection
		Dim strSALTOSREALES As String
		Dim icol As Object
		Dim rst1C As ADODB.Recordset
		Dim rst2C As ADODB.Recordset
		Dim contador As Integer
		Dim blnSalto1C As Boolean
		Dim strDIA As String
		Dim cadenaConectores1 As String
		Dim strDIA1 As String
		Dim strCon_DI As String
		Dim strPROP_DI As String
		'aketza 29/04/2008
		Dim strAux As String
		'fin aketza
		
		strDIA = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
		strCon_DI = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  EXPLOTA_ACC='S' order by ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5"
		strPROP_DI = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 "
		rstAux = mfRecordset(conPasarela, strSQL)
		Dim blnAux As Boolean
		While Not rstAux.EOF
			'If rstAux("ORDEN_N1") = 6 And rstAux("ORDEN_N2") = 3 And rstAux("ORDEN_N3") = 7 Then
			'DoEvents
			'End If
			If InStr(1, rstAux.Fields("NOMBRE").Value, "PR_TRAMITEFICTICIO", CompareMethod.Text) = 1 Then
				rstAux.MoveNext()
			End If
			
			blnSalto1C = False
			'UPGRADE_NOTE: Object rstAux5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rstAux5 = Nothing
			'UPGRADE_NOTE: Object rstAux5B may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rstAux5B = Nothing
			'UPGRADE_NOTE: Object rstAux6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rstAux6 = Nothing
			blnEN2 = False
			blnEN3 = False
			blnEN4 = False
			contador = 0
			strsalto = ""
			
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_ACC DESC"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			If Not rstAux2.RecordCount = 0 Then
				lngORACC = rstAux2.Fields("ORDEN_ACC").Value
				If rstAux2.Fields("NOM_ACCION").Value <> "JUMP" Then
					
					'Debug.Print rstAux(1) & "-" & rstAux(2) & "-" & rstAux(3) & "-" & rstAux(4) & "-" & rstAux(5)
					blnEnCONTRA = False
					cadenaConectores1 = strCon_DI & " NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and "
					'aketza 29/04/2008
					'Inicio Jonathan Prieto 18/01/2012
					'strAux = "RTRIM(CAT_CONECTOR) not in ('Fin de plazo 2','Fin de plazo 1','Conector Opcional') AND ORDEN_N1=" & rstAux("ORDEN_N1") & " AND ORDEN_N2=" & rstAux("ORDEN_N2")
					strAux = "RTRIM(CAT_CONECTOR) not in ('Fin de plazo 2','Fin de plazo 1','Conector Opcional','Conector Aplicaciones') AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value
					'Fin Jonathan Prieto 18/01/2012
					'fin aketza
					If rstAux.Fields("NUM_DIAGRAMA").Value = 1 Then
						strSQL = cadenaConectores1 & "RTRIM(CAT_CONECTOR) not in ('Fin de plazo 1','Conector Opcional') AND ORDEN_N1=0"
					ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 2 Then 
						strSQL = cadenaConectores1 & "RTRIM(CAT_CONECTOR) not in ('Fin de plazo 1','Conector Opcional') AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
					ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 3 Then 
						'aketza 29/04/2008
						'strSQL = cadenaConectores1 & "RTRIM(CAT_CONECTOR) not in ('Fin de plazo 2','Fin de plazo 1','Conector Opcional') AND ORDEN_N1=" & rstAux("ORDEN_N1") & " AND ORDEN_N2=" & rstAux("ORDEN_N2")
						strSQL = cadenaConectores1 & strAux
						'fin aketza
					ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 4 Then 
						'aketza 29/04/2008
						strSQL = cadenaConectores1 & strAux & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value
						'fin aketza
					ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 5 Then 
						'aketza 29/04/2008
						strSQL = cadenaConectores1 & strAux & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value
						'fin aketza
					End If
					rstAux3 = mfRecordset(conPasarela, strSQL)
					If rstAux3.EOF And rstAux2.Fields("NOM_ACCION").Value = "CANCEL" Then
						'Inicio Jonathan Prieto 25/02/2011: Si la consulta no ha devuelto ningún registro, no debe buscar ahora los de Fin plazo 1 para insertar JUMP
						'strSQL = Replace(strSQL, "'Fin de plazo 1',", "")
						'Set rstAux3 = mfRecordset(conPasarela, strSQL)
						'Fin Jonathan Prieto 25/02/2011
					End If
					bln2SALTO = False
salto2: 
					While Not rstAux3.EOF
						strsalto = ""
						bln2SALTO = False
						'''''''''''''''''''
						blnEN2 = False
						blnEN3 = False
						blnEN4 = False
						'''''''''''''''
						strDIA1 = strDIA & "ID_PADRE=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
						If rstAux.Fields("NUM_DIAGRAMA").Value > 1 Then
							strSQL = strDIA1 & " and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
						Else
							If rstAux.Fields("NUM_DIAGRAMA").Value = 3 Then
								strSQL = strDIA1 & "AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value
							Else
								strSQL = strDIA1
							End If
						End If
						rstAux4 = mfRecordset(conPasarela, strSQL)
						If rstAux4.RecordCount > 1 Then
							rstAux4.Filter = "ORDEN_N2= " & rstAux.Fields("ORDEN_N2").Value
						End If
						If rstAux4.EOF = True Then
							'If Trim(UCase(rstAux3("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Then
							'aketza 29/04/2008
							'If Trim(UCase(rstAux3("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux3("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
							If Trim(UCase(rstAux3.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux3.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or Trim(UCase(rstAux3.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
								'fin aketza
								'aketza 29/04/2008
								'strSQL = "SELECT * FROM CONECTOR_ACC WHERE procedimiento='" & gNomProcCorto & "' and ID_DIAGRAMA=" & rstAux("ID_DIAGRAMA") & " and (UPPER(RTRIM(CAT_CONECTOR2))='FIN DE EXPEDIENTE' or UPPER(RTRIM(CAT_CONECTOR2))='FIN DE ASUNTO')"
								strSQL = "SELECT * FROM CONECTOR_ACC WHERE procedimiento='" & gNomProcCorto & "' and ID_DIAGRAMA=" & rstAux.Fields("ID_DIAGRAMA").Value & " and (UPPER(RTRIM(CAT_CONECTOR2))='FIN DE EXPEDIENTE' or UPPER(RTRIM(CAT_CONECTOR2))='FIN DE ASUNTO' or UPPER(RTRIM(CAT_CONECTOR2))='FIN ASUNTO')"
								'fin aketza
								'strSQL = "SELECT * FROM CONECTOR_ACC WHERE procedimiento='" & gNomProcCorto & "' and ID_DIAGRAMA=" & rstAux("ID_DIAGRAMA") & " and RTRIM(CAT_CONECTOR2)='Fin de Expediente'"
								rstAUX9 = mfRecordset(conPasarela, strSQL)
								If rstAUX9.EOF Then
									bln2SALTO = True
									blnEN2 = False
									If rstAux.Fields("NUM_DIAGRAMA").Value = 1 Then blnEN2 = True
									If rstAux.Fields("NUM_DIAGRAMA").Value = 2 Then blnEN3 = True
									If rstAux.Fields("NUM_DIAGRAMA").Value = 3 Then blnEN4 = True
									strsalto = "PR_FINEXPEDIENTE"
									GoTo FIN
									GoTo meteJump
								Else
									'Inicio Jonathan Prieto 18/01/2012
									strsalto = "PR_FINEXPEDIENTE"
									GoTo FIN
									'Fin Jonathan Prieto 18/01/2012
									rstAux3.MoveNext()
								End If
							ElseIf rstAux3.Fields("SALIDA").Value = "S" Then 
								bln2SALTO = True
								'If rstAux("NUM_DIAGRAMA") = 1 Then blnEN2 = True
								If rstAux.Fields("NUM_DIAGRAMA").Value = 2 Then
									'GoTo en2salida
									''''''''''''''''''
									blnEN2 = True
									strSQL = strDIA & " NUM_DIAGRAMA=1 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
									rstAux6 = mfRecordset(conPasarela, strSQL)
									'strSQL = strCon_DI & " NUM=" & rstAux6("NUM_DIAGRAMA") & " AND DIAGRAMA=" & rstAux6("ID_PADRE") & " AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR=''"
									strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR='' ORDER BY ID_CONECTOR"
									rstAux5B = mfRecordset(conPasarela, strSQL)
									While Not rstAux5B.EOF
										strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux5B.Fields("NUM_SEC_HASTA").Value
										rstAux4 = mfRecordset(conPasarela, strSQL)
										
										If rstAux4.EOF = True Then
											rstAux5B.MoveNext()
										Else
											strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR = ('Conector Opcional')"
											rstAux5 = mfRecordset(conPasarela, strSQL)
											If rstAux5.RecordCount > 1 Then
												strsalto = "PR_FINEXPEDIENTE"
											Else
												strsalto = ""
											End If
											'Inicio Jonathan Prieto 07/02/2011: modificada por completo la mfComprobarFDP
											'''''comprobar que no salta a una alerta
											'If mfComprobarFDP(rstAux5B, rstAux3) = False Or buscaTodo = True Then
											If mfComprobarFDP(rstAux5B, rstAux3) = True Or buscaTodo = True Then
												'Fin Jonathan Prieto 07/02/2011
												GoTo meteJump
											Else
												rstAux5B.MoveNext()
											End If
										End If
									End While
									
									GoTo meteJump
								Else
									rstAux3.MoveNext()
								End If
								'Inicio Jonathan Prieto 31/01/2011: Tratamiento cuando el conector apunta a Caducar Expediente
							ElseIf Trim(UCase(rstAux3.Fields("CAT_CONECTOR2").Value)) = "CADUCAR EXPEDIENTE" Then 
								'UPGRADE_WARNING: Couldn't resolve default property of object rstAux3.Source. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strSQL = rstAux3.Source
								GoTo Prueba
								'Fin Jonathan Prieto 31/01/2011
							Else
								rstAux3.MoveNext()
							End If
						Else
							bln2SALTO = True
							If rstAux4.Fields("NUM_DIAGRAMA").Value = 1 Then blnEN2 = True
							If rstAux4.Fields("NUM_DIAGRAMA").Value = 2 Then blnEN3 = True
							If rstAux4.Fields("NUM_DIAGRAMA").Value = 3 Then blnEN4 = True
							If rstAux4.Fields("NUM_DIAGRAMA").Value = 4 Then blnEN5 = True
							If rstAux4.Fields("NUM_DIAGRAMA").Value = 5 Then blnEN5 = True
							GoTo meteJump
						End If
					End While
					If rstAux3.RecordCount = 0 And buscaTodo = True Then
						If rstAux.Fields("NUM_DIAGRAMA").Value = 3 Or rstAux.Fields("NUM_DIAGRAMA").Value = 2 Then
							strSQL = strCon_DI & "NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR) = 'Conector Opcional' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
							rstAux3 = mfRecordset(conPasarela, strSQL)
							If Not rstAux3.EOF Then
								GoTo solo1J
							End If
						End If
						strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA"
						rstAux3 = mfRecordset(conPasarela, strSQL)
						While Not rstAux3.EOF
							strsalto = ""
							bln2SALTO = False
							If rstAux.Fields("NUM_DIAGRAMA").Value > 1 Then
								strSQL = strDIA & "ID_PADRE=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
							Else
								strSQL = strDIA & "ID_PADRE=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
							End If
							rstAux4 = mfRecordset(conPasarela, strSQL)
							If rstAux4.EOF = True Then
								'aketza 29/04/2008
								'If Trim(UCase(rstAux3("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux3("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
								If Trim(UCase(rstAux3.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux3.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or Trim(UCase(rstAux3.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
									'fin aketza
									bln2SALTO = True
									blnEN2 = False
									If rstAux4.Fields("NUM_DIAGRAMA").Value = 1 Then blnEN2 = True
									If rstAux4.Fields("NUM_DIAGRAMA").Value = 2 Then blnEN3 = True
									If rstAux4.Fields("NUM_DIAGRAMA").Value = 3 Then blnEN4 = True
									GoTo meteJump
								Else
									rstAux3.MoveNext()
								End If
							Else
								bln2SALTO = True
								If rstAux4.Fields("NUM_DIAGRAMA").Value = 1 Then blnEN2 = True
								If rstAux4.Fields("NUM_DIAGRAMA").Value = 2 Then blnEN3 = True
								If rstAux4.Fields("NUM_DIAGRAMA").Value = 3 Then blnEN4 = True
								GoTo meteJump
							End If
						End While
					End If
					strsalto = "PR_FINEXPEDIENTE"
					If rstAux.Fields("NUM_DIAGRAMA").Value > 1 Then
						If buscaTodo = False Then
							strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR) = 'Conector Opcional' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
							rstAux4 = mfRecordset(conPasarela, strSQL)
							If Not rstAux4.EOF Then
								GoTo solo1J
							End If
						End If
						If rstAux.Fields("NUM_DIAGRAMA").Value = 3 Then
							blnEN3 = True
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 2 Then 
							blnEN2 = True
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 4 Then 
							blnEN4 = True
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 5 Then 
							blnEN5 = True
						End If
						If rstAux.Fields("NUM_DIAGRAMA").Value = 2 Then
							strSQL = strDIA & "NUM_DIAGRAMA=1 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = strDIA & "NUM_DIAGRAMA=2 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = strDIA & "NUM_DIAGRAMA=3 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 5 Then 
							strSQL = strDIA & "NUM_DIAGRAMA=4 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value
						End If
						rstAux5 = mfRecordset(conPasarela, strSQL)
						If rstAux5.EOF Then
							strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR) = '' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
							rstAux4 = mfRecordset(conPasarela, strSQL)
							strSQL = strDIA & "NUM_DIAGRAMA=1 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
							rstAux5 = mfRecordset(conPasarela, strSQL)
							If rstAux5.EOF Then
								strsalto = "PR_FINEXPEDIENTE"
								GoTo meteJump
							End If
						End If
						If rstAux5.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = strCon_DI & "NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=0"
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = strCon_DI & "NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = strCon_DI & "NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux5.Fields("ORDEN_N2").Value
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value >= 4 Then 
							strSQL = strCon_DI & "NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_n3=" & rstAux5.Fields("ORDEN_N3").Value
						End If
						rstAux3 = mfRecordset(conPasarela, strSQL)
						While Not rstAux3.EOF
							'strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAUX5("ID_PADRE") & " AND NUM_SEQ=" & rstAUX3("NUM_SEC_HASTA")
							If rstAux5.Fields("NUM_DIAGRAMA").Value = 1 Then
								strSQL = strDIA & "ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value
							ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Then 
								strSQL = strDIA & "ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
							ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 3 Then 
								strSQL = strDIA & "ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value
							ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value >= 4 Then 
								strSQL = strDIA & "ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value
							End If
							rstAux4 = mfRecordset(conPasarela, strSQL)
							If rstAux4.EOF = True Then
								rstAux3.MoveNext()
							Else
								strsalto = ""
								GoTo meteJump
							End If
						End While
					End If
					'SEPTIEMBRE 2008
					msNivelSuperior(strsalto, rstAux4, rstAux5, rstAux3)
					'''''''''''''''''''''''''''''''''''
					'Buscamos sus conectores opcionales
					If rstAux5 Is Nothing Then
						GoTo meteJump
					Else
						If rstAux5.EOF Then
							GoTo meteJump
						End If
					End If
					If rstAux5.Fields("NUM_DIAGRAMA").Value = 1 Then
						strSQL = strCon_DI & " NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='Conector Opcional' and ORDEN_N1=0"
					ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Then 
						strSQL = strCon_DI & " NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='Conector Opcional' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
					ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 3 Then 
						strSQL = strCon_DI & " NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='Conector Opcional' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux5.Fields("ORDEN_N2").Value
					End If
					rstAux3 = mfRecordset(conPasarela, strSQL)
					If rstAux3.EOF Then
						If rstAux5.Fields("NUM_DIAGRAMA").Value = 1 Then
							GoTo meteJump
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = strCon_DI & " NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = strCon_DI & " NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux5.Fields("ORDEN_N2").Value
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = strCon_DI & " NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_n3=" & rstAux5.Fields("ORDEN_N3").Value
						End If
						rstAux4 = mfRecordset(conPasarela, strSQL)
						
						If Not rstAux4.EOF Then
							While Not rstAux4.EOF
								If Trim(rstAux4.Fields("SALIDA").Value) <> "" Then
									GoTo nivsup
								ElseIf rstAux4.AbsolutePosition = rstAux4.RecordCount Then 
									GoTo meteJump
								End If
								rstAux4.MoveNext()
							End While
						Else
							GoTo meteJump
						End If
					End If
					While Not rstAux3.EOF
						If rstAux5.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = strDIA & " ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = strDIA & " ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
						ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = strDIA & " ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value
						End If
						rstAux4 = mfRecordset(conPasarela, strSQL)
						If rstAux4.EOF = True Then
							rstAux3.MoveNext()
						Else
							strsalto = ""
							GoTo meteJump
						End If
					End While
					
nivsup: 
					'busqueda de nivel superior
					If rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Or rstAux5.Fields("NUM_DIAGRAMA").Value = 3 Then
						strSQL = strDIA & " num_diagrama=" & rstAux5.Fields("NUM_DIAGRAMA").Value - 1 & " and id_diagrama=" & rstAux5.Fields("ID_PADRE").Value & " and orden_n1=" & rstAux5.Fields("ORDEN_N1").Value & IIf(rstAux5.Fields("NUM_DIAGRAMA").Value = 3, " and orden_n2=" & rstAux5.Fields("ORDEN_N2").Value, "")
						rstAux5 = mfRecordset(conPasarela, strSQL)
						strSQL = strCon_DI & " NUM=" & rstAux5.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and " & IIf(rstAux5.Fields("NUM_DIAGRAMA").Value = 2, "ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value, "ORDEN_N1=0")
						rstAux3 = mfRecordset(conPasarela, strSQL)
						While Not rstAux3.EOF
							If rstAux5.Fields("NUM_DIAGRAMA").Value = 1 Then
								strSQL = strDIA & " ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value
							ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Then 
								strSQL = strDIA & " ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
							ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value = 3 Then 
								strSQL = strDIA & " ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value
							ElseIf rstAux5.Fields("NUM_DIAGRAMA").Value >= 4 Then 
								strSQL = strDIA & " ID_PADRE=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value
							End If
							rstAux4 = mfRecordset(conPasarela, strSQL)
							If rstAux4.EOF = True Then
								rstAux3.MoveNext()
							Else
								strsalto = ""
								blnEN2 = True
								GoTo meteJump
							End If
						End While
					End If
					
					strsalto = "PR_FINEXPEDIENTE"
					'CAMBIO FIN DE EXPEDIENTE
					GoTo meteJump
					'FIN CAMBIO FIN DE EXPEDIENTE
					If blnEN3 = True Then
						If rstAux5 Is Nothing Then
							GoTo solo1J
						End If
						If rstAux5.Fields("NUM_DIAGRAMA").Value = 2 Then
							blnEN2 = True
							strSQL = strDIA & " NUM_DIAGRAMA=1 AND ID_DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
							rstAux6 = mfRecordset(conPasarela, strSQL)
							If rstAux6.Fields("NUM_DIAGRAMA").Value = 1 Then
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=0"
							ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 2 Then 
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value
							ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 3 Then 
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux6.Fields("ORDEN_N2").Value
							ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 4 Then 
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_n3=" & rstAux6.Fields("ORDEN_N3").Value
							ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 5 Then 
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_n2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_n3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_n4=" & rstAux6.Fields("ORDEN_N4").Value
							End If
							
							''''''''''''''''''BUSQUEDA DE UN NIVEL SUPERIOR DE CONECTORES
							rstAux3 = mfRecordset(conPasarela, strSQL)
							While Not rstAux3.EOF
								If rstAux6.Fields("NUM_DIAGRAMA").Value = 1 Then
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value
								ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 2 Then 
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value
								ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 3 Then 
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value
								ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 4 Then 
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value
								ElseIf rstAux6.Fields("NUM_DIAGRAMA").Value = 5 Then 
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_n4=" & rstAux6.Fields("ORDEN_N4").Value
								End If
								
								
								rstAux4 = mfRecordset(conPasarela, strSQL)
								If rstAux4.EOF = True Then
									rstAux3.MoveNext()
								Else
									strsalto = ""
									GoTo meteJump
								End If
							End While
							
							If Not rstAux3.EOF Then
								GoTo SALTOTRUCADOSOLO1C
								blnSalto1C = True
							End If
							strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR=''"
							rstAux3 = mfRecordset(conPasarela, strSQL)
SALTOTRUCADOSOLO1C: 
							While Not rstAux3.EOF
								If blnSalto1C = True Then
									strSQL = strDIA & " orden_N1=" & rstAux3.Fields("ORDEN_n1").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
								Else
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
								End If
								rstAux4 = mfRecordset(conPasarela, strSQL)
								If rstAux4.EOF = True Then
									rstAux3.MoveNext()
								Else
									strsalto = ""
									GoTo meteJump
								End If
							End While
						End If
					Else
						If rstAux.Fields("NUM_DIAGRAMA").Value = 2 Then
en2salida: 
							blnEN2 = True
							strSQL = strDIA & " NUM_DIAGRAMA=1 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
							rstAux6 = mfRecordset(conPasarela, strSQL)
							strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR=''"
							rstAux3 = mfRecordset(conPasarela, strSQL)
							While Not rstAux3.EOF
								strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
								rstAux4 = mfRecordset(conPasarela, strSQL)
								If rstAux4.EOF = True Then
									rstAux3.MoveNext()
								Else
									strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR = ('Conector Opcional')"
									rstAux3 = mfRecordset(conPasarela, strSQL)
									If rstAux3.RecordCount > 1 Then
										strsalto = "PR_FINEXPEDIENTE"
									Else
										strsalto = ""
									End If
									GoTo meteJump
								End If
							End While
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 4 Then 
							blnEN4 = True
							strSQL = strDIA & " NUM_DIAGRAMA=3 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux.Fields("ORDEN_N2").Value
							rstAux6 = mfRecordset(conPasarela, strSQL)
							strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR=''"
							rstAux3 = mfRecordset(conPasarela, strSQL)
							While Not rstAux3.EOF
								strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
								rstAux4 = mfRecordset(conPasarela, strSQL)
								If rstAux4.EOF = True Then
									rstAux3.MoveNext()
								Else
									blnEnCONTRA = True
									strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR = ('Conector Opcional')"
									rstAux3 = mfRecordset(conPasarela, strSQL)
									If rstAux3.RecordCount > 1 Then
										strsalto = "PR_FINEXPEDIENTE"
									Else
										strsalto = ""
									End If
									GoTo meteJump
								End If
							End While
							If blnEnCONTRA = False Then
								strSQL = strDIA & " NUM_DIAGRAMA=3 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux.Fields("ORDEN_N2").Value
								rstAux6 = mfRecordset(conPasarela, strSQL)
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR=''"
								rstAux3 = mfRecordset(conPasarela, strSQL)
								While Not rstAux3.EOF
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
									rstAux4 = mfRecordset(conPasarela, strSQL)
									If rstAux4.EOF = True Then
										rstAux3.MoveNext()
									Else
										blnEnCONTRA = True
										strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM= 3 AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR = ('Conector Opcional')"
										rstAux3 = mfRecordset(conPasarela, strSQL)
										If rstAux3.RecordCount > 1 Then
											strsalto = "PR_FINEXPEDIENTE"
										Else : strsalto = ""
										End If
										GoTo meteJump
									End If
								End While
							End If
							If blnEnCONTRA = False Then
								strSQL = strDIA & " NUM_DIAGRAMA=2 AND ID_DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
								rstAux6 = mfRecordset(conPasarela, strSQL)
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR=''"
								rstAux3 = mfRecordset(conPasarela, strSQL)
								While Not rstAux3.EOF
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
									rstAux4 = mfRecordset(conPasarela, strSQL)
									If rstAux4.EOF = True Then
										rstAux3.MoveNext()
									Else
										blnEnCONTRA = True
										blnEN2 = True
										blnEN4 = False
										strsalto = ""
										GoTo meteJump
									End If
								End While
							End If
						ElseIf rstAux.Fields("NUM_DIAGRAMA").Value = 5 Then 
							blnEN5 = True
							strSQL = strDIA & " NUM_DIAGRAMA=4 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux.Fields("ORDEN_N3").Value
							rstAux6 = mfRecordset(conPasarela, strSQL)
							strSQL = "SELECT DISTINCT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR='' and orden_n1=" & rstAux6.Fields("ORDEN_N1").Value
							rstAux3 = mfRecordset(conPasarela, strSQL)
							While Not rstAux3.EOF
								strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
								rstAux4 = mfRecordset(conPasarela, strSQL)
								If rstAux4.EOF = True Then
									rstAux3.MoveNext()
								Else
									blnEnCONTRA = True
									strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR = ('Conector Opcional')"
									rstAux3 = mfRecordset(conPasarela, strSQL)
									If rstAux3.RecordCount > 1 Then
										strsalto = "PR_FINEXPEDIENTE"
									Else
										strsalto = ""
									End If
									GoTo meteJump
								End If
							End While
							If blnEnCONTRA = False Then
								strSQL = strDIA & " NUM_DIAGRAMA=4 AND ID_DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux.Fields("ORDEN_N2").Value
								rstAux6 = mfRecordset(conPasarela, strSQL)
								strSQL = strCon_DI & " NUM=" & rstAux6.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR=''"
								rstAux3 = mfRecordset(conPasarela, strSQL)
								While Not rstAux3.EOF
									strSQL = strDIA & " ID_PADRE=" & rstAux6.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
									rstAux4 = mfRecordset(conPasarela, strSQL)
									If rstAux4.EOF = True Then
										rstAux3.MoveNext()
									Else
										blnEnCONTRA = True
										strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM= 3 AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR = ('Conector Opcional')"
										rstAux3 = mfRecordset(conPasarela, strSQL)
										If rstAux3.RecordCount > 1 Then
											strsalto = "PR_FINEXPEDIENTE"
										Else
											strsalto = ""
										End If
										GoTo meteJump
									End If
								End While
							End If
						End If
					End If
					strsalto = "PR_FINEXPEDIENTE"
meteJump: 
					If strsalto = "" Then
						If blnEN2 = True Then
							strSQL = ""
							If Not rstAux4.EOF Then
								strSQL = strPROP_DI & "=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux4.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							Else
								strSQL = strPROP_DI & "=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							End If
							rstAux7 = mfRecordset(conPasarela, strSQL)
							Do While Not rstAux7.EOF
								If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
									strsalto = rstAux7.Fields("NOM_DIAGRAMA").Value
									Exit Do
								End If
								rstAux7.MoveNext()
								strsalto = "PR_FINEXPEDIENTE"
							Loop 
							strSQL = strPROP_DI & "=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
							rstAux7 = mfRecordset(conPasarela, strSQL)
							If rstAux7.Fields("NOM_DIAGRAMA").Value = strsalto Then
								strsalto = "PR_FINEXPEDIENTE"
							End If
						ElseIf blnEN3 = True Then 
							If Not rstAux4.EOF Then
								strSQL = strPROP_DI & "=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >= " & rstAux4.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								rstAux7 = mfRecordset(conPasarela, strSQL)
								Do While Not rstAux7.EOF
									If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
										strsalto = rstAux7.Fields("NOM_DIAGRAMA").Value
										Exit Do
									End If
									rstAux7.MoveNext()
									strsalto = "PR_FINEXPEDIENTE"
								Loop 
							Else
								strsalto = "PR_FINEXPEDIENTE"
							End If
						ElseIf blnEN4 = True Then 
							If Not rstAux4.EOF Then
								strSQL = strPROP_DI & "=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >= " & rstAux4.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							End If
							rstAux7 = mfRecordset(conPasarela, strSQL)
							Do While Not rstAux7.EOF
								If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
									strsalto = rstAux7.Fields("NOM_DIAGRAMA").Value
									Exit Do
								End If
								rstAux7.MoveNext()
								strsalto = "PR_FINEXPEDIENTE"
							Loop 
							strSQL = strPROP_DI & "=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
							rstAux7 = mfRecordset(conPasarela, strSQL)
							If rstAux7.Fields("NOM_DIAGRAMA").Value = strsalto Then
								strsalto = "PR_FINEXPEDIENTE"
							End If
						ElseIf blnEN5 = True Then 
							strSQL = strPROP_DI & "=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstAux4.Fields("ORDEN_N4").Value & " and orden_n5 >=" & rstAux4.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							rstAux7 = mfRecordset(conPasarela, strSQL)
							Do While Not rstAux7.EOF
								If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
									strsalto = rstAux7.Fields("NOM_DIAGRAMA").Value
									Exit Do
								End If
								rstAux7.MoveNext()
								strsalto = "PR_FINEXPEDIENTE"
							Loop 
							strSQL = strPROP_DI & "=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
							rstAux7 = mfRecordset(conPasarela, strSQL)
							If rstAux7.Fields("NOM_DIAGRAMA").Value = strsalto Then
								strsalto = "PR_FINEXPEDIENTE"
							End If
						End If
					End If
					If Not rstAux3.EOF Then
						If rstAux3.Fields("SALIDA").Value = "S" And blnEN2 = True Then
							blnAux = False
							
							If Not rstAux5 Is Nothing Then
								rstAux5.Requery()
								If InStr(1, rstAux5.Source, "CONECTORES_DI") > 0 Then
									If Not rstAux5.EOF And Not rstAux5.BOF Then
										If RTrim(rstAux5.Fields("Cat_Conector2").Value) = "Caducar Expediente" Then
											blnAux = True
										End If
									End If
								End If
							ElseIf Not rstAux5B Is Nothing Then 
								rstAux5B.Requery()
								If Not rstAux5B.EOF And Not rstAux5B.BOF Then
									If RTrim(rstAux5B.Fields("Cat_Conector2").Value) = "Caducar Expediente" Then
										blnAux = True
									End If
								End If
								
							End If
							If Not rstAux6 Is Nothing And blnAux = True Then
								strSQL = strCon_DI & " NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND DIAGRAMA= " & rstAux6.Fields("ID_PADRE").Value
								GoTo Prueba
							Else
								GoTo FIN
							End If
							'fin aketza
						End If
					End If
					If blnEN2 = True Then
						If Not rstAux5 Is Nothing Then
							strSQL = strCon_DI & " NUM_SEC_DESDE=" & rstAux5.Fields("NUM_SEQ").Value & " AND DIAGRAMA= " & rstAux5.Fields("ID_PADRE").Value
						ElseIf Not rstAux4 Is Nothing Then 
							If rstAux4.RecordCount > 0 Then
								'igor 11/07/2008
								'aketza 28/02/2008
								GoTo aqui2 '
								'fin aketza
							Else
								GoTo FIN
							End If
						Else
							GoTo FIN
						End If
						'aketza 15/05/2007
Prueba: 
						'fin aketza
						rstAUX8 = mfRecordset(conPasarela, strSQL)
						If Not rstAUX8.EOF Then
							If Trim(rstAUX8.Fields("CAT_CONECTOR2").Value) <> "" Then 'And rstAUX8("CAT_CONECTOR") <> "Fin de plazo 1" Then
								Select Case UCase(Trim(Replace(rstAUX8.Fields("CAT_CONECTOR2").Value, " ", "")))
									Case "CADUCAREXPEDIENTE"
										lngORACC2 = lngORACC + 2
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CADUCAREXPEDIENTE'"
										rstAUX9 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAUX9.Fields(0).Value & "") + 1
										mfInserta_ACCIONES(rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC2, 0, "CADUCAREXPEDIENTE", lngNumAcc, "G", "APE_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
										blnInserta = True
										msInsertaParamAcc("", "", rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC2)
										blnInserta = False
										lngORACC2 = lngORACC2 + 1
										mfInserta_ACCIONES(rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC2, 0, "ENDPROC", lngNumAcc, "", "EDP_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
										lngORACC2 = lngORACC2 + 1
										mfInserta_ACCIONES(rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC2, 0, "PROCESS", lngNumAcc, "", "PRO_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
										strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC2 - 2
										mfExecute(conPasarela, strSQL)
										strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
										rstAcc = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
										lngORACC2 = lngORACC2 + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & ", " & rstAux.Fields("ORDEN_N2").Value & ", " & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & "," & rstAux.Fields("ORDEN_N5").Value & "," & lngORACC2 & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
										mfExecute(conPasarela, strSQL)
										
										blnInserta = False
										msInsertaParamAcc("PATH", "FIN " & Mid(strNombre, 1, lngNombre), rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC2)
										strSQL = "SELECT distinct * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and CAT_CONECTOR in ('Fin de plazo 1')"
										rstAUX8 = mfRecordset(conPasarela, strSQL)
										If rstAUX8.EOF Then
											GoTo solo1J
										End If
									Case "FINEXPEDIENTE", "FINDEASUNTO"
										lngORACC = lngORACC + 1
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='FINEXPEDIENTE'"
										rstAUX9 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAUX9.Fields(0).Value & "") + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,TIPO_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'FINEXPEDIENTE', " & lngNumAcc & "," & "'F','APE_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										blnInserta = True
										msInsertaParamAcc("", "", rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
										blnInserta = False
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & ",'ENDPROC', " & lngNumAcc & " ,'EDP_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'PROCESS', " & lngNumAcc & " ," & "'PRO_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
										mfExecute(conPasarela, strSQL)
									Case Else
										GoTo FIN
								End Select
							Else
								If rstAux.Fields("NUM_DIAGRAMA").Value <> 2 Then
									GoTo FIN
								Else
									GoTo aqui2
								End If
							End If
						Else
							GoTo FIN
						End If
					ElseIf blnEN3 = True Then 
aqui2: 
						strSQL = strCon_DI & " NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND DIAGRAMA= " & rstAux.Fields("ID_PADRE").Value & " AND CAT_CONECTOR2<>''"
						rstAUX8 = mfRecordset(conPasarela, strSQL)
						If rstAUX8.EOF Then
							rstAUX8 = mfRecordset(conPasarela, rstAux3.Source)
						End If
						If Not rstAUX8.EOF Then
							If Trim(rstAUX8.Fields("CAT_CONECTOR2").Value) <> "" Then
								Select Case UCase(Trim(Replace(rstAUX8.Fields("CAT_CONECTOR2").Value, " ", "")))
									Case "CADUCAREXPEDIENTE"
										lngORACC = lngORACC + 2
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CADUCAREXPEDIENTE'"
										rstAUX9 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAUX9.Fields(0).Value & "") + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,TIPO_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'CADUCAREXPEDIENTE', " & lngNumAcc & ",'G','APE_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										blnInserta = True
										msInsertaParamAcc("", "", rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
										blnInserta = False
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'ENDPROC', " & lngNumAcc & " ," & "'EDP_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'PROCESS', " & lngNumAcc & " ," & "'PRO_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
										mfExecute(conPasarela, strSQL)
										strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
										rstAcc = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & ", " & rstAux.Fields("ORDEN_N2").Value & ", " & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & "," & rstAux.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
										mfExecute(conPasarela, strSQL)
										blnInserta = False
										msInsertaParamAcc("PATH", "FIN " & Mid(strNombre, 1, lngNombre), rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
										If rstAUX8.Fields("CAT_CONECTOR").Value <> "Fin de plazo 1" Then
											GoTo solo1J
										End If
									Case "FINEXPEDIENTE", "FINDEASUNTO"
										lngORACC = lngORACC + 1
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='FINEXPEDIENTE'"
										rstAUX9 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAUX9.Fields(0).Value & "") + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,TIPO_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'FINEXPEDIENTE', " & lngNumAcc & "," & "'F','APE_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										blnInserta = True
										msInsertaParamAcc("", "", rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
										blnInserta = False
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & ",'ENDPROC', " & lngNumAcc & " ,'EDP_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'PROCESS', " & lngNumAcc & " ," & "'PRO_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
										mfExecute(conPasarela, strSQL)
									Case Else
										GoTo FIN
								End Select
							Else
								GoTo FIN
							End If
						Else
							GoTo FIN
						End If
					ElseIf blnEN4 = True Then 
						If Not rstAux6 Is Nothing Then
							strSQL = strCon_DI & " NUM_SEC_DESDE=" & rstAux6.Fields("NUM_SEQ").Value & " AND DIAGRAMA= " & rstAux6.Fields("ID_PADRE").Value
						Else
							strSQL = strCon_DI & " NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND DIAGRAMA= " & rstAux.Fields("ID_PADRE").Value
						End If
						rstAUX8 = mfRecordset(conPasarela, strSQL)
						If Not rstAUX8.EOF Then
							If rstAUX8.Fields("ORDEN_N1").Value <> 0 Then
								strSQL = strCon_DI & " NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND DIAGRAMA= " & rstAux.Fields("ID_PADRE").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
								rstAUX8 = mfRecordset(conPasarela, strSQL)
							End If
						End If
						If Not rstAUX8.EOF Then
							If Trim(rstAUX8.Fields("CAT_CONECTOR2").Value) <> "" Then
								Select Case UCase(Trim(Replace(rstAUX8.Fields("CAT_CONECTOR2").Value, " ", "")))
									Case "CADUCAREXPEDIENTE"
										lngORACC = lngORACC + 1
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CADUCAREXPEDIENTE'"
										rstAUX9 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAUX9.Fields(0).Value & "") + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,TIPO_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'CADUCAREXPEDIENTE', " & lngNumAcc & ",'G','APE_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										blnInserta = True
										msInsertaParamAcc("", "", rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
										blnInserta = False
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'ENDPROC', " & lngNumAcc & " ," & "'EDP_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'PROCESS', " & lngNumAcc & " ," & "'PRO_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_CADUCAREXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
										mfExecute(conPasarela, strSQL)
										strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
										rstAcc = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & ", " & rstAux.Fields("ORDEN_N2").Value & ", " & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & "," & rstAux.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
										mfExecute(conPasarela, strSQL)
										blnInserta = False
										msInsertaParamAcc("PATH", "FIN " & Mid(strNombre, 1, lngNombre), rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
										If rstAUX8.Fields("CAT_CONECTOR").Value = "Fin de plazo 1" Then
											GoTo solo1J
										End If
									Case "FINEXPEDIENTE", "FINDEASUNTO"
										lngORACC = lngORACC + 1
										strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='FINEXPEDIENTE'"
										rstAUX9 = mfRecordset(conPasarela, strSQL)
										lngNumAcc = Val(rstAUX9.Fields(0).Value & "") + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,TIPO_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'FINEXPEDIENTE', " & lngNumAcc & "," & "'F','APE_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										blnInserta = True
										msInsertaParamAcc("", "", rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
										blnInserta = False
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & ",'ENDPROC', " & lngNumAcc & " ,'EDP_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										lngORACC = lngORACC + 1
										strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & ", " & rstAux.Fields("ORDEN_N5").Value & ", " & lngORACC & "," & "'PROCESS', " & lngNumAcc & " ," & "'PRO_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "')"
										mfExecute(conPasarela, strSQL)
										strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_FINEXPEDIENTE" & VB6.Format(lngNumAcc, "00") & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
										mfExecute(conPasarela, strSQL)
										If rstAUX8.Fields("CAT_CONECTOR").Value = "Fin de plazo 1" Then
											GoTo solo1J
										End If
									Case Else
										GoTo FIN
								End Select
							Else
								If rstAux.Fields("NUM_DIAGRAMA").Value <> 2 Then
									GoTo FIN
								Else
									GoTo aqui2
								End If
							End If
						Else
							GoTo FIN
						End If
					End If
FIN: 
					'*CAMBIO
					If bln2SALTO = True Then
						strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
						rstAcc = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
						lngORACC = lngORACC + 1
						
						mfInserta_ACCIONES(rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
						blnInserta = False
						'msInsertaParamAcc "PATH", strsalto, rstAux("ORDEN_N1"), rstAux("ORDEN_N2"), rstAux("ORDEN_N3"), rstAux("ORDEN_N4"), rstAux("ORDEN_N5"), rstAux2("ORDEN_ACC") + rstAux3.AbsolutePosition
						msInsertaParamAcc("PATH", strsalto, rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
						contador = contador + 1
						If rstAux3.RecordCount <> rstAux3.AbsolutePosition Then
							If rstAux.Fields("SALIDAS").Value = 1 Then
								rst1C = rstAux3.Clone
								rst2C = rstAux.Clone
								rst2C.AbsolutePosition = rstAux.AbsolutePosition
								If mfConectoresValidos(rst1C, rst2C) <= contador Then
									GoTo solo1J
									'## DS66 25/03/09
								Else
									If msCalc(rstAux, rstAux3) = True Then GoTo solo1J
									'##
								End If
							End If
							If Not rstAux3.EOF Then
								rstAux3.MoveNext()
								GoTo salto2
							End If
						End If
					Else
						strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
						rstAcc = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
						If Not rstAUX8 Is Nothing Then
							If Not rstAUX8.EOF Then
								If UCase(rstAUX8.Fields("CAT_CONECTOR2").Value) = "FIN EXPEDIENTE" Then
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND PATH_HIDRA LIKE 'APE_" & UCase(Trim(Replace(rstAUX8.Fields("CAT_CONECTOR2").Value, " ", ""))) & "%'"
									rstAux7 = mfRecordset(conPasarela, strSQL)
									lngORACC = rstAux7.Fields("ORDEN_ACC").Value + 2
									strsalto = "FIN " & Mid(strNombre, 1, lngNombre)
								ElseIf rstAUX8.Fields("CAT_CONECTOR2").Value <> "" Then 
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND PATH_HIDRA LIKE 'APE_" & UCase(Trim(Replace(rstAUX8.Fields("CAT_CONECTOR2").Value, " ", ""))) & "%'"
									rstAux7 = mfRecordset(conPasarela, strSQL)
									If Not rstAux7.EOF Then
										lngORACC = rstAux7.Fields("ORDEN_ACC").Value - 1
										strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value & " and ORDEN_ACC >= " & rstAux7.Fields("ORDEN_ACC").Value & " ORDER BY ORDEN_ACC DESC"
										rstAux7 = mfRecordset(conPasarela, strSQL)
										Do While Not rstAux7.EOF
											strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux7.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rstAux7.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value
											mfExecute(conPasarela, strSQL)
											strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux7.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rstAux7.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value
											mfExecute(conPasarela, strSQL)
											rstAux7.MoveNext()
										Loop 
									End If
								End If
							End If
						End If
						lngORACC = lngORACC + 1
						strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & ", " & rstAux.Fields("ORDEN_N2").Value & ", " & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & "," & rstAux.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "')"
						mfExecute(conPasarela, strSQL)
						blnInserta = False
						msInsertaParamAcc("PATH", strsalto, rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
					End If
				Else
					If buscaTodo = True Then
						strSQL = "SELECT DISTINCT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 1','Fin de plazo 2') AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " and NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value
						rstAux3 = mfRecordset(conPasarela, strSQL)
						If rstAux3.EOF Then
							GoTo solo1J
						End If
						If rstAux3.Fields("ORDEN_N1").Value <> 0 Then
							strSQL = "SELECT DISTINCT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 1','Fin de plazo 2') AND NUM_SEC_DESDE=" & rstAux.Fields("NUM_SEQ").Value & " AND DIAGRAMA=" & rstAux.Fields("ID_PADRE").Value & " and NUM=" & rstAux.Fields("NUM_DIAGRAMA").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value
							rstAux3 = mfRecordset(conPasarela, strSQL)
						End If
						If rstAux.Fields("SALIDAS").Value < rstAux3.RecordCount Then
							colConectores = New Collection
							While Not rstAux3.EOF
								strSQL = strDIA & " ID_PADRE=" & rstAux3.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value
								rstAux4 = mfRecordset(conPasarela, strSQL)
								If rstAux4.EOF Then
									GoTo solo1J
								Else
									If rstAux4.RecordCount > 1 Then
										strSQL = strDIA & " ID_PADRE=" & rstAux3.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux3.Fields("NUM_SEC_HASTA").Value & " AND ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value
										rstAux4 = mfRecordset(conPasarela, strSQL)
									End If
								End If
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
								rstAux5 = mfRecordset(conPasarela, strSQL)
								If rstAux5.Fields("NOM_DIAGRAMA").Value <> "" Then
									colConectores.Add(CStr(rstAux5.Fields("NOM_DIAGRAMA").Value))
								Else
									If rstAux5.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strPROP_DI & "> =" & rstAux5.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux5.Fields("ORDEN_N3").Value = 0 Then 
										strSQL = strPROP_DI & "=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux5.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux5.Fields("ORDEN_N4").Value = 0 Then 
										strSQL = strPROP_DI & "=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux5.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux5.Fields("ORDEN_N5").Value = 0 Then 
										strSQL = strPROP_DI & "=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux5.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									End If
									rstAux6 = mfRecordset(conPasarela, strSQL)
									Do While Not rstAux6.EOF
										If rstAux6.Fields("NOM_DIAGRAMA").Value <> "" Then
											colConectores.Add(CStr(rstAux6.Fields("NOM_DIAGRAMA").Value))
											Exit Do
										End If
										rstAux6.MoveNext()
									Loop 
								End If
								rstAux3.MoveNext()
							End While
							strSQL = "SELECT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND LEFT(VALOR,3)= 'PR_'"
							rstAux3 = mfRecordset(conPasarela, strSQL)
							While Not rstAux3.EOF
								strSALTOSREALES = strSALTOSREALES & rstAux3.Fields("VALOR").Value & ";"
								rstAux3.MoveNext()
							End While
							For	Each icol In colConectores
								'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								If InStr(1, strSALTOSREALES, icol) = 0 Then
									strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstAux3 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux3.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									'''                              strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," _
									''''                                 & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
									''''                                 & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
									''''                                 & "'" & gNomProcCorto & "'," & rstAux("ORDEN_N1") & ", " & rstAux("ORDEN_N2") & ", " & rstAux("ORDEN_N3") _
									''''                                 & "," & rstAux("ORDEN_N4") & "," & rstAux("ORDEN_N5") & "," & lngORACC & "," _
									''''                                 & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "')"
									'''                              mfExecute conPasarela, strSQL
									mfInserta_ACCIONES(rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
									blnInserta = False
									'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									msInsertaParamAcc("PATH", CStr(icol), rstAux.Fields("ORDEN_N1").Value, rstAux.Fields("ORDEN_N2").Value, rstAux.Fields("ORDEN_N3").Value, rstAux.Fields("ORDEN_N4").Value, rstAux.Fields("ORDEN_N5").Value, lngORACC)
									'Exit For
								End If
							Next icol
						End If
					End If
				End If
			End If
solo1J: 
			rstAux.MoveNext()
		End While
		
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Solución Jumps", "Ha ocurrido un error no controlado", "msSolucionJumps") '& " -" & strSeg
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msSolucionJumps- " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	'## DS66 25/03/09
	'Private Function msPas(ByVal rstAux As ADODB.Recordset) As Boolean
	'
	'Dim rst1C As ADODB.Recordset
	'Dim strSQL As String
	'
	'strSQL = "select * from param_acc WHERE PROCEDIMIENTO='PO093010' and orden_n1=" & rstAux("ORDEN_N1") & " and orden_n2=" & rstAux("ORDEN_N2") & "  and orden_n3=" & rstAux("ORDEN_N3") & "  and orden_n4=" & rstAux("ORDEN_N4") & "  and orden_n5=" & rstAux("ORDEN_N5") & "  and parametro='PATH' and valor not like ('ALRT%') and valor like ('PR_%')"
	'
	'Set rst1C = mfRecordset(conPasarela, strSQL)
	'
	'If rst1C.EOF = False Then
	'   msPas = True
	'   cont = 1
	'Else
	'   msPas = False
	'End If
	'
	'End Function
	'##
	'## DS66 25/03/09
	Private Function msCalc(ByVal rstAux As ADODB.Recordset, ByVal rstAux3 As ADODB.Recordset) As Boolean
		
		Dim rst1C As ADODB.Recordset
		Dim strSQL As String
		
		strSQL = Replace(rstAux3.Source, "'Fin de plazo 1',", "")
		rst1C = mfRecordset(conPasarela, strSQL)
		If rst1C.RecordCount > 2 Then
			If rst1C.RecordCount > rstAux3.RecordCount Then
				strSQL = "select * from Acciones_di where Procedimiento='" & gNomProcCorto & "' and ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " and ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " and ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " and ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " and path_Hidra like('%CADUCARTRAMITE%')"
				rst1C = mfRecordset(conPasarela, strSQL)
				If rst1C.RecordCount > 0 Then
					'GoTo solo1J
					msCalc = True
				Else
					msCalc = False
				End If
			End If
		End If
		
	End Function
	'##
	
	Private Sub msSolucionWait()
		On Error GoTo procErr
		Dim strAux, nomVarHN, strTF, strSQL, strURP, strPath, strValorV, strError As String
		Dim rstconE, rstAcc, rst7, rst5, rst3, rst1R, rst1, rst2, rst4, rst6, rst9, rstparamHN, rstparamCME As ADODB.Recordset
		Dim colXML2, colTramG, colTram, colTramB, colRami, colXMLD As Collection
		Dim icol, iColB As Object
		Dim lngTDAUT, lngNumAcc, lngOr5, lngOr3, lngOr1, lngOr2, lngOr4, lngF, lngWAIT, I As Integer
		Dim blnAUT, blnExclu, blnRamifi As Boolean
		Dim strSel_Con_DI, strSel_prop_DI, strOrden, strIns_prop_DI, strIns_diag, strIns_Acc_DI, strSel_diag, strSel_Acc_DI, strAuxiliar As String
		Dim rstRepe As ADODB.Recordset
		Dim lngNumWait, numRows As Integer
		
		strOrden = "ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5"
		strIns_diag = "PROCEDIMIENTO," & strOrden & ",NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA"
		strIns_prop_DI = "PROCEDIMIENTO," & strOrden & ",NOM_DIAGRAMA,ID_DIAGRAMA"
		strIns_Acc_DI = "PROCEDIMIENTO," & strOrden & ",ORDEN_ACC,NOM_ACCION,NUM_ACCION"
		strSel_diag = strOrden & ",ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,INDCOMUN,DI_ID"
		strSel_prop_DI = strOrden & ",ID_DIAGRAMA,NOM_DIAGRAMA,TIPO_DIAGRAMA,PLAZTIP1_DI,PLAZTIP2_DI,NIVELTRAM_DI,INDBLOQ_DI,INDRAM_DI,INDPERSINT"
		strSel_Acc_DI = strOrden & ",ORDEN_ACC,ID_ACCION,NOM_ACCION,NUM_ACCION,TIPO_ACCION,PATH_HIDRA,NUM_SEQ,DI_ID,NOMBRE,METOFLY"
		strSel_Con_DI = "ID_CONECTOR,DIAGRAMA,NUM,NUM_SEC_DESDE,NUM_SEC_HASTA,CAT_CONECTOR,CAT_CONECTOR2,DI_ID,ORDEN_N1"
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		colTram = New Collection
		colTramB = New Collection
		colTramG = New Collection
		colRami = New Collection
		strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITMOMENTANEO' ORDER BY " & strOrden
		rst1 = mfRecordset(conPasarela, strSQL)
		While Not rst1.EOF
			For I = 1 To colRami.Count()
				colRami.Remove(1)
			Next I
			For I = 1 To colTram.Count()
				colTram.Remove(1)
			Next I
			For I = 1 To colTramB.Count()
				colTramB.Remove(1)
			Next I
			For I = 1 To colTramG.Count()
				colTramG.Remove(1)
			Next I
			If rst1.Fields("ORDEN_N2").Value = 0 Then
				strSQL = "SELECT " & strSel_prop_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 >= " & rst1.Fields("ORDEN_N1").Value & " ORDER BY " & strOrden
			ElseIf rst1.Fields("ORDEN_N3").Value = 0 Then 
				strSQL = "SELECT " & strSel_prop_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rst1.Fields("ORDEN_N2").Value & " ORDER BY " & strOrden
			End If
			rst1R = mfRecordset(conPasarela, strSQL)
			Do While Not rst1R.EOF
				If rst1R.Fields("NOM_DIAGRAMA").Value <> "" Then
					blnRamifi = True
					Exit Do
				End If
				rst1R.MoveNext()
				blnRamifi = False
			Loop 
			If blnRamifi = False Then
				rst1R = rst1
				rst1R.AbsolutePosition = rst1.AbsolutePosition
			End If
			strSQL = "SELECT " & strSel_prop_DI & " FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
			rst9 = mfRecordset(conPasarela, strSQL)
			strURP = rst9.Fields("NOM_DIAGRAMA").Value
			strSQL = "SELECT " & strSel_diag & " FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value
			rst9 = mfRecordset(conPasarela, strSQL)
			If rst9.Fields("NUM_DIAGRAMA").Value > 1 Then
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rst9.Fields("ID_PADRE").Value & " AND NUM_SEC_HASTA=" & rst9.Fields("NUM_SEQ").Value & " and ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value
			Else
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rst9.Fields("ID_PADRE").Value & " AND NUM_SEC_HASTA=" & rst9.Fields("NUM_SEQ").Value
			End If
			rst2 = mfRecordset(conPasarela, strSQL)
			While Not rst2.EOF
				If rst2.Fields("NUM").Value > 1 Then
					strSQL = "SELECT " & strSel_diag & " from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rst2.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rst2.Fields("NUM_SEC_DESDE").Value & " AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value
				Else
					strSQL = "SELECT " & strSel_diag & " from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rst2.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rst2.Fields("NUM_SEC_DESDE").Value
				End If
				rst3 = mfRecordset(conPasarela, strSQL)
				If Not rst3.EOF Then
					If rst3.Fields("CAT_DIAGRAMA").Value = "Ramificación" Then
						colRami.Add(rst3)
					ElseIf rst3.Fields("CAT_DIAGRAMA").Value = "Trámite automático" Then 
						colTramG.Add(rst3)
					Else
						colTram.Add(rst3)
						colTramB.Add(rst3)
					End If
				End If
				rst2.MoveNext()
			End While
			For	Each icol In colRami
				strSQL = "SELECT COUNT(*) FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA LIKE 'PR_TRAMITEFICTICIO%'"
				rst4 = mfRecordset(conPasarela, strSQL)
				strTF = "PR_TRAMITEFICTICIO" & VB6.Format(Val(rst4.Fields(0).Value & "") + 1, "00")
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				If icol(1) = 0 Then
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", 100," & icol(2) & "," & icol(3) & "," & icol(4) & "," & icol(13) & ",'" & strTF & "','S',999999)"
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					mfInserta_PROPIEDADES(icol(0), 100, icol(2), icol(3), icol(4), 999999, strTF, "", "", "", "", "", "", "0")
					'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", 100," & icol(2) & "," & icol(3) & "," & icol(4) & ",'" & strTF & "',999999)"
					'mfExecute conPasarela, strSQL
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr1 = icol(0)
					lngOr2 = 100
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr3 = icol(2)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr4 = icol(3)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr5 = icol(4)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0)
					mfExecute(conPasarela, strSQL,  , numRows)
					
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				ElseIf icol(2) = 0 Then 
					'strSQL = "select * from DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and orden_n1=" & icol(0) & " and orden_n2= " & icol(1) & " and orden_n3 = 100"
					'Set rstRepe = mfRecordset(conPasarela, strSQL)
					'If rstRepe.EOF Then
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & ",100," & icol(3) & "," & icol(4) & "," & icol(13) & ",'" & strTF & "','S',999999)"
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					mfInserta_PROPIEDADES(icol(0), icol(1), 100, icol(3), icol(4), 999999, strTF, "", "", "", "", "", "", "0")
					'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & ",100," & icol(3) & "," & icol(4) & ",'" & strTF & "',999999)"
					'mfExecute conPasarela, strSQL
					'Else
					'   strTF = rstRepe("NOMBRE")
					'End If
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr1 = icol(0)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr2 = icol(1)
					lngOr3 = 100
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr4 = icol(3)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr5 = icol(4)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND " & "ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1)
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				ElseIf icol(3) = 0 Then 
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & ",100," & icol(4) & "," & icol(13) & ",'" & strTF & "','S',999999)"
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					mfInserta_PROPIEDADES(icol(0), icol(1), icol(2), 100, icol(4), 999999, strTF, "", "", "", "", "", "", "0")
					'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & ",100," & icol(4) & "," & icol(13) & ",'" & strTF & "',999999)"
					'mfExecute conPasarela, strSQL
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr1 = icol(0)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr2 = icol(1)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr3 = icol(2)
					lngOr4 = 100
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr5 = icol(4)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2)
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				ElseIf icol(4) = 0 Then 
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & "," & icol(4) & ",99," & icol(13) & ",'" & strTF & "',999999)"
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					mfInserta_PROPIEDADES(icol(0), icol(1), icol(2), icol(3), 99, 999999, strTF, "", "", "", "", "", "", "0")
					'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & "," & icol(4) & ",99," & icol(13) & ",'" & strTF & "',999999)"
					'mfExecute conPasarela, strSQL
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr1 = icol(0)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr2 = icol(1)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr3 = icol(2)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					lngOr4 = icol(3)
					lngOr5 = 99
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2) & " AND ORDEN_N4=" & icol(3)
					mfExecute(conPasarela, strSQL)
				End If
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				If icol(1) = 0 Then
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0)
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				ElseIf icol(2) = 0 Then 
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND " & "ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1)
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				ElseIf icol(3) = 0 Then 
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2)
					mfExecute(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				ElseIf icol(4) = 0 Then 
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2) & " AND ORDEN_N4=" & icol(3)
					mfExecute(conPasarela, strSQL)
				End If
				strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstAcc = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
				strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & lngOr1 & ", " & lngOr2 & " , " & lngOr3 & "," & lngOr4 & ", " & lngOr5 & ", 1," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", strURP, lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, 1)
				blnInserta = True
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_CONECTOR='Fin de plazo 2' AND NUM_SEC_DESDE=" & icol(15)
				rst3 = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_ACC DESC"
				rst4 = mfRecordset(conPasarela, strSQL)
				While Not rst4.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst4.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst4.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					rst4.MoveNext()
				End While
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITALL'"
				rst6 = mfRecordset(conPasarela, strSQL)
				lngWAIT = Val(rst6.Fields(0).Value & "") + 1
				If Not rst5 Is Nothing Then
					If Not rst5.EOF Then
						strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", " & rst5.Fields("ORDEN_ACC").Value - 1 & "," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
					Else
						strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", 1," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
					End If
				Else
					strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", 1," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
				End If
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				If Not rst5 Is Nothing Then
					If Not rst5.EOF Then
						msInsertaParamAcc("PATH", "JUMP" & VB6.Format(lngNumAcc, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst5.Fields("ORDEN_ACC").Value - 1)
					Else
						msInsertaParamAcc("PATH", "JUMP" & VB6.Format(lngNumAcc, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
					End If
				Else
					msInsertaParamAcc("PATH", "JUMP" & VB6.Format(lngNumAcc, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
				End If
				blnInserta = True
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(15). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rst9.Fields("ID_PADRE").Value & " AND NUM_SEC_HASTA=" & rst9.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE=" & icol(15)
				rst2 = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rst9.Fields("ID_PADRE").Value & " AND NUM_SEC_HASTA=" & rst2.Fields("NUM_SEC_DESDE").Value & " AND CAT_CONECTOR='Conector Opcional'"
				rst3 = mfRecordset(conPasarela, strSQL)
				If Not rst3.EOF Then
					strSQL = "SELECT FlowOrder From wfFlowActions WHERE (RTRIM(Flow)='TDAUTOMATICA') AND (RTRIM(Action) = 'LABEL') ORDER BY FLOWORDER"
					'Set rst7 = mfRecordset(conInfra, strSQL)
					rst7 = mfRecordset(conGene, strSQL)
					If Not rst7.EOF Then
						lngF = rst7.Fields("FLOWORDER").Value
						rst7.Close()
						strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='TDAUTOMATICA' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
						
						'Set rstParamHN = mfRecordset(conInfra, strSQL)
						rstparamHN = mfRecordset(conGene, strSQL)
					End If
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TDAUTOMATICA'"
					rst7 = mfRecordset(conPasarela, strSQL)
					lngTDAUT = Val(rst7.Fields(0).Value & "") + 1
					strPath = "APE_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_ACC DESC"
					rst4 = mfRecordset(conPasarela, strSQL)
					Do While Not rst4.EOF
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value + 3 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst4.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value + 3 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst4.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						If rst4.Fields("PATH_HIDRA").Value = "WAIT" & VB6.Format(lngWAIT, "00") Then
							Exit Do
						End If
						rst4.MoveNext()
					Loop 
					strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",TIPO_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & "," & rst1R.Fields("ORDEN_N2").Value & "," & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & "," & rst4.Fields("ORDEN_ACC").Value & "," & "'TDAUTOMATICA'," & lngTDAUT & ",'G','" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strSQL = "Select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rst3.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rst3.Fields("NUM_SEC_DESDE").Value & " AND SH_SEQ_TO=" & rst3.Fields("NUM_SEC_HASTA").Value & " AND DI_ID=" & rst3.Fields("DI_ID").Value & " AND DM_INSERTS=1"
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					rstconE = mfRecordset(conDP4, strSQL)
					strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " ORDER BY C.DM_SEQ"
					rstparamCME = mfRecordset(conDP4, strSQL)
					blnInserta = True
					If Not rstparamCME.EOF Then
						Do While Not rstparamCME.EOF
							If rstparamCME.AbsolutePosition = 4 Then Exit Do
							Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
								Case "Constantes"
									colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
									'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strValorV = colXMLD.Item(1)
									If strValorV <> "" Then
										msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst4.Fields("ORDEN_ACC").Value)
									End If
								Case ""
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst4.Fields("ORDEN_ACC").Value)
								Case Else
									'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst4.Fields("ORDEN_ACC").Value)
							End Select
							rstparamCME.MoveNext()
							rstparamHN.MoveNext()
						Loop 
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "WAIT" & VB6.Format(lngWAIT, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst4.Fields("ORDEN_ACC").Value)
						rstparamHN.MoveNext()
						strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > " & rst4.Fields("ORDEN_ACC").Value & " AND NOM_ACCION <> 'WAITMOMENTANEO' and PATH_HIDRA<>'WAIT" & VB6.Format(lngWAIT, "00") & "' ORDER BY ORDEN_ACC ASC"
						rst6 = mfRecordset(conPasarela, strSQL)
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rst6.Fields("PATH_HIDRA").Value, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst4.Fields("ORDEN_ACC").Value)
					End If
					strPath = "EDP_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
					strSQL = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & "," & rst4.Fields("ORDEN_ACC").Value + 1 & ",'ENDPROC'," & lngTDAUT & ",'" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strPath = "PRO_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
					strSQL = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & "," & rst4.Fields("ORDEN_ACC").Value + 2 & ",'PROCESS'," & lngTDAUT & ",'" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst4.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
				End If
			Next icol
			rst2.MoveFirst()
			For	Each icol In colTram
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(15). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & icol(13) & " AND NUM_SEC_DESDE=" & icol(15) & " AND NUM_SEC_HASTA<>" & rst9.Fields("NUM_SEQ").Value
				rst3 = mfRecordset(conPasarela, strSQL)
				While Not rst3.EOF
					For	Each iColB In colTramB
						If rst3.Fields("NUM_SEC_HASTA").Value = iColB(15) Then
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND E.ANO_ID = " & icol(10)
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							rst4 = mfRecordset(conDP4, strSQL)
							If rst4.RecordCount > 2 Then
								blnExclu = True
								GoTo aqui
							End If
						End If
					Next iColB
					rst3.MoveNext()
				End While
			Next icol
aqui: 
			If blnExclu = True Then
				For	Each icol In colTram
					If blnExclu = True Then
						strSQL = "SELECT COUNT(*) FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA LIKE 'PR_TRAMITEFICTICIO%'"
						rst4 = mfRecordset(conPasarela, strSQL)
						strTF = "PR_TRAMITEFICTICIO" & VB6.Format(Val(rst4.Fields(0).Value & "") + 1, "00")
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If icol(1) = 0 Then
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", 99," & icol(2) & "," & icol(3) & "," & icol(4) & "," & icol(13) & ",'" & strTF & "','S',999999)"
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							mfInserta_PROPIEDADES(icol(0), 99, icol(2), icol(3), icol(4), 999999, strTF, "", "", "", "", "", "", "0")
							'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", 99," & icol(2) & "," & icol(3) & "," & icol(4) & ",'" & strTF & "',999999)"
							'mfExecute conPasarela, strSQL
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr1 = icol(0)
							lngOr2 = 99
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr3 = icol(2)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr4 = icol(3)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr5 = icol(4)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0)
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf icol(2) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & ",99," & icol(3) & "," & icol(4) & "," & icol(13) & ",'" & strTF & "','S',999999)"
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							mfInserta_PROPIEDADES(icol(0), icol(1), 99, icol(3), icol(4), 999999, strTF, "", "", "", "", "", "", "0")
							'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & ",99," & icol(3) & "," & icol(4) & ",'" & strTF & "',999999)"
							'mfExecute conPasarela, strSQL
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr1 = icol(0)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr2 = icol(1)
							lngOr3 = 99
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr4 = icol(3)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr5 = icol(4)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND " & "ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1)
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf icol(3) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & ",99," & icol(4) & "," & icol(13) & ",'" & strTF & "','S',999999)"
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							mfInserta_PROPIEDADES(icol(0), icol(1), icol(2), 99, icol(4), 999999, strTF, "", "", "", "", "", "", "0")
							'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & ",99," & icol(4) & ",'" & strTF & "',999999)"
							'mfExecute conPasarela, strSQL
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr1 = icol(0)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr2 = icol(1)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr3 = icol(2)
							lngOr4 = 99
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr5 = icol(4)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2)
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf icol(4) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(13). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "INSERT INTO DIAGRAMA (" & strIns_diag & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & "," & icol(4) & ",99," & icol(13) & ",'" & strTF & "',999999)"
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							mfInserta_PROPIEDADES(icol(0), icol(1), icol(2), icol(3), 99, 999999, strTF, "", "", "", "", "", "", "0")
							'strSQL = "INSERT INTO PROPIEDADES_DI (" & strIns_prop_DI & ") VALUES ('" & gNomProcCorto & "'," & icol(0) & ", " & icol(1) & "," & icol(2) & "," & icol(4) & ",99,'" & strTF & "',999999)"
							'mfExecute conPasarela, strSQL
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr1 = icol(0)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr2 = icol(1)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr3 = icol(2)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							lngOr4 = icol(3)
							lngOr5 = 99
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2) & " AND ORDEN_N4=" & icol(3)
							mfExecute(conPasarela, strSQL)
						End If
						blnExclu = False
					Else
						'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						If icol(1) = 0 Then
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0)
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf icol(2) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND " & "ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1)
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf icol(3) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2)
							mfExecute(conPasarela, strSQL)
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						ElseIf icol(4) = 0 Then 
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & strURP & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2) & " AND ORDEN_N4=" & icol(3)
							mfExecute(conPasarela, strSQL)
						End If
					End If
				Next icol
				strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  NOM_ACCION='JUMP'"
				rstAcc = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
				strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & lngOr1 & ", " & lngOr2 & " , " & lngOr3 & "," & lngOr4 & ", " & lngOr5 & ", 1," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", strURP, lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, 1)
				blnInserta = True
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITALL'"
				rst6 = mfRecordset(conPasarela, strSQL)
				lngWAIT = Val(rst6.Fields(0).Value & "") + 1
				For	Each icol In colTram
					'strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & colTram(1)(13) & " AND NUM_SEC_HASTA=" & colTram(1)(15) & " AND CAT_CONECTOR='Conector Opcional'"
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(15). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & icol(13) & " AND NUM_SEC_HASTA=" & icol(15) & " AND CAT_CONECTOR='Conector Opcional'"
					rst4 = mfRecordset(conPasarela, strSQL)
					If Not rst4.EOF Then
						Exit For
					End If
				Next icol
				
				
				If Not rst4.EOF Then
					strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION <>'WAITMOMENTANEO' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_ACC"
					rst6 = mfRecordset(conPasarela, strSQL)
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & "  ORDER BY ORDEN_ACC DESC"
					rst5 = mfRecordset(conPasarela, strSQL)
					While Not rst5.EOF
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						rst5.MoveNext()
					End While
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITALL'"
					rst7 = mfRecordset(conPasarela, strSQL)
					lngWAIT = Val(rst7.Fields(0).Value & "") + 1
					strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", 4," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					msInsertaParamAcc("PATH", "JUMP" & VB6.Format(lngNumAcc, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 4)
					blnInserta = True
					strSQL = "SELECT FlowOrder From wfFlowActions WHERE (RTRIM(Flow)='TDAUTOMATICA') AND (RTRIM(Action) = 'LABEL') ORDER BY FLOWORDER"
					'Set rst7 = mfRecordset(conInfra, strSQL)
					rst7 = mfRecordset(conGene, strSQL)
					If Not rst7.EOF Then
						lngF = rst7.Fields("FLOWORDER").Value
						rst7.Close()
						strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='TDAUTOMATICA' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
						'Set rstParamHN = mfRecordset(conInfra, strSQL)
						rstparamHN = mfRecordset(conGene, strSQL)
					End If
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TDAUTOMATICA'"
					rst7 = mfRecordset(conPasarela, strSQL)
					lngTDAUT = Val(rst7.Fields(0).Value & "") + 1
					strPath = "APE_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
					strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",TIPO_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & "," & rst1R.Fields("ORDEN_N2").Value & "," & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & ",1," & "'TDAUTOMATICA'," & lngTDAUT & ",'G','" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strSQL = "Select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rst4.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rst4.Fields("NUM_SEC_DESDE").Value & " AND SH_SEQ_TO=" & rst4.Fields("NUM_SEC_HASTA").Value & " AND DI_ID=" & rst4.Fields("DI_ID").Value & " AND DM_INSERTS=1"
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					
					rstconE = mfRecordset(conDP4, strSQL)
					strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID"
					' **** NUEVO SD ENERO'08
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " ORDER BY C.DM_SEQ"
					
					rstparamCME = mfRecordset(conDP4, strSQL)
					blnInserta = True
					If Not rstparamCME.EOF Then
						While Not rstparamCME.EOF
							Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
								Case "Constantes"
									colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
									'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strValorV = colXMLD.Item(1)
									If strValorV <> "" Then
										msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
									End If
								Case ""
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
								Case Else
									'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
							End Select
							rstparamCME.MoveNext()
							rstparamHN.MoveNext()
						End While
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "WAIT" & VB6.Format(lngWAIT, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
						rstparamHN.MoveNext()
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rst6.Fields("PATH_HIDRA").Value, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
					End If
					strPath = "EDP_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
					strSQL = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & ",2,'ENDPROC'," & lngTDAUT & ",'" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strPath = "PRO_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
					strSQL = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & ",3 ,'PROCESS'," & lngTDAUT & ",'" & strPath & "')"
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=1"
					mfExecute(conPasarela, strSQL)
				Else
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & "  ORDER BY ORDEN_ACC DESC"
					rst5 = mfRecordset(conPasarela, strSQL)
					While Not rst5.EOF
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						rst5.MoveNext()
					End While
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITALL'"
					rst7 = mfRecordset(conPasarela, strSQL)
					lngWAIT = Val(rst7.Fields(0).Value & "") + 1
					strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", 1," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					msInsertaParamAcc("PATH", "JUMP" & VB6.Format(lngNumAcc, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
					blnInserta = True
				End If
				GoTo pasando
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITALL'"
				rst6 = mfRecordset(conPasarela, strSQL)
				lngWAIT = Val(rst6.Fields(0).Value & "") + 1
				'UPGRADE_WARNING: Couldn't resolve default property of object colTram(1)(15). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object colTram()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & colTram.Item(1)(13) & " AND NUM_SEC_HASTA=" & colTram.Item(1)(15) & " AND CAT_CONECTOR='Conector Opcional'"
				rst4 = mfRecordset(conPasarela, strSQL)
				If Not rst4.EOF Then
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TRAMITEPDTE' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
					rst6 = mfRecordset(conPasarela, strSQL)
					If rst6.EOF Then
						strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='INICIOTRAMITEAUTOMA' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
						rst6 = mfRecordset(conPasarela, strSQL)
					End If
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC >= " & rst6.Fields("ORDEN_ACC").Value & " ORDER BY ORDEN_ACC DESC"
					rst5 = mfRecordset(conPasarela, strSQL)
				End If
				While Not rst5.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					rst5.MoveNext()
				End While
				strSQL = "SELECT FlowOrder From wfFlowActions WHERE (RTRIM(Flow)='TDAUTOMATICA') AND (RTRIM(Action) = 'LABEL') ORDER BY FLOWORDER"
				'Set rst7 = mfRecordset(conInfra, strSQL)
				rst7 = mfRecordset(conGene, strSQL)
				If Not rst7.EOF Then
					lngF = rst7.Fields("FLOWORDER").Value
					rst7.Close()
					strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='TDAUTOMATICA' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
					'Set rstParamHN = mfRecordset(conInfra, strSQL)
					rstparamHN = mfRecordset(conGene, strSQL)
				End If
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TDAUTOMATICA'"
				rst7 = mfRecordset(conPasarela, strSQL)
				lngTDAUT = Val(rst7.Fields(0).Value & "") + 1
				strPath = "APE_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
				strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",TIPO_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & "," & rst1R.Fields("ORDEN_N2").Value & "," & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & "," & rst6.Fields("ORDEN_ACC").Value & "," & "'TDAUTOMATICA'," & lngTDAUT & ",'G','" & strPath & "')"
				mfExecute(conPasarela, strSQL)
				strSQL = "Select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rst4.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rst4.Fields("NUM_SEC_DESDE").Value & " AND SH_SEQ_TO=" & rst4.Fields("NUM_SEC_HASTA").Value & " AND DI_ID=" & rst4.Fields("DI_ID").Value & " AND DM_INSERTS=1"
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				
				rstconE = mfRecordset(conDP4, strSQL)
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL)
				blnInserta = True
				If Not rstparamCME.EOF Then
					While Not rstparamCME.EOF
						Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
							Case "Constantes"
								colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
								'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strValorV = colXMLD.Item(1)
								If strValorV <> "" Then
									msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst6.Fields("ORDEN_ACC").Value)
								End If
							Case ""
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst6.Fields("ORDEN_ACC").Value)
							Case Else
								'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst6.Fields("ORDEN_ACC").Value)
						End Select
						rstparamCME.MoveNext()
						rstparamHN.MoveNext()
					End While
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "WAIT" & VB6.Format(lngWAIT, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst6.Fields("ORDEN_ACC").Value)
					rstparamHN.MoveNext()
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rst6.Fields("PATH_HIDRA").Value, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst6.Fields("ORDEN_ACC").Value)
				End If
				strPath = "EDP_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
				strSQL = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & "," & rst6.Fields("ORDEN_ACC").Value + 1 & ",'ENDPROC'," & lngTDAUT & ",'" & strPath & "')"
				mfExecute(conPasarela, strSQL)
				strPath = "PRO_TDAUTOMATICA" & VB6.Format(lngNumAcc, "00")
				strSQL = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & "," & rst6.Fields("ORDEN_ACC").Value + 2 & ",'PROCESS'," & lngTDAUT & ",'" & strPath & "')"
				mfExecute(conPasarela, strSQL)
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value
				mfExecute(conPasarela, strSQL)
				strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TRAMITEPDTE' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
				rst5 = mfRecordset(conPasarela, strSQL)
				If rst5.EOF Then
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='INICIOTRAMITEAUTOMA' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
					rst5 = mfRecordset(conPasarela, strSQL)
				End If
				strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC >= " & rst5.Fields("ORDEN_ACC").Value & " ORDER BY ORDEN_ACC DESC"
				rst6 = mfRecordset(conPasarela, strSQL)
				While Not rst6.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					rst6.MoveNext()
				End While
				strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst5.Fields("ORDEN_N1").Value & ", " & rst5.Fields("ORDEN_N2").Value & " , " & rst5.Fields("ORDEN_N3").Value & "," & rst5.Fields("ORDEN_N4").Value & ", " & rst5.Fields("ORDEN_N5").Value & ", " & rst5.Fields("ORDEN_ACC").Value & "," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "JUMP" & VB6.Format(lngNumAcc, "00"), rst5.Fields("ORDEN_N1").Value, rst5.Fields("ORDEN_N2").Value, rst5.Fields("ORDEN_N3").Value, rst5.Fields("ORDEN_N4").Value, rst5.Fields("ORDEN_N5").Value, rst5.Fields("ORDEN_ACC").Value)
				blnInserta = True
pasando: 
			Else
				For	Each icol In colTram
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2) & " AND ORDEN_N4=" & icol(3) & " AND ORDEN_N5=" & icol(4) & " and NOM_ACCION='FINTRAMITE'"
					rst3 = mfRecordset(conPasarela, strSQL)
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2) & " AND ORDEN_N4=" & icol(3) & " AND ORDEN_N5=" & icol(4) & " and ORDEN_ACC > " & rst3.Fields("ORDEN_ACC").Value & " AND NOM_ACCION='JUMP'"
					rst3 = mfRecordset(conPasarela, strSQL)
					strPath = rst3.Fields("PATH_HIDRA").Value
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND NOM_ACCION <> 'WAITMOMENTANEO' ORDER BY ORDEN_ACC ASC"
					rst6 = mfRecordset(conPasarela, strSQL)
					If rst6.EOF Then
						strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='INICIOTRAMITEAUTOMA' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
						rst6 = mfRecordset(conPasarela, strSQL)
					End If
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC >= " & rst6.Fields("ORDEN_ACC").Value & " ORDER BY ORDEN_ACC DESC"
					rst5 = mfRecordset(conPasarela, strSQL)
					While Not rst5.EOF
						strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
						mfExecute(conPasarela, strSQL)
						rst5.MoveNext()
					End While
					strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITALL'"
					rst7 = mfRecordset(conPasarela, strSQL)
					lngWAIT = Val(rst7.Fields(0).Value & "") + 1
					'strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R("ORDEN_N1") & ", " & rst1R("ORDEN_N2") & " , " & rst1R("ORDEN_N3") & "," & rst1R("ORDEN_N4") & ", " & rst1R("ORDEN_N5") & ", 1," & "'WAITALL'," & lngWAIT & ",'WAIT" & Format(lngWAIT, "00") & "')"
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3 =  " & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4 =  " & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5 =  " & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=1"
					rst7 = mfRecordset(conPasarela, strSQL)
					If rst7.EOF Then
						strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", 1," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
						lngNumWait = 1
					Else
						strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", 2," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
						lngNumWait = 2
					End If
					mfExecute(conPasarela, strSQL)
					blnInserta = False
					msInsertaParamAcc("PATH", strPath, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, lngNumWait)
					blnInserta = True
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(15). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & icol(13) & " AND NUM_SEC_HASTA=" & icol(15) & " AND CAT_CONECTOR='Conector Opcional'"
					rst4 = mfRecordset(conPasarela, strSQL)
					If Not rst4.EOF Then
						' str auxiliar para reutilizar codigo (aketza)
						strAuxiliar = " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
						strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI " & strAuxiliar & "  AND NOM_ACCION <> 'WAITMOMENTANEO'  and PATH_HIDRA<>'WAIT" & VB6.Format(lngWAIT, "00") & "' ORDER BY ORDEN_ACC ASC"
						rst6 = mfRecordset(conPasarela, strSQL)
						strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI " & strAuxiliar & " ORDER BY ORDEN_ACC DESC"
						rst5 = mfRecordset(conPasarela, strSQL)
						While Not rst5.EOF
							' str auxiliar para reutilizar codigo (aketza)
							strAuxiliar = " SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
							strSQL = "UPDATE ACCIONES_DI " & strAuxiliar
							mfExecute(conPasarela, strSQL)
							strSQL = "UPDATE PARAM_ACC " & strAuxiliar
							mfExecute(conPasarela, strSQL)
							rst5.MoveNext()
						End While
						strSQL = "SELECT FlowOrder From wfFlowActions WHERE (RTRIM(Flow)='TDAUTOMATICA') AND (RTRIM(Action) = 'LABEL') ORDER BY FLOWORDER"
						'Set rst7 = mfRecordset(conInfra, strSQL)
						rst7 = mfRecordset(conGene, strSQL)
						If Not rst7.EOF Then
							lngF = rst7.Fields("FLOWORDER").Value
							rst7.Close()
							strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='TDAUTOMATICA' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
							'Set rstParamHN = mfRecordset(conInfra, strSQL)
							rstparamHN = mfRecordset(conGene, strSQL)
						End If
						
						strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TDAUTOMATICA'"
						rst7 = mfRecordset(conPasarela, strSQL)
						lngTDAUT = Val(rst7.Fields(0).Value & "") + 1
						strPath = "APE_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
						strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",TIPO_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & "," & rst1R.Fields("ORDEN_N2").Value & "," & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & ",1," & "'TDAUTOMATICA'," & lngTDAUT & ",'G','" & strPath & "')"
						mfExecute(conPasarela, strSQL)
						
						strSQL = "Select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C Where J.JO_SEQ=" & rst4.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rst4.Fields("NUM_SEC_DESDE").Value & " AND SH_SEQ_TO=" & rst4.Fields("NUM_SEC_HASTA").Value & " AND DI_ID=" & rst4.Fields("DI_ID").Value & " AND DM_INSERTS=1"
						strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
						rstconE = mfRecordset(conDP4, strSQL)
						
						strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
						strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & "  ORDER BY C.DM_SEQ"
						rstparamCME = mfRecordset(conDP4, strSQL)
						
						blnInserta = True
						If Not rstparamCME.EOF Then
							'22/10/2015
							If rstparamCME.RecordCount > 3 Then
								GoTo procErrCondiciones
							End If
							'22/10/2015
							While Not rstparamCME.EOF
								Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
									Case "Constantes"
										colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
										'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
										strValorV = colXMLD.Item(1)
										If strValorV <> "" Then
											msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
										End If
									Case ""
										msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
									Case Else
										'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
										nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
										msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
								End Select
								rstparamCME.MoveNext()
								rstparamHN.MoveNext()
							End While
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "WAIT" & VB6.Format(lngWAIT, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
							rstparamHN.MoveNext()
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rst6.Fields("PATH_HIDRA").Value, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
						End If
						strPath = "EDP_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
						' str auxiliar para reutilizar codigo (aketza)
						strAuxiliar = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value
						strSQL = strAuxiliar & ", 2,'ENDPROC'," & lngTDAUT & ",'" & strPath & "')"
						mfExecute(conPasarela, strSQL)
						strPath = "PRO_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
						strSQL = strAuxiliar & ", 3,'PROCESS'," & lngTDAUT & ",'" & strPath & "')"
						mfExecute(conPasarela, strSQL)
						'aketza 4/9/2006
						'strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R("ORDEN_N1") & " AND ORDEN_N2=" & rst1R("ORDEN_N2") & " AND ORDEN_N3=" & rst1R("ORDEN_N3") & " AND ORDEN_N4=" & rst1R("ORDEN_N4") & " AND ORDEN_N5=" & rst1R("ORDEN_N5") & " AND ORDEN_ACC=1"
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=1"
						'fin aketza
						mfExecute(conPasarela, strSQL)
					End If
				Next icol
			End If
			
			'ERROR: el procedimiento es demasiado largo , SOLUCIONADO con el strAuxiliar --aketza
			'-----------------------------------------------------------
			
			For	Each icol In colTramG
				' str auxiliar para reutilizar codigo  (aketza)
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strAuxiliar = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & icol(0) & " AND ORDEN_N2=" & icol(1) & " AND ORDEN_N3=" & icol(2) & " AND ORDEN_N4=" & icol(3) & " AND ORDEN_N5=" & icol(4)
				strSQL = strAuxiliar & " and NOM_ACCION='FINTRAMITE'"
				rst3 = mfRecordset(conPasarela, strSQL)
				strSQL = strAuxiliar & " and ORDEN_ACC > " & rst3.Fields("ORDEN_ACC").Value & " AND NOM_ACCION='JUMP'"
				rst3 = mfRecordset(conPasarela, strSQL)
				strPath = rst3.Fields("PATH_HIDRA").Value
				' str auxiliar para reutilizar codigo(aketza)
				strAuxiliar = " and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
				strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TRAMITEPDTE'" & strAuxiliar
				rst6 = mfRecordset(conPasarela, strSQL)
				If rst6.EOF Then
					strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='INICIOTRAMITEAUTOMA'" & strAuxiliar
					rst6 = mfRecordset(conPasarela, strSQL)
				End If
				strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' " & strAuxiliar & " AND ORDEN_ACC >= " & rst6.Fields("ORDEN_ACC").Value & " ORDER BY ORDEN_ACC DESC"
				rst5 = mfRecordset(conPasarela, strSQL)
				
				While Not rst5.EOF
					' str auxiliar para reutilizar codigo (aketza)
					strAuxiliar = " SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
					strSQL = "UPDATE ACCIONES_DI" & strAuxiliar
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC" & strAuxiliar
					mfExecute(conPasarela, strSQL)
					rst5.MoveNext()
				End While
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='WAITALL'"
				rst7 = mfRecordset(conPasarela, strSQL)
				lngWAIT = Val(rst7.Fields(0).Value & "") + 1
				strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value - 1 & " AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
				rst9 = mfRecordset(conPasarela, strSQL)
				If Not rst9.EOF Then
					strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO, ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", " & rst6.Fields("ORDEN_ACC").Value & "," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET VALOR='WAIT" & VB6.Format(lngWAIT, "00") & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR ='" & rst9.Fields("PATH_HIDRA").Value & "'"
					mfExecute(conPasarela, strSQL)
				Else
					strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & " , " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & ", " & rst1R.Fields("ORDEN_N5").Value & ", " & rst6.Fields("ORDEN_ACC").Value & "," & "'WAITALL'," & lngWAIT & ",'WAIT" & VB6.Format(lngWAIT, "00") & "')"
					mfExecute(conPasarela, strSQL)
				End If
				blnInserta = False
				msInsertaParamAcc("PATH", strPath, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, rst6.Fields("ORDEN_ACC").Value)
				blnInserta = True
				
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(15). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = "SELECT " & strSel_Con_DI & " FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & icol(13) & " AND NUM_SEC_HASTA=" & icol(15) & " AND CAT_CONECTOR='Conector Opcional'"
				rst4 = mfRecordset(conPasarela, strSQL)
				If Not rst4.EOF Then
					mfMeteOpcionalParaWait(rst4, rst1R, lngWAIT)
				End If
				
			Next icol
			'----------------------------------------------------------
			
			
			rst1.MoveNext()
		End While
		GoTo procFin
		
procErrCondiciones: 
		'UPGRADE_WARNING: Couldn't resolve default property of object icol(4). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		'UPGRADE_WARNING: Couldn't resolve default property of object icol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		'UPGRADE_WARNING: Couldn't resolve default property of object icol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		'UPGRADE_WARNING: Couldn't resolve default property of object icol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		'UPGRADE_WARNING: Couldn't resolve default property of object icol(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		Insertar_Error(Me, "Solución Unión Ramas Paralelas", "El conector opcional de entrada al trámite " & icol(19) & " (Orden: " & icol(0) & "/" & icol(1) & "/" & icol(2) & "/" & icol(3) & "/" & icol(4) & ") tiene mas de una condición.", "msSolucionWait")
		Exit Sub
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub : logError("msSolucionWait- " & Err.Description)
		Insertar_Error(Me, "Solución Unión Ramas Paralelas", "Ha ocurrido un error no controlado", "msSolucionWait")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		Resume procFin
procFin: 
	End Sub
	
	
	Private Sub msSolucionRampa()
		On Error GoTo procErr
		Dim strSQL As String
		Dim strURP As String
		Dim strTF As String
		Dim rst1 As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rst3 As ADODB.Recordset
		Dim rst4 As ADODB.Recordset
		Dim rst5 As ADODB.Recordset
		Dim rst6 As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstAUX9 As ADODB.Recordset
		Dim colENLACES As Collection
		Dim icol As Object
		Dim lngOr1 As Integer
		Dim lngOr2 As Integer
		Dim lngOr3 As Integer
		Dim lngOr4 As Integer
		Dim lngOr5 As Integer
		Dim lngNumAcc As Integer
		Dim intcuenta As Integer
		Dim lngCon As Integer
		Dim lngnumSal As Integer
		
		
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND EXPLOTA_ACC='N' ORDER BY " & "ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5"
		
		rst1 = mfRecordset(conPasarela, strSQL)
		While Not rst1.EOF
			strSeg = rst1.Fields("ORDEN_N1").Value & "/" & rst1.Fields("ORDEN_N2").Value & "/" & rst1.Fields("ORDEN_N3").Value & "/" & rst1.Fields("ORDEN_N4").Value & "/" & rst1.Fields("ORDEN_N5").Value
			'strSQL = "SELECT * FROM CONECTORES_DI WHERE " _
			'& "DIAGRAMA=" & rst1("ID_PADRE") & " AND " _
			'& "NUM=" & rst1("NUM_DIAGRAMA") & " AND " _
			'& "NUM_SEC_DESDE=" & rst1("NUM_SEQ") & " AND " _
			'& "NUM_SEC_HASTA=(SELECT DISTINCT NUM_SEQ FROM DIAGRAMA " _
			'& "WHERE NUM_DIAGRAMA=1 AND NUM_SEQ=NUM_SEC_HASTA) " _
			'& "AND CAT_CONECTOR='' AND CAT_CONECTOR2=''"
			'aketza 15/9/2006
			'strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " _
			''            & "DIAGRAMA=" & rst1("ID_PADRE") & " AND " _
			''            & "NUM=" & rst1("NUM_DIAGRAMA") & " AND " _
			''            & "NUM_SEC_DESDE=" & rst1("NUM_SEQ") & " AND " _
			''            & "NUM_SEC_HASTA=(SELECT DISTINCT NUM_SEQ FROM DIAGRAMA " _
			''            & "WHERE NUM_DIAGRAMA=" & rst1("NUM_DIAGRAMA") & " AND NUM_SEQ=NUM_SEC_HASTA) " _
			''            & "AND CAT_CONECTOR='' AND CAT_CONECTOR2='' and ORDEN_N1=" & rst1("ORDEN_N1")
			strSQL = "SELECT DISTINCT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rst1.Fields("ID_PADRE").Value & " AND " & "NUM=" & rst1.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEC_DESDE=" & rst1.Fields("NUM_SEQ").Value & " AND " & "NUM_SEC_HASTA=(SELECT DISTINCT NUM_SEQ FROM DIAGRAMA " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and NUM_DIAGRAMA=" & rst1.Fields("NUM_DIAGRAMA").Value & " AND NUM_SEQ=NUM_SEC_HASTA) " & "AND CAT_CONECTOR='' AND CAT_CONECTOR2=''" & IIf(rst1.Fields("NUM_DIAGRAMA").Value > 1, "and ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value, "")
			'fin aketza
			rst2 = mfRecordset(conPasarela, strSQL)
			If rst2.RecordCount > 1 Then
				strSQL = "SELECT DI_ID FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rst1.Fields("ID_DIAGRAMA").Value
				rst3 = mfRecordset(conPasarela, strSQL)
				If rst3.EOF Then GoTo aqui
				strSQL = "SELECT A.EV_ID, A.EV_NAME FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rst1.Fields("ID_DIAGRAMA").Value & " AND E.DI_ID=" & rst3.Fields("DI_ID").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rst4 = mfRecordset(conDP4, strSQL)
				lngnumSal = 0
				While Not rst4.EOF
					If InStr(1, rst4.Fields(1).Value, "Inicio") <> 0 Or InStr(1, rst4.Fields(1).Value, "Fin") <> 0 Then
						lngnumSal = lngnumSal + 1
					End If
					rst4.MoveNext()
				End While
				
				'If rst4.RecordCount = 2 Then
				If lngnumSal <= 2 Then
					colENLACES = New Collection
					While Not rst2.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rst1.Fields("ID_PADRE").Value & " AND " & "NUM_SEQ=" & rst2.Fields("NUM_SEC_HASTA").Value
						rst5 = mfRecordset(conPasarela, strSQL)
						If rst5.EOF Then GoTo aqui2
						If rst5.Fields("ORDEN_N2").Value = 0 Then
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1 > =" & rst5.Fields("ORDEN_N1").Value & " " & "ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst5.Fields("ORDEN_N3").Value = 0 Then 
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2 >= " & rst5.Fields("ORDEN_N2").Value & " " & "ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst5.Fields("ORDEN_N4").Value = 0 Then 
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2 = " & rst5.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3 >=" & rst5.Fields("ORDEN_N3").Value & " " & "ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst5.Fields("ORDEN_N5").Value = 0 Then 
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2 = " & rst5.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4 >=" & rst5.Fields("ORDEN_N4").Value & " " & "ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						rst6 = mfRecordset(conPasarela, strSQL)
						Do While Not rst6.EOF
							If rst6.Fields("NOM_DIAGRAMA").Value <> "" Then
								colENLACES.Add(CStr(rst6.Fields("NOM_DIAGRAMA").Value))
								Exit Do
							End If
							rst6.MoveNext()
						Loop 
aqui2: 
						rst2.MoveNext()
					End While
					
					
					'SOLO TIENE UNA SALIDA
					strSQL = "SELECT COUNT(*) FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA LIKE 'PR_TRAMITEFICTICIO%'"
					rst4 = mfRecordset(conPasarela, strSQL)
					strTF = "PR_TRAMITEFICTICIO" & VB6.Format(Val(rst4.Fields(0).Value & "") + 1, "00")
					If rst1.Fields("ORDEN_N2").Value = 0 Then
						strSQL = "select count(*) from diagrama where procedimiento='" & gNomProcCorto & "' and ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " and orden_n2=99"
						rstAUX9 = mfRecordset(conPasarela, strSQL)
						If rstAUX9.Fields(0).Value = 0 Then
							lngOr2 = 99
						Else
							lngOr2 = 100
						End If
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES (" & "'" & gNomProcCorto & "'," & rst1.Fields("ORDEN_N1").Value & ", " & lngOr2 & "," & rst1.Fields("ORDEN_N3").Value & "," & rst1.Fields("ORDEN_N4").Value & "," & rst1.Fields("ORDEN_N5").Value & "," & rst1.Fields("NUM_DIAGRAMA").Value & ",'" & strTF & "','S',999999)"
						mfExecute(conPasarela, strSQL)
						mfInserta_PROPIEDADES(rst1.Fields("ORDEN_N1").Value, lngOr2, rst1.Fields("ORDEN_N3").Value, rst1.Fields("ORDEN_N4").Value, rst1.Fields("ORDEN_N5").Value, 999999, strTF, "", "", "", "", "", "", "0")
						'strSQL = "INSERT INTO PROPIEDADES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," _
						'& "ORDEN_N4,ORDEN_N5,NOM_DIAGRAMA,ID_DIAGRAMA) VALUES (" _
						'& "'" & gNomProcCorto & "'," & rst1("ORDEN_N1") & ", " & lngOr2 & "," & rst1("ORDEN_N3") & "," _
						'& rst1("ORDEN_N4") & "," & rst1("ORDEN_N5") & ",'" & strTF & "',999999)"
						'mfExecute conPasarela, strSQL
						lngOr1 = rst1.Fields("ORDEN_N1").Value
						lngOr3 = rst1.Fields("ORDEN_N3").Value
						lngOr4 = rst1.Fields("ORDEN_N4").Value
						lngOr5 = rst1.Fields("ORDEN_N5").Value
						'''si el tramite anterior es un tramite ficticio actualizaremos todos los tramites excepto el del tramite ficticio
						strSQL = "SELECT  * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " and orden_n2 < " & lngOr2 & " order by ORDEN_N2 DESC"
						rst4 = mfRecordset(conPasarela, strSQL)
						If Not rst4.EOF Then
							If InStr(1, rst4.Fields("NOMBRE").Value, "PR_TRAMITEFICTICIO") > 0 Then
								For	Each icol In colENLACES
									'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " and orden_n2=" & rst4.Fields("ORDEN_N2").Value
									mfExecute(conPasarela, strSQL)
								Next icol
								For	Each icol In colENLACES
									'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strSQL = "UPDATE PARAM_ACC SET VALOR='" & rst4.Fields("NOMBRE").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value
									mfExecute(conPasarela, strSQL)
								Next icol
							Else
								For	Each icol In colENLACES
									'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
									strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value
									mfExecute(conPasarela, strSQL)
								Next icol
							End If
						Else
							For	Each icol In colENLACES
								'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value
								mfExecute(conPasarela, strSQL)
							Next icol
							'End If
							
							
							
							For	Each icol In colENLACES
								'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND " & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value
								mfExecute(conPasarela, strSQL)
							Next icol
						End If
					ElseIf rst1.Fields("ORDEN_N3").Value = 0 Then 
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES (" & "'" & gNomProcCorto & "'," & rst1.Fields("ORDEN_N1").Value & ", " & rst1.Fields("ORDEN_N2").Value & ",99," & rst1.Fields("ORDEN_N4").Value & "," & rst1.Fields("ORDEN_N5").Value & "," & rst1.Fields("NUM_DIAGRAMA").Value & ",'" & strTF & "','S',999999)"
						mfExecute(conPasarela, strSQL)
						mfInserta_PROPIEDADES(rst1.Fields("ORDEN_N1").Value, rst1.Fields("ORDEN_N2").Value, 99, rst1.Fields("ORDEN_N4").Value, rst1.Fields("ORDEN_N5").Value, 999999, strTF, "", "", "", "", "", "", "0")
						'strSQL = "INSERT INTO PROPIEDADES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," _
						'& "ORDEN_N4,ORDEN_N5,NOM_DIAGRAMA,ID_DIAGRAMA) VALUES (" _
						'& "'" & gNomProcCorto & "'," & rst1("ORDEN_N1") & ", " & rst1("ORDEN_N2") & ",99," _
						'& rst1("ORDEN_N4") & "," & rst1("ORDEN_N5") & ",'" & strTF & "',999999)"
						'mfExecute conPasarela, strSQL
						lngOr1 = rst1.Fields("ORDEN_N1").Value
						lngOr2 = rst1.Fields("ORDEN_N2").Value
						lngOr3 = 99
						lngOr4 = rst1.Fields("ORDEN_N4").Value
						lngOr5 = rst1.Fields("ORDEN_N5").Value
						For	Each icol In colENLACES
							'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND " & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value
							mfExecute(conPasarela, strSQL)
						Next icol
					ElseIf rst1.Fields("ORDEN_N4").Value = 0 Then 
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES (" & "'" & gNomProcCorto & "'," & rst1.Fields("ORDEN_N1").Value & ", " & rst1.Fields("ORDEN_N2").Value & "," & rst1.Fields("ORDEN_N3").Value & "," & 99 & "," & rst1.Fields("ORDEN_N5").Value & "," & rst1.Fields("NUM_DIAGRAMA").Value & ",'" & strTF & "','S',999999)"
						mfExecute(conPasarela, strSQL)
						mfInserta_PROPIEDADES(rst1.Fields("ORDEN_N1").Value, rst1.Fields("ORDEN_N2").Value, rst1.Fields("ORDEN_N3").Value, 99, rst1.Fields("ORDEN_N5").Value, 999999, strTF, "", "", "", "", "", "", "0")
						'strSQL = "INSERT INTO PROPIEDADES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," _
						'& "ORDEN_N4,ORDEN_N5,NOM_DIAGRAMA,ID_DIAGRAMA) VALUES (" _
						'& "'" & gNomProcCorto & "'," & rst1("ORDEN_N1") & ", " & rst1("ORDEN_N2") & "," & rst1("ORDEN_N3") & "," _
						'& 99 & "," & rst1("ORDEN_N5") & ",'" & strTF & "',999999)"
						'mfExecute conPasarela, strSQL
						lngOr1 = rst1.Fields("ORDEN_N1").Value
						lngOr2 = rst1.Fields("ORDEN_N2").Value
						lngOr3 = rst1.Fields("ORDEN_N3").Value
						lngOr4 = 99
						lngOr5 = rst1.Fields("ORDEN_N5").Value
						For	Each icol In colENLACES
							'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND " & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value
							mfExecute(conPasarela, strSQL)
						Next icol
						
					ElseIf rst1.Fields("ORDEN_N5").Value = 0 Then 
						strSQL = "INSERT INTO DIAGRAMA (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA) VALUES (" & "'" & gNomProcCorto & "'," & rst1.Fields("ORDEN_N1").Value & ", " & rst1.Fields("ORDEN_N2").Value & "," & rst1.Fields("ORDEN_N3").Value & "," & rst1.Fields("ORDEN_N4").Value & ",99," & rst1.Fields("NUM_DIAGRAMA").Value & ",'" & strTF & "','S',999999)"
						mfExecute(conPasarela, strSQL)
						mfInserta_PROPIEDADES(rst1.Fields("ORDEN_N1").Value, rst1.Fields("ORDEN_N2").Value, rst1.Fields("ORDEN_N3").Value, rst1.Fields("ORDEN_N4").Value, 99, 999999, strTF, "", "", "", "", "", "", "0")
						'strSQL = "INSERT INTO PROPIEDADES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," _
						'& "ORDEN_N4,ORDEN_N5,NOM_DIAGRAMA,ID_DIAGRAMA) VALUES (" _
						'& "'" & gNomProcCorto & "'," & rst1("ORDEN_N1") & ", " & rst1("ORDEN_N2") & "," & rst1("ORDEN_N3") & "," _
						'& rst1("ORDEN_N4") & ",99,'" & strTF & "',999999)"
						'mfExecute conPasarela, strSQL
						lngOr1 = rst1.Fields("ORDEN_N1").Value
						lngOr2 = rst1.Fields("ORDEN_N2").Value
						lngOr3 = rst1.Fields("ORDEN_N3").Value
						lngOr4 = rst1.Fields("ORDEN_N4").Value
						lngOr5 = 99
						For	Each icol In colENLACES
							'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strSQL = "UPDATE PARAM_ACC SET VALOR='" & strTF & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='" & icol & "' AND " & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value
							mfExecute(conPasarela, strSQL)
						Next icol
					End If
					lngCon = 0
					For	Each icol In colENLACES
						lngCon = lngCon + 1
						If lngCon = 1 Then
							strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngOr1 & ", " & lngOr2 & " , " & lngOr3 & "," & lngOr4 & ", " & lngOr5 & ", " & lngCon & "," & "'PRO_FINTRAMITE','PRO_FINTRAMITEELIMINAR')"
							mfExecute(conPasarela, strSQL)
						End If
						strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
						rstAcc = mfRecordset(conPasarela, strSQL)
						lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
						
						
						strSQL = "INSERT INTO ACCIONES_DI (PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & lngOr1 & ", " & lngOr2 & " , " & lngOr3 & "," & lngOr4 & ", " & lngOr5 & ", " & lngCon + 1 & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "')"
						mfExecute(conPasarela, strSQL)
						blnInserta = False
						'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						msInsertaParamAcc("PATH", icol, lngOr1, lngOr2, lngOr3, lngOr4, lngOr5, lngCon + 1)
						blnInserta = True
					Next icol
					
					
				End If
			End If
aqui: 
			rst1.MoveNext()
		End While
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		
		If blnParar = True Then Exit Sub
		logError("msSolucionRampa- " & Err.Description)
		'aketza errores
		Insertar_Error(Me, "Solución Ramas Paralelas", "Ha ocurrido un error no controlado", "msSolucionRampa" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		Resume procFin
procFin: 
	End Sub
	
	
	
	
	Private Sub msFly()
		'Inicio Jonathan Prieto 25/02/2011: modificada de arriba a abajo, hacía mal el tratamiento para insertar FLY's
		On Error GoTo procErr
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim rstAux7 As ADODB.Recordset
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim strSQL As String
		Dim j As Integer
		Dim strNomTram As String
		Dim Marca As String
		Dim intOrdAccAnt As Short
		Dim intAñadidos As Short
		Dim strAccAnt As String
		Dim strAccPos As String
		Dim intNumSecTDAant As Short
		Dim blnEsTramiteFicticio As Boolean
		
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND EXPLOTA_ACC='S'"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			blnEsTramiteFicticio = False
			strSeg = rstAux.Fields("ORDEN_N1").Value & "/" & rstAux.Fields("ORDEN_N2").Value & "/" & rstAux.Fields("ORDEN_N3").Value & "/" & rstAux.Fields("ORDEN_N4").Value & "/" & rstAux.Fields("ORDEN_N5").Value
			
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND " & "ORDEN_ACC>(SELECT ORDEN_ACC FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND " & "PATH_HIDRA LIKE 'PRO_FINTRAMITE%') AND " & "(PATH_HIDRA LIKE 'JUMP%' OR " & "PATH_HIDRA LIKE 'APE_TDAUTOMATICA%') AND " & "(NOMBRE <> 'FLY' OR NOMBRE <> 'ISFLY') AND METOFLY<>'N' order by orden_acc"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			If rstAux2.EOF Then
				strAccPos = ""
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
				rstAux3 = mfRecordset(conPasarela, strSQL)
				If Not rstAux3.EOF Then
					If InStr(1, rstAux3.Fields("NOM_DIAGRAMA").Value, "PR_TRAMITEFICTICIO") Then
						strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND (PATH_HIDRA LIKE 'JUMP%' OR " & "PATH_HIDRA LIKE 'APE_TDAUTOMATICA%') AND " & "(NOMBRE <> 'FLY' OR NOMBRE <> 'ISFLY') AND METOFLY<>'N' order by orden_acc"
						rstAux2 = mfRecordset(conPasarela, strSQL)
						blnEsTramiteFicticio = True
					End If
				End If
			End If
			
			If rstAux.Fields("ORDEN_N1").Value = 10 Then System.Windows.Forms.Application.DoEvents()
			
			intOrdAccAnt = 0
			intAñadidos = 0
			
			If rstAux2.RecordCount > 1 Then
				intNumSecTDAant = 0
				While Not rstAux2.EOF
					'Averiguo el NOM_ACCION de la acción ANTERIOR
					strSQL = "SELECT TOP 1 NOM_ACCION FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<" & IIf(rstAux2.Fields("ORDEN_ACC").Value <> 1, (rstAux2.Fields("ORDEN_ACC").Value + intAñadidos), 1) & " ORDER BY ORDEN_ACC DESC"
					rstAux3 = mfRecordset(conPasarela, strSQL)
					If Not rstAux3.EOF Then
						strAccAnt = rstAux3.Fields("NOM_ACCION").Value
					Else
						strAccAnt = ""
					End If
					'Averiguo el NOM_ACCION de la acción POSTERIOR
					strSQL = "SELECT TOP 1 NOM_ACCION FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & IIf(rstAux2.Fields("ORDEN_ACC").Value <> 1, (rstAux2.Fields("ORDEN_ACC").Value + intAñadidos), 1) & " ORDER BY ORDEN_ACC ASC"
					rstAux4 = mfRecordset(conPasarela, strSQL)
					If Not rstAux4.EOF Then
						strAccPos = rstAux4.Fields("NOM_ACCION").Value
					Else
						strAccPos = ""
					End If
					
					'CONDICION: Si la acción anterior es una TDA y tiene el mismo último NUM_SEQ no se deben insertar más FLYs
					'Obtenemos el último NUM_SEQ de las acciones TDA posteriores a PRO_FINTRAMITE
					strSQL = "SELECT MAX(NUM_SEQ) AS MAXNUMSEQ FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
					If Not blnEsTramiteFicticio Then 'En caso de condiciones de conectores opcionales desde ramificación no hay que realizar esta parte
						strSQL = strSQL & " AND ORDEN_ACC>(SELECT ORDEN_ACC FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND " & "PATH_HIDRA LIKE 'PRO_FINTRAMITE%')"
					End If
					strSQL = strSQL & " AND (PATH_HIDRA LIKE 'JUMP%' OR PATH_HIDRA LIKE 'APE_TDAUTOMATICA%') AND " & "(NOMBRE <> 'FLY' OR NOMBRE <> 'ISFLY') AND METOFLY<>'N'"
					rstAux7 = mfRecordset(conPasarela, strSQL)
					If Not rstAux7.EOF And rstAux7.RecordCount > 0 And rstAux2.AbsolutePosition > 1 And rstAux7.Fields("MAXNUMSEQ").Value > 0 Then
						'Si la acción anterior es una TDA y tiene el mismo último NUM_SEQ no se deben insertar más FLYs
						rstAux2.MovePrevious()
						If rstAux2.Fields("NOM_ACCION").Value = "TDAUTOMATICA" And rstAux2.Fields("NUM_SEQ").Value = rstAux7.Fields("MAXNUMSEQ").Value Then
							rstAux2.MoveLast()
							GoTo SiguienteAccion
						End If
						rstAux2.MoveNext()
					End If
					
					'Resto de condiciones a cumplir, de las acciones anterior y posterior, para que se inserte el FLY
					If ((strAccAnt <> "CANCEL" And strAccPos <> "CADUCARTRAMITE") Or (strAccAnt = "CANCEL" And strAccPos = "TDAUTOMATICA") Or (strAccAnt = "CANCEL" And strAccPos = "JUMP")) And (strAccAnt <> "METERCANCELFORMULARIO") Then
						
						If intOrdAccAnt <> 0 Then
							
							'--------------------------------------------------------------------------------------------------------------------------
							'Si la accion anterior es una TDA y su NUM_SEQ coincide con el NUM_SEQ de la TDA del ultimo FLY del tramite
							'insertamos la accion en el FLY anterior
							'Obtenemos el NUM_SEQ de cualquier accion que este dentro del ultimo FLY del tramite
							strSQL = "SELECT MAX(NUM_SEQ) AS NUM_SEQ FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND NOMBRE='ISFLY' AND ORDEN_ACC>(SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND NOM_ACCION='FLY')"
							rstAux7 = mfRecordset(conPasarela, strSQL)
							If Not rstAux7.EOF Then
								'Si la accion anterior es una TDA y su NUM_SEQ coincide con el NUM_SEQ de la TDA del ultimo FLY del tramite insertamos la accion en el FLY anterior
								strSQL = "SELECT NUM_SEQ FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC = " & intOrdAccAnt & " AND NOM_ACCION='TDAUTOMATICA'"
								rstAux3 = mfRecordset(conPasarela, strSQL)
								If Not rstAux3.EOF Then
									If rstAux3.Fields("NUM_SEQ").Value = rstAux7.Fields("NUM_SEQ").Value Then
										'Insertamos la TDA anterior en el FLY anterior
										strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND NUM_ACCION=(SELECT NUM_ACCION FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC = " & intOrdAccAnt & ")" & " AND ORDEN_ACC >= " & intOrdAccAnt
										rstAux3 = mfRecordset(conPasarela, strSQL)
										'Inserto ISFLY en el campo NOMBRE a los registros de la TDA anterior para encajarlo en el FLY anterior
										While Not rstAux3.EOF
											strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_ACC=" & rstAux3.Fields("ORDEN_ACC").Value & " AND " & "ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux3.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux3.Fields("ORDEN_N5").Value
											mfExecute(conPasarela, strSQL)
											rstAux3.MoveNext()
										End While
										'No ha insertado ninguna acción
										intOrdAccAnt = rstAux2.Fields("ORDEN_ACC").Value + intAñadidos
										GoTo SiguienteAccion
									End If
								End If
							End If
							
							'--------------------------------------------------------------------------------------------------------------------------
							'El FLY se pondrá delante de la acción anterior
							strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC >= " & intOrdAccAnt & " ORDER BY ORDEN_ACC DESC"
							lngORACC = intOrdAccAnt
							rstAux3 = mfRecordset(conPasarela, strSQL)
							
							'Modifico el ORDEN_ACC (+1) a todas las acciones que estén detrás de la tratada actualmente
							While Not rstAux3.EOF
								strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux3.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_ACC=" & rstAux3.Fields("ORDEN_ACC").Value & " AND " & "ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux3.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux3.Fields("ORDEN_N5").Value
								mfExecute(conPasarela, strSQL)
								
								strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux3.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_ACC=" & rstAux3.Fields("ORDEN_ACC").Value & " AND " & "ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux3.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux3.Fields("ORDEN_N5").Value
								mfExecute(conPasarela, strSQL)
								rstAux3.MoveNext()
							End While
							rstAux3.Requery()
							'Consigo el número mayor de FLY insertado en el flujo, para saber cuál es el siguiente
							strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='FLY'"
							rstAux4 = mfRecordset(conPasarela, strSQL)
							lngNumAcc = Val(rstAux4.Fields(0).Value) + 1
							'Consigo el nombre para la nueva acción FLY
							strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
							rstAux5 = mfRecordset(conPasarela, strSQL)
							strNomTram = "PRO_" & Mid(rstAux5.Fields(0).Value, 4, Len(rstAux5.Fields(0).Value) - 2)
							
							strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "PATH_HIDRA LIKE '" & Mid(strNomTram, 1, Len(strNomTram) - 2) & "%'"
							rstAux6 = mfRecordset(conPasarela, strSQL)
							strNomTram = Mid(strNomTram, 1, Len(strNomTram) - 2) & VB6.Format(Val(rstAux6.Fields(0).Value) + 1, "00")
							'Inserto el FLY
							strSQL = "INSERT INTO ACCIONES_DI(" & "PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION," & "NUM_ACCION,PATH_HIDRA,NOMBRE) VALUES " & "('" & gNomProcCorto & "'," & rstAux.Fields("ORDEN_N1").Value & "," & rstAux.Fields("ORDEN_N2").Value & "," & rstAux.Fields("ORDEN_N3").Value & "," & rstAux.Fields("ORDEN_N4").Value & "," & rstAux.Fields("ORDEN_N5").Value & "," & lngORACC & ",'FLY'" & "," & lngNumAcc & ",'" & strNomTram & "','FLY')"
							mfExecute(conPasarela, strSQL)
							'La acción posterior la "meto" dentro del FLY creado, pero primero miro a ver de qué tipo es la acción posterior al FLY creado
							strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC + 1
							rstAux4 = mfRecordset(conPasarela, strSQL)
							If VB.Left(rstAux4.Fields("PATH_HIDRA").Value, 16) = "APE_TDAUTOMATICA" Then
								For j = lngORACC + 1 To lngORACC + 3
									strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & j
									mfExecute(conPasarela, strSQL)
								Next j
								Marca = VB.Left(rstAux4.Fields("PATH_HIDRA").Value, 16)
							ElseIf VB.Left(rstAux4.Fields("PATH_HIDRA").Value, 4) = "JUMP" Then 
								strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC + 1
								mfExecute(conPasarela, strSQL)
								Marca = VB.Left(rstAux4.Fields("PATH_HIDRA").Value, 4)
							End If
							
							'¿La TDA tratada es del mismo conector opcional que la TDA anterior (la que acabamos de incluir en un FLY)?
							If rstAux2.Fields("NOM_ACCION").Value = "TDAUTOMATICA" And rstAux4.Fields("NOM_ACCION").Value = "TDAUTOMATICA" Then
								If Val(rstAux2.Fields("ORDEN_N1").Value) = Val(rstAux4.Fields("ORDEN_N1").Value) And Val(rstAux2.Fields("ORDEN_N2").Value) = Val(rstAux4.Fields("ORDEN_N2").Value) And Val(rstAux2.Fields("ORDEN_N3").Value) = Val(rstAux4.Fields("ORDEN_N3").Value) And Val(rstAux2.Fields("ORDEN_N4").Value) = Val(rstAux4.Fields("ORDEN_N4").Value) And Val(rstAux2.Fields("ORDEN_N5").Value) = Val(rstAux4.Fields("ORDEN_N5").Value) And Val(rstAux2.Fields("NUM_SEQ").Value) = Val(rstAux4.Fields("NUM_SEQ").Value) Then
									'Es otra TDA del mismo conector opcional, lo incluimos en el mismo FLY
									strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 + intAñadidos
									mfExecute(conPasarela, strSQL)
									strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 + intAñadidos
									mfExecute(conPasarela, strSQL)
									strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 3 + intAñadidos
									mfExecute(conPasarela, strSQL)
									rstAux2.MoveNext()
									
									'En caso de haber llegado al último registro, volvemos a comprobar si es una TDA del mismo conector opcional
									If rstAux2.AbsolutePosition = rstAux2.RecordCount Then
										If rstAux2.Fields("NOM_ACCION").Value = "TDAUTOMATICA" And Val(rstAux2.Fields("ORDEN_N1").Value) = Val(rstAux4.Fields("ORDEN_N1").Value) And Val(rstAux2.Fields("ORDEN_N2").Value) = Val(rstAux4.Fields("ORDEN_N2").Value) And Val(rstAux2.Fields("ORDEN_N3").Value) = Val(rstAux4.Fields("ORDEN_N3").Value) And Val(rstAux2.Fields("ORDEN_N4").Value) = Val(rstAux4.Fields("ORDEN_N4").Value) And Val(rstAux2.Fields("ORDEN_N5").Value) = Val(rstAux4.Fields("ORDEN_N5").Value) And Val(rstAux2.Fields("NUM_SEQ").Value) = Val(rstAux4.Fields("NUM_SEQ").Value) Then
											'Es otra TDA del mismo conector opcional, lo incluimos en el mismo FLY
											strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 1 + intAñadidos
											mfExecute(conPasarela, strSQL)
											strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 + intAñadidos
											mfExecute(conPasarela, strSQL)
											strSQL = "UPDATE ACCIONES_DI SET NOMBRE='ISFLY' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 3 + intAñadidos
											mfExecute(conPasarela, strSQL)
										End If
									End If
									
									'Si hemos avanzado más allá del último registro, volvemos al último
									If rstAux2.EOF Then
										rstAux2.MoveLast()
									End If
									
								End If
							End If
							
							blnInserta = False
							'Ha insertado una acción nueva (FLY), todas las demás han aumentado +1 en su ORDEN_ACC
							intAñadidos = intAñadidos + 1
							intOrdAccAnt = rstAux2.Fields("ORDEN_ACC").Value + intAñadidos
							
						Else
							'No ha insertado ninguna acción
							intOrdAccAnt = rstAux2.Fields("ORDEN_ACC").Value
						End If
					Else
						'No ha insertado ninguna acción
						intOrdAccAnt = rstAux2.Fields("ORDEN_ACC").Value
					End If
					
SiguienteAccion: 
					rstAux2.MoveNext()
					
				End While
			ElseIf rstAux.RecordCount = 0 Then 
				'SI NO TIENE ACCION, COMO QUE SOBRA
				strSQL = "delete from diagrama where procedimiento='" & gNomProcCorto & "' and orden_n1=" & rstAux.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux.Fields("ORDEN_N4").Value & " and orden_n5=" & rstAux.Fields("ORDEN_N5").Value
				mfExecute(conPasarela, strSQL)
				strSQL = "delete from propiedades_di where procedimiento='" & gNomProcCorto & "' and orden_n1=" & rstAux.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux.Fields("ORDEN_N4").Value & " and orden_n5=" & rstAux.Fields("ORDEN_N5").Value
				mfExecute(conPasarela, strSQL)
			End If
			
			rstAux.MoveNext()
		End While
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		logError("msfly - " & Err.Description)
		Insertar_Error(Me, "Tratamiento FLY", "Ha ocurrido un error no controlado", "msFly" & " -" & strSeg)
		Mostrar_Error()
		Resume procFin
		
procFin: 
		'Fin Jonathan Prieto 25/02/2011
		
	End Sub
	
	
	
	Private Sub msProcEnCola()
		Dim colTruc As Collection
		Dim arrTruc(3) As Object
		Dim icol As Object
		Dim acol As Object
		Dim blnNo As Boolean
		On Error GoTo procErr
		If colCola.Count() = 0 Then Exit Sub
		For	Each icol In colCola
			'UPGRADE_WARNING: Couldn't resolve default property of object colCola()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If MsgBox("¿Desea continuar con el procedimiento " & colCola.Item(1)(1) & "?", MsgBoxStyle.Question + MsgBoxStyle.YesNo, "Siguiente Procedimiento") = MsgBoxResult.Yes Then
				blnNo = True
				colCola.Remove(1)
				colTruc = New Collection
				For	Each acol In colCola
					'UPGRADE_WARNING: Couldn't resolve default property of object acol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					If acol(0) <> "" Then
						colTruc.Add(acol)
					End If
				Next acol
			Else
				Exit For
			End If
		Next icol
		If blnNo = True Then
			'UPGRADE_NOTE: Object colCola may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			colCola = Nothing
			colCola = New Collection
			colCola = colTruc
		End If
		If colCola.Count() > 0 Then
			'UPGRADE_WARNING: Couldn't resolve default property of object colCola()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arrTruc(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrTruc(0) = colCola.Item(1)(0)
			'UPGRADE_WARNING: Couldn't resolve default property of object arrTruc(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrTruc(1) = ""
			'UPGRADE_WARNING: Couldn't resolve default property of object arrTruc(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrTruc(2) = ""
			'UPGRADE_WARNING: Couldn't resolve default property of object arrTruc(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrTruc(3) = ""
			'UPGRADE_WARNING: Couldn't resolve default property of object colCola()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			strNombre = colCola.Item(1)(1)
			'UPGRADE_WARNING: Couldn't resolve default property of object colCola()(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			gNomProc = colCola.Item(1)(1)
			gNomProcCorto = gNomProcCorto
			colCola.Remove(1)
			colTruc = New Collection
			For	Each icol In colCola
				'UPGRADE_WARNING: Couldn't resolve default property of object icol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				If icol(0) <> "" Then
					colTruc.Add(icol)
				End If
			Next icol
			'UPGRADE_NOTE: Object colPasar may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			colPasar = Nothing
			colPasar = New Collection
			colPasar.Add(arrTruc)
			'UPGRADE_NOTE: Object colCola may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			colCola = Nothing
			colCola = New Collection
			colCola = colTruc
			blnCargaInfra = False
			blnCarga = False
			tramiteAnterior = ""
			Me.Close()
			Me.ShowDialog()
			'UPGRADE_WARNING: Form event frmProceso.Activated has a new behavior. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6BA9B8D2-2A32-4B6E-8D36-44949974A5B4"'
			frmProceso_Activated(Me, New System.EventArgs())
		End If
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		
		Resume procFin
procFin: 
	End Sub
	
	
	
	
	Private Sub msValidaciones()
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rst1 As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rst3 As ADODB.Recordset
		Dim rst4 As ADODB.Recordset
		Dim strVar As String
		Dim strTram As String
		Dim strAcc As String
		Dim Tiempo As Integer
		Me.lblMensaje.Text = "Realizando Validaciones Procedimiento"
		Tiempo = GetTickCount
		'*primero validaremos que no existen acciones sin parametros
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PATH_HIDRA LIKE 'APE_%' " & "ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC"
		rst1 = mfRecordset(conPasarela, strSQL)
		While Not rst1.EOF
			msProceso(rst1.AbsolutePosition, rst1.RecordCount, 1, 3)
			strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & " ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value
			rst2 = mfRecordset(conPasarela, strSQL)
			If rst2.EOF Then
				'aketza errores
				Insertar_Error(Me, "Validaciones Procedimiento", "La acción " & rst1.Fields("PATH_HIDRA").Value & " no tiene parámetros", "msValidaciones")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
			End If
			rst1.MoveNext()
		End While
		CierraRS(rst1)
		CierraRS(rst2)
		'*a continuacion comprobamos que todos los jumps van a algun path existente
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP' " & "ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC"
		rst1 = mfRecordset(conPasarela, strSQL)
		While Not rst1.EOF
			msProceso(rst1.AbsolutePosition, rst1.RecordCount, 2, 3)
			strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & " ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value
			rst2 = mfRecordset(conPasarela, strSQL)
			If Not rst2.EOF Then
				If InStr(1, rst2.Fields("VALOR").Value, "FIN ") Then
					
				ElseIf InStr(1, rst2.Fields("VALOR").Value, "@INICIO!") Then 
					strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='" & rst2.Fields("VALOR").Value & "'"
					rst3 = mfRecordset(conPasarela, strSQL)
					While Not rst3.EOF
						strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA='" & rst3.Fields("VALOR").Value
						rst4 = mfRecordset(conPasarela, strSQL)
						If rst4.EOF Then
							strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PATH_HIDRA='" & rst3.Fields("VALOR").Value
							rst4 = mfRecordset(conPasarela, strSQL)
							If rst4.EOF Then
								strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,USERID,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "','" & strUserId & "', 'Validaciones Procedimiento', 'El salto " & rst3.Fields("PARAMETRO").Value & " no tiene destino')"
								'strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "', 'Validaciones Procedimiento', 'El salto " & rst3("PARAMETRO") & " no tiene destino')"
								'***************************
							End If
						End If
						rst3.MoveNext()
					End While
				Else
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA='" & rst2.Fields("VALOR").Value & "'"
					rst3 = mfRecordset(conPasarela, strSQL)
					If rst3.EOF Then
						strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PATH_HIDRA='" & rst2.Fields("VALOR").Value & "'"
						rst3 = mfRecordset(conPasarela, strSQL)
						If rst3.EOF Then
							strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,USERID,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "','" & strUserId & "', 'Validaciones Procedimiento', 'El salto " & rst1.Fields("PATH_HIDRA").Value & " no tiene destino')"
							'strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "','Validaciones Procedimiento', 'El salto " & rst1("PATH_HIDRA") & " no tiene destino')"
							'************************************
						End If
					End If
				End If
			Else
				strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,USERID,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "','" & strUserId & "', 'Validaciones Procedimiento', 'El salto " & rst1.Fields("PATH_HIDRA").Value & " no tiene destino')"
				'strSQL = "INSERT INTO ERRORES (PROCEDIMIENTO,AMBITO, DESCRIPCION) VALUES ('" & gNomProcCorto & "','Validaciones Procedimiento', 'El salto " & rst1("PATH_HIDRA") & " no tiene destino')"
				'**********************************
				mfExecute(conPasarela, strSQL)
			End If
			rst1.MoveNext()
		End While
		CierraRS(rst1)
		CierraRS(rst2)
		CierraRS(rst3)
		CierraRS(rst4)
		'*por ultimo q las variables que se igualan a otas existen con anterioridad.
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR LIKE '@INICIO!VAR%'"
		rst1 = mfRecordset(conPasarela, strSQL)
		While Not rst1.EOF
			msProceso(rst1.AbsolutePosition, rst1.RecordCount, 3, 3)
			strVar = Mid(rst1.Fields("VALOR").Value, 9)
			If strVar <> "VAR24" Then
				strSQL = "SELECT * FROM VAR_ALTA_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CODHIDRA='" & strVar & "'"
				rst2 = mfRecordset(conPasarela, strSQL)
				If rst2.EOF Then
					If rst1.Fields("ORDEN_N2").Value = 0 Then
						strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ((ORDEN_N1 < " & rst1.Fields("ORDEN_N1").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_ACC < " & rst1.Fields("ORDEN_ACC").Value & ")) and " & "(VALOR='" & strVar & "' OR PARAMETRO='@" & strVar & "')"
					ElseIf rst1.Fields("ORDEN_N3").Value = 0 Then 
						strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ((ORDEN_N1 < " & rst1.Fields("ORDEN_N1").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 < " & rst1.Fields("ORDEN_N2").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_ACC < " & rst1.Fields("ORDEN_ACC").Value & ")) and " & "(VALOR='" & strVar & "' OR PARAMETRO='@" & strVar & "')"
					ElseIf rst1.Fields("ORDEN_N4").Value = 0 Then 
						strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ((ORDEN_N1 < " & rst1.Fields("ORDEN_N1").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 < " & rst1.Fields("ORDEN_N2").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3 < " & rst1.Fields("ORDEN_N3").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_ACC < " & rst1.Fields("ORDEN_ACC").Value & ")) and " & "(VALOR='" & strVar & "' OR PARAMETRO='@" & strVar & "')"
					ElseIf rst1.Fields("ORDEN_N5").Value = 0 Then 
						strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ((ORDEN_N1 < " & rst1.Fields("ORDEN_N1").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 < " & rst1.Fields("ORDEN_N2").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3 < " & rst1.Fields("ORDEN_N3").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4 < " & rst1.Fields("ORDEN_N4").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_ACC < " & rst1.Fields("ORDEN_ACC").Value & ")) and " & "(VALOR='" & strVar & "' OR PARAMETRO='@" & strVar & "')"
					Else
						strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ((ORDEN_N1 < " & rst1.Fields("ORDEN_N1").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 < " & rst1.Fields("ORDEN_N2").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3 < " & rst1.Fields("ORDEN_N3").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & ") OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_N5 = " & rst1.Fields("ORDEN_N5").Value & " ) OR " & "(ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC < " & rst1.Fields("ORDEN_ACC").Value & ")) and " & "(VALOR='" & strVar & "' OR PARAMETRO='@" & strVar & "')"
					End If
					rst2 = mfRecordset(conPasarela, strSQL)
					If rst2.EOF Then
						'INSERTO EN LA TABLA DE PREGUNTAS
						strSQL = "SELECT NOMBRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value
						rst2 = mfRecordset(conPasarela, strSQL)
						strTram = rst2.Fields("NOMBRE").Value
						strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND " & "ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value
						rst2 = mfRecordset(conPasarela, strSQL)
						strAcc = rst2.Fields("PATH_HIDRA").Value
						strSQL = "SELECT DESATRIB FROM VARIABLES WHERE CODHIDRA='" & strVar & "'"
						rst2 = mfRecordset(conInfra, strSQL)
						If rst2.EOF Then
							'aketza 8/9/2006
							'strSQL = "SELECT DESATRIB FROM VARIABLES_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CODHIDRA='" & strVar & "'"
							strSQL = "SELECT DESATRIB FROM VARIABLES_PA WHERE CODHIDRA='" & strVar & "'"
							'fin aketza
							rst2 = mfRecordset(conPasarela, strSQL)
						End If
						If Not rst2.EOF Then
							strVar = rst2.Fields("DESATRIB").Value
						End If
						strSQL = "INSERT INTO VALIDACIONES (PROCEDIMIENTO,MENSAJE) VALUES " & "('" & gNomProcCorto & "','La variable " & Replace(strVar, "'", "''") & " que se encuenta en la acción " & strAcc & " del trámite " & strTram & " no se ha inicializado con anterioridad en el procedimiento')"
						mfExecute(conPasarela, strSQL)
					End If
				End If
			End If
			rst1.MoveNext()
		End While
		CierraRS(rst1)
		CierraRS(rst2)
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		
		If blnParar = True Then Exit Sub
		Insertar_Error(Me, "Validaciones", "Ha ocurrido un error no controlado", "msValidaciones")
		Mostrar_Error()
		logError("msRepaso - " & Err.Description)
		Resume procFin
procFin: 
		Tiempo = GetTickCount - Tiempo
		logTiempos("Validaciones: " & formatGTC(Tiempo))
	End Sub
	
	
	Private Sub msSolucionCaducar()
		On Error GoTo procErr
		Dim strSQL As String
		Dim rst1 As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rst3 As ADODB.Recordset
		Dim rst4 As ADODB.Recordset
		Dim rst5 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim arrFormulario As Object
		Dim strPath As String
		Dim strForm As String
		Dim lngNumAcc As Integer
		Dim nomTramS As String
		
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='METERCANCELFORMULARIO'"
		
		rst1 = mfRecordset(conPasarela, strSQL)
		While Not rst1.EOF
			strSeg = rst1.Fields("ORDEN_N1").Value & "/" & rst1.Fields("ORDEN_N2").Value & "/" & rst1.Fields("ORDEN_N3").Value & "/" & rst1.Fields("ORDEN_N4").Value & "/" & rst1.Fields("ORDEN_N5").Value
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CANCEL'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			strPath = "CNL FORM" & VB6.Format(lngNumAcc, "00")
			strSQL = "UPDATE ACCIONES_DI SET NOM_ACCION='CANCEL', PATH_HIDRA ='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND "
			strSQL = strSQL & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND "
			strSQL = strSQL & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value
			mfExecute(conPasarela, strSQL)
			'''BUSCO EL FORMULARIO QUE TENGO QUE CANCELAR
			'puede ocurrir que el path del cancel venga en dos formatos
			'1 - X;X;X;X;X - que nos indica el nivel del formulario
			'2 - "XXXXX" Una accion que esta dentro del nivel de dicho formulario
			strSQL = "SELECT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND "
			strSQL = strSQL & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND "
			strSQL = strSQL & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value
			rst2 = mfRecordset(conPasarela, strSQL)
			'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrFormulario = Split(rst2.Fields(0).Value, ";")
			If UBound(arrFormulario) > 1 Then
				strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & "ORDEN_N1=" & arrFormulario(0) & " AND ORDEN_N2=" & arrFormulario(1) & " AND "
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & "ORDEN_N3=" & arrFormulario(2) & " AND ORDEN_N4=" & arrFormulario(3) & " AND "
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & "ORDEN_N5=" & arrFormulario(4) & " AND NOM_ACCION='FORMFICTICIO'"
				rst3 = mfRecordset(conPasarela, strSQL)
				
				strForm = rst3.Fields(0).Value
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & strForm & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND "
				strSQL = strSQL & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND "
				strSQL = strSQL & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value '& " AND NUM_ACCION=" & rst1("NUM_ACCION")
				mfExecute(conPasarela, strSQL)
				
			Else
				strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				strSQL = strSQL & "NOM_DIAGRAMA='" & arrFormulario(0) & "'"
				rst3 = mfRecordset(conPasarela, strSQL)
				If Not rst3.EOF Then
					strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ORDEN_N1=" & rst3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst3.Fields("ORDEN_N2").Value & " AND "
					strSQL = strSQL & "ORDEN_N3=" & rst3.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst3.Fields("ORDEN_N4").Value & " AND "
					strSQL = strSQL & "ORDEN_N5=" & rst3.Fields("ORDEN_N5").Value & " AND NOM_ACCION='FORMFICTICIO'"
					rst4 = mfRecordset(conPasarela, strSQL)
					
					strForm = rst4.Fields(0).Value
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strForm & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND "
					strSQL = strSQL & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND "
					strSQL = strSQL & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value '& " AND NUM_ACCION=" & rst1("NUM_ACCION")
					mfExecute(conPasarela, strSQL)
					'strSQL = "DELETE FROM ACCIONES_DI NOM_ACCION='METERCANCELFORMULARIO' and orden_n1=" & rst1("ORDEN_N1") & " AND orden_n2=" & rst1("ORDEN_N2") & " AND orden_n3=" & rst1("ORDEN_N3") & " AND orden_n4=" & rst1("ORDEN_N4") & " AND orden_n5=" & rst1("ORDEN_N5") & " AND orden_ACC=" & rst1("ORDEN_ACC") & " AND NUM_aCCION=" & rst1("NUM_ACCION")
					'mfExecute conPasarela, strSQL
				Else
					strSQL = "SELECT NOMBRE FROM TBPFIN03_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					'UPGRADE_WARNING: Couldn't resolve default property of object arrFormulario(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					strSQL = strSQL & "ORDENTRA=" & arrFormulario(0)
					rst5 = mfRecordset(conPasarela, strSQL)
					
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "NOM_DIAGRAMA='" & Trim(rst5.Fields("NOMBRE").Value) & "'"
					rst3 = mfRecordset(conPasarela, strSQL)
					
					strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ORDEN_N1=" & rst3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst3.Fields("ORDEN_N2").Value & " AND "
					strSQL = strSQL & "ORDEN_N3=" & rst3.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst3.Fields("ORDEN_N4").Value & " AND "
					strSQL = strSQL & "ORDEN_N5=" & rst3.Fields("ORDEN_N5").Value & " AND NOM_ACCION='FORMFICTICIO'"
					rst4 = mfRecordset(conPasarela, strSQL)
					
					'##   DS66 23/02/09
					If Not rst4.EOF Then
						'##
						strForm = rst4.Fields(0).Value
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strForm & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND "
						strSQL = strSQL & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND "
						strSQL = strSQL & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value '& " AND NUM_ACCION=" & rst1("NUM_ACCION")
						mfExecute(conPasarela, strSQL)
						'##   DS66 23/02/09
					End If
					'##
					
					'strSQL = "DELETE FROM ACCIONES_DI NOM_ACCION='METERCANCELFORMULARIO' and orden_n1=" & rst1("ORDEN_N1") & " AND orden_n2=" & rst1("ORDEN_N2") & " AND orden_n3=" & rst1("ORDEN_N3") & " AND orden_n4=" & rst1("ORDEN_N4") & " AND orden_n5=" & rst1("ORDEN_N5") & " AND orden_ACC=" & rst1("ORDEN_ACC") & " AND NUM_aCCION=" & rst1("NUM_ACCION")
					'mfExecute conPasarela, strSQL
					
				End If
			End If
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=0"
			rst4 = mfRecordset(conPasarela, strSQL)
			'## DS66 24/03/2009
			'strSQL = "select * from conectores_Di where PROCEDIMIENTO='" & gNomProcCorto & "' AND num=" & rst4("NUM_DIAGRAMA") & " and num_Sec_desde=" & rst4("NUM_SEQ") & " and cat_conector<>''"
			strSQL = "select * from conectores_Di where PROCEDIMIENTO='" & gNomProcCorto & "' AND num=" & rst4.Fields("NUM_DIAGRAMA").Value & " and num_Sec_desde=" & rst4.Fields("NUM_SEQ").Value & " and cat_conector<>'' and CAT_CONECTOR='Fin de plazo 1'"
			'##
			rst3 = mfRecordset(conPasarela, strSQL)
			If Not rst3.EOF Then
				strSQL = "SELECT * FROM diagrama WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rst3.Fields("NUM").Value & " and NUM_SEQ=" & rst3.Fields("NUM_SEC_HASTA").Value
				rst2 = mfRecordset(conPasarela, strSQL)
				If Not rst2.EOF Then
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value
					rst2 = mfRecordset(conPasarela, strSQL)
					If Not rst2.EOF Then
						
						nomTramS = rst2.Fields("NOM_DIAGRAMA").Value
						If nomTramS = "" Then
							If rst2.Fields("ORDEN_N2").Value = 0 Then
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rst2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rst2.Fields("ORDEN_N3").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rst2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rst2.Fields("ORDEN_N4").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rst2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rst2.Fields("ORDEN_N5").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rst2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							End If
							rst2 = mfRecordset(conPasarela, strSQL)
							Do While Not rst2.EOF
								If rst2.Fields("NOM_DIAGRAMA").Value <> "" Then
									nomTramS = rst2.Fields("NOM_DIAGRAMA").Value
									Exit Do
								End If
								rst2.MoveNext()
								nomTramS = "PR_FINEXPEDIENTE"
							Loop 
						End If
						strSQL = "select * from acciones_di WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value + 1
						rst2 = mfRecordset(conPasarela, strSQL)
						
						If Not rst2.EOF Then
							If rst2.Fields("NOM_ACCION").Value = "JUMP" Then
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & nomTramS & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " AND "
								strSQL = strSQL & "ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " AND "
								strSQL = strSQL & "ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value + 1
								mfExecute(conPasarela, strSQL)
							End If
						End If
						
						
					End If
				End If
			End If
			rst1.MoveNext()
		End While
		strSQL = "DELETE FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='METERCANCELFORMULARIO'"
		mfExecute(conPasarela, strSQL)
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Repaso", "Ha ocurrido un error no controlado", "msSolucionCaducar" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msRepaso - " & Err.Description)
		Resume procFin
procFin: 
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rst1)
		'UPGRADE_NOTE: Object rst1 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst1 = Nothing
		CierraRS(rst2)
		'UPGRADE_NOTE: Object rst2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst2 = Nothing
		CierraRS(rst3)
		'UPGRADE_NOTE: Object rst3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst3 = Nothing
		CierraRS(rst4)
		'UPGRADE_NOTE: Object rst4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst4 = Nothing
		CierraRS(rst5)
		'UPGRADE_NOTE: Object rst5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rst5 = Nothing
	End Sub
	
	Private Function mfUnidTraComunicacion(ByVal AnoID As Integer, ByVal idPadre As Integer, ByVal idpadre2 As Integer, ByVal Orden As Integer, ByRef orden1 As Integer, ByRef orden2 As Integer, ByRef orden3 As Integer, ByRef orden4 As Integer, ByRef orden5 As Integer, ByRef idInicial As Integer, Optional ByRef idArrastra As Integer = 0) As Boolean
		Dim cont As Short
		Dim rstTram As ADODB.Recordset
		Dim rstTram1 As ADODB.Recordset
		Dim rstTram2 As ADODB.Recordset
		Dim rsttram3 As ADODB.Recordset
		Dim rsttram4 As ADODB.Recordset
		Dim rsttram5 As ADODB.Recordset
		Dim strSQL As String
		Dim arr As Object
		Dim strDestino As String
		Dim rstRami As ADODB.Recordset
		Dim blnRami As Boolean
		'Inicio Jonathan Prieto 10/02/2011: variables necesarias para el nuevo tratamiento
		Dim rstObjDestino As ADODB.Recordset
		Dim intObjDestino As Short
		'Fin Jonathan Prieto 10/02/2011
		
		On Error GoTo procErr
		
		mfUnidTraComunicacion = True
		
		strSQL = "SELECT * " & "FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & AnoID & " " & "AND ORDEN_N1 = " & orden1 & " " & "AND ORDEN_N2 = " & orden2 & " " & "AND ORDEN_N3 = " & orden3 & " " & "AND ORDEN_N4 = " & orden4 & " " & "AND ORDEN_N5 = " & orden5
		rstTram1 = mfRecordset(conPasarela, strSQL)
		If orden5 <> 0 Then
			strSQL = "SELECT * " & "FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & idpadre2 & " " & "AND ORDEN_N1 = " & orden1 & " " & "AND ORDEN_N2 = " & orden2 & " " & "AND ORDEN_N3 = " & orden3 & " " & "AND ORDEN_N4 = " & orden4 & " " & "AND ORDEN_N5 = 0"
		ElseIf orden4 <> 0 Then 
			strSQL = "SELECT * " & "FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & idpadre2 & " " & "AND ORDEN_N1 = " & orden1 & " " & "AND ORDEN_N2 = " & orden2 & " " & "AND ORDEN_N3 = " & orden3 & " " & "AND ORDEN_N4 = 0"
		ElseIf orden3 <> 0 Then 
			strSQL = "SELECT * " & "FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & idpadre2 & " " & "AND ORDEN_N1 = " & orden1 & " " & "AND ORDEN_N2 = " & orden2 & " " & "AND ORDEN_N3 = 0"
		ElseIf orden2 <> 0 Then 
			strSQL = "SELECT * " & "FROM PROPIEDADES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & idpadre2 & " " & "AND ORDEN_N1 = " & orden1 & " " & "AND ORDEN_N2 = 0"
		End If
		rstRami = mfRecordset(conPasarela, strSQL)
		If Not rstRami.EOF Then
			If rstRami.Fields("TIPO_DIAGRAMA").Value = "O" Then
				blnRami = True
			End If
		End If
		'If Not rstTram1.EOF Then
		'If rstTram1("TIPO_DIAGRAMA") = "Comunicación" Then
		'    mfUnidTraComunicacion = False
		'    Exit Function
		'End If
		'End If
		'SECCION A COMENTAR
		If blnRami = True Then
			If rstTram1.Fields("ORDEN_N3").Value <> 0 Then
				strSQL = "SELECT * " & "FROM DIAGRAMA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & idpadre2 & " " & "AND ORDEN_N1 = " & orden1 & " " & "AND ORDEN_N2 = " & orden2
			Else
				strSQL = "SELECT * " & "FROM DIAGRAMA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & idpadre2 & " " & "AND ORDEN_N1 = " & orden1
			End If
		Else
			strSQL = "SELECT * " & "FROM DIAGRAMA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & AnoID & " " & "AND ORDEN_N1 = " & orden1 & " " & "AND ORDEN_N2 = " & orden2 & " " & "AND ORDEN_N3 = " & orden3 & " " & "AND ORDEN_N4 = " & orden4 & " " & "AND ORDEN_N5 = " & orden5
		End If
		'SECCION A DESCOMENTAR
		'''''    strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA= " & idpadre2 & " AND ORDEN_N1=" & ORDEN1
		'''''    strSQL = strSQL & " AND ORDEN_N2 = " & ORDEN2 & " AND ORDEN_N3=" & ORDEN3
		'''''    strSQL = strSQL & " AND ORDEN_N4 = " & ORDEN4 & " AND ORDEN_N5=" & ORDEN5
		rstTram1 = mfRecordset(conPasarela, strSQL)
		If rstTram1.EOF Then
			strSQL = "SELECT * " & "FROM DIAGRAMA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND ID_DIAGRAMA = " & idInicial & " " & "AND ORDEN_N1 = " & orden1
			rstTram1 = mfRecordset(conPasarela, strSQL)
		End If
		strSQL = "SELECT DISTINCT NUM_SEC_HASTA " & "FROM CONECTORES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND DIAGRAMA = " & rstTram1.Fields("DI_ID").Value & " " & "AND NUM_SEC_DESDE = " & rstTram1.Fields("NUM_SEQ").Value
		rstTram2 = mfRecordset(conPasarela, strSQL)
		If rstTram2.EOF Then
			strSQL = "SELECT DISTINCT NUM_SEC_HASTA " & "FROM CONECTORES_DI " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND DI_ID = " & rstTram1.Fields("DI_ID").Value & " " & "AND NUM_SEC_DESDE = " & rstTram1.Fields("NUM_SEQ").Value
			rstTram2 = mfRecordset(conPasarela, strSQL)
		End If
		While Not rstTram2.EOF
			strDestino = strDestino & rstTram2.Fields("NUM_SEC_HASTA").Value & "','"
			rstTram2.MoveNext()
		End While
		'***** ????¿¿¿¿*****
		If strDestino = "" Then
			Insertar_Error(Me, "Lectura de Unidades Tramitación", "El strdestino es vacio -- No se encuentran las unidades de tramitación para el trámite  " & AnoID, "mfUnidTraComunicacion")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			mfUnidTraComunicacion = False
			Exit Function
		End If
		'*****************
		'esto da error si strDestino está vacio (aketza)
		strDestino = Mid(strDestino, 1, Len(strDestino) - 2)
		strDestino = "'" & strDestino
		'rstTram2.MoveFirst
		strSQL = "SELECT DISTINCT B.ANO_ID " & "FROM CW_OBJECT_TYPE A, " & "SHAPE B " & "WHERE A.OT_ID = B.ANO_TABNR " & "AND B.SH_SEQ IN (" & strDestino & ") " & "AND B.ANO_TABNR = 9097 " & "AND B.DI_ID = " & rstTram1.Fields("DI_ID").Value & " " & "AND A.MODEL_NAME = '" & strModelo & "' " & "AND B.MODEL_NAME = '" & strModelo & "'"
		rsttram3 = mfRecordset(conDP4, strSQL)
		cont = cont + 1
		
		'Inicio Jonathan Prieto 10/02/2011: busco sólo el objeto M*** Comunicación Plazo Baja
		If Not rsttram3.EOF Then
			intObjDestino = -1 'inicializo la variable con valor negativo, por si encuentra un objeto con ID=0
			strSQL = "SELECT EV_ID " & "FROM CW_OBJECT_TYPE A, " & "EVENT B, " & "SHAPE C, " & "JOINER D, " & "SHAPE E " & "WHERE A.OT_NAME = 'Evento/Resultado' " & "AND A.OT_ID = C.ANO_TABNR " & "AND B.EV_ID = C.ANO_ID " & "AND C.SH_SEQ = D.SH_SEQ_TO " & "AND C.DI_ID = D.DI_ID " & "AND E.DI_ID = D.DI_ID " & "AND E.SH_SEQ = D.SH_SEQ_FROM " & "AND C.DI_ID = " & rstTram1.Fields("DI_ID").Value & " " & "AND D.SH_SEQ_TO IN (" & strDestino & ") " & "AND SUBSTRING(EV_NAME,1,1) = 'M' " & "AND A.MODEL_NAME = '" & strModelo & "' " & "AND B.MODEL_NAME = '" & strModelo & "' " & "AND C.MODEL_NAME = '" & strModelo & "' " & "AND D.MODEL_NAME = '" & strModelo & "' " & "AND E.MODEL_NAME = '" & strModelo & "'"
			rstObjDestino = mfRecordset(conDP4, strSQL)
			If Not rstObjDestino.EOF Then
				intObjDestino = rstObjDestino.Fields("EV_ID").Value
			End If
		End If
		'Fin Jonathan Prieto 10/02/2011
		
		'Inicio Jonathan Prieto 10/02/2011: busca la UT del objeto M*** Comunicación Plazo Baja
		strSQL = "SELECT DISTINCT E.OU_ID, " & "E.OU_NAME " & "FROM CW_OBJECT_TYPE A, " & "ORGANIZATION E, " & "SHAPE C, " & "SHAPE D, " & "EVENT " & "WHERE C.ANO_ID = EVENT.EV_ID " & "AND A.OT_ID = C.ANO_TABNR " & "AND C.ANO_TABNR = 9097 "
		'strSQL = strSQL & "AND C.ANO_ID=" & rsttram3("ANO_ID") & " AND C.DI_ID=" & rstTram1("DI_ID")
		'## DS66 4/01/10
		'    If Not rsttram3.EOF Then
		'      strSql = strSql & "AND C.ANO_ID=" & rsttram3("ANO_ID")
		'      Else
		'      DoEvents
		'    End If
		If intObjDestino <> -1 Then
			strSQL = strSQL & "AND C.ANO_ID = " & intObjDestino & " "
		End If
		'Fin Jonathan Prieto 10/02/2011
		'##
		strSQL = strSQL & "AND C.DI_ID = " & rstTram1.Fields("DI_ID").Value & " " & "AND C.DI_ID = D.DI_ID " & "AND D.ANO_ID = E.OU_ID " & "AND D.ANO_TABNR NOT IN (SELECT OT_ID " & "FROM CW_OBJECT_TYPE " & "WHERE MODEL_NAME = '" & strModelo & "' " & "AND OT_NAME = 'FaseSubfase') " & "AND C.SH_X > D.SH_X " & "AND C.SH_X < D.SH_WIDTH + D.SH_X " & "AND C.SH_Y < D.SH_Y " & "AND C.SH_Y > D.SH_Y - D.SH_HEIGHT " & "AND C.SH_SEQ IN (" & strDestino & ") " & "AND A.MODEL_NAME = '" & strModelo & "' " & "AND E.MODEL_NAME = '" & strModelo & "' " & "AND C.MODEL_NAME = '" & strModelo & "' " & "AND D.MODEL_NAME = '" & strModelo & "' " & "AND EVENT.MODEL_NAME = '" & strModelo & "'"
		rsttram4 = mfRecordset(conDP4, strSQL)
		While Not rsttram4.EOF
			'Inicio Jonathan Prieto 10/02/2011: si no tiene UT en la organización, hay que buscar la UT del padre
			If rsttram4.Fields("OU_NAME").Value <> "(Unidad donde está dibujado)" Then
				'la organización donde está dibujado si tiene UT
				strSQL = "SELECT CODUNITR, " & "CODUTRHN " & "FROM TBPFIN23_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "' " & "AND NUMORG = " & rsttram4.Fields("OU_ID").Value
				rsttram5 = mfRecordset(conPasarela, strSQL)
				If Not rsttram5.EOF Then
					strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO, CODPROCE, ORDENTRA, CODTRAAD, CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "', " & lngCodProc & ", " & Orden & ", " & idInicial & ", " & rsttram5.Fields("CODUNITR").Value & ", " & "'" & rsttram5.Fields("CODUTRHN").Value & "', " & "'N', " & "'S')"
					mfExecute(conPasarela, strSQL)
				Else
					strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO, CODPROCE, ORDENTRA, CODTRAAD, CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "', " & lngCodProc & ", " & Orden & ", " & idInicial & ", " & rsttram4.Fields("OU_ID").Value & ", " & "'', " & "'N', " & "'S')"
					mfExecute(conPasarela, strSQL)
				End If
			Else
buscaUTpadre: 
				'Hay que buscar la UT donde está dibujado el padre
				strSQL = "SELECT * " & "FROM DIAGRAMA " & "WHERE PROCEDIMIENTO = 'P01100' " & "AND ID_DIAGRAMA = " & rstTram1.Fields("ID_PADRE").Value
				Select Case rstTram1.Fields("NUM_DIAGRAMA").Value
					Case 2
						strSQL = strSQL & " AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
					Case 3
						strSQL = strSQL & " AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value
					Case 4
						strSQL = strSQL & " AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram1.Fields("ORDEN_N3").Value
					Case 5
						strSQL = strSQL & " AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram1.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram1.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram1.Fields("ORDEN_N4").Value
				End Select
				rstTram1 = mfRecordset(conPasarela, strSQL)
				If Not rstTram1.EOF Then
					strSQL = "Select OU_ID, OU_NAME From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
					strSQL = strSQL & " Where A.OT_NAME = 'Proceso' AND A.OT_ID = C.ANO_TABNR and B.PR_ID = C.ANO_ID "
					strSQL = strSQL & " and C.DI_ID = D.DI_ID and D.ANO_ID = E.OU_ID AND C.SH_X > D.SH_X and C.SH_X < D.SH_WIDTH+D.SH_X and C.SH_Y < D.SH_Y and C.SH_Y > D.SH_Y - D.SH_HEIGHT "
					strSQL = strSQL & " and B.PR_ID =" & rstTram1.Fields("ID_DIAGRAMA").Value & " and C.DI_ID =" & rstTram1.Fields("DI_ID").Value
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					rsttram4 = mfRecordset(conDP4, strSQL)
					If Not rsttram4.EOF Then
						If rsttram4.Fields("OU_NAME").Value = "(Unidad donde está dibujado)" Then
							'El padre tampoco tiene UT, debe subir a el "abuelo"
							GoTo buscaUTpadre
						End If
					End If
					'Comprueba que exista la UT en la TBPFIN23_PA
					strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUMORG=" & rsttram4.Fields("OU_ID").Value
					rsttram5 = mfRecordset(conPasarela, strSQL)
					If Not rsttram5.EOF Then
						'Puede que ya exista el registro en la TBPFIN04_PA, entonces no habría que hacer la INSERT
						strSQL = "SELECT * FROM TBPFIN04_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CODPROCE=" & lngCodProc & " AND ORDENTRA=" & Orden & " AND CODTRAAD=" & idInicial & " AND CODUNITR=" & rsttram4.Fields("OU_ID").Value
						rsttram5 = mfRecordset(conPasarela, strSQL)
						If rsttram5.EOF Then
							strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, "
							strSQL = strSQL & "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES ("
							strSQL = strSQL & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & ","
							strSQL = strSQL & rsttram5.Fields("CODUNITR").Value & ",'" & rsttram5.Fields("CODUTRHN").Value & "','N','S')"
							mfExecute(conPasarela, strSQL)
						End If
					Else
						strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, "
						strSQL = strSQL & "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES ("
						strSQL = strSQL & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & ","
						strSQL = strSQL & rsttram4.Fields("OU_ID").Value & ",'','N','S')"
						mfExecute(conPasarela, strSQL)
					End If
				End If
			End If
			'Fin Jonathan Prieto 10/02/2011
			rsttram4.MoveNext()
		End While
		
		Exit Function
		
		strSQL = "SELECT DISTINCT D.OU_ID, C.PR_NAME, E.OU_NAME FROM "
		strSQL = strSQL & "DIAGRAM A, SHAPE B, PROCESS C, CW_REASON D, ORGANIZATION E WHERE "
		strSQL = strSQL & "A.DI_ID=B.DI_ID AND "
		strSQL = strSQL & "B.ANO_ID=C.PR_ID AND "
		strSQL = strSQL & "C.PR_ID=D.PR_ID AND "
		strSQL = strSQL & "D.OU_ID=E.OU_ID AND "
		strSQL = strSQL & "B.ANO_ID= " & AnoID
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		rstTram = mfRecordset(conDP4, strSQL)
		
		If Not rstTram.EOF Then
			If rstTram.Fields("OU_NAME").Value = "Persona Interesada" Or rstTram.Fields("OU_NAME").Value = "Persona Implicada" Then
				strSQL = "UPDATE PROPIEDADES_DI SET INDPERSINT='1' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & AnoID
				mfExecute(conPasarela, strSQL)
				'strSQL = "INSERT INTO TBPFIN04_PA (CODPROCE, ORDENTRA, CODTRAAD, " _
				'& "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" _
				'& lngCodProc & "," & Orden & ", " & IIf(idArrastra <> 0, idArrastra, AnoID) & "," _
				'& "'76','USUARIO-GENERAL','S','N')"
				strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & "'76','USUARIO-GENERAL','S','N')"
				mfExecute(conPasarela, strSQL)
				Exit Function
			End If
			
			'UPGRADE_WARNING: Couldn't resolve default property of object rstTram.GetRows. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			'UPGRADE_WARNING: Couldn't resolve default property of object arr. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arr = rstTram.GetRows
			System.Windows.Forms.Application.DoEvents()
			rstTram.MoveFirst()
			'si existe mas de uno
			If UBound(arr, 2) + 1 > 1 Then
				'*16/09/2004
				strSQL = "SELECT ID_DIAGRAMA, ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE"
				rsttram3 = mfRecordset(conPasarela, strSQL)
				If Not rsttram3.EOF Then
					AnoID = rsttram3.Fields("ID_DIAGRAMA").Value
					'idPadre = rsttram3("ID_PADRE")
					idPadre = rsttram3.Fields("DI_ID").Value
				Else
					AnoID = AnoID
					idPadre = idPadre
				End If
				'*16/09/2004 end
				strSQL = "Select OU_ID, OU_NAME "
				strSQL = strSQL & "From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
				strSQL = strSQL & "Where A.OT_NAME = 'Proceso' AND "
				strSQL = strSQL & "A.OT_ID = C.ANO_TABNR and "
				strSQL = strSQL & "B.PR_ID = C.ANO_ID and "
				strSQL = strSQL & "C.DI_ID = D.DI_ID and "
				strSQL = strSQL & "D.ANO_ID = E.OU_ID AND "
				strSQL = strSQL & "C.SH_X > D.SH_X and "
				strSQL = strSQL & "C.SH_X < D.SH_WIDTH+D.SH_X and "
				strSQL = strSQL & "C.SH_Y < D.SH_Y and "
				strSQL = strSQL & "C.SH_Y > D.SH_Y - D.SH_HEIGHT and "
				strSQL = strSQL & "B.PR_ID =" & AnoID & " and "
				strSQL = strSQL & "C.DI_ID =" & idPadre
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				rsttram3 = mfRecordset(conDP4, strSQL)
				
				If Not rsttram3.EOF Then
					strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rsttram3.Fields("OU_ID").Value
					rstTram2 = mfRecordset(conPasarela, strSQL)
					If Not rstTram2.EOF Then
						'strSQL = "INSERT INTO TBPFIN04_PA (CODPROCE, ORDENTRA, CODTRAAD, " _
						'& "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" _
						'& lngCodProc & "," & Orden & ", " & IIf(idArrastra <> 0, idArrastra, AnoID) & "," _
						'& rstTram2("CODUNITR") & ",'" & rstTram2("CODUTRHN") & "','S','N')"
						strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
						mfExecute(conPasarela, strSQL)
					Else
						While Not rstTram.EOF
							strSQL = "SELECT CODUNITR, CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
							rstTram2 = mfRecordset(conPasarela, strSQL)
							If Not rstTram2.EOF Then
								'strSQL = "INSERT INTO TBPFIN04_PA (CODPROCE, ORDENTRA, CODTRAAD, " _
								'& "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" _
								'& lngCodProc & "," & Orden & ", " & IIf(idArrastra <> 0, idArrastra, AnoID) & "," _
								'& rstTram2("CODUNITR") & ",'" & rstTram2("CODUTRHN") & "','S','N')"
								strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
								mfExecute(conPasarela, strSQL)
							Else
								If rstTram.Fields("OU_ID").Value <> 76 Then
									'aketza errores
									Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite  " & rstTram.Fields("PR_NAME").Value, "mfUnidTraComunicacion")
									'mostramos el btn y el lbl
									Mostrar_Error()
									'fin aketza
									mfUnidTraComunicacion = False
								End If
							End If
							rstTram.MoveNext()
						End While
					End If
				End If
			Else
				'solamente tiene 1
				strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
				rstTram2 = mfRecordset(conPasarela, strSQL)
				If Not rstTram2.EOF Then
					'strSQL = "INSERT INTO TBPFIN04_PA (CODPROCE, ORDENTRA, CODTRAAD, " _
					'& "CODUNITR, INDTRAMI, INDCOMUN) VALUES (" _
					'& lngCodProc & "," & Orden & ", " & IIf(idArrastra <> 0, idArrastra, AnoID) & "," _
					'& rstTram2("CODUNITR") & ",'N','S')"
					'strSQL = "INSERT INTO TBPFIN04_PA (CODPROCE, ORDENTRA, CODTRAAD, " _
					'& "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" _
					'& lngCodProc & "," & Orden & ", " & IIf(idArrastra <> 0, idArrastra, AnoID) & "," _
					'& rstTram2("CODUNITR") & ",'" & rstTram2("CODUTRHN") & "','S','N')"
					strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
					mfExecute(conPasarela, strSQL)
				Else
					'aketza errores
					Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite  " & rstTram.Fields("PR_NAME").Value, "mfUnidTraComunicacion")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					mfUnidTraComunicacion = False
				End If
			End If
		Else
			'se buscan las del padre y se vuelve a realizar el mismo proceso
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & idPadre & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
			rsttram3 = mfRecordset(conPasarela, strSQL)
			If Not rsttram3.EOF Then
				mfUnidTra(rsttram3.Fields("ID_DIAGRAMA").Value, rsttram3.Fields("DI_ID").Value, rsttram3.Fields("ID_PADRE").Value, Orden, rsttram3.Fields("ORDEN_N1").Value, rsttram3.Fields("ORDEN_N2").Value, rsttram3.Fields("ORDEN_N3").Value, rsttram3.Fields("ORDEN_N4").Value, rsttram3.Fields("ORDEN_N5").Value, idInicial, IIf(idArrastra <> 0, idArrastra, AnoID))
			Else
				
				strSQL = "Select OU_ID, OU_NAME "
				strSQL = strSQL & "From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
				strSQL = strSQL & "Where A.OT_NAME = 'Proceso' AND "
				strSQL = strSQL & "A.OT_ID = C.ANO_TABNR and "
				strSQL = strSQL & "B.PR_ID = C.ANO_ID and "
				strSQL = strSQL & "C.DI_ID = D.DI_ID and "
				strSQL = strSQL & "D.ANO_ID = E.OU_ID AND "
				strSQL = strSQL & "C.SH_X > D.SH_X and "
				strSQL = strSQL & "C.SH_X < D.SH_WIDTH+D.SH_X and "
				strSQL = strSQL & "C.SH_Y < D.SH_Y and "
				strSQL = strSQL & "C.SH_Y > D.SH_Y - D.SH_HEIGHT and "
				strSQL = strSQL & "B.PR_ID =" & AnoID & " and "
				strSQL = strSQL & "C.DI_ID =" & idPadre
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				rsttram3 = mfRecordset(conDP4, strSQL)
				
				If Not rsttram3.EOF Then
					strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "NUMORG=" & rsttram3.Fields("OU_ID").Value
					rstTram2 = mfRecordset(conPasarela, strSQL)
					If Not rstTram2.EOF Then
						strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
						mfExecute(conPasarela, strSQL)
					Else
						'''''
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & idpadre2 & " AND ID_DIAGRAMA<>ID_PADRE AND ORDEN_N1=" & rstTram1.Fields("ORDEN_N1").Value
						rsttram3 = mfRecordset(conPasarela, strSQL)
						If Not rsttram3.EOF Then
							''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
							strSQL = "Select OU_ID, OU_NAME "
							strSQL = strSQL & "From CW_OBJECT_TYPE A, PROCESS B, SHAPE C, SHAPE D, ORGANIZATION E "
							strSQL = strSQL & "Where A.OT_NAME = 'Proceso' AND "
							strSQL = strSQL & "A.OT_ID = C.ANO_TABNR and "
							strSQL = strSQL & "B.PR_ID = C.ANO_ID and "
							strSQL = strSQL & "C.DI_ID = D.DI_ID and "
							strSQL = strSQL & "D.ANO_ID = E.OU_ID AND "
							strSQL = strSQL & "C.SH_X > D.SH_X and "
							strSQL = strSQL & "C.SH_X < D.SH_WIDTH+D.SH_X and "
							strSQL = strSQL & "C.SH_Y < D.SH_Y and "
							strSQL = strSQL & "C.SH_Y > D.SH_Y - D.SH_HEIGHT and "
							strSQL = strSQL & "B.PR_ID =" & idpadre2 & " and C.di_id=" & rsttram3.Fields("DI_ID").Value
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							rsttram4 = mfRecordset(conDP4, strSQL)
							If Not rsttram4.EOF Then
								strSQL = "SELECT * FROM EQUIV_UT WHERE CODCM=" & rsttram4.Fields("OU_ID").Value
								rsttram5 = mfRecordset(conPasarela, strSQL)
								If Not rsttram5.EOF Then
									While Not rsttram5.EOF
										strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, "
										strSQL = strSQL & "CODUNITR,CODUTRHN, INDTRAMI, INDCOMUN) VALUES ( "
										strSQL = strSQL & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & ", "
										strSQL = strSQL & rsttram5.Fields("CODHN").Value & ",'" & rsttram5.Fields("CODUTRHN").Value & "','S','N')"
										mfExecute(conPasarela, strSQL)
										rsttram5.MoveNext()
									End While
								Else
									mfUnidTra(rsttram3.Fields("ID_DIAGRAMA").Value, rsttram3.Fields("DI_ID").Value, rsttram3.Fields("ID_PADRE").Value, Orden, rsttram3.Fields("ORDEN_N1").Value, rsttram3.Fields("ORDEN_N2").Value, rsttram3.Fields("ORDEN_N3").Value, rsttram3.Fields("ORDEN_N4").Value, rsttram3.Fields("ORDEN_N5").Value, idInicial, IIf(idArrastra <> 0, idArrastra, AnoID))
								End If
							Else
								''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								mfUnidTra(rsttram3.Fields("ID_DIAGRAMA").Value, rsttram3.Fields("DI_ID").Value, rsttram3.Fields("ID_PADRE").Value, Orden, rsttram3.Fields("ORDEN_N1").Value, rsttram3.Fields("ORDEN_N2").Value, rsttram3.Fields("ORDEN_N3").Value, rsttram3.Fields("ORDEN_N4").Value, rsttram3.Fields("ORDEN_N5").Value, idInicial, IIf(idArrastra <> 0, idArrastra, AnoID))
							End If
						End If
						'mfUnidTra idpadre2
						'''''
						While Not rstTram.EOF
							strSQL = "SELECT CODUNITR,CODUTRHN FROM TBPFIN23_PA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUMORG=" & rstTram.Fields("OU_ID").Value
							rstTram2 = mfRecordset(conPasarela, strSQL)
							If Not rstTram2.EOF Then
								strSQL = "INSERT INTO TBPFIN04_PA (PROCEDIMIENTO,CODPROCE, ORDENTRA, CODTRAAD, " & "CODUNITR, CODUTRHN, INDTRAMI, INDCOMUN) VALUES (" & "'" & gNomProcCorto & "'," & lngCodProc & "," & Orden & ", " & idInicial & "," & rstTram2.Fields("CODUNITR").Value & ",'" & rstTram2.Fields("CODUTRHN").Value & "','S','N')"
								mfExecute(conPasarela, strSQL)
							Else
								'aketza errores
								Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite  " & rstTram.Fields("PR_NAME").Value, "mfUnidTraComunicacion")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
								mfUnidTraComunicacion = False
							End If
							rstTram.MoveNext()
						End While
					End If
				Else
					'aketza errores
					Insertar_Error(Me, "Lectura de Unidades Tramitación", "No se encuentran las unidades de tramitación para el trámite  " & AnoID, "mfUnidTraComunicacion")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					mfUnidTraComunicacion = False
				End If
				
				
			End If
		End If
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		logError("mfUnidTra - " & Err.Description)
		'aketza errores
		Insertar_Error(Me, "Lectura de Unidades de Tramitación", "Ha ocurrido un error no controlado", "mfUnidTraComunicacion")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		Resume procFin
procFin: 
		CierraRS(rstTram)
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
		CierraRS(rstTram2)
		'UPGRADE_NOTE: Object rstTram2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram2 = Nothing
		CierraRS(rsttram3)
		'UPGRADE_NOTE: Object rsttram3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rsttram3 = Nothing
		
		'aketza 09/04/2008
		CierraRS(rsttram4)
		'UPGRADE_NOTE: Object rsttram4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rsttram4 = Nothing
		CierraRS(rsttram5)
		'UPGRADE_NOTE: Object rsttram5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rsttram5 = Nothing
		'fin aketza
		'Inicio Jonathan Prieto 10/02/2011
		CierraRS(rstObjDestino)
		'UPGRADE_NOTE: Object rstObjDestino may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstObjDestino = Nothing
		'Fin Jonathan Prieto 10/02/2011
		
	End Function
	
	
	
	
	
	Private Function mfInsertaVariablesNOMBRE(ByVal strNOM As String) As Object
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rstInfra As ADODB.Recordset
		Dim rstPasa As ADODB.Recordset
		Dim strValor As String
		Dim arrValor() As String
		Dim I As Integer
		
		'Por si viene más de una variable informada (separadas por ";")
		arrValor = Split(strNOM, ";")
		
		For I = 0 To UBound(arrValor)
			strValor = vbNullString
			
			'----------------------------------------------------------------------------------------------------------
			'BUSQUEDA EN LA BBDD GENERAL
			'----------------------------------------------------------------------------------------------------------
			'Busco en la BBDD General con el nombre completo tal y como aparece en Corporate
			'o con el nombre de la variable sin los paréntesis (si los tuviera)
			If InStr(1, arrValor(I), "(") > 0 Then
				'Tiene paréntesis en el nombre
				strSQL = "SELECT * FROM VARIABLES" & " WHERE (DESATRIB='" & arrValor(I) & "'" & " OR DESATRIB='" & Trim(VB.Left(arrValor(I), InStr(1, arrValor(I), "(") - 1)) & "')"
			Else
				'No tiene paréntesis en el nombre
				strSQL = "SELECT * FROM VARIABLES" & " WHERE DESATRIB='" & arrValor(I) & "'"
			End If
			rstInfra = mfRecordset(conInfra, strSQL)
			'Comprobamos si se ha encontrado alguna coincidencia
			If Not rstInfra.EOF Then
				If rstInfra.RecordCount > 1 Then
					'Se han encontrado varias coincidencias, volvemos a realizar la consulta filtrando sólo con el nombre completo
					strSQL = "SELECT * FROM VARIABLES" & " WHERE DESATRIB='" & arrValor(I) & "'"
					rstInfra = mfRecordset(conInfra, strSQL)
					'Comprobamos si se ha encontrado alguna coincidencia
					If Not rstInfra.EOF Then
						'Encontrada una coincidencia en la BBDD General
						strValor = Trim(rstInfra.Fields("CODHIDRA").Value)
					End If
				Else
					'Encontrada una coincidencia en la BBDD General
					strValor = Trim(rstInfra.Fields("CODHIDRA").Value)
				End If
			End If
			CierraRS(rstInfra)
			
			'----------------------------------------------------------------------------------------------------------
			'BUSQUEDA EN LA BBDD PASARELA
			'----------------------------------------------------------------------------------------------------------
			If strValor = vbNullString Then
				'No encontrada en la BBDD General. La busco en la BBDD Pasarela, tal y como aparece en Corporate
				'o con el nombre de la variable sin los paréntesis (si los tuviera)
				If InStr(1, arrValor(I), "(") > 0 Then
					'Tiene paréntesis en el nombre
					strSQL = "SELECT * FROM VARIABLES_PA" & " WHERE (DESATRIB='" & arrValor(I) & "'" & " OR DESATRIB='" & Trim(VB.Left(arrValor(I), InStr(1, arrValor(I), "(") - 1)) & "')" & " AND FAMILIA ='" & strFamil & "'"
				Else
					'No tiene paréntesis en el nombre
					strSQL = "SELECT * FROM VARIABLES_PA" & " WHERE DESATRIB='" & arrValor(I) & "'" & " AND FAMILIA ='" & strFamil & "'"
				End If
				rstPasa = mfRecordset(conPasarela, strSQL)
				'Comprobamos si se ha encontrado alguna coincidencia
				If Not rstPasa.EOF Then
					If rstPasa.RecordCount > 1 Then
						'Se han encontrado varias coincidencias, volvemos a realizar la consulta filtrando sólo con el nombre completo
						strSQL = "SELECT * FROM VARIABLES_PA" & " WHERE DESATRIB='" & arrValor(I) & "'" & " AND FAMILIA ='" & strFamil & "'"
						rstPasa = mfRecordset(conPasarela, strSQL)
						'Comprobamos si se ha encontrado alguna coincidencia
						If Not rstPasa.EOF Then
							'Encontrada una coincidencia en la BBDD Pasarela
							strValor = Trim(rstPasa.Fields("CODHIDRA").Value)
						End If
					Else
						'Encontrada una coincidencia en la BBDD Pasarela
						strValor = Trim(rstPasa.Fields("CODHIDRA").Value)
					End If
				End If
				CierraRS(rstPasa)
			End If
			
			If strValor = vbNullString Then
				'No se ha podido encontrar la variable ni en la BBDD General ni en la BBDD Pasarela
				Insertar_Error(Me, "Inserción de variables", "No se ha encontrado la variable " & Replace(arrValor(I), "'", """"), "msInsertaVariablesNOMBRE")
				Mostrar_Error()
				GoTo procFin
			End If
			
			If I = 0 Then
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariablesNOMBRE. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				mfInsertaVariablesNOMBRE = strValor
			Else
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariablesNOMBRE. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				mfInsertaVariablesNOMBRE = mfInsertaVariablesNOMBRE & " " & strValor
			End If
			
		Next I
		
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		
		Insertar_Error(Me, "Inserción de variables", "Ha ocurrido un error no controlado", "msInsertaVariablesNOMBRE")
		Mostrar_Error()
		logError("mfInsertaVariablesNOMBRE - " & Err.Description)
		
		Resume procFin
		
procFin: 
		CierraRS(rstInfra)
		CierraRS(rstPasa)
		'UPGRADE_NOTE: Object rstInfra may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstInfra = Nothing
		'UPGRADE_NOTE: Object rstPasa may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstPasa = Nothing
		
	End Function
	
	'## DS66 18/01/10  Repasa los Plazos de Tipo 1 y los que estan mal pintados (Los que empiezan al principio de la seguiente accion) los salta al la anterior
	Private Sub msResolPlazo1()
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rst1 As ADODB.Recordset
		Dim rstInfo As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim lngNumAcc As Integer
		
		Dim ORD_N1 As Integer
		Dim ORD_N2 As Integer
		Dim ORD_N3 As Integer
		Dim ORD_N4 As Integer
		Dim ORD_N5 As Integer
		Dim strPoss As String
		Dim strPoss2 As String
		
		'se seleccionan solo los casos concreteos en los que Caducar este al principio de la siguiente accion.
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ((PATH_HIDRA like('APE_CADUCARTRAMITE%') AND " & "ORDEN_ACC=1) OR (PATH_HIDRA like('EDP_CADUCARTRAMITE%') AND ORDEN_ACC=2) OR (PATH_HIDRA like('PRO_CADUCARTRAMITE%') AND ORDEN_ACC=3) OR (PATH_HIDRA like('CNL FORM%') AND ORDEN_ACC=4))"
		rst1 = mfRecordset(conPasarela, strSQL)
		
		strPoss = "0-0-0-0-0"
		
		While Not rst1.EOF
			strSeg = rst1.Fields("ORDEN_N1").Value & "/" & rst1.Fields("ORDEN_N2").Value & "/" & rst1.Fields("ORDEN_N3").Value & "/" & rst1.Fields("ORDEN_N4").Value & "/" & rst1.Fields("ORDEN_N5").Value
			strPoss2 = rst1.Fields("ORDEN_N1").Value & "-" & rst1.Fields("ORDEN_N2").Value & "-" & rst1.Fields("ORDEN_N3").Value & "-" & rst1.Fields("ORDEN_N4").Value & "-" & rst1.Fields("ORDEN_N5").Value
			
			If strPoss2 <> strPoss Then
				If rst1.Fields("ORDEN_N1").Value <> 0 And rst1.Fields("ORDEN_N2").Value = 0 Then
					ORD_N1 = rst1.Fields("ORDEN_N1").Value - 1
				Else
					ORD_N1 = rst1.Fields("ORDEN_N1").Value
				End If
				If rst1.Fields("ORDEN_N2").Value <> 0 And rst1.Fields("ORDEN_N3").Value = 0 Then
					ORD_N2 = rst1.Fields("ORDEN_N2").Value - 1
				Else
					ORD_N2 = rst1.Fields("ORDEN_N2").Value
				End If
				If rst1.Fields("ORDEN_N3").Value <> 0 And rst1.Fields("ORDEN_N4").Value = 0 Then
					ORD_N3 = rst1.Fields("ORDEN_N3").Value - 1
				Else
					ORD_N3 = rst1.Fields("ORDEN_N3").Value
				End If
				If rst1.Fields("ORDEN_N4").Value <> 0 And rst1.Fields("ORDEN_N5").Value = 0 Then
					ORD_N4 = rst1.Fields("ORDEN_N4").Value - 1
				Else
					ORD_N4 = rst1.Fields("ORDEN_N4").Value
				End If
				If rst1.Fields("ORDEN_N5").Value <> 0 Then
					ORD_N5 = rst1.Fields("ORDEN_N5").Value - 1
				Else
					ORD_N5 = rst1.Fields("ORDEN_N5").Value
				End If
			End If
			
			strPoss = strPoss2
			
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' "
			''''
			strSQL = strSQL & " and ORDEN_N1=" & ORD_N1
			strSQL = strSQL & " and ORDEN_N2=" & ORD_N2
			strSQL = strSQL & " and ORDEN_N3=" & ORD_N3
			strSQL = strSQL & " and ORDEN_N4=" & ORD_N4
			strSQL = strSQL & " and ORDEN_N5=" & ORD_N5
			strSQL = strSQL & "ORDER BY ORDEN_ACC DESC"
			
			rstAux2 = mfRecordset(conPasarela, strSQL)
			lngNumAcc = rstAux2.Fields("ORDEN_ACC").Value + 1
			
			System.Windows.Forms.Application.DoEvents()
			'Se cactualiza la ubicacion, un paso arriba
			strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & lngNumAcc
			strSQL = strSQL & " ,ORDEN_N1=" & ORD_N1
			strSQL = strSQL & " ,ORDEN_N2=" & ORD_N2
			strSQL = strSQL & " ,ORDEN_N3=" & ORD_N3
			strSQL = strSQL & " ,ORDEN_N4=" & ORD_N4
			strSQL = strSQL & " ,ORDEN_N5=" & ORD_N5
			strSQL = strSQL & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " and ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " and ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " and ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " and ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value & " and PATH_HIDRA='" & rst1.Fields("PATH_HIDRA").Value & "'"
			mfExecute(conPasarela, strSQL)
			
			'Se recupera @CODUTRHN,@ORDENTRA y @USUARIO para actualizarlo despues
			strSQL = "SELECT parametro,valor from param_acc WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_acc=1 AND (parametro='@usuario' or parametro='@ordentra' or parametro='@codutrhn') " & "AND ORDEN_N1=" & ORD_N1 & " and ORDEN_N2=" & ORD_N2 & " and ORDEN_N3=" & ORD_N3 & " and ORDEN_N4=" & ORD_N4 & " and ORDEN_N5=" & ORD_N5 & " order by parametro"
			rstInfo = mfRecordset(conPasarela, strSQL)
			
			'Se actualizan las posiciones de los parametros
			strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & lngNumAcc
			strSQL = strSQL & " ,ORDEN_N1=" & ORD_N1
			strSQL = strSQL & " ,ORDEN_N2=" & ORD_N2
			strSQL = strSQL & " ,ORDEN_N3=" & ORD_N3
			strSQL = strSQL & " ,ORDEN_N4=" & ORD_N4
			strSQL = strSQL & " ,ORDEN_N5=" & ORD_N5
			strSQL = strSQL & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & rst1.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rst1.Fields("ORDEN_N2").Value & " and ORDEN_N3=" & rst1.Fields("ORDEN_N3").Value & " and ORDEN_N4=" & rst1.Fields("ORDEN_N4").Value & " and ORDEN_N5=" & rst1.Fields("ORDEN_N5").Value & " and ORDEN_ACC=" & rst1.Fields("ORDEN_ACC").Value
			mfExecute(conPasarela, strSQL)
			
			
			
			'Se actualizan @CODUTRHN,@ORDENTRA y @USUARIO para que tengan el mismo valor q el resto
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstInfo.Fields("VALOR").Value
			strSQL = strSQL & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & ORD_N1 & " and ORDEN_N2=" & ORD_N2 & " and ORDEN_N3=" & ORD_N3 & " and ORDEN_N4=" & ORD_N4 & " and ORDEN_N5=" & ORD_N5 & " and ORDEN_ACC=" & lngNumAcc & " And Parametro='@CODUTRHN'"
			mfExecute(conPasarela, strSQL)
			rstInfo.MoveNext()
			
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstInfo.Fields("VALOR").Value
			strSQL = strSQL & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & ORD_N1 & " and ORDEN_N2=" & ORD_N2 & " and ORDEN_N3=" & ORD_N3 & " and ORDEN_N4=" & ORD_N4 & " and ORDEN_N5=" & ORD_N5 & " and ORDEN_ACC=" & lngNumAcc & " And Parametro='@ORDENTRA'"
			mfExecute(conPasarela, strSQL)
			rstInfo.MoveNext()
			
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstInfo.Fields("VALOR").Value
			strSQL = strSQL & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and ORDEN_N1=" & ORD_N1 & " and ORDEN_N2=" & ORD_N2 & " and ORDEN_N3=" & ORD_N3 & " and ORDEN_N4=" & ORD_N4 & " and ORDEN_N5=" & ORD_N5 & " and ORDEN_ACC=" & lngNumAcc & " And Parametro='@USUARIO'"
			mfExecute(conPasarela, strSQL)
			
			rst1.MoveNext()
		End While
		GoTo procFin
		
procErr: 
		'para salir si han dado a cancelar
		If blnCancelar = True Then Exit Sub
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Resolucion de Plazo1", "Ha ocurrido un error no controlado", "msResolPlazo1" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("mfInsertaVariables - " & Err.Description)
		Resume procFin
procFin: 
	End Sub
	'## DS66
	
	Private Sub msResolVariables()
		Dim strSQL As String
		Dim rst1 As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rst3 As ADODB.Recordset
		Dim rst4 As ADODB.Recordset
		Dim rst5 As ADODB.Recordset
		Dim rst6 As ADODB.Recordset
		Dim rst7 As ADODB.Recordset
		Dim rst8 As ADODB.Recordset
		Dim rst9 As ADODB.Recordset
		Dim lngLocal As Integer
		Dim strJOINER As String
		Dim strSUSTI As String
		Dim lngNumAcc As Integer
		Dim arr As Object
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim strValorV As String
		Dim strSQL2 As String
		
		
		On Error GoTo procErr
		
		'   strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
		'   strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
		'   strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID "
		'   strSQL = strSQL & "FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_DIAGRAMA='Ramificación' "
		'   strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		
		'Inicio Jonathan Prieto 19/09/2011 - Todos los trámites del procedimiento
		'   '# Modif DS66'''''''''''''para que salgan tambien los tramites de primer nivel'''''''
		'   strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
		'   strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
		'   strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID, NOMBRE, CAT_DIAGRAMA "
		'   strSQL = strSQL & "FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND (CAT_DIAGRAMA='Ramificación' OR (CAT_DIAGRAMA='Trámite' AND ORDEN_N2 = 0))"
		'   strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'   '#'''''''''''''''''''''''''
		
		strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID, NOMBRE, CAT_DIAGRAMA" & " FROM DIAGRAMA" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_DIAGRAMA<>''" & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'Fin Jonathan Prieto 19/09/2011
		
		'''RECORDSET CON TODAS LAS RAMIFICACIONES
		rst1 = mfRecordset(conPasarela, strSQL)
		Dim Sust As String
		While Not rst1.EOF
			
			strSeg = rst1.Fields("ORDEN_N1").Value & "/" & rst1.Fields("ORDEN_N2").Value & "/" & rst1.Fields("ORDEN_N3").Value & "/" & rst1.Fields("ORDEN_N4").Value & "/" & rst1.Fields("ORDEN_N5").Value
			strSQL = "SELECT ID_CONECTOR, DIAGRAMA, NUM, NUM_SEC_DESDE, NUM_SEC_HASTA, DI_ID "
			strSQL = strSQL & "FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "NUM_SEC_HASTA= " & rst1.Fields("NUM_SEQ").Value & " AND "
			strSQL = strSQL & "DIAGRAMA= " & rst1.Fields("ID_PADRE").Value & " AND "
			strSQL = strSQL & "CAT_CONECTOR <> 'Conector Opcional'"
			'RECORDSET CON TODOS LOS CONECTORES DE ENTRADA A LA RAMIFICACIÓN
			rst2 = mfRecordset(conPasarela, strSQL)
			strJOINER = ""
			If Not rst2.EOF Then
				strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
				strSQL = strSQL & "Where J.JO_SEQ=" & rst2.Fields("ID_CONECTOR").Value & " AND "
				strSQL = strSQL & "SH_SEQ_FROM=" & rst2.Fields("NUM_SEC_DESDE").Value & " AND "
				strSQL = strSQL & "SH_SEQ_TO=" & rst2.Fields("NUM_SEC_HASTA").Value & " AND "
				strSQL = strSQL & "DI_ID=" & rst2.Fields("DI_ID").Value & " AND "
				strSQL = strSQL & "DM_INSERTS=1"
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				
				'RECORDSET CON LOS ID DE CONECTORES
				rst3 = mfRecordset(conDP4, strSQL)
				If Not rst3.EOF Then
					strJOINER = strJOINER & rst3.Fields(0).Value & ","
				End If
				'rst2.MoveNext
			End If
			
			If strJOINER <> "" Then
				strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			End If
			If strJOINER <> "" Then
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, "
				strSQL = strSQL & "ENTITY E Where C.CO_ID IN (" & strJOINER & ") AND DM_INSERTS=1 AND "
				strSQL = strSQL & "A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				
				'strSQL = strSQL & " order by C.DM_ID "
				strSQL = strSQL & " order by C.DM_SEQ"
				
				'RECORDSET CON LAS VARIABLES ASOCIADAS AL CONECTOR
				rst4 = mfRecordset(conDP4, strSQL)
				
				If rst4.RecordCount > 0 Then
					''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
					'''''''''''''''''''''''''''''''''''''''''''''''''''''''4 PARAMETROS'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
					''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
					If rst4.RecordCount = 4 Then
						colXML2 = New Collection
						colXML2.Add("Valor")
						
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSUSTI = mfInsertaVariables(rst4.Fields(0).Value, rst4.Fields(1).Value)
						rst4.MoveNext()
						rst4.MoveNext()
						
						colXMLD = mfBuscaXML("Atributo", colXML2, rst4.Fields("AT_ID").Value)
						'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strValorV = colXMLD.Item(1)
						
						If rst1.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 >= " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 >= " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_ACC > 0"
							
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 >= " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N3 >= " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_ACC > 0"
							
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 >= " & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N4 >= " & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_ACC > 0"
							
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL = strSQL & "ORDEN_N5 >= " & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N5 >= " & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > 0"
							
						End If
						mfExecute(conPasarela, strSQL)
						mfExecute(conPasarela, strSQL2)
						'''''
						rst4.MoveNext()
						lngLocal = lngLocal + 1
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSUSTI = mfInsertaVariables(rst4.Fields(0).Value, rst4.Fields(1).Value)
						'DEBEMOS INSERTAR UN INITVAR EL PRIMER TRAMITE DEL PRIMER PROCESO DE LA RAMIFICACION
						'CON @INICIO!LOCALII = @INICIO!VARXX
						If rst1.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 > " & rst1.Fields("ORDEN_N2").Value & " "
							strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 > " & rst1.Fields("ORDEN_N3").Value & " "
							strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 > " & rst1.Fields("ORDEN_N4").Value & " "
							strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 <= " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL = strSQL & "ORDEN_N5 > " & rst1.Fields("ORDEN_N5").Value & " "
							strSQL = strSQL & " order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						rst5 = mfRecordset(conPasarela, strSQL)
						Do While Not rst5.EOF
							If rst5.Fields("EXPLOTA_ACC").Value = "S" Then
								'INSERTAREMOS UNA ACCION LETVAR AL PRINCIPIO DEL PRIMER TRAMITE
								strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC "
								strSQL = strSQL & "FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "ORDEN_N1 = " & rst5.Fields("ORDEN_N1").Value & " AND "
								strSQL = strSQL & "ORDEN_N2 = " & rst5.Fields("ORDEN_N2").Value & " AND "
								strSQL = strSQL & "ORDEN_N3 = " & rst5.Fields("ORDEN_N3").Value & " AND "
								strSQL = strSQL & "ORDEN_N4 = " & rst5.Fields("ORDEN_N4").Value & " AND "
								strSQL = strSQL & "ORDEN_N5 = " & rst5.Fields("ORDEN_N5").Value & " "
								strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC DESC"
								rst6 = mfRecordset(conPasarela, strSQL)
								While Not rst6.EOF
									strSQL = "UPDATE ACCIONES_DI SET "
									strSQL = strSQL & "ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
									strSQL = strSQL & " AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value
									mfExecute(conPasarela, strSQL)
									
									strSQL = "UPDATE PARAM_ACC SET "
									strSQL = strSQL & "ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
									strSQL = strSQL & " AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value
									mfExecute(conPasarela, strSQL)
									rst6.MoveNext()
								End While
								rst6.Close()
								'UPGRADE_NOTE: Object rst6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
								rst6 = Nothing
								strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
								rst6 = mfRecordset(conPasarela, strSQL)
								lngNumAcc = rst6.Fields(0).Value + 1
								
								strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) "
								strSQL = strSQL & "VALUES ('" & gNomProcCorto & "'," & rst5.Fields("ORDEN_N1").Value & ", "
								strSQL = strSQL & rst5.Fields("ORDEN_N2").Value & ", " & rst5.Fields("ORDEN_N3").Value & ", "
								strSQL = strSQL & rst5.Fields("ORDEN_N4").Value & "," & rst5.Fields("ORDEN_N5").Value & ", "
								strSQL = strSQL & "0," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ","
								strSQL = strSQL & "'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
								mfExecute(conPasarela, strSQL)
								blnInserta = False
								'msInsertaParamAcc "@LOCAL" & Format(lngLocal, "00"), "@INICIO!" & strSUSTI, rst5("ORDEN_N1"), rst5("ORDEN_N2"), rst5("ORDEN_N3"), rst5("ORDEN_N4"), rst5("ORDEN_N5"), 0
								msInsertaParamAcc("@INICIO!LOCAL" & VB6.Format(lngLocal, "00"), "@INICIO!" & strSUSTI, rst5.Fields("ORDEN_N1").Value, rst5.Fields("ORDEN_N2").Value, rst5.Fields("ORDEN_N3").Value, rst5.Fields("ORDEN_N4").Value, rst5.Fields("ORDEN_N5").Value, 0)
								blnInserta = True
								rst5.MoveFirst()
								Exit Do
							End If
							rst5.MoveNext()
						Loop 
						
						'REEMPLAZAR TODOS LOS VARXX POR LOCALII DENTRO DE LA RAMIFICACIÓN, ES DECIR, TODOS AQUELLOS
						'CUYO PADRE SEA LA RAMIFICACION Y SU ORDEN_N1 SEA EL MISMO
						If rst1.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO= '" & strSUSTI & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 > " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_ACC > 0"
							
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO= '" & strSUSTI & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 > " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_ACC > 0"
							
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 > " & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_ACC > 0"
							
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL = strSQL & "ORDEN_N5 > " & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > 0"
							
						End If
						mfExecute(conPasarela, strSQL)
						'mfExecute conPasarela, strSQL2
						'''''''''''''''''''''''''
						''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
						'''''''''''''''''''''''''''''''''''''''''''''''''''''''3 PARAMETROS'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
						''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
					ElseIf rst4.RecordCount = 3 Or rst4.RecordCount = 6 Then 
variables: 
						colXML2 = New Collection
						colXML2.Add("Valor")
						
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSUSTI = mfInsertaVariables(rst4.Fields(0).Value, rst4.Fields(1).Value)
						rst4.MoveNext()
						rst4.MoveNext()
						
						colXMLD = mfBuscaXML("Atributo", colXML2, rst4.Fields("AT_ID").Value)
						'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strValorV = colXMLD.Item(1)
						
						'Inicio Jonathan Prieto 22/07/2011
						'Si no ha conseguido el VALOR (constante) del atributo tendrá que ser una variable
						If Trim(strValorV) = vbNullString Then
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = "@INICIO!" & mfInsertaVariables(rst4.Fields(0).Value, rst4.Fields(1).Value)
						End If
						'Fin Jonathan Prieto 22/07/2011
						
						If rst1.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 >= " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 >= " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_ACC > 0"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 >= " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N3 >= " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_ACC > 0"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 >= " & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N4 >= " & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_ACC > 0"
							
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "VALOR=Replace(VALOR, '@INICIO!" & strSUSTI & "', '" & strValorV & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "'  AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL = strSQL & "ORDEN_N5 >= " & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > 0"
							
							strSQL2 = "UPDATE PARAM_ACC SET "
							strSQL2 = strSQL2 & "VALOR=Replace(VALOR, '@INICIO!CODIGODOCUMENTOEMITIDO', '" & strValorV & "') "
							strSQL2 = strSQL2 & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL2 = strSQL2 & "ORDEN_N5 >= " & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > 0"
						End If
						
						mfExecute(conPasarela, strSQL)
						mfExecute(conPasarela, strSQL2)
						If rst4.RecordCount = 6 Then
							If rst4.RecordCount > rst4.AbsolutePosition Then
								rst4.MoveNext()
								GoTo variables
							End If
						End If
					ElseIf rst4.RecordCount = 1 Then 
						'''''''''''''''''''''''''
						lngLocal = lngLocal + 1
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strSUSTI = mfInsertaVariables(rst4.Fields(0).Value, rst4.Fields(1).Value)
						'DEBEMOS INSERTAR UN INITVAR EL PRIMER TRAMITE DEL PRIMER PROCESO DE LA RAMIFICACION
						'CON @INICIO!LOCALII = @INICIO!VARXX
						If rst1.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 > " & rst1.Fields("ORDEN_N2").Value & " "
							strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 > " & rst1.Fields("ORDEN_N3").Value & " "
							strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 > " & rst1.Fields("ORDEN_N4").Value & " "
							strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 <= " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL = strSQL & "ORDEN_N5 > " & rst1.Fields("ORDEN_N5").Value & " "
							strSQL = strSQL & " order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						
						'# Modif DS66''''''''''''''''''''
						If rst1.Fields("CAT_DIAGRAMA").Value = "Trámite" Then
							strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, "
							strSQL = strSQL & "ID_DIAG_N1, ID_DIAG_N2, ID_DIAG_N3, ID_DIAG_N4, ID_DIAG_N5, "
							strSQL = strSQL & "ID_DIAGRAMA , ID_PADRE, NUM_DIAGRAMA,EXPLOTA_ACC, NUM_SEQ, DI_ID FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
							strSQL = strSQL & "ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = 0"
							strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						'#'''''''''''''
						rst5 = mfRecordset(conPasarela, strSQL)
						Do While Not rst5.EOF
							If rst5.Fields("EXPLOTA_ACC").Value = "S" Then
								'INSERTAREMOS UNA ACCION LETVAR AL PRINCIPIO DEL PRIMER TRAMITE
								strSQL = "SELECT ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC "
								strSQL = strSQL & "FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "ORDEN_N1 = " & rst5.Fields("ORDEN_N1").Value & " AND "
								strSQL = strSQL & "ORDEN_N2 = " & rst5.Fields("ORDEN_N2").Value & " AND "
								strSQL = strSQL & "ORDEN_N3 = " & rst5.Fields("ORDEN_N3").Value & " AND "
								strSQL = strSQL & "ORDEN_N4 = " & rst5.Fields("ORDEN_N4").Value & " AND "
								strSQL = strSQL & "ORDEN_N5 = " & rst5.Fields("ORDEN_N5").Value & " "
								strSQL = strSQL & "order by ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5, ORDEN_ACC DESC"
								rst6 = mfRecordset(conPasarela, strSQL)
								While Not rst6.EOF
									strSQL = "UPDATE ACCIONES_DI SET "
									strSQL = strSQL & "ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
									strSQL = strSQL & " AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value
									mfExecute(conPasarela, strSQL)
									
									strSQL = "UPDATE PARAM_ACC SET "
									strSQL = strSQL & "ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value + 1 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
									strSQL = strSQL & "ORDEN_N1=" & rst6.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2=" & rst6.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3=" & rst6.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4=" & rst6.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5=" & rst6.Fields("ORDEN_N5").Value
									strSQL = strSQL & " AND ORDEN_ACC=" & rst6.Fields("ORDEN_ACC").Value
									mfExecute(conPasarela, strSQL)
									rst6.MoveNext()
								End While
								rst6.Close()
								'UPGRADE_NOTE: Object rst6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
								rst6 = Nothing
								strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='LET INICIALIZACIONVAR'"
								rst6 = mfRecordset(conPasarela, strSQL)
								lngNumAcc = rst6.Fields(0).Value + 1
								
								strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION, PATH_HIDRA) "
								strSQL = strSQL & "VALUES ('" & gNomProcCorto & "'," & rst5.Fields("ORDEN_N1").Value & ", "
								strSQL = strSQL & rst5.Fields("ORDEN_N2").Value & ", " & rst5.Fields("ORDEN_N3").Value & ", "
								strSQL = strSQL & rst5.Fields("ORDEN_N4").Value & "," & rst5.Fields("ORDEN_N5").Value & ", "
								strSQL = strSQL & "0," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ","
								strSQL = strSQL & "'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
								mfExecute(conPasarela, strSQL)
								blnInserta = False
								'msInsertaParamAcc "@INICIO!LOCAL" & Format(lngLocal, "00"), "@INICIO!" & strSUSTI, rst5("ORDEN_N1"), rst5("ORDEN_N2"), rst5("ORDEN_N3"), rst5("ORDEN_N4"), rst5("ORDEN_N5"), 0
								msInsertaParamAcc("@LOCAL" & VB6.Format(lngLocal, "00"), "@INICIO!" & strSUSTI, rst5.Fields("ORDEN_N1").Value, rst5.Fields("ORDEN_N2").Value, rst5.Fields("ORDEN_N3").Value, rst5.Fields("ORDEN_N4").Value, rst5.Fields("ORDEN_N5").Value, 0)
								blnInserta = True
								rst5.MoveFirst()
								Exit Do
							End If
							rst5.MoveNext()
						Loop 
						
						'REEMPLAZAR TODOS LOS VARXX POR LOCALII DENTRO DE LA RAMIFICACIÓN, ES DECIR, TODOS AQUELLOS
						'CUYO PADRE SEA LA RAMIFICACION Y SU ORDEN_N1 SEA EL MISMO
						If rst1.Fields("NUM_DIAGRAMA").Value = 1 Then
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "'), "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							'strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO= '" & strSUSTI & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1") & " AND "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 > " & rst1.Fields("ORDEN_N2").Value & " AND ORDEN_ACC > 0"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 2 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "'), "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							'strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO= '" & strSUSTI & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1") & " AND "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 > " & rst1.Fields("ORDEN_N3").Value & " AND ORDEN_ACC > 0"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 3 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "'), "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							'strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO= '" & strSUSTI & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1") & " AND "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 > " & rst1.Fields("ORDEN_N4").Value & " AND ORDEN_ACC > 0"
						ElseIf rst1.Fields("NUM_DIAGRAMA").Value = 4 Then 
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "'), "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							'strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO= '" & strSUSTI & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1") & " AND "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = " & rst1.Fields("ORDEN_N2").Value & " AND "
							strSQL = strSQL & "ORDEN_N3 = " & rst1.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4 = " & rst1.Fields("ORDEN_N4").Value & " AND "
							strSQL = strSQL & "ORDEN_N5 > " & rst1.Fields("ORDEN_N5").Value & " AND ORDEN_ACC > 0"
						End If
						'Inicio Jonathan Prieto 11/02/2011: estaba mal, reemplazando todas las que contengan el texto
						'Ej: reemplazar por LOCAL01 las que contengan VAR39, si era VAR397 dejaba como resultado LOCAL017
						strSQL = strSQL & " AND VALOR LIKE '%" & strSUSTI & "'"
						'Fin Jonathan Prieto 11/02/2011
						'# Modif DS66''''''''''''''''''''
						If rst1.Fields("CAT_DIAGRAMA").Value = "Trámite" Then
							
							strSQL = "SELECT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' and PARAMETRO = '@" & strSUSTI & "'"
							rst9 = mfRecordset(conPasarela, strSQL)
							If Not rst9.EOF Then
								Sust = rst9.Fields("VALOR").Value
								If InStr(1, Sust, "!") <> 0 Then
									strSUSTI = Split(Sust, "!", 2, CompareMethod.Text)(1)
								End If
							End If
							
							strSQL = "UPDATE PARAM_ACC SET "
							strSQL = strSQL & "PARAMETRO=Replace(PARAMETRO, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "'), "
							strSQL = strSQL & "VALOR=Replace(VALOR, '" & strSUSTI & "', 'LOCAL" & VB6.Format(lngLocal, "00") & "') "
							strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 = " & rst1.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2 = 0 AND ORDEN_ACC > 0"
						End If
						'#''''''''''''''''''''''''''''
						
						mfExecute(conPasarela, strSQL)
						'''''''''''''''''''''''''
					End If
					
				End If
			End If
			CierraRS(rst2)
			CierraRS(rst3)
			CierraRS(rst4)
			CierraRS(rst5)
			CierraRS(rst6)
			rst1.MoveNext()
		End While
		CierraRS(rst1)
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Resolución Variables Locales", "Ha ocurrido un error no controlado", "msResolVariables" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("mfInsertaVariables - " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	
	
	
	Private Sub msJumpsNoDetectados()
		On Error GoTo procErr
		Dim sql As String
		Dim rst1 As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rst3 As ADODB.Recordset
		Dim nomTramS As String
		Dim lngNumAcc As Integer
		Dim lngOR As Integer
		
		sql = "select * from diagrama where PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n2=0 and salidas > 1"
		rst1 = mfRecordset(conPasarela, sql)
		While Not rst1.EOF
			strSeg = rst1.Fields("ORDEN_N1").Value & "/" & rst1.Fields("ORDEN_N2").Value & "/" & rst1.Fields("ORDEN_N3").Value & "/" & rst1.Fields("ORDEN_N4").Value & "/" & rst1.Fields("ORDEN_N5").Value
			sql = "select * from diagrama where PROCEDIMIENTO='" & gNomProcCorto & "' AND num_diagrama=1 and num_seq in ("
			sql = sql & " select num_sec_hasta from conectores_di where PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rst1.Fields("DI_ID").Value
			sql = sql & " AND NUM_SEC_DESDE=" & rst1.Fields("NUM_SEQ").Value & " and"
			sql = sql & " cat_conector='' and num_sec_hasta not in ("
			sql = sql & " select num_Seq from diagrama where PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n1 in ("
			'aketza 4/9/2006
			'Vuelvo a cambiar porque daba error ('se termino el tiempo de espera')
			'sql = sql & " select orden_n1 from propiedades_di where nom_diagrama in"
			sql = sql & " select orden_n1 from propiedades_di where PROCEDIMIENTO='" & gNomProcCorto & "' AND nom_diagrama in"
			'fin aketza
			sql = sql & " (select distinct VALOR from param_acc where PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n1=" & rst1.Fields("ORDEN_N1").Value & " and "
			sql = sql & " SUBSTRING(valor,1,3) = 'PR_')) and orden_n2=0))"
			rst2 = mfRecordset(conPasarela, sql)
			
			If rst2.RecordCount > 0 Then
				sql = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst2.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst2.Fields("ORDEN_N5").Value
				rst3 = mfRecordset(conPasarela, sql)
				If Not rst3.EOF Then
					nomTramS = rst3.Fields("NOM_DIAGRAMA").Value
				End If
				
				If nomTramS = "" Then
					If rst3.Fields("ORDEN_N2").Value = 0 Then
						sql = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rst3.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					ElseIf rst3.Fields("ORDEN_N3").Value = 0 Then 
						sql = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst3.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rst3.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					ElseIf rst3.Fields("ORDEN_N4").Value = 0 Then 
						sql = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst3.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst3.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rst3.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					ElseIf rst3.Fields("ORDEN_N5").Value = 0 Then 
						sql = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst3.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rst3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst3.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rst3.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
					End If
					rst3 = mfRecordset(conPasarela, sql)
					Do While Not rst3.EOF
						If rst3.Fields("NOM_DIAGRAMA").Value <> "" Then
							nomTramS = rst3.Fields("NOM_DIAGRAMA").Value
							Exit Do
						End If
						rst3.MoveNext()
						nomTramS = "PR_FINEXPEDIENTE"
					Loop 
				End If
				sql = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rst3 = mfRecordset(conPasarela, sql)
				lngNumAcc = Val(rst3.Fields(0).Value & "") + 1
				sql = "SELECT max(orden_Acc) from acciones_di where PROCEDIMIENTO='" & gNomProcCorto & "' AND orden_n1 = " & rst1.Fields("ORDEN_N1").Value & " and orden_n2 =" & rst1.Fields("ORDEN_N2").Value & " and orden_n3=" & rst1.Fields("ORDEN_N3").Value & " and orden_n4=" & rst1.Fields("ORDEN_N4").Value & " and orden_n5=" & rst1.Fields("ORDEN_N5").Value
				rst3 = mfRecordset(conPasarela, sql)
				
				'****????¿¿¿¿****
				'Daba un error cuando rst3(0) es nulo, ya que lo asignaba directamente a la variable
				'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
				If IsDbNull(rst3.Fields(0).Value) Then
					lngOR = 1
				Else
					lngOR = rst3.Fields(0).Value + 1
				End If
				sql = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5,ORDEN_ACC,NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1.Fields("ORDEN_N1").Value & ", " & rst1.Fields("ORDEN_N2").Value & ", " & rst1.Fields("ORDEN_N3").Value & "," & rst1.Fields("ORDEN_N4").Value & "," & rst1.Fields("ORDEN_N5").Value & "," & lngOR & ",'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, sql)
				msInsertaParamAcc("PATH", nomTramS, rst1.Fields("ORDEN_N1").Value, rst1.Fields("ORDEN_N2").Value, rst1.Fields("ORDEN_N3").Value, rst1.Fields("ORDEN_N4").Value, rst1.Fields("ORDEN_N5").Value, lngOR)
			End If
			rst1.MoveNext()
		End While
		
		
		Exit Sub
		
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Resolución Jumps", "Ha ocurrido un error no controlado al solucionar los jumps", "msJumpNoDetectados" & " -" & strSeg)
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msJumpsNoDetectados - " & Err.Description)
		
		
	End Sub
	
	
	
	
	
	
	
	
	
	Private Function fIntroCampoOb(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer) As Boolean
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstACC2 As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim I As Integer
		Dim blnPrim As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim lngUlt As Integer
		Dim blnIndValVar As Boolean
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		fIntroCampoOb = True
		If Not rstparamHN.EOF Then rstparamHN.MoveFirst()
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID "
			strSQL = strSQL & "FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_DELETES=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = strJOINER & rstConS.Fields(0).Value & ","
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
			'strSQL = "SELECT A.AT_ID, A.AT_NAME, E.EN_NAME FROM " _
			'& "ATTRIBUTE A, JOINER J, ENTITY E " _
			'& "WHERE A.AT_ID IN ( select C.AT_ID " _
			'& "FROM JOINER J, CW_DATA_USAGE C " _
			'& "Where J.ANO_ID in (" & strJoiner & ") AND " _
			'& "C.CO_ID=J.ANO_ID AND DM_DELETES=1) AND " _
			'& " J.ANO_ID IN (" & strJoiner & ") AND E.EN_ID = A.EN_ID"
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID IN (" & strJOINER & ") AND DM_DELETES=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID  "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL)
			lngAccConS = rstParamCMS.RecordCount
		Else
			rstAux.MoveFirst()
			strSQL = "select DISTINCT J.ANO_ID "
			strSQL = strSQL & "FROM JOINER J "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			rstConS = mfRecordset(conDP4, strSQL)
			rstParamCMS = rstParCMS
			lngAccConS = rstParamCMS.RecordCount
		End If
		rstAux.Close()
		
		'Parámetros conector de entrada
		strJOINER = ""
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		lngAnt = 0
		blnPrim = True
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID "
			strSQL = strSQL & "FROM JOINER J, CW_DATA_USAGE C "
			strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
			strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
			strSQL = strSQL & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
			strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND "
			strSQL = strSQL & "C.CO_ID=J.ANO_ID AND DM_INSERTS=1"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				'*strJoiner = strJoiner & rstConE(0) & ","
				strJOINER = rstconE.Fields(0).Value
vuelta: 
				
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			Else
				strSQL = "select DISTINCT J.ANO_ID "
				strSQL = strSQL & "FROM JOINER J "
				strSQL = strSQL & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND "
				strSQL = strSQL & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND "
				strSQL = strSQL & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND "
				strSQL = strSQL & "DI_ID=" & rstAcc.Fields("DI_ID").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
				rstconE = mfRecordset(conDP4, strSQL)
				GoTo vuelta
			End If
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> rstparamCME.RecordCount Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fIntro_Campob")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fIntroCampoOb = False
					Exit Function
				End If
				
			End If
			System.Windows.Forms.Application.DoEvents()
			lngAnt = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		If Not strJOINER = "" Then
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E Where C.CO_ID IN (" & strJOINER & ") AND DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID"
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
		Else
			rstparamCME = rstParCME
		End If
		I = 0
		If rstparamCME.RecordCount = 0 Then
			rstparamCME = rstParCME
		End If
		If rstParamCMS.RecordCount = 0 Then
			rstParamCMS = rstParCMS
		End If
		colXML4 = New Collection
		System.Windows.Forms.Application.DoEvents()
		colXML4.Add("Código Literal 1")
		colXML4.Add("Código Literal 2")
		colXML4.Add("Indicador Valor Variable")
		If Not rstconE Is Nothing Then
			colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
			'Inicio Jonathan Prieto 30/08/2011
			'blnIndValVar = CBool(colXMLD(2) = "1")
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			If colXMLD.Item(2) <> vbNullString Then
				'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
			End If
			'Fin Jonathan Prieto 30/08/2011
			colXMLD.Remove(3)
			For	Each icol In colXMLD
				'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				If icol <> "" Then
					'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
					msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
					rstparamHN.MoveNext()
					I = I + 1
				End If
			Next icol
		End If
		
		Do While Not rstparamHN.EOF
			If InStr(1, rstparamHN.Fields("PARAM").Value, "LITERAL") <> 0 Then
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstparamHN.MoveNext()
				I = I + 1
			Else
				Exit Do
			End If
		Loop 
		
		If rstparamCME.RecordCount > 0 Then rstparamCME.MoveFirst()
		If Not rstparamCME.EOF Then
			While Not rstparamCME.EOF
				Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
					Case "Constantes"
						colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
						'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strValorV = colXMLD.Item(1)
						If strValorV = "" Then
							'aketza errores
							Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fIntro_Campob")
							'mostramos el btn y el lbl
							Mostrar_Error()
							'fin aketza
						Else
							'curso ccc
							If strValorV = "1" Then
								strValorV = "S"
							Else
								If strValorV = "" Then
									strValorV = "N"
								End If
							End If
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							I = I + 1
						End If
					Case ""
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						I = I + 1
					Case Else
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						I = I + 1
				End Select
				rstparamHN.MoveNext()
				rstparamCME.MoveNext()
			End While
		End If
		If rstparamHN.Fields("PARAM").Value = "@NOREQUERIDO" Then
			rstParCME.MoveNext()
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "N", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
			rstparamHN.MoveNext()
			lngacc = lngacc - 1
		End If
		
		j = 0
		If lngAccConS <> 0 Then
			If lngAccCMS = lngAccConS Then
				While Not rstParamCMS.EOF
					Select Case rstParamCMS.Fields("EN_NAME").Value
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fIntro_Campob")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
								j = j + 1
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							j = j + 1
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							j = j + 1
					End Select
					rstParamCMS.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fIntro_Campob")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fIntroCampoOb = False
				Exit Function
			End If
		Else
			If Not rstParCMS.EOF Then rstParCMS.MoveFirst()
			While Not rstParCMS.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCMS.MoveNext()
				rstparamHN.MoveNext()
				j = j + 1
			End While
		End If
		If lngacc <> j + I Then
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fIntro_Campob")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			fIntroCampoOb = False
			Exit Function
		End If
		
		If lngacc = 0 Then
			msInsertaParamAcc("", "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
		End If
		
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM "
				strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
				strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND "
				strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
				strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
				strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							strSQL = "SELECT A.EV_ID FROM "
							strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
							strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND "
							strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
							strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " and E.ANO_TABNR=8953"
							' **** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							strSQL = strSQL & "ORDER BY D.SH_Y DESC"
							
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
										If nomTramS = "" Then
											If rstAux2.Fields("ORDEN_N2").Value = 0 Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											Do While Not rstAux2.EOF
												If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Exit Do
												End If
												rstAux2.MoveNext()
												nomTramS = "PR_FINEXPEDIENTE"
											Loop 
										End If
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									'GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									strSQL = "SELECT A.EV_ID FROM "
									strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
									strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=9097 AND "
									strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
									strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
									strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
									strSQL = strSQL & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value
									' **** NUEVO SD ENERO'08
									strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
									strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            End If
				'fin aketza
				rstAux.MoveFirst()
				'aketza 29/04/2008
				'If Trim(UCase(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If Trim(UCase(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or Trim(UCase(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or Trim(UCase(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
				Else
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
		End If
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Function
		If blnParar = True Then Exit Function
		If rstparamHN.EOF Then
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas en Corporate no coincide con el número de variables de HidraNet", "fIntro_Campob")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			fIntroCampoOb = False
		Else
			'aketza errores
			Insertar_Error(Me, "Introducción de datos", "Ha ocurrido un error no controlado en la acción " & rstAcc.Fields("ID_ACCION").Value & "-" & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fIntro_Campob")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
			logError("fIntroCampoOb - " & Err.Description)
		End If
		Resume procFin
procFin: 
		
	End Function
	
	Private Sub msAcusRecTele(ByVal rstTram As ADODB.Recordset)
		On Error GoTo procErr
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		Dim rstTram2 As ADODB.Recordset
		'## DS66 05/02/09
		Dim rst1 As ADODB.Recordset
		Dim rst2 As ADODB.Recordset
		Dim rst3 As ADODB.Recordset
		Dim rst4 As ADODB.Recordset
		Dim strJOINER As String
		'###
		Dim strPath As String
		Dim strPath2 As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		
		strSQL = "SELECT * FROM ACCIONES WHERE DESACCHN = 'GENDETACUSEREC'"
		rstAcc = mfRecordset(conInfra, strSQL)
		If Not rstAcc.EOF Then
			strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC<>999"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngORACC = Val(rstAux.Fields(0).Value & "") + 1
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI " & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='GENDETACUSEREC'"
			
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			strPath = "APE_" & Mid("GENDETACUSEREC", 1, 19) & VB6.Format(lngNumAcc, "00")
			
			'insertamos campo procedimiento (aketza)
			strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA, TIPO_ACCION) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'GENDETACUSEREC'," & lngNumAcc & "," & "'" & strPath & "','" & rstAcc.Fields("INDTIPOA").Value & "')"
			mfExecute(conPasarela, strSQL)
			blnInserta = True
			
			'## DS66 05/02/09 -- Busca variables Locales
			strSQL = "SELECT * "
			strSQL = strSQL & "FROM DIAGRAMA "
			strSQL = strSQL & "WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & " ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=0" & " AND ORDEN_N3=0" & " AND ORDEN_N4=0" & " AND ORDEN_N5=0"
			rst1 = mfRecordset(conPasarela, strSQL)
			While Not rst1.EOF
				strSQL = "SELECT ID_CONECTOR, DIAGRAMA, NUM, NUM_SEC_DESDE, NUM_SEC_HASTA, DI_ID "
				strSQL = strSQL & "FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "NUM_SEC_HASTA= " & rst1.Fields("NUM_SEQ").Value & " AND "
				strSQL = strSQL & "DIAGRAMA= " & rst1.Fields("ID_PADRE").Value '& " AND "
				'strSQL = strSQL & "CAT_CONECTOR <> 'Conector Opcional'"
				'RECORDSET CON TODOS LOS CONECTORES DE ENTRADA A LA RAMIFICACIÓN
				rst2 = mfRecordset(conPasarela, strSQL)
				strJOINER = ""
				
				If Not rst2.EOF Then
					strSQL = "select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
					strSQL = strSQL & "Where J.JO_SEQ=" & rst2.Fields("ID_CONECTOR").Value & " AND "
					strSQL = strSQL & "SH_SEQ_FROM=" & rst2.Fields("NUM_SEC_DESDE").Value & " AND "
					strSQL = strSQL & "SH_SEQ_TO=" & rst2.Fields("NUM_SEC_HASTA").Value & " AND "
					strSQL = strSQL & "DI_ID=" & rst2.Fields("DI_ID").Value & " AND "
					strSQL = strSQL & "DM_INSERTS=1"
					strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					
					'RECORDSET CON LOS ID DE CONECTORES
					rst3 = mfRecordset(conDP4, strSQL)
					If Not rst3.EOF Then
						strJOINER = strJOINER & rst3.Fields(0).Value & ","
					End If
				End If
				
				If strJOINER <> "" Then
					strJOINER = Mid(strJOINER, 1, Len(strJOINER) - 1)
				End If
				If strJOINER <> "" Then
					strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, "
					strSQL = strSQL & "ENTITY E Where C.CO_ID IN (" & strJOINER & ") AND DM_INSERTS=1 AND "
					strSQL = strSQL & "A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " order by C.DM_SEQ"
					
					'RECORDSET CON LAS VARIABLES ASOCIADAS AL CONECTOR
					rst4 = mfRecordset(conDP4, strSQL)
				End If
				rst1.MoveNext()
			End While
			If Not rst4 Is Nothing Then
				If rst4.RecordCount > 0 Then ' Dependiendo si hay variables locales o no
					msInsertaParamAcc("@CODDOCUM", rst4.Fields("AT_NAME").Value, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC, True)
				Else
					msInsertaParamAcc("@CODDOCUM", "@INICIO!CODIGODOCUMENTOEMITIDO", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				End If
			Else
				msInsertaParamAcc("@CODDOCUM", "@INICIO!CODIGODOCUMENTOEMITIDO", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
			End If
			
			
			'msInsertaParamAcc "@CODDOCUM", "@INICIO!CODIGODOCUMENTOEMITIDO", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC
			'msInsertaParamAcc "@CODDOCUM", "identificativo documento", rstTram("ORDEN_N1"), rstTram("ORDEN_N2"), rstTram("ORDEN_N3"), rstTram("ORDEN_N4"), rstTram("ORDEN_N5"), lngORACC, True
			
			'##
			
			blnInserta = False
			
			lngORACC = lngORACC + 1
			
			strPath = "EDP_" & Mid("GENDETACUSEREC", 1, 19) & VB6.Format(lngNumAcc, "00")
			'insertamos campo procedimiento (aketza)
			strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'ENDPROC'," & lngNumAcc & "," & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			lngORACC = lngORACC + 1
			strPath = "PRO_" & Mid("GENDETACUSEREC", 1, 19) & VB6.Format(lngNumAcc, "00")
			
			'insertamos campo procedimiento (aketza)
			strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION," & "PATH_HIDRA) VALUES (" & "'" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'PROCESS'," & lngNumAcc & "," & "'" & strPath & "')"
			mfExecute(conPasarela, strSQL)
			
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " And orden_acc = " & lngORACC - 2
			mfExecute(conPasarela, strSQL)
			
		Else
			'aketza errores
			Insertar_Error(Me, "Lectura de acciones de trámite", "La acción  GENDETACUSEREC no se encuentra en la tabla de conversión", "msAcusRecTele")
			'mostramos el btn y el lbl
			Mostrar_Error()
			'fin aketza
		End If
		
		GoTo procFin
procErr: 
		'para salir si han dado a cancelar (aketza)
		If blnCancelar = True Then Exit Sub
		
		If blnParar = True Then Exit Sub
		'aketza errores
		Insertar_Error(Me, "Acuse de recibo telemático", "Ha ocurrido un error no controlado", "msAcusRecTele")
		'mostramos el btn y el lbl
		Mostrar_Error()
		'fin aketza
		logError("msVBResp2 - " & Err.Description)
		Resume procFin
procFin: 
		
	End Sub
	
	
	
	
	
	Private Function logTiempos(ByRef Texto As String) As Object
		On Error Resume Next
		Dim nFnum As Integer ' -- Número para el fichero log
		Dim cSource As String ' -- Cadena con el tipo de origen de error
		
		''    nFnum = FreeFile()
		''    Open App.Path & "\logTiempos.log" For Append As nFnum
		''    Print #nFnum, Texto
		''    Close #nFnum
	End Function
	
	
	Private Function formatGTC(ByVal Tiempo As Integer) As String
		Dim sekgesamt As Single
		Dim std As Single
		Dim Min As Single
		Dim Sek As Single
		sekgesamt = Tiempo \ 1000
		std = (sekgesamt \ 3600)
		Min = (sekgesamt - (std * 3600)) \ 60
		Sek = (sekgesamt - (std * 3600) - (Min * 60))
		formatGTC = CStr(VB6.Format(std, "00") & ":" & VB6.Format(Min, "00") & ":" & VB6.Format(Sek, "00")) & "----" & Tiempo
		
	End Function
	
	Private Sub frmProceso_Load(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles MyBase.Load
		On Error GoTo Err_Renamed
		Me.Top = 0
		Me.Left = 0
		mdiAncho = VB6.PixelsToTwipsX(Me.Width) + 100
		mdiAlto = VB6.PixelsToTwipsY(Me.Height) + 400
		'aketza minimizado
		bMinimizado = False
		'fin aketza
		'If frmMDI.WindowState <> 0 Then
		frmMDI.Width = VB6.TwipsToPixelsX(mdiAncho)
		frmMDI.Height = VB6.TwipsToPixelsY(mdiAlto)
		'End If
		'aketza minimizado
MINIMI: 
		bMinimizado = True
		'fin aketza
		frmMDI.Icon = Me.Icon
		frmMDI.Text = Me.Text
		If strFechaProgramada <> "" Then
			cerrarConexiones()
			Me.cmdForzar.Visible = False
			'UPGRADE_WARNING: DateDiff behavior may be different. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6B38EC3F-686D-4B2E-B5A5-9E8E7A762E32"'
			strdif = DateDiff(Microsoft.VisualBasic.DateInterval.Second, CDate(VB6.Format(Now, "dd/mm/yyyy hh:mm:ss")), CDate(VB6.Format(strFechaProgramada, "dd/mm/yyyy hh:mm")))
			Me.lblMensaje.Text = "El proceso comenzará en " & FormatoHoras(strdif)
			Me.tmrProg.Interval = 1000
		Else
			Me.tmrProg.Interval = 1
		End If
		'------ If puesto por aketza para cargar el timer solo la primera vez
		If intTimer <> 1 Then
			Me.tmrProg.Enabled = True
			intTimer = 1
		End If
		
		Exit Sub
Err_Renamed: 
		GoTo MINIMI
		
	End Sub
	
	Private Sub tmrProg_Tick(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles tmrProg.Tick
		If strFechaProgramada <> "" Then
			If CDate(strFechaProgramada) < Now Then
				Me.tmrProg.Enabled = False
				'aketza 17/04/2008
				strFechaProgramada = ""
				'fin aketza
				arrancarConexiones()
				msPasarProcedimientos()
			Else
				'UPGRADE_WARNING: DateDiff behavior may be different. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6B38EC3F-686D-4B2E-B5A5-9E8E7A762E32"'
				strdif = DateDiff(Microsoft.VisualBasic.DateInterval.Second, CDate(VB6.Format(Now, "dd/mm/yyyy hh:mm:ss")), CDate(VB6.Format(strFechaProgramada, "dd/mm/yyyy hh:mm")))
				Me.lblMensaje.Text = "El proceso comenzará en " & FormatoHoras(strdif)
			End If
		Else
			Me.tmrProg.Enabled = False
			msPasarProcedimientos()
		End If
	End Sub
	Private Function FormatoHoras(ByRef Segundos As Integer) As String
		Dim Minuto, Hora, Segundo As Integer
		Dim Tiempo As Single
		Tiempo = Segundos
		'Separa el tiempo en horas, minutos y segundos
		Hora = Int(Tiempo / 3600)
		Minuto = Int((Tiempo - Hora * 3600) / 60)
		Segundo = Tiempo - Hora * 3600 - Minuto * 60
		'Formatea el tiempo como cadena
		FormatoHoras = VB6.Format(Hora, "00") & "h, " & VB6.Format(Minuto, "00") & "m, " & VB6.Format(Segundo, "00") & "s"
	End Function
	Private Sub msPasarProcedimientos()
		Dim rstProcPend As New ADODB.Recordset
		Dim rstError As New ADODB.Recordset
		Dim arrCol(3) As Object
		Dim sSQL As String
		'Inicio Jonathan Prieto 07/06/2011
		Dim objValidaciones As New clsValidaciones
		'Inicio Jonathan Prieto 07/06/2011
		'Inicio Jonathan Prieto 12/12/2013
		Dim rstAux As New ADODB.Recordset
		
		On Error GoTo procErr
		
		'Obtengo la variable 'Vacio' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB='Vacio'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarVacio = rstAux.Fields("CODHIDRA").Value
		End If
		'Obtengo la variable 'Asunto Delegación' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB='Asunto Delegación'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarAsuntoDelegacion = rstAux.Fields("CODHIDRA").Value
		End If
		'Obtengo la variable 'Indicador Primer Visto Bueno' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB='Indicador Primer Visto Bueno'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarIndPrimerVB = rstAux.Fields("CODHIDRA").Value
		End If
		'Obtengo la variable 'Indicador Último VºBº/Firma' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB='Indicador Último VºBº/Firma'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarIndUltimoVB = rstAux.Fields("CODHIDRA").Value
		End If
		'Obtengo la variable 'Indicador Visto Bueno' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB='Indicador Visto Bueno'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarIndVB = rstAux.Fields("CODHIDRA").Value
		End If
		'Obtengo la variable 'Último Documento Visto Bueno' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB='Último Documento Visto Bueno'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarUltimoDocVB = rstAux.Fields("CODHIDRA").Value
		End If
		'Obtengo la variable 'Indicador Notificación Presencial' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB='Indicador Notificación Presencial'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarNotifPresencial = rstAux.Fields("CODHIDRA").Value
		End If
		'Obtenemos la variable 'Código Circuito' para la aplicación
		sSQL = "SELECT CODHIDRA FROM VARIABLES WHERE DESATRIB = 'Código Circuito'"
		rstAux = mfRecordset(conInfra, sSQL)
		If Not rstAux.EOF Then
			strVarIDCircuito = rstAux.Fields("CODHIDRA").Value
		End If
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'Fin Jonathan Prieto 12/12/2013
		
		'msSolucionJumps (True)
		'UPGRADE_WARNING: Screen property Screen.MousePointer has a new behavior. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6BA9B8D2-2A32-4B6E-8D36-44949974A5B4"'
		System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.WaitCursor
		Me.Enabled = True
		conPasarela.Close()
		'UPGRADE_NOTE: Object conPasarela may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conPasarela = Nothing
		conPasarela = New ADODB.Connection
		ComprobarConexion(conPasarela, ReadIniFile(INIFile, "PASARELA", "Connection"))
		conDP4.Close()
		'UPGRADE_NOTE: Object conDP4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conDP4 = Nothing
		conDP4 = New ADODB.Connection
		ComprobarConexion(conDP4, ReadIniFile(INIFile, "SQLMODELO", "Connection"))
		'UPGRADE_NOTE: Object conDB2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conDB2 = Nothing
		conDB2 = New ADODB.Connection
		ComprobarConexion(conDB2, ReadIniFile(INIFile, "DB2", "Connection"))
		conInfra.Close()
		'UPGRADE_NOTE: Object conInfra may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conInfra = Nothing
		conInfra = New ADODB.Connection
		ComprobarConexion(conInfra, ReadIniFile(INIFile, "GENERALAPLICACION" & strFamil, "Connection"))
		conEspe.Close()
		'UPGRADE_NOTE: Object conEspe may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conEspe = Nothing
		conEspe = New ADODB.Connection
		ComprobarConexion(conEspe, ReadIniFile(INIFile, "ESPECIFICA" & strFamil, "Connection"))
		If conGene.State = 1 Then
			conGene.Close()
		End If
		'UPGRADE_NOTE: Object conGene may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conGene = Nothing
		conGene = New ADODB.Connection
		ComprobarConexion(conGene, ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection"))
		'UPGRADE_WARNING: Couldn't resolve default property of object frmMDI.ImageList1.ListImages. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		frmMDI.SysTray.set_TrayIcon(frmMDI.ImageList1.ListImages(1).Picture)
		
		sSQL = "SELECT * FROM PROCESOS_PENDIENTES WHERE USERID='" & strUserId & "' and (FINALIZADO <>'S' and FINALIZADO <> 'C') order by NOMBRE_CM"
		'************************
		rstProcPend = mfRecordset(conPasarela, sSQL)
		While Not rstProcPend.EOF
			'Inicio Jonathan Prieto 23/06/2011
			ComprobarConexion(conDP4, ReadIniFile(INIFile, "SQLMODELO", "Connection"))
			ComprobarConexion(conDB2, ReadIniFile(INIFile, "DB2", "Connection"))
			ComprobarConexion(conInfra, ReadIniFile(INIFile, "GENERALAPLICACION" & strFamil, "Connection"))
			ComprobarConexion(conEspe, ReadIniFile(INIFile, "ESPECIFICA" & strFamil, "Connection"))
			ComprobarConexion(conGene, ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection"))
			'Fin Jonathan Prieto 23/06/2011
			strNombre = rstProcPend.Fields("NOMBRE_CM").Value
			gNomProc = rstProcPend.Fields("NOMBRE_CM").Value
			gNomProcCorto = rstProcPend.Fields("PROCEDIMIENTO").Value
			gstrGrupo = rstProcPend.Fields("GRUPO").Value
			sSQL = "UPDATE PROCESOS_PENDIENTES SET FINALIZADO='P', FECHAINICIO= getdate() WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOMBRE_CM='" & gNomProc & "' and USERID='" & strUserId & "'"
			mfExecute(conPasarela, sSQL)
			colPasar = New Collection
			'UPGRADE_WARNING: Couldn't resolve default property of object arrCol(0). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrCol(0) = rstProcPend.Fields("ID").Value
			'UPGRADE_WARNING: Couldn't resolve default property of object arrCol(1). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrCol(1) = ""
			'UPGRADE_WARNING: Couldn't resolve default property of object arrCol(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrCol(2) = ""
			'UPGRADE_WARNING: Couldn't resolve default property of object arrCol(3). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			arrCol(3) = ""
			colPasar.Add(arrCol)
			blnCancelar = False
			blnParar = False
			cmdCancelar.Visible = True
			CmdCancelarActual.Visible = True
			colCancel = New Collection
			colConOp = New Collection
			Me.lblProc.Text = Trim(gNomProc)
			'Inicio Jonathan Prieto 07/06/2011
			If objValidaciones.fValidacionesIniciales(colPasar) Then
				frmErrores.lblError.Text = "Validaciones incumplidas detectadas"
				frmErrores.Text = "Validaciones"
				frmErrores.intOpcion = 1
				intTimer = 1
				tramiteAnterior = ""
				frmErrores.ShowDialog()
			End If
			'Fin Jonathan Prieto 07/06/2011
			msLec_Diagram_Proc(colPasar, "'Trámite de Inicio', 'Trámite','Trámite automático','Trámite general','Ramificación','Trámite General Automático'", 1)
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then Exit Sub
			System.Windows.Forms.Application.DoEvents()
			msPropiedades_Proc(colPasar)
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			System.Windows.Forms.Application.DoEvents()
			msVariables_Alta(colPasar)
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			System.Windows.Forms.Application.DoEvents()
			msUd_Tramitacion()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			System.Windows.Forms.Application.DoEvents()
			msLec_Conectores_ACC()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			'PENDIENTE
			msComprobarNombres()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			msActualizarSalidas()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			System.Windows.Forms.Application.DoEvents()
			msLecTramRamif()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			System.Windows.Forms.Application.DoEvents()
			msLecAccTram()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			System.Windows.Forms.Application.DoEvents()
			mslecParamAcc()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			System.Windows.Forms.Application.DoEvents()
			msRepaso()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			msValidaciones()
			If blnCancelar = True Then GoTo procFin
			If blnParar = True Then GoTo procFin
			If blnParar = True Then Exit Sub
			strFecha = VB6.Format(CDate(rstProcPend.Fields("FECHA_ACTIVACION").Value), "yyyy/mm/dd")
			If rstProcPend.Fields("NUEVA_VERSION").Value = "1" Then
				gblnNuevaVersion = True
				gstrObserva = rstProcPend.Fields("OBSERVACIONES").Value & ""
			Else
				gblnNuevaVersion = False
			End If
			blnParar = False
			blnCancelar = False
			'Inicio Jonathan Prieto 31/01/2011: De momento, debe cancelar manualmente la alerta del Plazo Tipo 2
			'sSQL = "SELECT * FROM ERRORES where PROCEDIMIENTO='" & gNomProcCorto & "' and USERID='" & strUserId & "' and AMBITO<>'Inserción de Nueva Acción' and AMBITO<>'Corrección de Acción' and AMBITO<>'Aviso UT asociada' "
			sSQL = "SELECT * FROM ERRORES " & "where PROCEDIMIENTO='" & gNomProcCorto & "' and USERID='" & strUserId & "' " & "and AMBITO<>'Inserción de Nueva Acción' " & "and AMBITO<>'Corrección de Acción' " & "and AMBITO<>'Aviso UT asociada' " & "and AMBITO<>'Aviso Solución Plazo Tipo 2'"
			'Fin Jonathan Prieto 31/01/2011
			rstError = mfRecordset(conPasarela, sSQL)
			If rstError.EOF Then
				msLimpiar("WFFLOWS", "FLOW", gNomProcCorto, conPasarela)
				msLimpiar("WFFLOWACTIONS", "FLOW", gNomProcCorto, conPasarela)
				msOptimizarFlujo()
				msCrearFlujo()
				msCrearTramites()
			End If
			rstError.Requery()
			If rstError.EOF Then
				cmdCancelar.Visible = False
				CmdCancelarActual.Visible = False
				bConexion2 = False
				If ComprobarConexion(conCarga, rstProcPend.Fields("CONEXION").Value) = True Then
					If (rstProcPend.Fields("CONEXION2").Value <> "") Then
						conCarga2 = New ADODB.Connection
						bConexion2 = ComprobarConexion(conCarga2, rstProcPend.Fields("CONEXION2").Value)
					End If
					msCargarInfraestructura()
					msVariablesInfra()
					msCargarFlujo()
					'Eliminar JUMPs a paso siguiente
					msEliminarJUMP_SiguienteInstruccion()
					msModificacionesTramites()
					'Ejecutar procedimientos de adaptación de flujos J.Lerma
					msAdaptarFlujosRamasUnion(strProj, gNomProcCorto, VersionHidra)
				Else
					Insertar_Error(Me, "Error de conexión", "No se ha podido conectar con el Servidor al que se desea volcar el procedimiento.", "msPasarProcedimientos")
					Mostrar_Error()
				End If
			End If
			rstError.Requery()
			If rstError.EOF Then
				Insertar_Error(Me, "Resultado", "El proceso se ha volcado sin errores", "msPasarProcedimientos")
				Mostrar_Error()
				sSQL = "UPDATE PROCESOS_PENDIENTES SET FINALIZADO='S', FECHAFIN= GETDATE() WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOMBRE_CM='" & gNomProc & "' and USERID='" & strUserId & "'"
				mfExecute(conPasarela, sSQL)
			Else
				sSQL = "UPDATE PROCESOS_PENDIENTES SET FINALIZADO='S', FECHAFIN= GETDATE() WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOMBRE_CM='" & gNomProc & "' and USERID='" & strUserId & "'"
				'********************************
				mfExecute(conPasarela, sSQL)
			End If
			blnCancelar = True
			rstError.Close()
			rstProcPend.MoveNext()
		End While
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		logError("msPasarProcedimientos - " & Err.Description)
		Resume procFin
		
procFin: 
		intTimer = 0
		tramiteAnterior = ""
		Me.Close()
		'Inicio Jonathan Prieto 07/06/2011
		frmErrores.lblError.Text = "Errores detectados por la pasarela"
		frmErrores.Text = "Errores"
		frmErrores.intOpcion = 0
		'Fin Jonathan Prieto 07/06/2011
		frmErrores.Show()
	End Sub
	
	
	
	
	
	
	Private Function fTrat_Docum(ByVal rstTram As ADODB.Recordset, ByVal rstparamHN As ADODB.Recordset, ByVal rstAcc As ADODB.Recordset, ByVal rstParCME As ADODB.Recordset, ByVal rstParCMS As ADODB.Recordset, ByVal lngacc As Integer, ByVal lngAccCME As Integer, ByVal lngAccCMS As Integer, ByVal strImplem As String) As Boolean
		On Error GoTo procErr
		
		Dim rstACC2 As ADODB.Recordset
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstParamCMS As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim lngAccConS As Integer
		Dim lngAccConE As Integer
		Dim lngAnt As Integer
		Dim lngUlt As Integer
		Dim I As Integer
		Dim lngNumAcc As Integer
		Dim lngORACC As Integer
		Dim blnPrim As Boolean
		Dim blnfin As Boolean
		Dim strJOINER As String
		Dim strSQL As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim nomTram As String
		Dim nomTramS As String
		Dim colXMLD As Collection
		Dim colXML2 As Collection
		Dim colXML4 As Collection
		Dim icol As Object
		Dim codPlaz As String
		Dim blnIndValVar As Boolean
		colXML2 = New Collection
		colXML2.Add("Valor")
		
		fTrat_Docum = True
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		strJOINER = ""
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM " & "JOINER J, CW_DATA_USAGE C Where " & "J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND " & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND " & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND " & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND " & "C.CO_ID=J.ANO_ID AND " & "DM_DELETES=1 " & " AND J.MODEL_NAME ='" & strModelo & "'" & " AND C.MODEL_NAME ='" & strModelo & "'"
			'****
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				strJOINER = rstConS.Fields(0).Value
			End If
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C,ENTITY E "
			strSQL = strSQL & "  Where C.CO_ID = (" & strJOINER & ") AND DM_DELETES=1 "
			strSQL = strSQL & " AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID  "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'****
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstParamCMS = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConS = rstParamCMS.RecordCount
			System.Windows.Forms.Application.DoEvents()
			rstParamCMS.MoveFirst()
		Else
			lngAccConS = 0
		End If
		strJOINER = ""
		rstAux.Close()
		strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " and " & "NUM_SEQ_HASTA=" & rstAcc.Fields("NUM_SEQ").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		lngAnt = 0
		blnPrim = True
		While Not rstAux.EOF
			strSQL = "select DISTINCT J.ANO_ID FROM " & "JOINER J, CW_DATA_USAGE C Where " & "J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND " & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND " & "SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND " & "DI_ID=" & rstAcc.Fields("DI_ID").Value & " AND " & "C.CO_ID=J.ANO_ID AND DM_INSERTS=1" & " AND J.MODEL_NAME ='" & strModelo & "'" & " AND C.MODEL_NAME ='" & strModelo & "'"
			' **** NUEVO SD ENERO'08
			rstconE = mfRecordset(conDP4, strSQL)
			If Not rstconE.EOF Then
				strJOINER = rstconE.Fields(0).Value
vuelta: 
				strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
				strSQL = strSQL & " Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND "
				strSQL = strSQL & " DM_INSERTS=1 AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID "
				' **** NUEVO SD ENERO'08
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				'****
				strSQL = strSQL & " ORDER BY C.DM_SEQ"
				rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			Else
				strSQL = "select DISTINCT J.ANO_ID " & "FROM JOINER J " & "Where J.JO_SEQ=" & rstAux.Fields("ID_CONECTOR").Value & " AND " & "SH_SEQ_FROM=" & rstAux.Fields("NUM_SEQ_DESDE").Value & " AND " & " SH_SEQ_TO=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND " & "DI_ID=" & rstAux.Fields("DI_ID").Value & " AND J.MODEL_NAME ='" & strModelo & "'"
				'***& "DI_ID=" & rstAcc("DI_ID") _          Cambio '## DS66 10/12/09 rstAcc("DI_ID") tiene q ser siempre igual q rstAux("DI_ID")
				' **** NUEVO SD ENERO'08
				
				If rstAcc.Fields("DI_ID").Value <> rstAux.Fields("DI_ID").Value Then
					System.Windows.Forms.Application.DoEvents()
				End If
				
				
				rstconE = mfRecordset(conDP4, strSQL)
				GoTo vuelta
			End If
			If blnPrim = False Then
				System.Windows.Forms.Application.DoEvents()
				If lngAnt <> rstparamCME.RecordCount Then
					'aketza errores
					Insertar_Error(Me, "Lectura de acciones de trámite", "Los conectores de entrada a la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " tienen diferente número de parámetros", "fTrat_Docum")
					'mostramos el btn y el lbl
					Mostrar_Error()
					'fin aketza
					fTrat_Docum = False
					Exit Function
				End If
				
			End If
			System.Windows.Forms.Application.DoEvents()
			lngAnt = rstparamCME.RecordCount
			System.Windows.Forms.Application.DoEvents()
			blnPrim = False
			rstAux.MoveNext()
		End While
		If strJOINER <> "" Then
			strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
			strSQL = strSQL & " Where C.CO_ID = (" & strJOINER & ") AND DM_INSERTS=1 AND "
			strSQL = strSQL & " A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID  "
			' **** NUEVO SD ENERO'08
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'****
			strSQL = strSQL & " ORDER BY C.DM_SEQ"
			rstparamCME = mfRecordset(conDP4, strSQL, CStr(True))
			System.Windows.Forms.Application.DoEvents()
			lngAccConE = rstparamCME.RecordCount
			rstparamCME.MoveFirst()
		Else
			lngAccConE = 0
		End If
		rstAux.Close()
		If Trim(rstAcc.Fields("NOM_ACCION").Value) <> "COMPROBACIONVALOR" Then
			If lngacc <> IIf(lngAccConE <> 0, lngAccConE, lngAccCME) + IIf(lngAccConS <> 0, lngAccConS, lngAccCMS) + 1 Then
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas no coincide con el número de parámetros", "fTrat_Docum")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fTrat_Docum = False
				Exit Function
			End If
		End If
		colXML4 = New Collection
		colXML4.Add("Código Documento")
		colXML4.Add("Indicador Valor Variable")
		colXMLD = mfBuscaXML("Conector", colXML4, rstconE.Fields("ANO_ID").Value)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(2). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		If colXMLD.Item(2) <> vbNullString Then
			'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			blnIndValVar = CBool(System.Math.Abs(colXMLD.Item(2)) = CDbl("1"))
		End If
		colXMLD.Remove(2)
		I = 0
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		codPlaz = colXMLD.Item(1)
		For	Each icol In colXMLD
			I = I + 1
			'UPGRADE_WARNING: Couldn't resolve default property of object icol. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, icol, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value, blnIndValVar)
			rstparamHN.MoveNext()
		Next icol
		If lngAccConE <> 0 Then
			If lngAccCME = lngAccConE + IIf(Trim(rstAcc.Fields("NOM_ACCION").Value) = "COMPROBACIONVALOR", (IIf(codPlaz <> "", 1, 0)), 0) Then
				While Not rstparamCME.EOF
					If Trim(rstparamHN.Fields("PARAM").Value) = "@OPERANDO2" And codPlaz <> "" Then
						rstparamHN.MoveNext()
					End If
					Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTrat_Docum")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstparamCME.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fTrat_Docum")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fTrat_Docum = False
				Exit Function
			End If
		Else
			While Not rstParCME.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCME.Fields("AT_ID").Value, rstParCME.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCME.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		If lngAccConS <> 0 Then
			If lngAccCMS = lngAccConS Then
				While Not rstParamCMS.EOF
					Select Case rstParamCMS.Fields("EN_NAME").Value
						Case "Constantes"
							colXMLD = mfBuscaXML("Atributo", colXML2, rstParamCMS.Fields("AT_ID").Value)
							'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							strValorV = colXMLD.Item(1)
							If strValorV = "" Then
								'aketza errores
								Insertar_Error(Me, "Lectura de acciones de trámite", "No se encuentra el valor de la constante " & Replace(rstparamCME.Fields("AT_NAME").Value, "'", """") & " de la acción " & rstAcc.Fields("NOM_ACCION").Value & " del trámite " & rstTram.Fields("NOMBRE").Value, "fTrat_Docum")
								'mostramos el btn y el lbl
								Mostrar_Error()
								'fin aketza
							Else
								msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
							End If
						Case ""
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
						Case Else
							'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
							nomVarHN = mfInsertaVariables(rstParamCMS.Fields("AT_ID").Value, rstParamCMS.Fields("AT_NAME").Value)
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
					End Select
					rstParamCMS.MoveNext()
					rstparamHN.MoveNext()
				End While
			Else
				'aketza errores
				Insertar_Error(Me, "Lectura de acciones de trámite", "En la acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " el número de variables asignadas como entrada no coincide con el número de parámetros de entrada", "fTrat_Docum")
				'mostramos el btn y el lbl
				Mostrar_Error()
				'fin aketza
				fTrat_Docum = False
				Exit Function
			End If
		Else
			While Not rstParCMS.EOF
				'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
				nomVarHN = mfInsertaVariables(rstParCMS.Fields("AT_ID").Value, rstParCMS.Fields("AT_NAME").Value)
				msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, nomVarHN, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, rstAcc.Fields("ORDEN_ACC").Value)
				rstParCMS.MoveNext()
				rstparamHN.MoveNext()
			End While
		End If
		If rstTram.Fields("SALIDAS").Value > 1 Then
			strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ID_DIAGRAMA=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "NUM_CONECTOR=" & rstTram.Fields("NUM_DIAGRAMA").Value & " AND " & "NUM_SEQ_DESDE=" & rstAcc.Fields("NUM_SEQ").Value & " AND " & "IND_SALIDA_TRAM='S'"
			rstAux = mfRecordset(conPasarela, strSQL, CStr(True))
			While Not rstAux.EOF
				'aketza 29/04/2008
				'If UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
				If UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or UCase(Trim(rstAux.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
					'fin aketza
					nomTramS = "PR_FINEXPEDIENTE"
					GoTo aqui
				End If
				strSQL = "SELECT A.EV_ID FROM " & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E " & "WHERE D.ANO_ID=A.EV_ID AND " & "D.ANO_TABNR=9097 AND " & "B.OT_NAME='Evento/Resultado' AND " & "E.DI_ID=D.DI_ID AND " & "D.ANO_TABNR=B.OT_ID AND " & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND " & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value & " AND A.MODEL_NAME ='" & strModelo & "'" & " AND B.MODEL_NAME ='" & strModelo & "'" & " AND D.MODEL_NAME ='" & strModelo & "'" & " AND E.MODEL_NAME ='" & strModelo & "'" 'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				'Fin Jonathan Prieto 28/10/2010
				' **** NUEVO SD ENERO'08
				
				rstConS = mfRecordset(conDP4, strSQL)
				If Not rstConS.EOF Then
					strSQL = "SELECT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND " & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					rstConST = mfRecordset(conPasarela, strSQL)
					While Not rstConST.EOF
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND " & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
						rstTRAMS = mfRecordset(conPasarela, strSQL)
						While Not rstTRAMS.EOF
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = "SELECT A.EV_ID FROM " & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E " & "WHERE D.ANO_ID=A.EV_ID AND " & "D.ANO_TABNR=9097 AND " & "B.OT_NAME='Evento/Resultado' AND " & "E.DI_ID=D.DI_ID AND " & "D.ANO_TABNR=B.OT_ID AND " & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " and E.ANO_TABNR=8953 " & " AND A.MODEL_NAME ='" & strModelo & "'" & " AND B.MODEL_NAME ='" & strModelo & "'" & " AND D.MODEL_NAME ='" & strModelo & "'" & " AND E.MODEL_NAME ='" & strModelo & "'" & " AND E.DI_TYPE <> " & gstrCodTramUsu & " ORDER BY D.SH_Y DESC"
							'Fin Jonathan Prieto 28/10/2010
							rstAux3 = mfRecordset(conDP4, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
									blnfin = True
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
									strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
									rstAux2 = mfRecordset(conPasarela, strSQL)
									While Not rstAux2.EOF
										strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										lngUlt = rstAux2.Fields("ORDEN_ACC").Value
										
										strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
										mfExecute(conPasarela, strSQL)
										
										rstAux2.MoveNext()
									End While
									If lngUlt <> 0 Then
										lngORACC = lngUlt
									Else
										strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
										rstAux3 = mfRecordset(conPasarela, strSQL)
										lngORACC = rstAux3.Fields(0).Value + 1
									End If
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
									Else
										nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									rstAux2 = mfRecordset(conPasarela, strSQL)
									If Not rstAux2.EOF Then
										nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
										If nomTramS = "" Then
											If rstAux2.Fields("ORDEN_N2").Value = 0 Then
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N3").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux2.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N4").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux2.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											ElseIf rstAux2.Fields("ORDEN_N5").Value = 0 Then 
												strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux2.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
											End If
											rstAux2 = mfRecordset(conPasarela, strSQL)
											Do While Not rstAux2.EOF
												If rstAux2.Fields("NOM_DIAGRAMA").Value <> "" Then
													nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
													Exit Do
												End If
												rstAux2.MoveNext()
												nomTramS = "PR_FINEXPEDIENTE"
											Loop 
										End If
									Else
										nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
									End If
									msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
									rstACC2 = mfRecordset(conPasarela, strSQL)
									lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
									lngORACC = lngORACC + 1
									strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
									mfExecute(conPasarela, strSQL)
									blnInserta = False
									blnIns = True
									regPlus = regPlus + 1 '
									msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
									'GoTo aqui
								End If
							Else
								'''''''''''''''''''
								If rstTRAMS.Fields("EXPLOTA_ACC").Value = "N" Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value
									
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = strSQL & " AND ORDEN_N2=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N3=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value
									End If
									If rstTRAMS.Fields("ORDEN_N4").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N4=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
									End If
									If rstTRAMS.Fields("ORDEN_N3").Value = 0 And rstTRAMS.Fields("ORDEN_N2").Value <> 0 And rstTRAMS.Fields("ORDEN_N3").Value <> 0 And rstTRAMS.Fields("ORDEN_N4").Value <> 0 Then
										strSQL = strSQL & " AND ORDEN_N5=1 "
									Else
										strSQL = strSQL & " AND ORDEN_N5=" & rstTRAMS.Fields("ORDEN_N5").Value
									End If
									
									rstAux4 = mfRecordset(conPasarela, strSQL)
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
									'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
									strSQL = "SELECT A.EV_ID FROM " & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E " & "WHERE D.ANO_ID=A.EV_ID AND " & "D.ANO_TABNR=9097 AND " & "B.OT_NAME='Evento/Resultado' AND " & "E.DI_ID=D.DI_ID AND " & "D.ANO_TABNR=B.OT_ID AND " & "E.ANO_ID=" & rstAux4.Fields("ID_DIAGRAMA").Value & " AND A.MODEL_NAME ='" & strModelo & "'" & " AND B.MODEL_NAME ='" & strModelo & "'" & " AND D.MODEL_NAME ='" & strModelo & "'" & " AND E.MODEL_NAME ='" & strModelo & "'" & " AND E.DI_TYPE <> " & gstrCodTramUsu
									'Fin Jonathan Prieto 28/10/2010
									rstAux3 = mfRecordset(conDP4, strSQL)
									If Not rstAux3.EOF Then
										If rstAux3.Fields(0).Value = rstConS.Fields("EV_ID").Value Then
											blnfin = True
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
											strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
											rstAux2 = mfRecordset(conPasarela, strSQL)
											While Not rstAux2.EOF
												strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												lngUlt = rstAux2.Fields("ORDEN_ACC").Value
												strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
												mfExecute(conPasarela, strSQL)
												rstAux2.MoveNext()
											End While
											If lngUlt <> 0 Then
												lngORACC = lngUlt
											Else
												strSQL = "SELECT MAX(ORDEN_ACC) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
												rstAux3 = mfRecordset(conPasarela, strSQL)
												lngORACC = rstAux3.Fields(0).Value + 1
											End If
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
											Else
												nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux4.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux4.Fields("ORDEN_N5").Value
											rstAux2 = mfRecordset(conPasarela, strSQL)
											If Not rstAux2.EOF Then
												nomTramS = rstAux2.Fields("NOM_DIAGRAMA").Value
											Else
												nomTramS = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
											End If
											msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
											strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
											rstACC2 = mfRecordset(conPasarela, strSQL)
											lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
											lngORACC = lngORACC + 1
											strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
											mfExecute(conPasarela, strSQL)
											blnInserta = False
											blnIns = True
											regPlus = regPlus + 1 '
											msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
										End If
									End If
									'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
								End If
							End If
							rstTRAMS.MoveNext()
						End While
						rstConST.MoveNext()
					End While
				End If
				rstAux.MoveNext()
			End While
aqui: 
			If blnfin = False And rstAux.RecordCount > 0 Then
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "NOM_ACCION='LET INICIALIZACIONVAR'"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstAux2.Fields(0).Value) + 1
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value & " AND ORDEN_ACC>" & rstAcc.Fields("ORDEN_ACC").Value + 2 & " AND ORDEN_ACC<>999 ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					strSQL = "UPDATE PARAM_ACC SET " & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 2 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value
					mfExecute(conPasarela, strSQL)
					
					rstAux2.MoveNext()
				End While
				lngORACC = rstAcc.Fields("ORDEN_ACC").Value + 3
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION, PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'LET INICIALIZACIONVAR'," & lngNumAcc & ",'LET INICIALIZACIONVAR" & VB6.Format(lngNumAcc, "00") & "')"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND " & "ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTram.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstTram.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTram.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstTram.Fields("ORDEN_N5").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					nomTram = "@LET" & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, 1, 17) & Mid(rstAux2.Fields("NOM_DIAGRAMA").Value, Len(rstAux2.Fields("NOM_DIAGRAMA").Value) - 3)
				Else
					nomTram = rstTram.Fields("ORDEN_N1").Value & ";" & rstTram.Fields("ORDEN_N2").Value & ";" & rstTram.Fields("ORDEN_N3").Value & ";" & rstTram.Fields("ORDEN_N4").Value & ";" & rstTram.Fields("ORDEN_N5").Value
				End If
				'aketza 5/9/2006
				'            If rstTram("ORDEN_N5") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5") + 1
				'            ElseIf rstTram("ORDEN_N4") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") + 1 & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N3") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") + 1 & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N2") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") & ";" & rstTram("ORDEN_N2") + 1 & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'            ElseIf rstTram("ORDEN_N1") <> 0 Then
				'                nomTramS = rstTram("ORDEN_N1") + 1 & ";" & rstTram("ORDEN_N2") & ";" & rstTram("ORDEN_N3") & ";" & rstTram("ORDEN_N4") & ";" & rstTram("ORDEN_N5")
				'
				'            End If
				'fin aketza
				If nomTramS <> "PR_FINEXPEDIENTE" Then
					nomTramS = "ENLACE SIN DEFINIR"
				End If
				
				msInsertaParamAcc(nomTram, nomTramS, rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
				rstACC2 = mfRecordset(conPasarela, strSQL)
				lngNumAcc = Val(rstACC2.Fields(0).Value & "") + 1
				lngORACC = lngORACC + 1
				strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rstTram.Fields("ORDEN_N1").Value & ", " & rstTram.Fields("ORDEN_N2").Value & ", " & rstTram.Fields("ORDEN_N3").Value & "," & rstTram.Fields("ORDEN_N4").Value & "," & rstTram.Fields("ORDEN_N5").Value & "," & lngORACC & "," & "'JUMP'," & lngNumAcc & ",'JUMP" & VB6.Format(lngNumAcc, "00") & "' )"
				mfExecute(conPasarela, strSQL)
				blnInserta = False
				msInsertaParamAcc("PATH", "FINTRAMITEPROV", rstTram.Fields("ORDEN_N1").Value, rstTram.Fields("ORDEN_N2").Value, rstTram.Fields("ORDEN_N3").Value, rstTram.Fields("ORDEN_N4").Value, rstTram.Fields("ORDEN_N5").Value, lngORACC)
				blnIns = True
				regPlus = 1
			End If
		End If
		GoTo procFin
procErr: 
		If blnParar = True Then Exit Function
		logError("fTrat_Docum - " & Err.Description)
		Insertar_Error(Me, "Lectura de acciones de trámite", "La acción " & Trim(rstAcc.Fields("NOM_ACCION").Value) & " del trámite " & rstTram.Fields("NOMBRE").Value & " está mal definida.", "fTrat_Docum")
		Mostrar_Error()
		fTrat_Docum = False
		Resume procFin
procFin: 
		
	End Function
	
	
	'aketza errores
	
	Public Sub Mostrar_Error()
		'ContadorErrores = ContadorErrores + 1
		'If ContadorErrores > 1 Then
		'lblError.Caption = "Han ocurrido " & ContadorErrores & " errores"
		'End If
		'se muestran el boton y el label
		'cmdNotepad.Visible = True
		'LblError.Visible = True
		
	End Sub
	' fin aketza
	
	'aketza excel
	Private Sub cmdNotepad_Click(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles cmdNotepad.Click
		' para ver los errores
		'Abrir_Excel Me
	End Sub
	' fin aketza
	
	
	Private Function mfConectoresValidos(ByVal rst As ADODB.Recordset, ByVal rst1 As ADODB.Recordset) As Integer
		On Error GoTo Err_Renamed
		Dim rst2 As ADODB.Recordset
		Dim strSQL As String
		rst.MoveFirst()
		While Not rst.EOF
			If rst1.Fields("NUM_DIAGRAMA").Value > 1 Then
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ID_PADRE=" & rst1.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rst.Fields("NUM_SEC_HASTA").Value & " and ORDEN_N1=" & rst.Fields("ORDEN_N1").Value
			Else
				If rst1.Fields("NUM_DIAGRAMA").Value = 3 Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ID_PADRE=" & rst1.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rst.Fields("NUM_SEC_HASTA").Value & " AND ORDEN_N2=" & rst.Fields("ORDEN_N2").Value
				Else
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND  ID_PADRE=" & rst1.Fields("ID_PADRE").Value & " AND NUM_SEQ=" & rst.Fields("NUM_SEC_HASTA").Value
				End If
			End If
			rst2 = mfRecordset(conPasarela, strSQL)
			If Not rst2.EOF Then
				mfConectoresValidos = mfConectoresValidos + 1
				'mfConectoresValidos = mfConectoresValidos + rst2.RecordCount
			ElseIf rst.Fields("SALIDA").Value = "S" Then 
				mfConectoresValidos = mfConectoresValidos + 1
				'mfConectoresValidos = mfConectoresValidos + rst2.RecordCount
			End If
			rst.MoveNext()
			rst2.Close()
			'UPGRADE_NOTE: Object rst2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rst2 = Nothing
		End While
		
		Exit Function
		
Err_Renamed: 
		
	End Function
	
	Private Sub arrancarConexiones()
		On Error GoTo procErr
		
		conDP4.Open(conDP4.ConnectionString)
		conDB2.Open(conDB2.ConnectionString)
		conGene.Open(conGene.ConnectionString)
		conInfra.Open(conInfra.ConnectionString)
		conEspe.Open(conEspe.ConnectionString)
		conGestion.Open(conGestion.ConnectionString)
		conWord.Open(conWord.ConnectionString)
		'## Ds66, Para la nueva BD DBT0DOCU
		conDocu.Open(conDocu.ConnectionString)
		'##
		conMSJ.Open(conMSJ.ConnectionString)
		
		Exit Sub
procErr: 
		MsgBox(Err.Description)
		End
	End Sub
	
	
	Private Sub cerrarConexiones()
		On Error GoTo procErr
		conDP4.Close()
		conDB2.Close()
		conGene.Close()
		conInfra.Close()
		conEspe.Close()
		conGestion.Close()
		conWord.Close()
		'## Ds66, Para la nueva BD DBT0DOCU
		conDocu.Close()
		'##
		conMSJ.Close()
		
		
		Exit Sub
procErr: 
		MsgBox(Err.Description)
		End
	End Sub
	
	
	
	
	'aketza 10/11/2006
	Public Function CrearAccion(ByVal rstAcc As ADODB.Recordset) As Boolean
		
		On Error GoTo procErr
		
		Dim strPath As String
		Dim strAux As String
		Dim strSQL As String
		Dim intAux As Short
		Dim rstAux As ADODB.Recordset
		Dim conAux As ADODB.Connection
		Dim I As Short
		Dim colXMLIm As Collection
		Dim colXMLD As Collection
		Dim strError As String
		'aketza 12/02/2008
		Dim rstProcPend As ADODB.Recordset
		Dim strServidor2 As String
		Dim conAux2 As ADODB.Connection
		Dim conInfra2 As ADODB.Connection
		Dim strServidor1 As String
		'fin aketza
		CrearAccion = True
		colXMLIm = New Collection
		conAux = New ADODB.Connection
		
		
		'aketza 12/02/2008
		conAux = New ADODB.Connection
		rstProcPend = mfRecordset(conPasarela, "SELECT * FROM PROCESOS_PENDIENTES WHERE USERID='" & strUserId & "' and (FINALIZADO <>'S' and FINALIZADO <> 'C') order by NOMBRE_CM")
		If Not rstProcPend.EOF Then
			strServidor2 = Mid(rstProcPend.Fields("CONEXION2").Value, InStr(1, rstProcPend.Fields("CONEXION2").Value, "Data Source=") + 12)
		Else
			strServidor2 = ""
		End If
		'fin aketza
		
		strSQL = "SELECT COUNT(*) FROM ACCIONES WHERE IDACCION=" & rstAcc.Fields("PR_ID").Value
		rstAux = mfRecordset(conInfra, strSQL)
		intAux = Val(rstAux.Fields(0).Value & "") + 1
		If Trim(rstAcc.Fields("PR_ALT_NAME").Value) = "" Then
			strError = " por carecer de nombre alternativo"
			GoTo procErr
		End If
		strPath = ObtenerNombre(rstAcc.Fields("PR_ALT_NAME").Value)
		If intAux > 1 And intAux < 10 Then
			If Len(strPath) = 25 Then
				strPath = Mid(strPath, 0, Len(strPath) - 1) & CStr(intAux)
			Else
				strPath = strPath & CStr(intAux)
			End If
		ElseIf intAux > 9 And intAux < 100 Then 
			If Len(strPath) = 25 Then
				strPath = Mid(strPath, 0, Len(strPath) - 2) & CStr(intAux)
			Else
				If Len(strPath) = 24 Then
					strPath = Mid(strPath, 0, Len(strPath) - 1) & CStr(intAux)
				Else
					strPath = strPath & CStr(intAux)
				End If
			End If
		ElseIf intAux > 99 Then 
			If Len(strPath) = 25 Then
				strPath = Mid(strPath, 0, Len(strPath) - 3) & CStr(intAux)
			Else
				If Len(strPath) = 24 Then
					strPath = Mid(strPath, 0, Len(strPath) - 2) & CStr(intAux)
				Else
					If Len(strPath) = 23 Then
						strPath = Mid(strPath, 0, Len(strPath) - 1) & CStr(intAux)
					Else
						strPath = strPath & CStr(intAux)
					End If
				End If
			End If
		End If
		
		colXMLIm.Add("Tipo Proceso")
		colXMLD = mfBuscaXML("Proceso", colXMLIm, rstAcc.Fields("PR_ID").Value, True)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strAux = IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1))
		'aketza 26/02/2008
		'If strAux = "Específico" Then
		'If ComprobarConexion(conAux, ReadIniFile(INIFile, "ESPECIFICA" & strFamil, "Connection")) = True Then
		'strAux = "E"
		If strAux = "General" Then
			If ComprobarConexion(conAux, ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection")) = True Then
				strAux = "G"
			Else
				GoTo procErr
			End If
		Else
			'If ComprobarConexion(conAux, ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection")) = True Then
			'strAux = "G"
			If ComprobarConexion(conAux, ReadIniFile(INIFile, "ESPECIFICA" & strFamil, "Connection")) = True Then
				strAux = "E"
			Else
				GoTo procErr
			End If
		End If
		'fin aketza
		
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			strServidor1 = Mid(ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection"), InStr(1, ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection"), "Data Source=") + 12)
			If strAux = "E" Then
				If ComprobarConexion(conAux2, Replace(ReadIniFile(INIFile, "ESPECIFICA" & strFamil, "Connection"), strServidor1, strServidor2)) = False Then
					GoTo procErr
				End If
			Else
				If ComprobarConexion(conAux2, Replace(ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection"), strServidor1, strServidor2)) = False Then
					GoTo procErr
				End If
			End If
			If ComprobarConexion(conInfra2, Replace(ReadIniFile(INIFile, "GENERALES" & strFamil, "Connection"), strServidor1, strServidor2)) = False Then
				GoTo procErr
			End If
		End If
		'fin aketza
		
		strSQL = "INSERT INTO ACCIONES(IDACCION,DESACCCM,DESACCHN,DESCRIPCION,INDTIPOA) VALUES "
		strSQL = strSQL & "(" & rstAcc.Fields("PR_ID").Value & ",'X', '" & strPath & "', '" & rstAcc.Fields("PR_ALT_NAME").Value & "','" & strAux & "')"
		'la accion siempre se inserta en infraestructura
		mfExecute(conInfra, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			'en D1MAPPSQL05 --> DBT4AS01 no hay tabla ACCIONES
			'mfExecute conInfra2, strSQL
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlows(FLOW,VERSION,ACTIVE,FLOWNAME,COMMENTS,RUNNING,START,STOPOLDERVERSIONS) VALUES "
		'Inicio Jonathan Prieto 02/05/2011: Corregir el formato de fecha al insertar una acción de trámite
		'strSQL = strSQL & "('" & strPath & "', 0, '1','" & strPath & "', 'ACCION INTRODUCIDA POR PASARELA - " & rstAcc("PR_ALT_NAME") & "' , '1', " & Format(Date, ReadIniFile(INIFile, "FECHA", "Formato")) & ", '0')"
		strSQL = strSQL & "('" & strPath & "', 0, '1','" & strPath & "', 'ACCION INTRODUCIDA POR PASARELA - " & rstAcc.Fields("PR_ALT_NAME").Value & "' , '1', '" & VB6.Format(Today, ReadIniFile(INIFile, "FECHA", "Formato")) & "', '0')"
		'Fin Jonathan Prieto 02/05/2011
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 0,0, 'BEGIN' , 'INICIO', 'STATE', 'INICIO " & strPath & "')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 100,0, 'LABEL' , '" & strPath & "', 'CAPTION', '" & strPath & "')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 100,1,null,null , 'SUBMIT', '0')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 100,2, null, null, 'LEVEL','1')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		
		'////////////aqui van los parámetros de entrada y salida
		I = 2
		strSQL = "SELECT A.AT_NAME, A.AT_ID,E.EN_NAME FROM ATTRIBUTE A, CW_DATA_USAGE B, ENTITY E  "
		strSQL = strSQL & " WHERE A.AT_ID=B.AT_ID AND B.PR_ID=" & rstAcc.Fields("PR_ID").Value & ""
		strSQL = strSQL & " AND DM_INSERTS=1 AND E.EN_ID=A.EN_ID"
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		'****
		strSQL = strSQL & " ORDER BY B.DM_SEQ"
		rstAux = mfRecordset(conDP4, strSQL)
		Do While Not rstAux.EOF
			I = I + 1
			strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
			strSQL = strSQL & "('" & strPath & "', 0, 100," & I & ", null, null, '@" & ObtenerNombre(rstAux.Fields("AT_NAME").Value) & "',null)"
			mfExecute(conAux, strSQL)
			'aketza 12/02/2008
			If strServidor2 <> "" Then
				mfExecute(conAux2, strSQL)
			End If
			'fin aketza
			rstAux.MoveNext()
		Loop 
		strSQL = "SELECT A.AT_NAME, A.AT_ID,E.EN_NAME FROM ATTRIBUTE A, CW_DATA_USAGE B, ENTITY E "
		strSQL = strSQL & " WHERE A.AT_ID=B.AT_ID AND B.PR_ID=" & rstAcc.Fields("PR_ID").Value
		strSQL = strSQL & " AND DM_DELETES=1 AND E.EN_ID=A.EN_ID "
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		'****
		strSQL = strSQL & " ORDER BY B.DM_SEQ"
		rstAux = mfRecordset(conDP4, strSQL)
		intAux = 0
		Do While Not rstAux.EOF
			I = I + 1
			intAux = intAux + 1
			strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
			strSQL = strSQL & "('" & strPath & "', 0, 100," & I & ", null, null, '@NOMVAR" & intAux & "',null)"
			mfExecute(conAux, strSQL)
			'aketza 12/02/2008
			If strServidor2 <> "" Then
				mfExecute(conAux2, strSQL)
			End If
			'fin aketza
			rstAux.MoveNext()
		Loop 
		'APILAUNCH
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99900,0, 'APILAUNCHEXT' , 'APLE " & Mid(strPath, 1, 20) & "', 'PROJECT', '@INICIO!PROJECT')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99900,1, null , null, 'FLOW', '@INICIO!FLUJO')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99900,2, null , null, 'REFERENCE', '@INICIO!REFERENCIA')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99900,3, null , null, 'PATH', '@INICIO!PATHRETORNO')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99900,4, null , null, 'LEVEL', '1')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		
		'DS66 9/2/2010 Añadidos dos parametros antes de insertar el END
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99900,5, null , null, 'NEXTEND', '1')"
		mfExecute(conAux, strSQL)
		''
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		''
		
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99900,6, null , null, 'FLUSHALL', '0')"
		mfExecute(conAux, strSQL)
		''
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		''
		
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99999,0,'END','FIN', 'FLUSHALL','0')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		strSQL = "INSERT INTO wfFlowActions(FLOW,VERSION,FLOWORDER,ID,ACTION,PATH,PARAM,VALUE) VALUES "
		strSQL = strSQL & "('" & strPath & "', 0, 99999,1, null, null, 'LEVEL','1')"
		mfExecute(conAux, strSQL)
		'aketza 12/02/2008
		If strServidor2 <> "" Then
			mfExecute(conAux2, strSQL)
		End If
		'fin aketza
		
		'dejamos constancia de que la acción ha sido creada por Pasarela
		Insertar_Error(Me, "Inserción de Nueva Acción", "La acción  " & rstAcc.Fields("PR_NAME").Value & " - " & rstAcc.Fields("PR_ID").Value & " ha sido creada por Pasarela como " & strPath & " en la base de datos " & IIf(strAux = "E", "de acciones específicas", "de acciones generales") & ", porque no se encuentra en la tabla de conversión ", "CrearAccion")
		GoTo procFin
		
procErr: 
		Insertar_Error(Me, "Inserción de Nueva Acción", "No se ha podido crear la acción " & rstAcc.Fields("PR_NAME").Value & " - " & rstAcc.Fields("PR_ID").Value & "" & strError, "CrearAccion")
		CrearAccion = False
		Resume procFin
procFin: 
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'aketza 12/02/2008
		'UPGRADE_NOTE: Object rstProcPend may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstProcPend = Nothing
		CierraCN(conAux2)
		CierraCN(conInfra2)
		'UPGRADE_NOTE: Object conAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conAux2 = Nothing
		'UPGRADE_NOTE: Object conInfra2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conInfra2 = Nothing
		'fin aketza
		CierraCN(conAux)
		'UPGRADE_NOTE: Object conAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		conAux = Nothing
	End Function
	'fin aketza
	'aketza 16/11/2006
	Private Sub SolucionarINDTIPOA(ByVal rstAcc As ADODB.Recordset)
		Dim colXMLIm As Collection
		Dim colXMLD As Collection
		Dim strAux As String
		Dim strSQL As String
		
		colXMLIm = New Collection : colXMLIm.Add("Tipo Proceso")
		colXMLD = mfBuscaXML("Proceso", colXMLIm, rstAcc.Fields("PR_ID").Value, True)
		'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
		strAux = IIf(colXMLD.Item(1) = "-1", "", colXMLD.Item(1))
		
		If strAux = "Específico" Then
			strAux = "E"
		Else
			strAux = "G"
		End If
		
		strSQL = "UPDATE ACCIONES SET INDTIPOA='" & strAux & "' WHERE IDACCION='" & rstAcc.Fields("PR_ID").Value & "'"
		mfExecute(conInfra, strSQL)
		
		'dejamos constancia de que INDTIPOA ha sido puesto por Pasarela
		Insertar_Error(Me, "Corrección de Acción", "La acción  " & rstAcc.Fields("PR_NAME").Value & " - " & rstAcc.Fields("PR_ID").Value & " tenía INDTIPOA sin definir en Infraestructura, por lo que Pasarela la ha actualizado a '" & strAux & "'", "SolucionarINDTIPOA")
		
	End Sub
	'fin aketza
	
	
	
	Private Sub msComprobarNombres()
		
		On Error GoTo proc_ERR
		
		Dim strSQL As String
		Dim rstTram As ADODB.Recordset
		Dim rstNom As ADODB.Recordset
		
		strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_DIAGRAMA IS NOT NULL ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		rstTram = mfRecordset(conPasarela, strSQL)
		While Not rstTram.EOF
			strSQL = "SELECT PR_ID FROM PROCESS WHERE PR_NAME ='" & rstTram.Fields("NOMBRE").Value & "'"
			'**** NUEVO SD ENERO'08
			strSQL = strSQL & " AND MODEL_NAME ='" & strModelo & "'"
			'****
			rstNom = mfRecordset(conDP4, strSQL)
			If rstNom.EOF Then
				strSQL = "SELECT PR_NAME FROM PROCESS WHERE PR_ID='" & rstTram.Fields("ID_DIAGRAMA").Value & "'"
				'**** NUEVO SD ENERO'08
				strSQL = strSQL & " AND MODEL_NAME ='" & strModelo & "'"
				'****
				rstNom = mfRecordset(conDP4, strSQL)
				If Not rstNom.EOF Then
					Insertar_Error(Me, "Comprobación Nombres", "El objeto " & rstTram.Fields("NOMBRE").Value & " tiene un conflicto de nomenclatura, en CM se llama " & Trim(rstNom.Fields("DI_NAME").Value), "msComprobarNombres")
				Else
					Insertar_Error(Me, "Comprobación Nombres", "El objeto " & rstTram.Fields("NOMBRE").Value & " tiene un conflicto de nomenclatura", "msComprobarNombres")
				End If
			End If
			CierraRS(rstNom)
			'UPGRADE_NOTE: Object rstNom may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rstNom = Nothing
			rstTram.MoveNext()
		End While
		GoTo proc_FIN
proc_ERR: 
		Resume proc_FIN
proc_FIN: 
		CierraRS(rstNom)
		'UPGRADE_NOTE: Object rstNom may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstNom = Nothing
		CierraRS(rstTram)
		'UPGRADE_NOTE: Object rstTram may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTram = Nothing
	End Sub
	
	
	
	
	Public Function mfObtieneRuta(ByVal o1 As Integer, ByVal o2 As Integer, ByVal o3 As Integer, ByVal o4 As Integer, ByVal o5 As Integer, ByVal oAcc As Integer) As String
		On Error GoTo procErr
		'Función que devuelve la acción y la ruta de trámites para ubicar el error
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim strRuta As String
		Dim rstAux2 As ADODB.Recordset
		Dim strAccion As String
		
		strSQL = "select * from acciones_di where procedimiento='" & gNomProcCorto & "' and orden_n1=" & o1 & "and orden_n2=" & o2 & " and orden_n3=" & o3 & " and orden_n4=" & o4 & " and orden_n5=" & o5 & "AND ORDEN_ACC=" & oAcc
		rstAux2 = mfRecordset(conPasarela, strSQL)
		
		strSQL = "select * from DIAGRAMA where procedimiento='" & gNomProcCorto & "' and orden_n1=" & o1 & " and orden_n2=0 and orden_n3=0 and orden_n4=0 and orden_n5=0"
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			strRuta = rstAux.Fields("NOMBRE").Value
		End If
		If o2 <> 0 Then
			strSQL = "select * from DIAGRAMA where procedimiento='" & gNomProcCorto & "' and orden_n1=" & o1 & " and orden_n2=" & o2 & " and orden_n3=0 and orden_n4=0 and orden_n5=0"
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strRuta = strRuta & "-" & rstAux.Fields("NOMBRE").Value
			End If
		End If
		If o3 <> 0 Then
			strSQL = "select * from DIAGRAMA where procedimiento='" & gNomProcCorto & "' and orden_n1=" & o1 & "and orden_n2=" & o2 & " and orden_n3=" & o3 & " and orden_n4=0 and orden_n5=0"
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strRuta = strRuta & "-" & rstAux.Fields("NOMBRE").Value
			End If
		End If
		If o4 <> 0 Then
			strSQL = "select * from DIAGRAMA where procedimiento='" & gNomProcCorto & "' and orden_n1=" & o1 & "and orden_n2=" & o2 & " and orden_n3=" & o3 & " and orden_n4=" & o4 & " and orden_n5=0"
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strRuta = strRuta & "-" & rstAux.Fields("NOMBRE").Value
			End If
		End If
		If o5 <> 0 Then
			strSQL = "select * from DIAGRAMA where procedimiento='" & gNomProcCorto & "' and orden_n1=" & o1 & "and orden_n2=" & o2 & " and orden_n3=" & o3 & " and orden_n4=" & o4 & " and orden_n5=" & o5
			rstAux = mfRecordset(conPasarela, strSQL)
			If Not rstAux.EOF Then
				strRuta = strRuta & "-" & rstAux.Fields("NOMBRE").Value
			End If
		End If
		
		If Not rstAux2.EOF Then
			strRuta = strRuta & " en la acción " & rstAux2.Fields("NOMBRE_CM").Value
		End If
		mfObtieneRuta = strRuta
		Exit Function
procErr: 
		
	End Function
	
	
	Private Sub msEnlaces_sin_Definir()
		
		Dim strSQL As String
		Dim strSaltIn As String
		Dim strIDE As String
		Dim strEn As String
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux4B As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim rstAux7 As ADODB.Recordset
		Dim rstAUX8 As ADODB.Recordset
		Dim rstAUX9 As ADODB.Recordset
		Dim numconectoresvalidos As Integer
		Dim lngIDESD As Integer
		Dim strIDESD As Integer
		Dim blnEncon As Boolean
		Dim rstCOM1 As ADODB.Recordset
		Dim rstCOM2 As ADODB.Recordset
		Dim blnForzar As Boolean
		'aketza 27/08/2007
		Dim strParametroAnterior As String
		Dim blnRepetido As Boolean
		'fin aketza
		' cambios 11/2007
		Dim blnVarios As Boolean
		Dim lngSeq As Integer
		Dim blnSEQ As Integer
		Dim blnen As Boolean
		'****
		
		On Error GoTo procErr
		strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='ENLACE SIN DEFINIR' order by orden_n1, orden_n2, orden_n3, orden_n4, orden_n5, orden_acc"
		rstAux = mfRecordset(conPasarela, strSQL)
		While Not rstAux.EOF
			strSeg = rstAux.Fields("ORDEN_N1").Value & "/" & rstAux.Fields("ORDEN_N2").Value & "/" & rstAux.Fields("ORDEN_N3").Value & "/" & rstAux.Fields("ORDEN_N4").Value & "/" & rstAux.Fields("ORDEN_N5").Value
			'Debug.Print rstAux("PARAMETRO") & "-" & rstAux("ORDEN_N1") & "-" & rstAux("ORDEN_N2") & "-" & rstAux("ORDEN_N3")
			'aketza 27/08/2007
			blnRepetido = False
			If rstAux.Fields("Parametro").Value = strParametroAnterior Then
				blnRepetido = True
			End If
			strParametroAnterior = rstAux.Fields("Parametro").Value
			'fin aketza
			strIDE = "0"
			'CAMBIOS 11/20007
			If blnVarios = True Then
				strSQL = "select * from acciones_di where procedimiento='" & gNomProcCorto & "' and orden_n1=" & rstAux.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux.Fields("ORDEN_N4").Value & " and orden_n5=" & rstAux.Fields("ORDEN_N5").Value & "  and orden_acc<=" & rstAux.Fields("ORDEN_ACC").Value & " order by orden_acc desc"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				Do While Not rstAux2.EOF
					'UPGRADE_WARNING: Use of Null/IsNull() detected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="2EED02CB-5C0E-4DC1-AE94-4FAA3A30F51A"'
					If rstAux2.Fields("NUM_SEQ").Value Is System.DBNull.Value Or rstAux2.Fields("NUM_SEQ").Value <> 0 Then
						System.Windows.Forms.Application.DoEvents()
						strSQL = "select * from conector_acc where procedimiento='" & gNomProcCorto & "'  and num_seq_desde=" & rstAux2.Fields("NUM_SEQ").Value & " and ind_salida_tram='S' and di_id=" & rstAux2.Fields("DI_ID").Value
						rstAux2 = mfRecordset(conPasarela, strSQL)
						If Not rstAux2.EOF Then
							If lngSeq = rstAux2.Fields("NUM_SEQ_HASTA").Value Then
								'A ACTUALIZAR COMO UN LOCO
								strSQL = "UPDATE PARAM_ACC SET VALOR='" & strSaltIn & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
								'aketza 17/04/2008
								strSQL = strSQL & " AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
								'fin aketza
								mfExecute(conPasarela, strSQL)
								GoTo aca
							End If
						End If
						Exit Do
					End If
					rstAux2.MoveNext()
				Loop 
			End If
			'********
			blnForzar = False
			numconectoresvalidos = 0
			'UPGRADE_NOTE: Object rstAux7 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rstAux7 = Nothing
			'UPGRADE_NOTE: Object rstAUX8 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
			rstAUX8 = Nothing
			strSaltIn = ""
			'Inicio Jonathan Prieto 08/08/2012: Simplificar la consulta de salidas del trámite, eliminando duplicados
			'strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='" & rstAux("PARAMETRO") & "'"
			strSQL = "SELECT DISTINCT(VALOR) FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			'Fin Jonathan Prieto 08/08/2012
			strEn = ""
			While Not rstAux2.EOF
				If rstAux2.Fields("VALOR").Value <> "ENLACE SIN DEFINIR" Then
					'aketza 27/08/2007
					'If blnRepetido = False Then
					'fin aketza
					strEn = strEn & rstAux2.Fields("VALOR").Value & ","
					'aketza 27/08/2007
					'End If
					'fin aketza
				End If
				rstAux2.MoveNext()
			End While
			strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
			strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
			strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
			rstAux3 = mfRecordset(conPasarela, strSQL)
			If rstAux3.Fields("NUM_DIAGRAMA").Value = 1 Then
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR NOT IN ('Fin de plazo 2') AND NUM=" & rstAux3.Fields("NUM_DIAGRAMA").Value & " AND CAT_CONECTOR <>'Conector Opcional' AND ORDEN_N1= 0 ORDER BY NUM_SEC_HASTA DESC"
			ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 2 Then 
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR NOT IN ('Fin de plazo 2') AND NUM=" & rstAux3.Fields("NUM_DIAGRAMA").Value & " AND CAT_CONECTOR <>'Conector Opcional' AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " ORDER BY NUM_SEC_HASTA DESC"
			ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 3 Then 
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR NOT IN ('Fin de plazo 2') AND NUM=" & rstAux3.Fields("NUM_DIAGRAMA").Value & " AND CAT_CONECTOR <>'Conector Opcional' AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux3.Fields("ORDEN_N2").Value & " ORDER BY NUM_SEC_HASTA DESC"
			ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 4 Then 
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR NOT IN ('Fin de plazo 2') AND NUM=" & rstAux3.Fields("NUM_DIAGRAMA").Value & " AND CAT_CONECTOR <>'Conector Opcional' AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " ORDER BY NUM_SEC_HASTA DESC"
				'##  DS66 03/07/09 No estaba contemplado el caso q fuera =5
			ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 5 Then 
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR NOT IN ('Fin de plazo 2') AND NUM=" & rstAux3.Fields("NUM_DIAGRAMA").Value & " AND CAT_CONECTOR <>'Conector Opcional' AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2= " & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux3.Fields("ORDEN_N4").Value & " ORDER BY NUM_SEC_HASTA DESC"
				'##
			End If
			rstAux4 = mfRecordset(conPasarela, strSQL)
			While Not rstAux4.EOF
				If rstAux3.Fields("NUM_DIAGRAMA").Value = 1 Then
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ID_PADRE=" & rstAux4.Fields("DIAGRAMA").Value & " AND "
					strSQL = strSQL & "NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA= " & rstAux4.Fields("NUM").Value
				ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 2 Then 
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ID_PADRE=" & rstAux4.Fields("DIAGRAMA").Value & " AND "
					strSQL = strSQL & "NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA= " & rstAux4.Fields("NUM").Value
					strSQL = strSQL & " AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value
				ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 3 Then 
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ID_PADRE=" & rstAux4.Fields("DIAGRAMA").Value & " AND "
					strSQL = strSQL & "NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA= " & rstAux4.Fields("NUM").Value
					strSQL = strSQL & " AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value
				ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 4 Then 
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ID_PADRE=" & rstAux4.Fields("DIAGRAMA").Value & " AND "
					strSQL = strSQL & "NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA= " & rstAux4.Fields("NUM").Value
					strSQL = strSQL & " AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstAux4.Fields("ORDEN_N3").Value
				ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 5 Then 
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ID_PADRE=" & rstAux4.Fields("DIAGRAMA").Value & " AND "
					strSQL = strSQL & "NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA= " & rstAux4.Fields("NUM").Value
					strSQL = strSQL & " AND ORDEN_N1=" & rstAux4.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux4.Fields("ORDEN_N2").Value & " AND ORDEN_N3 = " & rstAux4.Fields("ORDEN_N3").Value & " AND ORDEN_N4= " & rstAux4.Fields("ORDEN_N4").Value
				End If
				rstAux5 = mfRecordset(conPasarela, strSQL)
				If Not rstAux5.EOF Then
					numconectoresvalidos = numconectoresvalidos + 1
					strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND "
					strSQL = strSQL & "ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND "
					strSQL = strSQL & "ORDEN_N4=" & rstAux5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux5.Fields("ORDEN_N5").Value
					rstAux6 = mfRecordset(conPasarela, strSQL)
					strSaltIn = rstAux6.Fields("NOM_DIAGRAMA").Value
					If strSaltIn = "" Then
						If rstAux5.Fields("ORDEN_N2").Value = 0 Then
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux5.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstAux5.Fields("ORDEN_N3").Value = 0 Then 
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux5.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstAux5.Fields("ORDEN_N4").Value = 0 Then 
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux5.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						ElseIf rstAux5.Fields("ORDEN_N5").Value = 0 Then 
							strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux5.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						rstAux7 = mfRecordset(conPasarela, strSQL)
						Do While Not rstAux7.EOF
							If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
								strSaltIn = rstAux7.Fields("NOM_DIAGRAMA").Value
								Exit Do
							End If
							rstAux7.MoveNext()
							strSaltIn = "PR_FINEXPEDIENTE"
						Loop 
					Else
						If rstAux5.Fields("EXPLOTA_ACC").Value = "N" Then strSaltIn = ""
					End If
				Else
					If RTrim(UCase(rstAux4.Fields("CAT_CONECTOR2").Value)) = "FIN DE EXPEDIENTE" Then
						strSaltIn = "PR_FINEXPEDIENTE"
						If rstAux4.AbsolutePosition = rstAux4.RecordCount Then
							blnForzar = True
						End If
					End If
					'aketza 29/04/2008
					'If RTrim(UCase(rstAux4("CAT_CONECTOR2"))) = "FIN DE ASUNTO" Then
					If RTrim(UCase(rstAux4.Fields("CAT_CONECTOR2").Value)) = "FIN DE ASUNTO" Or RTrim(UCase(rstAux4.Fields("CAT_CONECTOR2").Value)) = "FIN ASUNTO" Then
						'fin aketza
						strSaltIn = "PR_FINEXPEDIENTE"
						blnForzar = False
					End If
					'Inicio Jonathan Prieto 08/08/2012: buscamos si algún conector de salida del nivel superior apunta a un Fin Expediente
					If rstAux3.Fields("NUM_DIAGRAMA").Value = 2 Then
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & ") AND NUM_SEC_DESDE in (SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & ") and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') and CAT_CONECTOR2='Fin de Expediente' "
					ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 3 Then 
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux3.Fields("ORDEN_N2").Value & ") AND NUM_SEC_DESDE in (SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') and CAT_CONECTOR2='Fin de Expediente' and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value
					ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 4 Then 
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux3.Fields("ORDEN_N3").Value & ") AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " ) and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') and CAT_CONECTOR2='Fin de Expediente' AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value
					ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 5 Then 
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux3.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux3.Fields("ORDEN_N4").Value & ") AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux3.Fields("ORDEN_N4").Value & " ) and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') and CAT_CONECTOR2='Fin de Expediente' AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value
					End If
					rstAux6 = mfRecordset(conPasarela, strSQL)
					If rstAux6.RecordCount >= 1 Then
						strSaltIn = "PR_FINEXPEDIENTE"
						GoTo CompruebaYaExiste
					End If
					'Fin Jonathan Prieto 08/08/2012
					If rstAux3.Fields("NUM_DIAGRAMA").Value = 2 Then
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & ") AND NUM_SEC_DESDE in (SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & ") and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') and CAT_CONECTOR2='' "
					ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 3 Then 
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and orden_n2=" & rstAux3.Fields("ORDEN_N2").Value & ") AND NUM_SEC_DESDE in (SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value
					ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 4 Then 
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux3.Fields("ORDEN_N3").Value & ") AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " ) and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value
						'Inicio Jonathan Prieto 29/10/2010 - No contemplado el caso de Nivel 5
					ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 5 Then 
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux3.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux3.Fields("ORDEN_N4").Value & ") AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux3.Fields("ORDEN_N4").Value & " ) and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2') AND ORDEN_N1= " & rstAux3.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value
						'Fin Jonathan Prieto 29/10/2010
					End If
					rstAux6 = mfRecordset(conPasarela, strSQL)
					If rstAux6.State = ADODB.ObjectStateEnum.adStateClosed Then GoTo SIG
					'IGOR JULIO 2008
					'If rstAux6.EOF Then strSaltIn = "PR_FINEXPEDIENTE"
					
					Do While Not rstAux6.EOF
						If rstAux6.Fields("NUM").Value > 1 Then
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux6.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux6.Fields("NUM_SEC_HASTA").Value & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value
							If Val(rstAux6.Fields("ORDEN_N2").Value) > 0 Then
								strSQL = strSQL & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value
							End If
							If Val(rstAux6.Fields("ORDEN_N3").Value) > 0 Then
								strSQL = strSQL & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value
							End If
							If Val(rstAux6.Fields("ORDEN_N4").Value) > 0 Then
								strSQL = strSQL & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value
							End If
						Else
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux6.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux6.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=1"
						End If
						rstAUX8 = mfRecordset(conPasarela, strSQL)
						If rstAUX8.EOF = False Then
							If InStr(1, strIDE, "-" & rstAux6.Fields("NUM_SEC_HASTA").Value) > 0 Then
								strIDE = strIDE & "-" & rstAux6.Fields("NUM_SEC_HASTA").Value
							Else
								strIDE = strIDE & "-" & rstAux6.Fields("NUM_SEC_HASTA").Value
								Exit Do
							End If
						End If
vuelta1: 
						rstAux6.MoveNext()
					Loop 
					If Not rstAUX8 Is Nothing Then
						If Not rstAUX8.EOF Then
							If rstAUX8.Fields("ORDEN_N2").Value = 0 Then
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 >=" & rstAUX8.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstAUX8.Fields("ORDEN_N3").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX8.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAUX8.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstAUX8.Fields("ORDEN_N4").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX8.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAUX8.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAUX8.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							ElseIf rstAUX8.Fields("ORDEN_N5").Value = 0 Then 
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX8.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAUX8.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAUX8.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAUX8.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
							End If
							rstAux7 = mfRecordset(conPasarela, strSQL)
							Do While Not rstAux7.EOF
								If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
									strSaltIn = rstAux7.Fields("NOM_DIAGRAMA").Value
									'aketza 23/08/2007
									'fin aketza
									Exit Do
								End If
								rstAux7.MoveNext()
								strSaltIn = "PR_FINEXPEDIENTE"
							Loop 
						Else
							'un nivel superior
							If rstAux3.Fields("NUM_DIAGRAMA").Value = 2 Then
								strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2= 0 ) AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=0) and CAT_CONECTOR =''"
							ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 3 Then 
								strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2= 0 ) AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=0) and CAT_CONECTOR =''"
								'Inicio Jonathan Prieto 31/01/2011: No tenía tratamiento para un trámite de nivel 5, que debe ir a buscar al nivel 3 cuando sube otro nivel superior
							ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 4 Then 
								strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N2").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N2").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") and CAT_CONECTOR =''"
							Else
								strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N3").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " and ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & ") AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N3").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & " and ORDEN_N3=" & rstAux3.Fields("ORDEN_N3").Value & ") and CAT_CONECTOR =''"
							End If
							'Fin Jonathan Prieto 31/01/2011
							rstAux6 = mfRecordset(conPasarela, strSQL)
							If rstAux6.EOF Then
								'Inicio Jonathan Prieto 31/01/2011: No tenía tratamiento para un trámite de nivel 5, que debe ir a buscar al nivel 2 cuando no ha encontrado en el nivel 3
								If rstAux3.Fields("NUM_DIAGRAMA").Value = 3 Then
									strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2= 0 ) AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=0) and CAT_CONECTOR ='Conector Opcional'"
								ElseIf rstAux3.Fields("NUM_DIAGRAMA").Value = 4 Then 
									strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2= 0 ) AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=0) and CAT_CONECTOR ='Conector Opcional'"
								Else
									strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N2").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_DIAG_N2").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") and CAT_CONECTOR ='Conector Opcional'"
								End If
								'Fin Jonathan Prieto 31/01/2011
								rstAux6 = mfRecordset(conPasarela, strSQL)
							End If
							Do While Not rstAux6.EOF
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux6.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux6.Fields("NUM_SEC_HASTA").Value
								rstAux7 = mfRecordset(conPasarela, strSQL)
								If rstAux7.EOF = False Then
									Exit Do
								End If
								rstAux6.MoveNext()
							Loop 
							If Not rstAux7 Is Nothing Then
								If Not rstAux7.EOF Then
									If rstAux7.Fields("ORDEN_N2").Value = 0 Then
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux7.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux7.Fields("ORDEN_N3").Value = 0 Then 
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux7.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux7.Fields("ORDEN_N4").Value = 0 Then 
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux7.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux7.Fields("ORDEN_N5").Value = 0 Then 
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux7.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									End If
									rstAux7 = mfRecordset(conPasarela, strSQL)
									Do While Not rstAux7.EOF
										If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
											strSaltIn = rstAux7.Fields("NOM_DIAGRAMA").Value
											Exit Do
										End If
										rstAux7.MoveNext()
										strSaltIn = "PR_FINEXPEDIENTE"
									Loop 
								Else
									strSaltIn = "PR_FINEXPEDIENTE"
								End If
							End If
						End If
					End If
				End If
				'Inicio Jonathan Prieto 08/08/2012
CompruebaYaExiste: 
				'Fin Jonathan Prieto 08/08/2012
				If InStr(1, strEn, strSaltIn) = 0 And (strEn <> "" Or strSaltIn <> "") Then
					blnEncon = False
				Else
					'Inicio Jonathan Prieto 09/02/2011: puede que deba tener la misma salida que otro enlace del mismo trámite
					If strSaltIn <> "" Then
						If msMismoEnlaceSinDefinir(rstAux, rstAux3, rstAux.Fields("ORDEN_ACC").Value, strSaltIn, False) = True Then
							blnEncon = False
						Else
							blnEncon = True
						End If
					Else
						If blnForzar = False Then
							blnEncon = True
						Else
							blnEncon = False
						End If
					End If
					'Fin Jonathan Prieto 09/02/2011
				End If
				
				If blnEncon = False Then
					'comprobación de salto correcto
					If Not rstAUX8 Is Nothing Then
						If Not rstAUX8.EOF Then
							strSQL = "SELECT A.EV_ID FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND "
							strSQL = strSQL & "D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND "
							strSQL = strSQL & "E.ANO_ID=" & rstAUX8.Fields("ID_DIAGRAMA").Value & " and  e.di_name='" & rstAUX8.Fields("NOMBRE").Value & "'"
							'**** NUEVO SD ENERO'08
							strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
							strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
							'****
							'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
							strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
							'Fin Jonathan Prieto 28/10/2010
							strSQL = strSQL & " order by D.SH_Y DESC"
							
							rstCOM1 = mfRecordset(conDP4, strSQL)
							If InStr(1, rstAux6.Source, "PROPIEDADES_DI") = 0 Then
								If Not rstAux6.EOF Then
									strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux6.Fields("DI_ID").Value & " AND NUM_SEQ=" & rstAux6.Fields("NUM_SEC_DESDE").Value
									rstCOM2 = mfRecordset(conPasarela, strSQL)
									If Not rstCOM2.EOF Then
										strSQL = "SELECT A.EV_ID,A.EV_NAME FROM EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND "
										strSQL = strSQL & "D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND "
										strSQL = strSQL & "E.ANO_ID=" & rstCOM2.Fields("ID_DIAGRAMA").Value & " and  e.di_name='" & rstCOM2.Fields("NOMBRE").Value & "'"
										' **** NUEVO SD ENERO'08
										strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
										strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
										strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
										'Fin Jonathan Prieto 28/10/2010
										strSQL = strSQL & " order by D.SH_Y ASC"
										rstCOM2 = mfRecordset(conDP4, strSQL)
										If Not rstCOM1.EOF Then
											'CAMBIOS 11/20007
											blnen = False
											Do While Not rstCOM2.EOF
												If rstCOM2.Fields(0).Value = rstCOM1.Fields(0).Value Then
													If Not rstAux6.EOF Then
														'octubre 2007
														If rstAux3.Fields("NUM_DIAGRAMA").Value < rstAUX8.Fields("NUM_DIAGRAMA").Value Then
															GoTo vuelta1
														End If
														If Trim(rstCOM2.Fields(1).Value) = "Inicio Fin Plazo" Then
															GoTo vuelta1
														End If
													Else
														blnen = True
														Exit Do
													End If
												End If
												rstCOM2.MoveNext()
											Loop 
											If blnen = False Then
												rstCOM1.MoveNext()
												If Not rstCOM1.EOF Then
													rstCOM2.Requery()
													Do While Not rstCOM2.EOF
														If rstCOM2.Fields(0).Value = rstCOM1.Fields(0).Value Then
															If Not rstAux6.EOF Then
																'octubre 2007
																If Trim(rstCOM2.Fields(1).Value) = "Inicio Fin Plazo" Then
																	GoTo vuelta1
																End If
															Else
																Exit Do
															End If
														End If
														rstCOM2.MoveNext()
													Loop 
												End If
											End If
											'*****
										End If
									End If
								End If
							End If
						End If
					End If
					'''''''''''''''''''''''''''''''
					strSQL = "UPDATE PARAM_ACC SET VALOR='" & strSaltIn & "' "
					strSQL = strSQL & "where PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
					strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
					strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
					'aketza 08/04/2008
					strSQL = strSQL & " AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
					'aketza
					mfExecute(conPasarela, strSQL)
					GoTo aca
				End If
				blnEncon = True
SIG: 
				rstAux4.MoveNext()
			End While
			'''buscamos si hay algun conector que salga del objeto continente
			
			If numconectoresvalidos = 1 Or numconectoresvalidos = 2 Then
				strSQL = "SELECT * FROM DIAGRAMA WHERE procedimiento='" & gNomProcCorto & "' and ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value
				rstAux2 = mfRecordset(conPasarela, strSQL)
				If Not rstAux2.EOF Then
					strSQL = "SELECT * FROM CONECTORES_DI WHERE procedimiento='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux2.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux2.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
					rstAux2 = mfRecordset(conPasarela, strSQL)
					If rstAux2.RecordCount = 0 Then
						strSaltIn = "PR_FINEXPEDIENTE"
						GoTo aca2
					ElseIf rstAux2.Fields("CAT_CONECTOR2").Value = "Fin de Expediente" Then 
						strSaltIn = "PR_FINEXPEDIENTE"
						GoTo aca2
					End If
				End If
			End If
			'''buscamos los conectores que van a procesos... si solo es uno, actualizamos directamente y santas pascuas
			If numconectoresvalidos = 1 Then
				If rstAux.Fields(4).Value = 0 And rstAux.Fields(3).Value <> 0 And rstAux.Fields(2).Value <> 0 Then If strSaltIn = "" Then strSaltIn = "PR_FINEXPEDIENTE"
				strSQL = "UPDATE PARAM_ACC SET VALOR='" & strSaltIn & "' " & "where PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND " & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND " & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND " & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND " & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND " & "ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
				'aketza 17/04/2008
				strSQL = strSQL & " AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
				'fin aketza
				mfExecute(conPasarela, strSQL)
				blnEncon = False
			End If
			If blnEncon = True Then
				strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "' "
				strSQL = strSQL & "and orden_acc in (SELECT ORDEN_ACC FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION LIKE"
				strSQL = strSQL & "(SELECT top 1 SUBSTRING(NOM_ACCION,1,LEN(NOM_ACCION)-2) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " and orden_n3=" & rstAux.Fields("ORDEN_N3").Value & " and orden_n4=" & rstAux.Fields("ORDEN_N4").Value & " and orden_n5=" & rstAux.Fields("ORDEN_N5").Value & ")+ '%' )"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				strEn = ""
				While Not rstAux2.EOF
					If rstAux2.Fields("VALOR").Value <> "ENLACE SIN DEFINIR" Then
						strEn = strEn & rstAux2.Fields("VALOR").Value & ","
					End If
					rstAux2.MoveNext()
				End While
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
				strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND "
				strSQL = strSQL & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
				rstAux3 = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND "
				strSQL = strSQL & "NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR NOT IN ('Fin de plazo 2') AND "
				strSQL = strSQL & "CAT_CONECTOR <>'Conector Opcional'" & IIf(rstAux3.Fields("NUM_DIAGRAMA").Value > 1, " AND ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value, "")
				rstAux4 = mfRecordset(conPasarela, strSQL)
				While Not rstAux4.EOF
					strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux4.Fields("DIAGRAMA").Value & " AND "
					strSQL = strSQL & "NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value
					rstAux5 = mfRecordset(conPasarela, strSQL)
					If Not rstAux5.EOF Then
						strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND "
						strSQL = strSQL & "ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND "
						strSQL = strSQL & "ORDEN_N4=" & rstAux5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux5.Fields("ORDEN_N5").Value
						rstAux6 = mfRecordset(conPasarela, strSQL)
						strSaltIn = rstAux6.Fields("NOM_DIAGRAMA").Value
					Else
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=(SELECT DISTINCT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") AND NUM_SEC_DESDE IN(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value & " and ORDEN_N2=" & rstAux3.Fields("ORDEN_N2").Value & ") and CAT_CONECTOR NOT IN ('Conector Opcional','Fin de plazo 2')"
						rstAux6 = mfRecordset(conPasarela, strSQL)
						Do While Not rstAux6.EOF
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux6.Fields("DIAGRAMA").Value & " AND "
							strSQL = strSQL & "NUM_SEQ=" & rstAux6.Fields("NUM_SEC_HASTA").Value
							rstAux7 = mfRecordset(conPasarela, strSQL)
							If rstAux7.EOF = False Then
								Exit Do
							End If
							rstAux6.MoveNext()
						Loop 
						If Not rstAux7 Is Nothing Then
							If Not rstAux7.EOF Then
								'*PENDIENTE
								If rstAux7.Fields("ORDEN_N2").Value = 0 Then
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux7.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								ElseIf rstAux7.Fields("ORDEN_N3").Value = 0 Then 
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux7.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								ElseIf rstAux7.Fields("ORDEN_N4").Value = 0 Then 
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux7.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								ElseIf rstAux7.Fields("ORDEN_N5").Value = 0 Then 
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux7.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								Else
									strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4 =" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >=" & rstAux7.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
								End If
								rstAux7 = mfRecordset(conPasarela, strSQL)
								Do While Not rstAux7.EOF
									If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
										strSaltIn = rstAux7.Fields("NOM_DIAGRAMA").Value
										Exit Do
									End If
									rstAux7.MoveNext()
									strSaltIn = "PR_FINEXPEDIENTE"
								Loop 
							Else
								strSaltIn = "PR_FINEXPEDIENTE"
							End If
						Else
							strSaltIn = "PR_FINEXPEDIENTE"
						End If
					End If
					If InStr(1, strEn, strSaltIn) = 0 Then
						blnEncon = False
					Else
						blnEncon = True
					End If
					If blnEncon = False And strSaltIn <> "" Then
aca2: 
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strSaltIn & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
						strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
						strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
						'aketza 17/04/2008
						strSQL = strSQL & " AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
						'fin aketza
						mfExecute(conPasarela, strSQL)
						GoTo aca
					End If
					blnEncon = True
					If strSaltIn = "" Then
						'''''''''''''''
						strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
						rstAux2 = mfRecordset(conPasarela, strSQL)
						strEn = ""
						While Not rstAux2.EOF
							If rstAux2.Fields("VALOR").Value <> "ENLACE SIN DEFINIR" Then
								strEn = strEn & rstAux2.Fields("VALOR").Value & ","
							End If
							rstAux2.MoveNext()
						End While
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
						rstAux3 = mfRecordset(conPasarela, strSQL)
						strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND NUM=" & rstAux3.Fields("NUM_DIAGRAMA").Value
						rstAux4B = mfRecordset(conPasarela, strSQL)
						While Not rstAux4B.EOF
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_PADRE=" & rstAux4B.Fields("DIAGRAMA").Value & " AND NUM_SEQ=" & rstAux4B.Fields("NUM_SEC_HASTA").Value & " AND NUM_DIAGRAMA=" & rstAux4B.Fields("NUM").Value
							rstAux5 = mfRecordset(conPasarela, strSQL)
							If Not rstAux5.EOF Then
								strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux5.Fields("ORDEN_N5").Value
								rstAux6 = mfRecordset(conPasarela, strSQL)
								strSaltIn = rstAux6.Fields("NOM_DIAGRAMA").Value
								If strSaltIn = "" Then
									If rstAux5.Fields("ORDEN_N2").Value = 0 Then
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux5.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux5.Fields("ORDEN_N3").Value = 0 Then 
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 >= " & rstAux5.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux5.Fields("ORDEN_N4").Value = 0 Then 
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux5.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstAux5.Fields("ORDEN_N5").Value = 0 Then 
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux5.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									End If
									rstAux7 = mfRecordset(conPasarela, strSQL)
									Do While Not rstAux7.EOF
										If rstAux7.Fields("NOM_DIAGRAMA").Value <> "" Then
											strSaltIn = rstAux7.Fields("NOM_DIAGRAMA").Value
											Exit Do
										End If
										rstAux7.MoveNext()
										strSaltIn = "PR_FINEXPEDIENTE"
									Loop 
								Else
									If rstAux5.Fields("EXPLOTA_ACC").Value = "N" Then strSaltIn = ""
								End If
								If InStr(1, strEn, strSaltIn) = 0 Then
									blnEncon = False
								Else
									blnEncon = True
								End If
								If blnEncon = False Then
									strSQL = "UPDATE PARAM_ACC SET VALOR='" & strSaltIn & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
									'aketza 17/04/2008
									strSQL = strSQL & " AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
									'fin aketza
									mfExecute(conPasarela, strSQL)
									GoTo aca
								End If
								blnEncon = True
							End If
							rstAux4B.MoveNext()
						End While
					Else
						''''''''''''''''''''''''''MUCHO CUIDADO
						
					End If
					''''''''''''
					rstAux4.MoveNext()
				End While
			End If
			'SI NO LO ENCUENTRO TENGO QUE BAJAR A NIVEL DE ACCION
			If blnEncon = True Then
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
				strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
				strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND "
				strSQL = strSQL & "ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
				rstAux3 = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PATH_HIDRA LIKE '" & Mid(rstAux3.Fields("PATH_HIDRA").Value, 4, 13) & "%" & Mid(rstAux3.Fields("PATH_HIDRA").Value, 17, 2) & "'"
				rstAux4 = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
				strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND "
				strSQL = strSQL & "ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
				strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND "
				strSQL = strSQL & "ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value
				rstAux5 = mfRecordset(conPasarela, strSQL)
				strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux5.Fields("ID_DIAGRAMA").Value & " And NUM_SEQ_DESDE = " & rstAux5.Fields("NUM_SEQ").Value
				rstAux6 = mfRecordset(conPasarela, strSQL)
				Do While Not rstAux6.EOF
					strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
					strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
					strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND "
					strSQL = strSQL & "NUM_SEQ=" & rstAux6.Fields("NUM_SEQ_HASTA").Value
					rstAux7 = mfRecordset(conPasarela, strSQL)
					If rstAux7.EOF Then
						strSQL = "SELECT * FROM CONECTOR_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux5.Fields("ID_DIAGRAMA").Value & " AND "
						strSQL = strSQL & "NUM_SEQ_DESDE <> " & rstAux6.Fields("NUM_SEQ_DESDE").Value & " AND NUM_SEQ_HASTA=" & rstAux6.Fields("NUM_SEQ_HASTA").Value
						rstAUX8 = mfRecordset(conPasarela, strSQL)
						If Not rstAUX8.EOF Then
							strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND "
							strSQL = strSQL & "NUM_SEQ=" & rstAUX8.Fields("NUM_SEQ_DESDE").Value
							rstAUX9 = mfRecordset(conPasarela, strSQL)
							strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PATH_HIDRA LIKE 'LET" & Mid(rstAUX9.Fields("PATH_HIDRA").Value, 1, 13) & VB.Right(rstAUX9.Fields("PATH_HIDRA").Value, 2) & "%" & "'"
							rstAUX9 = mfRecordset(conPasarela, strSQL)
							strSQL = "SELECT * FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND "
							strSQL = strSQL & "ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND "
							strSQL = strSQL & "ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND "
							strSQL = strSQL & "ORDEN_ACC=" & rstAUX9.Fields("ORDEN_ACC").Value
							rstAUX9 = mfRecordset(conPasarela, strSQL)
							strSaltIn = rstAUX9.Fields("VALOR").Value
						End If
						strSQL = "UPDATE PARAM_ACC SET VALOR='" & strSaltIn & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & rstAux.Fields("ORDEN_ACC").Value
						'aketza 17/04/2008
						strSQL = strSQL & " AND PARAMETRO='" & rstAux.Fields("PARAMETRO").Value & "'"
						'fin aketza
						mfExecute(conPasarela, strSQL)
						Exit Do
					End If
					rstAux6.MoveNext()
				Loop 
			End If
aca: 
			
			rstAux.MoveNext()
		End While
		
		strSQL = "UPDATE PARAM_ACC SET VALOR='PR_FINEXPEDIENTE' where PROCEDIMIENTO='" & gNomProcCorto & "' AND VALOR='ENLACE SIN DEFINIR'"
		mfExecute(conPasarela, strSQL)
		Exit Sub
		
procErr: 
		
		Insertar_Error(Me, "Solución saltos", "La pasarela no ha resuelto los saltos de manera correcta", "msEnlaces_sin_definir" & " -" & strSeg)
		
	End Sub
	
	Private Sub msMetoCaducar()
		
		On Error GoTo proc_ERR
		
		Dim strSQL As String
		Dim strPath As String
		Dim lngORACC As Integer
		Dim lngNumAcc As Integer
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim rstAux7 As ADODB.Recordset
		Dim rstAUX8 As ADODB.Recordset
		Dim rstAUX9 As ADODB.Recordset
		Dim rstAcc As ADODB.Recordset
		'##    DS66 23/02/09
		Dim rstPru As ADODB.Recordset
		'##'''
		Dim blnEncon As Boolean
		Dim nomTramS As String
		
		strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='METOCADUCAR'"
		
		rstAux7 = mfRecordset(conPasarela, strSQL)
		While Not rstAux7.EOF
			strSeg = rstAux7.Fields("ORDEN_N1").Value & "/" & rstAux7.Fields("ORDEN_N2").Value & "/" & rstAux7.Fields("ORDEN_N3").Value & "/" & rstAux7.Fields("ORDEN_N4").Value & "/" & rstAux7.Fields("ORDEN_N5").Value
			blnEncon = False
			'Buscamos todas las acciones CADUCAREXPEDIENTE del mismo trámite donde se encuentra METOCADUCAR
			strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value
			strSQL = strSQL & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value
			strSQL = strSQL & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value
			strSQL = strSQL & " AND NOM_ACCION='CADUCAREXPEDIENTE'"
			rstAux = mfRecordset(conPasarela, strSQL)
			If rstAux.EOF = True Then
				'No tiene ninguna acción CADUCAREXPEDIENTE, obtenemos todas las acciones del trámite en orden descendente
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value
				strSQL = strSQL & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value
				strSQL = strSQL & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value
				strSQL = strSQL & " ORDER BY ORDEN_ACC DESC"
				rstAux = mfRecordset(conPasarela, strSQL)
				'Identificamos cual será el siguiente ORDEN_ACC del trámite
				lngORACC = rstAux.Fields("ORDEN_ACC").Value + 1
			Else
				strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC >= " & rstAux.Fields("ORDEN_ACC").Value & " AND "
				strSQL = strSQL & "ORDEN_N1=" & rstAux.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux.Fields("ORDEN_N2").Value
				strSQL = strSQL & " AND ORDEN_N3=" & rstAux.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux.Fields("ORDEN_N4").Value
				strSQL = strSQL & " AND ORDEN_N5=" & rstAux.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_ACC DESC"
				rstAux2 = mfRecordset(conPasarela, strSQL)
				While Not rstAux2.EOF
					strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND "
					strSQL = strSQL & "ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND "
					strSQL = strSQL & "ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
					strSQL = strSQL & "ORDEN_ACC=" & rstAux2.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rstAux2.Fields("ORDEN_N1").Value & " AND "
					strSQL = strSQL & "ORDEN_N2=" & rstAux2.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux2.Fields("ORDEN_N3").Value & " AND "
					strSQL = strSQL & "ORDEN_N4=" & rstAux2.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux2.Fields("ORDEN_N5").Value
					mfExecute(conPasarela, strSQL)
					rstAux2.MoveNext()
				End While
				lngORACC = rstAux.Fields("ORDEN_ACC").Value
			End If
			
			'## DS66 23/02/09 Cuando no es Nivel 1
			'If rstAUX7("ORDEN_N2") <> 0 Then
			'##
			'Calculamos cual será la siguiente acción APE_CADUCARTRAMITE e insertamos la acción al final del trámite
			strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CADUCARTRAMITE'"
			rstAux = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAux.Fields(0).Value & "") + 1
			strPath = "APE_CADUCARTRAMITE" & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC, 0, "CADUCARTRAMITE", lngNumAcc, "", strPath, 0, 0, "", "", "")
			blnInserta = True
			'Insertamos los Parámetros de la acción CADUCARTRAMITE
			msInsertaParamAcc("@ORDTRACADUCAR", "", rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC)
			'El ALERTPATH de la alerta del trámite apuntará a la nueva acción CADUCARTRAMITE
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='ALERTPATH' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value
			mfExecute(conPasarela, strSQL)
			'El PATH del IF_CREARALERTA también apuntará a CADUCARTRAMITE
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "'" & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND PARAMETRO='PATH'" & " AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & " (SELECT ORDEN_ACC FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value & " AND PATH_HIDRA LIKE 'IF_CREARALERTA%')"
			mfExecute(conPasarela, strSQL)
			'Insertamos EDP_CADUCARTRAMITE
			lngORACC = lngORACC + 1
			strPath = "EDP_CADUCARTRAMITE" & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC, 0, "ENDPROC", lngNumAcc, "", strPath, 0, 0, "", "", "")
			'Insertamos PRO_CADUCARTRAMITE
			lngORACC = lngORACC + 1
			strPath = "PRO_CADUCARTRAMITE" & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC, 0, "PROCESS", lngNumAcc, "", strPath, 0, 0, "", "", "")
			'El PATHRETORNO de la acción APE_CADUCARTRAMITE apuntará a PRO_CADUCARTRAMITE
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
			strSQL = strSQL & "ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value
			strSQL = strSQL & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value
			strSQL = strSQL & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=" & lngORACC - 2
			mfExecute(conPasarela, strSQL)
			'Obtenemos el valor del ORDENTRA del trámite y updateamos el valor al parámetro ORDTRACADUCAR de APE_CADUCARTRAMITE
			strSQL = "SELECT DISTINCT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@ORDENTRA' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value & " AND (VALOR IS NOT NULL OR VALOR<>'')"
			rstAux2 = mfRecordset(conPasarela, strSQL)
			strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2.Fields("VALOR").Value & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			strSQL = strSQL & "PARAMETRO='@ORDTRACADUCAR' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND "
			strSQL = strSQL & "ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND "
			strSQL = strSQL & "ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value
			mfExecute(conPasarela, strSQL)
			'Insertamos la acción CANCELARFORMULARIO detrás de CADUCARTRAMITE
			lngORACC = lngORACC + 1
			strPath = "APE_CREARALERTA" & VB6.Format(lngNumAcc, "00")
			mfInserta_ACCIONES(rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC, 0, "METERCANCELFORMULARIO", lngNumAcc, "", strPath, 0, 0, "", "", "")
			msInsertaParamAcc("PATH", rstAux2.Fields("VALOR").Value, rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC)
			
			'Inicio Jonathan 11/01/2012: el nuevo tratamiento
			'Insertamos JUMP detrás del CANCELARFORMULARIO
			'Conseguimos el conector tipo Fin Plazo 1 del trámite
			strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND CAT_CONECTOR='Fin de plazo 1' AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND NUM_SEC_DESDE=(SELECT NUM_SEQ FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "'" & " AND ORDEN_N1=" & rstAux7.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux7.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux7.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux7.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux7.Fields("ORDEN_N5").Value & ")"
			rstAux6 = mfRecordset(conPasarela, strSQL)
			If Not rstAux6.EOF Then
				'Buscamos el tipo de objeto al que apunta el conector tipo Fin Plazo 1
				strSQL = "SELECT * FROM SHAPE WHERE MODEL_NAME='" & strModelo & "'" & " AND SH_SEQ=" & rstAux6.Fields("NUM_SEC_HASTA").Value & " AND DI_ID=" & rstAux6.Fields("DI_ID").Value
				rstAUX8 = mfRecordset(conDP4, strSQL)
				If Not rstAUX8.EOF Then
					'Conseguimos el objeto al que apunta el conector tipo Fin Plazo y apuntamos el JUMP a él
					Select Case rstAUX8.Fields("ANO_TABNR").Value
						'
						Case "8953" 'Trámite/Ramificación
							strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAUX8.Fields("ANO_ID").Value
							rstAux6 = mfRecordset(conPasarela, strSQL)
							If Not rstAux6.EOF Then
								If rstAux6.Fields("EXPLOTA_ACC").Value = "S" Then
									'Trámite
									strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
									rstAux6 = mfRecordset(conPasarela, strSQL)
									If Not rstAux6.EOF Then
										nomTramS = rstAux6.Fields("NOM_DIAGRAMA").Value
									End If
								Else
									'Ramificación
									strSQL = "SELECT TOP 1 NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_DIAGRAMA<>''"
									Select Case rstAux6.Fields("NUM_DIAGRAMA").Value
										Case 1
											strSQL = strSQL & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value
										Case 2
											strSQL = strSQL & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value
										Case 3
											strSQL = strSQL & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value
										Case 4
											strSQL = strSQL & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value
										Case 5
											strSQL = strSQL & " AND ORDEN_N1=" & rstAux6.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstAux6.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux6.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstAux6.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rstAux6.Fields("ORDEN_N5").Value
									End Select
									strSQL = strSQL & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									rstAux6 = mfRecordset(conPasarela, strSQL)
									If Not rstAux6.EOF Then
										nomTramS = rstAux6.Fields("NOM_DIAGRAMA").Value
									End If
								End If
							End If
							'
						Case "9097" 'Evento/Resultado
							strSQL = "SELECT * FROM EVENT WHERE MODEL_NAME='" & strModelo & "' AND EV_ID=" & rstAUX8.Fields("ANO_ID").Value
							rstAux6 = mfRecordset(conDP4, strSQL)
							If Not rstAux6.EOF Then
								If UCase(VB.Left(rstAux6.Fields("EV_NAME").Value, 6)) = "INICIO" Then
									'*** Evento de Inicio ***
									nomTramS = "ENLACE SIN DEFINIR"
								Else
									'*** Evento de Fin ***
									nomTramS = "ENLACE SIN DEFINIR"
								End If
							End If
							'
						Case "5257" 'ProcessBreak
							nomTramS = "PR_FINEXPEDIENTE"
					End Select
				End If
			End If
			'Aquí insertamos el JUMP
			strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
			rstAcc = mfRecordset(conPasarela, strSQL)
			lngNumAcc = Val(rstAcc.Fields(0).Value & "") + 1
			lngORACC = lngORACC + 1
			mfInserta_ACCIONES(rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & VB6.Format(lngNumAcc, "00"), 0, 0, "", "", "")
			msInsertaParamAcc("PATH", nomTramS, rstAux7.Fields("ORDEN_N1").Value, rstAux7.Fields("ORDEN_N2").Value, rstAux7.Fields("ORDEN_N3").Value, rstAux7.Fields("ORDEN_N4").Value, rstAux7.Fields("ORDEN_N5").Value, lngORACC)
			
			'Jonathan 11/01/2012: comento lo que existía
			
			'      '## DS66 23/02/09
			'      'End If
			'      '##
			'
			'      'Obtenemos el objeto padre (puede ser una ramificación) del trámite
			'      strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5") & ")"
			'      Set rstAux6 = mfRecordset(conPasarela, strSQL)
			'
			'      '## DS66 23/02/09  Dependiendo si es Nivel 1 o no...cancelar el path del formulario ficticio del tramite que este cancelando el caducar tramite, es decir, el valor del parametro
			'         '@ORGTRACADUC
			'      If rstAUX7("ORDEN_N2") = 0 Then
			'        'Es nivel 1
			'         strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
			'         Set rstAux6 = mfRecordset(conPasarela, strSQL)
			'         strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
			'      Else
			'        'No es nivel 1
			'         If Not rstAux6.EOF Then
			'            'Obtenemos los conectores de salida del objeto padre
			'            strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
			'         Else
			'            strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
			'            Set rstAux6 = mfRecordset(conPasarela, strSQL)
			'            strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
			'         End If
			'      End If
			'      Set rstAUX8 = mfRecordset(conPasarela, strSQL)
			'      While Not rstAUX8.EOF
			'        'Buscamos el que sea tipo Fin Plazo 1
			'         If Trim(rstAUX8("CAT_CONECTOR")) = "Fin de plazo 1" Then
			'            blnEncon = True
			'            Select Case UCase(Trim(Replace(rstAUX8("CAT_CONECTOR2"), " ", "")))
			'               Case "CADUCAREXPEDIENTE"
			'                  lngORACC = lngORACC + 1
			'                  strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CADUCAREXPEDIENTE'"
			'                  Set rstAUX9 = mfRecordset(conPasarela, strSQL)
			'                  lngNumAcc = Val(rstAUX9(0) & "") + 1
			'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "CADUCAREXPEDIENTE", lngNumAcc, "G", "APE_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                  blnInserta = True
			'                  msInsertaParamAcc "", "", rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
			'                  blnInserta = False
			'                  lngORACC = lngORACC + 1
			'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "ENDPROC", lngNumAcc, "", "EDP_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                  lngORACC = lngORACC + 1
			'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "PROCESS", lngNumAcc, "", "PRO_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                  strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00") & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
			'                  strSQL = strSQL & "ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2")
			'                  strSQL = strSQL & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4")
			'                  strSQL = strSQL & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5") & " AND ORDEN_ACC=" & lngORACC - 2
			'                  mfExecute conPasarela, strSQL
			'                  strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
			'                  Set rstAcc = mfRecordset(conPasarela, strSQL)
			'                  lngNumAcc = Val(rstAcc(0) & "") + 1
			'                  lngORACC = lngORACC + 1
			'                  strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," _
			''                     & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
			''                     & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
			''                     & "'" & gNomProcCorto & "'," & rstAUX7("ORDEN_N1") & ", " & rstAUX7("ORDEN_N2") & ", " & rstAUX7("ORDEN_N3") _
			''                     & "," & rstAUX7("ORDEN_N4") & "," & rstAUX7("ORDEN_N5") & "," & lngORACC & "," _
			''                     & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
			'                  mfExecute conPasarela, strSQL
			'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                  blnInserta = False
			'                  msInsertaParamAcc "PATH", "FIN " & Mid(strNombre, 1, lngNombre), rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
			'
			'
			'                  '## DS66 23/02/09 Para Borrar el Jump a PR_FINEXPEDIENTE cuando es Caducar Expediente
			'                  strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
			'                  strSQL = strSQL & "ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND "
			'                  strSQL = strSQL & "ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND "
			'                  strSQL = strSQL & "ORDEN_N5=" & rstAUX7("ORDEN_N5") & " Order By ORDEN_ACC"
			'                  Set rstPru = mfRecordset(conPasarela, strSQL)
			'
			'                  Dim Orden As Integer
			'                  If Not rstPru.EOF Then
			'                     While Not rstPru.EOF
			'                        If rstPru("NOM_ACCION") = "CADUCAREXPEDIENTE" Then
			'                           Orden = rstPru("ORDEN_ACC")
			'                           'Wend
			'                        End If
			'                        rstPru.MoveNext
			'                     Wend
			'
			'                     If Orden > 0 Then
			'                        Dim marc As Boolean
			'                        marc = False
			'                        rstPru.MoveFirst
			'
			'                        While Not rstPru.EOF
			'                           If marc = False Then
			'                              If rstPru("ORDEN_ACC") < Orden And rstPru("NOM_ACCION") = "FINTRAMITE" Then
			'                                 marc = True
			'                              End If
			'                           End If
			'                           If marc = True And rstPru("NOM_ACCION") = "JUMP" And rstPru("ORDEN_ACC") < Orden Then
			'                           'DELETE FROM Store_Information Where store_name = "Los Angeles"
			'                              strSQL = "DELETE FROM ACCIONES_DI WHERE orden_n1=" & rstPru("ORDEN_N1") & " AND orden_n2=" & rstPru("ORDEN_N2") & " AND orden_n3=" & rstPru("ORDEN_N3") & " AND orden_n4=" & rstPru("ORDEN_N4") & " AND orden_n5=" & rstPru("ORDEN_N5") & " AND ORDEN_ACC=" & rstPru("ORDEN_ACC") & " AND NUM_ACCION=" & rstPru("NUM_ACCION")
			'                              mfExecute conPasarela, strSQL
			'                              'Marc = False
			'                           End If
			'                           rstPru.MoveNext
			'                           '## 17/06/09
			'                           marc = False
			'                           '##
			'                        Wend
			'                     End If
			'                  End If
			'                  '##
			'
			'
			'
			'
			'               Case "FINEXPEDIENTE", "FINDEASUNTO"
			'                  lngORACC = lngORACC + 1
			'                  strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='FINEXPEDIENTE'"
			'                  Set rstAUX9 = mfRecordset(conPasarela, strSQL)
			'                  lngNumAcc = Val(rstAUX9(0) & "") + 1
			'                  'ponemos tipo_accion=F en vez de a G
			'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "FINEXPEDIENTE", lngNumAcc, "F", "APE_FINEXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                  blnInserta = True
			'                  msInsertaParamAcc "", "", rstAux("ORDEN_N1"), rstAux("ORDEN_N2"), rstAux("ORDEN_N3"), rstAux("ORDEN_N4"), rstAux("ORDEN_N5"), lngORACC
			'                  'fin aketza
			'                  blnInserta = False
			'                  lngORACC = lngORACC + 1
			'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "ENDPROC", lngNumAcc, "", "EDP_FINEXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                  lngORACC = lngORACC + 1
			'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "PROCESS", lngNumAcc, "", "PRO_FINEXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                  strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_FINEXPEDIENTE" & Format(lngNumAcc, "00") & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
			'                  strSQL = strSQL & "ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2")
			'                  strSQL = strSQL & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4")
			'                  strSQL = strSQL & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
			'                  mfExecute conPasarela, strSQL
			'            End Select
			'         End If
			'         rstAUX8.MoveNext
			'      Wend
			'
			'       If blnEncon = False Then
			'        'Ninguno de los conectores de salida del padre era tipo Fin Plazo 1
			'        'Buscamos si dentro de todo el objeto padre existe un conector de tipo Fin Plazo 1
			'         strSQL = "SELECT * from CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_CONECTOR='Fin de plazo 1' and ORDEN_N1=" & rstAUX7("ORDEN_N1")
			'         Set rstAux = mfRecordset(conPasarela, strSQL)
			'         If rstAux.RecordCount > 0 Then
			'            'Hemos encontrado alguno
			'            strSQL = "SELECT A.EV_ID FROM "
			'            strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
			'            strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
			'            strSQL = strSQL & "D.ANO_TABNR=9097 AND "
			'            strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
			'            strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
			'            strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
			'            strSQL = strSQL & "E.ANO_ID=" & rstAux("DIAGRAMA") & " AND "
			'            strSQL = strSQL & "D.SH_SEQ=" & rstAux("NUM_SEC_HASTA")
			'            strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'            strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
			'            Set rstAUX8 = mfRecordset(conDP4, strSQL)
			'            If rstAUX8.RecordCount > 0 Then
			'               strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=0"
			'               Set rstAux = mfRecordset(conPasarela, strSQL)
			'               If Not rstAux.EOF Then
			'                  strSQL = "SELECT * from CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=0 AND NUM_SEC_DESDE= " & rstAux("NUM_SEQ") & " AND CAT_CONECTOR=''"
			'                  Set rstAux = mfRecordset(conPasarela, strSQL)
			'                  Do While Not rstAux.EOF
			'                     strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA = 1 AND NUM_SEQ=" & rstAux("NUM_SEC_HASTA")
			'                     Set rstAUX9 = mfRecordset(conPasarela, strSQL)
			'                     If Not rstAUX9.EOF Then
			'                        strSQL = "SELECT A.EV_ID FROM "
			'                        strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
			'                        strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
			'                        strSQL = strSQL & "D.ANO_TABNR=9097 AND "
			'                        strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
			'                        strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
			'                        strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
			'                        strSQL = strSQL & "E.ANO_ID=" & rstAUX9("ID_DIAGRAMA") & " AND "
			'                        strSQL = strSQL & "A.EV_ID=" & rstAUX8("EV_ID")
			'                        ' **** NUEVO SD ENERO'08
			'                        strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			'                        strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			'                        strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			'                        strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'                        'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
			'                        strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
			'                        'Fin Jonathan Prieto 28/10/2010
			'                        Set rstAux2 = mfRecordset(conDP4, strSQL)
			'                        If Not rstAux2.EOF Then
			'                        'METO JUMP
			'   '''''''''''''''''''''''''''''''''''''''''''''''''''''''
			'                           strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
			'                           Set rstAcc = mfRecordset(conPasarela, strSQL)
			'                           lngNumAcc = Val(rstAcc(0) & "") + 1
			'                           lngORACC = lngORACC + 1
			'                           mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
			'                           strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=1 AND NUM_SEQ=" & rstAux("NUM_SEC_HASTA")
			'                           Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'                           blnInserta = False
			'                           strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
			'                           Set rstAux2 = mfRecordset(conPasarela, strSQL)
			'                           Do While Not rstAux2.EOF
			'                              If rstAux2("NOM_DIAGRAMA") <> "" Then
			'                                 nomTramS = rstAux2("NOM_DIAGRAMA")
			'                                 Exit Do
			'                              End If
			'                              rstAux2.MoveNext
			'                              nomTramS = "PR_FINEXPEDIENTE"
			'                           Loop
			'                           blnIns = False
			'                           msInsertaParamAcc "PATH", nomTramS, rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
			'
			'   '''''''''''''''''''''''''''''''''''''''''''''''''''''''
			'                           Exit Do
			'                        End If
			'                     End If
			'                     rstAux.MoveNext
			'                  Loop
			'               End If
			'            End If
			'
			'         End If
			'      End If
			'      '****************
			'Fin Jonathan 11/01/2012: comento lo que existía fin
			rstAux7.MoveNext()
		End While
		
		'strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='METOCADUCAR'"
		'strSQL = "UPDATE ACCIONES_DI SET NOM_ACCION='METOCADUCAR' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R("ORDEN_N1") & " AND ORDEN_N2=" & rst1R("ORDEN_N2") & " AND ORDEN_N3=" & rst1R("ORDEN_N3") & " AND ORDEN_N4=" & rst1R("ORDEN_N4") & " AND ORDEN_N5=" & rst1R("ORDEN_N5") & " AND ORDEN_ACC=1"""
		'mfInserta_ACCIONES 4, 0, 0, 0, 0, lngORACC, 0, "METOCADUCAR", lngNumAcc, "", strPathAL, 0, 0, "", "S", ""
		
		GoTo proc_FIN
proc_ERR: 
		Insertar_Error(Me, "Caducidad alertas", "Ha ocurrido un error no controlado", "msMetoCaducar" & " -" & strSeg)
		Resume proc_FIN
proc_FIN: 
		CierraRS(rstAux)
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		CierraRS(rstAux2)
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		CierraRS(rstAux6)
		'UPGRADE_NOTE: Object rstAux6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux6 = Nothing
		CierraRS(rstAux7)
		'UPGRADE_NOTE: Object rstAux7 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux7 = Nothing
		CierraRS(rstAUX8)
		'UPGRADE_NOTE: Object rstAUX8 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAUX8 = Nothing
		CierraRS(rstAUX9)
		'UPGRADE_NOTE: Object rstAUX9 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAUX9 = Nothing
		CierraRS(rstAcc)
		'UPGRADE_NOTE: Object rstAcc may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAcc = Nothing
		
		
		
		
		
		
		
		
		
		
		'
		'On Error GoTo proc_ERR
		'
		'Dim strSQL     As String
		'Dim strPath    As String
		'Dim lngORACC   As Long
		'Dim lngNumAcc  As Long
		'Dim rstAux     As ADODB.Recordset
		'Dim rstAux2    As ADODB.Recordset
		'Dim rstAux6    As ADODB.Recordset
		'Dim rstAUX7    As ADODB.Recordset
		'Dim rstAUX8    As ADODB.Recordset
		'Dim rstAUX9    As ADODB.Recordset
		'Dim rstAcc     As ADODB.Recordset
		''##    DS66 23/02/09
		'Dim rstPru As ADODB.Recordset
		''##'''
		'Dim blnEncon   As Boolean
		'Dim nomTramS   As String
		'
		''## DS66 23/02/09
		'   'strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='METOCADUCAR'"
		'   strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND (NOM_ACCION='METOCADUCAR' OR NOM_ACCION='PCADUCARINCIDENCIA')"
		''##
		'   Set rstAUX7 = mfRecordset(conPasarela, strSQL)
		'   While Not rstAUX7.EOF
		'      blnEncon = False
		'      strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1")
		'      strSQL = strSQL & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3")
		'      strSQL = strSQL & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		'      strSQL = strSQL & " AND NOM_ACCION='CADUCAREXPEDIENTE'"
		'      Set rstAux = mfRecordset(conPasarela, strSQL)
		'      If rstAux.EOF = True Then
		'         strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1")
		'         strSQL = strSQL & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3")
		'         strSQL = strSQL & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		'         strSQL = strSQL & " ORDER BY ORDEN_ACC DESC"
		'         Set rstAux = mfRecordset(conPasarela, strSQL)
		'         lngORACC = rstAux("ORDEN_ACC") + 1
		'      Else
		'         strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC >= " & rstAux("ORDEN_ACC") & " AND "
		'         strSQL = strSQL & "ORDEN_N1=" & rstAux("ORDEN_N1") & " AND ORDEN_N2=" & rstAux("ORDEN_N2")
		'         strSQL = strSQL & " AND ORDEN_N3=" & rstAux("ORDEN_N3") & " AND ORDEN_N4=" & rstAux("ORDEN_N4")
		'         strSQL = strSQL & " AND ORDEN_N5=" & rstAux("ORDEN_N5") & " ORDER BY ORDEN_ACC DESC"
		'         Set rstAux2 = mfRecordset(conPasarela, strSQL)
		'         While Not rstAux2.EOF
		'            strSQL = "UPDATE ACCIONES_DI SET ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
		'            strSQL = strSQL & "ORDEN_ACC=" & rstAux2("ORDEN_ACC") & " AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND "
		'            strSQL = strSQL & "ORDEN_N2=" & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND "
		'            strSQL = strSQL & "ORDEN_N4=" & rstAux2("ORDEN_N4") & " AND ORDEN_N5=" & rstAux2("ORDEN_N5")
		'            mfExecute conPasarela, strSQL
		'            strSQL = "UPDATE PARAM_ACC SET ORDEN_ACC=" & rstAux2("ORDEN_ACC") + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
		'            strSQL = strSQL & "ORDEN_ACC=" & rstAux2("ORDEN_ACC") & " AND ORDEN_N1=" & rstAux2("ORDEN_N1") & " AND "
		'            strSQL = strSQL & "ORDEN_N2=" & rstAux2("ORDEN_N2") & " AND ORDEN_N3=" & rstAux2("ORDEN_N3") & " AND "
		'            strSQL = strSQL & "ORDEN_N4=" & rstAux2("ORDEN_N4") & " AND ORDEN_N5=" & rstAux2("ORDEN_N5")
		'            mfExecute conPasarela, strSQL
		'            rstAux2.MoveNext
		'         Wend
		'         lngORACC = rstAux("ORDEN_ACC")
		'      End If
		'
		'      '## DS66 23/02/09 Cuando no es Nivel 1
		'      If rstAUX7("ORDEN_N2") <> 0 Then
		'      '##
		'
		'         strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CADUCARTRAMITE'"
		'         Set rstAux = mfRecordset(conPasarela, strSQL)
		'         lngNumAcc = Val(rstAux(0) & "") + 1
		'         strPath = "APE_CADUCARTRAMITE" & Format(lngNumAcc, "00")
		'         mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "CADUCARTRAMITE", lngNumAcc, "", strPath, 0, 0, "", "", ""
		'         blnInserta = True
		'         msInsertaParamAcc "@ORDTRACADUCAR", "", rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
		'         ''''UPDATEAR EL ALERTPATH
		'         strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='ALERTPATH' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		'         mfExecute conPasarela, strSQL
		'         lngORACC = lngORACC + 1
		'         strPath = "EDP_CADUCARTRAMITE" & Format(lngNumAcc, "00")
		'         mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "ENDPROC", lngNumAcc, "", strPath, 0, 0, "", "", ""
		'         lngORACC = lngORACC + 1
		'         strPath = "PRO_CADUCARTRAMITE" & Format(lngNumAcc, "00")
		'         mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "PROCESS", lngNumAcc, "", strPath, 0, 0, "", "", ""
		'         strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
		'         strSQL = strSQL & "ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2")
		'         strSQL = strSQL & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4")
		'         strSQL = strSQL & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5") & " AND ORDEN_ACC=" & lngORACC - 2
		'         mfExecute conPasarela, strSQL
		'         strSQL = "SELECT DISTINCT VALOR FROM PARAM_ACC WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@ORDENTRA' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5") & " AND (VALOR IS NOT NULL OR VALOR<>'')"
		'         Set rstAux2 = mfRecordset(conPasarela, strSQL)
		'         strSQL = "UPDATE PARAM_ACC SET VALOR='" & rstAux2("VALOR") & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
		'         strSQL = strSQL & "PARAMETRO='@ORDTRACADUCAR' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND "
		'         strSQL = strSQL & "ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND "
		'         strSQL = strSQL & "ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		'         mfExecute conPasarela, strSQL
		'         'insertar un cancel en el momento de caducar tramite
		'         'este cancel debera cancelar el path del formulario ficticio del tramite que este cancelando el caducar tramite, es decir, el valor del parametro
		'         '@ORGTRACADUCAR
		'         lngORACC = lngORACC + 1
		'         strPath = "APE_CREARALERTA" & Format(lngNumAcc, "00")
		'         mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "METERCANCELFORMULARIO", lngNumAcc, "", strPath, 0, 0, "", "", ""
		'         msInsertaParamAcc "PATH", rstAux2("VALOR"), rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
		'
		'      '## DS66 23/02/09
		'      End If
		'      '##
		'
		'
		'      strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=(SELECT ID_PADRE FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5") & ")"
		'      Set rstAux6 = mfRecordset(conPasarela, strSQL)
		'
		'      '## DS66 23/02/09  Dependiendo si es Nivel 1 o no...
		'      If rstAUX7("ORDEN_N2") = 0 Then
		'         strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		'         Set rstAux6 = mfRecordset(conPasarela, strSQL)
		'         strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
		'      Else
		'         If Not rstAux6.EOF Then
		'            strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
		'         Else
		'            strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		'            Set rstAux6 = mfRecordset(conPasarela, strSQL)
		'            strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
		'         End If
		'      End If
		'      '##
		'
		''      If Not rstAux6.EOF Then
		''         strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
		''      Else
		''         strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		''         Set rstAux6 = mfRecordset(conPasarela, strSQL)
		''         strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEC_DESDE=" & rstAux6("NUM_SEQ") & " AND DIAGRAMA= " & rstAux6("ID_PADRE")
		''      End If
		'
		'      Set rstAUX8 = mfRecordset(conPasarela, strSQL)
		'      While Not rstAUX8.EOF
		'         '##  DS66 23/02/09
		'         'If Trim(rstAUX8("CAT_CONECTOR2")) <> "" And Trim(rstAUX8("CAT_CONECTOR")) = "Fin de plazo 1" Then
		'         If Trim(rstAUX8("CAT_CONECTOR2")) <> "" Then
		'         '##
		'            'CAMBIO 11/2007
		'            blnEncon = True
		'            '*******
		'            Select Case UCase(Trim(Replace(rstAUX8("CAT_CONECTOR2"), " ", "")))
		'               Case "CADUCAREXPEDIENTE"
		'                  lngORACC = lngORACC + 1
		'                  strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='CADUCAREXPEDIENTE'"
		'                  Set rstAUX9 = mfRecordset(conPasarela, strSQL)
		'                  lngNumAcc = Val(rstAUX9(0) & "") + 1
		'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "CADUCAREXPEDIENTE", lngNumAcc, "G", "APE_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                  blnInserta = True
		'                  msInsertaParamAcc "", "", rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
		'                  blnInserta = False
		'                  lngORACC = lngORACC + 1
		'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "ENDPROC", lngNumAcc, "", "EDP_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                  lngORACC = lngORACC + 1
		'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "PROCESS", lngNumAcc, "", "PRO_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                  strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_CADUCAREXPEDIENTE" & Format(lngNumAcc, "00") & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
		'                  strSQL = strSQL & "ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2")
		'                  strSQL = strSQL & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4")
		'                  strSQL = strSQL & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5") & " AND ORDEN_ACC=" & lngORACC - 2
		'                  mfExecute conPasarela, strSQL
		'                  strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
		'                  Set rstAcc = mfRecordset(conPasarela, strSQL)
		'                  lngNumAcc = Val(rstAcc(0) & "") + 1
		'                  lngORACC = lngORACC + 1
		'                  strSQL = "INSERT INTO ACCIONES_DI(PROCEDIMIENTO,ORDEN_N1,ORDEN_N2,ORDEN_N3," _
		''                     & "ORDEN_N4,ORDEN_N5,ORDEN_ACC," _
		''                     & "NOM_ACCION,NUM_ACCION,PATH_HIDRA) VALUES (" _
		''                     & "'" & gNomProcCorto & "'," & rstAUX7("ORDEN_N1") & ", " & rstAUX7("ORDEN_N2") & ", " & rstAUX7("ORDEN_N3") _
		''                     & "," & rstAUX7("ORDEN_N4") & "," & rstAUX7("ORDEN_N5") & "," & lngORACC & "," _
		''                     & "'JUMP'," & lngNumAcc & ",'JUMP" & Format(lngNumAcc, "00") & "' )"
		'                  mfExecute conPasarela, strSQL
		'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                  blnInserta = False
		'                  msInsertaParamAcc "PATH", "FIN " & Mid(strNombre, 1, lngNombre), rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
		'
		'
		'                  '## DS66 23/02/09 Para Borrar el Jump a PR_FINEXPEDIENTE cuando es Caducar Expediente
		'                  strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
		'                  strSQL = strSQL & "ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2") & " AND "
		'                  strSQL = strSQL & "ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4") & " AND "
		'                  strSQL = strSQL & "ORDEN_N5=" & rstAUX7("ORDEN_N5") & " Order By ORDEN_ACC"
		'                  Set rstPru = mfRecordset(conPasarela, strSQL)
		'
		'                  Dim Orden As Integer
		'                  If Not rstPru.EOF Then
		'                     While Not rstPru.EOF
		'                        If rstPru("NOM_ACCION") = "CADUCAREXPEDIENTE" Then
		'                           Orden = rstPru("ORDEN_ACC")
		'                           'Wend
		'                        End If
		'                        rstPru.MoveNext
		'                     Wend
		'
		'                     If Orden > 0 Then
		'                        Dim Marc As Boolean
		'                        Marc = False
		'                        rstPru.MoveFirst
		'
		'                        While Not rstPru.EOF
		'                           If Marc = False Then
		'                              If rstPru("ORDEN_ACC") < Orden And rstPru("NOM_ACCION") = "FINTRAMITE" Then
		'                                 Marc = True
		'                              End If
		'                           End If
		'                           If Marc = True And rstPru("NOM_ACCION") = "JUMP" And rstPru("ORDEN_ACC") < Orden Then
		'                           'DELETE FROM Store_Information Where store_name = "Los Angeles"
		'                              strSQL = "DELETE FROM ACCIONES_DI WHERE orden_n1=" & rstPru("ORDEN_N1") & " AND orden_n2=" & rstPru("ORDEN_N2") & " AND orden_n3=" & rstPru("ORDEN_N3") & " AND orden_n4=" & rstPru("ORDEN_N4") & " AND orden_n5=" & rstPru("ORDEN_N5") & " AND ORDEN_ACC=" & rstPru("ORDEN_ACC") & " AND NUM_ACCION=" & rstPru("NUM_ACCION")
		'                              mfExecute conPasarela, strSQL
		'                           End If
		'                           rstPru.MoveNext
		'                        Wend
		'                     End If
		'
		'                  End If
		'                  '##
		'
		'
		'
		'
		'               Case "FINEXPEDIENTE", "FINDEASUNTO"
		'                  lngORACC = lngORACC + 1
		'                  strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='FINEXPEDIENTE'"
		'                  Set rstAUX9 = mfRecordset(conPasarela, strSQL)
		'                  lngNumAcc = Val(rstAUX9(0) & "") + 1
		'                  'ponemos tipo_accion=F en vez de a G
		'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "FINEXPEDIENTE", lngNumAcc, "F", "APE_FINEXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                  blnInserta = True
		'                  msInsertaParamAcc "", "", rstAux("ORDEN_N1"), rstAux("ORDEN_N2"), rstAux("ORDEN_N3"), rstAux("ORDEN_N4"), rstAux("ORDEN_N5"), lngORACC
		'                  'fin aketza
		'                  blnInserta = False
		'                  lngORACC = lngORACC + 1
		'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "ENDPROC", lngNumAcc, "", "EDP_FINEXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                  lngORACC = lngORACC + 1
		'                  mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "PROCESS", lngNumAcc, "", "PRO_FINEXPEDIENTE" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                  strSQL = "UPDATE PARAM_ACC SET VALOR='PRO_FINEXPEDIENTE" & Format(lngNumAcc, "00") & "' WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and "
		'                  strSQL = strSQL & "ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=" & rstAUX7("ORDEN_N2")
		'                  strSQL = strSQL & " AND ORDEN_N3=" & rstAUX7("ORDEN_N3") & " AND ORDEN_N4=" & rstAUX7("ORDEN_N4")
		'                  strSQL = strSQL & " AND ORDEN_N5=" & rstAUX7("ORDEN_N5")
		'                  mfExecute conPasarela, strSQL
		'            End Select
		'         End If
		'         rstAUX8.MoveNext
		'      Wend
		'      'CAMBIO *11/2007
		'       If blnEncon = False Then
		'
		'         'miro a ver si desde el origen hay un conector de plazo, obtengo su evento, subo un nivel y miro si coincide el  evento
		'         'de alguno de los conectores.
		'         strSQL = "SELECT * from CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND CAT_CONECTOR='Fin de plazo 1' and ORDEN_N1=" & rstAUX7("ORDEN_N1")
		'         Set rstAux = mfRecordset(conPasarela, strSQL)
		'         If rstAux.RecordCount > 0 Then
		'            strSQL = "SELECT A.EV_ID FROM "
		'            strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
		'            strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
		'            strSQL = strSQL & "D.ANO_TABNR=9097 AND "
		'            strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
		'            strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
		'            strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
		'            strSQL = strSQL & "E.ANO_ID=" & rstAux("DIAGRAMA") & " AND "
		'            strSQL = strSQL & "D.SH_SEQ=" & rstAux("NUM_SEC_HASTA")
		'            ' **** NUEVO SD ENERO'08
		'            strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		'            strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		'            strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		'            strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		'            Set rstAUX8 = mfRecordset(conDP4, strSQL)
		'            If rstAUX8.RecordCount > 0 Then
		'               strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAUX7("ORDEN_N1") & " AND ORDEN_N2=0"
		'               Set rstAux = mfRecordset(conPasarela, strSQL)
		'               If Not rstAux.EOF Then
		'                  strSQL = "SELECT * from CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=0 AND NUM_SEC_DESDE= " & rstAux("NUM_SEQ") & " AND CAT_CONECTOR=''"
		'                  Set rstAux = mfRecordset(conPasarela, strSQL)
		'                  Do While Not rstAux.EOF
		'                     strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA = 1 AND NUM_SEQ=" & rstAux("NUM_SEC_HASTA")
		'                     Set rstAUX9 = mfRecordset(conPasarela, strSQL)
		'                     If Not rstAUX9.EOF Then
		'                        strSQL = "SELECT A.EV_ID FROM "
		'                        strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
		'                        strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
		'                        strSQL = strSQL & "D.ANO_TABNR=9097 AND "
		'                        strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
		'                        strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
		'                        strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
		'                        strSQL = strSQL & "E.ANO_ID=" & rstAUX9("ID_DIAGRAMA") & " AND "
		'                        strSQL = strSQL & "A.EV_ID=" & rstAUX8("EV_ID")
		'                        ' **** NUEVO SD ENERO'08
		'                        strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		'                        strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
		'                        strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
		'                        strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		'                        Set rstAux2 = mfRecordset(conDP4, strSQL)
		'                        If Not rstAux2.EOF Then
		'                        'METO JUMP
		'   '''''''''''''''''''''''''''''''''''''''''''''''''''''''
		'                           strSQL = "SELECT MAX(NUM_ACCION) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='JUMP'"
		'                           Set rstAcc = mfRecordset(conPasarela, strSQL)
		'                           lngNumAcc = Val(rstAcc(0) & "") + 1
		'                           lngORACC = lngORACC + 1
		'                           mfInserta_ACCIONES rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC, 0, "JUMP", lngNumAcc, "", "JUMP" & Format(lngNumAcc, "00"), 0, 0, "", "", ""
		'                           strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=1 AND NUM_SEQ=" & rstAux("NUM_SEC_HASTA")
		'                           Set rstAux2 = mfRecordset(conPasarela, strSQL)
		'                           blnInserta = False
		'                           strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux2("ORDEN_N1") & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'                           Set rstAux2 = mfRecordset(conPasarela, strSQL)
		'                           Do While Not rstAux2.EOF
		'                              If rstAux2("NOM_DIAGRAMA") <> "" Then
		'                                 nomTramS = rstAux2("NOM_DIAGRAMA")
		'                                 Exit Do
		'                              End If
		'                              rstAux2.MoveNext
		'                              nomTramS = "PR_FINEXPEDIENTE"
		'                           Loop
		'                           blnIns = False
		'                           msInsertaParamAcc "PATH", nomTramS, rstAUX7("ORDEN_N1"), rstAUX7("ORDEN_N2"), rstAUX7("ORDEN_N3"), rstAUX7("ORDEN_N4"), rstAUX7("ORDEN_N5"), lngORACC
		'
		'   '''''''''''''''''''''''''''''''''''''''''''''''''''''''
		'                           Exit Do
		'                        End If
		'                     End If
		'                     rstAux.MoveNext
		'                  Loop
		'               End If
		'            End If
		'
		'         End If
		'      End If
		'
		'
		'
		'
		'
		'      '****************
		'
		'
		'      rstAUX7.MoveNext
		'   Wend
		'
		'   'strSQL = "SELECT * FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='METOCADUCAR'"
		'   'strSQL = "UPDATE ACCIONES_DI SET NOM_ACCION='METOCADUCAR' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R("ORDEN_N1") & " AND ORDEN_N2=" & rst1R("ORDEN_N2") & " AND ORDEN_N3=" & rst1R("ORDEN_N3") & " AND ORDEN_N4=" & rst1R("ORDEN_N4") & " AND ORDEN_N5=" & rst1R("ORDEN_N5") & " AND ORDEN_ACC=1"""
		'   'mfInserta_ACCIONES 4, 0, 0, 0, 0, lngORACC, 0, "METOCADUCAR", lngNumAcc, "", strPathAL, 0, 0, "", "S", ""
		'
		'GoTo proc_FIN
		'proc_ERR:
		'   Insertar_Error Me, "Caducidad alertas", "Ha ocurrido un error no controlado"
		'   Resume proc_FIN
		'proc_FIN:
		'   CierraRS rstAux
		'   Set rstAux = Nothing
		'   CierraRS rstAux2
		'   Set rstAux2 = Nothing
		'   CierraRS rstAux6
		'   Set rstAux6 = Nothing
		'   CierraRS rstAUX7
		'   Set rstAUX7 = Nothing
		'   CierraRS rstAUX8
		'   Set rstAUX8 = Nothing
		'   CierraRS rstAUX9
		'   Set rstAUX9 = Nothing
		'   CierraRS rstAcc
		'   Set rstAcc = Nothing
		
	End Sub
	
	
	Private Function mfComprobarFDP(ByVal rst1 As ADODB.Recordset, ByVal rst2 As ADODB.Recordset) As Boolean
		'Inicio Jonathan Prieto 07/02/2011: comparo cada evento del trámite (destino) al que apunta el conector, con el evento
		'de salida del trámite (origen) estudiado, si son iguales, el salto deberá apuntar al trámite (destino)
		
		'rst1 es el recordset con los conectores de destino
		'rst2 es el recordset con los conectores del nivel anterior
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rstAux As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim lngDestino As Integer
		Dim lngOrigen As Integer
		
		mfComprobarFDP = False
		strSQL = "SELECT * FROM diagrama WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_DIAGRAMA=" & rst1.Fields("NUM").Value & " AND NUM_SEQ=" & rst1.Fields("NUM_SEC_HASTA").Value
		rstAux = mfRecordset(conPasarela, strSQL)
		If Not rstAux.EOF Then
			strSQL = "SELECT A.EV_ID, D.SH_SEQ FROM  EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND "
			strSQL = strSQL & "D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND "
			strSQL = strSQL & "E.ANO_ID=" & rstAux.Fields("ID_DIAGRAMA").Value & " AND A.EV_NAME like 'Inicio%'"
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
			rstAux2 = mfRecordset(conDP4, strSQL)
			While Not rstAux2.EOF
				lngDestino = rstAux2.Fields("EV_ID").Value
				strSQL = "SELECT A.EV_ID, D.SH_SEQ FROM  EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E WHERE D.ANO_ID=A.EV_ID AND "
				strSQL = strSQL & "D.ANO_TABNR=9097 AND B.OT_NAME='Evento/Resultado' AND E.DI_ID=D.DI_ID AND D.ANO_TABNR=B.OT_ID AND "
				strSQL = strSQL & "E.ANO_ID=" & rst2.Fields("DIAGRAMA").Value & " AND A.EV_ID=" & lngDestino
				strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
				strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
				rstAux3 = mfRecordset(conDP4, strSQL)
				If Not rstAux3.EOF Then
					mfComprobarFDP = True 'Encontrado!!
					GoTo procFin
				End If
				rstAux2.MoveNext()
			End While
		End If
		
		GoTo procFin
procErr: 
		Resume procFin
procFin: 
		'UPGRADE_NOTE: Object rstAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux = Nothing
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		'UPGRADE_NOTE: Object rstAux3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux3 = Nothing
		'Fin Jonathan Prieto 07/02/2011
		
	End Function
	
	Private Function mfMeteOpcionalParaWait(ByVal rst4 As ADODB.Recordset, ByVal rst1R As ADODB.Recordset, ByVal lngWAIT As Integer) As Object
		
		Dim strOrden As String
		Dim strIns_diag As String
		Dim strIns_prop_DI As String
		Dim strIns_Acc_DI As String
		Dim strSel_diag As String
		Dim strSel_prop_DI As String
		Dim strSel_Acc_DI As String
		Dim strSel_Con_DI As String
		Dim strAuxiliar As String
		Dim strSQL As String
		Dim strPath As String
		Dim strValorV As String
		Dim nomVarHN As String
		Dim rst5 As ADODB.Recordset
		Dim rst6 As ADODB.Recordset
		Dim rst7 As ADODB.Recordset
		Dim rstparamHN As ADODB.Recordset
		Dim rstconE As ADODB.Recordset
		Dim rstparamCME As ADODB.Recordset
		Dim lngF As Integer
		Dim lngTDAUT As Integer
		Dim colXML2 As Collection
		Dim colXMLD As Collection
		
		On Error GoTo ERROR_Renamed
		
		colXML2 = New Collection
		colXML2.Add("Valor")
		
		strOrden = "ORDEN_N1,ORDEN_N2,ORDEN_N3,ORDEN_N4,ORDEN_N5"
		strIns_diag = "PROCEDIMIENTO," & strOrden & ",NUM_DIAGRAMA,NOMBRE,EXPLOTA_ACC,ID_DIAGRAMA"
		strIns_prop_DI = "PROCEDIMIENTO," & strOrden & ",NOM_DIAGRAMA,ID_DIAGRAMA"
		strIns_Acc_DI = "PROCEDIMIENTO," & strOrden & ",ORDEN_ACC,NOM_ACCION,NUM_ACCION"
		strSel_diag = strOrden & ",ID_DIAG_N1,ID_DIAG_N2,ID_DIAG_N3,ID_DIAG_N4,ID_DIAG_N5,ID_DIAGRAMA,CAT_DIAGRAMA,ID_PADRE,NUM_DIAGRAMA,EXPLOTA_ACC,NUM_SEQ,INDPARA,INDJUMP,INDCANCEL,NOMBRE,SALIDAS,INDCOMUN,DI_ID"
		strSel_prop_DI = strOrden & ",ID_DIAGRAMA,NOM_DIAGRAMA,TIPO_DIAGRAMA,PLAZTIP1_DI,PLAZTIP2_DI,NIVELTRAM_DI,INDBLOQ_DI,INDRAM_DI,INDPERSINT"
		strSel_Acc_DI = strOrden & ",ORDEN_ACC,ID_ACCION,NOM_ACCION,NUM_ACCION,TIPO_ACCION,PATH_HIDRA,NUM_SEQ,DI_ID,NOMBRE,METOFLY"
		strSel_Con_DI = "ID_CONECTOR,DIAGRAMA,NUM,NUM_SEC_DESDE,NUM_SEC_HASTA,CAT_CONECTOR,CAT_CONECTOR2,DI_ID,ORDEN_N1"
		
		
		
		' str auxiliar para reutilizar codigo (aketza)
		strAuxiliar = " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value
		strSQL = "SELECT PATH_HIDRA FROM ACCIONES_DI " & strAuxiliar & "  AND NOM_ACCION <> 'WAITMOMENTANEO'  and PATH_HIDRA<>'WAIT" & VB6.Format(lngWAIT, "00") & "' ORDER BY ORDEN_ACC ASC"
		rst6 = mfRecordset(conPasarela, strSQL)
		strSQL = "SELECT " & strSel_Acc_DI & " FROM ACCIONES_DI " & strAuxiliar & " ORDER BY ORDEN_ACC DESC"
		rst5 = mfRecordset(conPasarela, strSQL)
		While Not rst5.EOF
			' str auxiliar para reutilizar codigo (aketza)
			strAuxiliar = " SET ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value + 4 & " WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_ACC=" & rst5.Fields("ORDEN_ACC").Value & " AND ORDEN_N1=" & rst5.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst5.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst5.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst5.Fields("ORDEN_N5").Value
			strSQL = "UPDATE ACCIONES_DI " & strAuxiliar
			mfExecute(conPasarela, strSQL)
			strSQL = "UPDATE PARAM_ACC " & strAuxiliar
			mfExecute(conPasarela, strSQL)
			rst5.MoveNext()
		End While
		strSQL = "SELECT FlowOrder From wfFlowActions WHERE (RTRIM(Flow)='TDAUTOMATICA') AND (RTRIM(Action) = 'LABEL') ORDER BY FLOWORDER"
		'Set rst7 = mfRecordset(conInfra, strSQL)
		rst7 = mfRecordset(conGene, strSQL)
		If Not rst7.EOF Then
			lngF = rst7.Fields("FLOWORDER").Value
			rst7.Close()
			strSQL = "SELECT PARAM FROM WFFLOWACTIONS WHERE RTRIM(FLOW)='TDAUTOMATICA' AND PARAM LIKE '@%' AND FLOWORDER = " & lngF & " ORDER BY CONVERT(INT, Id)"
			'Set rstParamHN = mfRecordset(conInfra, strSQL)
			rstparamHN = mfRecordset(conGene, strSQL)
		End If
		strSQL = "SELECT COUNT(*) FROM ACCIONES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NOM_ACCION='TDAUTOMATICA'"
		rst7 = mfRecordset(conPasarela, strSQL)
		lngTDAUT = Val(rst7.Fields(0).Value & "") + 1
		strPath = "APE_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
		strSQL = "INSERT INTO ACCIONES_DI (" & strIns_Acc_DI & ",TIPO_ACCION,PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & "," & rst1R.Fields("ORDEN_N2").Value & "," & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value & ",1," & "'TDAUTOMATICA'," & lngTDAUT & ",'G','" & strPath & "')"
		mfExecute(conPasarela, strSQL)
		strSQL = "Select DISTINCT J.ANO_ID FROM JOINER J, CW_DATA_USAGE C "
		strSQL = strSQL & " Where J.JO_SEQ=" & rst4.Fields("ID_CONECTOR").Value & " AND SH_SEQ_FROM=" & rst4.Fields("NUM_SEC_DESDE").Value
		strSQL = strSQL & " AND SH_SEQ_TO=" & rst4.Fields("NUM_SEC_HASTA").Value & " AND DI_ID>=" & rst4.Fields("DI_ID").Value & " "
		strSQL = strSQL & " AND DI_ID<=" & rst4.Fields("DI_ID").Value & " AND DM_INSERTS=1"
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND J.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		rstconE = mfRecordset(conDP4, strSQL)
		strSQL = "SELECT C.AT_ID,A.AT_NAME, E.EN_NAME FROM ATTRIBUTE A,CW_DATA_USAGE C, ENTITY E "
		strSQL = strSQL & " Where C.CO_ID = (" & rstconE.Fields("ANO_ID").Value & ") AND DM_INSERTS=1 "
		strSQL = strSQL & "  AND A.AT_ID=C.AT_ID AND E.EN_ID = A.EN_ID"
		' **** NUEVO SD ENERO'08
		strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
		strSQL = strSQL & "  ORDER BY C.DM_SEQ"
		rstparamCME = mfRecordset(conDP4, strSQL)
		blnInserta = True
		If Not rstparamCME.EOF Then
			While Not rstparamCME.EOF
				Select Case Trim(rstparamCME.Fields("EN_NAME").Value)
					Case "Constantes"
						colXMLD = mfBuscaXML("Atributo", colXML2, rstparamCME.Fields("AT_ID").Value)
						'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						strValorV = colXMLD.Item(1)
						If strValorV <> "" Then
							msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, strValorV, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
						End If
					Case ""
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "", rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
					Case Else
						'UPGRADE_WARNING: Couldn't resolve default property of object mfInsertaVariables(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
						nomVarHN = mfInsertaVariables(rstparamCME.Fields("AT_ID").Value, rstparamCME.Fields("AT_NAME").Value)
						msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "@INICIO!" & nomVarHN, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
				End Select
				rstparamCME.MoveNext()
				rstparamHN.MoveNext()
			End While
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, "WAIT" & VB6.Format(lngWAIT, "00"), rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
			rstparamHN.MoveNext()
			msInsertaParamAcc(rstparamHN.Fields("PARAM").Value, rst6.Fields("PATH_HIDRA").Value, rst1R.Fields("ORDEN_N1").Value, rst1R.Fields("ORDEN_N2").Value, rst1R.Fields("ORDEN_N3").Value, rst1R.Fields("ORDEN_N4").Value, rst1R.Fields("ORDEN_N5").Value, 1)
		End If
		strPath = "EDP_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
		' str auxiliar para reutilizar codigo (aketza)
		strAuxiliar = "INSERT INTO ACCIONES_DI(" & strIns_Acc_DI & ",PATH_HIDRA) VALUES ('" & gNomProcCorto & "'," & rst1R.Fields("ORDEN_N1").Value & ", " & rst1R.Fields("ORDEN_N2").Value & ", " & rst1R.Fields("ORDEN_N3").Value & "," & rst1R.Fields("ORDEN_N4").Value & "," & rst1R.Fields("ORDEN_N5").Value
		strSQL = strAuxiliar & ", 2,'ENDPROC'," & lngTDAUT & ",'" & strPath & "')"
		mfExecute(conPasarela, strSQL)
		strPath = "PRO_TDAUTOMATICA" & VB6.Format(lngTDAUT, "00")
		strSQL = strAuxiliar & ", 3,'PROCESS'," & lngTDAUT & ",'" & strPath & "')"
		mfExecute(conPasarela, strSQL)
		'aketza 4/9/2006
		'strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R("ORDEN_N1") & " AND ORDEN_N2=" & rst1R("ORDEN_N2") & " AND ORDEN_N3=" & rst1R("ORDEN_N3") & " AND ORDEN_N4=" & rst1R("ORDEN_N4") & " AND ORDEN_N5=" & rst1R("ORDEN_N5") & " AND ORDEN_ACC=1"
		strSQL = "UPDATE PARAM_ACC SET VALOR='" & strPath & "' where PROCEDIMIENTO='" & gNomProcCorto & "' AND PARAMETRO='@PATHRETORNO' and ORDEN_N1=" & rst1R.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rst1R.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rst1R.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rst1R.Fields("ORDEN_N4").Value & " AND ORDEN_N5=" & rst1R.Fields("ORDEN_N5").Value & " AND ORDEN_ACC=1"
		'fin aketza
		mfExecute(conPasarela, strSQL)
		
		Exit Function
ERROR_Renamed: 
		
	End Function
	
	Private Function mfTratamientoCM10(ByVal propiedad As String) As String
		
		mfTratamientoCM10 = Replace(propiedad, "0", "")
		
	End Function
	
	
	Private Sub msNivelSuperior(ByRef strsalto As String, ByRef rstAux4 As ADODB.Recordset, ByRef rstAux5 As ADODB.Recordset, ByRef rstAux3 As ADODB.Recordset)
		On Error GoTo procErr
		
		'Inicio Jonathan Prieto 31/01/2011: Muchas veces sigue kaskando la primera consulta, no puede encontrar el padre
		
		Dim strSQL As String
		Dim rstConectores As ADODB.Recordset
		Dim rstDiagrama As ADODB.Recordset
		Dim rstPropiedades As ADODB.Recordset
		
		rstAux3.Requery()
		
		If Not rstAux5 Is Nothing And Not rstAux3 Is Nothing Then
			'Busco el padre
			strSQL = "SELECT ID_PADRE, ID_DIAGRAMA, NUM_SEQ, NUM_DIAGRAMA FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux5.Fields("ID_PADRE").Value & " AND NUM_DIAGRAMA=" & rstAux3.Fields("NUM").Value - 1
			rstAux4 = mfRecordset(conPasarela, strSQL)
			If Not rstAux4.EOF Then
				'Consigo los conectores (sin categoría asignada) del padre
				strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux4.Fields("NUM_DIAGRAMA").Value & " AND DIAGRAMA=" & rstAux4.Fields("ID_PADRE").Value & " AND NUM_SEC_DESDE=" & rstAux4.Fields("NUM_SEQ").Value & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value
				rstConectores = mfRecordset(conPasarela, strSQL)
				While Not rstConectores.EOF
					'Busco el registro del diagrama del trámite al que debe apuntar el salto
					strSQL = "select * from diagrama where procedimiento='" & gNomProcCorto & "' and "
					strSQL = strSQL & "num_seq=" & rstConectores.Fields("NUM_SEC_HASTA").Value & " and ORDEN_N1=" & rstConectores.Fields("ORDEN_N1").Value
					strSQL = strSQL & " and num_diagrama=" & rstConectores.Fields("NUM").Value
					rstDiagrama = mfRecordset(conPasarela, strSQL)
					If Not rstDiagrama.EOF Then
						'Si, lo ha encontrado. Busco el nombre en sus propiedades
						If Trim(rstDiagrama.Fields("CAT_DIAGRAMA").Value) <> "Ramificación" Then
							strSQL = "select * FROM PROPIEDADES_DI WHERE procedimiento='" & gNomProcCorto & "' "
							strSQL = strSQL & " AND ORDEN_N1= " & rstDiagrama.Fields("ORDEN_N1").Value
							strSQL = strSQL & " AND ORDEN_N2= " & rstDiagrama.Fields("ORDEN_N2").Value
							strSQL = strSQL & " AND ORDEN_N3= " & rstDiagrama.Fields("ORDEN_N3").Value
							strSQL = strSQL & " AND ORDEN_N4= " & rstDiagrama.Fields("ORDEN_N4").Value
							strSQL = strSQL & " AND ORDEN_N5= " & rstDiagrama.Fields("ORDEN_N5").Value
						Else
							'Si es una ramificación, debe buscar el primer trámite que tenga dentro, con NOM_DIAGRAMA<>''
							strSQL = "select * FROM PROPIEDADES_DI WHERE procedimiento='" & gNomProcCorto & "' "
							Select Case rstDiagrama.Fields("NUM_DIAGRAMA").Value
								Case 1
									strSQL = strSQL & " AND ORDEN_N1>= " & rstDiagrama.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2= " & rstDiagrama.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3= " & rstDiagrama.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4= " & rstDiagrama.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5= " & rstDiagrama.Fields("ORDEN_N5").Value
								Case 2
									strSQL = strSQL & " AND ORDEN_N1= " & rstDiagrama.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2>= " & rstDiagrama.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3>= " & rstDiagrama.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4>= " & rstDiagrama.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5>= " & rstDiagrama.Fields("ORDEN_N5").Value
								Case 3
									strSQL = strSQL & " AND ORDEN_N1= " & rstDiagrama.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2= " & rstDiagrama.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3>= " & rstDiagrama.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4>= " & rstDiagrama.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5>= " & rstDiagrama.Fields("ORDEN_N5").Value
								Case 4
									strSQL = strSQL & " AND ORDEN_N1= " & rstDiagrama.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2= " & rstDiagrama.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3= " & rstDiagrama.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4>= " & rstDiagrama.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5>= " & rstDiagrama.Fields("ORDEN_N5").Value
								Case Else
									strSQL = strSQL & " AND ORDEN_N1= " & rstDiagrama.Fields("ORDEN_N1").Value
									strSQL = strSQL & " AND ORDEN_N2= " & rstDiagrama.Fields("ORDEN_N2").Value
									strSQL = strSQL & " AND ORDEN_N3= " & rstDiagrama.Fields("ORDEN_N3").Value
									strSQL = strSQL & " AND ORDEN_N4= " & rstDiagrama.Fields("ORDEN_N4").Value
									strSQL = strSQL & " AND ORDEN_N5>= " & rstDiagrama.Fields("ORDEN_N5").Value
							End Select
							strSQL = strSQL & " AND NOM_DIAGRAMA<>'' ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
						End If
						rstPropiedades = mfRecordset(conPasarela, strSQL)
						If Not rstPropiedades.EOF Then
							'UPGRADE_NOTE: Object rstAux5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
							rstAux5 = Nothing
							strsalto = rstPropiedades.Fields("NOM_DIAGRAMA").Value
							'Le obligo a salir del bucle porque ya ha tratado el registro de diagrama que debía
							GoTo procFin
						End If
						rstConectores.MoveNext()
					Else
						'No lo ha encontrado, paso al siguiente conector (si lo tiene)
						rstConectores.MoveNext()
					End If
				End While
			End If
		End If
		
procFin: 
		'UPGRADE_NOTE: Object rstConectores may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstConectores = Nothing
		'UPGRADE_NOTE: Object rstDiagrama may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstDiagrama = Nothing
		'UPGRADE_NOTE: Object rstPropiedades may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstPropiedades = Nothing
		
		'   rstAux3.Requery
		'   strSQL = "SELECT ID_PADRE, ID_DIAGRAMA, NUM_SEQ, NUM_DIAGRAMA FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstAux5("ID_PADRE") & " AND NUM_DIAGRAMA=" & rstAux3("NUM") - 1
		'   Set rstAux4 = mfRecordset(conPasarela, strSQL)
		'   If Not rstAux4.EOF Then
		'      strSQL = "SELECT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM=" & rstAux4("NUM_DIAGRAMA") & " AND DIAGRAMA=" & rstAux4("ID_PADRE") & " AND NUM_SEC_DESDE=" & rstAux4("NUM_SEQ") & " AND NUM_SEC_DESDE<>NUM_SEC_HASTA and RTRIM(CAT_CONECTOR)='' and ORDEN_N1=" & rstAux5("ORDEN_N1")
		'      Set rstAux4 = mfRecordset(conPasarela, strSQL)
		'      If Not rstAux4.EOF Then
		'         strSQL = "select * from diagrama where procedimiento='" & gNomProcCorto & "' and "
		'         strSQL = strSQL & "num_seq=" & rstAux4("NUM_SEC_HASTA") & " and ORDEN_N1=" & rstAux4("ORDEN_N1")
		'         strSQL = strSQL & " and num_diagrama=" & rstAux4("NUM")
		'         Set rstAux4 = mfRecordset(conPasarela, strSQL)
		'      End If
		'      If Not rstAux4.EOF Then
		'        If Trim(rstAux4("CAT_DIAGRAMA")) <> "Ramificación" Then
		'           strSQL = "select * FROM PROPIEDADES_DI WHERE procedimiento='" & gNomProcCorto & "' "
		'           strSQL = strSQL & " AND ORDEN_N1= " & rstAux4("ORDEN_N1")
		'           strSQL = strSQL & " AND ORDEN_N2= " & rstAux4("ORDEN_N2")
		'           strSQL = strSQL & " AND ORDEN_N3= " & rstAux4("ORDEN_N3")
		'           strSQL = strSQL & " AND ORDEN_N4= " & rstAux4("ORDEN_N4")
		'           strSQL = strSQL & " AND ORDEN_N5= " & rstAux4("ORDEN_N5")
		'        Else
		'           strSQL = "select * FROM PROPIEDADES_DI WHERE procedimiento='" & gNomProcCorto & "' "
		'           Select Case rstAux4("NUM_DIAGRAMA")
		'           Case 1
		'                strSQL = strSQL & " AND ORDEN_N1>= " & rstAux4("ORDEN_N1")
		'                strSQL = strSQL & " AND ORDEN_N2= " & rstAux4("ORDEN_N2")
		'                strSQL = strSQL & " AND ORDEN_N3= " & rstAux4("ORDEN_N3")
		'                strSQL = strSQL & " AND ORDEN_N4= " & rstAux4("ORDEN_N4")
		'                strSQL = strSQL & " AND ORDEN_N5= " & rstAux4("ORDEN_N5")
		'           Case 2
		'                strSQL = strSQL & " AND ORDEN_N1= " & rstAux4("ORDEN_N1")
		'                strSQL = strSQL & " AND ORDEN_N2>= " & rstAux4("ORDEN_N2")
		'                strSQL = strSQL & " AND ORDEN_N3>= " & rstAux4("ORDEN_N3")
		'                strSQL = strSQL & " AND ORDEN_N4>= " & rstAux4("ORDEN_N4")
		'                strSQL = strSQL & " AND ORDEN_N5>= " & rstAux4("ORDEN_N5")
		'           Case 3
		'                strSQL = strSQL & " AND ORDEN_N1= " & rstAux4("ORDEN_N1")
		'                strSQL = strSQL & " AND ORDEN_N2= " & rstAux4("ORDEN_N2")
		'                strSQL = strSQL & " AND ORDEN_N3>= " & rstAux4("ORDEN_N3")
		'                strSQL = strSQL & " AND ORDEN_N4>= " & rstAux4("ORDEN_N4")
		'                strSQL = strSQL & " AND ORDEN_N5>= " & rstAux4("ORDEN_N5")
		'           Case 4
		'                strSQL = strSQL & " AND ORDEN_N1= " & rstAux4("ORDEN_N1")
		'                strSQL = strSQL & " AND ORDEN_N2= " & rstAux4("ORDEN_N2")
		'                strSQL = strSQL & " AND ORDEN_N3= " & rstAux4("ORDEN_N3")
		'                strSQL = strSQL & " AND ORDEN_N4>= " & rstAux4("ORDEN_N4")
		'                strSQL = strSQL & " AND ORDEN_N5>= " & rstAux4("ORDEN_N5")
		'           Case Else
		'                strSQL = strSQL & " AND ORDEN_N1= " & rstAux4("ORDEN_N1")
		'                strSQL = strSQL & " AND ORDEN_N2= " & rstAux4("ORDEN_N2")
		'                strSQL = strSQL & " AND ORDEN_N3= " & rstAux4("ORDEN_N3")
		'                strSQL = strSQL & " AND ORDEN_N4= " & rstAux4("ORDEN_N4")
		'                strSQL = strSQL & " AND ORDEN_N5>= " & rstAux4("ORDEN_N5")
		'           End Select
		'           strSQL = strSQL & " AND NOM_DIAGRAMA<>'' ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
		'        End If
		'        Set rstAux4 = mfRecordset(conPasarela, strSQL)
		'        If Not rstAux4.EOF Then
		'           Set rstAux5 = Nothing
		'           strsalto = rstAux4("NOM_DIAGRAMA")
		'        End If
		'      End If
		'   End If
		
		'Fin Jonathan Prieto 31/01/2011
		
		Exit Sub
procErr: 
		
		
	End Sub
	
	Private Function mfBuscaTramiteTDUSuperior(ByVal rstTram As ADODB.Recordset, ByVal rstAux As ADODB.Recordset) As String
		
		On Error GoTo procErr
		
		Dim strSQL As String
		Dim rstCon As ADODB.Recordset
		Dim rstConS As ADODB.Recordset
		Dim rstConST As ADODB.Recordset
		Dim rstTRAMS As ADODB.Recordset
		Dim rstTRAMax As ADODB.Recordset
		Dim rstAux2 As ADODB.Recordset
		Dim rstAux3 As ADODB.Recordset
		Dim rstAux4 As ADODB.Recordset
		Dim rstAux5 As ADODB.Recordset
		Dim rstAux6 As ADODB.Recordset
		Dim colXML As Collection
		Dim colXMLD As Collection
		Dim strProp As String
		Dim strAuxiliar As String
		Dim Id As Integer
		
		rstAux.Requery()
		
		
		Do While Not rstAux.EOF
			strSQL = "SELECT A.EV_ID FROM "
			strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
			strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
			strSQL = strSQL & "D.ANO_TABNR=9097 AND "
			strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
			strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
			strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
			strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_DIAGRAMA").Value & " AND "
			strSQL = strSQL & "D.SH_SEQ=" & rstAux.Fields("NUM_SEQ_HASTA").Value
			strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
			strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
			'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
			strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
			'Fin Jonathan Prieto 28/10/2010
			rstConS = mfRecordset(conDP4, strSQL)
			If Not rstConS.EOF Then
				Id = rstConS.Fields("EV_ID").Value
				strSQL = "SELECT DISTINCT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
				strSQL = strSQL & "DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
				strSQL = strSQL & "NUM_SEC_DESDE=" & rstTram.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
				rstConST = mfRecordset(conPasarela, strSQL)
				Do While Not rstConST.EOF
					If rstTram.Fields("NUM_DIAGRAMA").Value > 1 Then
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
						strSQL = strSQL & "ID_PADRE=" & rstTram.Fields("ID_PADRE").Value & " AND ID_DIAG_N1=" & rstTram.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
					Else
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTram.Fields("ID_PADRE").Value
					End If
					rstTRAMS = mfRecordset(conPasarela, strSQL)
					If rstTRAMS.EOF Then
						strSQL = "SELECT A.* FROM "
						strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
						strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
						strSQL = strSQL & "D.ANO_TABNR=9097 AND "
						strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
						strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
						strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
						strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "A.EV_ID=" & rstConS.Fields("EV_ID").Value
						strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
						'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
						strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
						'Fin Jonathan Prieto 28/10/2010
						rstAux2 = mfRecordset(conDP4, strSQL)
						If Not rstAux2.EOF Then
							If InStr(1, UCase(rstAux2.Fields("EV_NAME").Value), "FIN ") <> 0 Then
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND "
								strSQL = strSQL & " ORDEN_N1=" & rstTram.Fields("ORDEN_N1").Value
								rstAux3 = mfRecordset(conPasarela, strSQL)
								strSQL = "SELECT DISTINCT * FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "DIAGRAMA=" & rstAux3.Fields("ID_PADRE").Value & " AND "
								strSQL = strSQL & "NUM_SEC_DESDE=" & rstAux3.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR='' and CAT_CONECTOR2=''"
								rstAux4 = mfRecordset(conPasarela, strSQL)
								Do While Not rstAux4.EOF
									If rstAux4.Fields("NUM").Value > 1 Then
										strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
										strSQL = strSQL & "NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value & " AND "
										strSQL = strSQL & "ID_PADRE=" & rstAux3.Fields("ID_PADRE").Value & " AND ID_DIAG_N1=" & rstAux3.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstAux3.Fields("ORDEN_N1").Value
									Else
										strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstAux4.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstAux3.Fields("ID_PADRE").Value
									End If
									rstAux5 = mfRecordset(conPasarela, strSQL)
									If Not rstAux5.EOF Then
										If rstAux5.Fields("NUM_DIAGRAMA").Value = 1 Then
											strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID "
											strSQL = strSQL & "FROM SHAPE A, JOINER B, PROCESS C, CW_LOOKUP E "
											strSQL = strSQL & "Where A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_FROM AND (A.ANO_TABNR=8953) AND A.DI_ID=" & rstAux5.Fields("ID_PADRE").Value & "  AND A.ANO_ID=C.PR_ID AND "
											strSQL = strSQL & "SH_SEQ_FROM=" & rstAux3.Fields("NUM_SEQ").Value & " AND SH_SEQ_TO=" & rstAux5.Fields("NUM_SEQ").Value & " AND "
											strSQL = strSQL & "C.PR_TYPE=E.LU_ID and E.LU_NAME in ('Trámite de Inicio', 'Trámite', 'Trámite automático', 'Trámite general', 'Trámite General Automático','Ramificación') AND C.PR_TYPE<>23 "
											strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " ORDER BY A.SH_Y DESC, A.SH_X ASC"
										Else
											strSQL = "SELECT A.ANO_TABNR, B.ANO_ID, A.SH_SEQ, B.JO_SEQ, A.SH_SEQ, B.SH_SEQ_FROM, B.SH_SEQ_TO, B.DI_ID  "
											strSQL = strSQL & "From SHAPE A, JOINER B, PROCESS C, CW_LOOKUP E, DIAGRAM D Where "
											strSQL = strSQL & "A.DI_ID=B.DI_ID AND A.SH_SEQ=B.SH_SEQ_FROM AND (A.ANO_TABNR=8953) AND A.ANO_ID=C.PR_ID AND C.PR_TYPE=E.LU_ID and "
											strSQL = strSQL & "SH_SEQ_FROM=" & rstAux3.Fields("NUM_SEQ").Value & " AND SH_SEQ_TO=" & rstAux5.Fields("NUM_SEQ").Value & " AND "
											strSQL = strSQL & "E.LU_NAME in ('Trámite de Inicio', 'Trámite', 'Trámite automático', 'Trámite general', 'Trámite General Automático','Ramificación') AND C.PR_TYPE<>23 AND "
											strSQL = strSQL & "D.DI_ID =A.DI_ID and D.DI_TYPE <> 1 and D.ANO_ID = " & rstAux5.Fields("ID_PADRE").Value
											strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND C.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
											strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
										End If
										rstAux6 = mfRecordset(conDP4, strSQL)
										If Not rstAux6.EOF Then
											
											colXML = New Collection
											colXML.Add("Código Plazo")
											colXMLD = mfBuscaXML("Conector", colXML, rstAux6.Fields("ANO_ID").Value, True)
											'UPGRADE_WARNING: Couldn't resolve default property of object colXMLD(). Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"'
											strProp = colXMLD.Item(1)
											If strProp = "" Then
												strAuxiliar = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstAux5.Fields("ORDEN_N1").Value & " AND ORDEN_N2 "
												If rstAux5.Fields("ORDEN_N2").Value = 0 Then
													strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstAux5.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												ElseIf rstAux5.Fields("ORDEN_N3").Value = 0 Then 
													strSQL = strAuxiliar & " >= " & rstAux5.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												ElseIf rstAux5.Fields("ORDEN_N4").Value = 0 Then 
													strSQL = strAuxiliar & " = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstAux5.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												ElseIf rstAux5.Fields("ORDEN_N5").Value = 0 Then 
													strSQL = strAuxiliar & " = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux5.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												Else
													strSQL = strAuxiliar & "  = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstAux5.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >=" & rstAux5.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
												End If
												rstAux6 = mfRecordset(conPasarela, strSQL)
												Do While Not rstAux6.EOF
													If rstAux6.Fields("NOM_DIAGRAMA").Value <> "" Then
														mfBuscaTramiteTDUSuperior = rstAux6.Fields("NOM_DIAGRAMA").Value
														GoTo procFin
													End If
													rstAux6.MoveNext()
												Loop 
											End If
										End If
										
									End If
									rstAux4.MoveNext()
								Loop 
								
							End If
						End If
						'Inicio Jonathan Prieto 28/10/2010 - Ha encontrado el trámite con el mismo número de secuencia, lo enlazamos con su nombre
					Else
						'
						strSQL = "SELECT A.* FROM "
						strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
						strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
						strSQL = strSQL & "D.ANO_TABNR=9097 AND "
						strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
						strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
						strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
						strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND "
						strSQL = strSQL & "A.EV_ID=" & rstConS.Fields("EV_ID").Value
						strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
						strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
						rstAux2 = mfRecordset(conDP4, strSQL)
						If Not rstAux2.EOF Then
							strSQL = "SELECT NOM_DIAGRAMA FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "'"
							strSQL = strSQL & " AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2=" & rstTRAMS.Fields("ORDEN_N2").Value
							strSQL = strSQL & " AND ORDEN_N3=" & rstTRAMS.Fields("ORDEN_N3").Value & " AND ORDEN_N4=" & rstTRAMS.Fields("ORDEN_N4").Value
							strSQL = strSQL & " AND ID_DIAGRAMA = " & rstTRAMS.Fields("ID_DIAGRAMA").Value
							rstAux3 = mfRecordset(conPasarela, strSQL)
							If Not rstAux3.EOF Then
								If rstAux3.Fields("NOM_DIAGRAMA").Value <> "" Then
									mfBuscaTramiteTDUSuperior = rstAux3.Fields("NOM_DIAGRAMA").Value
									GoTo procFin
								End If
							End If
						End If
						'Fin Jonathan Prieto 28/10/2010
					End If
					rstConST.MoveNext()
				Loop 
				''''''''''''''
				If mfBuscaTramiteTDUSuperior = "" Then
					strSQL = "SELECT A.EV_ID FROM "
					strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
					strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
					strSQL = strSQL & "D.ANO_TABNR=9097 AND "
					strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
					strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
					strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
					strSQL = strSQL & "E.ANO_ID=" & rstTram.Fields("ID_PADRE").Value & " AND "
					strSQL = strSQL & "A.EV_ID=" & Id
					strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
					strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
					'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
					strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
					'Fin Jonathan Prieto 28/10/2010
					rstConS = mfRecordset(conDP4, strSQL)
					If Not rstConS.EOF Then
						strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "ID_DIAGRAMA=" & rstTram.Fields("ID_PADRE").Value & " AND NUM_DIAGRAMA=" & rstTram.Fields("NUM_DIAGRAMA").Value - 1
						rstTRAMax = mfRecordset(conPasarela, strSQL)
						
						strSQL = "SELECT DISTINCT NUM_SEC_HASTA FROM CONECTORES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
						strSQL = strSQL & "DIAGRAMA=" & rstTRAMax.Fields("ID_PADRE").Value & " AND "
						strSQL = strSQL & "NUM_SEC_DESDE=" & rstTRAMax.Fields("NUM_SEQ").Value & " AND CAT_CONECTOR<>'Conector Opcional'"
						rstConST = mfRecordset(conPasarela, strSQL)
						Do While Not rstConST.EOF
							If rstTRAMax.Fields("NUM_DIAGRAMA").Value > 1 Then
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND "
								strSQL = strSQL & "NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND "
								strSQL = strSQL & "ID_PADRE=" & rstTRAMax.Fields("ID_PADRE").Value & " AND ID_DIAG_N1=" & rstTRAMax.Fields("ID_DIAG_N1").Value & " and ORDEN_N1=" & rstTRAMax.Fields("ORDEN_N1").Value
							Else
								strSQL = "SELECT * FROM DIAGRAMA WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND NUM_SEQ=" & rstConST.Fields("NUM_SEC_HASTA").Value & " AND ID_PADRE=" & rstTRAMax.Fields("ID_PADRE").Value
							End If
							rstTRAMS = mfRecordset(conPasarela, strSQL)
							If Not rstTRAMS.EOF Then
								strSQL = "SELECT A.* FROM "
								strSQL = strSQL & "EVENT A, CW_OBJECT_TYPE B, SHAPE D, DIAGRAM E "
								strSQL = strSQL & "WHERE D.ANO_ID=A.EV_ID AND "
								strSQL = strSQL & "D.ANO_TABNR=9097 AND "
								strSQL = strSQL & "B.OT_NAME='Evento/Resultado' AND "
								strSQL = strSQL & "E.DI_ID=D.DI_ID AND "
								strSQL = strSQL & "D.ANO_TABNR=B.OT_ID AND "
								strSQL = strSQL & "E.ANO_ID=" & rstTRAMS.Fields("ID_DIAGRAMA").Value & " AND "
								strSQL = strSQL & "A.EV_ID=" & rstConS.Fields("EV_ID").Value
								strSQL = strSQL & " AND A.MODEL_NAME ='" & strModelo & "'"
								strSQL = strSQL & " AND B.MODEL_NAME ='" & strModelo & "'"
								strSQL = strSQL & " AND D.MODEL_NAME ='" & strModelo & "'"
								strSQL = strSQL & " AND E.MODEL_NAME ='" & strModelo & "'"
								'Inicio Jonathan Prieto 28/10/2010 - Que no busque trámites de usuario
								strSQL = strSQL & " AND E.DI_TYPE <> " & gstrCodTramUsu
								'Fin Jonathan Prieto 28/10/2010
								rstAux2 = mfRecordset(conDP4, strSQL)
								If Not rstAux2.EOF Then
									strAuxiliar = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1=" & rstTRAMS.Fields("ORDEN_N1").Value & " AND ORDEN_N2 "
									If rstTRAMS.Fields("ORDEN_N2").Value = 0 Then
										strSQL = "SELECT * FROM PROPIEDADES_DI WHERE PROCEDIMIENTO='" & gNomProcCorto & "' AND ORDEN_N1 > =" & rstTRAMS.Fields("ORDEN_N1").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstTRAMS.Fields("ORDEN_N3").Value = 0 Then 
										strSQL = strAuxiliar & " >= " & rstTRAMS.Fields("ORDEN_N2").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstTRAMS.Fields("ORDEN_N4").Value = 0 Then 
										strSQL = strAuxiliar & " = " & rstTRAMS.Fields("ORDEN_N2").Value & " AND ORDEN_N3 >=" & rstTRAMS.Fields("ORDEN_N3").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									ElseIf rstTRAMS.Fields("ORDEN_N5").Value = 0 Then 
										strSQL = strAuxiliar & " = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4 >=" & rstAux5.Fields("ORDEN_N4").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									Else
										strSQL = strAuxiliar & "  = " & rstAux5.Fields("ORDEN_N2").Value & " AND ORDEN_N3=" & rstAux5.Fields("ORDEN_N3").Value & " AND ORDEN_N4 = " & rstAux5.Fields("ORDEN_N4").Value & " AND ORDEN_N5 >=" & rstAux5.Fields("ORDEN_N5").Value & " ORDER BY ORDEN_N1, ORDEN_N2, ORDEN_N3, ORDEN_N4, ORDEN_N5"
									End If
									rstAux6 = mfRecordset(conPasarela, strSQL)
									Do While Not rstAux6.EOF
										If rstAux6.Fields("NOM_DIAGRAMA").Value <> "" Then
											mfBuscaTramiteTDUSuperior = rstAux6.Fields("NOM_DIAGRAMA").Value
											GoTo procFin
										End If
										rstAux6.MoveNext()
									Loop 
								End If
							End If
							
							rstConST.MoveNext()
						Loop 
					End If
				End If
				
				'Loop
				'End If
				'End If
				'''''''''''
			End If
			rstAux.MoveNext()
		Loop 
		'''' TO DO
		'''' BUSCAR SI NO TENEMOS CASADO NINGUN TRAMITE NI RAMIFICACION LOS E/R Q COINCIDAN CON EL DE SALIDA DEL TRAMITE
		'''' SI EXISTE REPETIMOS LA BUISQUEDA DE INICIOS DE TRAMITE O RAMIFICACIÓN A UN NIVEL SUPERIOR
		
		mfBuscaTramiteTDUSuperior = "ENLACE SIN DEFINIR"
		
		GoTo procFin
procErr: 
		MsgBox(Err.Description)
		
procFin: 
		CierraRS(rstAux2)
		'UPGRADE_NOTE: Object rstAux2 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux2 = Nothing
		
		CierraRS(rstAux3)
		'UPGRADE_NOTE: Object rstAux3 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux3 = Nothing
		
		CierraRS(rstAux4)
		'UPGRADE_NOTE: Object rstAux4 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux4 = Nothing
		
		CierraRS(rstAux5)
		'UPGRADE_NOTE: Object rstAux5 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux5 = Nothing
		
		CierraRS(rstAux6)
		'UPGRADE_NOTE: Object rstAux6 may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstAux6 = Nothing
		
	End Function
	
	Private Sub msModificacionesTramites()
		'Tratamiento para realizar modificaciones en los flujos en función del Tipo de Trámite
		Dim strSQL As String
		Dim rstTramites As ADODB.Recordset
		Dim rstDatos As ADODB.Recordset
		Dim rstDatosAux As ADODB.Recordset
		Dim strCodProce As String
		Dim strVERSIONP As String
		Dim strORDENTRA As String
		Dim strTipoTramite As String
		Dim strVariableCondicion As String
		Dim strOperadorCondicion As String
		Dim strFLOWORDER As String
		Dim strIDLEVEL As String
		Dim strID As String
		Dim strNombreAccion As String
		Dim strError As String
		Dim strNombreFormFicticio As String
		Dim strCodigoDocumento As String
		Dim strValorAction As String
		Dim strVariableAcuseRecibo As String
		Dim strFlowOrderMin As String
		Dim strFlowOrderMax As String
		
		On Error GoTo procErr
		
		lblMensaje.Text = "Tratamiento de Modificaciones de Trámites " & gNomProcCorto
		
		blnErrRecordset = False
		
		'Obtener CODPROCE y VERSIONP del procedimiento tratado
		strSQL = "SELECT TOP 1 CODPROCE, " & "VERSIONP " & "FROM TBPFIN03_PA " & "WHERE PROCEDIMIENTO = '" & gNomProcCorto & "'"
		rstDatos = mfRecordset(conPasarela, strSQL)
		'Si la consulta ha generado un error, paramos
		If blnErrRecordset = True Then
			strError = "No se ha podido obtener CODPROCE y VERSIONP del procedimiento tratado."
			GoTo procErr
		End If
		If Not rstDatos.EOF Then
			strCodProce = Trim(rstDatos.Fields("CODPROCE").Value)
			strVERSIONP = Trim(rstDatos.Fields("VERSIONP").Value)
			
			'Obtener los trámites del Procedimiento Tratado
			strSQL = "SELECT ORDENTRA, " & "INDPROCE, " & "VAR_FLUJO, " & "CRITERIO_COMP " & "FROM %owner%TBPFIN03 " & "WHERE CODPROCE = " & strCodProce & " " & "AND VERSIONP = " & strVERSIONP
			conDB2 = New ADODB.Connection
			If ComprobarConexion(conDB2, ReadIniFile(INIFile, "DB2", "Connection")) = False Then
				MsgBox("No se ha podido conectar a DB2, vuelva a lanzar la pasarela", MsgBoxStyle.Critical)
				End
			End If
			rstTramites = mfRecordset(conDB2, strSQL, "DB2")
			'Si la consulta ha generado un error, paramos
			If blnErrRecordset = True Then
				strError = "No se han podido obtener los trámites del procedimiento tratado."
				GoTo procErr
			End If
			If Not rstTramites.EOF Then
				'-->Bucle de trámites
				While Not rstTramites.EOF
					msProceso(rstTramites.AbsolutePosition, rstTramites.RecordCount + 1, 1, 2)
					
					'Recuperar los datos del Trámite
					strORDENTRA = Trim(rstTramites.Fields("ORDENTRA").Value)
					strTipoTramite = Trim(rstTramites.Fields("INDPROCE").Value)
					strVariableCondicion = Trim(rstTramites.Fields("VAR_FLUJO").Value)
					strOperadorCondicion = Trim(rstTramites.Fields("CRITERIO_COMP").Value)
					
					'Comprobamos si el trámite está condicionado
					If strVariableCondicion <> vbNullString And strOperadorCondicion <> vbNullString Then
						'El trámite está condicionado, tenemos que actualizar la acción de gestión TRAMITEPDTE o INICIOTRAMITEAUTOMA
						'Obtenemos el FLOWORDER, el ID y el Nombre de la acción
						strSQL = "SELECT ACC_GESTION.FLOWORDER, " & "ACC_GESTION.ID, " & "ACC_GESTION.VALUE " & "FROM WFFLOWACTIONS FLOWORDERS, " & "WFFLOWACTIONS ACC_GESTION " & "WHERE ACC_GESTION.FLOW = FLOWORDERS.FLOW " & "AND ACC_GESTION.VERSION = FLOWORDERS.VERSION " & "AND ACC_GESTION.FLOWORDER = FLOWORDERS.FLOWORDER " & "AND FLOWORDERS.FLOW = '" & gNomProcCorto & "' " & "AND FLOWORDERS.VERSION = " & VersionHidra & " " & "AND FLOWORDERS.PARAM = '@ORDENTRA' " & "AND FLOWORDERS.VALUE = '" & strORDENTRA & "' " & "AND ACC_GESTION.PARAM = 'FLOW' " & "AND ACC_GESTION.VALUE IN ('INICIOTRAMITEAUTOMA', 'TRAMITEPDTE')"
						rstDatos = mfRecordset(conCarga, strSQL)
						'Si la consulta ha generado un error, paramos
						If blnErrRecordset = True Then
							strError = "No se han podido obtener los FLOWORDER e ID de la Acción de Gestión."
							GoTo procErr
						End If
						If Not rstDatos.EOF Then
							'Recuperar el FLOWORDER de la acción APIINIEXT
							strFLOWORDER = Trim(rstDatos.Fields("FLOWORDER").Value)
							strIDLEVEL = Trim(rstDatos.Fields("ID").Value)
							strNombreAccion = Trim(rstDatos.Fields("VALUE").Value)
							'Actualizamos la Acción
							Select Case strNombreAccion
								Case "TRAMITEPDTE"
									strNombreAccion = "TRAMITEPDTE_COND"
								Case "INICIOTRAMITEAUTOMA"
									strNombreAccion = "INICIOTRAMITEAUTOMA_COND"
							End Select
							strSQL = "UPDATE WFFLOWACTIONS " & "SET VALUE = '" & strNombreAccion & "' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & strFLOWORDER & " " & "AND ID = " & strIDLEVEL
							mfExecute(conCarga, strSQL)
						End If
					End If
					
					If CInt(strORDENTRA) > 0 Then
						'Comprobamos si el Trámite es Manual (tiene FORMFICTICIO) o Automático (no tiene FORMFICTICIO)
						strSQL = "SELECT FORMFICTICIO.FLOWORDER, " & "FORMFICTICIO.PATH, " & "FORMFICTICIO.ACTION, " & "(SELECT MAX(ID) + 1 " & "FROM WFFLOWACTIONS B " & "WHERE B.FLOW = FORMFICTICIO.FLOW " & "AND B.VERSION = FORMFICTICIO.VERSION " & "AND B.FLOWORDER = FORMFICTICIO.FLOWORDER) AS ID " & "FROM WFFLOWACTIONS FLOWORDERS, " & "WFFLOWACTIONS FORMFICTICIO " & "WHERE FORMFICTICIO.FLOW = FLOWORDERS.FLOW " & "AND FORMFICTICIO.VERSION = FLOWORDERS.VERSION " & "AND FORMFICTICIO.FLOWORDER = FLOWORDERS.FLOWORDER " & "AND FLOWORDERS.FLOW = '" & gNomProcCorto & "' " & "AND FLOWORDERS.VERSION = " & VersionHidra & " " & "AND FLOWORDERS.PARAM = '@ORDENTRA' " & "AND FLOWORDERS.VALUE = '" & strORDENTRA & "' " & "AND FORMFICTICIO.ACTION IN ('FORM', 'LETVAR') " & "AND FORMFICTICIO.PATH LIKE 'FORMFICTICIO%'"
						rstDatos = mfRecordset(conCarga, strSQL)
						If blnErrRecordset = True Then
							strError = "No se han podido obtener los FLOWORDER"
							GoTo procErr
						End If
						If Not rstDatos.EOF Then
							'Es un Trámite Manual
							If Trim(rstDatos.Fields("ACTION").Value) = "FORM" Then
								strValorAction = ""
							Else
								strValorAction = "M"
							End If
							'Insertamos el nuevo parámetro Tipo Ejecución al Formulario Ficticio
							strSQL = "INSERT INTO wfFlowActions (Flow, Version, FlowOrder, Id, Action, Path, Param, " & "Value, Comments) VALUES (" & "'" & gNomProcCorto & "', " & VersionHidra & ", " & Trim(rstDatos.Fields("FLOWORDER").Value) & ", " & Trim(rstDatos.Fields("ID").Value) & ", " & "'', " & "'', " & "'@TIPOEJECUCION', " & "'" & strValorAction & "', " & "'')"
							mfExecute(conCarga, strSQL)
							'Insertamos el nuevo parámetro Tipo Ejecución a la Acción Inicio Trámite
							strSQL = "INSERT INTO wfFlowActions " & "SELECT INICIOTRAMITE.FLOW, " & "INICIOTRAMITE.VERSION, " & "INICIOTRAMITE.FLOWORDER, " & "(SELECT MAX(ID) + 1 " & "FROM wfFlowActions B " & "WHERE B.FLOW = INICIOTRAMITE.FLOW " & "AND B.VERSION = INICIOTRAMITE.VERSION " & "AND B.FLOWORDER = INICIOTRAMITE.FLOWORDER) AS ID, " & "INICIOTRAMITE.ACTION, " & "INICIOTRAMITE.PATH, " & "'@TIPOEJECUCION' AS PARAM, " & "'@" & Trim(rstDatos.Fields("PATH").Value) & "!TIPOEJECUCION' AS VALUE, " & "INICIOTRAMITE.COMMENTS " & "FROM WFFLOWACTIONS FLOWORDERS, " & "WFFLOWACTIONS INICIOTRAMITE " & "WHERE INICIOTRAMITE.FLOW = FLOWORDERS.FLOW " & "AND INICIOTRAMITE.VERSION = FLOWORDERS.VERSION " & "AND INICIOTRAMITE.FLOWORDER = FLOWORDERS.FLOWORDER " & "AND FLOWORDERS.FLOW = '" & gNomProcCorto & "' " & "AND FLOWORDERS.VERSION = " & VersionHidra & " " & "AND FLOWORDERS.PARAM = '@ORDENTRA' " & "AND FLOWORDERS.VALUE = '" & strORDENTRA & "' " & "AND INICIOTRAMITE.PARAM = 'FLOW' " & "AND INICIOTRAMITE.VALUE = 'INICIOTRAMITE'"
							mfExecute(conCarga, strSQL)
						End If
					End If
					
					'Tratamientos específicos por Tipo de Trámite
					Select Case strTipoTramite
						Case "5", "X", "Z", "F", "M", "0", "@", "#" '04/03/2019 se añade la acción "0" J.Lerma
							'**************************************************************************************************
							'**************************************************************************************************
							'Trámites de Visto Bueno y/o Firma
							'**************************************************************************************************
							'**************************************************************************************************
							'Obtenemos el primer paso del Trámite
							strSQL = "SELECT TOP(1) FLOWORDER, " & "ACTION, " & "PARAM, " & "VALUE " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER < (SELECT MIN(FLOWORDER) " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND PARAM = '@ORDENTRA' " & "AND VALUE = '" & strORDENTRA & "') " & "AND ID = 0 " & "ORDER BY FLOWORDER DESC"
							rstDatos = mfRecordset(conCarga, strSQL)
							If blnErrRecordset = True Then
								strError = "No se han podido obtener el primer paso del Trámite de Visto Bueno y/o Firma."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								'Comprobamos si el primer paso es una Inicialización de Variables (Ramificación con Variable Local)
								If Trim(rstDatos.Fields("ACTION").Value) = "LETVAR" And InStr(1, Trim(rstDatos.Fields("PARAM").Value), "@LOCALCO") > 0 Then
									'Modificamos todas las referencias a la variable CODIGODOCUMENTOEMITIDO por el valor de la variable local
									strSQL = "SELECT ACCIONES_TRAMITE.FLOWORDER, " & "ACCIONES_TRAMITE.ID " & "FROM WFFLOWACTIONS ACCIONES_TRAMITE " & "JOIN WFFLOWACTIONS CODIGODOCUMENTOEMITIDO ON (CODIGODOCUMENTOEMITIDO.FLOW = ACCIONES_TRAMITE.FLOW AND " & "CODIGODOCUMENTOEMITIDO.VERSION = ACCIONES_TRAMITE.VERSION AND " & "CODIGODOCUMENTOEMITIDO.FLOWORDER = ACCIONES_TRAMITE.FLOWORDER AND " & "CODIGODOCUMENTOEMITIDO.VALUE = '@INICIO!CODIGODOCUMENTOEMITIDO') " & "WHERE ACCIONES_TRAMITE.FLOW = '" & gNomProcCorto & "' " & "AND ACCIONES_TRAMITE.VERSION = " & VersionHidra & " " & "AND ACCIONES_TRAMITE.PARAM = '@ORDENTRA' " & "AND ACCIONES_TRAMITE.VALUE = '" & strORDENTRA & "'"
									rstDatosAux = mfRecordset(conCarga, strSQL)
									If blnErrRecordset = True Then
										strError = "No se han podido obtener los FLOWORDER del Trámite de Visto Bueno y/o Firma."
										GoTo procErr
									End If
									If Not rstDatosAux.EOF Then
										'Actualizamos el valor de la variable de cada FLOWORDER
										While Not rstDatosAux.EOF
											'Recuperar el FLOWORDER de la acción APIINIEXT
											strFLOWORDER = rstDatosAux.Fields("FLOWORDER").Value
											strID = rstDatosAux.Fields("ID").Value
											'Actualizamos el Parámetro DEFERRED
											strSQL = "UPDATE WFFLOWACTIONS " & "SET VALUE = '" & Trim(rstDatos.Fields("VALUE").Value) & "' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & strFLOWORDER & " " & "AND ID = " & strIDLEVEL
											mfExecute(conCarga, strSQL)
											'Avanzamos al siguiente FLOWORDER
											rstDatosAux.MoveNext()
										End While
									End If
									'Eliminamos la Inicialización de Variables de la Variable Local
									strSQL = "DELETE FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & rstDatos.Fields("FLOWORDER").Value
									mfExecute(conCarga, strSQL)
								End If
							End If
							
						Case "A"
							'**************************************************************************************************
							'**************************************************************************************************
							'Trámites de Actualización
							'**************************************************************************************************
							'**************************************************************************************************
							'Obtener todos los FLOWORDER e ID del Parámetro DEFERRED de los APIINIEXT
							strSQL = "SELECT DEFERRED.FLOWORDER, " & "DEFERRED.ID " & "FROM WFFLOWACTIONS FLOWORDERS, " & "WFFLOWACTIONS DEFERRED " & "WHERE DEFERRED.FLOW = FLOWORDERS.FLOW " & "AND DEFERRED.VERSION = FLOWORDERS.VERSION " & "AND DEFERRED.FLOWORDER = FLOWORDERS.FLOWORDER " & "AND FLOWORDERS.FLOW = '" & gNomProcCorto & "' " & "AND FLOWORDERS.VERSION = " & VersionHidra & " " & "AND FLOWORDERS.PARAM = '@ORDENTRA' " & "AND FLOWORDERS.VALUE = '" & strORDENTRA & "' " & "AND DEFERRED.PARAM = 'DEFERRED'"
							rstDatos = mfRecordset(conCarga, strSQL)
							'Si la consulta ha generado un error, paramos
							If blnErrRecordset = True Then
								strError = "No se han podido obtener los FLOWORDER e ID del Parámetro DEFERRED de los APIINIEXT."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								'-->Bucle de acciones APIINIEXT del trámite
								While Not rstDatos.EOF
									'Recuperar el FLOWORDER de la acción APIINIEXT
									strFLOWORDER = rstDatos.Fields("FLOWORDER").Value
									strIDLEVEL = rstDatos.Fields("ID").Value
									'Actualizamos el Parámetro DEFERRED
									strSQL = "UPDATE WFFLOWACTIONS " & "SET VALUE = '1' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & strFLOWORDER & " " & "AND ID = " & strIDLEVEL
									mfExecute(conCarga, strSQL)
									'Avanzamos al siguiente Parámetro
									rstDatos.MoveNext()
								End While
							End If
							
						Case "T"
							'**************************************************************************************************
							'**************************************************************************************************
							'Trámite de Notificación
							'**************************************************************************************************
							'**************************************************************************************************
							'Obtenemos el nombre del FORMFICTICIO correspondiente al Trámite
							strSQL = "SELECT FORMFICTICIO.PATH AS FORMFICTICIO " & "FROM WFFLOWACTIONS TRAMITE, " & "WFFLOWACTIONS FORMFICTICIO " & "WHERE FORMFICTICIO.FLOW = TRAMITE.FLOW " & "AND FORMFICTICIO.VERSION = TRAMITE.VERSION " & "AND FORMFICTICIO.FLOWORDER = TRAMITE.FLOWORDER " & "AND TRAMITE.FLOW = '" & gNomProcCorto & "' " & "AND TRAMITE.VERSION = " & VersionHidra & " " & "AND TRAMITE.PARAM = '@ORDENTRA' " & "AND TRAMITE.VALUE = '" & strORDENTRA & "' " & "AND FORMFICTICIO.ACTION = 'FORM' " & "AND FORMFICTICIO.PARAM = 'FORM' " & "AND FORMFICTICIO.PATH LIKE 'FORMFICTICIO%'"
							rstDatos = mfRecordset(conCarga, strSQL)
							If blnErrRecordset = True Then
								strError = "No se han podido obtener el nombre del FORMFICTICIO del Trámite de Notificación."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								strNombreFormFicticio = Trim(rstDatos.Fields("FORMFICTICIO").Value)
							Else
								strError = "No se ha recuperado el nombre del FORMFICTICIO del Trámite de Notificación."
								GoTo procErr
							End If
							'Comprobamos si la acción ACTULOTENOTIFICACION del Trámite de Notificación tiene el parámetro
							'"@IND_NOTIF_PRESENCIAL_IN" informado con el valor de la variable "Indicador Notificación Presencial"
							strSQL = "SELECT NOTIF_PRESENCIAL.FLOWORDER AS FLOWORDER, " & "NOTIF_PRESENCIAL.ID AS ID " & "FROM WFFLOWACTIONS TRAMITE, " & "WFFLOWACTIONS ACTULOTENOTIFICACION, " & "WFFLOWACTIONS NOTIF_PRESENCIAL " & "WHERE ACTULOTENOTIFICACION.FLOW = TRAMITE.FLOW " & "AND ACTULOTENOTIFICACION.VERSION = TRAMITE.VERSION " & "AND ACTULOTENOTIFICACION.FLOWORDER = TRAMITE.FLOWORDER " & "AND NOTIF_PRESENCIAL.FLOW = ACTULOTENOTIFICACION.FLOW " & "AND NOTIF_PRESENCIAL.VERSION = ACTULOTENOTIFICACION.VERSION " & "AND NOTIF_PRESENCIAL.FLOWORDER = ACTULOTENOTIFICACION.FLOWORDER " & "AND TRAMITE.FLOW = '" & gNomProcCorto & "' " & "AND TRAMITE.VERSION = " & VersionHidra & " " & "AND TRAMITE.PARAM = '@ORDENTRA' " & "AND TRAMITE.VALUE = '" & strORDENTRA & "' " & "AND ACTULOTENOTIFICACION.PARAM = 'FLOW' " & "AND ACTULOTENOTIFICACION.VALUE = 'ACTULOTENOTIFICACION' " & "AND NOTIF_PRESENCIAL.PARAM = '@IND_NOTIF_PRESENCIAL_IN' " & "AND NOTIF_PRESENCIAL.VALUE = '@INICIO!" & strVarNotifPresencial & "'"
							rstDatos = mfRecordset(conCarga, strSQL)
							If blnErrRecordset = True Then
								strError = "No se han podido comprobar si la acción ACTULOTENOTIFICACION tiene el parámetro @IND_NOTIF_PRESENCIAL_IN informado con la variable " & strVarNotifPresencial & "."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								'Actualizamos el valor del parámetro "@IND_NOTIF_PRESENCIAL_IN"
								strSQL = "UPDATE WFFLOWACTIONS " & "SET VALUE = '@" & strNombreFormFicticio & "!IND_NOTIF_PRESE' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & Trim(rstDatos.Fields("FLOWORDER").Value) & " " & "AND ID = " & Trim(rstDatos.Fields("ID").Value)
								mfExecute(conCarga, strSQL)
							End If
							'Obtenemos el valor del parámetro "@CODIDOCUMENTO_IN" de la acción ACTULOTENOTIFICACION
							strSQL = "SELECT DOCUMENTO.VALUE AS DOCUMENTO " & "FROM WFFLOWACTIONS ACCIONES, " & "WFFLOWACTIONS ACTULOTENOTIFICACION, " & "WFFLOWACTIONS DOCUMENTO " & "WHERE ACTULOTENOTIFICACION.FLOW = ACCIONES.FLOW " & "AND ACTULOTENOTIFICACION.VERSION = ACCIONES.VERSION " & "AND ACTULOTENOTIFICACION.FLOWORDER = ACCIONES.FLOWORDER " & "AND DOCUMENTO.FLOW = ACTULOTENOTIFICACION.FLOW " & "AND DOCUMENTO.VERSION = ACTULOTENOTIFICACION.VERSION " & "AND DOCUMENTO.FLOWORDER = ACTULOTENOTIFICACION.FLOWORDER " & "AND ACCIONES.FLOW = '" & gNomProcCorto & "' " & "AND ACCIONES.VERSION = " & VersionHidra & " " & "AND ACCIONES.PARAM = '@ORDENTRA' " & "AND ACCIONES.VALUE = '" & strORDENTRA & "' " & "AND ACTULOTENOTIFICACION.PARAM = 'FLOW' " & "AND ACTULOTENOTIFICACION.VALUE = 'ACTULOTENOTIFICACION' " & "AND DOCUMENTO.PARAM = '@CODIDOCUMENTO_IN'"
							rstDatos = mfRecordset(conCarga, strSQL)
							If blnErrRecordset = True Then
								strError = "No se ha podido obtener el valor del parámetro @CODIDOCUMENTO_IN de la acción ACTULOTENOTIFICACION."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								strCodigoDocumento = Trim(rstDatos.Fields("DOCUMENTO").Value)
							Else
								strError = "No se ha recuperado el valor del parámetro @CODIDOCUMENTO_IN de la acción ACTULOTENOTIFICACION."
								GoTo procErr
							End If
							'Obtenemos los FLOWORDER de la acción TRAMITEPDTE del Trámite de Notificación y del Trámite de Acuse de Recibo
							strSQL = "SELECT TRAMITEPDTE.FLOWORDER AS FLOWORDER " & "FROM WFFLOWACTIONS ACCIONES, " & "WFFLOWACTIONS TRAMITEPDTE " & "WHERE TRAMITEPDTE.FLOW = ACCIONES.FLOW " & "AND TRAMITEPDTE.VERSION = ACCIONES.VERSION " & "AND TRAMITEPDTE.FLOWORDER = ACCIONES.FLOWORDER " & "AND ACCIONES.FLOW = '" & gNomProcCorto & "' " & "AND ACCIONES.VERSION = " & VersionHidra & " " & "AND ACCIONES.PARAM = '@ORDENTRA' " & "AND ACCIONES.VALUE IN ('" & strORDENTRA & "', '" & CInt(strORDENTRA) + 1 & "') " & "AND TRAMITEPDTE.PARAM = 'FLOW' " & "AND TRAMITEPDTE.VALUE = 'TRAMITEPDTE'"
							rstDatos = mfRecordset(conCarga, strSQL)
							If blnErrRecordset = True Then
								strError = "No se han podido obtener los FLOWORDER de la acción TRAMITEPDTE del trámite de Notificación y Acuse de Recibo."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								While Not rstDatos.EOF
									strFLOWORDER = rstDatos.Fields("FLOWORDER").Value
									
									'Comprobamos si existe el parámetro @CODDOCUM en la acción TRAMITEPDTE
									strSQL = "SELECT 1 AS TIENE_CODDOCUM " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & strFLOWORDER & " " & "AND PARAM = '@CODDOCUM'"
									rstDatosAux = mfRecordset(conCarga, strSQL)
									If blnErrRecordset = True Then
										strError = "No se han podido obtener el parámetro @CODDOCUM."
										GoTo procErr
									End If
									If Not rstDatosAux.EOF Then
										strSQL = "UPDATE WFFLOWACTIONS " & "SET VALUE = '" & strCodigoDocumento & "' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & strFLOWORDER & " " & "AND PARAM = '@CODDOCUM'"
									Else
										strSQL = "INSERT INTO WFFLOWACTIONS (FLOW, " & "VERSION, " & "FLOWORDER, " & "ID, " & "ACTION, " & "PATH, " & "PARAM, " & "VALUE, " & "COMMENTS) " & "SELECT TOP(1) FLOW, " & "VERSION, " & "FLOWORDER, " & "ID + 1, " & "ACTION, " & "PATH, " & "'@CODDOCUM', " & "'" & strCodigoDocumento & "', " & "COMMENTS " & "FROM WFFLOWACTIONS " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER = " & strFLOWORDER & " " & "ORDER BY ID DESC"
									End If
									mfExecute(conCarga, strSQL)
									'Avanzamos al siguiente Parámetro
									rstDatos.MoveNext()
								End While
							Else
								strError = "No se han recuperado los FLOWORDER de la acción TRAMITEPDTE del trámite de Notificación y Acuse de Recibo."
								GoTo procErr
							End If
							'Obtenemos la Variable asociada al parámetro "@ACUSEREC_OUT" de la acción ACTULOTENOTIFICACION
							strSQL = "SELECT ACUSEREC.VALUE AS ACUSEREC " & "FROM WFFLOWACTIONS ACCIONES, " & "WFFLOWACTIONS ACTULOTENOTIFICACION, " & "WFFLOWACTIONS ACUSEREC " & "WHERE ACTULOTENOTIFICACION.FLOW = ACCIONES.FLOW " & "AND ACTULOTENOTIFICACION.VERSION = ACCIONES.VERSION " & "AND ACTULOTENOTIFICACION.FLOWORDER = ACCIONES.FLOWORDER " & "AND ACUSEREC.FLOW = ACTULOTENOTIFICACION.FLOW " & "AND ACUSEREC.VERSION = ACTULOTENOTIFICACION.VERSION " & "AND ACUSEREC.FLOWORDER = ACTULOTENOTIFICACION.FLOWORDER " & "AND ACCIONES.FLOW = '" & gNomProcCorto & "' " & "AND ACCIONES.VERSION = " & VersionHidra & " " & "AND ACCIONES.PARAM = '@ORDENTRA' " & "AND ACCIONES.VALUE = '" & strORDENTRA & "' " & "AND ACTULOTENOTIFICACION.PARAM = 'FLOW' " & "AND ACTULOTENOTIFICACION.VALUE = 'ACTULOTENOTIFICACION' " & "AND ACUSEREC.PARAM = '@ACUSEREC_OUT'"
							rstDatos = mfRecordset(conCarga, strSQL)
							If blnErrRecordset = True Then
								strError = "No se ha podido obtener la Variable asociada al parámetro @ACUSEREC_OUT de la acción ACTULOTENOTIFICACION."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								strVariableAcuseRecibo = Trim(rstDatos.Fields("ACUSEREC").Value)
							Else
								strError = "No se ha recuperado la Variable asociada al parámetro @ACUSEREC_OUT de la acción ACTULOTENOTIFICACION."
								GoTo procErr
							End If
							'Obtenemos el Primer y Último FlowOrder del Trámite
							strSQL = "SELECT MIN(FLOWORDER) AS FLOWORDER_MIN, " & "MAX(FLOWORDER) AS FLOWORDER_MAX " & "FROM WFFLOWACTIONS ACCIONES " & "WHERE ACCIONES.FLOW = '" & gNomProcCorto & "' " & "AND ACCIONES.VERSION = " & VersionHidra & " " & "AND ACCIONES.PARAM = '@ORDENTRA' " & "AND ACCIONES.VALUE = '" & strORDENTRA & "'"
							rstDatos = mfRecordset(conCarga, strSQL)
							If blnErrRecordset = True Then
								strError = "No se han podido obtener el Primer y Último FLOWORDER del trámite de Notificación y Acuse de Recibo."
								GoTo procErr
							End If
							If Not rstDatos.EOF Then
								strFlowOrderMin = Trim(rstDatos.Fields("FLOWORDER_MIN").Value)
								strFlowOrderMax = Trim(rstDatos.Fields("FLOWORDER_MAX").Value)
								'Actualizamos la Variable de Indicador de Acuse para concatenarle el ORDENTRA
								strSQL = "UPDATE WFFLOWACTIONS " & "SET VALUE = VALUE + '_" & strORDENTRA & "' " & "WHERE FLOW = '" & gNomProcCorto & "' " & "AND VERSION = " & VersionHidra & " " & "AND FLOWORDER BETWEEN " & strFlowOrderMin & " AND " & strFlowOrderMax & " " & "AND VALUE IN ('" & strVariableAcuseRecibo & "', '@INICIO!" & strVariableAcuseRecibo & "')"
								mfExecute(conCarga, strSQL)
							Else
								strError = "No se han recuperado el Primer y Último FLOWORDER del trámite de Notificación y Acuse de Recibo."
								GoTo procErr
							End If
							
					End Select
					'Avanzamos al Siguiente Trámite
					rstTramites.MoveNext()
				End While
			End If
		End If
		GoTo procFin
		
procErr: 
		If blnCancelar = True Then Exit Sub
		
		If strError = vbNullString Then
			strError = Err.Description
		End If
		
		Insertar_Error(Me, "Modificaciones Trámites", strError, "msModificacionesTramites")
		logError("msModificacionesTramites - Ha ocurrido un error en el tratamiento Modificaciones Trámites: " & strError)
		
		tramiteAnterior = ""
		Me.Close()
		Resume procFin
		
procFin: 
		'UPGRADE_NOTE: Object rstTramites may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstTramites = Nothing
		'UPGRADE_NOTE: Object rstDatos may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstDatos = Nothing
		'UPGRADE_NOTE: Object rstDatosAux may not be destroyed until it is garbage collected. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6E35BFF6-CD74-4B09-9689-3E1A43DF8969"'
		rstDatosAux = Nothing
	End Sub
	
	'Ejecutar procedimientos de adaptación de flujos J.Lerma
	Private Sub msAdaptarFlujosRamasUnion(ByRef baseDatos As String, ByRef procedimiento As String, ByRef version As Integer)
		Dim arrParam(3, 1) As String
		Dim retorno As String
		
		On Error GoTo procErr
		
		retorno = ""
		arrParam(0, 0) = LTrim(RTrim(baseDatos))
		arrParam(0, 1) = "BaseDatos"
		arrParam(1, 0) = LTrim(RTrim(procedimiento))
		arrParam(1, 1) = "CodExtPr"
		arrParam(2, 0) = CStr(version)
		arrParam(2, 1) = "Version"
		arrParam(3, 0) = retorno
		arrParam(3, 1) = "Retorno"
		msProcedimientoAlmacenado("SP_T0_ADAPTAR_FLUJOS_ELIMINAR_RAMAS", conInfrT0, arrParam)
		If retorno <> "" Then
			GoTo procErr
		End If
		'UPGRADE_NOTE: Erase was upgraded to System.Array.Clear. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="A9E4979A-37FA-4718-9994-97DD76ED70A7"'
		System.Array.Clear(arrParam, 0, arrParam.Length)
		
		arrParam(0, 0) = LTrim(RTrim(baseDatos))
		arrParam(0, 1) = "BaseDatos"
		arrParam(1, 0) = LTrim(RTrim(procedimiento))
		arrParam(1, 1) = "CodExtPr"
		arrParam(2, 0) = CStr(version)
		arrParam(2, 1) = "Version"
		arrParam(3, 0) = retorno
		arrParam(3, 1) = "Retorno"
		msProcedimientoAlmacenado("SP_T0_ADAPTAR_FLUJOS_UNION", conInfrT0, arrParam)
		If retorno <> "" Then
			GoTo procErr
		End If
		'UPGRADE_NOTE: Erase was upgraded to System.Array.Clear. Click for more: 'ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="A9E4979A-37FA-4718-9994-97DD76ED70A7"'
		System.Array.Clear(arrParam, 0, arrParam.Length)
		
		Exit Sub
		
procErr: 
		Dim strError As String
		strError = Err.Description
		
		Insertar_Error(Me, "Adaptar Flujos", strError, "msAdaptarFlujosRamasUnion")
		logError("msAdaptarFlujosRamasUnion - Ha ocurrido un error en la adaptación de los flujos: " & strError)
	End Sub
End Class